<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Spark on YARN éƒ¨ç½²</title>
    <url>/2016/03/29/spark-on-yarn/</url>
    <content><![CDATA[<h1 id="1-è¯´æ˜"><a href="#1-è¯´æ˜" class="headerlink" title="1.è¯´æ˜:"></a>1.è¯´æ˜:</h1><ol>
<li>é¦–å…ˆè¦éƒ¨ç½²å¥½Hadoopé›†ç¾¤åŒ…æ‹¬HDFSå’ŒYARN,è¿™é‡Œä¸å†èµ˜è¿°.</li>
<li>Spark on YARNæ¨¡å¼,ä¸éœ€è¦å¯åŠ¨sparkçš„masterå’Œworker,masterçš„å·¥ä½œç”±YARNå®Œæˆ.</li>
<li>ç›¸å…³è·¯å¾„æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹.</li>
<li>1.4å’Œ1.6ç‰ˆæœ¬éƒ¨ç½²è¿‡ç¨‹ç±»ä¼¼.<span id="more"></span></li>
</ol>
<h1 id="2-éƒ¨ç½²"><a href="#2-éƒ¨ç½²" class="headerlink" title="2.éƒ¨ç½²"></a>2.éƒ¨ç½²</h1><h2 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h2><p>ä»å®˜ç½‘(<a href="http://spark.apache.org/)%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94Hadoop%E7%89%88%E6%9C%AC%E7%9A%84%E5%8C%85,%E5%A6%82spark-1.6.1-bin-hadoop2.4.tgz">http://spark.apache.org/)ä¸‹è½½å¯¹åº”Hadoopç‰ˆæœ¬çš„åŒ…,å¦‚spark-1.6.1-bin-hadoop2.4.tgz</a>.<br>è§£å‹è‡³æŸä¸ªç›®å½•,å¦‚â€&#x2F;usr&#x2F;local&#x2F;hadoop&#x2F;spark-1.6.1-bin-hadoop2.4â€.<br>è§£å‹åå¾—åˆ°å¦‚ä¸‹æ–‡ä»¶</p>
<p><img src="http://thinkerblogimgs.qiniudn.com/16-4-11/66394000.jpg-l"></p>
<h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><h3 id="é…ç½®æ–‡ä»¶ä¿®æ”¹"><a href="#é…ç½®æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="é…ç½®æ–‡ä»¶ä¿®æ”¹"></a>é…ç½®æ–‡ä»¶ä¿®æ”¹</h3><p>é…ç½®æ–‡ä»¶åœ¨confç›®å½•ä¸­.<br>é…ç½®ç¯å¢ƒå˜é‡<br>cp spark-env.sh.template spark-env.sh<br>åœ¨spark-env.shä¸­æ·»åŠ å¦‚ä¸‹:<br>export HADOOP_HOME&#x3D;&#x2F;usr&#x2F;local&#x2F;hadoop&#x2F;hadoop-2.4.1<br>export YARN_CONF_DIR&#x3D;$HADOOP_HOME&#x2F;etc&#x2F;hadoop&#x2F;</p>
<p>é…ç½®sparké€‰é¡¹<br>cp spark-defaults.conf.template spark-defaults.conf<br>æ·»åŠ å¦‚ä¸‹:<br>spark.master                     yarn            #æŒ‡å®šä½¿ç”¨yarn<br>spark.driver.memory              1g              #æŒ‡å®šdriverä½¿ç”¨çš„å†…å­˜<br>spark.executor.memory            512m            #æŒ‡å®šexecutorä½¿ç”¨çš„å†…å­˜</p>
<p>é€‰å¡«:<br>spark.executor.extraClassPath   &#x2F;data&#x2F;hadoop&#x2F;hadoop&#x2F;hadoop-2.4.1&#x2F;share&#x2F;hadoop&#x2F;common&#x2F;lib&#x2F;hadoop-lzo-0.4.20.jar<br>spark.driver.extraClassPath     &#x2F;data&#x2F;hadoop&#x2F;hadoop&#x2F;hadoop-2.4.1&#x2F;share&#x2F;hadoop&#x2F;common&#x2F;lib&#x2F;*<br>spark.kryoserializer.buffer.max  256m</p>
<p>å¦å¤–ä¹Ÿå¯ä»¥è®¾ç½®ä¸€ä¸‹Sparkçš„log4jé…ç½®æ–‡ä»¶ï¼Œä½¿å¾—å±å¹•ä¸­ä¸æ‰“å°é¢å¤–çš„INFOä¿¡æ¯:<br>cp log4j.properties.template log4j.properties<br>ä¿®æ”¹ä¸€è¡Œ<br>log4j.rootCategory&#x3D;WARN, console</p>
<h2 id="å¯åŠ¨ä¸€ä¸ªsparkåº”ç”¨"><a href="#å¯åŠ¨ä¸€ä¸ªsparkåº”ç”¨" class="headerlink" title="å¯åŠ¨ä¸€ä¸ªsparkåº”ç”¨"></a>å¯åŠ¨ä¸€ä¸ªsparkåº”ç”¨</h2><p>æ‰§è¡Œ .&#x2F;bin&#x2F;spark-shell</p>
<p>è¾“å‡ºå°†åŒ…æ‹¬å¦‚ä¸‹æ‰€ç¤º</p>
<p><img src="http://thinkerblogimgs.qiniudn.com/16-4-11/77012870.jpg-l"></p>
<p>æµè§ˆå™¨è®¿é—®å½“å‰æœºå™¨çš„8088ç«¯å£,å°†å¯ä»¥çœ‹åˆ°å½“å‰å¯åŠ¨çš„driverçš„webç•Œé¢,å¦‚ä¸‹:</p>
<p><img src="http://thinkerblogimgs.qiniudn.com/16-4-11/49321272.jpg-l"></p>
<p>ç‚¹å‡»â€™Environmentâ€™æ ‡ç­¾,å°†å¯ä»¥çœ‹åˆ°ç›¸å…³ç¯å¢ƒå˜é‡å’Œå±æ€§çš„å€¼.</p>
<p>æµè§ˆå™¨è®¿é—®YARNçš„ç®¡ç†é¡µé¢,å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªSPARKåº”ç”¨æ­£åœ¨è¿è¡Œ(å¦‚ä¸‹),è‡³æ­¤sparkå°±å¯ä»¥è·‘åœ¨YARNä¸Šäº†.</p>
<p><img src="http://thinkerblogimgs.qiniudn.com/16-4-11/62275273.jpg-l"></p>
<h1 id="3-è¿è¡Œæ¨¡å¼"><a href="#3-è¿è¡Œæ¨¡å¼" class="headerlink" title="3.è¿è¡Œæ¨¡å¼"></a>3.è¿è¡Œæ¨¡å¼</h1><p>Spark on YARNæœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼clusterå’Œclient,spark-shellå’Œspark-sqläº¤äº’å¼çš„åº”ç”¨åªæ”¯æŒclientæ¨¡å¼.<br>ä¸¤ç§æ¨¡å¼åŒºåˆ«å¦‚ä¸‹:</p>
<blockquote>
<p>ä»å¹¿ä¹‰ä¸Šè®²ï¼Œyarn-clusteré€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼›è€Œyarn-clienté€‚ç”¨äºäº¤äº’å’Œè°ƒè¯•ï¼Œä¹Ÿå°±æ˜¯å¸Œæœ›å¿«é€Ÿåœ°çœ‹åˆ°applicationçš„è¾“å‡ºã€‚</p>
</blockquote>
<p>å¯ä»¥å‚è€ƒè¿™ç¯‡åšå®¢:Spark:Yarn-clusterå’ŒYarn-clientåŒºåˆ«ä¸è”ç³»(<a href="http://www.iteblog.com/archives/1223">http://www.iteblog.com/archives/1223</a>).</p>
<h1 id="4-å‚è€ƒæ–‡çŒ®"><a href="#4-å‚è€ƒæ–‡çŒ®" class="headerlink" title="4.å‚è€ƒæ–‡çŒ®:"></a>4.å‚è€ƒæ–‡çŒ®:</h1><p>Running Spark on YARN<br><a href="http://spark.apache.org/docs/latest/running-on-yarn.html">http://spark.apache.org/docs/latest/running-on-yarn.html</a></p>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>YARN</tag>
      </tags>
  </entry>
  <entry>
    <title>Hiveæ·»åŠ è‡ªå®šä¹‰UDFå‡½æ•°</title>
    <url>/2016/04/11/add-udf-to-hive/</url>
    <content><![CDATA[<h1 id="1-ç¼–å†™UDFç±»"><a href="#1-ç¼–å†™UDFç±»" class="headerlink" title="1 ç¼–å†™UDFç±»"></a>1 ç¼–å†™UDFç±»</h1><p>ä»¥ç®€å•çš„å¤„ç†å•ä¸ªå­—æ®µçš„UDFå‡½æ•°ä¸ºä¾‹,å¼€å‘è‡ªå®šä¹‰UDFå‡½æ•°éœ€è¦ç»§æ‰¿â€™org.apache.hadoop.hive.ql.exec.UDFâ€™ç±».<br>å¯ä»¥é€šè¿‡Mavenæ·»åŠ ,pomæ–‡ä»¶ä¸­åŠ å…¥(ç‰ˆæœ¬å·è·ŸHiveç‰ˆæœ¬ä¸€è‡´å³å¯):</p>
<span id="more"></span>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-exec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>æœ€ç®€å•çš„å®ç°åªéœ€ç»§æ‰¿UDFç±»,å¹¶å®ç°evaluateå‡½æ•°.å¦‚ä¸‹UDFå‡½æ•°ç”¨æ¥å°†IP(v4)åœ°å€è½¬æ¢ä¸ºæ•´æ•°.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ml.liam8.hive;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.Description;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.UDF;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Convert IPv4 to a num which type is Long in java.</span></span><br><span class="line"><span class="comment">* Created by Liam on 2016/4/11.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Description(name = &quot;IpToNum&quot;, value = &quot;_FUNC_(ip) - Convert IPv4 to a num(long).&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IpToNum</span> <span class="keyword">extends</span> <span class="title class_">UDF</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">evaluate</span><span class="params">(String ip)</span> &#123;</span><br><span class="line">      String[] nums = ip.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> Long.parseLong(nums[<span class="number">3</span>]) + Long.parseLong(nums[<span class="number">2</span>]) * <span class="number">256</span></span><br><span class="line">         + Long.parseLong(nums[<span class="number">1</span>]) * <span class="number">65536</span> + Long.parseLong(nums[<span class="number">0</span>]) * <span class="number">16777216</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>evaluateæ–¹æ³•çš„è¾“å…¥è¾“å‡ºå³æ˜¯UDFå‡½æ•°çš„è¾“å…¥è¾“å‡º.<br>Descriptionæ³¨è§£éƒ¨åˆ†æä¾›å‡½æ•°çš„å¸®åŠ©ä¿¡æ¯.</p>
<p>æ‰§è¡Œ:<br><code>desc function test.iptonum</code><br>è¾“å‡º:<br><code>test.iptonum(ip) - Convert IPv4 to a num(long).</code></p>
<p>æºç å·²ä¸Šä¼  <a href="https://github.com/Liam8/HiveUDF">Github</a></p>
<h1 id="2-éƒ¨ç½²åŠåˆ›å»ºUDFå‡½æ•°"><a href="#2-éƒ¨ç½²åŠåˆ›å»ºUDFå‡½æ•°" class="headerlink" title="2 éƒ¨ç½²åŠåˆ›å»ºUDFå‡½æ•°"></a>2 éƒ¨ç½²åŠåˆ›å»ºUDFå‡½æ•°</h1><p>ps:Hive0.13åŠä»¥åç‰ˆæœ¬é€‚ç”¨</p>
<h3 id="éƒ¨ç½²jaråŒ…"><a href="#éƒ¨ç½²jaråŒ…" class="headerlink" title="éƒ¨ç½²jaråŒ…"></a>éƒ¨ç½²jaråŒ…</h3><p>å°†jaråŒ…å¤åˆ¶åˆ°HDFS.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hdfs -dfs -put udfs-0.1.jar &#x27;hdfs:///user/hadoop/hiveUDF&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="åˆ›å»ºæ°¸ä¹…å‡½æ•°"><a href="#åˆ›å»ºæ°¸ä¹…å‡½æ•°" class="headerlink" title="åˆ›å»ºæ°¸ä¹…å‡½æ•°"></a>åˆ›å»ºæ°¸ä¹…å‡½æ•°</h3><p>éœ€åœ¨Hiveä¸­æ‰§è¡Œsqlè¯­å¥,æ ¼å¼å¦‚ä¸‹:</p>
<pre><code>CREATE FUNCTION [db_name.]function_name AS class_name
  [USING JAR|FILE|ARCHIVE &#39;file_uri&#39; [, JAR|FILE|ARCHIVE &#39;file_uri&#39;] ];
</code></pre>
<p>å¦‚:</p>
<pre><code>create function test.iptonum as &#39;com.liam8.hive.IpToNum&#39; using jar &#39;hdfs:///user/hadoop/hiveUDF/udfs-0.1.jar&#39;
</code></pre>
<p>å‡½æ•°éœ€è¦å±äºæŸä¸ªåº“,å¦‚è¿™é‡Œæ˜¯â€™testâ€™,å½“å…¶ä»–åº“è°ƒç”¨æ—¶,éœ€è¦åŠ ä¸Šåº“å,å¦‚â€™test.iptonumâ€™.</p>
<p>è°ƒç”¨æ–¹å¼: <code>select test.iptonum(&#39;127.0.0.1&#39;);</code></p>
<h3 id="åˆ›å»ºä¸´æ—¶å‡½æ•°"><a href="#åˆ›å»ºä¸´æ—¶å‡½æ•°" class="headerlink" title="åˆ›å»ºä¸´æ—¶å‡½æ•°"></a>åˆ›å»ºä¸´æ—¶å‡½æ•°</h3><p>ä¸´æ—¶å‡½æ•°åªåœ¨å½“å‰sessionä¸­æœ‰æ•ˆ,ä¸´æ—¶å‡½æ•°ä¸èƒ½æŒ‡å®šåº“.</p>
<pre><code>create temporary function iptonum as &#39;com.liam8.hive.IpToNum&#39; using jar &#39;hdfs:///user/hadoop/hiveUDF/udfs-0.1.jar&#39;
</code></pre>
<p>è°ƒç”¨æ–¹å¼: <code>select iptonum(&#39;127.0.0.1&#39;);</code></p>
<h1 id="3-å‚è€ƒèµ„æ–™"><a href="#3-å‚è€ƒèµ„æ–™" class="headerlink" title="3 å‚è€ƒèµ„æ–™"></a>3 å‚è€ƒèµ„æ–™</h1><p><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-PermanentFunctions">LanguageManualDDL-PermanentFunctions</a></p>
<p><a href="https://cwiki.apache.org/confluence/display/Hive/HivePlugins">HivePlugins</a></p>
]]></content>
      <tags>
        <tag>Hive</tag>
        <tag>UDF</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafka 0.10 å¸¸ç”¨è¿ç»´å‘½ä»¤</title>
    <url>/2017/03/02/kafka-operation-command/</url>
    <content><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>Kafkaæ˜¯ç”±LinkedInå¼€å‘çš„ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œå®ƒä»¥å¯æ°´å¹³æ‰©å±•å’Œé«˜ååç‡è€Œè¢«å¹¿æ³›ä½¿ç”¨ï¼Œç°åœ¨å·²ç»æ˜¯Apacheçš„é¡¹ç›®ã€‚</p>
<p>Kafkaç³»ç»Ÿè‡ªå¸¦äº†ä¸°å¯Œçš„è¿ç»´ç®¡ç†å·¥å…·ï¼Œéƒ½æ˜¯åŸºäºå‘½ä»¤è¡Œçš„ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤ã€‚</p>
<span id="more"></span>

<p>è¯»è€…éœ€è¦å¯¹Kafkaå·²ç»æœ‰å…¥é—¨çº§çš„äº†è§£ã€‚</p>
<h1 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h1><p>ä»¥ä¸‹å‘½ä»¤éƒ½æ˜¯åœ¨Kafkaçš„ä¸»ç›®å½•ä¸‹æ‰§è¡Œçš„ã€‚</p>
<h2 id="å¯åŠ¨Kafka"><a href="#å¯åŠ¨Kafka" class="headerlink" title="å¯åŠ¨Kafka"></a>å¯åŠ¨Kafka</h2><p>å¯åŠ¨å‘½ä»¤éœ€è¦æŒ‡å®šé…ç½®æ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-server-start.sh config/server.properties</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤çš„å¯åŠ¨æ–¹å¼å¹¶ä¸æ˜¯å®ˆæŠ¤è¿›ç¨‹ï¼Œå¯ä»¥æ·»åŠ â€™nohupâ€™å’Œâ€™&amp;â€™è®©è¿›ç¨‹ä¿æŒåœ¨åå°è¿è¡Œï¼Œå³ä½¿æ–­å¼€SSHç»ˆç«¯è¿æ¥ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nohup bin/kafka-server-start.sh config/server.properties &gt; ~/kafka-server-start.out 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<h2 id="topic-ç›¸å…³"><a href="#topic-ç›¸å…³" class="headerlink" title="topic ç›¸å…³"></a>topic ç›¸å…³</h2><h3 id="åˆ—å‡º-topic"><a href="#åˆ—å‡º-topic" class="headerlink" title="åˆ—å‡º topic"></a>åˆ—å‡º topic</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-topics.sh --list --zookeeper localhost:2181</span><br></pre></td></tr></table></figure>
<p>â€“zookeeperï¼šæŒ‡å®šzookeeperåœ°å€ã€‚</p>
<h3 id="åˆ›å»º-topic"><a href="#åˆ›å»º-topic" class="headerlink" title="åˆ›å»º topic"></a>åˆ›å»º topic</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 3 --partitions 4 --topic test_topic</span><br></pre></td></tr></table></figure>
<p>â€“replication-factorï¼šå¤‡ä»½æ•°ï¼Œå°±æ˜¯æ•°æ®ä¿å­˜å‡ ä»½ï¼Œè¿™é‡Œè®¾ç½®ä¸º3ï¼Œè¡¨ç¤ºè¯¥topicçš„æ•°æ®ä¼šåœ¨3ä¸ªèŠ‚ç‚¹ä¸Šå„ä¿å­˜ä¸€ä»½ã€‚</p>
<p>â€“partitionsï¼šåˆ†åŒºæ•°</p>
<h3 id="topic-è¯¦æƒ…"><a href="#topic-è¯¦æƒ…" class="headerlink" title="topic è¯¦æƒ…"></a>topic è¯¦æƒ…</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-topics.sh --describe --zookeeper localhost:2181 --topic test_topic</span><br></pre></td></tr></table></figure>
<h3 id="åˆ é™¤-topic"><a href="#åˆ é™¤-topic" class="headerlink" title="åˆ é™¤ topic"></a>åˆ é™¤ topic</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-topics.sh --zookeeper localhost:2181 --delete --topic test_topic</span><br></pre></td></tr></table></figure>
<p>éœ€è¦å¼€å¯ä¸€ä¸ªé…ç½®é¡¹æ‰å¯ä»¥åˆ é™¤topicã€‚</p>
<p>é…ç½®é¡¹åœ¨server.propertiesä¸­ï¼š<br><code>delete.topic.enable = true</code></p>
<p>ps: æœ‰ä¸ªç‰¹æ®Šçš„topicå« __consumer_offsetsï¼Œæ˜¯Kafkaå†…éƒ¨ä½¿ç”¨çš„ï¼Œä¸å…è®¸åˆ é™¤çš„ã€‚</p>
<h2 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…ç›¸å…³"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…ç›¸å…³" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…ç›¸å…³"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…ç›¸å…³</h2><h3 id="ç”Ÿäº§è€…"><a href="#ç”Ÿäº§è€…" class="headerlink" title="ç”Ÿäº§è€…"></a>ç”Ÿäº§è€…</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test_topic</span><br></pre></td></tr></table></figure>
<p>â€“broker-list:kafka brokeråœ°å€</p>
<h3 id="æ¶ˆè´¹è€…"><a href="#æ¶ˆè´¹è€…" class="headerlink" title="æ¶ˆè´¹è€…"></a>æ¶ˆè´¹è€…</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic test_topic</span><br></pre></td></tr></table></figure>

<h2 id="åˆ†åŒºç›¸å…³"><a href="#åˆ†åŒºç›¸å…³" class="headerlink" title="åˆ†åŒºç›¸å…³"></a>åˆ†åŒºç›¸å…³</h2><h3 id="å¢åŠ åˆ†åŒº"><a href="#å¢åŠ åˆ†åŒº" class="headerlink" title="å¢åŠ åˆ†åŒº"></a>å¢åŠ åˆ†åŒº</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-topics.sh --zookeeper localhost:2181 --alter --topic test_topic --partitions 4</span><br></pre></td></tr></table></figure>
<p>â€“partitions:æŒ‡æ˜å°†åˆ†åŒºå¢åŠ è‡³å¤šå°‘ä¸ªã€‚<br>åˆ†åŒºä¸èƒ½å‡å°‘åªèƒ½å¢åŠ ã€‚</p>
<h3 id="æ”¹å˜åˆ†åŒºåˆ†å¸ƒå’Œå‰¯æœ¬æ•°"><a href="#æ”¹å˜åˆ†åŒºåˆ†å¸ƒå’Œå‰¯æœ¬æ•°" class="headerlink" title="æ”¹å˜åˆ†åŒºåˆ†å¸ƒå’Œå‰¯æœ¬æ•°"></a>æ”¹å˜åˆ†åŒºåˆ†å¸ƒå’Œå‰¯æœ¬æ•°</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --reassignment-json-file test_topic.json --execute</span><br></pre></td></tr></table></figure>
<p>â€“reassignment-json-file:æŒ‡å®šä¸€ä¸ªåˆ†åŒºæ–¹æ¡ˆæ–‡ä»¶ã€‚</p>
<p>åˆ†åŒºæ–¹æ¡ˆæ–‡ä»¶æ˜¯ä¸€ä¸ªjsonæ ¼å¼çš„æ–‡æœ¬æ–‡ä»¶ï¼Œéœ€è¦è‡ªå·±ç¼–å†™ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œtest_topic.jsonå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;partitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_topic&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;partition&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;replicas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_topic&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;partition&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;replicas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_topic&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;partition&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;replicas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;topic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_topic&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;partition&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;replicas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>è§£é‡Šå…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œå‰©ä¸‹çš„è‡ªç„¶ä¹Ÿä¼šæ˜ç™½ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;topic&quot;: &quot;test_topic&quot;, //topicåç§°</span><br><span class="line">&quot;partition&quot;: 0,        //åˆ†åŒºç¼–å·ï¼Œä»0å¼€å§‹</span><br><span class="line">&quot;replicas&quot;: [1,2]      //æŒ‡å®šä¿å­˜åœ¨å“ªä¸ªbroker,è¿™é‡Œæ˜¯å¡«å†™broker idã€‚å†™ä¸¤ä¸ªidï¼Œæ„æ€å°±æ˜¯æœ‰ä¸¤ä»½å¤‡ä»½å•¦ã€‚</span><br></pre></td></tr></table></figure>

<p>PS:è¿™ä¸ªæ–¹æ³•ä¸èƒ½ç”¨æ¥å¢åŠ åˆ†åŒºæ•°ã€‚ç¬¬ä¸€ä¸ªreplicaså°±æ˜¯é»˜è®¤leaderã€‚</p>
<p>æ”¹å˜åˆ†åŒºå’Œå¤‡ä»½æ•°çš„æ“ä½œå¹¶ä¸èƒ½ç«‹å³å®Œæˆï¼Œè€Œæ˜¯éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œå†…éƒ¨æ“ä½œä¼šåœ¨åå°è¿è¡Œã€‚<br>æ‰€ä»¥éœ€è¦â€¦</p>
<p>æ£€æŸ¥è¿›åº¦</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --reassignment-json-file test_topic.json --verify</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šã€‚</p>
]]></content>
      <tags>
        <tag>Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World, Hello Blog</title>
    <url>/2016/12/25/hello-blog/</url>
    <content><![CDATA[<h2 id="Hello"><a href="#Hello" class="headerlink" title="Hello!"></a>Hello!</h2><p>Today is this blogâ€™s first day !</p>
<h3 id="Merry-Christmas"><a href="#Merry-Christmas" class="headerlink" title="Merry Christmas !"></a>Merry Christmas !</h3>]]></content>
      <tags>
        <tag>Life</tag>
      </tags>
  </entry>
  <entry>
    <title>è‡ªå®šä¹‰å¼€å‘Spark MLæœºå™¨å­¦ä¹ ç±» - 1</title>
    <url>/2018/02/04/diy-spark-ml-1/</url>
    <content><![CDATA[<h1 id="åˆçª¥é—¨å¾„"><a href="#åˆçª¥é—¨å¾„" class="headerlink" title="åˆçª¥é—¨å¾„"></a>åˆçª¥é—¨å¾„</h1><p>Sparkçš„MLlibç»„ä»¶å†…ç½®å®ç°äº†å¾ˆå¤šå¸¸è§çš„æœºå™¨å­¦ä¹ ç®—æ³•,åŒ…æ‹¬æ•°æ®æŠ½å–,åˆ†ç±»,èšç±»,å…³è”åˆ†æ,ååŒè¿‡æ»¤ç­‰ç­‰.<br>ç„¶é¹…,å†…ç½®çš„ç®—æ³•å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬æ‰€æœ‰çš„éœ€æ±‚,æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯ç»å¸¸éœ€è¦è‡ªå®šä¹‰MLç®—æ³•.</p>
<span id="more"></span>

<p>MLlibæä¾›çš„APIåˆ†ä¸ºä¸¤ç±»:</p>
<ul>
<li>1.åŸºäºDataFrameçš„API,å±äºspark.mlåŒ….</li>
<li>2.åŸºäºRDDçš„API, å±äºspark.mllibåŒ….</li>
</ul>
<p>ä»Spark 2.0å¼€å§‹,Sparkçš„APIå…¨é¢ä»RDDè½¬å‘DataFrame,MLlibä¹Ÿæ˜¯å¦‚æ­¤,å®˜ç½‘åŸè¯å¦‚ä¸‹:</p>
<blockquote>
<p>Announcement: DataFrame-based API is primary API</p>
<p>The MLlib RDD-based API is now in maintenance mode.</p>
</blockquote>
<p>æ‰€ä»¥æœ¬æ–‡å°†ä»‹ç»åŸºäºDataFrameçš„è‡ªå®šä¹‰mlç±»ç¼–å†™æ–¹æ³•.ä¸æ¶‰åŠå…·ä½“ç®—æ³•,åªè®²æ‰©å±•mlç±»çš„æ–¹æ³•.</p>
<h1 id="ç•¥çŸ¥ä¸€äºŒ"><a href="#ç•¥çŸ¥ä¸€äºŒ" class="headerlink" title="ç•¥çŸ¥ä¸€äºŒ"></a>ç•¥çŸ¥ä¸€äºŒ</h1><p>å®˜æ–¹æ–‡æ¡£å¹¶æ²¡æœ‰ä»‹ç»å¦‚ä½•è‡ªå®šä¹‰mlç±»,æ‰€ä»¥åªæœ‰ä»æºç å…¥æ‰‹,çœ‹çœ‹æºç é‡Œé¢æ˜¯æ€ä¹ˆå®ç°çš„.</p>
<p>æ‰¾ä¸€ä¸ªæœ€ç®€å•çš„å†…ç½®ç®—æ³•å…¥æ‰‹,è¿™ä¸ªç®—æ³•å°±æ˜¯å†…ç½®çš„åˆ†è¯å™¨,Tokenizer.</p>
<p>Tokenizeråªæ˜¯ç®€å•çš„å°†æ–‡æœ¬ä»¥ç©ºç™½éƒ¨åˆ†è¿›è¡Œåˆ†å‰²,åªé€‚åˆç»™è‹±æ–‡è¿›è¡Œåˆ†è¯,æ‰€ä»¥å®ƒçš„å®ç°åŠå…¶ç®€çŸ­,æºç å¦‚ä¸‹:</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.spark.ml.feature</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.annotation.<span class="type">Since</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.ml.<span class="type">UnaryTransformer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.ml.param._</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.ml.util._</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types.&#123;<span class="type">ArrayType</span>, <span class="type">DataType</span>, <span class="type">StringType</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A tokenizer that converts the input string to lowercase and then splits it by white spaces.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @see [[RegexTokenizer]]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Since</span>(<span class="string">&quot;1.2.0&quot;</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tokenizer</span> <span class="title">@Since</span>(<span class="params">&quot;1.4.0&quot;</span>) (<span class="params">@<span class="type">Since</span>(&quot;1.4.0&quot;</span>) <span class="title">override</span> <span class="title">val</span> <span class="title">uid</span></span>: <span class="type">String</span>)</span><br><span class="line">  <span class="keyword">extends</span> <span class="type">UnaryTransformer</span>[<span class="type">String</span>, <span class="type">Seq</span>[<span class="type">String</span>], <span class="type">Tokenizer</span>] <span class="keyword">with</span> <span class="type">DefaultParamsWritable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Since</span>(<span class="string">&quot;1.2.0&quot;</span>)</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">this</span></span>() = <span class="keyword">this</span>(<span class="type">Identifiable</span>.randomUID(<span class="string">&quot;tok&quot;</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">createTransformFunc</span></span>: <span class="type">String</span> =&gt; <span class="type">Seq</span>[<span class="type">String</span>] = &#123;</span><br><span class="line">    _.toLowerCase.split(<span class="string">&quot;\\s&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">validateInputType</span></span>(inputType: <span class="type">DataType</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    require(inputType == <span class="type">StringType</span>, <span class="string">s&quot;Input type must be string type but got <span class="subst">$inputType</span>.&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">outputDataType</span></span>: <span class="type">DataType</span> = <span class="keyword">new</span> <span class="type">ArrayType</span>(<span class="type">StringType</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Since</span>(<span class="string">&quot;1.4.1&quot;</span>)</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">copy</span></span>(extra: <span class="type">ParamMap</span>): <span class="type">Tokenizer</span> = defaultCopy(extra)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Since</span>(<span class="string">&quot;1.6.0&quot;</span>)</span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Tokenizer</span> <span class="keyword">extends</span> <span class="title">DefaultParamsReadable</span>[<span class="type">Tokenizer</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Since</span>(<span class="string">&quot;1.6.0&quot;</span>)</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">load</span></span>(path: <span class="type">String</span>): <span class="type">Tokenizer</span> = <span class="keyword">super</span>.load(path)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç®€å•åˆ†æä¸‹æºç :</p>
<ul>
<li>Tokenizerç»§æ‰¿äº†UnaryTransformerç±».unaryæ˜¯â€™ä¸€å…ƒâ€™çš„æ„æ€,ä¹Ÿæ˜¯è¯´è¿™ä¸ªç±»å®ç°çš„æ˜¯ç±»ä¼¼ä¸€å…ƒå‡½æ•°çš„åŠŸèƒ½,ä¸€ä¸ªè¾“å…¥å˜é‡,ä¸€ä¸ªè¾“å‡º.ç›´æ¥çœ‹UnaryTransformerçš„æºç æ³¨é‡Š:</li>
</ul>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* :: DeveloperApi ::</span></span><br><span class="line"><span class="comment">* Abstract class for transformers that take one input column, apply transformation, and output the</span></span><br><span class="line"><span class="comment">* result as a new column.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>DeveloperApiè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå¼€å‘çº§API,å¼€å‘è€…å¯ä»¥ç”¨,ä¸ä¼šæœ‰æƒé™é—®é¢˜(æºç ä¸­æœ‰å¾ˆå¤šprivate[spark]çš„ç±»,æ˜¯ä¸å…è®¸å¤–éƒ¨è°ƒç”¨çš„).<br>æ³¨é‡Šçš„å¤§æ„å°±æ˜¯:è¿™æ˜¯ä¸€ä¸ªä¸ºå®ç°transformerså‡†å¤‡çš„æŠ½è±¡ç±»,ä»¥ä¸€ä¸ªå­—æ®µ(åˆ—)ä¸ºè¾“å…¥,è¾“å‡ºä¸€ä¸ªæ–°å­—æ®µ(åˆ—).</p>
<p>æ‰€ä»¥å®é™…ä¸Šå°±æ˜¯å®ç°ä¸€ä¸ªTransformer,åªæ˜¯è¿™ä¸ªTransformeræœ‰æŒ‡å®šçš„è¾“å…¥å­—æ®µå’Œè¾“å‡ºå­—æ®µ.</p>
<ul>
<li>UnaryTransformerç±»ä¸­åªæœ‰ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•.<br>ä¸€ä¸ªæ˜¯createTransformFunc,æ˜¯æœ€æ ¸å¿ƒçš„æ–¹æ³•,è¿™ä¸ªæ–¹æ³•éœ€è¦è¿”å›ä¸€ä¸ªå‡½æ•°,è¿™ä¸ªå‡½æ•°çš„å‚æ•°å³Transformerçš„è¾“å…¥å­—æ®µçš„å€¼,è¿”å›å€¼ä¸ºTransformerçš„è¾“å‡ºå­—æ®µçš„å€¼.çœ‹çœ‹Tokenizerä¸­çš„å®ç°,å°±æ˜ç™½äº†.</li>
</ul>
<p>å¦ä¸€ä¸ªæ˜¯outputDataType,è¿™ä¸ªæ–¹æ³•ç”¨æ¥è¿”å›è¾“å‡ºå­—æ®µçš„ç±»å‹.</p>
<ul>
<li><p>validateInputTypeæ–¹æ³•æ˜¯ç”¨æ¥æ£€æŸ¥è¾“å…¥å­—æ®µç±»å‹çš„,çœ‹éœ€è¦å®ç°.</p>
</li>
<li><p>Tokenizeræ··å…¥äº†DefaultParamsWritableç‰¹è´¨,ä½¿å¾—è‡ªå·±å¯ä»¥è¢«ä¿å­˜.<br>  å¯¹åº”çš„object Tokenizerä¼´ç”Ÿå¯¹è±¡,ç”¨æ¥è¯»å–å·²ä¿å­˜çš„Tokenizer.</p>
</li>
<li><p>å€¼å¾—æ³¨æ„çš„æ˜¯,Transformerç±»æ˜¯PipelineStageç±»çš„å­ç±»,æ‰€ä»¥Transformerçš„å­ç±»,åŒ…æ‹¬æˆ‘ä»¬è‡ªå®šä¹‰çš„,æ˜¯å¯ä»¥ç›´æ¥ç”¨åœ¨<a href="http://spark.apache.org/docs/latest/ml-pipeline.html">ML Pipelines</a>ä¸­çš„.è¿™å°±å‰å®³äº†,è¯´æ˜è‡ªå®šä¹‰çš„ç®—æ³•ç±»,å¯ä»¥æ— ç¼ä¸å†…ç½®æœºå™¨å­¦ä¹ ç®—æ³•æ‰“é…åˆ,è¿˜èƒ½åˆ©ç”¨Pipelineçš„è°ƒä¼˜å·¥å…·(model selection,Cross-Validationç­‰).</p>
</li>
</ul>
<h1 id="åˆå‡ºèŒ…åº"><a href="#åˆå‡ºèŒ…åº" class="headerlink" title="åˆå‡ºèŒ…åº"></a>åˆå‡ºèŒ…åº</h1><p>çœ‹å®Œæºç ,åŸºæœ¬å¥—è·¯å·²ç»æ˜äº†,ä¸å¦‚åŠ¨æ‰‹æŠ„ä¸€ä¸ª,ä¸,æ•²ä¸€ä¸ª.<br>ä¾è‘«èŠ¦ç”»ç“¢,å®ç°ä¸€ä¸ªæ­£åˆ™æå–çš„Transformer.</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> util.matching.<span class="type">Regex</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.ml.<span class="type">UnaryTransformer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.ml.param.<span class="type">Param</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.ml.util.<span class="type">Identifiable</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types._</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æ­£åˆ™æå–å™¨</span></span><br><span class="line"><span class="comment">  * å°†åŒ¹é…æŒ‡å®šæ­£åˆ™è¡¨è¾¾å¼çš„å…¨éƒ¨å­å­—ç¬¦ä¸²ï¼Œæå–åˆ°array[string]ä¸­.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegexExtractor</span>(<span class="params">override val uid: <span class="type">String</span></span>)</span></span><br><span class="line">  <span class="keyword">extends</span> <span class="type">UnaryTransformer</span>[<span class="type">String</span>, <span class="type">Seq</span>[<span class="type">String</span>], <span class="type">RegexExtractor</span>] &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">this</span></span>() = <span class="keyword">this</span>(<span class="type">Identifiable</span>.randomUID(<span class="string">&quot;RegexExtractor&quot;</span>))</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å‚æ•°:æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @group param</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">val</span> regex = <span class="keyword">new</span> <span class="type">Param</span>[<span class="type">Regex</span>](<span class="keyword">this</span>, <span class="string">&quot;RegexExpr&quot;</span>, <span class="string">&quot;æ­£åˆ™è¡¨è¾¾å¼&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** @group setParam */</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">setRegexExpr</span></span>(value: <span class="type">String</span>): <span class="keyword">this</span>.<span class="keyword">type</span> = set(regex, <span class="keyword">new</span> <span class="type">Regex</span>(value))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">outputDataType</span></span>: <span class="type">DataType</span> = <span class="keyword">new</span> <span class="type">ArrayType</span>(<span class="type">StringType</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">validateInputType</span></span>(inputType: <span class="type">DataType</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    require(inputType == <span class="type">DataTypes</span>.<span class="type">StringType</span>,</span><br><span class="line">      <span class="string">s&quot;Input type must be string type but got <span class="subst">$inputType</span>.&quot;</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">createTransformFunc</span></span>: <span class="type">String</span> =&gt; <span class="type">Seq</span>[<span class="type">String</span>] = &#123;</span><br><span class="line">    parseContent</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ•°æ®å¤„ç†</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">parseContent</span></span>(text: <span class="type">String</span>): <span class="type">Seq</span>[<span class="type">String</span>] = &#123;</span><br><span class="line">    <span class="keyword">if</span> (text == <span class="literal">null</span> || text.isEmpty) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="type">Seq</span>.empty[<span class="type">String</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    $(regex).findAllIn(text).toSeq</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªç±»ç»“æ„ä¸Tokenizeræºç åŸºæœ¬å·®ä¸å¤š,å¤šç”¨åˆ°çš„Paramç±»,æ˜¯ä¸€ä¸ªå‚æ•°çš„åŒ…è£…ç±».<br>ä½œç”¨æ˜¯self-contained documentation and optionally default value.<br>å…¶å®å°±æ˜¯æŠŠå‚æ•°çš„å€¼,æ–‡æ¡£,é»˜è®¤å€¼ç­‰å±æ€§ç»„åˆæˆä¸€ä¸ªç±»,æ–¹ä¾¿è°ƒç”¨.</p>
<p>æ¯”å¦‚ä¸Šé¢å®šä¹‰çš„regexå‚æ•°,å°±å¯ä»¥ç”¨$(regex)è¿™æ ·çš„æ–¹å¼ç›´æ¥è°ƒç”¨.</p>
<p>å¦å¤–åœ¨org.apache.spark.ml.paramä¸­æœ‰å¾ˆå¤šå†…ç½®çš„Paramç±»,å¯ä»¥ç›´æ¥ä½¿ç”¨.</p>
<p>åŒæ—¶org.apache.spark.ml.param.sharedä¸­æœ‰å¾ˆå¤šè¾…åŠ©å¼•å…¥å‚æ•°çš„ç‰¹è´¨,æ¯”å¦‚HasInputColsç‰¹è´¨,ä½ çš„è‡ªå®šä¹‰Transformeråªè¦æ··å…¥è¿™ä¸ªç‰¹è´¨å°±æ‹¥æœ‰äº†inputColså‚æ•°.ä¸è¿‡ç›®å‰sharedä¸­ç‰¹è´¨çš„ä½œç”¨åŸŸæ˜¯private[ml],ä¹Ÿå°±æ˜¯è¯´ä¸èƒ½ç›´æ¥å¼•ç”¨,è€Œæ˜¯è¦copyä¸€ä»½ä»£ç åˆ°è‡ªå·±çš„é¡¹ç›®,å¹¶ä¿®æ”¹ä½œç”¨åŸŸæ‰è¡Œ.<br>å…³äºè¿™ä¸ªä½œç”¨åŸŸçš„é—®é¢˜,æœ‰äººåœ¨sparkçš„jiraä¸Šæåˆ°,æè®®å°†å…¶ä½œä¸ºDeveloperApiå¼€æ”¾å‡ºæ¥,æˆ‘ä¹ŸæŠ•äº†ä¸€ç¥¨è¡¨ç¤ºæ”¯æŒ.åæ¥åœ¨2017å¹´11æœˆç»ˆäºresolved,è¯¥é—®é¢˜å°†åœ¨Spark2.3.0ä¸­è§£å†³.<a href="https://issues.apache.org/jira/browse/SPARK-7146">è¯¦æƒ…æˆ³æˆ‘</a></p>
<h1 id="ç²—æ‡‚çš®æ¯›"><a href="#ç²—æ‡‚çš®æ¯›" class="headerlink" title="ç²—æ‡‚çš®æ¯›"></a>ç²—æ‡‚çš®æ¯›</h1><p>è‡ªå®šä¹‰çš„ç±»å†™å¥½äº†,è¯¥æ€ä¹ˆç”¨å‘¢? å½“ç„¶æ˜¯è·Ÿå†…ç½®çš„ä¸€æ ·å•¦.ä¸Šæ —å­:</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> regex=<span class="string">&quot;nidezhengze&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> tranTitle = <span class="keyword">new</span> <span class="type">RegexExtractor</span>()</span><br><span class="line">	.setInputCol(<span class="string">&quot;title&quot;</span>)</span><br><span class="line">	.setOutputCol(<span class="string">&quot;title_price_texts&quot;</span>)</span><br><span class="line">	.setRegexExpr(regex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> pipeline = <span class="keyword">new</span> <span class="type">Pipeline</span>().setStages(<span class="type">Array</span>(</span><br><span class="line">	tranTitle</span><br><span class="line">))</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> matched = pipeline.fit(data).transform(data)</span><br></pre></td></tr></table></figure>

<h1 id="æ‰“å®Œæ”¶åŠŸ"><a href="#æ‰“å®Œæ”¶åŠŸ" class="headerlink" title="æ‰“å®Œæ”¶åŠŸ"></a>æ‰“å®Œæ”¶åŠŸ</h1><p>åˆ°è¿™é‡Œ,å¼€å‘ç®€å•Transformçš„å¥—è·¯å·²ç»æ¸…æ¥šäº†,ä¸è¿‡è¿™é‡Œå®ç°çš„åŠŸèƒ½æ¯”è¾ƒç±»ä¼¼äºä¸€ä¸ªUDF,åªèƒ½å¯¹datasetçš„ä¸€ä¸ªå­—æ®µè¿›è¡Œå¤„ç†,è€Œä¸”æ˜¯é€è¡Œå¤„ç†,å¹¶ä¸èƒ½æ ¹æ®å¤šè¡Œæ•°æ®è¿›è¡Œå¤„ç†,å®ç°çª—å£å‡½æ•°ç±»ä¼¼çš„åŠŸèƒ½,è€Œä¸”ä¹Ÿæ²¡æœ‰æ¶‰åŠæ¨¡å‹çš„è¾“å‡º.å¦‚æœè¦å¼€å‘æ›´å¤æ‚çš„ç®—æ³•,ç”šè‡³è¿›è¡Œæ¨¡å‹è®­ç»ƒ,å°±éœ€è¦æ›´æ·±å…¥çš„äº†è§£MLlibäº†,é˜…è¯»æºç æ˜¯ä¸ªå¥½é€”å¾„.</p>
<p>æœ‰æœºä¼šå†è¯´.ğŸ‘‹</p>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>ML</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸€æ¡é€šå¾€æœåŠ¡å™¨æ‰€æœ‰ç«¯å£çš„éš§é“</title>
    <url>/2017/06/13/ssh-tunnel-with-windows/</url>
    <content><![CDATA[<p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/tunnel-899053_640.jpg"></p>
<h1 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h1><p>é€šå¸¸ä¸ºäº†å®‰å…¨,æœåŠ¡å™¨éœ€è¦é€šè¿‡è·³æ¿æœºè®¿é—®ï¼ŒæœåŠ¡å™¨å¯¹å¤–ç½‘æš´éœ²çš„ç«¯å£ä¹Ÿä¸¥æ ¼é™åˆ¶ã€‚è¿™ç§æƒ…å†µä¸‹è‹¥è¦åœ¨æœ¬åœ°<br>è®¿é—®æœåŠ¡å™¨ä¸Šçš„æœåŠ¡æˆ–ç³»ç»Ÿå°±ä¼šæ¯”è¾ƒè›‹ç–¼ã€‚<br>æœ‰ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯åœ¨æœ¬åœ°å’Œè·³æ¿æœºä¹‹é—´å»ºç«‹SSHéš§é“ã€‚SSHéš§é“æä¾›äº†ä¸€ä¸ªç½‘ç»œä»£ç†æœåŠ¡ï¼Œ<br>é€šè¿‡è¯¥ä»£ç†æœåŠ¡å¯ä»¥ç›´æ¥è®¿é—®è·³æ¿æœºæ‰€åœ¨çš„å±€åŸŸç½‘ï¼Œå³æœåŠ¡å™¨ä¸Šçš„ä»»æ„ç«¯å£ï¼ŒæœåŠ¡éƒ½å¯ä»¥ç›´æ¥è®¿é—®ã€‚</p>
<p>æœ¬æ–‡ä»‹ç»çš„æ–¹æ³•æ¯”ä¸€èˆ¬çš„ç«¯å£æ˜ å°„æ›´æ–¹ä¾¿ï¼Œä¸éœ€è¦ä¸ºæ¯ä¸ªç«¯å£é…ç½®ä¸€æ¡SSHéš§é“ï¼ŒåŒ…æ‹¬Windowsã€Macã€Linuxä¸Šçš„æ“ä½œæ–¹æ³•ã€‚</p>
<span id="more"></span>

<h1 id="SSHéš§é“å»ºç«‹"><a href="#SSHéš§é“å»ºç«‹" class="headerlink" title="SSHéš§é“å»ºç«‹"></a>SSHéš§é“å»ºç«‹</h1><h2 id="Mac-amp-Linux-ç‰ˆ"><a href="#Mac-amp-Linux-ç‰ˆ" class="headerlink" title="Mac &amp; Linux ç‰ˆ"></a>Mac &amp; Linux ç‰ˆ</h2><p>éå¸¸ç®€å•ï¼Œåªéœ€ä¸€æ¡å‘½ä»¤å³å¯å»ºç«‹SSHéš§é“ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh user@host -ND 127.0.0.1:1080</span><br></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯åœ¨å¸¸è§„çš„SSHå‘½ä»¤åŠ ä¸Š<code>-D</code>å‚æ•°ï¼Œå¼€å¯åŠ¨æ€ç«¯å£è½¬å‘ï¼Œä½¿SSHæˆä¸ºäº†SOCKS serverï¼Œåœ¨åå°æä¾›ç½‘ç»œæœåŠ¡ã€‚</p>
<p>è€Œ<code>-N</code>å‚æ•°æ˜¯è®©sshä¸è¦è¿”å›å‘½ä»¤è¡Œç»ˆç«¯ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦å‘é€å‘½ä»¤ï¼Œåªæ˜¯åšè½¬å‘ã€‚</p>
<p>1080æ˜¯ç»‘å®šçš„æœ¬åœ°ç«¯å£ï¼Œä¹Ÿå°±æ˜¯SOCKS serveræä¾›æœåŠ¡çš„ç«¯å£ï¼Œå¯ä»¥æ¢æˆå…¶ä»–ç«¯å£å·ã€‚</p>
<p>127.0.0.1è¡¨ç¤ºåªèƒ½æœ‰ä½ æœ¬æœºè®¿é—®è¿™ä¸ªæœåŠ¡ï¼Œå»æ‰IPåªç•™ä¸‹ç«¯å£å·çš„è¯ï¼Œå°±æ²¡æœ‰è¿™ä¸ªé™åˆ¶äº†ã€‚</p>
<p>PS:SSHéš§é“ç›¸å½“äºåœ¨æœåŠ¡å™¨çš„é˜²ç«å¢™ä¸Šæ‰“äº†ä¸ªæ´ï¼Œå¯èƒ½æœ‰å®‰å…¨éšæ‚£ï¼Œæ‰€ä»¥å»ºè®®åŠ ä¸Šä»…é™æœ¬æœºè®¿é—®çš„é™åˆ¶ã€‚</p>
<h2 id="Windowsç‰ˆ"><a href="#Windowsç‰ˆ" class="headerlink" title="Windowsç‰ˆ"></a>Windowsç‰ˆ</h2><p>è¿™é‡Œä½¿ç”¨Windowsä¸Šå¸¸ç”¨çš„XShellåšè¯´æ˜ã€‚</p>
<h3 id="1-é…ç½®å¸¸è§„çš„SSHè¿æ¥"><a href="#1-é…ç½®å¸¸è§„çš„SSHè¿æ¥" class="headerlink" title="1.é…ç½®å¸¸è§„çš„SSHè¿æ¥"></a>1.é…ç½®å¸¸è§„çš„SSHè¿æ¥</h3><p>é…ç½®ç”¨æˆ·åï¼Œå¯†ç ï¼Œä¸»æœºåœ°å€(é€šå¸¸æ˜¯è·³æ¿æœº)ç­‰ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/xshell-1.png" alt="xshell-1"></p>
<h3 id="2-æ·»åŠ éš§é“"><a href="#2-æ·»åŠ éš§é“" class="headerlink" title="2.æ·»åŠ éš§é“"></a>2.æ·»åŠ éš§é“</h3><p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/xshell-2.png" alt="xshell-2"></p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/xshell-3.png" alt="xshell-3"></p>
<h3 id="3-å…¶ä»–"><a href="#3-å…¶ä»–" class="headerlink" title="3.å…¶ä»–"></a>3.å…¶ä»–</h3><p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/xshell-4.png" alt="xshell-4"></p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/xshell-5.png" alt="xshell-5"></p>
<h1 id="SSHéš§é“ä½¿ç”¨"><a href="#SSHéš§é“ä½¿ç”¨" class="headerlink" title="SSHéš§é“ä½¿ç”¨"></a>SSHéš§é“ä½¿ç”¨</h1><h2 id="è®©æµè§ˆå™¨è®¿é—®å†…ç½‘æœåŠ¡"><a href="#è®©æµè§ˆå™¨è®¿é—®å†…ç½‘æœåŠ¡" class="headerlink" title="è®©æµè§ˆå™¨è®¿é—®å†…ç½‘æœåŠ¡"></a>è®©æµè§ˆå™¨è®¿é—®å†…ç½‘æœåŠ¡</h2><p>è¿™é‡Œä»‹ç»Chromeæµè§ˆå™¨+SwitchyOmegaæ’ä»¶çš„æ–¹æ³•ã€‚</p>
<p>SwitchyOmegaæ˜¯ä¸€ä¸ªChromeæ’ä»¶ï¼Œä¸‹è½½å®‰è£…åœ°å€ï¼š<br><a href="https://chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif">Chromeåº”ç”¨å•†åº—</a><br>æˆ–è€… <a href="https://www.switchyomega.com/download/">å®˜ç½‘ä¸‹è½½</a></p>
<p>å®‰è£…å¥½åï¼Œæ‰¾åˆ°æ’ä»¶å›¾æ ‡ï¼ˆä¸€ä¸ªåœ†åœˆï¼‰ï¼Œå•å‡»å›¾æ ‡-&gt;é€‰é¡¹ï¼Œæ‰“å¼€é…ç½®é¡µé¢ã€‚<br>ç‚¹å‡»ä¾§è¾¹æ çš„â€œæ–°å»ºæƒ…æ™¯æ¨¡å¼ï¼ˆNew Profileï¼‰â€ï¼Œæ·»åŠ ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼ˆProxy Profileï¼‰ï¼Œ<br>é…ç½®å¦‚ä¸‹å›¾ã€‚æ³¨æ„ç«¯å£è¦å¡«å†™å‰é¢SSHéš§é“æœåŠ¡çš„ç«¯å£å·ã€‚</p>
<p>å¦‚æœä¾§è¾¹æ ä¸­å·²ç»æœ‰ä¸€ä¸ªé»˜è®¤çš„â€™proxyâ€˜æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‹¿æ¥ä¿®æ”¹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/switch-1.png" alt="switch-1"></p>
<p>é…ç½®å¥½åå•å‡»SwitchyOmegaçš„å›¾æ ‡ï¼Œåˆ‡æ¢åˆ°æ–°å»ºçš„æƒ…æ™¯æ¨¡å¼ï¼Œç„¶åæ‰€æœ‰çš„æµè§ˆå™¨è¯·æ±‚éƒ½ä¼šä»¥SSHéš§é“ä½œä¸º<br>ä»£ç†äº†ï¼Œè¿™æ—¶ä½ åº”è¯¥å·²ç»å¯ä»¥è®¿é—®æœåŠ¡å™¨ä¸Šçš„ä»»ä½•webæœåŠ¡äº†ã€‚</p>
<p>ä½†æ˜¯ï¼æˆ‘ä»¬å¹¶ä¸éœ€è¦æ‰€æœ‰çš„æµè§ˆå™¨æµé‡éƒ½èµ°ä»£ç†å“‡ã€‚SwitchyOmegaå…¶å®å¯ä»¥æ ¹æ®URLçš„è§„åˆ™ï¼Œè‡ªåŠ¨é€‰æ‹©èµ°ä¸èµ°ä»£ç†ã€‚<br>é»˜è®¤å·²ç»å­˜åœ¨çš„ä¸€ä¸ªæƒ…æ™¯æ¨¡å¼â€™auto switchâ€˜ï¼Œå°±æ˜¯ä¸€ä¸ªå¯ä»¥æ ¹æ®è§„åˆ™æ¥è‡ªåŠ¨é€‰æ‹©ä»£ç†æœåŠ¡çš„æ¨¡å¼ã€‚<br>æ¯”å¦‚åœ¨â€™auto switchâ€˜æ¨¡å¼ä¸­é…ç½®ä¸€æ¡è§„åˆ™ï¼Œå¡«å†™<code>10.1.*</code>ï¼Œå¹¶é€‰æ‹©proxyæ¨¡å¼ã€‚è¿™å°±ä»£è¡¨å°†<code>10.1.</code><br>å¼€å¤´çš„æ‰€æœ‰è¯·æ±‚éƒ½ç”¨proxyæ¨¡å¼è½¬å‘ï¼Œè€Œå…¶ä»–ä¸æ»¡è¶³è§„åˆ™çš„è¯·æ±‚ï¼Œå°†å‘½ä¸­æœ€åä¸€æ¡â€™é»˜è®¤â€˜è§„åˆ™ï¼Œ<br>è¿›è¡Œâ€™ç›´æ¥è®¿é—®â€˜ï¼Œå³ä¸ä½¿ç”¨ä»»ä½•ä»£ç†æœåŠ¡ã€‚</p>
<h2 id="ä¸Proxifieré…åˆä½¿ç”¨"><a href="#ä¸Proxifieré…åˆä½¿ç”¨" class="headerlink" title="ä¸Proxifieré…åˆä½¿ç”¨"></a>ä¸Proxifieré…åˆä½¿ç”¨</h2><p>å¯ä»¥è®©ä»»æ„ç¨‹åºè®¿é—®æœåŠ¡å™¨ä¸Šçš„æœåŠ¡åŠç«¯å£,å®ç°å¦‚ä¸‹æ“ä½œï¼š</p>
<ul>
<li>ä½¿ç”¨å®¢æˆ·ç«¯ï¼ˆå¦‚Navicatï¼‰è®¿é—®æœåŠ¡ä¸Šçš„æ•°æ®åº“(å¦‚æ²¡æœ‰å¯¹å…¬ç½‘æš´éœ²çš„MySQL)ï¼›</li>
<li>è®©æœ¬åœ°è¿è¡Œçš„ä»£ç è®¿é—®æœåŠ¡å™¨å†…ç½‘æœåŠ¡ï¼Œæ¯”å¦‚HDFS,Hive,Hbase,ESç­‰ç­‰ã€‚ï¼ˆå¯¹äºå¤§æ•°æ®å¼€å‘éå¸¸å®ç”¨ï¼Œ<br>å¯ä»¥æ„‰å¿«çš„æ‰“æ–­ç‚¹è°ƒè¯•Sparkåº”ç”¨ï¼‰</li>
</ul>
<h3 id="é…ç½®æ–¹æ³•"><a href="#é…ç½®æ–¹æ³•" class="headerlink" title="é…ç½®æ–¹æ³•"></a>é…ç½®æ–¹æ³•</h3><h4 id="1-é…ç½®ä»£ç†æœåŠ¡å™¨"><a href="#1-é…ç½®ä»£ç†æœåŠ¡å™¨" class="headerlink" title="1 é…ç½®ä»£ç†æœåŠ¡å™¨"></a>1 é…ç½®ä»£ç†æœåŠ¡å™¨</h4><p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/proxifier-0.png"></p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/proxifier-1.png"></p>
<h4 id="2-é…ç½®è§„åˆ™"><a href="#2-é…ç½®è§„åˆ™" class="headerlink" title="2 é…ç½®è§„åˆ™"></a>2 é…ç½®è§„åˆ™</h4><p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/proxifier-2.png"></p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/proxifier-3.png"></p>
<h3 id="3-ä½¿ç”¨è¯´æ˜"><a href="#3-ä½¿ç”¨è¯´æ˜" class="headerlink" title="3 ä½¿ç”¨è¯´æ˜"></a>3 ä½¿ç”¨è¯´æ˜</h3><p>é…ç½®å¥½è§„åˆ™åï¼Œæœ¬åœ°åº”ç”¨å°±å¯ä»¥ç›´æ¥è®¿é—®æœåŠ¡å™¨çš„å†…ç½‘IPäº†ã€‚</p>
<p>æ¯”å¦‚è¿æ¥æ•°æ®åº“ï¼š</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/ssh-tunnel/navicat.png"></p>
]]></content>
      <tags>
        <tag>SSH</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxé…ç½®SSHå…å¯†ç™»é™†(å…¬ç§é’¥ç™»é™†)</title>
    <url>/2018/03/05/ssh-without-password/</url>
    <content><![CDATA[<h1 id="ç¯å¢ƒè¯´æ˜"><a href="#ç¯å¢ƒè¯´æ˜" class="headerlink" title="ç¯å¢ƒè¯´æ˜"></a>ç¯å¢ƒè¯´æ˜</h1><p>å®¢æˆ·æœº:Mac OS X</p>
<p>æœåŠ¡å™¨:CentOS 6.5</p>
<p>å®¢æˆ·ç«¯:OpenSSH,OS XåŠå¤§å¤šæ•°Linuxéƒ½å†…ç½®äº†OpenSSH.â€™ssh -vâ€™å‘½ä»¤å¯ä»¥æŸ¥çœ‹ç‰ˆæœ¬.</p>
<span id="more"></span>

<h1 id="å¤§è‡´æµç¨‹"><a href="#å¤§è‡´æµç¨‹" class="headerlink" title="å¤§è‡´æµç¨‹"></a>å¤§è‡´æµç¨‹</h1><ul>
<li><p>1.åœ¨å®¢æˆ·æœºåˆ›å»ºä¸€å¯¹å¯†é’¥æ–‡ä»¶,åŒ…æ‹¬å…¬é’¥æ–‡ä»¶(<del>&#x2F;.ssh&#x2F;id_rsa.pub),ç§é’¥æ–‡ä»¶(</del>&#x2F;.ssh&#x2F;id_rsa).</p>
</li>
<li><p>2.æŠŠå…¬é’¥æ”¾åˆ°æœåŠ¡å™¨ä¸Šï¼ˆ~&#x2F;.ssh&#x2F;authorized_keysï¼‰,åœ¨ä½¿ç”¨sshç™»å½•æ—¶ï¼Œsshç¨‹åºä¼šå‘é€ç§é’¥å»å’ŒæœåŠ¡å™¨ä¸Šçš„å…¬é’¥åšåŒ¹é…ã€‚å¦‚æœåŒ¹é…æˆåŠŸå°±å¯ä»¥è‡ªåŠ¨ç™»å½•äº†ã€‚</p>
</li>
</ul>
<h1 id="å®¢æˆ·æœºé…ç½®"><a href="#å®¢æˆ·æœºé…ç½®" class="headerlink" title="å®¢æˆ·æœºé…ç½®"></a>å®¢æˆ·æœºé…ç½®</h1><ul>
<li><p>1.æŸ¥çœ‹~&#x2F;.sshæ–‡ä»¶å¤¹,è‹¥å·²ç»å­˜åœ¨æœ‰å…¬é’¥æ–‡ä»¶(id_rsa.pub),ç§é’¥æ–‡ä»¶(id_rsa),åˆ™å¯ä»¥è·³è¿‡å®¢æˆ·ç«¯é…ç½®.</p>
</li>
<li><p>2.ç”Ÿæˆå¯†é’¥æ–‡ä»¶.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh-keygen</span><br></pre></td></tr></table></figure>
<p>ç„¶åä¸€è·¯å›è½¦.<br>ç„¶å~&#x2F;.sshä¸‹ä¼šç”Ÿæˆid_rsa.pubå’Œid_rsa, å…¶ä¸­id_rsaæ–‡ä»¶èµ·åˆ°å”¯ä¸€æ ‡è¯†ä½ çš„å®¢æˆ·æœºçš„ä½œç”¨.</p>
</li>
</ul>
<p>æ³¨æ„:ä¸è¦æ”¹è¿™ä¸¤ä¸ªæ–‡ä»¶çš„æ–‡ä»¶å,sshç™»é™†æ—¶ä¼šè¯»å–id_rsaæ–‡ä»¶.</p>
<h1 id="æœåŠ¡å™¨é…ç½®"><a href="#æœåŠ¡å™¨é…ç½®" class="headerlink" title="æœåŠ¡å™¨é…ç½®"></a>æœåŠ¡å™¨é…ç½®</h1><h2 id="1-ä¿®æ”¹sshdé…ç½®æ–‡ä»¶-x2F-etc-x2F-ssh-x2F-sshd-config"><a href="#1-ä¿®æ”¹sshdé…ç½®æ–‡ä»¶-x2F-etc-x2F-ssh-x2F-sshd-config" class="headerlink" title="1.ä¿®æ”¹sshdé…ç½®æ–‡ä»¶(&#x2F;etc&#x2F;ssh&#x2F;sshd_config)."></a>1.ä¿®æ”¹sshdé…ç½®æ–‡ä»¶(&#x2F;etc&#x2F;ssh&#x2F;sshd_config).</h2><p>æ‰¾åˆ°ä»¥ä¸‹å†…å®¹ï¼Œå¹¶å»æ‰æ³¨é‡Šç¬¦â€#â€œ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ã€€ã€€RSAAuthentication yes</span><br><span class="line">ã€€ã€€PubkeyAuthentication yes</span><br><span class="line">ã€€ã€€AuthorizedKeysFile  .ssh/authorized_keys</span><br></pre></td></tr></table></figure>

<h2 id="2-é…ç½®authorized-keysæ–‡ä»¶"><a href="#2-é…ç½®authorized-keysæ–‡ä»¶" class="headerlink" title="2.é…ç½®authorized_keysæ–‡ä»¶."></a>2.é…ç½®authorized_keysæ–‡ä»¶.</h2><p>è‹¥â€™~&#x2F;.ssh&#x2F;authorized_keysâ€™ä¸å­˜åœ¨,åˆ™å»ºç«‹.sshæ–‡ä»¶å¤¹å’Œauthorized_keysæ–‡ä»¶.</p>
<p>å°†ä¸Šæ–‡ä¸­å®¢æˆ·æœºid_rsa.pubçš„å†…å®¹æ‹·è´åˆ°authorized_keysä¸­.</p>
<p>PS:å¯ä»¥åœ¨å®¢æˆ·æœºä¸­æ‰§è¡Œå‘½ä»¤æ¥æ‹·è´:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat ~/.ssh/id_rsa.pub | ssh user@host â€œcat - &gt;&gt; ~/.ssh/authorized_keysâ€</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„:</p>
<ul>
<li>1 .sshç›®å½•çš„æƒé™å¿…é¡»æ˜¯700</li>
<li>2 .ssh&#x2F;authorized_keysæ–‡ä»¶æƒé™å¿…é¡»æ˜¯600</li>
</ul>
<h2 id="3-é‡å¯sshd"><a href="#3-é‡å¯sshd" class="headerlink" title="3.é‡å¯sshd."></a>3.é‡å¯sshd.</h2><p>$ &#x2F;etc&#x2F;init.d&#x2F;sshd restart</p>
<h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><p>å®¢æˆ·æœºæ‰§è¡Œ:<code>ssh -v user@host (-v è°ƒè¯•æ¨¡å¼)</code></p>
<p>ä¼šæ˜¾ç¤ºä¸€äº›ç™»é™†ä¿¡æ¯.<br>è‹¥ç™»é™†å¤±è´¥,æˆ–è€…ä»ç„¶è¦è¾“å…¥å¯†ç ,å¯ä»¥åœ¨æœåŠ¡å™¨æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶:&#x2F;var&#x2F;log&#x2F;secure.</p>
<p>è‹¥ç™»é™†æˆåŠŸ,åˆ™ä»¥åå°±å¯ä»¥ç”¨<code>ssh user@host</code> ç›´æ¥ç™»é™†äº†,ä¸ç”¨è¾“å…¥å¯†ç .</p>
]]></content>
      <tags>
        <tag>SSH</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Spark API å…¨é›†(2):Spark SQL å‡½æ•°å…¨é›†</title>
    <url>/2018/03/23/spark-sql-functions-api/</url>
    <content><![CDATA[<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>org.apache.spark.sql.functionsæ˜¯ä¸€ä¸ªObjectï¼Œæä¾›äº†çº¦ä¸¤ç™¾å¤šä¸ªå‡½æ•°ã€‚</p>
<p>å¤§éƒ¨åˆ†å‡½æ•°ä¸Hiveçš„å·®ä¸å¤šã€‚</p>
<p>é™¤UDFå‡½æ•°ï¼Œå‡å¯åœ¨spark-sqlä¸­ç›´æ¥ä½¿ç”¨ã€‚</p>
<p>ç»è¿‡import org.apache.spark.sql.functions._ ï¼Œä¹Ÿå¯ä»¥ç”¨äºDataframeï¼ŒDatasetã€‚</p>
<p>version<br>2.3.0</p>
<p>å¤§éƒ¨åˆ†æ”¯æŒColumnçš„å‡½æ•°ä¹Ÿæ”¯æŒStringç±»å‹çš„åˆ—åã€‚è¿™äº›å‡½æ•°çš„è¿”å›ç±»å‹åŸºæœ¬éƒ½æ˜¯Columnã€‚</p>
<p>å‡½æ•°å¾ˆå¤šï¼Œéƒ½åœ¨ä¸‹é¢äº†ã€‚</p>
<span id="more"></span>

<h1 id="èšåˆå‡½æ•°"><a href="#èšåˆå‡½æ•°" class="headerlink" title="èšåˆå‡½æ•°"></a>èšåˆå‡½æ•°</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">approx_count_distinct</span><br><span class="line">count_distinctè¿‘ä¼¼å€¼</span><br><span class="line"></span><br><span class="line">avg</span><br><span class="line">å¹³å‡å€¼</span><br><span class="line"></span><br><span class="line">collect_list</span><br><span class="line">èšåˆæŒ‡å®šå­—æ®µçš„å€¼åˆ°list</span><br><span class="line"></span><br><span class="line">collect_set</span><br><span class="line">èšåˆæŒ‡å®šå­—æ®µçš„å€¼åˆ°set</span><br><span class="line"></span><br><span class="line">corr</span><br><span class="line">è®¡ç®—ä¸¤åˆ—çš„<span class="type">Pearson</span>ç›¸å…³ç³»æ•°</span><br><span class="line"></span><br><span class="line">count</span><br><span class="line">è®¡æ•°</span><br><span class="line"></span><br><span class="line">countDistinct</span><br><span class="line">å»é‡è®¡æ•° <span class="type">SQL</span>ä¸­ç”¨æ³•</span><br><span class="line">select count(distinct <span class="class"><span class="keyword">class</span>)</span></span><br><span class="line"></span><br><span class="line">covar_pop</span><br><span class="line">æ€»ä½“åæ–¹å·®ï¼ˆpopulation covarianceï¼‰</span><br><span class="line"></span><br><span class="line">covar_samp</span><br><span class="line">æ ·æœ¬åæ–¹å·®ï¼ˆsample covarianceï¼‰</span><br><span class="line"></span><br><span class="line">first</span><br><span class="line">åˆ†ç»„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br><span class="line"></span><br><span class="line">last</span><br><span class="line">åˆ†ç»„æœ€åä¸€ä¸ªå…ƒç´ </span><br><span class="line"></span><br><span class="line">grouping</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">grouping_id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kurtosis</span><br><span class="line"> è®¡ç®—å³°æ€(kurtosis)å€¼</span><br><span class="line"></span><br><span class="line">skewness</span><br><span class="line"> è®¡ç®—ååº¦(skewness)</span><br><span class="line"></span><br><span class="line">max</span><br><span class="line">æœ€å¤§å€¼</span><br><span class="line"></span><br><span class="line">min</span><br><span class="line">æœ€å°å€¼</span><br><span class="line"></span><br><span class="line">mean</span><br><span class="line">å¹³å‡å€¼</span><br><span class="line"></span><br><span class="line">stddev</span><br><span class="line"> å³stddev_samp</span><br><span class="line"></span><br><span class="line">stddev_samp</span><br><span class="line"> æ ·æœ¬æ ‡å‡†åå·®ï¼ˆsample standard deviationï¼‰</span><br><span class="line"></span><br><span class="line">stddev_pop</span><br><span class="line">æ€»ä½“æ ‡å‡†åå·®ï¼ˆpopulation standard deviationï¼‰</span><br><span class="line"></span><br><span class="line">sum</span><br><span class="line">æ±‚å’Œ</span><br><span class="line"></span><br><span class="line">sumDistinct</span><br><span class="line">éé‡å¤å€¼æ±‚å’Œ <span class="type">SQL</span>ä¸­ç”¨æ³•</span><br><span class="line">select sum(distinct <span class="class"><span class="keyword">class</span>)</span></span><br><span class="line"></span><br><span class="line">var_pop</span><br><span class="line">æ€»ä½“æ–¹å·®ï¼ˆpopulation varianceï¼‰</span><br><span class="line"></span><br><span class="line">var_samp</span><br><span class="line">æ ·æœ¬æ— åæ–¹å·®ï¼ˆunbiased varianceï¼‰</span><br><span class="line"></span><br><span class="line">variance</span><br><span class="line">å³var_samp</span><br></pre></td></tr></table></figure>
<h1 id="é›†åˆå‡½æ•°"><a href="#é›†åˆå‡½æ•°" class="headerlink" title="é›†åˆå‡½æ•°"></a>é›†åˆå‡½æ•°</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">array_contains(column,value)</span><br><span class="line">æ£€æŸ¥arrayç±»å‹å­—æ®µæ˜¯å¦åŒ…å«æŒ‡å®šå…ƒç´ </span><br><span class="line"></span><br><span class="line">explode</span><br><span class="line"> å±•å¼€arrayæˆ–mapä¸ºå¤šè¡Œ</span><br><span class="line"></span><br><span class="line">explode_outer</span><br><span class="line">åŒexplodeï¼Œä½†å½“arrayæˆ–mapä¸ºç©ºæˆ–<span class="literal">null</span>æ—¶ï¼Œä¼šå±•å¼€ä¸º<span class="literal">null</span>ã€‚</span><br><span class="line"></span><br><span class="line">posexplode</span><br><span class="line">åŒexplodeï¼Œå¸¦ä½ç½®ç´¢å¼•ã€‚</span><br><span class="line"></span><br><span class="line">posexplode_outer</span><br><span class="line">åŒexplode_outerï¼Œå¸¦ä½ç½®ç´¢å¼•ã€‚</span><br><span class="line"></span><br><span class="line">from_json</span><br><span class="line">è§£æ<span class="type">JSON</span>å­—ç¬¦ä¸²ä¸º<span class="type">StructType</span> or <span class="type">ArrayType</span>ï¼Œæœ‰å¤šç§å‚æ•°å½¢å¼ï¼Œè¯¦è§æ–‡æ¡£ã€‚</span><br><span class="line"></span><br><span class="line">to_json</span><br><span class="line">è½¬ä¸ºjsonå­—ç¬¦ä¸²ï¼Œæ”¯æŒ<span class="type">StructType</span>, <span class="type">ArrayType</span> of <span class="type">StructTypes</span>, a <span class="type">MapType</span> or <span class="type">ArrayType</span> of <span class="type">MapTypes</span>ã€‚</span><br><span class="line"></span><br><span class="line">get_json_object(column,path)</span><br><span class="line">è·å–æŒ‡å®šjsonè·¯å¾„çš„jsonå¯¹è±¡å­—ç¬¦ä¸²ã€‚</span><br><span class="line">select get_json_object(&#x27;&#123;<span class="string">&quot;a&quot;</span><span class="number">1</span>,<span class="string">&quot;b&quot;</span>:<span class="number">2</span>&#125;&#x27;,&#x27;$.a&#x27;);</span><br><span class="line">[<span class="type">JSON</span> <span class="type">Path</span>ä»‹ç»](http:<span class="comment">//blog.csdn.net/koflance/article/details/63262484)</span></span><br><span class="line"></span><br><span class="line">json_tuple(column,fields)</span><br><span class="line">è·å–jsonä¸­æŒ‡å®šå­—æ®µå€¼ã€‚select json_tuple(&#x27;&#123;<span class="string">&quot;a&quot;</span>:<span class="number">1</span>,<span class="string">&quot;b&quot;</span>:<span class="number">2</span>&#125;&#x27;,&#x27;a&#x27;,&#x27;b&#x27;);</span><br><span class="line"></span><br><span class="line">map_keys</span><br><span class="line">è¿”å›mapçš„é”®ç»„æˆçš„array</span><br><span class="line"></span><br><span class="line">map_values</span><br><span class="line">è¿”å›mapçš„å€¼ç»„æˆçš„array</span><br><span class="line"></span><br><span class="line">size</span><br><span class="line">array or mapçš„é•¿åº¦</span><br><span class="line"></span><br><span class="line">sort_array(e: <span class="type">Column</span>, asc: <span class="type">Boolean</span>)</span><br><span class="line">å°†arrayä¸­å…ƒç´ æ’åºï¼ˆè‡ªç„¶æ’åºï¼‰ï¼Œé»˜è®¤ascã€‚</span><br></pre></td></tr></table></figure>
<h1 id="æ—¶é—´å‡½æ•°"><a href="#æ—¶é—´å‡½æ•°" class="headerlink" title="æ—¶é—´å‡½æ•°"></a>æ—¶é—´å‡½æ•°</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">add_months(startDate: <span class="type">Column</span>, numMonths: <span class="type">Int</span>)</span><br><span class="line">æŒ‡å®šæ—¥æœŸæ·»åŠ næœˆ</span><br><span class="line"></span><br><span class="line">date_add(start: <span class="type">Column</span>, days: <span class="type">Int</span>)</span><br><span class="line">æŒ‡å®šæ—¥æœŸä¹‹ånå¤© e.g. select date_add(&#x27;<span class="number">2018</span><span class="number">-01</span><span class="number">-01</span>&#x27;,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">date_sub(start: <span class="type">Column</span>, days: <span class="type">Int</span>)</span><br><span class="line">æŒ‡å®šæ—¥æœŸä¹‹å‰nå¤©</span><br><span class="line"></span><br><span class="line">datediff(end: <span class="type">Column</span>, start: <span class="type">Column</span>)</span><br><span class="line">ä¸¤æ—¥æœŸé—´éš”å¤©æ•°</span><br><span class="line"></span><br><span class="line">current_date()</span><br><span class="line">å½“å‰æ—¥æœŸ</span><br><span class="line"></span><br><span class="line">current_timestamp()</span><br><span class="line">å½“å‰æ—¶é—´æˆ³ï¼Œ<span class="type">TimestampType</span>ç±»å‹</span><br><span class="line"></span><br><span class="line">date_format(dateExpr: <span class="type">Column</span>, format: <span class="type">String</span>)</span><br><span class="line">æ—¥æœŸæ ¼å¼åŒ–</span><br><span class="line"></span><br><span class="line">dayofmonth(e: <span class="type">Column</span>)</span><br><span class="line">æ—¥æœŸåœ¨ä¸€æœˆä¸­çš„å¤©æ•°ï¼Œæ”¯æŒ date/timestamp/string</span><br><span class="line"></span><br><span class="line">dayofyear(e: <span class="type">Column</span>)</span><br><span class="line">æ—¥æœŸåœ¨ä¸€å¹´ä¸­çš„å¤©æ•°ï¼Œ æ”¯æŒ date/timestamp/string</span><br><span class="line"></span><br><span class="line">weekofyear(e: <span class="type">Column</span>)</span><br><span class="line">æ—¥æœŸåœ¨ä¸€å¹´ä¸­çš„å‘¨æ•°ï¼Œ æ”¯æŒ date/timestamp/string</span><br><span class="line"></span><br><span class="line">from_unixtime(ut: <span class="type">Column</span>, f: <span class="type">String</span>)</span><br><span class="line">æ—¶é—´æˆ³è½¬å­—ç¬¦ä¸²æ ¼å¼</span><br><span class="line"></span><br><span class="line">from_utc_timestamp(ts: <span class="type">Column</span>, tz: <span class="type">String</span>)</span><br><span class="line">æ—¶é—´æˆ³è½¬æŒ‡å®šæ—¶åŒºæ—¶é—´æˆ³</span><br><span class="line"></span><br><span class="line">to_utc_timestamp(ts: <span class="type">Column</span>, tz: <span class="type">String</span>)</span><br><span class="line">æŒ‡å®šæ—¶åŒºæ—¶é—´æˆ³è½¬<span class="type">UTF</span>æ—¶é—´æˆ³</span><br><span class="line"></span><br><span class="line">hour(e: <span class="type">Column</span>)</span><br><span class="line">æå–å°æ—¶å€¼</span><br><span class="line"></span><br><span class="line">minute(e: <span class="type">Column</span>)</span><br><span class="line">æå–åˆ†é’Ÿå€¼</span><br><span class="line"></span><br><span class="line">month(e: <span class="type">Column</span>)</span><br><span class="line">æå–æœˆä»½å€¼</span><br><span class="line"></span><br><span class="line">quarter(e: <span class="type">Column</span>)</span><br><span class="line">æå–å­£åº¦</span><br><span class="line"></span><br><span class="line">second(e: <span class="type">Column</span>)</span><br><span class="line">æå–ç§’</span><br><span class="line"></span><br><span class="line">year(e: <span class="type">Column</span>):æå–å¹´</span><br><span class="line"></span><br><span class="line">last_day(e: <span class="type">Column</span>)</span><br><span class="line">æŒ‡å®šæ—¥æœŸçš„æœˆæœ«æ—¥æœŸ</span><br><span class="line"></span><br><span class="line">months_between(date1: <span class="type">Column</span>, date2: <span class="type">Column</span>)</span><br><span class="line">è®¡ç®—ä¸¤æ—¥æœŸå·®å‡ ä¸ªæœˆ</span><br><span class="line"></span><br><span class="line">next_day(date: <span class="type">Column</span>, dayOfWeek: <span class="type">String</span>)</span><br><span class="line">è®¡ç®—æŒ‡å®šæ—¥æœŸä¹‹åçš„ä¸‹ä¸€ä¸ªå‘¨ä¸€ã€äºŒ...ï¼ŒdayOfWeekåŒºåˆ†å¤§å°å†™ï¼Œåªæ¥å— <span class="string">&quot;Mon&quot;</span>, <span class="string">&quot;Tue&quot;</span>, <span class="string">&quot;Wed&quot;</span>, <span class="string">&quot;Thu&quot;</span>, <span class="string">&quot;Fri&quot;</span>, <span class="string">&quot;Sat&quot;</span>, <span class="string">&quot;Sun&quot;</span>ã€‚</span><br><span class="line"></span><br><span class="line">to_date(e: <span class="type">Column</span>)</span><br><span class="line">å­—æ®µç±»å‹è½¬ä¸º<span class="type">DateType</span></span><br><span class="line"></span><br><span class="line">trunc(date: <span class="type">Column</span>, format: <span class="type">String</span>)</span><br><span class="line">æ—¥æœŸæˆªæ–­</span><br><span class="line"></span><br><span class="line">unix_timestamp(s: <span class="type">Column</span>, p: <span class="type">String</span>)</span><br><span class="line">æŒ‡å®šæ ¼å¼çš„æ—¶é—´å­—ç¬¦ä¸²è½¬æ—¶é—´æˆ³</span><br><span class="line"></span><br><span class="line">unix_timestamp(s: <span class="type">Column</span>)</span><br><span class="line">åŒä¸Šï¼Œé»˜è®¤æ ¼å¼ä¸º yyyy-<span class="type">MM</span>-dd <span class="type">HH</span>:mm:ss</span><br><span class="line"></span><br><span class="line">unix_timestamp():å½“å‰æ—¶é—´æˆ³(ç§’),åº•å±‚å®ç°ä¸ºunix_timestamp(current_timestamp(), yyyy-<span class="type">MM</span>-dd <span class="type">HH</span>:mm:ss)</span><br><span class="line"></span><br><span class="line">window(timeColumn: <span class="type">Column</span>, windowDuration: <span class="type">String</span>, slideDuration: <span class="type">String</span>, startTime: <span class="type">String</span>)</span><br><span class="line">æ—¶é—´çª—å£å‡½æ•°ï¼Œå°†æŒ‡å®šæ—¶é—´(<span class="type">TimestampType</span>)åˆ’åˆ†åˆ°çª—å£</span><br></pre></td></tr></table></figure>

<h1 id="æ•°å­¦å‡½æ•°"><a href="#æ•°å­¦å‡½æ•°" class="headerlink" title="æ•°å­¦å‡½æ•°"></a>æ•°å­¦å‡½æ•°</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">cos,sin,tan</span><br><span class="line">è®¡ç®—è§’åº¦çš„ä½™å¼¦ï¼Œæ­£å¼¦ã€‚ã€‚ã€‚</span><br><span class="line"></span><br><span class="line">sinh,tanh,cosh</span><br><span class="line">è®¡ç®—åŒæ›²æ­£å¼¦ï¼Œæ­£åˆ‡ï¼Œã€‚ã€‚</span><br><span class="line"></span><br><span class="line">acos,asin,atan,atan2</span><br><span class="line">è®¡ç®—ä½™å¼¦/æ­£å¼¦å€¼å¯¹åº”çš„è§’åº¦</span><br><span class="line"></span><br><span class="line">bin</span><br><span class="line">å°†longç±»å‹è½¬ä¸ºå¯¹åº”äºŒè¿›åˆ¶æ•°å€¼çš„å­—ç¬¦ä¸²<span class="type">For</span> example, bin(<span class="string">&quot;12&quot;</span>) returns <span class="string">&quot;1100&quot;</span>.</span><br><span class="line"></span><br><span class="line">bround</span><br><span class="line">èˆå…¥ï¼Œä½¿ç”¨<span class="type">Decimal</span>çš„<span class="type">HALF_EVEN</span>æ¨¡å¼ï¼Œv&gt;<span class="number">0.5</span>å‘ä¸Šèˆå…¥ï¼Œv&lt; <span class="number">0.5</span>å‘ä¸‹èˆå…¥ï¼Œv0<span class="number">.5</span>å‘æœ€è¿‘çš„å¶æ•°èˆå…¥ã€‚</span><br><span class="line"></span><br><span class="line">round(e: <span class="type">Column</span>, scale: <span class="type">Int</span>)</span><br><span class="line"><span class="type">HALF_UP</span>æ¨¡å¼èˆå…¥åˆ°scaleä¸ºå°æ•°ç‚¹ã€‚v&gt;=<span class="number">0.5</span>å‘ä¸Šèˆå…¥ï¼Œv&lt; <span class="number">0.5</span>å‘ä¸‹èˆå…¥,å³å››èˆäº”å…¥ã€‚</span><br><span class="line"></span><br><span class="line">ceil</span><br><span class="line">å‘ä¸Šèˆå…¥</span><br><span class="line"></span><br><span class="line">floor</span><br><span class="line">å‘ä¸‹èˆå…¥</span><br><span class="line"></span><br><span class="line">cbrt</span><br><span class="line"><span class="type">Computes</span> the cube-root of the <span class="keyword">given</span> value.</span><br><span class="line"></span><br><span class="line">conv(num:<span class="type">Column</span>, fromBase: <span class="type">Int</span>, toBase: <span class="type">Int</span>)</span><br><span class="line"> è½¬æ¢æ•°å€¼ï¼ˆå­—ç¬¦ä¸²ï¼‰çš„è¿›åˆ¶</span><br><span class="line"></span><br><span class="line">log(base: <span class="type">Double</span>, a: <span class="type">Column</span>):$log_&#123;base&#125;(a)$</span><br><span class="line"></span><br><span class="line">log(a: <span class="type">Column</span>):$log_e(a)$</span><br><span class="line"></span><br><span class="line">log10(a: <span class="type">Column</span>):$log_&#123;<span class="number">10</span>&#125;(a)$</span><br><span class="line"></span><br><span class="line">log2(a: <span class="type">Column</span>):$log_&#123;<span class="number">2</span>&#125;(a)$</span><br><span class="line"></span><br><span class="line">log1p(a: <span class="type">Column</span>):$log_&#123;e&#125;(a+<span class="number">1</span>)$</span><br><span class="line"></span><br><span class="line">pmod(dividend: <span class="type">Column</span>, divisor: <span class="type">Column</span>):<span class="type">Returns</span> the positive value of dividend mod divisor.</span><br><span class="line"></span><br><span class="line">pow(l: <span class="type">Double</span>, r: <span class="type">Column</span>):$r^l$ æ³¨æ„ræ˜¯åˆ—</span><br><span class="line"></span><br><span class="line">pow(l: <span class="type">Column</span>, r: <span class="type">Double</span>):$r^l$ æ³¨æ„læ˜¯åˆ—</span><br><span class="line"></span><br><span class="line">pow(l: <span class="type">Column</span>, r: <span class="type">Column</span>):$r^l$ æ³¨æ„r,léƒ½æ˜¯åˆ—</span><br><span class="line"></span><br><span class="line">radians(e: <span class="type">Column</span>):è§’åº¦è½¬å¼§åº¦</span><br><span class="line"></span><br><span class="line">rint(e: <span class="type">Column</span>):<span class="type">Returns</span> the double value that is closest in value to the argument and is equal to a mathematical integer.</span><br><span class="line"></span><br><span class="line">shiftLeft(e: <span class="type">Column</span>, numBits: <span class="type">Int</span>):å‘å·¦ä½ç§»</span><br><span class="line"></span><br><span class="line">shiftRight(e: <span class="type">Column</span>, numBits: <span class="type">Int</span>):å‘å³ä½ç§»</span><br><span class="line"></span><br><span class="line">shiftRightUnsigned(e: <span class="type">Column</span>, numBits: <span class="type">Int</span>):å‘å³ä½ç§»ï¼ˆæ— ç¬¦å·ä½ï¼‰</span><br><span class="line"></span><br><span class="line">signum(e: <span class="type">Column</span>):è¿”å›æ•°å€¼æ­£è´Ÿç¬¦å·</span><br><span class="line"></span><br><span class="line">sqrt(e: <span class="type">Column</span>):å¹³æ–¹æ ¹</span><br><span class="line"></span><br><span class="line">hex(column: <span class="type">Column</span>):è½¬åå…­è¿›åˆ¶</span><br><span class="line"></span><br><span class="line">unhex(column: <span class="type">Column</span>):é€†è½¬åå…­è¿›åˆ¶</span><br></pre></td></tr></table></figure>

<h1 id="æ··æ‚-misc-å‡½æ•°"><a href="#æ··æ‚-misc-å‡½æ•°" class="headerlink" title="æ··æ‚(misc)å‡½æ•°"></a>æ··æ‚(misc)å‡½æ•°</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">crc32(e: <span class="type">Column</span>):è®¡ç®—<span class="type">CRC32</span>,è¿”å›bigint</span><br><span class="line"></span><br><span class="line">hash(cols: <span class="type">Column</span>*):è®¡ç®— hash codeï¼Œè¿”å›int</span><br><span class="line"></span><br><span class="line">md5(e: <span class="type">Column</span>):è®¡ç®—<span class="type">MD5</span>æ‘˜è¦ï¼Œè¿”å›<span class="number">32</span>ä½ï¼Œ<span class="number">16</span>è¿›åˆ¶å­—ç¬¦ä¸²</span><br><span class="line"></span><br><span class="line">sha1(e: <span class="type">Column</span>):è®¡ç®—<span class="type">SHA</span><span class="number">-1</span>æ‘˜è¦ï¼Œè¿”å›<span class="number">40</span>ä½ï¼Œ<span class="number">16</span>è¿›åˆ¶å­—ç¬¦ä¸²</span><br><span class="line"></span><br><span class="line">sha2(e: <span class="type">Column</span>, numBits: <span class="type">Int</span>):è®¡ç®—<span class="type">SHA</span><span class="number">-1</span>æ‘˜è¦ï¼Œè¿”å›numBitsä½ï¼Œ<span class="number">16</span>è¿›åˆ¶å­—ç¬¦ä¸²ã€‚numBitsæ”¯æŒ<span class="number">224</span>, <span class="number">256</span>, <span class="number">384</span>, or <span class="number">512.</span></span><br></pre></td></tr></table></figure>

<h1 id="å…¶ä»–éèšåˆå‡½æ•°"><a href="#å…¶ä»–éèšåˆå‡½æ•°" class="headerlink" title="å…¶ä»–éèšåˆå‡½æ•°"></a>å…¶ä»–éèšåˆå‡½æ•°</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">abs(e: <span class="type">Column</span>)</span><br><span class="line">ç»å¯¹å€¼</span><br><span class="line"></span><br><span class="line">array(cols: <span class="type">Column</span>*)</span><br><span class="line">å¤šåˆ—åˆå¹¶ä¸ºarrayï¼Œcolså¿…é¡»ä¸ºåŒç±»å‹</span><br><span class="line"></span><br><span class="line">map(cols: <span class="type">Column</span>*):</span><br><span class="line">å°†å¤šåˆ—ç»„ç»‡ä¸ºmapï¼Œè¾“å…¥åˆ—å¿…é¡»ä¸ºï¼ˆkey,value)å½¢å¼ï¼Œå„åˆ—çš„key/valueåˆ†åˆ«ä¸ºåŒä¸€ç±»å‹ã€‚</span><br><span class="line"></span><br><span class="line">bitwiseNOT(e: <span class="type">Column</span>):</span><br><span class="line"><span class="type">Computes</span> bitwise <span class="type">NOT</span>.</span><br><span class="line"></span><br><span class="line">broadcast[<span class="type">T</span>](df: <span class="type">Dataset</span>[<span class="type">T</span>]): <span class="type">Dataset</span>[<span class="type">T</span>]:</span><br><span class="line">å°†dfå˜é‡å¹¿æ’­ï¼Œç”¨äºå®ç°broadcast joinã€‚å¦‚left.join(broadcast(right), <span class="string">&quot;joinKey&quot;</span>)</span><br><span class="line"></span><br><span class="line">coalesce(e: <span class="type">Column</span>*):</span><br><span class="line">è¿”å›ç¬¬ä¸€ä¸ªéç©ºå€¼</span><br><span class="line"></span><br><span class="line">col(colName: <span class="type">String</span>):</span><br><span class="line">è¿”å›colNameå¯¹åº”çš„<span class="type">Column</span></span><br><span class="line"></span><br><span class="line">column(colName: <span class="type">String</span>):</span><br><span class="line">colå‡½æ•°çš„åˆ«å</span><br><span class="line"></span><br><span class="line">expr(expr: <span class="type">String</span>):</span><br><span class="line">è§£æexprè¡¨è¾¾å¼ï¼Œå°†è¿”å›å€¼å­˜äº<span class="type">Column</span>ï¼Œå¹¶è¿”å›è¿™ä¸ª<span class="type">Column</span>ã€‚</span><br><span class="line"></span><br><span class="line">greatest(exprs: <span class="type">Column</span>*):</span><br><span class="line">è¿”å›å¤šåˆ—ä¸­çš„æœ€å¤§å€¼ï¼Œè·³è¿‡<span class="type">Null</span></span><br><span class="line"></span><br><span class="line">least(exprs: <span class="type">Column</span>*):</span><br><span class="line">è¿”å›å¤šåˆ—ä¸­çš„æœ€å°å€¼ï¼Œè·³è¿‡<span class="type">Null</span></span><br><span class="line"></span><br><span class="line">input_file_name():è¿”</span><br><span class="line">å›å½“å‰ä»»åŠ¡çš„æ–‡ä»¶å ï¼Ÿï¼Ÿ</span><br><span class="line"></span><br><span class="line">isnan(e: <span class="type">Column</span>):</span><br><span class="line">æ£€æŸ¥æ˜¯å¦<span class="type">NaN</span>ï¼ˆéæ•°å€¼ï¼‰</span><br><span class="line"></span><br><span class="line">isnull(e: <span class="type">Column</span>):</span><br><span class="line">æ£€æŸ¥æ˜¯å¦ä¸º<span class="type">Null</span></span><br><span class="line"></span><br><span class="line">lit(literal: <span class="type">Any</span>):</span><br><span class="line">å°†å­—é¢é‡(literal)åˆ›å»ºä¸€ä¸ª<span class="type">Column</span></span><br><span class="line"></span><br><span class="line">typedLit[<span class="type">T</span>](literal: <span class="type">T</span>)(<span class="keyword">implicit</span> arg0: scala.reflect.api.<span class="type">JavaUniverse</span>.<span class="type">TypeTag</span>[<span class="type">T</span>]):</span><br><span class="line">å°†å­—é¢é‡(literal)åˆ›å»ºä¸€ä¸ª<span class="type">Column</span>ï¼Œliteralæ”¯æŒ scala types e.g.: <span class="type">List</span>, <span class="type">Seq</span> and <span class="type">Map</span>.</span><br><span class="line"></span><br><span class="line">monotonically_increasing_id():</span><br><span class="line">è¿”å›å•è°ƒé€’å¢å”¯ä¸€<span class="type">ID</span>ï¼Œä½†ä¸åŒåˆ†åŒºçš„<span class="type">ID</span>ä¸è¿ç»­ã€‚<span class="type">ID</span>ä¸º<span class="number">64</span>ä½æ•´å‹ã€‚</span><br><span class="line"></span><br><span class="line">nanvl(col1: <span class="type">Column</span>, col2: <span class="type">Column</span>):</span><br><span class="line">col1ä¸º<span class="type">NaN</span>åˆ™è¿”å›col2</span><br><span class="line"></span><br><span class="line">negate(e: <span class="type">Column</span>):</span><br><span class="line">è´Ÿæ•°ï¼ŒåŒdf.select( -df(<span class="string">&quot;amount&quot;</span>) )</span><br><span class="line"></span><br><span class="line">not(e: <span class="type">Column</span>):</span><br><span class="line">å–åï¼ŒåŒdf.filter( !df(<span class="string">&quot;isActive&quot;</span>) )</span><br><span class="line"></span><br><span class="line">rand():</span><br><span class="line">éšæœºæ•°[<span class="number">0.0</span>, <span class="number">1.0</span>]</span><br><span class="line"></span><br><span class="line">rand(seed: <span class="type">Long</span>):</span><br><span class="line">éšæœºæ•°[<span class="number">0.0</span>, <span class="number">1.0</span>]ï¼Œä½¿ç”¨seedç§å­</span><br><span class="line"></span><br><span class="line">randn():</span><br><span class="line">éšæœºæ•°ï¼Œä»æ­£æ€åˆ†å¸ƒå–</span><br><span class="line"></span><br><span class="line">randn(seed: <span class="type">Long</span>):</span><br><span class="line">åŒä¸Š</span><br><span class="line"></span><br><span class="line">spark_partition_id():</span><br><span class="line">è¿”å›partition <span class="type">ID</span></span><br><span class="line"></span><br><span class="line">struct(cols: <span class="type">Column</span>*):</span><br><span class="line">å¤šåˆ—ç»„åˆæˆæ–°çš„struct column ï¼Ÿï¼Ÿ</span><br><span class="line"></span><br><span class="line">when(condition: <span class="type">Column</span>, value: <span class="type">Any</span>):</span><br><span class="line">å½“conditionä¸º<span class="literal">true</span>è¿”å›valueï¼Œå¦‚</span><br><span class="line">people.select(when(people(<span class="string">&quot;gender&quot;</span>) === <span class="string">&quot;male&quot;</span>, <span class="number">0</span>)</span><br><span class="line">  .when(people(<span class="string">&quot;gender&quot;</span>) === <span class="string">&quot;female&quot;</span>, <span class="number">1</span>)</span><br><span class="line">  .otherwise(<span class="number">2</span>))</span><br><span class="line">å¦‚æœæ²¡æœ‰otherwiseä¸”conditionå…¨éƒ¨æ²¡å‘½ä¸­ï¼Œåˆ™è¿”å›<span class="literal">null</span>.</span><br></pre></td></tr></table></figure>
<h1 id="æ’åºå‡½æ•°"><a href="#æ’åºå‡½æ•°" class="headerlink" title="æ’åºå‡½æ•°"></a>æ’åºå‡½æ•°</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">asc(columnName: <span class="type">String</span>):æ­£åº</span><br><span class="line"></span><br><span class="line">asc_nulls_first(columnName: <span class="type">String</span>):æ­£åºï¼Œ<span class="literal">null</span>æ’æœ€å‰</span><br><span class="line"></span><br><span class="line">asc_nulls_last(columnName: <span class="type">String</span>):æ­£åºï¼Œ<span class="literal">null</span>æ’æœ€å</span><br><span class="line"></span><br><span class="line">e.g.</span><br><span class="line">df.sort(asc(<span class="string">&quot;dept&quot;</span>), desc(<span class="string">&quot;age&quot;</span>))</span><br><span class="line"></span><br><span class="line">å¯¹åº”æœ‰descå‡½æ•°</span><br><span class="line"> desc,desc_nulls_first,desc_nulls_last</span><br></pre></td></tr></table></figure>
<h1 id="å­—ç¬¦ä¸²å‡½æ•°"><a href="#å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="å­—ç¬¦ä¸²å‡½æ•°"></a>å­—ç¬¦ä¸²å‡½æ•°</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">ascii(e: <span class="type">Column</span>): è®¡ç®—ç¬¬ä¸€ä¸ªå­—ç¬¦çš„asciiç </span><br><span class="line"></span><br><span class="line">base64(e: <span class="type">Column</span>): base64è½¬ç </span><br><span class="line"></span><br><span class="line">unbase64(e: <span class="type">Column</span>): base64è§£ç </span><br><span class="line"></span><br><span class="line">concat(exprs: <span class="type">Column</span>*):è¿æ¥å¤šåˆ—å­—ç¬¦ä¸²</span><br><span class="line"></span><br><span class="line">concat_ws(sep: <span class="type">String</span>, exprs: <span class="type">Column</span>*):ä½¿ç”¨sepä½œä¸ºåˆ†éš”ç¬¦è¿æ¥å¤šåˆ—å­—ç¬¦ä¸²</span><br><span class="line"></span><br><span class="line">decode(value: <span class="type">Column</span>, charset: <span class="type">String</span>): è§£ç </span><br><span class="line"></span><br><span class="line">encode(value: <span class="type">Column</span>, charset: <span class="type">String</span>): è½¬ç ï¼Œcharsetæ”¯æŒ &#x27;<span class="type">US</span>-<span class="type">ASCII</span>&#x27;, &#x27;<span class="type">ISO</span><span class="number">-8859</span><span class="number">-1</span>&#x27;, &#x27;<span class="type">UTF</span><span class="number">-8</span>&#x27;, &#x27;<span class="type">UTF</span><span class="number">-16</span>BE&#x27;, &#x27;<span class="type">UTF</span><span class="number">-16</span>LE&#x27;, &#x27;<span class="type">UTF</span><span class="number">-16</span>&#x27;ã€‚</span><br><span class="line"></span><br><span class="line">format_number(x: <span class="type">Column</span>, d: <span class="type">Int</span>):æ ¼å¼åŒ–&#x27;#,###,###.##&#x27;å½¢å¼çš„å­—ç¬¦ä¸²</span><br><span class="line"></span><br><span class="line">format_string(format: <span class="type">String</span>, arguments: <span class="type">Column</span>*): å°†argumentsæŒ‰formatæ ¼å¼åŒ–ï¼Œæ ¼å¼ä¸ºprintf-styleã€‚</span><br><span class="line"></span><br><span class="line">initcap(e: <span class="type">Column</span>): å•è¯é¦–å­—æ¯å¤§å†™</span><br><span class="line"></span><br><span class="line">lower(e: <span class="type">Column</span>): è½¬å°å†™</span><br><span class="line"></span><br><span class="line">upper(e: <span class="type">Column</span>): è½¬å¤§å†™</span><br><span class="line"></span><br><span class="line">instr(str: <span class="type">Column</span>, substring: <span class="type">String</span>): substringåœ¨strä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®</span><br><span class="line"></span><br><span class="line">length(e: <span class="type">Column</span>): å­—ç¬¦ä¸²é•¿åº¦</span><br><span class="line"></span><br><span class="line">levenshtein(l: <span class="type">Column</span>, r: <span class="type">Column</span>): è®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²ä¹‹é—´çš„ç¼–è¾‘è·ç¦»ï¼ˆ<span class="type">Levenshtein</span> distanceï¼‰</span><br><span class="line"></span><br><span class="line">locate(substr: <span class="type">String</span>, str: <span class="type">Column</span>): substringåœ¨strä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼Œä½ç½®ç¼–å·ä»<span class="number">1</span>å¼€å§‹ï¼Œ<span class="number">0</span>è¡¨ç¤ºæœªæ‰¾åˆ°ã€‚</span><br><span class="line"></span><br><span class="line">locate(substr: <span class="type">String</span>, str: <span class="type">Column</span>, pos: <span class="type">Int</span>): åŒä¸Šï¼Œä½†ä»posä½ç½®åæŸ¥æ‰¾ã€‚</span><br><span class="line"></span><br><span class="line">lpad(str: <span class="type">Column</span>, len: <span class="type">Int</span>, pad: <span class="type">String</span>):å­—ç¬¦ä¸²å·¦å¡«å……ã€‚ç”¨padå­—ç¬¦å¡«å……strçš„å­—ç¬¦ä¸²è‡³lené•¿åº¦ã€‚æœ‰å¯¹åº”çš„rpadï¼Œå³å¡«å……ã€‚</span><br><span class="line"></span><br><span class="line">ltrim(e: <span class="type">Column</span>):å‰ªæ‰å·¦è¾¹çš„ç©ºæ ¼ã€ç©ºç™½å­—ç¬¦ï¼Œå¯¹åº”æœ‰rtrim.</span><br><span class="line"></span><br><span class="line">ltrim(e: <span class="type">Column</span>, trimString: <span class="type">String</span>):å‰ªæ‰å·¦è¾¹çš„æŒ‡å®šå­—ç¬¦,å¯¹åº”æœ‰rtrim.</span><br><span class="line"></span><br><span class="line">trim(e: <span class="type">Column</span>, trimString: <span class="type">String</span>):å‰ªæ‰å·¦å³ä¸¤è¾¹çš„æŒ‡å®šå­—ç¬¦</span><br><span class="line"></span><br><span class="line">trim(e: <span class="type">Column</span>):å‰ªæ‰å·¦å³ä¸¤è¾¹çš„ç©ºæ ¼ã€ç©ºç™½å­—ç¬¦</span><br><span class="line"></span><br><span class="line">regexp_extract(e: <span class="type">Column</span>, exp: <span class="type">String</span>, groupIdx: <span class="type">Int</span>): æ­£åˆ™æå–åŒ¹é…çš„ç»„</span><br><span class="line"></span><br><span class="line">regexp_replace(e: <span class="type">Column</span>, pattern: <span class="type">Column</span>, replacement: <span class="type">Column</span>): æ­£åˆ™æ›¿æ¢åŒ¹é…çš„éƒ¨åˆ†ï¼Œè¿™é‡Œå‚æ•°ä¸ºåˆ—ã€‚</span><br><span class="line"></span><br><span class="line">regexp_replace(e: <span class="type">Column</span>, pattern: <span class="type">String</span>, replacement: <span class="type">String</span>): æ­£åˆ™æ›¿æ¢åŒ¹é…çš„éƒ¨åˆ†</span><br><span class="line"></span><br><span class="line">repeat(str: <span class="type">Column</span>, n: <span class="type">Int</span>):å°†stré‡å¤næ¬¡è¿”å›</span><br><span class="line"></span><br><span class="line">reverse(str: <span class="type">Column</span>): å°†stråè½¬</span><br><span class="line"></span><br><span class="line">soundex(e: <span class="type">Column</span>): è®¡ç®—æ¡‘è¿ªå…‹æ–¯ä»£ç ï¼ˆsoundex codeï¼‰<span class="type">PS</span>:ç”¨äºæŒ‰è‹±è¯­å‘éŸ³æ¥ç´¢å¼•å§“å,å‘éŸ³ç›¸åŒä½†æ‹¼å†™ä¸åŒçš„å•è¯ï¼Œä¼šæ˜ å°„æˆåŒä¸€ä¸ªç ã€‚</span><br><span class="line"></span><br><span class="line">split(str: <span class="type">Column</span>, pattern: <span class="type">String</span>): ç”¨patternåˆ†å‰²str</span><br><span class="line"></span><br><span class="line">substring(str: <span class="type">Column</span>, pos: <span class="type">Int</span>, len: <span class="type">Int</span>): åœ¨strä¸Šæˆªå–ä»posä½ç½®å¼€å§‹é•¿åº¦ä¸ºlençš„å­å­—ç¬¦ä¸²ã€‚</span><br><span class="line"></span><br><span class="line">substring_index(str: <span class="type">Column</span>, delim: <span class="type">String</span>, count: <span class="type">Int</span>):<span class="type">Returns</span> the substring from string str before count occurrences of the delimiter delim. <span class="type">If</span> count is positive, everything the left of the <span class="keyword">final</span> delimiter (counting from left) is returned. <span class="type">If</span> count is negative, every to the right of the <span class="keyword">final</span> delimiter (counting from the right) is returned. substring_index performs a <span class="keyword">case</span>-sensitive <span class="keyword">match</span> when searching <span class="keyword">for</span> delim.</span><br><span class="line"></span><br><span class="line">translate(src: <span class="type">Column</span>, matchingString: <span class="type">String</span>, replaceString: <span class="type">String</span>):æŠŠsrcä¸­çš„matchingStringå…¨æ¢æˆreplaceStringã€‚</span><br></pre></td></tr></table></figure>

<h1 id="UDFå‡½æ•°"><a href="#UDFå‡½æ•°" class="headerlink" title="UDFå‡½æ•°"></a>UDFå‡½æ•°</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">user-defined function.</span><br><span class="line"></span><br><span class="line">callUDF(udfName: <span class="type">String</span>, cols: <span class="type">Column</span>*): è°ƒç”¨<span class="type">UDF</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql._</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> df = <span class="type">Seq</span>((<span class="string">&quot;id1&quot;</span>, <span class="number">1</span>), (<span class="string">&quot;id2&quot;</span>, <span class="number">4</span>), (<span class="string">&quot;id3&quot;</span>, <span class="number">5</span>)).toDF(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;value&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> spark = df.sparkSession</span><br><span class="line">spark.udf.register(<span class="string">&quot;simpleUDF&quot;</span>, (v: <span class="type">Int</span>) =&gt; v * v)</span><br><span class="line">df.select($<span class="string">&quot;id&quot;</span>, callUDF(<span class="string">&quot;simpleUDF&quot;</span>, $<span class="string">&quot;value&quot;</span>))</span><br><span class="line"></span><br><span class="line">udf: å®šä¹‰<span class="type">UDF</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="çª—å£å‡½æ•°"><a href="#çª—å£å‡½æ•°" class="headerlink" title="çª—å£å‡½æ•°"></a>çª—å£å‡½æ•°</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">cume_dist(): cumulative distribution of values within a window partition</span><br><span class="line"></span><br><span class="line">currentRow(): returns the special frame boundary that represents the current row in the window partition.</span><br><span class="line"></span><br><span class="line">rank():æ’åï¼Œè¿”å›æ•°æ®é¡¹åœ¨åˆ†ç»„ä¸­çš„æ’åï¼Œæ’åç›¸ç­‰ä¼šåœ¨åæ¬¡ä¸­ç•™ä¸‹ç©ºä½ <span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">4</span>ã€‚</span><br><span class="line"></span><br><span class="line">dense_rank(): æ’åï¼Œè¿”å›æ•°æ®é¡¹åœ¨åˆ†ç»„ä¸­çš„æ’åï¼Œæ’åç›¸ç­‰ä¼šåœ¨åæ¬¡ä¸­ä¸ä¼šç•™ä¸‹ç©ºä½ <span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>ã€‚</span><br><span class="line"></span><br><span class="line">row_number():è¡Œå·ï¼Œä¸ºæ¯æ¡è®°å½•è¿”å›ä¸€ä¸ªæ•°å­— <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span></span><br><span class="line"></span><br><span class="line">percent_rank():returns the relative rank (i.e. percentile) of rows within a window partition.</span><br><span class="line"></span><br><span class="line">lag(e: <span class="type">Column</span>, offset: <span class="type">Int</span>, defaultValue: <span class="type">Any</span>): offset rows before the current row</span><br><span class="line"></span><br><span class="line">lead(e: <span class="type">Column</span>, offset: <span class="type">Int</span>, defaultValue: <span class="type">Any</span>): returns the value that is offset rows after the current row</span><br><span class="line"></span><br><span class="line">ntile(n: <span class="type">Int</span>): returns the ntile group id (from <span class="number">1</span> to n inclusive) in an ordered window partition.</span><br><span class="line"></span><br><span class="line">unboundedFollowing():returns the special frame boundary that represents the last row in the window partition.</span><br></pre></td></tr></table></figure>

<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="http://spark.apache.org/docs/latest/api/scala/index.html#org.apache.spark.sql.functions$">Spark API</a></li>
</ul>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>API</tag>
      </tags>
  </entry>
  <entry>
    <title>[è¯»ä¹¦ç¬”è®°] ESæƒå¨æŒ‡å—</title>
    <url>/2018/03/26/es-guide-note/</url>
    <content><![CDATA[<h1 id="åŸºç¡€å…¥é—¨"><a href="#åŸºç¡€å…¥é—¨" class="headerlink" title="åŸºç¡€å…¥é—¨"></a>åŸºç¡€å…¥é—¨</h1><span id="more"></span>

<h3 id="è½»é‡æœç´¢"><a href="#è½»é‡æœç´¢" class="headerlink" title="è½»é‡æœç´¢"></a>è½»é‡æœç´¢</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /megacorp/employee/_search?q=last_name<span class="punctuation">:</span>Smith</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨æŸ¥è¯¢è¡¨è¾¾å¼æœç´¢"><a href="#ä½¿ç”¨æŸ¥è¯¢è¡¨è¾¾å¼æœç´¢" class="headerlink" title="ä½¿ç”¨æŸ¥è¯¢è¡¨è¾¾å¼æœç´¢"></a>ä½¿ç”¨æŸ¥è¯¢è¡¨è¾¾å¼æœç´¢</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /megacorp/employee/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;last_name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;smith&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;range&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;gt&quot;</span> <span class="punctuation">:</span> <span class="number">30</span> <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="å…¨æ–‡æœç´¢"><a href="#å…¨æ–‡æœç´¢" class="headerlink" title="å…¨æ–‡æœç´¢"></a>å…¨æ–‡æœç´¢</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /megacorp/employee/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;about&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;rock climbing&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="çŸ­è¯­æœç´¢"><a href="#çŸ­è¯­æœç´¢" class="headerlink" title="çŸ­è¯­æœç´¢"></a>çŸ­è¯­æœç´¢</h3><p>ç²¾ç¡®åŒ¹é…ä¸€ç³»åˆ—å•è¯æˆ–è€…çŸ­è¯­</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /megacorp/employee/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match_phrase&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;about&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;rock climbing&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="é«˜äº®æœç´¢"><a href="#é«˜äº®æœç´¢" class="headerlink" title="é«˜äº®æœç´¢"></a>é«˜äº®æœç´¢</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /megacorp/employee/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match_phrase&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;about&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;rock climbing&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;about&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="èšåˆ"><a href="#èšåˆ" class="headerlink" title="èšåˆ"></a>èšåˆ</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /megacorp/employee/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;all_interests&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;interests&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;avg_age&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;avg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;age&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="åˆ†å¸ƒå¼ç‰¹æ€§"><a href="#åˆ†å¸ƒå¼ç‰¹æ€§" class="headerlink" title="åˆ†å¸ƒå¼ç‰¹æ€§"></a>åˆ†å¸ƒå¼ç‰¹æ€§</h3><p>Elasticsearch å°½å¯èƒ½åœ°å±è”½äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚è¿™é‡Œåˆ—ä¸¾äº†ä¸€äº›åœ¨åå°è‡ªåŠ¨æ‰§è¡Œçš„æ“ä½œï¼š</p>
<p>åˆ†é…æ–‡æ¡£åˆ°ä¸åŒçš„å®¹å™¨ æˆ– åˆ†ç‰‡ ä¸­ï¼Œæ–‡æ¡£å¯ä»¥å‚¨å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ä¸­<br>æŒ‰é›†ç¾¤èŠ‚ç‚¹æ¥å‡è¡¡åˆ†é…è¿™äº›åˆ†ç‰‡ï¼Œä»è€Œå¯¹ç´¢å¼•å’Œæœç´¢è¿‡ç¨‹è¿›è¡Œè´Ÿè½½å‡è¡¡<br>å¤åˆ¶æ¯ä¸ªåˆ†ç‰‡ä»¥æ”¯æŒæ•°æ®å†—ä½™ï¼Œä»è€Œé˜²æ­¢ç¡¬ä»¶æ•…éšœå¯¼è‡´çš„æ•°æ®ä¸¢å¤±<br>å°†é›†ç¾¤ä¸­ä»»ä¸€èŠ‚ç‚¹çš„è¯·æ±‚è·¯ç”±åˆ°å­˜æœ‰ç›¸å…³æ•°æ®çš„èŠ‚ç‚¹<br>é›†ç¾¤æ‰©å®¹æ—¶æ— ç¼æ•´åˆæ–°èŠ‚ç‚¹ï¼Œé‡æ–°åˆ†é…åˆ†ç‰‡ä»¥ä¾¿ä»ç¦»ç¾¤èŠ‚ç‚¹æ¢å¤</p>
<h2 id="é›†ç¾¤å†…çš„åŸç†"><a href="#é›†ç¾¤å†…çš„åŸç†" class="headerlink" title="é›†ç¾¤å†…çš„åŸç†"></a>é›†ç¾¤å†…çš„åŸç†</h2><p>ä¸»åˆ†ç‰‡çš„æ•°ç›®åœ¨ç´¢å¼•åˆ›å»ºæ—¶ å°±å·²ç»ç¡®å®šäº†ä¸‹æ¥ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªæ•°ç›®å®šä¹‰äº†è¿™ä¸ªç´¢å¼•èƒ½å¤Ÿ å­˜å‚¨ çš„æœ€å¤§æ•°æ®é‡ã€‚ï¼ˆå®é™…å¤§å°å–å†³äºä½ çš„æ•°æ®ã€ç¡¬ä»¶å’Œä½¿ç”¨åœºæ™¯ã€‚ï¼‰ ä½†æ˜¯ï¼Œè¯»æ“ä½œâ€”â€”æœç´¢å’Œè¿”å›æ•°æ®â€”â€”å¯ä»¥åŒæ—¶è¢«ä¸»åˆ†ç‰‡ æˆ– å‰¯æœ¬åˆ†ç‰‡æ‰€å¤„ç†ï¼Œæ‰€ä»¥å½“ä½ æ‹¥æœ‰è¶Šå¤šçš„å‰¯æœ¬åˆ†ç‰‡æ—¶ï¼Œä¹Ÿå°†æ‹¥æœ‰è¶Šé«˜çš„ååé‡ã€‚</p>
<p>åœ¨è¿è¡Œä¸­çš„é›†ç¾¤ä¸Šæ˜¯å¯ä»¥åŠ¨æ€è°ƒæ•´å‰¯æœ¬åˆ†ç‰‡æ•°ç›®çš„ ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰éœ€ä¼¸ç¼©é›†ç¾¤ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœåªæ˜¯åœ¨ç›¸åŒèŠ‚ç‚¹æ•°ç›®çš„é›†ç¾¤ä¸Šå¢åŠ æ›´å¤šçš„å‰¯æœ¬åˆ†ç‰‡å¹¶ä¸èƒ½æé«˜æ€§èƒ½ï¼Œå› ä¸ºæ¯ä¸ªåˆ†ç‰‡ä»èŠ‚ç‚¹ä¸Šè·å¾—çš„èµ„æºä¼šå˜å°‘ã€‚ ä½ éœ€è¦å¢åŠ æ›´å¤šçš„ç¡¬ä»¶èµ„æºæ¥æå‡ååé‡ã€‚</p>
<p>ä½†æ˜¯æ›´å¤šçš„å‰¯æœ¬åˆ†ç‰‡æ•°æé«˜äº†æ•°æ®å†—ä½™é‡ï¼šæŒ‰ç…§ä¸Šé¢çš„èŠ‚ç‚¹é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤±å»2ä¸ªèŠ‚ç‚¹çš„æƒ…å†µä¸‹ä¸ä¸¢å¤±ä»»ä½•æ•°æ®ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬é‡æ–°å¯åŠ¨ Node 1 ï¼Œé›†ç¾¤å¯ä»¥å°†ç¼ºå¤±çš„å‰¯æœ¬åˆ†ç‰‡å†æ¬¡è¿›è¡Œåˆ†é…ï¼Œé‚£ä¹ˆé›†ç¾¤çš„çŠ¶æ€ä¹Ÿå°†å¦‚å›¾ 5 â€œå°†å‚æ•° number_of_replicas è°ƒå¤§åˆ° 2â€æ‰€ç¤ºã€‚ å¦‚æœ Node 1 ä¾ç„¶æ‹¥æœ‰ç€ä¹‹å‰çš„åˆ†ç‰‡ï¼Œå®ƒå°†å°è¯•å»é‡ç”¨å®ƒä»¬ï¼ŒåŒæ—¶ä»…ä»ä¸»åˆ†ç‰‡å¤åˆ¶å‘ç”Ÿäº†ä¿®æ”¹çš„æ•°æ®æ–‡ä»¶ã€‚</p>
<h2 id="æ•°æ®è¾“å…¥å’Œè¾“å‡º"><a href="#æ•°æ®è¾“å…¥å’Œè¾“å‡º" class="headerlink" title="æ•°æ®è¾“å…¥å’Œè¾“å‡º"></a>æ•°æ®è¾“å…¥å’Œè¾“å‡º</h2><p> ä¸€ä¸ª é”® å¯ä»¥æ˜¯ä¸€ä¸ªå­—æ®µæˆ–å­—æ®µçš„åç§°ï¼Œä¸€ä¸ª å€¼ å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸€ä¸ªæ•°å­—ï¼Œä¸€ä¸ªå¸ƒå°”å€¼ï¼Œ å¦ä¸€ä¸ªå¯¹è±¡ï¼Œä¸€äº›æ•°ç»„å€¼ï¼Œæˆ–ä¸€äº›å…¶å®ƒç‰¹æ®Šç±»å‹è¯¸å¦‚è¡¨ç¤ºæ—¥æœŸçš„å­—ç¬¦ä¸²ï¼Œæˆ–ä»£è¡¨ä¸€ä¸ªåœ°ç†ä½ç½®çš„å¯¹è±¡ï¼š</p>
<h3 id="æ–‡æ¡£å…ƒæ•°æ®"><a href="#æ–‡æ¡£å…ƒæ•°æ®" class="headerlink" title="æ–‡æ¡£å…ƒæ•°æ®"></a>æ–‡æ¡£å…ƒæ•°æ®</h3><p>ä¸€ä¸ªæ–‡æ¡£ä¸ä»…ä»…åŒ…å«å®ƒçš„æ•°æ® ï¼Œä¹ŸåŒ…å« å…ƒæ•°æ® â€”â€” æœ‰å…³ æ–‡æ¡£çš„ä¿¡æ¯ã€‚ ä¸‰ä¸ªå¿…é¡»çš„å…ƒæ•°æ®å…ƒç´ å¦‚ä¸‹ï¼š</p>
<p>_index<br>æ–‡æ¡£åœ¨å“ªå­˜æ”¾<br>_type<br>æ–‡æ¡£è¡¨ç¤ºçš„å¯¹è±¡ç±»åˆ«<br>_id<br>æ–‡æ¡£å”¯ä¸€æ ‡è¯†</p>
<p>_index<br>ä¸€ä¸ª ç´¢å¼• åº”è¯¥æ˜¯å› å…±åŒçš„ç‰¹æ€§è¢«åˆ†ç»„åˆ°ä¸€èµ·çš„æ–‡æ¡£é›†åˆã€‚ ä¾‹å¦‚ï¼Œä½ å¯èƒ½å­˜å‚¨æ‰€æœ‰çš„äº§å“åœ¨ç´¢å¼• products ä¸­ï¼Œè€Œå­˜å‚¨æ‰€æœ‰é”€å”®çš„äº¤æ˜“åˆ°ç´¢å¼• sales ä¸­ã€‚ è™½ç„¶ä¹Ÿå…è®¸å­˜å‚¨ä¸ç›¸å…³çš„æ•°æ®åˆ°ä¸€ä¸ªç´¢å¼•ä¸­ï¼Œä½†è¿™é€šå¸¸çœ‹ä½œæ˜¯ä¸€ä¸ªåæ¨¡å¼çš„åšæ³•ã€‚</p>
<p>æç¤º<br>å®é™…ä¸Šï¼Œåœ¨ Elasticsearch ä¸­ï¼Œæˆ‘ä»¬çš„æ•°æ®æ˜¯è¢«å­˜å‚¨å’Œç´¢å¼•åœ¨ åˆ†ç‰‡ ä¸­ï¼Œè€Œä¸€ä¸ªç´¢å¼•ä»…ä»…æ˜¯é€»è¾‘ä¸Šçš„å‘½åç©ºé—´ï¼Œ è¿™ä¸ªå‘½åç©ºé—´ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªåˆ†ç‰‡ç»„åˆåœ¨ä¸€èµ·ã€‚ ç„¶è€Œï¼Œè¿™æ˜¯ä¸€ä¸ªå†…éƒ¨ç»†èŠ‚ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ ¹æœ¬ä¸åº”è¯¥å…³å¿ƒåˆ†ç‰‡ï¼Œå¯¹äºåº”ç”¨ç¨‹åºè€Œè¨€ï¼Œåªéœ€çŸ¥é“æ–‡æ¡£ä½äºä¸€ä¸ª ç´¢å¼• å†…ã€‚ Elasticsearch ä¼šå¤„ç†æ‰€æœ‰çš„ç»†èŠ‚ã€‚</p>
<p>æˆ‘ä»¬å°†åœ¨ ç´¢å¼•ç®¡ç† ä»‹ç»å¦‚ä½•è‡ªè¡Œåˆ›å»ºå’Œç®¡ç†ç´¢å¼•ï¼Œä½†ç°åœ¨æˆ‘ä»¬å°†è®© Elasticsearch å¸®æˆ‘ä»¬åˆ›å»ºç´¢å¼•ã€‚ æ‰€æœ‰éœ€è¦æˆ‘ä»¬åšçš„å°±æ˜¯é€‰æ‹©ä¸€ä¸ªç´¢å¼•åï¼Œè¿™ä¸ªåå­—å¿…é¡»å°å†™ï¼Œä¸èƒ½ä»¥ä¸‹åˆ’çº¿å¼€å¤´ï¼Œä¸èƒ½åŒ…å«é€—å·ã€‚æˆ‘ä»¬ç”¨ website ä½œä¸ºç´¢å¼•åä¸¾ä¾‹ã€‚</p>
<p>_typeç¼–è¾‘<br>æ•°æ®å¯èƒ½åœ¨ç´¢å¼•ä¸­åªæ˜¯æ¾æ•£çš„ç»„åˆåœ¨ä¸€èµ·ï¼Œä½†æ˜¯é€šå¸¸æ˜ç¡®å®šä¹‰ä¸€äº›æ•°æ®ä¸­çš„å­åˆ†åŒºæ˜¯å¾ˆæœ‰ç”¨çš„ã€‚ ä¾‹å¦‚ï¼Œæ‰€æœ‰çš„äº§å“éƒ½æ”¾åœ¨ä¸€ä¸ªç´¢å¼•ä¸­ï¼Œä½†æ˜¯ä½ æœ‰è®¸å¤šä¸åŒçš„äº§å“ç±»åˆ«ï¼Œæ¯”å¦‚ â€œelectronicsâ€ ã€ â€œkitchenâ€ å’Œ â€œlawn-careâ€ã€‚</p>
<p>è¿™äº›æ–‡æ¡£å…±äº«ä¸€ç§ç›¸åŒçš„ï¼ˆæˆ–éå¸¸ç›¸ä¼¼ï¼‰çš„æ¨¡å¼ï¼šä»–ä»¬æœ‰ä¸€ä¸ªæ ‡é¢˜ã€æè¿°ã€äº§å“ä»£ç å’Œä»·æ ¼ã€‚ä»–ä»¬åªæ˜¯æ­£å¥½å±äºâ€œäº§å“â€ä¸‹çš„ä¸€äº›å­ç±»ã€‚</p>
<p>Elasticsearch å…¬å¼€äº†ä¸€ä¸ªç§°ä¸º types ï¼ˆç±»å‹ï¼‰çš„ç‰¹æ€§ï¼Œå®ƒå…è®¸æ‚¨åœ¨ç´¢å¼•ä¸­å¯¹æ•°æ®è¿›è¡Œé€»è¾‘åˆ†åŒºã€‚ä¸åŒ types çš„æ–‡æ¡£å¯èƒ½æœ‰ä¸åŒçš„å­—æ®µï¼Œä½†æœ€å¥½èƒ½å¤Ÿéå¸¸ç›¸ä¼¼ã€‚ æˆ‘ä»¬å°†åœ¨ ç±»å‹å’Œæ˜ å°„ ä¸­æ›´å¤šçš„è®¨è®ºå…³äº types çš„ä¸€äº›åº”ç”¨å’Œé™åˆ¶ã€‚</p>
<p>ä¸€ä¸ª _type å‘½åå¯ä»¥æ˜¯å¤§å†™æˆ–è€…å°å†™ï¼Œä½†æ˜¯ä¸èƒ½ä»¥ä¸‹åˆ’çº¿æˆ–è€…å¥å·å¼€å¤´ï¼Œä¸åº”è¯¥åŒ…å«é€—å·ï¼Œ å¹¶ä¸”é•¿åº¦é™åˆ¶ä¸º256ä¸ªå­—ç¬¦. æˆ‘ä»¬ä½¿ç”¨ blog ä½œä¸ºç±»å‹åä¸¾ä¾‹ã€‚</p>
<p>_idç¼–è¾‘<br>ID æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œ å½“å®ƒå’Œ _index ä»¥åŠ _type ç»„åˆå°±å¯ä»¥å”¯ä¸€ç¡®å®š Elasticsearch ä¸­çš„ä¸€ä¸ªæ–‡æ¡£ã€‚ å½“ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡æ¡£ï¼Œè¦ä¹ˆæä¾›è‡ªå·±çš„ _id ï¼Œè¦ä¹ˆè®© Elasticsearch å¸®ä½ ç”Ÿæˆã€‚</p>
<p>å…¶ä»–å…ƒæ•°æ®ç¼–è¾‘<br>è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å…ƒæ•°æ®å…ƒç´ ï¼Œä»–ä»¬åœ¨ ç±»å‹å’Œæ˜ å°„ è¿›è¡Œäº†ä»‹ç»ã€‚é€šè¿‡å‰é¢å·²ç»åˆ—å‡ºçš„å…ƒæ•°æ®å…ƒç´ ï¼Œ æˆ‘ä»¬å·²ç»èƒ½å­˜å‚¨æ–‡æ¡£åˆ° Elasticsearch ä¸­å¹¶é€šè¿‡ ID æ£€ç´¢å®ƒâ€“æ¢å¥è¯è¯´ï¼Œä½¿ç”¨ Elasticsearch ä½œä¸ºæ–‡æ¡£çš„å­˜å‚¨ä»‹è´¨ã€‚</p>
<h3 id="å–å›ä¸€ä¸ªæ–‡æ¡£"><a href="#å–å›ä¸€ä¸ªæ–‡æ¡£" class="headerlink" title="å–å›ä¸€ä¸ªæ–‡æ¡£"></a>å–å›ä¸€ä¸ªæ–‡æ¡£</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /website/blog/<span class="number">123</span>?pretty #è°ƒç”¨ Elasticsearch çš„ pretty-print åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½ ä½¿å¾— JSON å“åº”ä½“æ›´åŠ å¯è¯»</span><br><span class="line">GET /website/blog/<span class="number">123</span>?_source=title<span class="punctuation">,</span>text #è¯¥ _source å­—æ®µç°åœ¨åŒ…å«çš„åªæ˜¯æˆ‘ä»¬è¯·æ±‚çš„é‚£äº›å­—æ®µ</span><br><span class="line">GET /website/blog/<span class="number">123</span>/_source #åªæƒ³å¾—åˆ° _source å­—æ®µï¼Œä¸éœ€è¦ä»»ä½•å…ƒæ•°æ®</span><br></pre></td></tr></table></figure>
<h3 id="æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜åœ¨"><a href="#æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜åœ¨" class="headerlink" title="æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜åœ¨"></a>æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜åœ¨</h3><p>curl -i -XHEAD <a href="http://localhost:9200/website/blog/123">http://localhost:9200/website/blog/123</a></p>
<h3 id="æ›´æ–°æ•´ä¸ªæ–‡æ¡£"><a href="#æ›´æ–°æ•´ä¸ªæ–‡æ¡£" class="headerlink" title="æ›´æ–°æ•´ä¸ªæ–‡æ¡£"></a>æ›´æ–°æ•´ä¸ªæ–‡æ¡£</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /website/blog/<span class="number">123</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;My first blog entry&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;I am starting to get the hang of this...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;2014/01/02&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ps:ä¸å­˜åœ¨æ—¶ï¼Œå°±æ˜¯åˆ›å»º</p>
<h3 id="ä»…åˆ›å»ºæ–‡æ¡£"><a href="#ä»…åˆ›å»ºæ–‡æ¡£" class="headerlink" title="ä»…åˆ›å»ºæ–‡æ¡£"></a>ä»…åˆ›å»ºæ–‡æ¡£</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /website/blog/<span class="number">123</span>/_create</span><br><span class="line"><span class="punctuation">&#123;</span> ... <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="åˆ é™¤æ–‡æ¡£"><a href="#åˆ é™¤æ–‡æ¡£" class="headerlink" title="åˆ é™¤æ–‡æ¡£"></a>åˆ é™¤æ–‡æ¡£</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">DELETE /website/blog/<span class="number">123</span></span><br></pre></td></tr></table></figure>
<h3 id="å†²çªå¤„ç†"><a href="#å†²çªå¤„ç†" class="headerlink" title="å†²çªå¤„ç†"></a>å†²çªå¤„ç†</h3><p>æ‚²è§‚å¹¶å‘æ§åˆ¶<br>è¿™ç§æ–¹æ³•è¢«å…³ç³»å‹æ•°æ®åº“å¹¿æ³›ä½¿ç”¨ï¼Œå®ƒå‡å®šæœ‰å˜æ›´å†²çªå¯èƒ½å‘ç”Ÿï¼Œå› æ­¤é˜»å¡è®¿é—®èµ„æºä»¥é˜²æ­¢å†²çªã€‚ ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯è¯»å–ä¸€è¡Œæ•°æ®ä¹‹å‰å…ˆå°†å…¶é”ä½ï¼Œç¡®ä¿åªæœ‰æ”¾ç½®é”çš„çº¿ç¨‹èƒ½å¤Ÿå¯¹è¿™è¡Œæ•°æ®è¿›è¡Œä¿®æ”¹ã€‚<br>ä¹è§‚å¹¶å‘æ§åˆ¶<br>Elasticsearch ä¸­ä½¿ç”¨çš„è¿™ç§æ–¹æ³•å‡å®šå†²çªæ˜¯ä¸å¯èƒ½å‘ç”Ÿçš„ï¼Œå¹¶ä¸”ä¸ä¼šé˜»å¡æ­£åœ¨å°è¯•çš„æ“ä½œã€‚ ç„¶è€Œï¼Œå¦‚æœæºæ•°æ®åœ¨è¯»å†™å½“ä¸­è¢«ä¿®æ”¹ï¼Œæ›´æ–°å°†ä¼šå¤±è´¥ã€‚åº”ç”¨ç¨‹åºæ¥ä¸‹æ¥å°†å†³å®šè¯¥å¦‚ä½•è§£å†³å†²çªã€‚ ä¾‹å¦‚ï¼Œå¯ä»¥é‡è¯•æ›´æ–°ã€ä½¿ç”¨æ–°çš„æ•°æ®ã€æˆ–è€…å°†ç›¸å…³æƒ…å†µæŠ¥å‘Šç»™ç”¨æˆ·ã€‚</p>
<h3 id="ä¹è§‚å¹¶å‘æ§åˆ¶"><a href="#ä¹è§‚å¹¶å‘æ§åˆ¶" class="headerlink" title="ä¹è§‚å¹¶å‘æ§åˆ¶"></a>ä¹è§‚å¹¶å‘æ§åˆ¶</h3><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ _version å·æ¥ç¡®ä¿ åº”ç”¨ä¸­ç›¸äº’å†²çªçš„å˜æ›´ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚æˆ‘ä»¬é€šè¿‡æŒ‡å®šæƒ³è¦ä¿®æ”¹æ–‡æ¡£çš„ version å·æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚ å¦‚æœè¯¥ç‰ˆæœ¬ä¸æ˜¯å½“å‰ç‰ˆæœ¬å·ï¼Œæˆ‘ä»¬çš„è¯·æ±‚å°†ä¼šå¤±è´¥ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /website/blog/<span class="number">1</span>?version=<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;My first blog entry&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;Starting to get the hang of this...&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æƒ³è¿™ä¸ªåœ¨æˆ‘ä»¬ç´¢å¼•ä¸­çš„æ–‡æ¡£åªæœ‰ç°åœ¨çš„ _version ä¸º 1 æ—¶ï¼Œæœ¬æ¬¡æ›´æ–°æ‰èƒ½æˆåŠŸã€‚</p>
<p>é€šè¿‡å¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶</p>
<p>å¦‚æœä½ çš„ä¸»æ•°æ®åº“å·²ç»æœ‰äº†ç‰ˆæœ¬å·â€‰â€”â€‰æˆ–ä¸€ä¸ªèƒ½ä½œä¸ºç‰ˆæœ¬å·çš„å­—æ®µå€¼æ¯”å¦‚ timestampâ€‰â€”â€‰é‚£ä¹ˆä½ å°±å¯ä»¥åœ¨ Elasticsearch ä¸­é€šè¿‡å¢åŠ  version_type&#x3D;external åˆ°æŸ¥è¯¢å­—ç¬¦ä¸²çš„æ–¹å¼é‡ç”¨è¿™äº›ç›¸åŒçš„ç‰ˆæœ¬å·ï¼Œ ç‰ˆæœ¬å·å¿…é¡»æ˜¯å¤§äºé›¶çš„æ•´æ•°ï¼Œ ä¸”å°äº 9.2E+18â€‰â€”â€‰ä¸€ä¸ª Java ä¸­ long ç±»å‹çš„æ­£å€¼ã€‚</p>
<p>å¤–éƒ¨ç‰ˆæœ¬å·çš„å¤„ç†æ–¹å¼å’Œæˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„å†…éƒ¨ç‰ˆæœ¬å·çš„å¤„ç†æ–¹å¼æœ‰äº›ä¸åŒï¼Œ Elasticsearch ä¸æ˜¯æ£€æŸ¥å½“å‰ _version å’Œè¯·æ±‚ä¸­æŒ‡å®šçš„ç‰ˆæœ¬å·æ˜¯å¦ç›¸åŒï¼Œ è€Œæ˜¯æ£€æŸ¥å½“å‰ _version æ˜¯å¦ å°äº æŒ‡å®šçš„ç‰ˆæœ¬å·ã€‚ å¦‚æœè¯·æ±‚æˆåŠŸï¼Œå¤–éƒ¨çš„ç‰ˆæœ¬å·ä½œä¸ºæ–‡æ¡£çš„æ–° _version è¿›è¡Œå­˜å‚¨ã€‚</p>
<p>æ–‡æ¡£æ˜¯ä¸å¯å˜çš„ï¼šä»–ä»¬ä¸èƒ½è¢«ä¿®æ”¹ï¼Œåªèƒ½è¢«æ›¿æ¢ã€‚</p>
<h3 id="éƒ¨åˆ†æ›´æ–°"><a href="#éƒ¨åˆ†æ›´æ–°" class="headerlink" title="éƒ¨åˆ†æ›´æ–°"></a>éƒ¨åˆ†æ›´æ–°</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /website/blog/<span class="number">1</span>/_update</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;doc&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;testing&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;views&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å¯¹è±¡è¢«åˆå¹¶åˆ°ä¸€èµ·ï¼Œè¦†ç›–ç°æœ‰çš„å­—æ®µï¼Œå¢åŠ æ–°çš„å­—æ®µã€‚</p>
<h3 id="å–å›å¤šä¸ªæ–‡æ¡£"><a href="#å–å›å¤šä¸ªæ–‡æ¡£" class="headerlink" title="å–å›å¤šä¸ªæ–‡æ¡£"></a>å–å›å¤šä¸ªæ–‡æ¡£</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;docs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span>  <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span>    <span class="number">2</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span>  <span class="string">&quot;pageviews&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span>    <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;views&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">GET /website/blog/_mget</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;ids&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;1&quot;</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="ä»£ä»·è¾ƒå°çš„æ‰¹é‡æ“ä½œ"><a href="#ä»£ä»·è¾ƒå°çš„æ‰¹é‡æ“ä½œ" class="headerlink" title="ä»£ä»·è¾ƒå°çš„æ‰¹é‡æ“ä½œ"></a>ä»£ä»·è¾ƒå°çš„æ‰¹é‡æ“ä½œ</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;create&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;My first blog post&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span>  <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;My second blog post&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;update&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_retry_on_conflict&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;doc&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;My updated blog post&quot;</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨"><a href="#åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨" class="headerlink" title="åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨"></a>åˆ†å¸ƒå¼æ–‡æ¡£å­˜å‚¨</h2><p>åˆ†ç‰‡é€‰æ‹©å…¬å¼</p>
<p>shard &#x3D; hash(routing) % number_of_primary_shards<br>routing æ˜¯ä¸€ä¸ªå¯å˜å€¼ï¼Œé»˜è®¤æ˜¯æ–‡æ¡£çš„ _id ï¼Œä¹Ÿå¯ä»¥è®¾ç½®æˆä¸€ä¸ªè‡ªå®šä¹‰çš„å€¼ã€‚</p>
<p>ç›¸åŒåˆ†ç‰‡çš„å‰¯æœ¬ä¸ä¼šæ”¾åœ¨åŒä¸€èŠ‚ç‚¹</p>
<p>æˆ‘ä»¬å¯ä»¥å‘é€è¯·æ±‚åˆ°é›†ç¾¤ä¸­çš„ä»»ä¸€èŠ‚ç‚¹ã€‚ æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰èƒ½åŠ›å¤„ç†ä»»æ„è¯·æ±‚ã€‚ æ¯ä¸ªèŠ‚ç‚¹éƒ½çŸ¥é“é›†ç¾¤ä¸­ä»»ä¸€æ–‡æ¡£ä½ç½®ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°†è¯·æ±‚è½¬å‘åˆ°éœ€è¦çš„èŠ‚ç‚¹ä¸Šã€‚</p>
<p>æ–°å»ºã€ç´¢å¼•å’Œåˆ é™¤ è¯·æ±‚éƒ½æ˜¯ å†™ æ“ä½œï¼Œ å¿…é¡»åœ¨ä¸»åˆ†ç‰‡ä¸Šé¢å®Œæˆä¹‹åæ‰èƒ½è¢«å¤åˆ¶åˆ°ç›¸å…³çš„å‰¯æœ¬åˆ†ç‰‡<br>åœ¨å®¢æˆ·ç«¯æ”¶åˆ°æˆåŠŸå“åº”æ—¶ï¼Œæ–‡æ¡£å˜æ›´å·²ç»åœ¨ä¸»åˆ†ç‰‡å’Œæ‰€æœ‰å‰¯æœ¬åˆ†ç‰‡æ‰§è¡Œå®Œæˆï¼Œå˜æ›´æ˜¯å®‰å…¨çš„ã€‚</p>
<p>æœ‰ä¸€äº›å¯é€‰çš„è¯·æ±‚å‚æ•°å…è®¸æ‚¨å½±å“è¿™ä¸ªè¿‡ç¨‹ï¼Œå¯èƒ½ä»¥æ•°æ®å®‰å…¨ä¸ºä»£ä»·æå‡æ€§èƒ½ã€‚è¿™äº›é€‰é¡¹å¾ˆå°‘ä½¿ç”¨ï¼Œå› ä¸ºElasticsearchå·²ç»å¾ˆå¿«ï¼Œä½†æ˜¯ä¸ºäº†å®Œæ•´èµ·è§ï¼Œåœ¨è¿™é‡Œé˜è¿°å¦‚ä¸‹ï¼š<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/distrib-write.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/distrib-write.html</a></p>
<p>åœ¨å¤„ç†è¯»å–è¯·æ±‚æ—¶ï¼Œåè°ƒç»“ç‚¹åœ¨æ¯æ¬¡è¯·æ±‚çš„æ—¶å€™éƒ½ä¼šé€šè¿‡è½®è¯¢æ‰€æœ‰çš„å‰¯æœ¬åˆ†ç‰‡æ¥è¾¾åˆ°è´Ÿè½½å‡è¡¡ã€‚</p>
<h2 id="æœç´¢â€”â€”æœ€åŸºæœ¬çš„å·¥å…·"><a href="#æœç´¢â€”â€”æœ€åŸºæœ¬çš„å·¥å…·" class="headerlink" title="æœç´¢â€”â€”æœ€åŸºæœ¬çš„å·¥å…·"></a>æœç´¢â€”â€”æœ€åŸºæœ¬çš„å·¥å…·</h2><p>æ˜ å°„ï¼ˆMappingï¼‰<br>æè¿°æ•°æ®åœ¨æ¯ä¸ªå­—æ®µå†…å¦‚ä½•å­˜å‚¨<br>åˆ†æï¼ˆAnalysisï¼‰<br>å…¨æ–‡æ˜¯å¦‚ä½•å¤„ç†ä½¿ä¹‹å¯ä»¥è¢«æœç´¢çš„<br>é¢†åŸŸç‰¹å®šæŸ¥è¯¢è¯­è¨€ï¼ˆQuery DSLï¼‰<br>Elasticsearch ä¸­å¼ºå¤§çµæ´»çš„æŸ¥è¯¢è¯­è¨€</p>
<h3 id="å¤šç´¢å¼•ï¼Œå¤šç±»å‹"><a href="#å¤šç´¢å¼•ï¼Œå¤šç±»å‹" class="headerlink" title="å¤šç´¢å¼•ï¼Œå¤šç±»å‹"></a>å¤šç´¢å¼•ï¼Œå¤šç±»å‹</h3><p>ç„¶è€Œï¼Œç»å¸¸çš„æƒ…å†µä¸‹ï¼Œä½  æƒ³åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªç‰¹æ®Šçš„ç´¢å¼•å¹¶ä¸”åœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªç‰¹æ®Šçš„ç±»å‹ä¸­è¿›è¡Œæœç´¢ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨URLä¸­æŒ‡å®šç‰¹æ®Šçš„ç´¢å¼•å’Œç±»å‹è¾¾åˆ°è¿™ç§æ•ˆæœï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p>&#x2F;_search<br>åœ¨æ‰€æœ‰çš„ç´¢å¼•ä¸­æœç´¢æ‰€æœ‰çš„ç±»å‹<br>&#x2F;gb&#x2F;_search<br>åœ¨ gb ç´¢å¼•ä¸­æœç´¢æ‰€æœ‰çš„ç±»å‹<br>&#x2F;gb,us&#x2F;_search<br>åœ¨ gb å’Œ us ç´¢å¼•ä¸­æœç´¢æ‰€æœ‰çš„æ–‡æ¡£<br>&#x2F;g*,u*&#x2F;_search<br>åœ¨ä»»ä½•ä»¥ g æˆ–è€… u å¼€å¤´çš„ç´¢å¼•ä¸­æœç´¢æ‰€æœ‰çš„ç±»å‹<br>&#x2F;gb&#x2F;user&#x2F;_search<br>åœ¨ gb ç´¢å¼•ä¸­æœç´¢ user ç±»å‹<br>&#x2F;gb,us&#x2F;user,tweet&#x2F;_search<br>åœ¨ gb å’Œ us ç´¢å¼•ä¸­æœç´¢ user å’Œ tweet ç±»å‹<br>&#x2F;_all&#x2F;user,tweet&#x2F;_search<br>åœ¨æ‰€æœ‰çš„ç´¢å¼•ä¸­æœç´¢ user å’Œ tweet ç±»å‹</p>
<h3 id="åˆ†é¡µ"><a href="#åˆ†é¡µ" class="headerlink" title="åˆ†é¡µ"></a>åˆ†é¡µ</h3><p>å’Œ SQL ä½¿ç”¨ LIMIT å…³é”®å­—è¿”å›å•ä¸ª page ç»“æœçš„æ–¹æ³•ç›¸åŒï¼ŒElasticsearch æ¥å— from å’Œ size å‚æ•°ï¼š</p>
<p>size<br>æ˜¾ç¤ºåº”è¯¥è¿”å›çš„ç»“æœæ•°é‡ï¼Œé»˜è®¤æ˜¯ 10<br>from<br>æ˜¾ç¤ºåº”è¯¥è·³è¿‡çš„åˆå§‹ç»“æœæ•°é‡ï¼Œé»˜è®¤æ˜¯ 0<br>å¦‚æœæ¯é¡µå±•ç¤º 5 æ¡ç»“æœï¼Œå¯ä»¥ç”¨ä¸‹é¢æ–¹å¼è¯·æ±‚å¾—åˆ° 1 åˆ° 3 é¡µçš„ç»“æœï¼š</p>
<p>GET &#x2F;_search?size&#x3D;5<br>GET &#x2F;_search?size&#x3D;5&amp;from&#x3D;5<br>GET &#x2F;_search?size&#x3D;5&amp;from&#x3D;10</p>
<p><strong>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ·±åº¦åˆ†é¡µ</strong><br>ç†è§£ä¸ºä»€ä¹ˆæ·±åº¦åˆ†é¡µæ˜¯æœ‰é—®é¢˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾åœ¨ä¸€ä¸ªæœ‰ 5 ä¸ªä¸»åˆ†ç‰‡çš„ç´¢å¼•ä¸­æœç´¢ã€‚ å½“æˆ‘ä»¬è¯·æ±‚ç»“æœçš„ç¬¬ä¸€é¡µï¼ˆç»“æœä» 1 åˆ° 10 ï¼‰ï¼Œæ¯ä¸€ä¸ªåˆ†ç‰‡äº§ç”Ÿå‰ 10 çš„ç»“æœï¼Œå¹¶ä¸”è¿”å›ç»™ åè°ƒèŠ‚ç‚¹ ï¼Œåè°ƒèŠ‚ç‚¹å¯¹ 50 ä¸ªç»“æœæ’åºå¾—åˆ°å…¨éƒ¨ç»“æœçš„å‰ 10 ä¸ªã€‚</p>
<p>ç°åœ¨å‡è®¾æˆ‘ä»¬è¯·æ±‚ç¬¬ 1000 é¡µâ€“ç»“æœä» 10001 åˆ° 10010 ã€‚æ‰€æœ‰éƒ½ä»¥ç›¸åŒçš„æ–¹å¼å·¥ä½œé™¤äº†æ¯ä¸ªåˆ†ç‰‡ä¸å¾—ä¸äº§ç”Ÿå‰10010ä¸ªç»“æœä»¥å¤–ã€‚ ç„¶ååè°ƒèŠ‚ç‚¹å¯¹å…¨éƒ¨ 50050 ä¸ªç»“æœæ’åºæœ€åä¸¢å¼ƒæ‰è¿™äº›ç»“æœä¸­çš„ 50040 ä¸ªç»“æœã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¯¹ç»“æœæ’åºçš„æˆæœ¬éšåˆ†é¡µçš„æ·±åº¦æˆæŒ‡æ•°ä¸Šå‡ã€‚è¿™å°±æ˜¯ web æœç´¢å¼•æ“å¯¹ä»»ä½•æŸ¥è¯¢éƒ½ä¸è¦è¿”å›è¶…è¿‡ 1000 ä¸ªç»“æœçš„åŸå› ã€‚</p>
<p>å½“ç´¢å¼•ä¸€ä¸ªæ–‡æ¡£çš„æ—¶å€™ï¼ŒElasticsearch å–å‡ºæ‰€æœ‰å­—æ®µçš„å€¼æ‹¼æ¥æˆä¸€ä¸ªå¤§çš„å­—ç¬¦ä¸²ï¼Œä½œä¸º _all å­—æ®µè¿›è¡Œç´¢å¼•ã€‚<br>é™¤éè®¾ç½®ç‰¹å®šå­—æ®µï¼Œå¦åˆ™æŸ¥è¯¢å­—ç¬¦ä¸²å°±ä½¿ç”¨ _all å­—æ®µè¿›è¡Œæœç´¢ã€‚</p>
<p>åœ¨åˆšå¼€å§‹å¼€å‘ä¸€ä¸ªåº”ç”¨æ—¶ï¼Œ_all å­—æ®µæ˜¯ä¸€ä¸ªå¾ˆå®ç”¨çš„ç‰¹æ€§ã€‚ä¹‹åï¼Œä½ ä¼šå‘ç°å¦‚æœæœç´¢æ—¶ç”¨æŒ‡å®šå­—æ®µæ¥ä»£æ›¿ _all å­—æ®µï¼Œå°†ä¼šæ›´å¥½æ§åˆ¶æœç´¢ç»“æœã€‚å½“ _all å­—æ®µä¸å†æœ‰ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥å°†å®ƒç½®ä¸ºå¤±æ•ˆï¼Œæ­£å¦‚åœ¨ å…ƒæ•°æ®: _all å­—æ®µ ä¸­æ‰€è§£é‡Šçš„ã€‚</p>
<p>ä¸‹é¢çš„æŸ¥è¯¢é’ˆå¯¹tweentsç±»å‹ï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹çš„æ¡ä»¶ï¼š</p>
<p>name å­—æ®µä¸­åŒ…å« mary æˆ–è€… john<br>date å€¼å¤§äº 2014-09-10<br><em>all</em> å­—æ®µåŒ…å« aggregations æˆ–è€… geo<br>+name:(mary john) +date:&gt;2014-09-10 +(aggregations geo)</p>
<p>ä¸æ¨èç›´æ¥å‘ç”¨æˆ·æš´éœ²æŸ¥è¯¢å­—ç¬¦ä¸²æœç´¢åŠŸèƒ½ï¼Œé™¤éå¯¹äºé›†ç¾¤å’Œæ•°æ®æ¥è¯´éå¸¸ä¿¡ä»»ä»–ä»¬ã€‚</p>
<p>ç›¸åï¼Œæˆ‘ä»¬ç»å¸¸åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ›´å¤šåœ°ä½¿ç”¨åŠŸèƒ½å…¨é¢çš„ request body æŸ¥è¯¢APIï¼Œé™¤äº†èƒ½å®Œæˆä»¥ä¸Šæ‰€æœ‰åŠŸèƒ½ï¼Œè¿˜æœ‰ä¸€äº›é™„åŠ åŠŸèƒ½ã€‚</p>
<h2 id="æ˜ å°„å’Œåˆ†æ"><a href="#æ˜ å°„å’Œåˆ†æ" class="headerlink" title="æ˜ å°„å’Œåˆ†æ"></a>æ˜ å°„å’Œåˆ†æ</h2><p>Elasticsearch ä¸­çš„æ•°æ®å¯ä»¥æ¦‚æ‹¬çš„åˆ†ä¸ºä¸¤ç±»ï¼šç²¾ç¡®å€¼å’Œå…¨æ–‡ã€‚</p>
<p>ä½ åªèƒ½æœç´¢åœ¨ç´¢å¼•ä¸­å‡ºç°çš„è¯æ¡ï¼Œæ‰€ä»¥ç´¢å¼•æ–‡æœ¬å’ŒæŸ¥è¯¢å­—ç¬¦ä¸²å¿…é¡»æ ‡å‡†åŒ–ä¸ºç›¸åŒçš„æ ¼å¼ã€‚</p>
<p>åˆ†è¯å’Œæ ‡å‡†åŒ–çš„è¿‡ç¨‹ç§°ä¸º åˆ†æï¼ˆanalyzeï¼‰</p>
<p>åˆ†æå™¨ å®é™…ä¸Šæ˜¯å°†ä¸‰ä¸ªåŠŸèƒ½å°è£…åˆ°äº†ä¸€ä¸ªåŒ…é‡Œï¼š</p>
<p>å­—ç¬¦è¿‡æ»¤å™¨<br>é¦–å…ˆï¼Œå­—ç¬¦ä¸²æŒ‰é¡ºåºé€šè¿‡æ¯ä¸ª å­—ç¬¦è¿‡æ»¤å™¨ ã€‚ä»–ä»¬çš„ä»»åŠ¡æ˜¯åœ¨åˆ†è¯å‰æ•´ç†å­—ç¬¦ä¸²ã€‚ä¸€ä¸ªå­—ç¬¦è¿‡æ»¤å™¨å¯ä»¥ç”¨æ¥å»æ‰HTMLï¼Œæˆ–è€…å°† &amp; è½¬åŒ–æˆ <code>and</code>ã€‚<br>åˆ†è¯å™¨<br>å…¶æ¬¡ï¼Œå­—ç¬¦ä¸²è¢« åˆ†è¯å™¨ åˆ†ä¸ºå•ä¸ªçš„è¯æ¡ã€‚ä¸€ä¸ªç®€å•çš„åˆ†è¯å™¨é‡åˆ°ç©ºæ ¼å’Œæ ‡ç‚¹çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå°†æ–‡æœ¬æ‹†åˆ†æˆè¯æ¡ã€‚<br>Token è¿‡æ»¤å™¨<br>æœ€åï¼Œè¯æ¡æŒ‰é¡ºåºé€šè¿‡æ¯ä¸ª token è¿‡æ»¤å™¨ ã€‚è¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šæ”¹å˜è¯æ¡ï¼ˆä¾‹å¦‚ï¼Œå°å†™åŒ– Quick ï¼‰ï¼Œåˆ é™¤è¯æ¡ï¼ˆä¾‹å¦‚ï¼Œ åƒ a<code>ï¼Œ </code>and<code>ï¼Œ </code>the ç­‰æ— ç”¨è¯ï¼‰ï¼Œæˆ–è€…å¢åŠ è¯æ¡ï¼ˆä¾‹å¦‚ï¼Œåƒ jump å’Œ leap è¿™ç§åŒä¹‰è¯ï¼‰ã€‚</p>
<p>å½“ä½ æŸ¥è¯¢ä¸€ä¸ª å…¨æ–‡ åŸŸæ—¶ï¼Œ ä¼šå¯¹æŸ¥è¯¢å­—ç¬¦ä¸²åº”ç”¨ç›¸åŒçš„åˆ†æå™¨ï¼Œä»¥äº§ç”Ÿæ­£ç¡®çš„æœç´¢è¯æ¡åˆ—è¡¨ã€‚<br>å½“ä½ æŸ¥è¯¢ä¸€ä¸ª ç²¾ç¡®å€¼ åŸŸæ—¶ï¼Œä¸ä¼šåˆ†ææŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œ è€Œæ˜¯æœç´¢ä½ æŒ‡å®šçš„ç²¾ç¡®å€¼ã€‚</p>
<p>æµ‹è¯•åˆ†æå™¨ï¼Œæµ‹è¯•åˆ†è¯ç»“æœ</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Text to analyze&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>å½“Elasticsearchåœ¨ä½ çš„æ–‡æ¡£ä¸­æ£€æµ‹åˆ°ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²åŸŸ ï¼Œå®ƒä¼šè‡ªåŠ¨è®¾ç½®å…¶ä¸ºä¸€ä¸ªå…¨æ–‡ å­—ç¬¦ä¸² åŸŸï¼Œä½¿ç”¨ æ ‡å‡† åˆ†æå™¨å¯¹å®ƒè¿›è¡Œåˆ†æã€‚</p>
<p>Elasticsearch æ”¯æŒ å¦‚ä¸‹ç®€å•åŸŸç±»å‹ï¼š</p>
<p>å­—ç¬¦ä¸²: string<br>æ•´æ•° : byte, short, integer, long<br>æµ®ç‚¹æ•°: float, double<br>å¸ƒå°”å‹: boolean<br>æ—¥æœŸ: date</p>
<p>å½“ä½ ç´¢å¼•ä¸€ä¸ªåŒ…å«æ–°åŸŸçš„æ–‡æ¡£â€“ä¹‹å‰æœªæ›¾å‡ºç°â€“ Elasticsearch ä¼šä½¿ç”¨ åŠ¨æ€æ˜ å°„ ï¼Œé€šè¿‡JSONä¸­åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå°è¯•çŒœæµ‹åŸŸç±»å‹ï¼Œ</p>
<p>æŸ¥çœ‹æ˜ å°„<br>GET &#x2F;gb&#x2F;_mapping&#x2F;tweet</p>
<p>åŸŸæœ€é‡è¦çš„å±æ€§æ˜¯ type ã€‚å¯¹äºä¸æ˜¯ string çš„åŸŸï¼Œä½ ä¸€èˆ¬åªéœ€è¦è®¾ç½® type ï¼š</p>
<p>é»˜è®¤ï¼Œ string ç±»å‹åŸŸä¼šè¢«è®¤ä¸ºåŒ…å«å…¨æ–‡ã€‚å°±æ˜¯è¯´ï¼Œå®ƒä»¬çš„å€¼åœ¨ç´¢å¼•å‰ï¼Œä¼šé€šè¿‡ ä¸€ä¸ªåˆ†æå™¨ï¼Œé’ˆå¯¹äºè¿™ä¸ªåŸŸçš„æŸ¥è¯¢åœ¨æœç´¢å‰ä¹Ÿä¼šç»è¿‡ä¸€ä¸ªåˆ†æå™¨ã€‚</p>
<p>string åŸŸæ˜ å°„çš„ä¸¤ä¸ªæœ€é‡è¦ å±æ€§æ˜¯ index å’Œ analyzer ã€‚</p>
<p>index å±æ€§æ§åˆ¶æ€æ ·ç´¢å¼•å­—ç¬¦ä¸²ã€‚å®ƒå¯ä»¥æ˜¯ä¸‹é¢ä¸‰ä¸ªå€¼ï¼š</p>
<p>analyzed<br>é¦–å…ˆåˆ†æå­—ç¬¦ä¸²ï¼Œç„¶åç´¢å¼•å®ƒã€‚æ¢å¥è¯è¯´ï¼Œä»¥å…¨æ–‡ç´¢å¼•è¿™ä¸ªåŸŸã€‚<br>not_analyzed<br>  ç´¢å¼•è¿™ä¸ªåŸŸï¼Œæ‰€ä»¥å®ƒèƒ½å¤Ÿè¢«æœç´¢ï¼Œä½†ç´¢å¼•çš„æ˜¯ç²¾ç¡®å€¼ã€‚ä¸ä¼šå¯¹å®ƒè¿›è¡Œåˆ†æã€‚<br>no<br>ä¸ç´¢å¼•è¿™ä¸ªåŸŸã€‚è¿™ä¸ªåŸŸä¸ä¼šè¢«æœç´¢åˆ°ã€‚</p>
<p>analyzer<br>å¯¹äº analyzed å­—ç¬¦ä¸²åŸŸï¼Œç”¨ analyzer å±æ€§æŒ‡å®šåœ¨æœç´¢å’Œç´¢å¼•æ—¶ä½¿ç”¨çš„åˆ†æå™¨ã€‚é»˜è®¤ï¼Œ Elasticsearch ä½¿ç”¨ standard åˆ†æå™¨ï¼Œ ä½†ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªå†…ç½®çš„åˆ†æå™¨æ›¿ä»£å®ƒï¼Œä¾‹å¦‚ whitespace ã€ simple å’Œ <code>english</code>ï¼š</p>
<p>å½“ä½ é¦–æ¬¡ åˆ›å»ºä¸€ä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šç±»å‹çš„æ˜ å°„ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ &#x2F;_mapping ä¸ºæ–°ç±»å‹ï¼ˆæˆ–è€…ä¸ºå­˜åœ¨çš„ç±»å‹æ›´æ–°æ˜ å°„ï¼‰å¢åŠ æ˜ å°„ã€‚<br>ä¸èƒ½ _ä¿®æ”¹ å­˜åœ¨çš„åŸŸæ˜ å°„ã€‚</p>
<p>åˆ›å»ºç´¢å¼•çš„æ—¶å€™æŒ‡å®šæ˜ å°„</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /gb</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tweet&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;tweet&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span>    <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;english&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;date&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span>   <span class="string">&quot;date&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span>   <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;user_id&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span>   <span class="string">&quot;long&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•æ˜ å°„ç»“æœ</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /gb/_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tweet&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Black-cats&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ps:ä»…æ”¯æŒfulltextå­—æ®µ</p>
<h3 id="å¤æ‚æ ¸å¿ƒåŸŸç±»å‹"><a href="#å¤æ‚æ ¸å¿ƒåŸŸç±»å‹" class="headerlink" title="å¤æ‚æ ¸å¿ƒåŸŸç±»å‹"></a>å¤æ‚æ ¸å¿ƒåŸŸç±»å‹</h3><p>äº‹å®ä¸Šï¼Œ type æ˜ å°„åªæ˜¯ä¸€ç§ç‰¹æ®Šçš„ å¯¹è±¡ æ˜ å°„ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º æ ¹å¯¹è±¡ ã€‚é™¤äº†å®ƒæœ‰ä¸€äº›æ–‡æ¡£å…ƒæ•°æ®çš„ç‰¹æ®Šé¡¶çº§åŸŸï¼Œä¾‹å¦‚ _source å’Œ _all åŸŸï¼Œå®ƒå’Œå…¶ä»–å¯¹è±¡ä¸€æ ·ã€‚</p>
<p>Lucene ä¸ç†è§£å†…éƒ¨å¯¹è±¡ã€‚ Lucene æ–‡æ¡£æ˜¯ç”±ä¸€ç»„é”®å€¼å¯¹åˆ—è¡¨ç»„æˆçš„ã€‚ä¸ºäº†èƒ½è®© Elasticsearch æœ‰æ•ˆåœ°ç´¢å¼•å†…éƒ¨ç±»ï¼Œå®ƒæŠŠæˆ‘ä»¬çš„æ–‡æ¡£è½¬åŒ–æˆè¿™æ ·ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tweet&quot;</span><span class="punctuation">:</span>            <span class="punctuation">[</span>elasticsearch<span class="punctuation">,</span> flexible<span class="punctuation">,</span> very<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user.id&quot;</span><span class="punctuation">:</span>          <span class="punctuation">[</span>@johnsmith<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user.gender&quot;</span><span class="punctuation">:</span>      <span class="punctuation">[</span>male<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user.age&quot;</span><span class="punctuation">:</span>         <span class="punctuation">[</span><span class="number">26</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user.name.full&quot;</span><span class="punctuation">:</span>   <span class="punctuation">[</span>john<span class="punctuation">,</span> smith<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user.name.first&quot;</span><span class="punctuation">:</span>  <span class="punctuation">[</span>john<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user.name.last&quot;</span><span class="punctuation">:</span>   <span class="punctuation">[</span>smith<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å†…éƒ¨åŸŸ å¯ä»¥é€šè¿‡åç§°å¼•ç”¨ï¼ˆä¾‹å¦‚ï¼Œ first ï¼‰ã€‚ä¸ºäº†åŒºåˆ†åŒåçš„ä¸¤ä¸ªåŸŸï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…¨ è·¯å¾„ ï¼ˆä¾‹å¦‚ï¼Œ user.name.first ï¼‰ æˆ– type ååŠ è·¯å¾„ï¼ˆ tweet.user.name.first ï¼‰ã€‚</p>
<p>å†…éƒ¨å¯¹è±¡æ•°ç»„<br>æœ€åï¼Œè€ƒè™‘åŒ…å« å†…éƒ¨å¯¹è±¡çš„æ•°ç»„æ˜¯å¦‚ä½•è¢«ç´¢å¼•çš„ã€‚ å‡è®¾æˆ‘ä»¬æœ‰ä¸ª followers æ•°ç»„ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;followers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">35</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mary White&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alex Jones&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">19</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lisa Smith&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–‡æ¡£ä¼šåƒæˆ‘ä»¬ä¹‹å‰æè¿°çš„é‚£æ ·è¢«æ‰å¹³åŒ–å¤„ç†ï¼Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;followers.age&quot;</span><span class="punctuation">:</span>    <span class="punctuation">[</span><span class="number">19</span><span class="punctuation">,</span> <span class="number">26</span><span class="punctuation">,</span> <span class="number">35</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;followers.name&quot;</span><span class="punctuation">:</span>   <span class="punctuation">[</span>alex<span class="punctuation">,</span> jones<span class="punctuation">,</span> lisa<span class="punctuation">,</span> smith<span class="punctuation">,</span> mary<span class="punctuation">,</span> white<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>{age: 35} å’Œ {name: Mary White} ä¹‹é—´çš„ç›¸å…³æ€§å·²ç»ä¸¢å¤±äº†ï¼Œå› ä¸ºæ¯ä¸ªå¤šå€¼åŸŸåªæ˜¯ä¸€åŒ…æ— åºçš„å€¼ï¼Œè€Œä¸æ˜¯æœ‰åºæ•°ç»„ã€‚è¿™è¶³ä»¥è®©æˆ‘ä»¬é—®ï¼Œâ€œæœ‰ä¸€ä¸ª26å²çš„è¿½éšè€…ï¼Ÿâ€</p>
<p>ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½å¾—åˆ°ä¸€ä¸ªå‡†ç¡®çš„ç­”æ¡ˆï¼šâ€œæ˜¯å¦æœ‰ä¸€ä¸ª26å² åå­—å« Alex Jones çš„è¿½éšè€…ï¼Ÿâ€</p>
<p>ç›¸å…³å†…éƒ¨å¯¹è±¡è¢«ç§°ä¸º nested å¯¹è±¡ï¼Œå¯ä»¥å›ç­”ä¸Šé¢çš„æŸ¥è¯¢ï¼Œæˆ‘ä»¬ç¨åä¼šåœ¨åµŒå¥—å¯¹è±¡ä¸­ä»‹ç»å®ƒã€‚</p>
<h2 id="è¯·æ±‚ä½“æŸ¥è¯¢"><a href="#è¯·æ±‚ä½“æŸ¥è¯¢" class="headerlink" title="è¯·æ±‚ä½“æŸ¥è¯¢"></a>è¯·æ±‚ä½“æŸ¥è¯¢</h2><p>å¯¹äºä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚ï¼ŒElasticsearch çš„å·¥ç¨‹å¸ˆåå‘äºä½¿ç”¨ GET æ–¹å¼ï¼Œå› ä¸ºä»–ä»¬è§‰å¾—å®ƒæ¯” POST èƒ½æ›´å¥½çš„æè¿°ä¿¡æ¯æ£€ç´¢ï¼ˆretrieving informationï¼‰çš„è¡Œä¸ºã€‚ç„¶è€Œï¼Œå› ä¸ºå¸¦è¯·æ±‚ä½“çš„ GET è¯·æ±‚å¹¶ä¸è¢«å¹¿æ³›æ”¯æŒï¼Œæ‰€ä»¥ search API åŒæ—¶æ”¯æŒ POST è¯·æ±‚ï¼š</p>
<p>è¿‡æ»¤æƒ…å†µï¼ˆfiltering contextï¼‰å’ŒæŸ¥è¯¢æƒ…å†µï¼ˆquery contextï¼‰ã€‚<br>å½“ä½¿ç”¨äº è¿‡æ»¤æƒ…å†µ æ—¶ï¼ŒæŸ¥è¯¢è¢«è®¾ç½®æˆä¸€ä¸ªâ€œä¸è¯„åˆ†â€æˆ–è€…â€œè¿‡æ»¤â€æŸ¥è¯¢ã€‚<br>å½“ä½¿ç”¨äº æŸ¥è¯¢æƒ…å†µ æ—¶ï¼ŒæŸ¥è¯¢å°±å˜æˆäº†ä¸€ä¸ªâ€œè¯„åˆ†â€çš„æŸ¥è¯¢.<br>è¿‡æ»¤æŸ¥è¯¢ï¼ˆFiltering queriesï¼‰åªæ˜¯ç®€å•çš„æ£€æŸ¥åŒ…å«æˆ–è€…æ’é™¤ï¼Œè¿™å°±ä½¿å¾—è®¡ç®—èµ·æ¥éå¸¸å¿«ã€‚<br>é€šå¸¸çš„è§„åˆ™æ˜¯ï¼Œä½¿ç”¨ æŸ¥è¯¢ï¼ˆqueryï¼‰è¯­å¥æ¥è¿›è¡Œ å…¨æ–‡ æœç´¢æˆ–è€…å…¶å®ƒä»»ä½•éœ€è¦å½±å“ ç›¸å…³æ€§å¾—åˆ† çš„æœç´¢ã€‚é™¤æ­¤ä»¥å¤–çš„æƒ…å†µéƒ½ä½¿ç”¨è¿‡æ»¤ï¼ˆfilters)ã€‚</p>
<p>æŸ¥è¯¢è¡¨è¾¾å¼(Query DSL)æ˜¯ä¸€ç§éå¸¸çµæ´»åˆå¯Œæœ‰è¡¨ç°åŠ›çš„ æŸ¥è¯¢è¯­è¨€ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> YOUR_QUERY_HERE</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ çš„å…¸å‹ç»“æ„ï¼š</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    QUERY_NAME<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        ARGUMENT<span class="punctuation">:</span> VALUE<span class="punctuation">,</span></span><br><span class="line">        ARGUMENT<span class="punctuation">:</span> VALUE<span class="punctuation">,</span>...</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">å¦‚æœæ˜¯é’ˆå¯¹æŸä¸ªå­—æ®µï¼Œé‚£ä¹ˆå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    QUERY_NAME<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        FIELD_NAME<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            ARGUMENT<span class="punctuation">:</span> VALUE<span class="punctuation">,</span></span><br><span class="line">            ARGUMENT<span class="punctuation">:</span> VALUE<span class="punctuation">,</span>...</span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>æ— è®ºä½ åœ¨ä»»ä½•å­—æ®µä¸Šè¿›è¡Œçš„æ˜¯å…¨æ–‡æœç´¢è¿˜æ˜¯ç²¾ç¡®æŸ¥è¯¢ï¼Œmatch æŸ¥è¯¢æ˜¯ä½ å¯ç”¨çš„æ ‡å‡†æŸ¥è¯¢ã€‚<br>å¦‚æœä½ åœ¨ä¸€ä¸ªå…¨æ–‡å­—æ®µä¸Šä½¿ç”¨ match æŸ¥è¯¢ï¼Œåœ¨æ‰§è¡ŒæŸ¥è¯¢å‰ï¼Œå®ƒå°†ç”¨æ­£ç¡®çš„åˆ†æå™¨å»åˆ†ææŸ¥è¯¢å­—ç¬¦ä¸²ï¼š<br>{ â€œmatchâ€: { â€œtweetâ€: â€œAbout Searchâ€ }}<br>å¦‚æœåœ¨ä¸€ä¸ªç²¾ç¡®å€¼çš„å­—æ®µä¸Šä½¿ç”¨å®ƒï¼Œ ä¾‹å¦‚æ•°å­—ã€æ—¥æœŸã€å¸ƒå°”æˆ–è€…ä¸€ä¸ª not_analyzed å­—ç¬¦ä¸²å­—æ®µï¼Œé‚£ä¹ˆå®ƒå°†ä¼šç²¾ç¡®åŒ¹é…ç»™å®šçš„å€¼ï¼š<br>{ â€œmatchâ€: { â€œageâ€:    26           }}</p>
<p>multi_match æŸ¥è¯¢å¯ä»¥åœ¨å¤šä¸ªå­—æ®µä¸Šæ‰§è¡Œç›¸åŒçš„ match æŸ¥è¯¢ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;full text search&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span>   <span class="punctuation">[</span> <span class="string">&quot;title&quot;</span><span class="punctuation">,</span> <span class="string">&quot;body&quot;</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>range æŸ¥è¯¢æ‰¾å‡ºé‚£äº›è½åœ¨æŒ‡å®šåŒºé—´å†…çš„æ•°å­—æˆ–è€…æ—¶é—´ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span>  <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lt&quot;</span><span class="punctuation">:</span>   <span class="number">30</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>term æŸ¥è¯¢å¯¹äºè¾“å…¥çš„æ–‡æœ¬ä¸ åˆ†æ ï¼Œæ‰€ä»¥å®ƒå°†ç»™å®šçš„å€¼è¿›è¡Œç²¾ç¡®æŸ¥è¯¢ã€‚</p>
<p>terms æŸ¥è¯¢å’Œ term æŸ¥è¯¢ä¸€æ ·ï¼Œä½†å®ƒå…è®¸ä½ æŒ‡å®šå¤šå€¼è¿›è¡ŒåŒ¹é…ã€‚å¦‚æœè¿™ä¸ªå­—æ®µåŒ…å«äº†æŒ‡å®šå€¼ä¸­çš„ä»»ä½•ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–‡æ¡£æ»¡è¶³æ¡ä»¶ï¼š</p>
<p>{ â€œtermsâ€: { â€œtagâ€: [ â€œsearchâ€, â€œfull_textâ€, â€œnosqlâ€ ] }}</p>
<p>exists æŸ¥è¯¢å’Œ missing æŸ¥è¯¢è¢«ç”¨äºæŸ¥æ‰¾é‚£äº›æŒ‡å®šå­—æ®µä¸­æœ‰å€¼ (exists) æˆ–æ— å€¼ (missing) çš„æ–‡æ¡£ã€‚è¿™ä¸SQLä¸­çš„ IS_NULL (missing) å’Œ NOT IS_NULL (exists) åœ¨æœ¬è´¨ä¸Šå…·æœ‰å…±æ€§ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;exists&quot;</span><span class="punctuation">:</span>   <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;title&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä½ å¯ä»¥ç”¨ bool æŸ¥è¯¢æ¥å®ç°ä½ çš„éœ€æ±‚ã€‚è¿™ç§æŸ¥è¯¢å°†å¤šæŸ¥è¯¢ç»„åˆåœ¨ä¸€èµ·ï¼Œæˆä¸ºç”¨æˆ·è‡ªå·±æƒ³è¦çš„å¸ƒå°”æŸ¥è¯¢ã€‚å®ƒæ¥æ”¶ä»¥ä¸‹å‚æ•°ï¼š</p>
<p>must<br>æ–‡æ¡£ å¿…é¡» åŒ¹é…è¿™äº›æ¡ä»¶æ‰èƒ½è¢«åŒ…å«è¿›æ¥ã€‚<br>must_not<br>æ–‡æ¡£ å¿…é¡»ä¸ åŒ¹é…è¿™äº›æ¡ä»¶æ‰èƒ½è¢«åŒ…å«è¿›æ¥ã€‚<br>should<br>å¦‚æœæ»¡è¶³è¿™äº›è¯­å¥ä¸­çš„ä»»æ„è¯­å¥ï¼Œå°†å¢åŠ  _score ï¼Œå¦åˆ™ï¼Œæ— ä»»ä½•å½±å“ã€‚å®ƒä»¬ä¸»è¦ç”¨äºä¿®æ­£æ¯ä¸ªæ–‡æ¡£çš„ç›¸å…³æ€§å¾—åˆ†ã€‚<br>filter<br>å¿…é¡» åŒ¹é…ï¼Œä½†å®ƒä»¥ä¸è¯„åˆ†ã€è¿‡æ»¤æ¨¡å¼æ¥è¿›è¡Œã€‚è¿™äº›è¯­å¥å¯¹è¯„åˆ†æ²¡æœ‰è´¡çŒ®ï¼Œåªæ˜¯æ ¹æ®è¿‡æ»¤æ ‡å‡†æ¥æ’é™¤æˆ–åŒ…å«æ–‡æ¡£ã€‚<br>ç”±äºè¿™æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„ç¬¬ä¸€ä¸ªåŒ…å«å¤šä¸ªæŸ¥è¯¢çš„æŸ¥è¯¢ï¼Œæ‰€ä»¥æœ‰å¿…è¦è®¨è®ºä¸€ä¸‹ç›¸å…³æ€§å¾—åˆ†æ˜¯å¦‚ä½•ç»„åˆçš„ã€‚æ¯ä¸€ä¸ªå­æŸ¥è¯¢éƒ½ç‹¬è‡ªåœ°è®¡ç®—æ–‡æ¡£çš„ç›¸å…³æ€§å¾—åˆ†ã€‚ä¸€æ—¦ä»–ä»¬çš„å¾—åˆ†è¢«è®¡ç®—å‡ºæ¥ï¼Œ bool æŸ¥è¯¢å°±å°†è¿™äº›å¾—åˆ†è¿›è¡Œåˆå¹¶å¹¶ä¸”è¿”å›ä¸€ä¸ªä»£è¡¨æ•´ä¸ªå¸ƒå°”æ“ä½œçš„å¾—åˆ†ã€‚</p>
<p>ä¸‹é¢çš„æŸ¥è¯¢ç”¨äºæŸ¥æ‰¾ title å­—æ®µåŒ¹é… how to make millions å¹¶ä¸”ä¸è¢«æ ‡è¯†ä¸º spam çš„æ–‡æ¡£ã€‚é‚£äº›è¢«æ ‡è¯†ä¸º starred æˆ–åœ¨2014ä¹‹åçš„æ–‡æ¡£ï¼Œå°†æ¯”å¦å¤–é‚£äº›æ–‡æ¡£æ‹¥æœ‰æ›´é«˜çš„æ’åã€‚å¦‚æœ <em>ä¸¤è€…</em> éƒ½æ»¡è¶³ï¼Œé‚£ä¹ˆå®ƒæ’åå°†æ›´é«˜ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span>     <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;how to make millions&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;spam&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;starred&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2014-01-01&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æœ‰ must è¯­å¥ï¼Œé‚£ä¹ˆè‡³å°‘éœ€è¦èƒ½å¤ŸåŒ¹é…å…¶ä¸­çš„ä¸€æ¡ should è¯­å¥ã€‚ä½†ï¼Œå¦‚æœå­˜åœ¨è‡³å°‘ä¸€æ¡ must è¯­å¥ï¼Œåˆ™å¯¹ should è¯­å¥çš„åŒ¹é…æ²¡æœ‰è¦æ±‚ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span>     <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;how to make millions&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;spam&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;starred&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2014-01-01&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>è¿‡å°† range æŸ¥è¯¢ç§»åˆ° filter è¯­å¥ä¸­ï¼Œæˆ‘ä»¬å°†å®ƒè½¬æˆä¸è¯„åˆ†çš„æŸ¥è¯¢ï¼Œå°†ä¸å†å½±å“æ–‡æ¡£çš„ç›¸å…³æ€§æ’åã€‚ç”±äºå®ƒç°åœ¨æ˜¯ä¸€ä¸ªä¸è¯„åˆ†çš„æŸ¥è¯¢ï¼Œå¯ä»¥ä½¿ç”¨å„ç§å¯¹ filter æŸ¥è¯¢æœ‰æ•ˆçš„ä¼˜åŒ–æ‰‹æ®µæ¥æå‡æ€§èƒ½ã€‚</p>
<p>å¯¹äºåˆæ³•æŸ¥è¯¢ï¼Œä½¿ç”¨ explain å‚æ•°å°†è¿”å›å¯è¯»çš„æè¿°ï¼Œè¿™å¯¹å‡†ç¡®ç†è§£ Elasticsearch æ˜¯å¦‚ä½•è§£æä½ çš„ query æ˜¯éå¸¸æœ‰ç”¨çš„ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_validate/query?explain</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;match&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;tweet&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;really powerful&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="æ’åºä¸ç›¸å…³æ€§"><a href="#æ’åºä¸ç›¸å…³æ€§" class="headerlink" title="æ’åºä¸ç›¸å…³æ€§"></a>æ’åºä¸ç›¸å…³æ€§</h2><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span>   <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;tweet&quot;</span><span class="punctuation">:</span> <span class="string">&quot;manage text search&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;filter&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;user_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span>   <span class="punctuation">&#123;</span> <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¯¹äºæ•°å­—æˆ–æ—¥æœŸï¼Œä½ å¯ä»¥å°†å¤šå€¼å­—æ®µå‡ä¸ºå•å€¼ï¼Œè¿™å¯ä»¥é€šè¿‡ä½¿ç”¨ min ã€ max ã€ avg æˆ–æ˜¯ sum æ’åºæ¨¡å¼ ã€‚ ä¾‹å¦‚ä½ å¯ä»¥æŒ‰ç…§æ¯ä¸ª date å­—æ®µä¸­çš„æœ€æ—©æ—¥æœŸè¿›è¡Œæ’åºï¼Œé€šè¿‡ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dates&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;min&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æ‰€æœ‰çš„ _core_field ç±»å‹ (strings, numbers, Booleans, dates) æ¥æ”¶ä¸€ä¸ª fields å‚æ•°</p>
<p>è¯¥å‚æ•°å…è®¸ä½ è½¬åŒ–ä¸€ä¸ªç®€å•çš„æ˜ å°„å¦‚ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;tweet&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>     <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;english&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä¸ºä¸€ä¸ªå¤šå­—æ®µæ˜ å°„å¦‚ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;tweet&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>     <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;english&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;raw&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;not_analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œè‡³å°‘åªè¦æˆ‘ä»¬é‡æ–°ç´¢å¼•äº†æˆ‘ä»¬çš„æ•°æ®ï¼Œä½¿ç”¨ tweet å­—æ®µç”¨äºæœç´¢ï¼Œtweet.raw å­—æ®µç”¨äºæ’åºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;tweet&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tweet.raw&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä»¥å…¨æ–‡ analyzed å­—æ®µæ’åºä¼šæ¶ˆè€—å¤§é‡çš„å†…å­˜</p>
<h3 id="ç›¸å…³æ€§"><a href="#ç›¸å…³æ€§" class="headerlink" title="ç›¸å…³æ€§"></a>ç›¸å…³æ€§</h3><p>æŸ¥è¯¢è¯­å¥ä¼šä¸ºæ¯ä¸ªæ–‡æ¡£ç”Ÿæˆä¸€ä¸ª _score å­—æ®µã€‚è¯„åˆ†çš„è®¡ç®—æ–¹å¼å–å†³äºæŸ¥è¯¢ç±»å‹ ä¸åŒçš„æŸ¥è¯¢è¯­å¥ç”¨äºä¸åŒçš„ç›®çš„ï¼š fuzzy æŸ¥è¯¢ä¼šè®¡ç®—ä¸å…³é”®è¯çš„æ‹¼å†™ç›¸ä¼¼ç¨‹åº¦ï¼Œterms æŸ¥è¯¢ä¼šè®¡ç®— æ‰¾åˆ°çš„å†…å®¹ä¸å…³é”®è¯ç»„æˆéƒ¨åˆ†åŒ¹é…çš„ç™¾åˆ†æ¯”ï¼Œä½†æ˜¯é€šå¸¸æˆ‘ä»¬è¯´çš„ relevance æ˜¯æˆ‘ä»¬ç”¨æ¥è®¡ç®—å…¨æ–‡æœ¬å­—æ®µçš„å€¼ç›¸å¯¹äºå…¨æ–‡æœ¬æ£€ç´¢è¯ç›¸ä¼¼ç¨‹åº¦çš„ç®—æ³•ã€‚</p>
<p>Elasticsearch çš„ç›¸ä¼¼åº¦ç®—æ³• è¢«å®šä¹‰ä¸ºæ£€ç´¢è¯é¢‘ç‡&#x2F;åå‘æ–‡æ¡£é¢‘ç‡ï¼Œ TF&#x2F;IDF.</p>
<p>è§£é‡Šä¸ºä»€ä¹ˆåŒ¹é…æˆ–ä¸åŒ¹é…</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /us/tweet/<span class="number">12</span>/_explain</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;bool&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;filter&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span> <span class="punctuation">:</span>  <span class="punctuation">&#123;</span> <span class="attr">&quot;user_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span>           <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;must&quot;</span> <span class="punctuation">:</span>  <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;tweet&quot;</span> <span class="punctuation">:</span>   <span class="string">&quot;honeymoon&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ Elasticsearch ä¸­ï¼Œdoc values å°±æ˜¯ä¸€ç§åˆ—å¼å­˜å‚¨ç»“æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹æ¯ä¸ªå­—æ®µçš„ doc values éƒ½æ˜¯æ¿€æ´»çš„ï¼Œdoc values æ˜¯åœ¨ç´¢å¼•æ—¶åˆ›å»ºçš„ï¼Œå½“å­—æ®µç´¢å¼•æ—¶ï¼ŒElasticsearch ä¸ºäº†èƒ½å¤Ÿå¿«é€Ÿæ£€ç´¢ï¼Œä¼šæŠŠå­—æ®µçš„å€¼åŠ å…¥å€’æ’ç´¢å¼•ä¸­ï¼ŒåŒæ—¶å®ƒä¹Ÿä¼šå­˜å‚¨è¯¥å­—æ®µçš„ doc valuesã€‚</p>
<h2 id="æ‰§è¡Œåˆ†å¸ƒå¼æ£€ç´¢"><a href="#æ‰§è¡Œåˆ†å¸ƒå¼æ£€ç´¢" class="headerlink" title="æ‰§è¡Œåˆ†å¸ƒå¼æ£€ç´¢"></a>æ‰§è¡Œåˆ†å¸ƒå¼æ£€ç´¢</h2><p>æœç´¢è¢«æ‰§è¡Œæˆä¸€ä¸ªä¸¤é˜¶æ®µè¿‡ç¨‹ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º query then fetch<br>ps:æŸ¥è¯¢é˜¶æ®µ+å–å›é˜¶æ®µ</p>
<p>æŸ¥è¯¢é˜¶æ®µ<br>æŸ¥è¯¢é˜¶æ®µåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤:</p>
<p>1.å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª search è¯·æ±‚åˆ° Node 3 ï¼Œ Node 3 ä¼šåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º from + size çš„ç©ºä¼˜å…ˆé˜Ÿåˆ—ã€‚<br>2.Node 3 å°†æŸ¥è¯¢è¯·æ±‚è½¬å‘åˆ°ç´¢å¼•çš„æ¯ä¸ªä¸»åˆ†ç‰‡æˆ–å‰¯æœ¬åˆ†ç‰‡ä¸­ã€‚æ¯ä¸ªåˆ†ç‰‡åœ¨æœ¬åœ°æ‰§è¡ŒæŸ¥è¯¢å¹¶æ·»åŠ ç»“æœåˆ°å¤§å°ä¸º from + size çš„æœ¬åœ°æœ‰åºä¼˜å…ˆé˜Ÿåˆ—ä¸­ã€‚<br>3.æ¯ä¸ªåˆ†ç‰‡è¿”å›å„è‡ªä¼˜å…ˆé˜Ÿåˆ—ä¸­æ‰€æœ‰æ–‡æ¡£çš„ ID å’Œæ’åºå€¼ç»™åè°ƒèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ Node 3 ï¼Œå®ƒåˆå¹¶è¿™äº›å€¼åˆ°è‡ªå·±çš„ä¼˜å…ˆé˜Ÿåˆ—ä¸­æ¥äº§ç”Ÿä¸€ä¸ªå…¨å±€æ’åºåçš„ç»“æœåˆ—è¡¨ã€‚</p>
<p>æ¯ä¸ªåˆ†ç‰‡åœ¨æœ¬åœ°æ‰§è¡ŒæŸ¥è¯¢è¯·æ±‚å¹¶ä¸”åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º from + size çš„ä¼˜å…ˆé˜Ÿåˆ—â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªåˆ†ç‰‡åˆ›å»ºçš„ç»“æœé›†è¶³å¤Ÿå¤§ï¼Œå‡å¯ä»¥æ»¡è¶³å…¨å±€çš„æœç´¢è¯·æ±‚ã€‚ åˆ†ç‰‡è¿”å›ä¸€ä¸ªè½»é‡çº§çš„ç»“æœåˆ—è¡¨åˆ°åè°ƒèŠ‚ç‚¹ï¼Œå®ƒä»…åŒ…å«æ–‡æ¡£ ID é›†åˆä»¥åŠä»»ä½•æ’åºéœ€è¦ç”¨åˆ°çš„å€¼ï¼Œä¾‹å¦‚ _score ã€‚</p>
<p>åè°ƒèŠ‚ç‚¹å°†è¿™äº›åˆ†ç‰‡çº§çš„ç»“æœåˆå¹¶åˆ°è‡ªå·±çš„æœ‰åºä¼˜å…ˆé˜Ÿåˆ—é‡Œï¼Œå®ƒä»£è¡¨äº†å…¨å±€æ’åºç»“æœé›†åˆã€‚è‡³æ­¤æŸ¥è¯¢è¿‡ç¨‹ç»“æŸã€‚<br>ps:from 90 size 10 ï¼Œéœ€è¦100é•¿åº¦çš„é˜Ÿåˆ—ã€‚</p>
<p>å–å›é˜¶æ®µ<br>åˆ†å¸ƒå¼é˜¶æ®µç”±ä»¥ä¸‹æ­¥éª¤æ„æˆï¼š</p>
<p>1.åè°ƒèŠ‚ç‚¹è¾¨åˆ«å‡ºå“ªäº›æ–‡æ¡£éœ€è¦è¢«å–å›å¹¶å‘ç›¸å…³çš„åˆ†ç‰‡æäº¤å¤šä¸ª GET è¯·æ±‚ã€‚<br>2.æ¯ä¸ªåˆ†ç‰‡åŠ è½½å¹¶ ä¸°å¯Œ æ–‡æ¡£ï¼Œå¦‚æœæœ‰éœ€è¦çš„è¯ï¼Œæ¥ç€è¿”å›æ–‡æ¡£ç»™åè°ƒèŠ‚ç‚¹ã€‚<br>3.ä¸€æ—¦æ‰€æœ‰çš„æ–‡æ¡£éƒ½è¢«å–å›äº†ï¼Œåè°ƒèŠ‚ç‚¹è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ã€‚</p>
<p>æ·±åˆ†é¡µï¼ˆDeep Paginationï¼‰</p>
<p>ç»™ 10,000 åˆ° 50,000 çš„ç»“æœæ–‡æ¡£æ·±åˆ†é¡µï¼ˆ 1,000 åˆ° 5,000 é¡µï¼‰æ˜¯å®Œå…¨å¯è¡Œçš„ã€‚ä½†æ˜¯ä½¿ç”¨è¶³å¤Ÿå¤§çš„ from å€¼ï¼Œæ’åºè¿‡ç¨‹å¯èƒ½ä¼šå˜å¾—éå¸¸æ²‰é‡ï¼Œä½¿ç”¨å¤§é‡çš„CPUã€å†…å­˜å’Œå¸¦å®½ã€‚å› ä¸ºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½ ä¸è¦ä½¿ç”¨æ·±åˆ†é¡µã€‚</p>
<p>å®é™…ä¸Šï¼Œ â€œæ·±åˆ†é¡µâ€ å¾ˆå°‘ç¬¦åˆäººçš„è¡Œä¸ºã€‚å½“2åˆ°3é¡µè¿‡å»ä»¥åï¼Œäººä¼šåœæ­¢ç¿»é¡µï¼Œå¹¶ä¸”æ”¹å˜æœç´¢æ ‡å‡†ã€‚ä¼šä¸çŸ¥ç–²å€¦åœ°ä¸€é¡µä¸€é¡µçš„è·å–ç½‘é¡µç›´åˆ°ä½ çš„æœåŠ¡å´©æºƒçš„ç½ªé­ç¥¸é¦–ä¸€èˆ¬æ˜¯æœºå™¨äººæˆ–è€…web spiderã€‚</p>
<p>å¦‚æœä½  ç¡®å® éœ€è¦ä»ä½ çš„é›†ç¾¤å–å›å¤§é‡çš„æ–‡æ¡£ï¼Œä½ å¯ä»¥é€šè¿‡ç”¨ scroll æŸ¥è¯¢ç¦ç”¨æ’åºä½¿è¿™ä¸ªå–å›è¡Œä¸ºæ›´æœ‰æ•ˆç‡ï¼Œæˆ‘ä»¬ä¼šåœ¨ later in this chapter è¿›è¡Œè®¨è®ºã€‚</p>
<p>è¶…æ—¶é—®é¢˜<br>é€šå¸¸åˆ†ç‰‡å¤„ç†å®Œå®ƒæ‰€æœ‰çš„æ•°æ®åå†æŠŠç»“æœè¿”å›ç»™ååŒèŠ‚ç‚¹ï¼ŒååŒèŠ‚ç‚¹æŠŠæ”¶åˆ°çš„æ‰€æœ‰ç»“æœåˆå¹¶ä¸ºæœ€ç»ˆç»“æœã€‚</p>
<p>è¿™æ„å‘³ç€èŠ±è´¹çš„æ—¶é—´æ˜¯æœ€æ…¢åˆ†ç‰‡çš„å¤„ç†æ—¶é—´åŠ ç»“æœåˆå¹¶çš„æ—¶é—´ã€‚å¦‚æœæœ‰ä¸€ä¸ªèŠ‚ç‚¹æœ‰é—®é¢˜ï¼Œå°±ä¼šå¯¼è‡´æ‰€æœ‰çš„å“åº”ç¼“æ…¢ã€‚</p>
<p>å‚æ•° timeout å‘Šè¯‰ åˆ†ç‰‡å…è®¸å¤„ç†æ•°æ®çš„æœ€å¤§æ—¶é—´ã€‚å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„æ—¶é—´å¤„ç†æ‰€æœ‰æ•°æ®ï¼Œè¿™ä¸ªåˆ†ç‰‡çš„ç»“æœå¯ä»¥æ˜¯éƒ¨åˆ†çš„ï¼Œç”šè‡³æ˜¯ç©ºæ•°æ®ã€‚</p>
<p>æœç´¢çš„è¿”å›ç»“æœä¼šç”¨å±æ€§ timed_out æ ‡æ˜åˆ†ç‰‡æ˜¯å¦è¿”å›çš„æ˜¯éƒ¨åˆ†ç»“æœï¼š</p>
<pre><code>...
&quot;timed_out&quot;:     true,
...
</code></pre>
<p>æ¸¸æ ‡æŸ¥è¯¢ Scroll<br>scroll æŸ¥è¯¢ å¯ä»¥ç”¨æ¥å¯¹ Elasticsearch æœ‰æ•ˆåœ°æ‰§è¡Œå¤§æ‰¹é‡çš„æ–‡æ¡£æŸ¥è¯¢ï¼Œè€Œåˆä¸ç”¨ä»˜å‡ºæ·±åº¦åˆ†é¡µé‚£ç§ä»£ä»·ã€‚</p>
<p>æ¸¸æ ‡æŸ¥è¯¢å…è®¸æˆ‘ä»¬ å…ˆåšæŸ¥è¯¢åˆå§‹åŒ–ï¼Œç„¶åå†æ‰¹é‡åœ°æ‹‰å–ç»“æœã€‚ è¿™æœ‰ç‚¹å„¿åƒä¼ ç»Ÿæ•°æ®åº“ä¸­çš„ cursor ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /old_index/_search?scroll=<span class="number">1</span>m</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;_doc&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span>  <span class="number">1000</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ä¿æŒæ¸¸æ ‡æŸ¥è¯¢çª—å£ä¸€åˆ†é’Ÿã€‚</p>
<p>å…³é”®å­— _doc æ˜¯æœ€æœ‰æ•ˆçš„æ’åºé¡ºåºã€‚</p>
<p>è¿™ä¸ªæŸ¥è¯¢çš„è¿”å›ç»“æœåŒ…æ‹¬ä¸€ä¸ªå­—æ®µ _scroll_id<code>ï¼Œ å®ƒæ˜¯ä¸€ä¸ªbase64ç¼–ç çš„é•¿å­—ç¬¦ä¸² (((&quot;scroll_id&quot;))) ã€‚ ç°åœ¨æˆ‘ä»¬èƒ½ä¼ é€’å­—æ®µ </code>_scroll_id åˆ° _search&#x2F;scroll æŸ¥è¯¢æ¥å£è·å–ä¸‹ä¸€æ‰¹ç»“æœï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_search/scroll</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;scroll&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1m&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;scroll_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;cXVlcnlUaGVuRmV0Y2g7NTsxMDk5NDpkUmpiR2FjOFNhNnlCM1ZDMWpWYnRROzEwOTk1OmRSamJHYWM4U2E2eUIzVkMxalZidFE7MTA5OTM6ZFJqYkdhYzhTYTZ5QjNWQzFqVmJ0UTsxMTE5MDpBVUtwN2lxc1FLZV8yRGVjWlI2QUVBOzEwOTk2OmRSamJHYWM4U2E2eUIzVkMxalZidFE7MDs=&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„å†æ¬¡è®¾ç½®æ¸¸æ ‡æŸ¥è¯¢è¿‡æœŸæ—¶é—´ä¸ºä¸€åˆ†é’Ÿã€‚</p>
<p>è¿™ä¸ªæ¸¸æ ‡æŸ¥è¯¢è¿”å›çš„ä¸‹ä¸€æ‰¹ç»“æœã€‚ å°½ç®¡æˆ‘ä»¬æŒ‡å®šå­—æ®µ size çš„å€¼ä¸º1000ï¼Œæˆ‘ä»¬æœ‰å¯èƒ½å–åˆ°è¶…è¿‡è¿™ä¸ªå€¼æ•°é‡çš„æ–‡æ¡£ã€‚ å½“æŸ¥è¯¢çš„æ—¶å€™ï¼Œ å­—æ®µ size ä½œç”¨äºå•ä¸ªåˆ†ç‰‡ï¼Œæ‰€ä»¥æ¯ä¸ªæ‰¹æ¬¡å®é™…è¿”å›çš„æ–‡æ¡£æ•°é‡æœ€å¤§ä¸º size * number_of_primary_shards ã€‚</p>
<h2 id="ç´¢å¼•ç®¡ç†"><a href="#ç´¢å¼•ç®¡ç†" class="headerlink" title="ç´¢å¼•ç®¡ç†"></a>ç´¢å¼•ç®¡ç†</h2><p>åˆ›å»ºç´¢å¼•</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> ... any settings ... <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type_one&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> ... any mappings ... <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type_two&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> ... any mappings ... <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>åˆ é™¤ç´¢å¼•<br>ç”¨ä»¥ä¸‹çš„è¯·æ±‚æ¥ åˆ é™¤ç´¢å¼•:</p>
<p>DELETE &#x2F;my_index<br>ä½ ä¹Ÿå¯ä»¥è¿™æ ·åˆ é™¤å¤šä¸ªç´¢å¼•ï¼š</p>
<p>DELETE &#x2F;index_one,index_two<br>DELETE &#x2F;index_*<br>ä½ ç”šè‡³å¯ä»¥è¿™æ ·åˆ é™¤ å…¨éƒ¨ ç´¢å¼•ï¼š</p>
<p>DELETE &#x2F;_all<br>DELETE &#x2F;*</p>
<p>è®¾ç½®ç´¢å¼•</p>
<p>ä¸‹é¢æ˜¯ä¸¤ä¸ª æœ€é‡è¦çš„è®¾ç½®ï¼š</p>
<p>number_of_shards<br>æ¯ä¸ªç´¢å¼•çš„ä¸»åˆ†ç‰‡æ•°ï¼Œé»˜è®¤å€¼æ˜¯ 5 ã€‚è¿™ä¸ªé…ç½®åœ¨ç´¢å¼•åˆ›å»ºåä¸èƒ½ä¿®æ”¹ã€‚<br>number_of_replicas<br>æ¯ä¸ªä¸»åˆ†ç‰‡çš„å‰¯æœ¬æ•°ï¼Œé»˜è®¤å€¼æ˜¯ 1 ã€‚å¯¹äºæ´»åŠ¨çš„ç´¢å¼•åº“ï¼Œè¿™ä¸ªé…ç½®å¯ä»¥éšæ—¶ä¿®æ”¹ã€‚</p>
<p>å¯ä»¥ç”¨ update-index-settings API åŠ¨æ€ä¿®æ”¹å‰¯æœ¬æ•°ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_temp_index/_settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºè‡ªå®šä¹‰åˆ†æå™¨</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;char_filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> ... custom character filters ... <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span>   <span class="punctuation">&#123;</span> ...    custom tokenizers     ... <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span>      <span class="punctuation">&#123;</span> ...   custom token filters   ... <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span>    <span class="punctuation">&#123;</span> ...    custom analyzers      ... <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>åˆ†æå™¨åº”ç”¨åœ¨ä¸€ä¸ª string å­—æ®µä¸Šï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_mapping/my_type</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>      <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;my_analyzer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="ç±»å‹å’Œæ˜ å°„"><a href="#ç±»å‹å’Œæ˜ å°„" class="headerlink" title="ç±»å‹å’Œæ˜ å°„"></a>ç±»å‹å’Œæ˜ å°„</h3><p>å¦‚æœæœ‰ä¸¤ä¸ªä¸åŒçš„ç±»å‹ï¼Œæ¯ä¸ªç±»å‹éƒ½æœ‰åŒåçš„å­—æ®µï¼Œä½†æ˜ å°„ä¸åŒï¼ˆä¾‹å¦‚ï¼šä¸€ä¸ªæ˜¯å­—ç¬¦ä¸²ä¸€ä¸ªæ˜¯æ•°å­—ï¼‰ï¼Œå°†ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼Ÿ</p>
<p>ç®€å•å›ç­”æ˜¯ï¼ŒElasticsearch ä¸ä¼šå…è®¸ä½ å®šä¹‰è¿™ä¸ªæ˜ å°„ã€‚å½“ä½ é…ç½®è¿™ä¸ªæ˜ å°„æ—¶ï¼Œå°†ä¼šå‡ºç°å¼‚å¸¸ã€‚</p>
<p>Lucene æ²¡æœ‰æ–‡æ¡£ç±»å‹çš„æ¦‚å¿µï¼Œæ¯ä¸ªæ–‡æ¡£çš„ç±»å‹åè¢«å­˜å‚¨åœ¨ä¸€ä¸ªå« _type çš„å…ƒæ•°æ®å­—æ®µä¸Šã€‚ å½“æˆ‘ä»¬è¦æ£€ç´¢æŸä¸ªç±»å‹çš„æ–‡æ¡£æ—¶, Elasticsearch é€šè¿‡åœ¨ _type å­—æ®µä¸Šä½¿ç”¨è¿‡æ»¤å™¨é™åˆ¶åªè¿”å›è¿™ä¸ªç±»å‹çš„æ–‡æ¡£ã€‚</p>
<p>Lucene ä¹Ÿæ²¡æœ‰æ˜ å°„çš„æ¦‚å¿µã€‚ æ˜ å°„æ˜¯ Elasticsearch å°†å¤æ‚ JSON æ–‡æ¡£ æ˜ å°„ æˆ Lucene éœ€è¦çš„æ‰å¹³åŒ–æ•°æ®çš„æ–¹å¼ã€‚</p>
<p>é‡è¦çš„ä¸€ç‚¹æ˜¯: ç±»å‹å¯ä»¥å¾ˆå¥½çš„åŒºåˆ†åŒä¸€ä¸ªé›†åˆä¸­çš„ä¸åŒç»†åˆ†ã€‚åœ¨ä¸åŒçš„ç»†åˆ†ä¸­æ•°æ®çš„æ•´ä½“æ¨¡å¼æ˜¯ç›¸åŒçš„ï¼ˆæˆ–ç›¸ä¼¼çš„ï¼‰ã€‚</p>
<p>ç±»å‹ä¸é€‚åˆ å®Œå…¨ä¸åŒç±»å‹çš„æ•°æ® ã€‚å¦‚æœä¸¤ä¸ªç±»å‹çš„å­—æ®µé›†æ˜¯äº’ä¸ç›¸åŒçš„ï¼Œè¿™å°±æ„å‘³ç€ç´¢å¼•ä¸­å°†æœ‰ä¸€åŠçš„æ•°æ®æ˜¯ç©ºçš„ï¼ˆå­—æ®µå°†æ˜¯ ç¨€ç–çš„ ï¼‰ï¼Œæœ€ç»ˆå°†å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¥½æ˜¯ä½¿ç”¨ä¸¤ä¸ªå•ç‹¬çš„ç´¢å¼•ã€‚</p>
<h3 id="æ ¹å¯¹è±¡"><a href="#æ ¹å¯¹è±¡" class="headerlink" title="æ ¹å¯¹è±¡"></a>æ ¹å¯¹è±¡</h3><p>_source å­—æ®µåœ¨è¢«å†™å…¥ç£ç›˜ä¹‹å‰å…ˆä¼šè¢«å‹ç¼©ã€‚<br>è¿™ä¸ªå­—æ®µçš„å­˜å‚¨å‡ ä¹æ€»æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œå› ä¸ºå®ƒæ„å‘³ç€ä¸‹é¢çš„è¿™äº›ï¼š</p>
<ul>
<li>æœç´¢ç»“æœåŒ…æ‹¬äº†æ•´ä¸ªå¯ç”¨çš„æ–‡æ¡£â€”â€”ä¸éœ€è¦é¢å¤–çš„ä»å¦ä¸€ä¸ªçš„æ•°æ®ä»“åº“æ¥å–æ–‡æ¡£ã€‚</li>
<li>å¦‚æœæ²¡æœ‰ _source å­—æ®µï¼Œéƒ¨åˆ† update è¯·æ±‚ä¸ä¼šç”Ÿæ•ˆã€‚</li>
<li>å½“ä½ çš„æ˜ å°„æ”¹å˜æ—¶ï¼Œä½ éœ€è¦é‡æ–°ç´¢å¼•ä½ çš„æ•°æ®ï¼Œæœ‰äº†_sourceå­—æ®µä½ å¯ä»¥ç›´æ¥ä»Elasticsearchè¿™æ ·åšï¼Œè€Œä¸å¿…ä»å¦ä¸€ä¸ªï¼ˆé€šå¸¸æ˜¯é€Ÿåº¦æ›´æ…¢çš„ï¼‰æ•°æ®ä»“åº“å–å›ä½ çš„æ‰€æœ‰æ–‡æ¡£ã€‚</li>
<li>å½“ä½ ä¸éœ€è¦çœ‹åˆ°æ•´ä¸ªæ–‡æ¡£æ—¶ï¼Œå•ä¸ªå­—æ®µå¯ä»¥ä» _source å­—æ®µæå–å’Œé€šè¿‡ get æˆ–è€… search è¯·æ±‚è¿”å›ã€‚</li>
<li>è°ƒè¯•æŸ¥è¯¢è¯­å¥æ›´åŠ ç®€å•ï¼Œå› ä¸ºä½ å¯ä»¥ç›´æ¥çœ‹åˆ°æ¯ä¸ªæ–‡æ¡£åŒ…æ‹¬ä»€ä¹ˆï¼Œè€Œä¸æ˜¯ä»ä¸€åˆ—idçŒœæµ‹å®ƒä»¬çš„å†…å®¹ã€‚<br>ç„¶è€Œï¼Œå­˜å‚¨ _source å­—æ®µçš„ç¡®è¦ä½¿ç”¨ç£ç›˜ç©ºé—´ã€‚å¦‚æœä¸Šé¢çš„åŸå› å¯¹ä½ æ¥è¯´æ²¡æœ‰ä¸€ä¸ªæ˜¯é‡è¦çš„ï¼Œä½ å¯ä»¥ç”¨ä¸‹é¢çš„æ˜ å°„ç¦ç”¨ _source å­—æ®µï¼š<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span>  <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
åœ¨ä¸€ä¸ªæœç´¢è¯·æ±‚é‡Œï¼Œä½ å¯ä»¥é€šè¿‡åœ¨è¯·æ±‚ä½“ä¸­æŒ‡å®š _source å‚æ•°ï¼Œæ¥è¾¾åˆ°åªè·å–ç‰¹å®šçš„å­—æ®µçš„æ•ˆæœï¼š<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>   <span class="punctuation">&#123;</span> <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;title&quot;</span><span class="punctuation">,</span> <span class="string">&quot;created&quot;</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>_all å­—æ®µï¼š<br>ä¸€ä¸ªæŠŠå…¶å®ƒå­—æ®µå€¼ å½“ä½œä¸€ä¸ªå¤§å­—ç¬¦ä¸²æ¥ç´¢å¼•çš„ç‰¹æ®Šå­—æ®µã€‚ query_string æŸ¥è¯¢å­å¥(æœç´¢ ?q&#x3D;john )åœ¨æ²¡æœ‰æŒ‡å®šå­—æ®µæ—¶é»˜è®¤ä½¿ç”¨ _all å­—æ®µã€‚</p>
<p>relevance algorithm è€ƒè™‘çš„ä¸€ä¸ªæœ€é‡è¦çš„åŸåˆ™æ˜¯å­—æ®µçš„é•¿åº¦ï¼šå­—æ®µè¶ŠçŸ­è¶Šé‡è¦ã€‚ åœ¨è¾ƒçŸ­çš„ title å­—æ®µä¸­å‡ºç°çš„çŸ­è¯­å¯èƒ½æ¯”åœ¨è¾ƒé•¿çš„ content å­—æ®µä¸­å‡ºç°çš„çŸ­è¯­æ›´åŠ é‡è¦ã€‚å­—æ®µé•¿åº¦çš„åŒºåˆ«åœ¨ _all å­—æ®µä¸­ä¸ä¼šå‡ºç°ã€‚</p>
<p>å¦‚æœä½ ä¸å†éœ€è¦ _all å­—æ®µï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ˜ å°„æ¥ç¦ç”¨ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_mapping/my_type</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span> <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä½ å¯ä»¥ä¸ºæ‰€æœ‰å­—æ®µé»˜è®¤ç¦ç”¨ include_in_all é€‰é¡¹ï¼Œä»…åœ¨ä½ é€‰æ‹©çš„å­—æ®µä¸Šå¯ç”¨ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index/my_type/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;include_in_all&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>           <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;include_in_all&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            ...</span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>è®°ä½ï¼Œ_all å­—æ®µä»…ä»…æ˜¯ä¸€ä¸ª ç»è¿‡åˆ†è¯çš„ string å­—æ®µã€‚å®ƒä½¿ç”¨é»˜è®¤åˆ†è¯å™¨æ¥åˆ†æå®ƒçš„å€¼ï¼Œä¸ç®¡è¿™ä¸ªå€¼åŸæœ¬æ‰€åœ¨å­—æ®µæŒ‡å®šçš„åˆ†è¯å™¨ã€‚å°±åƒæ‰€æœ‰ string å­—æ®µï¼Œä½ å¯ä»¥é…ç½® _all å­—æ®µä½¿ç”¨çš„åˆ†è¯å™¨ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index/my_type/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;whitespace&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>æ–‡æ¡£æ ‡è¯†ä¸å››ä¸ªå…ƒæ•°æ®å­—æ®µ ç›¸å…³ï¼š</p>
<ul>
<li>_id<br>æ–‡æ¡£çš„ ID å­—ç¬¦ä¸²</li>
<li>_type<br>æ–‡æ¡£çš„ç±»å‹å</li>
<li>_index<br>æ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•</li>
<li>_uid<br>_type å’Œ _id è¿æ¥åœ¨ä¸€èµ·æ„é€ æˆ type#id</li>
</ul>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ _uid å­—æ®µæ˜¯è¢«å­˜å‚¨ï¼ˆå¯å–å›ï¼‰å’Œç´¢å¼•ï¼ˆå¯æœç´¢ï¼‰çš„ã€‚ _type å­—æ®µè¢«ç´¢å¼•ä½†æ˜¯æ²¡æœ‰å­˜å‚¨ï¼Œ _id å’Œ _index å­—æ®µåˆ™æ—¢æ²¡æœ‰è¢«ç´¢å¼•ä¹Ÿæ²¡æœ‰è¢«å­˜å‚¨ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¹¶ä¸æ˜¯çœŸå®å­˜åœ¨çš„ã€‚</p>
<h3 id="åŠ¨æ€æ˜ å°„"><a href="#åŠ¨æ€æ˜ å°„" class="headerlink" title="åŠ¨æ€æ˜ å°„"></a>åŠ¨æ€æ˜ å°„</h3><p>å¹¸è¿çš„æ˜¯å¯ä»¥ç”¨ dynamic é…ç½®æ¥æ§åˆ¶è¿™ç§è¡Œä¸º ï¼Œå¯æ¥å—çš„é€‰é¡¹å¦‚ä¸‹ï¼š</p>
<p>true<br>åŠ¨æ€æ·»åŠ æ–°çš„å­—æ®µâ€“ç¼ºçœ<br>false<br>å¿½ç•¥æ–°çš„å­—æ®µ<br>strict<br>å¦‚æœé‡åˆ°æ–°å­—æ®µæŠ›å‡ºå¼‚å¸¸</p>
<p>æŠŠ dynamic è®¾ç½®ä¸º false ä¸€ç‚¹å„¿ä¹Ÿä¸ä¼šæ”¹å˜ _source çš„å­—æ®µå†…å®¹ã€‚ _source ä»ç„¶åŒ…å«è¢«ç´¢å¼•çš„æ•´ä¸ªJSONæ–‡æ¡£ã€‚åªæ˜¯æ–°çš„å­—æ®µä¸ä¼šè¢«åŠ åˆ°æ˜ å°„ä¸­ä¹Ÿä¸å¯æœç´¢ã€‚</p>
<p>æ—¥æœŸæ£€æµ‹å¯ä»¥é€šè¿‡åœ¨æ ¹å¯¹è±¡ä¸Šè®¾ç½® date_detection ä¸º false æ¥å…³é—­ï¼š</p>
<p>PUT &#x2F;my_index<br>{<br>    â€œmappingsâ€: {<br>        â€œmy_typeâ€: {<br>            â€œdate_detectionâ€: false<br>        }<br>    }<br>}</p>
<p>ä½¿ç”¨ dynamic_templates ï¼Œä½ å¯ä»¥å®Œå…¨æ§åˆ¶ æ–°æ£€æµ‹ç”Ÿæˆå­—æ®µçš„æ˜ å°„ã€‚ä½ ç”šè‡³å¯ä»¥é€šè¿‡å­—æ®µåç§°æˆ–æ•°æ®ç±»å‹æ¥åº”ç”¨ä¸åŒçš„æ˜ å°„ã€‚</p>
<p>ä¸€ä¸ªç´¢å¼•ä¸­çš„æ‰€æœ‰ç±»å‹å…±äº«ç›¸åŒçš„å­—æ®µå’Œè®¾ç½®ã€‚ <em>default</em> æ˜ å°„æ›´åŠ æ–¹ä¾¿åœ°æŒ‡å®šé€šç”¨è®¾ç½®ï¼Œè€Œä¸æ˜¯æ¯æ¬¡åˆ›å»ºæ–°ç±»å‹æ—¶éƒ½è¦é‡å¤è®¾ç½®ã€‚ <em>default</em> æ˜ å°„æ˜¯æ–°ç±»å‹çš„æ¨¡æ¿ã€‚<br>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <em>default</em> æ˜ å°„ä¸ºæ‰€æœ‰çš„ç±»å‹ç¦ç”¨ _all å­—æ®µï¼Œ è€Œåªåœ¨ blog ç±»å‹å¯ç”¨ï¼š</p>
<p>PUT &#x2F;my_index<br>{<br>    â€œmappingsâ€: {<br>        â€œ<em>default</em>â€œ: {<br>            â€œ_allâ€: { â€œenabledâ€:  false }<br>        },<br>        â€œblogâ€: {<br>            â€œ_allâ€: { â€œenabledâ€:  true  }<br>        }<br>    }<br>}</p>
<p>é‡æ–°ç´¢å¼•æ•°æ®<br>ä»æ—§ç´¢å¼•å¤åˆ¶åˆ°æ–°ç´¢å¼•</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;twitter&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;new_twitter&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ps:éœ€è¦å…ˆå‡†å¤‡å¥½ç›®æ ‡ç´¢å¼•<br>ps:<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html</a></p>
<p>ç´¢å¼• åˆ«å å°±åƒä¸€ä¸ªå¿«æ·æ–¹å¼æˆ–è½¯è¿æ¥ï¼Œå¯ä»¥æŒ‡å‘ä¸€ä¸ªæˆ–å¤šä¸ªç´¢å¼•ï¼Œä¹Ÿå¯ä»¥ç»™ä»»ä½•ä¸€ä¸ªéœ€è¦ç´¢å¼•åçš„APIæ¥ä½¿ç”¨ã€‚åˆ«å å¸¦ç»™æˆ‘ä»¬æå¤§çš„çµæ´»æ€§ï¼Œå…è®¸æˆ‘ä»¬åšä¸‹é¢è¿™äº›ï¼š</p>
<p>åœ¨è¿è¡Œçš„é›†ç¾¤ä¸­å¯ä»¥æ— ç¼çš„ä»ä¸€ä¸ªç´¢å¼•åˆ‡æ¢åˆ°å¦ä¸€ä¸ªç´¢å¼•<br>ç»™å¤šä¸ªç´¢å¼•åˆ†ç»„ (ä¾‹å¦‚ï¼Œ last_three_months)<br>ç»™ç´¢å¼•çš„ä¸€ä¸ªå­é›†åˆ›å»º è§†å›¾</p>
<p>é¦–å…ˆï¼Œåˆ›å»ºç´¢å¼• my_index_v1 ï¼Œç„¶åå°†åˆ«å my_index æŒ‡å‘å®ƒï¼š</p>
<p>PUT &#x2F;my_index_v1<br>PUT &#x2F;my_index_v1&#x2F;_alias&#x2F;my_index</p>
<p>ä½ å¯ä»¥æ£€æµ‹è¿™ä¸ªåˆ«åæŒ‡å‘å“ªä¸€ä¸ªç´¢å¼•ï¼š</p>
<p>GET &#x2F;*&#x2F;_alias&#x2F;my_index<br>æˆ–å“ªäº›åˆ«åæŒ‡å‘è¿™ä¸ªç´¢å¼•ï¼š</p>
<p>GET &#x2F;my_index_v1&#x2F;_alias&#x2F;*</p>
<p>åœ¨ä½ çš„åº”ç”¨ä¸­ä½¿ç”¨åˆ«åè€Œä¸æ˜¯ç´¢å¼•åã€‚ç„¶åä½ å°±å¯ä»¥åœ¨ä»»ä½•æ—¶å€™é‡å»ºç´¢å¼•ã€‚åˆ«åçš„å¼€é”€å¾ˆå°ï¼Œåº”è¯¥å¹¿æ³›ä½¿ç”¨ã€‚</p>
<h2 id="åˆ†ç‰‡å†…éƒ¨åŸç†"><a href="#åˆ†ç‰‡å†…éƒ¨åŸç†" class="headerlink" title="åˆ†ç‰‡å†…éƒ¨åŸç†"></a>åˆ†ç‰‡å†…éƒ¨åŸç†</h2><p>å€’æ’ç´¢å¼•è¢«å†™å…¥ç£ç›˜åæ˜¯ ä¸å¯æ”¹å˜ çš„:å®ƒæ°¸è¿œä¸ä¼šä¿®æ”¹ã€‚</p>
<p>æ–‡æ¡£æ›´æ–°ä¹Ÿæ˜¯ç±»ä¼¼çš„æ“ä½œæ–¹å¼ï¼šå½“ä¸€ä¸ªæ–‡æ¡£è¢«æ›´æ–°æ—¶ï¼Œæ—§ç‰ˆæœ¬æ–‡æ¡£è¢«æ ‡è®°åˆ é™¤ï¼Œæ–‡æ¡£çš„æ–°ç‰ˆæœ¬è¢«ç´¢å¼•åˆ°ä¸€ä¸ªæ–°çš„æ®µä¸­ã€‚ å¯èƒ½ä¸¤ä¸ªç‰ˆæœ¬çš„æ–‡æ¡£éƒ½ä¼šè¢«ä¸€ä¸ªæŸ¥è¯¢åŒ¹é…åˆ°ï¼Œä½†è¢«åˆ é™¤çš„é‚£ä¸ªæ—§ç‰ˆæœ¬æ–‡æ¡£åœ¨ç»“æœé›†è¿”å›å‰å°±å·²ç»è¢«ç§»é™¤ã€‚</p>
<p>åœ¨ Elasticsearch ä¸­ï¼Œå†™å…¥å’Œæ‰“å¼€ä¸€ä¸ªæ–°æ®µçš„è½»é‡çš„è¿‡ç¨‹å«åš refresh ã€‚ é»˜è®¤æƒ…å†µä¸‹æ¯ä¸ªåˆ†ç‰‡ä¼šæ¯ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¯´ Elasticsearch æ˜¯ è¿‘ å®æ—¶æœç´¢: æ–‡æ¡£çš„å˜åŒ–å¹¶ä¸æ˜¯ç«‹å³å¯¹æœç´¢å¯è§ï¼Œä½†ä¼šåœ¨ä¸€ç§’ä¹‹å†…å˜ä¸ºå¯è§ã€‚</p>
<p>ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹æ¯æ¬¡ç´¢å¼•ä¸€ä¸ªæ–‡æ¡£éƒ½å»æ‰‹åŠ¨åˆ·æ–°ã€‚ ç›¸åï¼Œä½ çš„åº”ç”¨éœ€è¦æ„è¯†åˆ° Elasticsearch çš„è¿‘å®æ—¶çš„æ€§è´¨ï¼Œå¹¶æ¥å—å®ƒçš„ä¸è¶³ã€‚</p>
<p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå½“ä½ æ­£åœ¨å»ºç«‹ä¸€ä¸ªå¤§çš„æ–°ç´¢å¼•æ—¶ï¼Œå¯ä»¥å…ˆå…³é—­è‡ªåŠ¨åˆ·æ–°ï¼Œå¾…å¼€å§‹ä½¿ç”¨è¯¥ç´¢å¼•æ—¶ï¼Œå†æŠŠå®ƒä»¬è°ƒå›æ¥ï¼š</p>
<p>PUT &#x2F;my_logs&#x2F;_settings<br>{ â€œrefresh_intervalâ€: -1 }</p>
<p>PUT &#x2F;my_logs&#x2F;_settings<br>{ â€œrefresh_intervalâ€: â€œ1sâ€ }</p>
<p>refresh_interval éœ€è¦ä¸€ä¸ª æŒç»­æ—¶é—´ å€¼ï¼Œ ä¾‹å¦‚ 1s ï¼ˆ1 ç§’ï¼‰ æˆ– 2m ï¼ˆ2 åˆ†é’Ÿï¼‰ã€‚ ä¸€ä¸ªç»å¯¹å€¼ 1 è¡¨ç¤ºçš„æ˜¯ 1æ¯«ç§’ â€“æ— ç–‘ä¼šä½¿ä½ çš„é›†ç¾¤é™·å…¥ç˜«ç—ªã€‚</p>
<p>è¿™ä¸ªæ‰§è¡Œä¸€ä¸ªæäº¤å¹¶ä¸”æˆªæ–­ translog çš„è¡Œä¸ºåœ¨ Elasticsearch è¢«ç§°ä½œä¸€æ¬¡ flush ã€‚ åˆ†ç‰‡æ¯30åˆ†é’Ÿè¢«è‡ªåŠ¨åˆ·æ–°ï¼ˆflushï¼‰ï¼Œæˆ–è€…åœ¨ translog å¤ªå¤§çš„æ—¶å€™ä¹Ÿä¼šåˆ·æ–°ã€‚</p>
<p>åœ¨æ–‡ä»¶è¢« fsync åˆ°ç£ç›˜å‰ï¼Œè¢«å†™å…¥çš„æ–‡ä»¶åœ¨é‡å¯ä¹‹åå°±ä¼šä¸¢å¤±ã€‚é»˜è®¤ translog æ˜¯æ¯ 5 ç§’è¢« fsync åˆ·æ–°åˆ°ç¡¬ç›˜ï¼Œ æˆ–è€…åœ¨æ¯æ¬¡å†™è¯·æ±‚å®Œæˆä¹‹åæ‰§è¡Œ(e.g. index, delete, update, bulk)ã€‚</p>
<p>æ®µåˆå¹¶çš„æ—¶å€™ä¼šå°†é‚£äº›æ—§çš„å·²åˆ é™¤æ–‡æ¡£ ä»æ–‡ä»¶ç³»ç»Ÿä¸­æ¸…é™¤ã€‚ è¢«åˆ é™¤çš„æ–‡æ¡£ï¼ˆæˆ–è¢«æ›´æ–°æ–‡æ¡£çš„æ—§ç‰ˆæœ¬ï¼‰ä¸ä¼šè¢«æ‹·è´åˆ°æ–°çš„å¤§æ®µä¸­ã€‚</p>
<p>optimize APIå¤§å¯çœ‹åšæ˜¯ å¼ºåˆ¶åˆå¹¶ API ã€‚å®ƒä¼šå°†ä¸€ä¸ªåˆ†ç‰‡å¼ºåˆ¶åˆå¹¶åˆ° max_num_segments å‚æ•°æŒ‡å®šå¤§å°çš„æ®µæ•°ç›®ã€‚ è¿™æ ·åšçš„æ„å›¾æ˜¯å‡å°‘æ®µçš„æ•°é‡ï¼ˆé€šå¸¸å‡å°‘åˆ°ä¸€ä¸ªï¼‰ï¼Œæ¥æå‡æœç´¢æ€§èƒ½ã€‚</p>
<p>ä½¿ç”¨optimizeä¼˜åŒ–è€çš„ç´¢å¼•ï¼Œå°†æ¯ä¸€ä¸ªåˆ†ç‰‡åˆå¹¶ä¸ºä¸€ä¸ªå•ç‹¬çš„æ®µå°±å¾ˆæœ‰ç”¨äº†ï¼›è¿™æ ·æ—¢å¯ä»¥èŠ‚çœèµ„æºï¼Œä¹Ÿå¯ä»¥ä½¿æœç´¢æ›´åŠ å¿«é€Ÿï¼š</p>
<p>POST &#x2F;logstash-2014-10&#x2F;_optimize?max_num_segments&#x3D;1</p>
<p>è¯·æ³¨æ„ï¼Œä½¿ç”¨ optimize API è§¦å‘æ®µåˆå¹¶çš„æ“ä½œä¸€ç‚¹ä¹Ÿä¸ä¼šå—åˆ°ä»»ä½•èµ„æºä¸Šçš„é™åˆ¶ã€‚è¿™å¯èƒ½ä¼šæ¶ˆè€—æ‰ä½ èŠ‚ç‚¹ä¸Šå…¨éƒ¨çš„I&#x2F;Oèµ„æº, ä½¿å…¶æ²¡æœ‰ä½™è£•æ¥å¤„ç†æœç´¢è¯·æ±‚ï¼Œä»è€Œæœ‰å¯èƒ½ä½¿é›†ç¾¤å¤±å»å“åº”ã€‚ å¦‚æœä½ æƒ³è¦å¯¹ç´¢å¼•æ‰§è¡Œ <code>optimize</code>ï¼Œä½ éœ€è¦å…ˆä½¿ç”¨åˆ†ç‰‡åˆ†é…ï¼ˆæŸ¥çœ‹ è¿ç§»æ—§ç´¢å¼•ï¼‰æŠŠç´¢å¼•ç§»åˆ°ä¸€ä¸ªå®‰å…¨çš„èŠ‚ç‚¹ï¼Œå†æ‰§è¡Œã€‚</p>
<h1 id="æ·±å…¥æœç´¢"><a href="#æ·±å…¥æœç´¢" class="headerlink" title="æ·±å…¥æœç´¢"></a>æ·±å…¥æœç´¢</h1><h2 id="ç»“æ„åŒ–æœç´¢"><a href="#ç»“æ„åŒ–æœç´¢" class="headerlink" title="ç»“æ„åŒ–æœç´¢"></a>ç»“æ„åŒ–æœç´¢</h2><p>é€šå¸¸å½“æŸ¥æ‰¾ä¸€ä¸ªç²¾ç¡®å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å¯¹æŸ¥è¯¢è¿›è¡Œè¯„åˆ†è®¡ç®—ã€‚åªå¸Œæœ›å¯¹æ–‡æ¡£è¿›è¡ŒåŒ…æ‹¬æˆ–æ’é™¤çš„è®¡ç®—ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šä½¿ç”¨ constant_score æŸ¥è¯¢ä»¥éè¯„åˆ†æ¨¡å¼æ¥æ‰§è¡Œ term æŸ¥è¯¢å¹¶ä»¥ä¸€ä½œä¸ºç»Ÿä¸€è¯„åˆ†ã€‚</p>
<p>æœ€ç»ˆç»„åˆçš„ç»“æœæ˜¯ä¸€ä¸ª constant_score æŸ¥è¯¢ï¼Œå®ƒåŒ…å«ä¸€ä¸ª term æŸ¥è¯¢ï¼š</p>
<p>GET &#x2F;my_store&#x2F;products&#x2F;_search<br>{<br>    â€œqueryâ€ : {<br>        â€œconstant_scoreâ€ : {<br>            â€œfilterâ€ : {<br>                â€œtermâ€ : {<br>                    â€œpriceâ€ : 20<br>                }<br>            }<br>        }<br>    }<br>}<br>ä»æ¦‚å¿µä¸Šè®°ä½éè¯„åˆ†è®¡ç®—æ˜¯é¦–å…ˆæ‰§è¡Œçš„ï¼Œè¿™å°†æœ‰åŠ©äºå†™å‡ºé«˜æ•ˆåˆå¿«é€Ÿçš„æœç´¢è¯·æ±‚ã€‚</p>
<p>ä¸€ä¸ª bool è¿‡æ»¤å™¨ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;bool&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span> <span class="punctuation">:</span>     <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;should&quot;</span> <span class="punctuation">:</span>   <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;must_not&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>must<br>æ‰€æœ‰çš„è¯­å¥éƒ½ å¿…é¡»ï¼ˆmustï¼‰ åŒ¹é…ï¼Œä¸ AND ç­‰ä»·ã€‚<br>must_not<br>æ‰€æœ‰çš„è¯­å¥éƒ½ ä¸èƒ½ï¼ˆmust notï¼‰ åŒ¹é…ï¼Œä¸ NOT ç­‰ä»·ã€‚<br>should<br>è‡³å°‘æœ‰ä¸€ä¸ªè¯­å¥è¦åŒ¹é…ï¼Œä¸ OR ç­‰ä»·ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /my_store/products/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filtered&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;filter&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;bool&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;should&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;productID&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;KDKE-B-9947-#kL5&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span> <span class="attr">&quot;bool&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;must&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;productID&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;JODL-X-1937-#pV7&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">           <span class="punctuation">&#125;</span></span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p> term å’Œ terms æ˜¯ åŒ…å«ï¼ˆcontainsï¼‰ æ“ä½œï¼Œè€Œé ç­‰å€¼ï¼ˆequalsï¼‰ ï¼ˆåˆ¤æ–­ï¼‰ã€‚ å¦‚ä½•ç†è§£è¿™å¥è¯å‘¢ï¼Ÿ</p>
<p>å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ª termï¼ˆè¯é¡¹ï¼‰è¿‡æ»¤å™¨ { â€œtermâ€ : { â€œtagsâ€ : â€œsearchâ€ } } ï¼Œå®ƒä¼šä¸ä»¥ä¸‹ä¸¤ä¸ªæ–‡æ¡£ åŒæ—¶ åŒ¹é…ï¼š</p>
<p>{ â€œtagsâ€ : [â€œsearchâ€] }<br>{ â€œtagsâ€ : [â€œsearchâ€, â€œopen_sourceâ€] }</p>
<p>å°½ç®¡ç¬¬äºŒä¸ªæ–‡æ¡£åŒ…å«é™¤ search ä»¥å¤–çš„å…¶ä»–è¯ï¼Œå®ƒè¿˜æ˜¯è¢«åŒ¹é…å¹¶ä½œä¸ºç»“æœè¿”å›ã€‚</p>
<p>å¦‚æœä¸€å®šæœŸæœ›å¾—åˆ°æˆ‘ä»¬å‰é¢è¯´çš„é‚£ç§è¡Œä¸ºï¼ˆå³æ•´ä¸ªå­—æ®µå®Œå…¨ç›¸ç­‰ï¼‰ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯å¢åŠ å¹¶ç´¢å¼•å¦ä¸€ä¸ªå­—æ®µï¼Œ è¿™ä¸ªå­—æ®µç”¨ä»¥å­˜å‚¨è¯¥å­—æ®µåŒ…å«è¯é¡¹çš„æ•°é‡ï¼ŒåŒæ ·ä»¥ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªæ–‡æ¡£ä¸ºä¾‹ï¼Œç°åœ¨æˆ‘ä»¬åŒ…æ‹¬äº†ä¸€ä¸ªç»´æŠ¤æ ‡ç­¾æ•°çš„æ–°å­—æ®µï¼š</p>
<p>{ â€œtagsâ€ : [â€œsearchâ€], â€œtag_countâ€ : 1 }<br>{ â€œtagsâ€ : [â€œsearchâ€, â€œopen_sourceâ€], â€œtag_countâ€ : 2 }</p>
<h3 id="èŒƒå›´æŸ¥è¯¢"><a href="#èŒƒå›´æŸ¥è¯¢" class="headerlink" title="èŒƒå›´æŸ¥è¯¢"></a>èŒƒå›´æŸ¥è¯¢</h3><p>range æ”¯æŒæ•°å€¼ã€æ—¥æœŸã€å­—ç¬¦ä¸²</p>
<p>â€œrangeâ€ : {<br>    â€œtimestampâ€ : {<br>        â€œgtâ€ : â€œ2014-01-01 00:00:00â€,<br>        â€œltâ€ : â€œ2014-01-07 00:00:00â€<br>    }<br>}</p>
<p>æ—¥æœŸè®¡ç®—<br>â€œrangeâ€ : {<br>    â€œtimestampâ€ : {<br>        â€œgtâ€ : â€œnow-1hâ€  # è¿‡å»ä¸€ä¸ªå°æ—¶<br>    }<br>}<br>â€œrangeâ€ : {<br>    â€œtimestampâ€ : {<br>        â€œgtâ€ : â€œ2014-01-01 00:00:00â€,<br>        â€œltâ€ : â€œ2014-01-01 00:00:00||+1Mâ€  #åŠ ä¸€ä¸ªæœˆ<br>    }<br>}<br>æ—¶é—´æ ¼å¼å‚è€ƒæ–‡æ¡£</p>
<p>å­—ç¬¦ä¸²èŒƒå›´å¯é‡‡ç”¨ å­—å…¸é¡ºåºï¼ˆlexicographicallyï¼‰ æˆ–å­—æ¯é¡ºåºï¼ˆalphabeticallyï¼‰ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢è¿™äº›å­—ç¬¦ä¸²æ˜¯é‡‡ç”¨å­—å…¸åºï¼ˆlexicographicallyï¼‰æ’åºçš„ï¼š</p>
<p>5, 50, 6, B, C, a, ab, abb, abc, b</p>
<p>â€œrangeâ€ : {<br>    â€œtitleâ€ : {<br>        â€œgteâ€ : â€œaâ€,<br>        â€œltâ€ :  â€œbâ€<br>    }<br>}<br>å­—ç¬¦ä¸²èŒƒå›´åœ¨è¿‡æ»¤ ä½åŸºæ•°ï¼ˆlow cardinalityï¼‰ å­—æ®µï¼ˆå³åªæœ‰å°‘é‡å”¯ä¸€è¯é¡¹ï¼‰æ—¶å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯å”¯ä¸€è¯é¡¹è¶Šå¤šï¼Œå­—ç¬¦ä¸²èŒƒå›´çš„è®¡ç®—ä¼šè¶Šæ…¢ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ç”¨ exists æˆ– missing æŸ¥è¯¢ name å­—æ®µå‘¢ï¼Ÿ name å­—æ®µå¹¶ä¸çœŸå®å­˜åœ¨äºå€’æ’ç´¢å¼•ä¸­ã€‚</p>
<p>åŸå› æ˜¯å½“æˆ‘ä»¬æ‰§è¡Œä¸‹é¢è¿™ä¸ªè¿‡æ»¤çš„æ—¶å€™ï¼š</p>
<p>{<br>    â€œexistsâ€ : { â€œfieldâ€ : â€œnameâ€ }<br>}<br>å®é™…æ‰§è¡Œçš„æ˜¯ï¼š</p>
<p>{<br>    â€œboolâ€: {<br>        â€œshouldâ€: [<br>            { â€œexistsâ€: { â€œfieldâ€: â€œname.firstâ€ }},<br>            { â€œexistsâ€: { â€œfieldâ€: â€œname.lastâ€ }}<br>        ]<br>    }<br>}<br>è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå¦‚æœ first å’Œ last éƒ½æ˜¯ç©ºï¼Œé‚£ä¹ˆ name è¿™ä¸ªå‘½åç©ºé—´æ‰ä¼šè¢«è®¤ä¸ºä¸å­˜åœ¨ã€‚</p>
<p>Elasticsearch ä¼šåŸºäºä½¿ç”¨é¢‘æ¬¡è‡ªåŠ¨ç¼“å­˜æŸ¥è¯¢ã€‚å¦‚æœä¸€ä¸ªéè¯„åˆ†æŸ¥è¯¢åœ¨æœ€è¿‘çš„ 256 è¯æŸ¥è¯¢ä¸­è¢«ä½¿ç”¨è¿‡ï¼ˆæ¬¡æ•°å–å†³äºæŸ¥è¯¢ç±»å‹ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæŸ¥è¯¢å°±ä¼šä½œä¸ºç¼“å­˜çš„å€™é€‰ã€‚ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç‰‡æ®µéƒ½èƒ½ä¿è¯ç¼“å­˜ bitset ã€‚åªæœ‰é‚£äº›æ–‡æ¡£æ•°é‡è¶…è¿‡ 10,000 ï¼ˆæˆ–è¶…è¿‡æ€»æ–‡æ¡£æ•°é‡çš„ 3% )æ‰ä¼šç¼“å­˜ bitset ã€‚å› ä¸ºå°çš„ç‰‡æ®µå¯ä»¥å¾ˆå¿«çš„è¿›è¡Œæœç´¢å’Œåˆå¹¶ï¼Œè¿™é‡Œç¼“å­˜çš„æ„ä¹‰ä¸å¤§ã€‚</p>
<h2 id="å…¨æ–‡æœç´¢-1"><a href="#å…¨æ–‡æœç´¢-1" class="headerlink" title="å…¨æ–‡æœç´¢"></a>å…¨æ–‡æœç´¢</h2><h3 id="åŸºäºè¯é¡¹ä¸åŸºäºå…¨æ–‡"><a href="#åŸºäºè¯é¡¹ä¸åŸºäºå…¨æ–‡" class="headerlink" title="åŸºäºè¯é¡¹ä¸åŸºäºå…¨æ–‡"></a>åŸºäºè¯é¡¹ä¸åŸºäºå…¨æ–‡</h3><p>æ–‡æœ¬æŸ¥è¯¢å¯ä»¥åˆ’åˆ†æˆä¸¤å¤§å®¶æ—ï¼š</p>
<ul>
<li><p>åŸºäºè¯é¡¹çš„æŸ¥è¯¢<br>å¦‚ term æˆ– fuzzy è¿™æ ·çš„åº•å±‚æŸ¥è¯¢ä¸éœ€è¦åˆ†æé˜¶æ®µï¼Œå®ƒä»¬å¯¹å•ä¸ªè¯é¡¹è¿›è¡Œæ“ä½œã€‚ç”¨ term æŸ¥è¯¢è¯é¡¹ Foo åªè¦åœ¨å€’æ’ç´¢å¼•ä¸­æŸ¥æ‰¾ å‡†ç¡®è¯é¡¹ ï¼Œå¹¶ä¸”ç”¨ TF&#x2F;IDF ç®—æ³•ä¸ºæ¯ä¸ªåŒ…å«è¯¥è¯é¡¹çš„æ–‡æ¡£è®¡ç®—ç›¸å…³åº¦è¯„åˆ† _score ã€‚<br>è®°ä½ term æŸ¥è¯¢åªå¯¹å€’æ’ç´¢å¼•çš„è¯é¡¹ç²¾ç¡®åŒ¹é…ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œå®ƒä¸ä¼šå¯¹è¯çš„å¤šæ ·æ€§è¿›è¡Œå¤„ç†ï¼ˆå¦‚ï¼Œ foo æˆ– FOO ï¼‰ã€‚è¿™é‡Œï¼Œæ— é¡»è€ƒè™‘è¯é¡¹æ˜¯å¦‚ä½•å­˜å…¥ç´¢å¼•çš„ã€‚å¦‚æœæ˜¯å°† [â€œFooâ€,â€Barâ€] ç´¢å¼•å­˜å…¥ä¸€ä¸ªä¸åˆ†æçš„ï¼ˆ not_analyzed ï¼‰åŒ…å«ç²¾ç¡®å€¼çš„å­—æ®µï¼Œæˆ–è€…å°† Foo Bar ç´¢å¼•åˆ°ä¸€ä¸ªå¸¦æœ‰ whitespace ç©ºæ ¼åˆ†æå™¨çš„å­—æ®µï¼Œä¸¤è€…çš„ç»“æœéƒ½ä¼šæ˜¯åœ¨å€’æ’ç´¢å¼•ä¸­æœ‰ Foo å’Œ Bar è¿™ä¸¤ä¸ªè¯ã€‚</p>
</li>
<li><p>åŸºäºå…¨æ–‡çš„æŸ¥è¯¢<br>åƒ match æˆ– query_string è¿™æ ·çš„æŸ¥è¯¢æ˜¯é«˜å±‚æŸ¥è¯¢ï¼Œå®ƒä»¬äº†è§£å­—æ®µæ˜ å°„çš„ä¿¡æ¯ï¼š<br>å¦‚æœæŸ¥è¯¢ æ—¥æœŸï¼ˆdateï¼‰ æˆ– æ•´æ•°ï¼ˆintegerï¼‰å­—æ®µï¼Œå®ƒä»¬ä¼šå°†æŸ¥è¯¢å­—ç¬¦ä¸²åˆ†åˆ«ä½œä¸ºæ—¥æœŸæˆ–æ•´æ•°å¯¹å¾…ã€‚<br>å¦‚æœæŸ¥è¯¢ä¸€ä¸ªï¼ˆ not_analyzed ï¼‰æœªåˆ†æçš„ç²¾ç¡®å€¼å­—ç¬¦ä¸²å­—æ®µï¼Œ å®ƒä»¬ä¼šå°†æ•´ä¸ªæŸ¥è¯¢å­—ç¬¦ä¸²ä½œä¸ºå•ä¸ªè¯é¡¹å¯¹å¾…ã€‚<br>ä½†å¦‚æœè¦æŸ¥è¯¢ä¸€ä¸ªï¼ˆ analyzed ï¼‰å·²åˆ†æçš„å…¨æ–‡å­—æ®µï¼Œ å®ƒä»¬ä¼šå…ˆå°†æŸ¥è¯¢å­—ç¬¦ä¸²ä¼ é€’åˆ°ä¸€ä¸ªåˆé€‚çš„åˆ†æå™¨ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªä¾›æŸ¥è¯¢çš„è¯é¡¹åˆ—è¡¨ã€‚<br>ä¸€æ—¦ç»„æˆäº†è¯é¡¹åˆ—è¡¨ï¼Œè¿™ä¸ªæŸ¥è¯¢ä¼šå¯¹æ¯ä¸ªè¯é¡¹é€ä¸€æ‰§è¡Œåº•å±‚çš„æŸ¥è¯¢ï¼Œå†å°†ç»“æœåˆå¹¶ï¼Œç„¶åä¸ºæ¯ä¸ªæ–‡æ¡£ç”Ÿæˆä¸€ä¸ªæœ€ç»ˆçš„ç›¸å…³åº¦è¯„åˆ†ã€‚</p>
</li>
</ul>
<p>Elasticsearch æ‰§è¡Œä¸Šé¢è¿™ä¸ª match æŸ¥è¯¢çš„æ­¥éª¤æ˜¯ï¼š</p>
<p>1.æ£€æŸ¥å­—æ®µç±»å‹ ã€‚</p>
<p>2.åˆ†ææŸ¥è¯¢å­—ç¬¦ä¸² ã€‚</p>
<p>3.æŸ¥æ‰¾åŒ¹é…æ–‡æ¡£ ã€‚</p>
<p>4.ä¸ºæ¯ä¸ªæ–‡æ¡£è¯„åˆ† ã€‚</p>
<h3 id="å¤šè¯æŸ¥è¯¢"><a href="#å¤šè¯æŸ¥è¯¢" class="headerlink" title="å¤šè¯æŸ¥è¯¢"></a>å¤šè¯æŸ¥è¯¢</h3><p>å› ä¸º match æŸ¥è¯¢å¿…é¡»æŸ¥æ‰¾ä¸¤ä¸ªè¯ï¼ˆ [â€œbrownâ€,â€dogâ€] ï¼‰ï¼Œå®ƒåœ¨å†…éƒ¨å®é™…ä¸Šå…ˆæ‰§è¡Œä¸¤æ¬¡ term æŸ¥è¯¢ï¼Œç„¶åå°†ä¸¤æ¬¡æŸ¥è¯¢çš„ç»“æœåˆå¹¶ä½œä¸ºæœ€ç»ˆç»“æœè¾“å‡ºã€‚</p>
<p>match æŸ¥è¯¢è¿˜å¯ä»¥æ¥å— operator æ“ä½œç¬¦ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹è¯¥æ“ä½œç¬¦æ˜¯ or ã€‚æˆ‘ä»¬å¯ä»¥å°†å®ƒä¿®æ”¹æˆ and è®©æ‰€æœ‰æŒ‡å®šè¯é¡¹éƒ½å¿…é¡»åŒ¹é…ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;BROWN DOG!&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;operator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;and&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>match æŸ¥è¯¢æ”¯æŒ minimum_should_match æœ€å°åŒ¹é…å‚æ•°ï¼Œ è¿™è®©æˆ‘ä»¬å¯ä»¥æŒ‡å®šå¿…é¡»åŒ¹é…çš„è¯é¡¹æ•°ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªæ–‡æ¡£æ˜¯å¦ç›¸å…³ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶è®¾ç½®ä¸ºæŸä¸ªå…·ä½“æ•°å­—ï¼Œæ›´å¸¸ç”¨çš„åšæ³•æ˜¯å°†å…¶è®¾ç½®ä¸ºä¸€ä¸ªç™¾åˆ†æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•æ§åˆ¶ç”¨æˆ·æœç´¢æ—¶è¾“å…¥çš„å•è¯æ•°é‡ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>                <span class="string">&quot;quick brown dog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minimum_should_match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;75%&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="ç»„åˆæŸ¥è¯¢"><a href="#ç»„åˆæŸ¥è¯¢" class="headerlink" title="ç»„åˆæŸ¥è¯¢"></a>ç»„åˆæŸ¥è¯¢</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span>     <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quick&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lazy&quot;</span>  <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brown&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dog&quot;</span>   <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>æ‹·è´ä¸º CURLåœ¨ SENSE ä¸­æŸ¥çœ‹<br>ä»¥ä¸Šçš„æŸ¥è¯¢ç»“æœè¿”å› title å­—æ®µåŒ…å«è¯é¡¹ quick ä½†ä¸åŒ…å« lazy çš„ä»»æ„æ–‡æ¡£ã€‚ç›®å‰ä¸ºæ­¢ï¼Œè¿™ä¸ bool è¿‡æ»¤å™¨çš„å·¥ä½œæ–¹å¼éå¸¸ç›¸ä¼¼ã€‚</p>
<p>&#x3D;&#x3D;åŒºåˆ«å°±åœ¨äºä¸¤ä¸ª should è¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šä¸€ä¸ªæ–‡æ¡£ä¸å¿…åŒ…å« brown æˆ– dog è¿™ä¸¤ä¸ªè¯é¡¹ï¼Œä½†å¦‚æœä¸€æ—¦åŒ…å«ï¼Œæˆ‘ä»¬å°±è®¤ä¸ºå®ƒä»¬ æ›´ç›¸å…³&#x3D;&#x3D;</p>
<p>bool æŸ¥è¯¢ä¼šä¸ºæ¯ä¸ªæ–‡æ¡£è®¡ç®—ç›¸å…³åº¦è¯„åˆ† _score ï¼Œ å†å°†æ‰€æœ‰åŒ¹é…çš„ must å’Œ should è¯­å¥çš„åˆ†æ•° _score æ±‚å’Œï¼Œæœ€åé™¤ä»¥ must å’Œ should è¯­å¥çš„æ€»æ•°ã€‚</p>
<p>must_not è¯­å¥ä¸ä¼šå½±å“è¯„åˆ†ï¼› å®ƒçš„ä½œç”¨åªæ˜¯å°†ä¸ç›¸å…³çš„æ–‡æ¡£æ’é™¤ã€‚<br>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ should è¯­å¥æ˜¯å¿…é¡»åŒ¹é…çš„ï¼Œåªæœ‰ä¸€ä¸ªä¾‹å¤–ï¼šé‚£å°±æ˜¯å½“æ²¡æœ‰ must è¯­å¥çš„æ—¶å€™ï¼Œè‡³å°‘æœ‰ä¸€ä¸ª should è¯­å¥å¿…é¡»åŒ¹é…ã€‚</p>
<h3 id="å¦‚ä½•ä½¿ç”¨å¸ƒå°”åŒ¹é…"><a href="#å¦‚ä½•ä½¿ç”¨å¸ƒå°”åŒ¹é…" class="headerlink" title="å¦‚ä½•ä½¿ç”¨å¸ƒå°”åŒ¹é…"></a>å¦‚ä½•ä½¿ç”¨å¸ƒå°”åŒ¹é…</h3><p>ä»¥ä¸‹ä¸¤ä¸ªæŸ¥è¯¢æ˜¯ç­‰ä»·çš„ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brown fox&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brown&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fox&quot;</span>   <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="æŸ¥è¯¢è¯­å¥æå‡æƒé‡"><a href="#æŸ¥è¯¢è¯­å¥æå‡æƒé‡" class="headerlink" title="æŸ¥è¯¢è¯­å¥æå‡æƒé‡"></a>æŸ¥è¯¢è¯­å¥æå‡æƒé‡</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®š boost æ¥æ§åˆ¶ä»»ä½•æŸ¥è¯¢è¯­å¥çš„ç›¸å¯¹çš„æƒé‡ï¼Œ boost çš„é»˜è®¤å€¼ä¸º 1 ï¼Œå¤§äº 1 ä¼šæå‡ä¸€ä¸ªè¯­å¥çš„ç›¸å¯¹æƒé‡ã€‚æ‰€ä»¥ä¸‹é¢é‡å†™ä¹‹å‰çš„æŸ¥è¯¢ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;full text search&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;operator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;and&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Elasticsearch&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lucene&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="æ§åˆ¶åˆ†æ"><a href="#æ§åˆ¶åˆ†æ" class="headerlink" title="æ§åˆ¶åˆ†æ"></a>æ§åˆ¶åˆ†æ</h3><p>åˆ†æå™¨å¯ä»¥ä»ä¸‰ä¸ªå±‚é¢è¿›è¡Œå®šä¹‰ï¼šæŒ‰å­—æ®µï¼ˆper-fieldï¼‰ã€æŒ‰ç´¢å¼•ï¼ˆper-indexï¼‰æˆ–å…¨å±€ç¼ºçœï¼ˆglobal defaultï¼‰ã€‚Elasticsearch ä¼šæŒ‰ç…§ä»¥ä¸‹é¡ºåºä¾æ¬¡å¤„ç†ï¼Œç›´åˆ°å®ƒæ‰¾åˆ°èƒ½å¤Ÿä½¿ç”¨çš„åˆ†æå™¨ã€‚</p>
<ul>
<li><p>ç´¢å¼•æ—¶çš„é¡ºåºå¦‚ä¸‹ï¼š<br>å­—æ®µæ˜ å°„é‡Œå®šä¹‰çš„ analyzer ï¼Œå¦åˆ™<br>ç´¢å¼•è®¾ç½®ä¸­åä¸º default çš„åˆ†æå™¨ï¼Œé»˜è®¤ä¸º<br>standard æ ‡å‡†åˆ†æå™¨</p>
</li>
<li><p>åœ¨æœç´¢æ—¶ï¼Œé¡ºåºæœ‰äº›è®¸ä¸åŒï¼š<br>æŸ¥è¯¢è‡ªå·±å®šä¹‰çš„ analyzer ï¼Œå¦åˆ™<br>å­—æ®µæ˜ å°„é‡Œå®šä¹‰çš„ analyzer ï¼Œå¦åˆ™<br>ç´¢å¼•è®¾ç½®ä¸­åä¸º default çš„åˆ†æå™¨ï¼Œé»˜è®¤ä¸º<br>standard æ ‡å‡†åˆ†æå™¨</p>
</li>
</ul>
<p>æŒä¸€ä¸ªå¯é€‰çš„ search_analyzer æ˜ å°„ï¼Œå®ƒä»…ä¼šåº”ç”¨äºæœç´¢æ—¶ï¼ˆ analyzer è¿˜ç”¨äºç´¢å¼•æ—¶ï¼‰ã€‚è¿˜æœ‰ä¸€ä¸ªç­‰ä»·çš„ default_search æ˜ å°„ï¼Œç”¨ä»¥æŒ‡å®šç´¢å¼•å±‚çš„é»˜è®¤é…ç½®ã€‚</p>
<p>å¦‚æœè€ƒè™‘åˆ°è¿™äº›é¢å¤–å‚æ•°ï¼Œä¸€ä¸ªæœç´¢æ—¶çš„ å®Œæ•´ é¡ºåºä¼šæ˜¯ä¸‹é¢è¿™æ ·ï¼š</p>
<p>æŸ¥è¯¢è‡ªå·±å®šä¹‰çš„ analyzer ï¼Œå¦åˆ™<br>å­—æ®µæ˜ å°„é‡Œå®šä¹‰çš„ search_analyzer ï¼Œå¦åˆ™<br>å­—æ®µæ˜ å°„é‡Œå®šä¹‰çš„ analyzer ï¼Œå¦åˆ™<br>ç´¢å¼•è®¾ç½®ä¸­åä¸º default_search çš„åˆ†æå™¨ï¼Œé»˜è®¤ä¸º<br>ç´¢å¼•è®¾ç½®ä¸­åä¸º default çš„åˆ†æå™¨ï¼Œé»˜è®¤ä¸º<br>standard æ ‡å‡†åˆ†æå™¨</p>
<p>&#x3D;&#x3D;æœ€ç®€å•çš„é€”å¾„å°±æ˜¯åœ¨åˆ›å»ºç´¢å¼•æˆ–è€…å¢åŠ ç±»å‹æ˜ å°„æ—¶ï¼Œä¸ºæ¯ä¸ªå…¨æ–‡å­—æ®µè®¾ç½®åˆ†æå™¨ã€‚è¿™ç§æ–¹å¼å°½ç®¡æœ‰ç‚¹éº»çƒ¦ï¼Œä½†æ˜¯å®ƒè®©æˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°æ¯ä¸ªå­—æ®µæ¯ä¸ªåˆ†æå™¨æ˜¯å¦‚ä½•è®¾ç½®çš„ã€‚å¯ä»¥åœ¨ç´¢å¼•çº§åˆ«è®¾ç½®ä¸­ï¼Œä¸ºç»å¤§éƒ¨åˆ†çš„å­—æ®µè®¾ç½®ä½ æƒ³æŒ‡å®šçš„ default é»˜è®¤åˆ†æå™¨ã€‚ç„¶ååœ¨å­—æ®µçº§åˆ«è®¾ç½®ä¸­ï¼Œå¯¹æŸä¸€ä¸¤ä¸ªå­—æ®µé…ç½®éœ€è¦æŒ‡å®šçš„åˆ†æå™¨ã€‚&#x3D;&#x3D;</p>
<h3 id="è¢«ç ´åçš„ç›¸å…³åº¦ï¼"><a href="#è¢«ç ´åçš„ç›¸å…³åº¦ï¼" class="headerlink" title="è¢«ç ´åçš„ç›¸å…³åº¦ï¼"></a>è¢«ç ´åçš„ç›¸å…³åº¦ï¼</h3><p>ç”±äºæ€§èƒ½åŸå› ï¼Œ Elasticsearch ä¸ä¼šè®¡ç®—ç´¢å¼•å†…æ‰€æœ‰æ–‡æ¡£çš„ IDF ã€‚ ç›¸åï¼Œæ¯ä¸ªåˆ†ç‰‡ä¼šæ ¹æ® è¯¥åˆ†ç‰‡ å†…çš„æ‰€æœ‰æ–‡æ¡£è®¡ç®—ä¸€ä¸ªæœ¬åœ° IDF ã€‚</p>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œæœ¬åœ°å’Œå…¨å±€çš„ IDF çš„å·®å¼‚ä¼šéšç€ç´¢å¼•é‡Œæ–‡æ¡£æ•°çš„å¢å¤šæ¸æ¸æ¶ˆå¤±ï¼Œåœ¨çœŸå®ä¸–ç•Œçš„æ•°æ®é‡ä¸‹ï¼Œå±€éƒ¨çš„ IDF ä¼šè¢«è¿…é€Ÿå‡åŒ–ï¼Œæ‰€ä»¥ä¸Šè¿°é—®é¢˜å¹¶ä¸æ˜¯ç›¸å…³åº¦è¢«ç ´åæ‰€å¯¼è‡´çš„ï¼Œè€Œæ˜¯ç”±äºæ•°æ®å¤ªå°‘ã€‚</p>
<p>åœ¨æœç´¢è¯·æ±‚åæ·»åŠ  ?search_type&#x3D;dfs_query_then_fetch ï¼Œ dfs æ˜¯æŒ‡ åˆ†å¸ƒå¼é¢‘ç‡æœç´¢ï¼ˆDistributed Frequency Searchï¼‰ ï¼Œ å®ƒå‘Šè¯‰ Elasticsearch ï¼Œå…ˆåˆ†åˆ«è·å¾—æ¯ä¸ªåˆ†ç‰‡æœ¬åœ°çš„ IDF ï¼Œç„¶åæ ¹æ®ç»“æœå†è®¡ç®—æ•´ä¸ªç´¢å¼•çš„å…¨å±€ IDF ã€‚<br><strong>ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šä½¿ç”¨ dfs_query_then_fetch</strong> ã€‚å®Œå…¨æ²¡æœ‰å¿…è¦ã€‚åªè¦æœ‰è¶³å¤Ÿçš„æ•°æ®å°±èƒ½ä¿è¯è¯é¢‘æ˜¯å‡åŒ€åˆ†å¸ƒçš„ã€‚æ²¡æœ‰ç†ç”±ç»™æ¯ä¸ªæŸ¥è¯¢é¢å¤–åŠ ä¸Š DFS è¿™æ­¥ã€‚</p>
<h2 id="å¤šå­—æ®µæœç´¢"><a href="#å¤šå­—æ®µæœç´¢" class="headerlink" title="å¤šå­—æ®µæœç´¢"></a>å¤šå­—æ®µæœç´¢</h2><h3 id="å¤šå­—ç¬¦ä¸²æŸ¥è¯¢"><a href="#å¤šå­—ç¬¦ä¸²æŸ¥è¯¢" class="headerlink" title="å¤šå­—ç¬¦ä¸²æŸ¥è¯¢"></a>å¤šå­—ç¬¦ä¸²æŸ¥è¯¢</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;War and Peace&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Leo Tolstoy&quot;</span>   <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span>  <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;translator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Constance Garnett&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;translator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Louise Maude&quot;</span>      <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ç­”æ¡ˆåœ¨äºè¯„åˆ†çš„è®¡ç®—æ–¹å¼ã€‚ bool æŸ¥è¯¢è¿è¡Œæ¯ä¸ª match æŸ¥è¯¢ï¼Œå†æŠŠè¯„åˆ†åŠ åœ¨ä¸€èµ·ï¼Œç„¶åå°†ç»“æœä¸æ‰€æœ‰åŒ¹é…çš„è¯­å¥æ•°é‡ç›¸ä¹˜ï¼Œæœ€åé™¤ä»¥æ‰€æœ‰çš„è¯­å¥æ•°é‡ã€‚å¤„äºåŒä¸€å±‚çš„æ¯æ¡è¯­å¥å…·æœ‰ç›¸åŒçš„æƒé‡ã€‚åœ¨å‰é¢è¿™ä¸ªä¾‹å­ä¸­ï¼ŒåŒ…å« translator è¯­å¥çš„ bool æŸ¥è¯¢ï¼Œåªå æ€»è¯„åˆ†çš„ä¸‰åˆ†ä¹‹ä¸€ã€‚å¦‚æœå°† translator è¯­å¥ä¸ title å’Œ author ä¸¤æ¡è¯­å¥æ”¾å…¥åŒä¸€å±‚ï¼Œé‚£ä¹ˆ title å’Œ author è¯­å¥åªè´¡çŒ®å››åˆ†ä¹‹ä¸€è¯„åˆ†ã€‚</p>
<h3 id="å•å­—ç¬¦ä¸²æŸ¥è¯¢"><a href="#å•å­—ç¬¦ä¸²æŸ¥è¯¢" class="headerlink" title="å•å­—ç¬¦ä¸²æŸ¥è¯¢"></a>å•å­—ç¬¦ä¸²æŸ¥è¯¢</h3><h3 id="æœ€ä½³å­—æ®µ"><a href="#æœ€ä½³å­—æ®µ" class="headerlink" title="æœ€ä½³å­—æ®µ"></a>æœ€ä½³å­—æ®µ</h3><p><strong>dis_max æŸ¥è¯¢</strong><br>ä¸ä½¿ç”¨ bool æŸ¥è¯¢ï¼Œå¯ä»¥ä½¿ç”¨ dis_max å³åˆ†ç¦» æœ€å¤§åŒ–æŸ¥è¯¢ï¼ˆDisjunction Max Queryï¼‰ ã€‚åˆ†ç¦»ï¼ˆDisjunctionï¼‰çš„æ„æ€æ˜¯ æˆ–ï¼ˆorï¼‰ ï¼Œè¿™ä¸å¯ä»¥æŠŠç»“åˆï¼ˆconjunctionï¼‰ç†è§£æˆ ä¸ï¼ˆandï¼‰ ç›¸å¯¹åº”ã€‚åˆ†ç¦»æœ€å¤§åŒ–æŸ¥è¯¢ï¼ˆDisjunction Max Queryï¼‰æŒ‡çš„æ˜¯ï¼š å°†ä»»ä½•ä¸ä»»ä¸€æŸ¥è¯¢åŒ¹é…çš„æ–‡æ¡£ä½œä¸ºç»“æœè¿”å›ï¼Œä½†&#x3D;&#x3D;åªå°†æœ€ä½³åŒ¹é…çš„è¯„åˆ†ä½œä¸ºæŸ¥è¯¢çš„è¯„åˆ†ç»“æœè¿”å›&#x3D;&#x3D; ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;dis_max&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;queries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Brown fox&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;Brown fox&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="æœ€ä½³å­—æ®µæŸ¥è¯¢è°ƒä¼˜"><a href="#æœ€ä½³å­—æ®µæŸ¥è¯¢è°ƒä¼˜" class="headerlink" title="æœ€ä½³å­—æ®µæŸ¥è¯¢è°ƒä¼˜"></a>æœ€ä½³å­—æ®µæŸ¥è¯¢è°ƒä¼˜</h3><p><strong>tie_breaker å‚æ•°</strong><br>å¯ä»¥é€šè¿‡æŒ‡å®š tie_breaker è¿™ä¸ªå‚æ•°å°†å…¶ä»–åŒ¹é…è¯­å¥çš„è¯„åˆ†ä¹Ÿè€ƒè™‘å…¶ä¸­ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;dis_max&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;queries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Quick pets&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;Quick pets&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tie_breaker&quot;</span><span class="punctuation">:</span> <span class="number">0.3</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>tie_breaker å‚æ•°æä¾›äº†ä¸€ç§ dis_max å’Œ bool ä¹‹é—´çš„æŠ˜ä¸­é€‰æ‹©ï¼Œå®ƒçš„è¯„åˆ†æ–¹å¼å¦‚ä¸‹ï¼š</p>
<ul>
<li>1.è·å¾—æœ€ä½³åŒ¹é…è¯­å¥çš„è¯„åˆ† _score ã€‚</li>
<li>2.å°†å…¶ä»–åŒ¹é…è¯­å¥çš„è¯„åˆ†ç»“æœä¸ tie_breaker ç›¸ä¹˜ã€‚</li>
<li>3.å¯¹ä»¥ä¸Šè¯„åˆ†æ±‚å’Œå¹¶è§„èŒƒåŒ–ã€‚</li>
</ul>
<p>æœ‰äº† tie_breaker ï¼Œä¼šè€ƒè™‘æ‰€æœ‰åŒ¹é…è¯­å¥ï¼Œä½†æœ€ä½³åŒ¹é…è¯­å¥ä¾ç„¶å æœ€ç»ˆç»“æœé‡Œçš„å¾ˆå¤§ä¸€éƒ¨åˆ†ã€‚</p>
<p>æ³¨æ„</p>
<blockquote>
<p>tie_breaker å¯ä»¥æ˜¯ 0 åˆ° 1 ä¹‹é—´çš„æµ®ç‚¹æ•°ï¼Œå…¶ä¸­ 0 ä»£è¡¨ä½¿ç”¨ dis_max æœ€ä½³åŒ¹é…è¯­å¥çš„æ™®é€šé€»è¾‘ï¼Œ 1 è¡¨ç¤ºæ‰€æœ‰åŒ¹é…è¯­å¥åŒç­‰é‡è¦ã€‚æœ€ä½³çš„ç²¾ç¡®å€¼éœ€è¦æ ¹æ®æ•°æ®ä¸æŸ¥è¯¢è°ƒè¯•å¾—å‡ºï¼Œä½†æ˜¯åˆç†å€¼åº”è¯¥ä¸é›¶æ¥è¿‘ï¼ˆå¤„äº 0.1 - 0.4 ä¹‹é—´ï¼‰ï¼Œè¿™æ ·å°±ä¸ä¼šé¢ è¦† dis_max æœ€ä½³åŒ¹é…æ€§è´¨çš„æ ¹æœ¬ã€‚</p>
</blockquote>
<h3 id="multi-match-æŸ¥è¯¢"><a href="#multi-match-æŸ¥è¯¢" class="headerlink" title="multi_match æŸ¥è¯¢"></a>multi_match æŸ¥è¯¢</h3><p>multi_match æŸ¥è¯¢ä¸ºèƒ½åœ¨å¤šä¸ªå­—æ®µä¸Šåå¤æ‰§è¡Œç›¸åŒæŸ¥è¯¢æä¾›äº†ä¸€ç§ä¾¿æ·æ–¹å¼ã€‚</p>
<blockquote>
<p>æ³¨æ„<br>multi_match å¤šåŒ¹é…æŸ¥è¯¢çš„ç±»å‹æœ‰å¤šç§ï¼Œå…¶ä¸­çš„ä¸‰ç§æ°å·§ä¸ äº†è§£æˆ‘ä»¬çš„æ•°æ® ä¸­ä»‹ç»çš„ä¸‰ä¸ªåœºæ™¯å¯¹åº”ï¼Œå³ï¼š best_fields ã€ most_fields å’Œ cross_fields ï¼ˆæœ€ä½³å­—æ®µã€å¤šæ•°å­—æ®µã€è·¨å­—æ®µï¼‰ã€‚</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>                <span class="string">&quot;Quick brown fox&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>                 <span class="string">&quot;best_fields&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span>               <span class="punctuation">[</span> <span class="string">&quot;title&quot;</span><span class="punctuation">,</span> <span class="string">&quot;body&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tie_breaker&quot;</span><span class="punctuation">:</span>          <span class="number">0.3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minimum_should_match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30%&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="æŸ¥è¯¢å­—æ®µåç§°çš„æ¨¡ç³ŠåŒ¹é…"><a href="#æŸ¥è¯¢å­—æ®µåç§°çš„æ¨¡ç³ŠåŒ¹é…" class="headerlink" title="æŸ¥è¯¢å­—æ®µåç§°çš„æ¨¡ç³ŠåŒ¹é…"></a>æŸ¥è¯¢å­—æ®µåç§°çš„æ¨¡ç³ŠåŒ¹é…</h4><p>å­—æ®µåç§°å¯ä»¥ç”¨æ¨¡ç³ŠåŒ¹é…çš„æ–¹å¼ç»™å‡ºï¼šä»»ä½•ä¸æ¨¡ç³Šæ¨¡å¼æ­£åˆ™åŒ¹é…çš„å­—æ®µéƒ½ä¼šè¢«åŒ…æ‹¬åœ¨æœç´¢æ¡ä»¶ä¸­ï¼Œ ä¾‹å¦‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼åŒæ—¶åŒ¹é… book_title ã€ chapter_title å’Œ section_title ï¼ˆä¹¦åã€ç« åã€èŠ‚åï¼‰è¿™ä¸‰ä¸ªå­—æ®µï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;Quick brown fox&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*_title&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="æå‡å•ä¸ªå­—æ®µçš„æƒé‡ç¼–è¾‘"><a href="#æå‡å•ä¸ªå­—æ®µçš„æƒé‡ç¼–è¾‘" class="headerlink" title="æå‡å•ä¸ªå­—æ®µçš„æƒé‡ç¼–è¾‘"></a>æå‡å•ä¸ªå­—æ®µçš„æƒé‡ç¼–è¾‘</h4><p>å¯ä»¥ä½¿ç”¨ ^ å­—ç¬¦è¯­æ³•ä¸ºå•ä¸ªå­—æ®µæå‡æƒé‡ï¼Œåœ¨å­—æ®µåç§°çš„æœ«å°¾æ·»åŠ  ^boost ï¼Œ å…¶ä¸­ boost æ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;Quick brown fox&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;*_title&quot;</span><span class="punctuation">,</span> <span class="string">&quot;chapter_title^2&quot;</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>chapter_title è¿™ä¸ªå­—æ®µçš„ boost å€¼ä¸º 2 ï¼Œè€Œå…¶ä»–ä¸¤ä¸ªå­—æ®µ book_title å’Œ section_title å­—æ®µçš„é»˜è®¤ boost å€¼ä¸º 1 ã€‚</p>
<h3 id="å¤šæ•°å­—æ®µ"><a href="#å¤šæ•°å­—æ®µ" class="headerlink" title="å¤šæ•°å­—æ®µ"></a>å¤šæ•°å­—æ®µ</h3><p>å¤šå­—æ®µæ˜ å°„ç¼–è¾‘<br>é¦–å…ˆè¦åšçš„äº‹æƒ…å°±æ˜¯å¯¹æˆ‘ä»¬çš„å­—æ®µç´¢å¼•ä¸¤æ¬¡ï¼š ä¸€æ¬¡ä½¿ç”¨è¯å¹²æ¨¡å¼ä»¥åŠä¸€æ¬¡éè¯å¹²æ¨¡å¼ã€‚ä¸ºäº†åšåˆ°è¿™ç‚¹ï¼Œé‡‡ç”¨ multifields æ¥å®ç°ï¼Œå·²ç»åœ¨ multifields æœ‰æ‰€ä»‹ç»ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">DELETE /my_index</span><br><span class="line"></span><br><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">1</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>     <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;english&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;std&quot;</span><span class="punctuation">:</span>   <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>     <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="è·¨å­—æ®µå®ä½“æœç´¢"><a href="#è·¨å­—æ®µå®ä½“æœç´¢" class="headerlink" title="è·¨å­—æ®µå®ä½“æœç´¢"></a>è·¨å­—æ®µå®ä½“æœç´¢</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>       <span class="string">&quot;Poland Street W1V&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>        <span class="string">&quot;most_fields&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span>      <span class="punctuation">[</span> <span class="string">&quot;street&quot;</span><span class="punctuation">,</span> <span class="string">&quot;city&quot;</span><span class="punctuation">,</span> <span class="string">&quot;country&quot;</span><span class="punctuation">,</span> <span class="string">&quot;postcode&quot;</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>most_fields æ–¹å¼çš„é—®é¢˜<br>ç”¨ most_fields è¿™ç§æ–¹å¼æœç´¢ä¹Ÿå­˜åœ¨æŸäº›é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å¹¶ä¸ä¼šé©¬ä¸Šæ˜¾ç°ï¼š</p>
<ul>
<li>å®ƒæ˜¯ä¸ºå¤šæ•°å­—æ®µåŒ¹é… ä»»æ„ è¯è®¾è®¡çš„ï¼Œè€Œä¸æ˜¯åœ¨ æ‰€æœ‰å­—æ®µ ä¸­æ‰¾åˆ°æœ€åŒ¹é…çš„ã€‚</li>
<li>å®ƒä¸èƒ½ä½¿ç”¨ operator æˆ– minimum_should_match å‚æ•°æ¥é™ä½æ¬¡ç›¸å…³ç»“æœé€ æˆçš„é•¿å°¾æ•ˆåº”ã€‚</li>
<li>è¯é¢‘å¯¹äºæ¯ä¸ªå­—æ®µæ˜¯ä¸ä¸€æ ·çš„ï¼Œè€Œä¸”å®ƒä»¬ä¹‹é—´çš„ç›¸äº’å½±å“ä¼šå¯¼è‡´ä¸å¥½çš„æ’åºç»“æœã€‚</li>
</ul>
<h3 id="å­—æ®µä¸­å¿ƒå¼æŸ¥è¯¢"><a href="#å­—æ®µä¸­å¿ƒå¼æŸ¥è¯¢" class="headerlink" title="å­—æ®µä¸­å¿ƒå¼æŸ¥è¯¢"></a>å­—æ®µä¸­å¿ƒå¼æŸ¥è¯¢</h3><p><strong>è§£å†³æ–¹æ¡ˆ</strong><br>å­˜åœ¨è¿™äº›é—®é¢˜ä»…ä»…æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨å¤„ç†ç€å¤šä¸ªå­—æ®µï¼Œå¦‚æœå°†æ‰€æœ‰è¿™äº›å­—æ®µç»„åˆæˆå•ä¸ªå­—æ®µï¼Œé—®é¢˜å°±ä¼šæ¶ˆå¤±ã€‚å¯ä»¥ä¸º person æ–‡æ¡£æ·»åŠ  full_name å­—æ®µæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;first_name&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;Peter&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;last_name&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;Smith&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;full_name&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;Peter Smith&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å½“æŸ¥è¯¢ full_name å­—æ®µæ—¶ï¼š</p>
<p>å…·æœ‰æ›´å¤šåŒ¹é…è¯çš„æ–‡æ¡£ä¼šæ¯”åªæœ‰ä¸€ä¸ªé‡å¤åŒ¹é…è¯çš„æ–‡æ¡£æ›´é‡è¦ã€‚<br>minimum_should_match å’Œ operator å‚æ•°ä¼šåƒæœŸæœ›é‚£æ ·å·¥ä½œã€‚<br>å§“å’Œåçš„é€†å‘æ–‡æ¡£é¢‘ç‡è¢«åˆå¹¶ï¼Œæ‰€ä»¥ Smith åˆ°åº•æ˜¯ä½œä¸ºå§“è¿˜æ˜¯ä½œä¸ºåå‡ºç°ï¼Œéƒ½ä¼šå˜å¾—æ— å…³ç´§è¦ã€‚<br>è¿™ä¹ˆåšå½“ç„¶æ˜¯å¯è¡Œçš„ï¼Œä½†æˆ‘ä»¬å¹¶ä¸å¤ªå–œæ¬¢å­˜å‚¨å†—ä½™æ•°æ®ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ Elasticsearch å¯ä»¥æä¾›ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆâ€”â€”ä¸€ä¸ªåœ¨ç´¢å¼•æ—¶ï¼Œè€Œå¦ä¸€ä¸ªæ˜¯åœ¨æœç´¢æ—¶â€”â€”éšåä¼šè®¨è®ºå®ƒä»¬ã€‚</p>
<h3 id="è‡ªå®šä¹‰-all-å­—æ®µ"><a href="#è‡ªå®šä¹‰-all-å­—æ®µ" class="headerlink" title="è‡ªå®šä¹‰ _all å­—æ®µ"></a>è‡ªå®šä¹‰ _all å­—æ®µ</h3><p>Elasticsearch åœ¨å­—æ®µæ˜ å°„ä¸­ä¸ºæˆ‘ä»¬æä¾› copy_to å‚æ•°æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;person&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;first_name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>     <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;full_name&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;last_name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>     <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;full_name&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;full_name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>     <span class="string">&quot;string&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>first_name å’Œ last_name å­—æ®µä¸­çš„å€¼ä¼šè¢«å¤åˆ¶åˆ° full_name å­—æ®µã€‚</p>
<h3 id="cross-fields-è·¨å­—æ®µæŸ¥è¯¢"><a href="#cross-fields-è·¨å­—æ®µæŸ¥è¯¢" class="headerlink" title="cross-fields è·¨å­—æ®µæŸ¥è¯¢"></a>cross-fields è·¨å­—æ®µæŸ¥è¯¢</h3><p>cross_fields ä½¿ç”¨è¯ä¸­å¿ƒå¼ï¼ˆterm-centricï¼‰çš„æŸ¥è¯¢æ–¹å¼ï¼Œè¿™ä¸ best_fields å’Œ most_fields ä½¿ç”¨å­—æ®µä¸­å¿ƒå¼ï¼ˆfield-centricï¼‰çš„æŸ¥è¯¢æ–¹å¼éå¸¸ä¸åŒï¼Œå®ƒå°†æ‰€æœ‰å­—æ®µå½“æˆä¸€ä¸ªå¤§å­—æ®µï¼Œå¹¶åœ¨ æ¯ä¸ªå­—æ®µ ä¸­æŸ¥æ‰¾ æ¯ä¸ªè¯ ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_validate/query?explain</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>       <span class="string">&quot;peter smith&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>        <span class="string">&quot;cross_fields&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;operator&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;and&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span>      <span class="punctuation">[</span> <span class="string">&quot;first_name&quot;</span><span class="punctuation">,</span> <span class="string">&quot;last_name&quot;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ç”¨ cross_fields è¯ä¸­å¿ƒå¼åŒ¹é…ã€‚</p>
<p>å®ƒé€šè¿‡ æ··åˆ ä¸åŒå­—æ®µé€†å‘ç´¢å¼•æ–‡æ¡£é¢‘ç‡çš„æ–¹å¼è§£å†³äº†è¯é¢‘çš„é—®é¢˜ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+blended(&quot;peter&quot;, fields: [first_name, last_name])</span><br><span class="line">+blended(&quot;smith&quot;, fields: [first_name, last_name])</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;è‡ªå®šä¹‰å•å­—æ®µæŸ¥è¯¢æ˜¯å¦èƒ½å¤Ÿä¼˜äºå¤šå­—æ®µæŸ¥è¯¢ï¼Œå–å†³äºåœ¨å¤šå­—æ®µæŸ¥è¯¢ä¸å•å­—æ®µè‡ªå®šä¹‰ _all ä¹‹é—´ä»£ä»·çš„æƒè¡¡ï¼Œå³å“ªç§è§£å†³æ–¹æ¡ˆä¼šå¸¦æ¥æ›´å¤§çš„æ€§èƒ½ä¼˜åŒ–å°±é€‰æ‹©å“ªä¸€ç§ã€‚&#x3D;&#x3D;</p>
<h3 id="Exact-Value-ç²¾ç¡®å€¼å­—æ®µ"><a href="#Exact-Value-ç²¾ç¡®å€¼å­—æ®µ" class="headerlink" title="Exact-Value ç²¾ç¡®å€¼å­—æ®µ"></a>Exact-Value ç²¾ç¡®å€¼å­—æ®µ</h3><p>åœ¨ multi_match æŸ¥è¯¢ä¸­é¿å…ä½¿ç”¨ not_analyzed å­—æ®µã€‚</p>
<h2 id="è¿‘ä¼¼åŒ¹é…"><a href="#è¿‘ä¼¼åŒ¹é…" class="headerlink" title="è¿‘ä¼¼åŒ¹é…"></a>è¿‘ä¼¼åŒ¹é…</h2><h3 id="çŸ­è¯­åŒ¹é…"><a href="#çŸ­è¯­åŒ¹é…" class="headerlink" title="çŸ­è¯­åŒ¹é…"></a>çŸ­è¯­åŒ¹é…</h3><p><strong>match_phrase æŸ¥è¯¢é¦–å…ˆå°†æŸ¥è¯¢å­—ç¬¦ä¸²è§£ææˆä¸€ä¸ªè¯é¡¹åˆ—è¡¨ï¼Œç„¶åå¯¹è¿™äº›è¯é¡¹è¿›è¡Œæœç´¢ï¼Œä½†åªä¿ç•™é‚£äº›åŒ…å« å…¨éƒ¨ æœç´¢è¯é¡¹ï¼Œä¸” ä½ç½® ä¸æœç´¢è¯é¡¹ç›¸åŒçš„æ–‡æ¡£ã€‚</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match_phrase&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quick brown fox&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="æ··åˆèµ·æ¥"><a href="#æ··åˆèµ·æ¥" class="headerlink" title="æ··åˆèµ·æ¥"></a>æ··åˆèµ·æ¥</h3><p>slop å‚æ•°å‘Šè¯‰ match_phrase æŸ¥è¯¢è¯æ¡ç›¸éš”å¤šè¿œæ—¶ä»ç„¶èƒ½å°†æ–‡æ¡£è§†ä¸ºåŒ¹é… ã€‚ ç›¸éš”å¤šè¿œçš„æ„æ€æ˜¯ä¸ºäº†è®©æŸ¥è¯¢å’Œæ–‡æ¡£åŒ¹é…ä½ éœ€è¦ç§»åŠ¨è¯æ¡å¤šå°‘æ¬¡ï¼Ÿ</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match_phrase&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quick fox&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;slop&quot;</span><span class="punctuation">:</span>  <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†ä½¿æŸ¥è¯¢ <code>fox quick</code> åŒ¹é…æˆ‘ä»¬çš„æ–‡æ¡£ï¼Œ æˆ‘ä»¬éœ€è¦ <code>slop</code> çš„å€¼ä¸º <code>3</code>:</p>
<pre><code>            Pos 1         Pos 2         Pos 3
-----------------------------------------------
Doc:        quick         brown         fox
-----------------------------------------------
Query:      fox           quick
Slop 1:     fox|quick  â†µ  &lt;1&gt;
Slop 2:     quick      â†³  fox
Slop 3:     quick                 â†³     fox
</code></pre>
<p>&lt;1&gt; æ³¨æ„ <code>fox</code> å’Œ <code>quick</code> åœ¨è¿™æ­¥ä¸­å æ®åŒæ ·çš„ä½ç½®ã€‚ å› æ­¤å°† <code>fox quick</code> è½¬æ¢é¡ºåºæˆ <code>quick fox</code> éœ€è¦ä¸¤æ­¥ï¼Œ æˆ–è€…å€¼ä¸º <code>2</code> çš„ <code>slop</code> ã€‚</p>
<p>PS:æ˜¯å°†æŸ¥è¯¢è¯è¿›è¡Œç§»åŠ¨ï¼Œä¸æ˜¯ç§»åŠ¨æ–‡æ¡£ä¸­çš„è¯ã€‚</p>
<h3 id="å¤šå€¼å­—æ®µ"><a href="#å¤šå€¼å­—æ®µ" class="headerlink" title="å¤šå€¼å­—æ®µ"></a>å¤šå€¼å­—æ®µ</h3><p>æ•°ç»„ç›¸å…³ï¼Œç•¥ã€‚</p>
<h3 id="è¶Šè¿‘è¶Šå¥½"><a href="#è¶Šè¿‘è¶Šå¥½" class="headerlink" title="è¶Šè¿‘è¶Šå¥½"></a>è¶Šè¿‘è¶Šå¥½</h3><p>é€šè¿‡è®¾ç½®ä¸€ä¸ªåƒ 50 æˆ–è€… 100 è¿™æ ·çš„é«˜ slop å€¼, ä½ èƒ½å¤Ÿæ’é™¤å•è¯è·ç¦»å¤ªè¿œçš„æ–‡æ¡£ï¼Œ ä½†æ˜¯ä¹Ÿç»™äºˆäº†é‚£äº›å•è¯ä¸´è¿‘çš„çš„æ–‡æ¡£æ›´é«˜çš„åˆ†æ•°ã€‚</p>
<h3 id="ä½¿ç”¨é‚»è¿‘åº¦æé«˜ç›¸å…³åº¦"><a href="#ä½¿ç”¨é‚»è¿‘åº¦æé«˜ç›¸å…³åº¦" class="headerlink" title="ä½¿ç”¨é‚»è¿‘åº¦æé«˜ç›¸å…³åº¦"></a>ä½¿ç”¨é‚»è¿‘åº¦æé«˜ç›¸å…³åº¦</h3><p>ç•¥</p>
<h3 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h3><p><strong>çŸ­è¯­æŸ¥è¯¢å’Œé‚»è¿‘æŸ¥è¯¢éƒ½æ¯”ç®€å•çš„ query æŸ¥è¯¢ä»£ä»·æ›´é«˜</strong> ã€‚ ä¸€ä¸ª match æŸ¥è¯¢ä»…ä»…æ˜¯çœ‹è¯æ¡æ˜¯å¦å­˜åœ¨äºå€’æ’ç´¢å¼•ä¸­ï¼Œè€Œä¸€ä¸ª match_phrase æŸ¥è¯¢æ˜¯å¿…é¡»è®¡ç®—å¹¶æ¯”è¾ƒå¤šä¸ªå¯èƒ½é‡å¤è¯é¡¹çš„ä½ç½®ã€‚</p>
<p>Lucene nightly benchmarks è¡¨æ˜ä¸€ä¸ªç®€å•çš„ term æŸ¥è¯¢æ¯”ä¸€ä¸ªçŸ­è¯­æŸ¥è¯¢å¤§çº¦å¿« 10 å€ï¼Œæ¯”é‚»è¿‘æŸ¥è¯¢(æœ‰ slop çš„çŸ­è¯­ æŸ¥è¯¢)å¤§çº¦å¿« 20 å€ã€‚å½“ç„¶ï¼Œè¿™ä¸ªä»£ä»·æŒ‡çš„æ˜¯åœ¨æœç´¢æ—¶è€Œä¸æ˜¯ç´¢å¼•æ—¶ã€‚</p>
<p><strong>é‡æ–°è¯„åˆ†</strong>é˜¶æ®µæ”¯æŒä¸€ä¸ªä»£ä»·æ›´é«˜çš„è¯„åˆ†ç®—æ³•â€“æ¯”å¦‚ phrase æŸ¥è¯¢â€“åªæ˜¯ä¸ºäº†ä»æ¯ä¸ªåˆ†ç‰‡ä¸­è·å¾—å‰ K ä¸ªç»“æœã€‚ ç„¶åä¼šæ ¹æ®å®ƒä»¬çš„æœ€æ–°è¯„åˆ† é‡æ–°æ’åºã€‚</p>
<p>è¯¥è¯·æ±‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>                <span class="string">&quot;quick brown fox&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;minimum_should_match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30%&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rescore&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;window_size&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;rescore_query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match_phrase&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quick brown fox&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;slop&quot;</span><span class="punctuation">:</span>  <span class="number">50</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>match æŸ¥è¯¢å†³å®šå“ªäº›æ–‡æ¡£å°†åŒ…å«åœ¨æœ€ç»ˆç»“æœé›†ä¸­ï¼Œå¹¶é€šè¿‡ TF&#x2F;IDF æ’åºã€‚<br>window_size æ˜¯æ¯ä¸€åˆ†ç‰‡è¿›è¡Œé‡æ–°è¯„åˆ†çš„é¡¶éƒ¨æ–‡æ¡£æ•°é‡ã€‚<br>ç›®å‰å”¯ä¸€æ”¯æŒçš„é‡æ–°æ‰“åˆ†ç®—æ³•å°±æ˜¯å¦ä¸€ä¸ªæŸ¥è¯¢ï¼Œä½†æ˜¯ä»¥åä¼šæœ‰è®¡åˆ’å¢åŠ æ›´å¤šçš„ç®—æ³•ã€‚</p>
<h3 id="å¯»æ‰¾ç›¸å…³è¯"><a href="#å¯»æ‰¾ç›¸å…³è¯" class="headerlink" title="å¯»æ‰¾ç›¸å…³è¯"></a>å¯»æ‰¾ç›¸å…³è¯</h3><p>è¦å°†æ¯ä¸ªå•è¯ ä»¥åŠå®ƒçš„é‚»è¿‘è¯ ä½œä¸ºå•ä¸ªè¯é¡¹ç´¢å¼•ï¼š</p>
<p>[â€œsue ateâ€, â€œate theâ€, â€œthe alligatorâ€]<br>è¿™äº›å•è¯å¯¹ï¼ˆæˆ–è€… bigrams ï¼‰è¢«ç§°ä¸º shingles ã€‚<br>ps:ç´¢å¼•ä¸‰ä¸ªå•è¯ï¼ˆ trigrams ï¼‰</p>
<p>Trigrams æä¾›äº†æ›´é«˜çš„ç²¾åº¦ï¼Œä½†æ˜¯ä¹Ÿå¤§å¤§å¢åŠ äº†ç´¢å¼•ä¸­å”¯ä¸€è¯é¡¹çš„æ•°é‡ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒBigrams å°±å¤Ÿäº†ã€‚</p>
<p>ç”Ÿæˆ Shingles</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;my_shingle_filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>             <span class="string">&quot;shingle&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;min_shingle_size&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;max_shingle_size&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;output_unigrams&quot;</span><span class="punctuation">:</span>  <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;my_shingle_analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>             <span class="string">&quot;custom&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span>        <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;lowercase&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="string">&quot;my_shingle_filter&quot;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">PUT /my_index/_mapping/my_type</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;shingles&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>     <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_shingle_analyzer&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ç°åœ¨åœ¨æŸ¥è¯¢é‡Œæ·»åŠ  shingles å­—æ®µã€‚ä¸è¦å¿˜äº†åœ¨ shingles å­—æ®µä¸Šçš„åŒ¹é…æ˜¯å……å½“ä¸€ ç§ä¿¡å·â€“ä¸ºäº†æé«˜ç›¸å…³åº¦è¯„åˆ†â€“æ‰€ä»¥æˆ‘ä»¬ä»ç„¶éœ€è¦å°†åŸºæœ¬ title å­—æ®µåŒ…å«åˆ°æŸ¥è¯¢ä¸­ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;the hungry alligator ate sue&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">         <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;title.shingles&quot;</span><span class="punctuation">:</span> <span class="string">&quot;the hungry alligator ate sue&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>shingles ä¸ä»…æ¯”çŸ­è¯­æŸ¥è¯¢æ›´çµæ´»ï¼Œ è€Œä¸”æ€§èƒ½ä¹Ÿæ›´å¥½ã€‚</strong> shingles æŸ¥è¯¢è·Ÿä¸€ä¸ªç®€å•çš„ match æŸ¥è¯¢ä¸€æ ·é«˜æ•ˆï¼Œè€Œä¸ç”¨æ¯æ¬¡æœç´¢èŠ±è´¹çŸ­è¯­æŸ¥è¯¢çš„ä»£ä»·ã€‚åªæ˜¯åœ¨ç´¢å¼•æœŸé—´å› ä¸ºæ›´å¤šè¯é¡¹éœ€è¦è¢«ç´¢å¼•ä¼šä»˜å‡ºä¸€äº›å°çš„ä»£ä»·ï¼Œ è¿™ä¹Ÿæ„å‘³ç€æœ‰ shingles çš„å­—æ®µä¼šå ç”¨æ›´å¤šçš„ç£ç›˜ç©ºé—´ã€‚ ç„¶è€Œï¼Œå¤§å¤šæ•°åº”ç”¨å†™å…¥ä¸€æ¬¡è€Œè¯»å–å¤šæ¬¡ï¼Œæ‰€ä»¥åœ¨ç´¢å¼•æœŸé—´ä¼˜åŒ–æˆ‘ä»¬çš„æŸ¥è¯¢é€Ÿåº¦æ˜¯æœ‰æ„ä¹‰çš„ã€‚</p>
<h2 id="éƒ¨åˆ†åŒ¹é…"><a href="#éƒ¨åˆ†åŒ¹é…" class="headerlink" title="éƒ¨åˆ†åŒ¹é…"></a>éƒ¨åˆ†åŒ¹é…</h2><h3 id="prefix-å‰ç¼€æŸ¥è¯¢"><a href="#prefix-å‰ç¼€æŸ¥è¯¢" class="headerlink" title="prefix å‰ç¼€æŸ¥è¯¢"></a>prefix å‰ç¼€æŸ¥è¯¢</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /my_index/address/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;postcode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;W1&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>prefix æŸ¥è¯¢æˆ–è¿‡æ»¤å¯¹äºä¸€äº›ç‰¹å®šçš„åŒ¹é…æ˜¯æœ‰æ•ˆçš„ï¼Œä½†ä½¿ç”¨æ–¹å¼è¿˜æ˜¯åº”å½“æ³¨æ„ã€‚ å½“å­—æ®µä¸­è¯çš„é›†åˆå¾ˆå°æ—¶ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨ï¼Œä½†æ˜¯å®ƒçš„ä¼¸ç¼©æ€§å¹¶ä¸å¥½ï¼Œä¼šå¯¹æˆ‘ä»¬çš„é›†ç¾¤å¸¦æ¥å¾ˆå¤šå‹åŠ›ã€‚å¯ä»¥ä½¿ç”¨è¾ƒé•¿çš„å‰ç¼€æ¥é™åˆ¶è¿™ç§å½±å“ï¼Œå‡å°‘éœ€è¦è®¿é—®çš„é‡ã€‚</p>
</blockquote>
<h3 id="é€šé…ç¬¦ä¸æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢"><a href="#é€šé…ç¬¦ä¸æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢" class="headerlink" title="é€šé…ç¬¦ä¸æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢"></a>é€šé…ç¬¦ä¸æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢</h3><p>wildcard é€šé…ç¬¦æŸ¥è¯¢: ? åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œ * åŒ¹é… 0 æˆ–å¤šä¸ªå­—ç¬¦.</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /my_index/address/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;wildcard&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;postcode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;W?F*HW&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">GET /my_index/address/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;postcode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;W[0-9].+&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>wildcard å’Œ regexp æŸ¥è¯¢çš„å·¥ä½œæ–¹å¼ä¸ prefix æŸ¥è¯¢å®Œå…¨ä¸€æ ·ï¼Œå®ƒä»¬ä¹Ÿéœ€è¦æ‰«æå€’æ’ç´¢å¼•ä¸­çš„è¯åˆ—è¡¨æ‰èƒ½æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„è¯ï¼Œç„¶åä¾æ¬¡è·å–æ¯ä¸ªè¯ç›¸å…³çš„æ–‡æ¡£ ID ï¼Œä¸ prefix æŸ¥è¯¢çš„å”¯ä¸€ä¸åŒæ˜¯ï¼šå®ƒä»¬èƒ½æ”¯æŒæ›´ä¸ºå¤æ‚çš„åŒ¹é…æ¨¡å¼ã€‚</p>
<blockquote>
<p>prefix ã€ wildcard å’Œ regexp æŸ¥è¯¢æ˜¯åŸºäºè¯æ“ä½œçš„ï¼Œå¦‚æœç”¨å®ƒä»¬æ¥æŸ¥è¯¢ analyzed å­—æ®µï¼Œå®ƒä»¬ä¼šæ£€æŸ¥å­—æ®µé‡Œé¢çš„æ¯ä¸ªè¯ï¼Œè€Œä¸æ˜¯å°†å­—æ®µä½œä¸ºæ•´ä½“æ¥å¤„ç†ã€‚</p>
</blockquote>
<h3 id="æŸ¥è¯¢æ—¶è¾“å…¥å³æœç´¢"><a href="#æŸ¥è¯¢æ—¶è¾“å…¥å³æœç´¢" class="headerlink" title="æŸ¥è¯¢æ—¶è¾“å…¥å³æœç´¢"></a>æŸ¥è¯¢æ—¶è¾“å…¥å³æœç´¢</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_phrase_prefix&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;brand&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>          <span class="string">&quot;johnnie walker bl&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_expansions&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;slop&quot;</span><span class="punctuation">:</span>  <span class="number">10</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä¸ match_phrase ä¸€æ ·ï¼Œå®ƒä¹Ÿå¯ä»¥æ¥å— slop å‚æ•°ï¼ˆå‚ç…§ slop ï¼‰è®©ç›¸å¯¹è¯åºä½ç½®ä¸é‚£ä¹ˆä¸¥æ ¼ï¼š<br>å‚æ•° max_expansions æ§åˆ¶ç€å¯ä»¥ä¸å‰ç¼€åŒ¹é…çš„è¯çš„æ•°é‡ï¼Œå®ƒä¼šå…ˆæŸ¥æ‰¾ç¬¬ä¸€ä¸ªä¸å‰ç¼€ bl åŒ¹é…çš„è¯ï¼Œç„¶åä¾æ¬¡æŸ¥æ‰¾æœé›†ä¸ä¹‹åŒ¹é…çš„è¯ï¼ˆæŒ‰å­—æ¯é¡ºåºï¼‰ï¼Œç›´åˆ°æ²¡æœ‰æ›´å¤šå¯åŒ¹é…çš„è¯æˆ–å½“æ•°é‡è¶…è¿‡ max_expansions æ—¶ç»“æŸã€‚</p>
<h3 id="ç´¢å¼•æ—¶è¾“å…¥å³æœç´¢"><a href="#ç´¢å¼•æ—¶è¾“å…¥å³æœç´¢" class="headerlink" title="ç´¢å¼•æ—¶è¾“å…¥å³æœç´¢"></a>ç´¢å¼•æ—¶è¾“å…¥å³æœç´¢</h3><p>è‡ªå®šä¹‰åˆ†æå™¨ autocomplete</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;autocomplete_filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>     <span class="string">&quot;edge_ngram&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;min_gram&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;max_gram&quot;</span><span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;autocomplete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>      <span class="string">&quot;custom&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;lowercase&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="string">&quot;autocomplete_filter&quot;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åº”ç”¨åœ¨å­—æ®µ</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index/my_type/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>            <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;index_analyzer&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;autocomplete&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å› ä¸ºå¤§å¤šæ•°å·¥ä½œæ˜¯åœ¨ç´¢å¼•æ—¶å®Œæˆçš„ï¼Œæ‰€æœ‰çš„æŸ¥è¯¢åªè¦æŸ¥æ‰¾ brown å’Œ fo è¿™ä¸¤ä¸ªè¯ï¼Œè¿™æ¯”ä½¿ç”¨ match_phrase_prefix æŸ¥æ‰¾æ‰€æœ‰ä»¥ fo å¼€å§‹çš„è¯çš„æ–¹å¼è¦é«˜æ•ˆè®¸å¤šã€‚</p>
<h2 id="æ§åˆ¶ç›¸å…³åº¦"><a href="#æ§åˆ¶ç›¸å…³åº¦" class="headerlink" title="æ§åˆ¶ç›¸å…³åº¦"></a>æ§åˆ¶ç›¸å…³åº¦</h2><h3 id="ç›¸å…³åº¦è¯„åˆ†èƒŒåçš„ç†è®º"><a href="#ç›¸å…³åº¦è¯„åˆ†èƒŒåçš„ç†è®º" class="headerlink" title="ç›¸å…³åº¦è¯„åˆ†èƒŒåçš„ç†è®º"></a>ç›¸å…³åº¦è¯„åˆ†èƒŒåçš„ç†è®º</h3><p>ä»¥ä¸‹ä¸‰ä¸ªå› ç´ â€”â€”è¯é¢‘ï¼ˆterm frequencyï¼‰ã€é€†å‘æ–‡æ¡£é¢‘ç‡ï¼ˆinverse document frequencyï¼‰å’Œå­—æ®µé•¿åº¦å½’ä¸€å€¼ï¼ˆfield-length normï¼‰â€”â€”<strong>æ˜¯åœ¨ç´¢å¼•æ—¶è®¡ç®—å¹¶å­˜å‚¨çš„</strong>ã€‚ æœ€åå°†å®ƒä»¬ç»“åˆåœ¨ä¸€èµ·è®¡ç®—å•ä¸ªè¯åœ¨ç‰¹å®šæ–‡æ¡£ä¸­çš„ æƒé‡ ã€‚</p>
<h3 id="Lucene-çš„å®ç”¨è¯„åˆ†å‡½æ•°"><a href="#Lucene-çš„å®ç”¨è¯„åˆ†å‡½æ•°" class="headerlink" title="Lucene çš„å®ç”¨è¯„åˆ†å‡½æ•°"></a>Lucene çš„å®ç”¨è¯„åˆ†å‡½æ•°</h3><p><em>å®ç”¨è¯„åˆ†å‡½æ•°ï¼ˆpractical scoring functionï¼‰</em><br>â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦..<br>score(q,d)  &#x3D;  &lt;1&gt;<br>            queryNorm(q)  &lt;2&gt;<br>          Â· coord(q,d)    &lt;3&gt;<br>          Â· âˆ‘ (           &lt;4&gt;<br>                tf(t in d)   &lt;5&gt;<br>              Â· idf(t)Â²      &lt;6&gt;<br>              Â· t.getBoost() &lt;7&gt;<br>              Â· norm(t,d)    &lt;8&gt;<br>            ) (t in q)    &lt;4&gt;<br>â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦..</p>
<p>&lt;1&gt; <code>score(q,d)</code> æ˜¯æ–‡æ¡£ <code>d</code> ä¸æŸ¥è¯¢ <code>q</code> çš„ç›¸å…³åº¦è¯„åˆ†ã€‚<br>&lt;2&gt; <code>queryNorm(q)</code> æ˜¯ &lt;&lt;query-norm,_æŸ¥è¯¢å½’ä¸€åŒ–_ å› å­&gt;&gt; ï¼ˆæ–°ï¼‰ã€‚<br>&lt;3&gt; <code>coord(q,d)</code> æ˜¯ &lt;&lt;coord,_åè°ƒ_ å› å­&gt;&gt; ï¼ˆæ–°ï¼‰ã€‚<br>&lt;4&gt; æŸ¥è¯¢ <code>q</code> ä¸­æ¯ä¸ªè¯ <code>t</code> å¯¹äºæ–‡æ¡£ <code>d</code> çš„æƒé‡å’Œã€‚<br>&lt;5&gt; <code>tf(t in d)</code> æ˜¯è¯ <code>t</code> åœ¨æ–‡æ¡£ <code>d</code> ä¸­çš„ &lt;&lt;tf,è¯é¢‘&gt;&gt; ã€‚<br>&lt;6&gt; <code>idf(t)</code> æ˜¯è¯ <code>t</code> çš„ &lt;&lt;idf,é€†å‘æ–‡æ¡£é¢‘ç‡&gt;&gt; ã€‚<br>&lt;7&gt; <code>t.getBoost()</code> æ˜¯æŸ¥è¯¢ä¸­ä½¿ç”¨çš„ &lt;&lt;query-time-boosting,_boost_&gt;&gt;ï¼ˆæ–°ï¼‰ã€‚<br>&lt;8&gt; <code>norm(t,d)</code> æ˜¯ &lt;&lt;field-norm,å­—æ®µé•¿åº¦å½’ä¸€å€¼&gt;&gt; ï¼Œä¸ &lt;&lt;index-boost,ç´¢å¼•æ—¶å­—æ®µå±‚ boost&gt;&gt; ï¼ˆå¦‚æœå­˜åœ¨ï¼‰çš„å’Œï¼ˆæ–°ï¼‰ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬ä¸å»ºè®®åœ¨å»ºç«‹ç´¢å¼•æ—¶å¯¹å­—æ®µæå‡æƒé‡ï¼Œæœ‰ä»¥ä¸‹åŸå› ï¼š<br>å°†æå‡å€¼ä¸å­—æ®µé•¿åº¦å½’ä¸€å€¼åˆåœ¨å•ä¸ªå­—èŠ‚ä¸­å­˜å‚¨ä¼šä¸¢å¤±å­—æ®µé•¿åº¦å½’ä¸€å€¼çš„ç²¾åº¦ï¼Œè¿™æ ·ä¼šå¯¼è‡´ Elasticsearch ä¸çŸ¥å¦‚ä½•åŒºåˆ†åŒ…å«ä¸‰ä¸ªè¯çš„å­—æ®µå’ŒåŒ…å«äº”ä¸ªè¯çš„å­—æ®µã€‚<br>è¦æƒ³æ”¹å˜ç´¢å¼•æ—¶çš„æå‡å€¼ï¼Œå°±å¿…é¡»é‡æ–°ä¸ºæ‰€æœ‰æ–‡æ¡£å»ºç«‹ç´¢å¼•ï¼Œä¸æ­¤ä¸åŒçš„æ˜¯ï¼ŒæŸ¥è¯¢æ—¶çš„æå‡å€¼å¯ä»¥éšç€æ¯æ¬¡æŸ¥è¯¢çš„ä¸åŒè€Œæ›´æ”¹ã€‚<br>å¦‚æœä¸€ä¸ªç´¢å¼•æ—¶æƒé‡æå‡çš„å­—æ®µæœ‰å¤šä¸ªå€¼ï¼Œæå‡å€¼ä¼šæŒ‰ç…§æ¯ä¸ªå€¼æ¥è‡ªä¹˜ï¼Œè¿™ä¼šå¯¼è‡´è¯¥å­—æ®µçš„æƒé‡æ€¥å‰§ä¸Šå‡ã€‚<br>æŸ¥è¯¢æ—¶èµ‹äºˆæƒé‡ æ˜¯æ›´ä¸ºç®€å•ã€æ¸…æ¥šã€çµæ´»çš„é€‰æ‹©ã€‚</p>
</blockquote>
<h3 id="æŸ¥è¯¢æ—¶æƒé‡æå‡"><a href="#æŸ¥è¯¢æ—¶æƒé‡æå‡" class="headerlink" title="æŸ¥è¯¢æ—¶æƒé‡æå‡"></a>æŸ¥è¯¢æ—¶æƒé‡æå‡</h3><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ— æ³•é€šè¿‡ç®€å•çš„å…¬å¼å¾—å‡ºæŸä¸ªç‰¹å®šæŸ¥è¯¢è¯­å¥çš„ â€œæ­£ç¡®â€ æƒé‡æå‡å€¼ï¼Œåªèƒ½é€šè¿‡ä¸æ–­å°è¯•è·å¾—ã€‚éœ€è¦è®°ä½çš„æ˜¯ boost åªæ˜¯å½±å“ç›¸å…³åº¦è¯„åˆ†çš„å…¶ä¸­ä¸€ä¸ªå› å­ï¼›å®ƒè¿˜éœ€è¦ä¸å…¶ä»–å› å­ç›¸äº’ç«äº‰ã€‚åœ¨å‰ä¾‹ä¸­ï¼Œ <strong>title å­—æ®µç›¸å¯¹ content å­—æ®µå¯èƒ½å·²ç»æœ‰ä¸€ä¸ª â€œç¼ºçœçš„â€ æƒé‡æå‡å€¼</strong>ï¼Œè¿™å› ä¸ºåœ¨ å­—æ®µé•¿åº¦å½’ä¸€å€¼ ä¸­ï¼Œæ ‡é¢˜å¾€å¾€æ¯”ç›¸å…³å†…å®¹è¦çŸ­ï¼Œæ‰€ä»¥ä¸è¦æƒ³å½“ç„¶çš„å»ç›²ç›®æå‡ä¸€äº›å­—æ®µçš„æƒé‡ã€‚é€‰æ‹©æƒé‡ï¼Œæ£€æŸ¥ç»“æœï¼Œå¦‚æ­¤åå¤ã€‚</p>
<p>å½“åœ¨å¤šä¸ªç´¢å¼•ä¸­æœç´¢æ—¶ï¼Œ å¯ä»¥ä½¿ç”¨å‚æ•° indices_boost æ¥æå‡æ•´ä¸ªç´¢å¼•çš„æƒé‡</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /docs_2014_*/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;indices_boost&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;docs_2014_10&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;docs_2014_09&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quick brown fox&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨æŸ¥è¯¢ç»“æ„ä¿®æ”¹ç›¸å…³åº¦"><a href="#ä½¿ç”¨æŸ¥è¯¢ç»“æ„ä¿®æ”¹ç›¸å…³åº¦" class="headerlink" title="ä½¿ç”¨æŸ¥è¯¢ç»“æ„ä¿®æ”¹ç›¸å…³åº¦"></a>ä½¿ç”¨æŸ¥è¯¢ç»“æ„ä¿®æ”¹ç›¸å…³åº¦</h3><p>ç•¥</p>
<h3 id="function-score-æŸ¥è¯¢"><a href="#function-score-æŸ¥è¯¢" class="headerlink" title="function_score æŸ¥è¯¢"></a>function_score æŸ¥è¯¢</h3><p>function_score æŸ¥è¯¢ æ˜¯ç”¨æ¥æ§åˆ¶è¯„åˆ†è¿‡ç¨‹çš„ç»ˆææ­¦å™¨ï¼Œå®ƒå…è®¸ä¸ºæ¯ä¸ªä¸ä¸»æŸ¥è¯¢åŒ¹é…çš„æ–‡æ¡£åº”ç”¨ä¸€ä¸ªå‡½æ•°ï¼Œ ä»¥è¾¾åˆ°æ”¹å˜ç”šè‡³å®Œå…¨æ›¿æ¢åŸå§‹æŸ¥è¯¢è¯„åˆ† _score çš„ç›®çš„ã€‚<br>å®é™…ä¸Šï¼Œä¹Ÿèƒ½ç”¨è¿‡æ»¤å™¨å¯¹ç»“æœçš„ å­é›† åº”ç”¨ä¸åŒçš„å‡½æ•°ï¼Œè¿™æ ·ä¸€ç®­åŒé›•ï¼šæ—¢èƒ½é«˜æ•ˆè¯„åˆ†ï¼Œåˆèƒ½åˆ©ç”¨è¿‡æ»¤å™¨ç¼“å­˜ã€‚</p>
<p>Elasticsearch é¢„å®šä¹‰äº†ä¸€äº›å‡½æ•°ï¼š</p>
<ul>
<li>weight<br>ä¸ºæ¯ä¸ªæ–‡æ¡£åº”ç”¨ä¸€ä¸ªç®€å•è€Œä¸è¢«è§„èŒƒåŒ–çš„æƒé‡æå‡å€¼ï¼šå½“ weight ä¸º 2 æ—¶ï¼Œæœ€ç»ˆç»“æœä¸º 2 * _score ã€‚</li>
<li>field_value_factor<br>ä½¿ç”¨è¿™ä¸ªå€¼æ¥ä¿®æ”¹ _score ï¼Œå¦‚å°† popularity æˆ– votes ï¼ˆå—æ¬¢è¿æˆ–èµï¼‰ä½œä¸ºè€ƒè™‘å› ç´ ã€‚</li>
<li>random_score<br>ä¸ºæ¯ä¸ªç”¨æˆ·éƒ½ä½¿ç”¨ä¸€ä¸ªä¸åŒçš„éšæœºè¯„åˆ†å¯¹ç»“æœæ’åºï¼Œä½†å¯¹æŸä¸€å…·ä½“ç”¨æˆ·æ¥è¯´ï¼Œçœ‹åˆ°çš„é¡ºåºå§‹ç»ˆæ˜¯ä¸€è‡´çš„ã€‚</li>
<li>è¡°å‡å‡½æ•° â€”â€” linear ã€ exp ã€ gauss<br>å°†æµ®åŠ¨å€¼ç»“åˆåˆ°è¯„åˆ† _score ä¸­ï¼Œä¾‹å¦‚ç»“åˆ publish_date è·å¾—æœ€è¿‘å‘å¸ƒçš„æ–‡æ¡£ï¼Œç»“åˆ geo_location è·å¾—æ›´æ¥è¿‘æŸä¸ªå…·ä½“ç»çº¬åº¦ï¼ˆlat&#x2F;lonï¼‰åœ°ç‚¹çš„æ–‡æ¡£ï¼Œç»“åˆ price è·å¾—æ›´æ¥è¿‘æŸä¸ªç‰¹å®šä»·æ ¼çš„æ–‡æ¡£ã€‚</li>
<li>script_score<br>å¦‚æœéœ€æ±‚è¶…å‡ºä»¥ä¸ŠèŒƒå›´æ—¶ï¼Œç”¨è‡ªå®šä¹‰è„šæœ¬å¯ä»¥å®Œå…¨æ§åˆ¶è¯„åˆ†è®¡ç®—ï¼Œå®ç°æ‰€éœ€é€»è¾‘ã€‚<br>å¦‚æœæ²¡æœ‰ function_score æŸ¥è¯¢ï¼Œå°±ä¸èƒ½å°†å…¨æ–‡æŸ¥è¯¢ä¸æœ€æ–°å‘ç”Ÿè¿™ç§å› å­ç»“åˆåœ¨ä¸€èµ·è¯„åˆ†ï¼Œè€Œä¸å¾—ä¸æ ¹æ®è¯„åˆ† _score æˆ–æ—¶é—´ date è¿›è¡Œæ’åºï¼›è¿™ä¼šç›¸äº’å½±å“æŠµæ¶ˆä¸¤ç§æ’åºå„è‡ªçš„æ•ˆæœã€‚è¿™ä¸ªæŸ¥è¯¢å¯ä»¥ä½¿ä¸¤ä¸ªæ•ˆæœèåˆï¼šå¯ä»¥ä»ç„¶æ ¹æ®å…¨æ–‡ç›¸å…³åº¦è¿›è¡Œæ’åºï¼Œä½†ä¹Ÿä¼šåŒæ—¶è€ƒè™‘æœ€æ–°å‘å¸ƒæ–‡æ¡£ã€æµè¡Œæ–‡æ¡£ã€æˆ–æ¥è¿‘ç”¨æˆ·å¸Œæœ›ä»·æ ¼çš„äº§å“ã€‚</li>
</ul>
<h3 id="æŒ‰å—æ¬¢è¿åº¦æå‡æƒé‡"><a href="#æŒ‰å—æ¬¢è¿åº¦æå‡æƒé‡" class="headerlink" title="æŒ‰å—æ¬¢è¿åº¦æå‡æƒé‡"></a>æŒ‰å—æ¬¢è¿åº¦æå‡æƒé‡</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /blogposts/post/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;function_score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;popularity&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;title&quot;</span><span class="punctuation">,</span> <span class="string">&quot;content&quot;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;field_value_factor&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;votes&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;modifier&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log1p&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä¿®é¥°è¯­ modifier çš„å€¼å¯ä»¥ä¸ºï¼š none ï¼ˆé»˜è®¤çŠ¶æ€ï¼‰ã€ log ã€ log1p ã€ log2p ã€ ln ã€ ln1p ã€ ln2p ã€ square ã€ sqrt ä»¥åŠ reciprocal ã€‚æƒ³è¦äº†è§£æ›´å¤šä¿¡æ¯è¯·å‚ç…§ï¼š <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/query-dsl-function-score-query.html#function-field-value-factor">field_value_factor æ–‡æ¡£</a>.</p>
<p><strong>boost_mode</strong><br>æˆ–è®¸å°†å…¨æ–‡è¯„åˆ†ä¸ field_value_factor å‡½æ•°å€¼ä¹˜ç§¯çš„æ•ˆæœä»ç„¶å¯èƒ½å¤ªå¤§ï¼Œ æˆ‘ä»¬å¯ä»¥é€šè¿‡å‚æ•° boost_mode æ¥æ§åˆ¶å‡½æ•°ä¸æŸ¥è¯¢è¯„åˆ† _score åˆå¹¶åçš„ç»“æœï¼Œå‚æ•°æ¥å—çš„å€¼ä¸ºï¼š</p>
<p>multiply<br>è¯„åˆ† _score ä¸å‡½æ•°å€¼çš„ç§¯ï¼ˆé»˜è®¤ï¼‰<br>sum<br>è¯„åˆ† _score ä¸å‡½æ•°å€¼çš„å’Œ<br>min<br>è¯„åˆ† _score ä¸å‡½æ•°å€¼é—´çš„è¾ƒå°å€¼<br>max<br>è¯„åˆ† _score ä¸å‡½æ•°å€¼é—´çš„è¾ƒå¤§å€¼<br>replace<br>å‡½æ•°å€¼æ›¿ä»£è¯„åˆ† _score</p>
<p>å¯ä»¥ä½¿ç”¨ <strong>max_boost</strong> å‚æ•°é™åˆ¶ä¸€ä¸ªå‡½æ•°çš„æœ€å¤§æ•ˆæœ</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /blogposts/post/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;function_score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;popularity&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;title&quot;</span><span class="punctuation">,</span> <span class="string">&quot;content&quot;</span> <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;field_value_factor&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;votes&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;modifier&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log1p&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;factor&quot;</span><span class="punctuation">:</span>   <span class="number">0.1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;boost_mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;max_boost&quot;</span><span class="punctuation">:</span>  <span class="number">1.5</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="è¿‡æ»¤é›†æå‡æƒé‡"><a href="#è¿‡æ»¤é›†æå‡æƒé‡" class="headerlink" title="è¿‡æ»¤é›†æå‡æƒé‡"></a>è¿‡æ»¤é›†æå‡æƒé‡</h3><p>ç”¨è¿‡æ»¤å™¨å°†ç»“æœåˆ’åˆ†ä¸ºå¤šä¸ªå­é›†ï¼ˆæ¯ä¸ªç‰¹æ€§ä¸€ä¸ªè¿‡æ»¤å™¨ï¼‰ï¼Œå¹¶ä¸ºæ¯ä¸ªå­é›†ä½¿ç”¨ä¸åŒçš„å‡½æ•°ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;function_score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Barcelona&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;functions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;features&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wifi&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;features&quot;</span><span class="punctuation">:</span> <span class="string">&quot;garden&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;features&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pool&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;score_mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="éšæœºè¯„åˆ†"><a href="#éšæœºè¯„åˆ†" class="headerlink" title="éšæœºè¯„åˆ†"></a>éšæœºè¯„åˆ†</h3><p>ç•¥</p>
<h3 id="è¶Šè¿‘è¶Šå¥½ï¼ˆè¡°å‡å‡½æ•°ï¼‰"><a href="#è¶Šè¿‘è¶Šå¥½ï¼ˆè¡°å‡å‡½æ•°ï¼‰" class="headerlink" title="è¶Šè¿‘è¶Šå¥½ï¼ˆè¡°å‡å‡½æ•°ï¼‰"></a>è¶Šè¿‘è¶Šå¥½ï¼ˆè¡°å‡å‡½æ•°ï¼‰</h3><p>function_score æŸ¥è¯¢ä¼šæä¾›ä¸€ç»„ è¡°å‡å‡½æ•°ï¼ˆdecay functionsï¼‰ ï¼Œ è®©æˆ‘ä»¬æœ‰èƒ½åŠ›åœ¨ä¸¤ä¸ªæ»‘åŠ¨æ ‡å‡†ï¼Œå¦‚åœ°ç‚¹å’Œä»·æ ¼ï¼Œä¹‹é—´æƒè¡¡ã€‚</p>
<p>æœ‰ä¸‰ç§è¡°å‡å‡½æ•°â€”â€” linear ã€ exp å’Œ gauss ï¼ˆçº¿æ€§ã€æŒ‡æ•°å’Œé«˜æ–¯å‡½æ•°ï¼‰ï¼Œå®ƒä»¬å¯ä»¥æ“ä½œæ•°å€¼ã€æ—¶é—´ä»¥åŠç»çº¬åº¦åœ°ç†åæ ‡ç‚¹è¿™æ ·çš„å­—æ®µã€‚æ‰€æœ‰ä¸‰ä¸ªå‡½æ•°éƒ½èƒ½æ¥å—ä»¥ä¸‹å‚æ•°ï¼š</p>
<p>origin<br>ä¸­å¿ƒç‚¹ æˆ–å­—æ®µå¯èƒ½çš„æœ€ä½³å€¼ï¼Œè½åœ¨åŸç‚¹ origin ä¸Šçš„æ–‡æ¡£è¯„åˆ† _score ä¸ºæ»¡åˆ† 1.0 ã€‚<br>scale<br>è¡°å‡ç‡ï¼Œå³ä¸€ä¸ªæ–‡æ¡£ä»åŸç‚¹ origin ä¸‹è½æ—¶ï¼Œè¯„åˆ† _score æ”¹å˜çš„é€Ÿåº¦ã€‚ï¼ˆä¾‹å¦‚ï¼Œæ¯ Â£10 æ¬§å…ƒæˆ–æ¯ 100 ç±³ï¼‰ã€‚<br>decay<br>ä»åŸç‚¹ origin è¡°å‡åˆ° scale æ‰€å¾—çš„è¯„åˆ† _score ï¼Œé»˜è®¤å€¼ä¸º 0.5 ã€‚<br>offset<br>ä»¥åŸç‚¹ origin ä¸ºä¸­å¿ƒç‚¹ï¼Œä¸ºå…¶è®¾ç½®ä¸€ä¸ªéé›¶çš„åç§»é‡ offset è¦†ç›–ä¸€ä¸ªèŒƒå›´ï¼Œè€Œä¸åªæ˜¯å•ä¸ªåŸç‚¹ã€‚åœ¨èŒƒå›´ -offset &lt;&#x3D; origin &lt;&#x3D; +offset å†…çš„æ‰€æœ‰è¯„åˆ† _score éƒ½æ˜¯ 1.0 ã€‚</p>
<h3 id="ç†è§£-price-ä»·æ ¼è¯­å¥"><a href="#ç†è§£-price-ä»·æ ¼è¯­å¥" class="headerlink" title="ç†è§£ price ä»·æ ¼è¯­å¥"></a>ç†è§£ price ä»·æ ¼è¯­å¥</h3><p>ç•¥</p>
<h3 id="è„šæœ¬è¯„åˆ†"><a href="#è„šæœ¬è¯„åˆ†" class="headerlink" title="è„šæœ¬è¯„åˆ†"></a>è„šæœ¬è¯„åˆ†</h3><p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/script-score.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/script-score.html</a></p>
<h3 id="å¯æ’æ‹”çš„ç›¸ä¼¼åº¦ç®—æ³•"><a href="#å¯æ’æ‹”çš„ç›¸ä¼¼åº¦ç®—æ³•" class="headerlink" title="å¯æ’æ‹”çš„ç›¸ä¼¼åº¦ç®—æ³•"></a>å¯æ’æ‹”çš„ç›¸ä¼¼åº¦ç®—æ³•</h3><p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/pluggable-similarites.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/pluggable-similarites.html</a></p>
<h3 id="æ›´æ”¹ç›¸ä¼¼åº¦"><a href="#æ›´æ”¹ç›¸ä¼¼åº¦" class="headerlink" title="æ›´æ”¹ç›¸ä¼¼åº¦"></a>æ›´æ”¹ç›¸ä¼¼åº¦</h3><p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/changing-similarities.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/changing-similarities.html</a></p>
<h3 id="è°ƒè¯•ç›¸å…³åº¦æ˜¯æœ€å-10-è¦åšçš„äº‹æƒ…"><a href="#è°ƒè¯•ç›¸å…³åº¦æ˜¯æœ€å-10-è¦åšçš„äº‹æƒ…" class="headerlink" title="è°ƒè¯•ç›¸å…³åº¦æ˜¯æœ€å 10% è¦åšçš„äº‹æƒ…"></a>è°ƒè¯•ç›¸å…³åº¦æ˜¯æœ€å 10% è¦åšçš„äº‹æƒ…</h3><p><strong>ç›¸å…³åº¦çš„è°ƒè¯•å°±æœ‰å¦‚å…”å­æ´ï¼Œä¸€æ—¦è·³è¿›å»å°±å¾ˆéš¾å†å‡ºæ¥</strong>ã€‚ æœ€ç›¸å…³ è¿™ä¸ªæ¦‚å¿µæ˜¯ä¸€ä¸ªéš¾ä»¥è§¦åŠçš„æ¨¡ç³Šç›®æ ‡ï¼Œé€šå¸¸ä¸åŒäººå¯¹æ–‡æ¡£æ’åºåˆæœ‰ç€ä¸åŒçš„æƒ³æ³•ï¼Œè¿™å¾ˆå®¹æ˜“ä½¿äººé™·å…¥æŒç»­åå¤è°ƒæ•´è€Œæ²¡æœ‰æ˜æ˜¾è¿›å±•çš„æ€ªåœˆã€‚</p>
<p>æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä¸è¦é™·å…¥è¿™ç§æ€ªåœˆï¼Œè€Œè¦ç›‘æ§æµ‹é‡æœç´¢ç»“æœã€‚ç›‘æ§ç”¨æˆ·ç‚¹å‡»æœ€é¡¶ç«¯ç»“æœçš„é¢‘æ¬¡ï¼Œè¿™å¯ä»¥æ˜¯å‰ 10 ä¸ªæ–‡æ¡£ï¼Œä¹Ÿå¯ä»¥æ˜¯ç¬¬ä¸€é¡µçš„ï¼›ç”¨æˆ·ä¸æŸ¥çœ‹é¦–æ¬¡æœç´¢çš„ç»“æœè€Œç›´æ¥æ‰§è¡Œç¬¬äºŒæ¬¡æŸ¥è¯¢çš„é¢‘æ¬¡ï¼›ç”¨æˆ·æ¥å›ç‚¹å‡»å¹¶æŸ¥çœ‹æœç´¢ç»“æœçš„é¢‘æ¬¡ï¼Œç­‰ç­‰è¯¸å¦‚æ­¤ç±»çš„ä¿¡æ¯ã€‚</p>
<h1 id="å¤„ç†äººç±»è¯­è¨€"><a href="#å¤„ç†äººç±»è¯­è¨€" class="headerlink" title="å¤„ç†äººç±»è¯­è¨€"></a>å¤„ç†äººç±»è¯­è¨€</h1><h2 id="å¼€å§‹å¤„ç†å„ç§è¯­è¨€"><a href="#å¼€å§‹å¤„ç†å„ç§è¯­è¨€" class="headerlink" title="å¼€å§‹å¤„ç†å„ç§è¯­è¨€"></a>å¼€å§‹å¤„ç†å„ç§è¯­è¨€</h2><p>ç•¥ï¼Œæ··åˆä¸åŒè¯­è¨€çš„å¤„ç†ã€‚</p>
<h2 id="è¯æ±‡è¯†åˆ«"><a href="#è¯æ±‡è¯†åˆ«" class="headerlink" title="è¯æ±‡è¯†åˆ«"></a>è¯æ±‡è¯†åˆ«</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/plugins/current/analysis.html">å®˜æ–¹åˆ†è¯æ’ä»¶</a></p>
<h2 id="å½’ä¸€åŒ–è¯å…ƒ"><a href="#å½’ä¸€åŒ–è¯å…ƒ" class="headerlink" title="å½’ä¸€åŒ–è¯å…ƒ"></a>å½’ä¸€åŒ–è¯å…ƒ</h2><p>ç•¥</p>
<h2 id="å°†å•è¯è¿˜åŸä¸ºè¯æ ¹"><a href="#å°†å•è¯è¿˜åŸä¸ºè¯æ ¹" class="headerlink" title="å°†å•è¯è¿˜åŸä¸ºè¯æ ¹"></a>å°†å•è¯è¿˜åŸä¸ºè¯æ ¹</h2><p>ç•¥</p>
<h2 id="åœç”¨è¯-æ€§èƒ½ä¸ç²¾åº¦"><a href="#åœç”¨è¯-æ€§èƒ½ä¸ç²¾åº¦" class="headerlink" title="åœç”¨è¯: æ€§èƒ½ä¸ç²¾åº¦"></a>åœç”¨è¯: æ€§èƒ½ä¸ç²¾åº¦</h2><h3 id="åœç”¨è¯çš„ä¼˜ç¼ºç‚¹"><a href="#åœç”¨è¯çš„ä¼˜ç¼ºç‚¹" class="headerlink" title="åœç”¨è¯çš„ä¼˜ç¼ºç‚¹"></a>åœç”¨è¯çš„ä¼˜ç¼ºç‚¹</h3><p>åœ¨æ­¤åŸºç¡€ä¸Šï¼Œä»ç´¢å¼•é‡Œå°†è¿™äº›è¯ç§»é™¤ä¼šä½¿æˆ‘ä»¬é™ä½æŸç§ç±»å‹çš„æœç´¢èƒ½åŠ›ã€‚å°†å‰é¢è¿™äº›æ‰€åˆ—å•è¯ç§»é™¤ä¼šè®©æˆ‘ä»¬éš¾ä»¥å®Œæˆä»¥ä¸‹äº‹æƒ…ï¼š</p>
<p>åŒºåˆ† happy å’Œ _not happy_ã€‚<br>æœç´¢ä¹é˜Ÿåç§° The Theã€‚<br>æŸ¥æ‰¾èå£«æ¯”äºšçš„åå¥ â€œTo be, or not to beâ€ ï¼ˆç”Ÿå­˜è¿˜æ˜¯æ¯ç­)ã€‚<br>ä½¿ç”¨æŒªå¨çš„å›½å®¶ä»£ç : <code>no</code>ã€‚<br>ç§»é™¤åœç”¨è¯çš„æœ€ä¸»è¦å¥½å¤„æ˜¯æ€§èƒ½ï¼Œå‡è®¾æˆ‘ä»¬åœ¨ä¸ªå…·æœ‰ä¸Šç™¾ä¸‡æ–‡æ¡£çš„ç´¢å¼•ä¸­æœç´¢å•è¯ fox<code>ã€‚æˆ–è®¸ </code>fox åªåœ¨å…¶ä¸­ 20 ä¸ªæ–‡æ¡£ä¸­å‡ºç°ï¼Œä¹Ÿå°±æ˜¯è¯´ Elasticsearch éœ€è¦è®¡ç®— 20 ä¸ªæ–‡æ¡£çš„ç›¸å…³åº¦è¯„åˆ† <code>_score </code>ä»è€Œæ’å‡ºå‰åã€‚ç°åœ¨æˆ‘ä»¬æŠŠæœç´¢æ¡ä»¶æ”¹ä¸º <code>the OR fox</code>ï¼Œå‡ ä¹æ‰€æœ‰çš„æ–‡ä»¶éƒ½åŒ…å« <code>the è¿™ä¸ªè¯ï¼Œä¹Ÿå°±æ˜¯è¯´ Elasticsearch éœ€è¦ä¸ºæ‰€æœ‰ä¸€ç™¾ä¸‡æ–‡æ¡£è®¡ç®—è¯„åˆ† </code>_score&#96;ã€‚ ç”±æ­¤å¯è§ç¬¬äºŒä¸ªæŸ¥è¯¢è‚¯å®šæ²¡æœ‰ç¬¬ä¸€ä¸ªçš„ç»“æœå¥½ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ¥ä¿æŒå¸¸ç”¨è¯æœç´¢ï¼ŒåŒæ—¶è¿˜å¯ä»¥ä¿æŒè‰¯å¥½çš„æ€§èƒ½ã€‚</p>
<h3 id="åœç”¨è¯ä¸æ€§èƒ½"><a href="#åœç”¨è¯ä¸æ€§èƒ½" class="headerlink" title="åœç”¨è¯ä¸æ€§èƒ½"></a>åœç”¨è¯ä¸æ€§èƒ½</h3><p><strong>ä¿ç•™åœç”¨è¯æœ€å¤§çš„ç¼ºç‚¹å°±å½±å“æœç´¢æ€§èƒ½ã€‚</strong><br>æˆ‘ä»¬æƒ³è¦å‡å°‘å¾…è¯„åˆ†æ–‡æ¡£çš„æ•°é‡ï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯åœ¨and æ“ä½œç¬¦ match æŸ¥è¯¢æ—¶ä½¿ç”¨ and æ“ä½œç¬¦ï¼Œ è¿™æ ·å¯ä»¥è®©æ‰€æœ‰è¯éƒ½æ˜¯å¿…é¡»çš„ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ match æŸ¥è¯¢ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;the quick brown fox&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;operator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;and&quot;</span></span><br><span class="line">             <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æœ€å°‘åŒ¹é…æ•°(minimum_should_match)<br>åœ¨ç²¾åº¦åŒ¹é…æ§åˆ¶ç²¾åº¦çš„ç« èŠ‚é‡Œé¢ï¼Œæˆ‘ä»¬è®¨è®ºè¿‡ä½¿ç”¨ minimum_should_match é…ç½®å»æ‰ç»“æœä¸­æ¬¡ç›¸å…³çš„é•¿å°¾ã€‚ è™½ç„¶å®ƒåªå¯¹è¿™ä¸ªç›®çš„å¥æ•ˆï¼Œä½†æ˜¯ä¹Ÿä¸ºæˆ‘ä»¬ä»ä¾§é¢å¸¦æ¥ä¸€ä¸ªå¥½å¤„ï¼Œå®ƒæä¾› and æ“ä½œç¬¦ç›¸ä¼¼çš„æ€§èƒ½ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;the quick brown fox&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;minimum_should_match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;75%&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå››åˆ†ä¹‹ä¸‰çš„è¯éƒ½å¿…é¡»åŒ¹é…ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åªéœ€è€ƒè™‘é‚£äº›åŒ…å«æœ€ä½é¢‘æˆ–æ¬¡ä½é¢‘è¯çš„æ–‡æ¡£ã€‚ ç›¸æ¯”é»˜è®¤ä½¿ç”¨ or æ“ä½œç¬¦çš„ç®€å•æŸ¥è¯¢ï¼Œè¿™ä¸ºæˆ‘ä»¬å¸¦æ¥äº†å·¨å¤§çš„æ€§èƒ½æå‡ã€‚ä¸è¿‡æˆ‘ä»¬æœ‰åŠæ³•å¯ä»¥åšå¾—æ›´å¥½â€¦â€¦</p>
<h3 id="è¯é¡¹çš„åˆ†åˆ«ç®¡ç†"><a href="#è¯é¡¹çš„åˆ†åˆ«ç®¡ç†" class="headerlink" title="è¯é¡¹çš„åˆ†åˆ«ç®¡ç†"></a>è¯é¡¹çš„åˆ†åˆ«ç®¡ç†</h3><p>match æŸ¥è¯¢æ¥å—ä¸€ä¸ªå‚æ•° <strong>cutoff_frequency</strong> ï¼Œä»è€Œå¯ä»¥è®©å®ƒå°†æŸ¥è¯¢å­—ç¬¦ä¸²é‡Œçš„è¯é¡¹åˆ†ä¸ºä½é¢‘å’Œé«˜é¢‘ä¸¤ç»„ã€‚ ä½é¢‘ç»„ï¼ˆæ›´é‡è¦çš„è¯é¡¹ï¼‰ç»„æˆ bulk å¤§é‡æŸ¥è¯¢æ¡ä»¶ï¼Œè€Œé«˜é¢‘ç»„ï¼ˆæ¬¡é‡è¦çš„è¯é¡¹ï¼‰åªä¼šç”¨æ¥è¯„åˆ†ï¼Œè€Œä¸å‚ä¸åŒ¹é…è¿‡ç¨‹ã€‚é€šè¿‡å¯¹è¿™ä¸¤ç»„è¯çš„åŒºåˆ†å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¹‹å‰æ…¢æŸ¥è¯¢çš„åŸºç¡€ä¸Šè·å¾—å·¨å¤§çš„é€Ÿåº¦æå‡ã€‚<br>cutoff_frequency ä¼šæŸ¥çœ‹ç´¢å¼•é‡Œè¯é¡¹çš„å…·ä½“é¢‘ç‡ï¼Œè¿™äº›è¯ä¼šè¢«è‡ªåŠ¨å½’ç±»ä¸º é«˜é¢‘è¯æ±‡ ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Quick and the dead&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cutoff_frequency&quot;</span><span class="punctuation">:</span> <span class="number">0.01</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ä»»ä½•è¯é¡¹å‡ºç°åœ¨æ–‡æ¡£ä¸­è¶…è¿‡1%ï¼Œè¢«è®¤ä¸ºæ˜¯é«˜é¢‘è¯ã€‚cutoff_frequency é…ç½®å¯ä»¥æŒ‡å®šä¸ºä¸€ä¸ªåˆ†æ•°ï¼ˆ 0.01 ï¼‰æˆ–è€…ä¸€ä¸ªæ­£æ•´æ•°ï¼ˆ 5 ï¼‰ã€‚</p>
<p>æ­¤æŸ¥è¯¢é€šè¿‡ cutoff_frequency é…ç½®ï¼Œå°†æŸ¥è¯¢æ¡ä»¶åˆ’åˆ†ä¸ºä½é¢‘ç»„ï¼ˆ quick , dead ï¼‰å’Œé«˜é¢‘ç»„ï¼ˆ and , the ï¼‰ã€‚ç„¶åï¼Œæ­¤æŸ¥è¯¢ä¼šè¢«é‡å†™ä¸ºä»¥ä¸‹çš„ bool æŸ¥è¯¢ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quick&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dead&quot;</span>  <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;and&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;the&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="åœç”¨è¯ä¸çŸ­è¯­æŸ¥è¯¢"><a href="#åœç”¨è¯ä¸çŸ­è¯­æŸ¥è¯¢" class="headerlink" title="åœç”¨è¯ä¸çŸ­è¯­æŸ¥è¯¢"></a>åœç”¨è¯ä¸çŸ­è¯­æŸ¥è¯¢</h3><p>ä¸€ä¸ªå…¸å‹çš„ç´¢å¼•ä¼šå¯èƒ½åŒ…å«éƒ¨åˆ†æˆ–æ‰€æœ‰ä»¥ä¸‹æ•°æ®ï¼š</p>
<p>è¯é¡¹å­—å…¸ï¼ˆTerms dictionaryï¼‰<br>ç´¢å¼•ä¸­æ‰€æœ‰æ–‡æ¡£å†…æ‰€æœ‰è¯é¡¹çš„æœ‰åºåˆ—è¡¨ï¼Œä»¥åŠåŒ…å«è¯¥è¯çš„æ–‡æ¡£æ•°é‡ã€‚<br>å€’æ’è¡¨ï¼ˆPostings listï¼‰<br>åŒ…å«æ¯ä¸ªè¯é¡¹çš„æ–‡æ¡£ï¼ˆIDï¼‰åˆ—è¡¨ã€‚<br>è¯é¢‘ï¼ˆTerm frequencyï¼‰<br>æ¯ä¸ªè¯é¡¹åœ¨æ¯ä¸ªæ–‡æ¡£é‡Œå‡ºç°çš„é¢‘ç‡ã€‚<br>ä½ç½®ï¼ˆPositionsï¼‰<br>æ¯ä¸ªè¯é¡¹åœ¨æ¯ä¸ªæ–‡æ¡£é‡Œå‡ºç°çš„ä½ç½®ï¼Œä¾›çŸ­è¯­æŸ¥è¯¢æˆ–è¿‘ä¼¼æŸ¥è¯¢ä½¿ç”¨ã€‚<br>åç§»ï¼ˆOffsetsï¼‰<br>æ¯ä¸ªè¯é¡¹åœ¨æ¯ä¸ªæ–‡æ¡£é‡Œå¼€å§‹ä¸ç»“æŸå­—ç¬¦çš„åç§»ï¼Œä¾›è¯è¯­é«˜äº®ä½¿ç”¨ï¼Œé»˜è®¤æ˜¯ç¦ç”¨çš„ã€‚<br>è§„èŒƒå› å­ï¼ˆNormsï¼‰<br>ç”¨æ¥å¯¹å­—æ®µé•¿åº¦è¿›è¡Œè§„èŒƒåŒ–å¤„ç†çš„å› å­ï¼Œç»™è¾ƒçŸ­å­—æ®µäºˆä»¥æ›´å¤šæƒé‡ã€‚</p>
<p>æˆ‘ä»¬é¦–å…ˆåº”è¯¥é—®è‡ªå·±ï¼šæ˜¯å¦çœŸçš„éœ€è¦ä½¿ç”¨çŸ­è¯­æŸ¥è¯¢ æˆ– è¿‘ä¼¼æŸ¥è¯¢ ï¼Ÿ</p>
<p>ç­”æ¡ˆé€šå¸¸æ˜¯ï¼šä¸éœ€è¦ã€‚åœ¨å¾ˆå¤šåº”ç”¨åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚è¯´æ—¥å¿—ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªè¯ æ˜¯å¦ åœ¨æ–‡æ¡£ä¸­ï¼ˆè¿™ä¸ªä¿¡æ¯ç”±å€’æ’è¡¨æä¾›ï¼‰è€Œä¸æ˜¯å…³å¿ƒè¯çš„ä½ç½®åœ¨å“ªé‡Œã€‚æˆ–è®¸æˆ‘ä»¬è¦å¯¹ä¸€ä¸¤ä¸ªå­—æ®µä½¿ç”¨çŸ­è¯­æŸ¥è¯¢ï¼Œä½†æ˜¯æˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨å…¶ä»– analyzed å­—ç¬¦ä¸²å­—æ®µä¸Šç¦ç”¨ä½ç½®ä¿¡æ¯ã€‚</p>
<p>index_options å‚æ•° å…è®¸æˆ‘ä»¬æ§åˆ¶ç´¢å¼•é‡Œä¸ºæ¯ä¸ªå­—æ®µå­˜å‚¨çš„ä¿¡æ¯ã€‚ å¯é€‰å€¼å¦‚ä¸‹:</p>
<p>docs<br>åªå­˜å‚¨æ–‡æ¡£åŠå…¶åŒ…å«è¯é¡¹çš„ä¿¡æ¯ã€‚è¿™å¯¹ not_analyzed å­—ç¬¦ä¸²å­—æ®µæ˜¯é»˜è®¤çš„ã€‚<br>freqs<br>å­˜å‚¨ docs ä¿¡æ¯ï¼Œä»¥åŠæ¯ä¸ªè¯åœ¨æ¯ä¸ªæ–‡æ¡£é‡Œå‡ºç°çš„é¢‘æ¬¡ã€‚è¯é¢‘æ˜¯å®ŒæˆTF&#x2F;IDF ç›¸å…³åº¦è®¡ç®—çš„å¿…è¦æ¡ä»¶ï¼Œä½†å¦‚æœåªæƒ³çŸ¥é“ä¸€ä¸ªæ–‡æ¡£æ˜¯å¦åŒ…å«æŸä¸ªç‰¹å®šè¯é¡¹ï¼Œåˆ™æ— éœ€ä½¿ç”¨å®ƒã€‚<br>positions<br>å­˜å‚¨ docs ã€ freqs ã€ analyzed ï¼Œä»¥åŠæ¯ä¸ªè¯é¡¹åœ¨æ¯ä¸ªæ–‡æ¡£é‡Œå‡ºç°çš„ä½ç½®ã€‚ è¿™å¯¹ analyzed å­—ç¬¦ä¸²å­—æ®µæ˜¯é»˜è®¤çš„ï¼Œä½†å½“ä¸éœ€ä½¿ç”¨çŸ­è¯­æˆ–è¿‘ä¼¼åŒ¹é…æ—¶ï¼Œå¯ä»¥å°†å…¶ç¦ç”¨ã€‚<br>offsets<br>å­˜å‚¨ docs,freqs,positions, ä»¥åŠæ¯ä¸ªè¯åœ¨åŸå§‹å­—ç¬¦ä¸²ä¸­å¼€å§‹ä¸ç»“æŸå­—ç¬¦çš„åç§»ä¿¡æ¯( postings highlighter )ã€‚è¿™ä¸ªä¿¡æ¯è¢«ç”¨ä»¥é«˜äº®æœç´¢ç»“æœï¼Œä½†å®ƒé»˜è®¤æ˜¯ç¦ç”¨çš„ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>          <span class="string">&quot;string&quot;</span></span><br><span class="line">       <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>          <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index_options&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freqs&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="common-grams-è¿‡æ»¤å™¨"><a href="#common-grams-è¿‡æ»¤å™¨" class="headerlink" title="common_grams è¿‡æ»¤å™¨"></a>common_grams è¿‡æ»¤å™¨</h3><p>common_grams è¿‡æ»¤å™¨æ˜¯é’ˆå¯¹çŸ­è¯­æŸ¥è¯¢èƒ½æ›´é«˜æ•ˆçš„ä½¿ç”¨åœç”¨è¯è€Œè®¾è®¡çš„ã€‚</p>
<h3 id="åœç”¨è¯ä¸ç›¸å…³æ€§"><a href="#åœç”¨è¯ä¸ç›¸å…³æ€§" class="headerlink" title="åœç”¨è¯ä¸ç›¸å…³æ€§"></a>åœç”¨è¯ä¸ç›¸å…³æ€§</h3><p>åœ¨ç´¢å¼•ä¸­ä¿ç•™åœç”¨è¯ä¼šé™ä½ç›¸å…³åº¦è®¡ç®—çš„å‡†ç¡®æ€§ï¼Œç‰¹åˆ«æ˜¯å½“æˆ‘ä»¬çš„æ–‡æ¡£éå¸¸é•¿æ—¶ã€‚<br>åŸºäºé€†æ–‡æ¡£é¢‘ç‡çš„å½±å“ï¼Œéå¸¸å¸¸ç”¨çš„è¯å¯èƒ½åªæœ‰å¾ˆä½çš„æƒé‡ï¼Œä½†æ˜¯åœ¨é•¿æ–‡æ¡£ä¸­ï¼Œå•ä¸ªæ–‡æ¡£å‡ºç°çš„ç»å¯¹æ•°é‡å¾ˆå¤§çš„åœç”¨è¯ä¼šå¯¼è‡´è¿™äº›è¯è¢«ä¸è‡ªç„¶çš„åŠ æƒã€‚</p>
<h2 id="åŒä¹‰è¯"><a href="#åŒä¹‰è¯" class="headerlink" title="åŒä¹‰è¯"></a>åŒä¹‰è¯</h2><p>&#x2F;&#x2F;TODO</p>
<h3 id="æ‹¼å†™é”™è¯¯-æ¨¡ç³ŠæŸ¥è¯¢"><a href="#æ‹¼å†™é”™è¯¯-æ¨¡ç³ŠæŸ¥è¯¢" class="headerlink" title="æ‹¼å†™é”™è¯¯(æ¨¡ç³ŠæŸ¥è¯¢)"></a>æ‹¼å†™é”™è¯¯(æ¨¡ç³ŠæŸ¥è¯¢)</h3><p>&#x2F;&#x2F;TODO</p>
<h1 id="èšåˆ-1"><a href="#èšåˆ-1" class="headerlink" title="èšåˆ"></a>èšåˆ</h1><h2 id="é«˜é˜¶æ¦‚å¿µ"><a href="#é«˜é˜¶æ¦‚å¿µ" class="headerlink" title="é«˜é˜¶æ¦‚å¿µ"></a>é«˜é˜¶æ¦‚å¿µ</h2><p>è¦æŒæ¡èšåˆï¼Œä½ åªéœ€è¦æ˜ç™½ä¸¤ä¸ªä¸»è¦çš„æ¦‚å¿µï¼š</p>
<p>æ¡¶ï¼ˆBucketsï¼‰<br>æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„æ–‡æ¡£çš„é›†åˆ<br>æŒ‡æ ‡ï¼ˆMetricsï¼‰<br>å¯¹æ¡¶å†…çš„æ–‡æ¡£è¿›è¡Œç»Ÿè®¡è®¡ç®—</p>
<h2 id="å°è¯•èšåˆ"><a href="#å°è¯•èšåˆ" class="headerlink" title="å°è¯•èšåˆ"></a>å°è¯•èšåˆ</h2><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;size&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;colors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;color&quot;</span></span><br><span class="line">         <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;avg_price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;price&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æ­£å¦‚æ‰€è§ï¼Œæˆ‘ä»¬ç”¨å‰é¢çš„ä¾‹å­åŠ å…¥äº†æ–°çš„ aggs å±‚ã€‚è¿™ä¸ªæ–°çš„èšåˆå±‚è®©æˆ‘ä»¬å¯ä»¥å°† avg åº¦é‡åµŒå¥—ç½®äº terms æ¡¶å†…ã€‚å®é™…ä¸Šï¼Œè¿™å°±ä¸ºæ¯ä¸ªé¢œè‰²ç”Ÿæˆäº†å¹³å‡ä»·æ ¼ã€‚</p>
<p>æ­£å¦‚ é¢œè‰² çš„ä¾‹å­ï¼Œæˆ‘ä»¬éœ€è¦ç»™åº¦é‡èµ·ä¸€ä¸ªåå­—ï¼ˆ avg_price ï¼‰è¿™æ ·å¯ä»¥ç¨åæ ¹æ®åå­—è·å–å®ƒçš„å€¼ã€‚æœ€åï¼Œæˆ‘ä»¬æŒ‡å®šåº¦é‡æœ¬èº«ï¼ˆ avg ï¼‰ä»¥åŠæˆ‘ä»¬æƒ³è¦è®¡ç®—å¹³å‡å€¼çš„å­—æ®µï¼ˆ price ï¼‰</p>
<p>åµŒå¥—æ¡¶</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;size&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;colors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;color&quot;</span></span><br><span class="line">         <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;avg_price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;price&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;make&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;terms&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;make&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;aggs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;min_price&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;price&quot;</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;max_price&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;price&quot;</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æ–°å¢çš„è¿™ä¸ª make èšåˆï¼Œå®ƒæ˜¯ä¸€ä¸ª terms æ¡¶ï¼ˆåµŒå¥—åœ¨ colors ã€ terms æ¡¶å†…ï¼‰ã€‚è¿™æ„å‘³ç€å®ƒ ä¼šä¸ºæ•°æ®é›†ä¸­çš„æ¯ä¸ªå”¯ä¸€ç»„åˆç”Ÿæˆï¼ˆ color ã€ make ï¼‰å…ƒç»„ã€‚</p>
<h2 id="æ¡å½¢å›¾"><a href="#æ¡å½¢å›¾" class="headerlink" title="æ¡å½¢å›¾"></a>æ¡å½¢å›¾</h2><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /cars/transactions/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;size&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;histogram&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;price&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="number">20000</span></span><br><span class="line">         <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;revenue&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;sum&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                 <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;price&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">             <span class="punctuation">&#125;</span></span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æˆ‘ä»¬æ‰€è§ï¼ŒæŸ¥è¯¢æ˜¯å›´ç»• price èšåˆæ„å»ºçš„ï¼Œå®ƒåŒ…å«ä¸€ä¸ª histogram æ¡¶ã€‚å®ƒè¦æ±‚å­—æ®µçš„ç±»å‹å¿…é¡»æ˜¯æ•°å€¼å‹çš„åŒæ—¶éœ€è¦è®¾å®šåˆ†ç»„çš„é—´éš”èŒƒå›´ã€‚ é—´éš”è®¾ç½®ä¸º 20,000 æ„å‘³ç€æˆ‘ä»¬å°†ä¼šå¾—åˆ°å¦‚ [0-19999, 20000-39999, â€¦] è¿™æ ·çš„åŒºé—´ã€‚</p>
<h2 id="Doc-Values-and-Fielddata"><a href="#Doc-Values-and-Fielddata" class="headerlink" title="Doc Values and Fielddata"></a>Doc Values and Fielddata</h2><p>Doc values å¯ä»¥ä½¿èšåˆæ›´å¿«ã€æ›´é«˜æ•ˆå¹¶ä¸”å†…å­˜å‹å¥½ã€‚<br>æ–‡æ¡£å€¼æ˜¯åœ¨ç´¢å¼•æ—¶ä¸å€’æ’ç´¢å¼•åŒæ—¶äº§ç”Ÿçš„ã€‚ä¹Ÿå°±æ˜¯è¯´æ–‡æ¡£å€¼æ˜¯æŒ‰æ®µæ¥äº§ç”Ÿçš„å¹¶ä¸”æ˜¯ä¸å¯å˜çš„ï¼Œæ­£å¦‚ç”¨äºæœç´¢çš„å€’æ’ç´¢å¼•ä¸€æ ·ã€‚ åŒæ ·ï¼Œå’Œå€’æ’ç´¢å¼•ä¸€æ ·ï¼Œæ–‡æ¡£å€¼ä¹Ÿåºåˆ—åŒ–åˆ°ç£ç›˜ã€‚è¿™äº›å¯¹äºæ€§èƒ½å’Œä¼¸ç¼©æ€§å¾ˆé‡è¦ã€‚</p>
<p>&#x3D;&#x3D;æ–‡æ¡£å€¼é»˜è®¤å¯¹æ‰€æœ‰å­—æ®µå¯ç”¨ï¼Œé™¤äº†åˆ†æå­—ç¬¦ç±»å‹å­—æ®µã€‚ä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„æ•°å­—ã€åœ°ç†åæ ‡ã€æ—¥æœŸã€IP å’Œä¸åˆ†æï¼ˆ not_analyzed ï¼‰å­—ç¬¦ç±»å‹ã€‚&#x3D;&#x3D;</p>
<p>å­—æ®µ â€œsession_idâ€ ç¦ç”¨äº†æ–‡æ¡£å€¼ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;session_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>       <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span>      <span class="string">&quot;not_analyzed&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="åœ°ç†ä½ç½®"><a href="#åœ°ç†ä½ç½®" class="headerlink" title="åœ°ç†ä½ç½®"></a>åœ°ç†ä½ç½®</h1><p>&#x2F;&#x2F;TODO</p>
<blockquote>
<p>Blockquote</p>
</blockquote>
<h1 id="æ•°æ®å»ºæ¨¡"><a href="#æ•°æ®å»ºæ¨¡" class="headerlink" title="æ•°æ®å»ºæ¨¡"></a>æ•°æ®å»ºæ¨¡</h1><h2 id="å…³è”å…³ç³»å¤„ç†"><a href="#å…³è”å…³ç³»å¤„ç†" class="headerlink" title="å…³è”å…³ç³»å¤„ç†"></a>å…³è”å…³ç³»å¤„ç†</h2><p> ä»¥ä¸‹å››ç§å¸¸ç”¨çš„æ–¹æ³•ï¼Œç”¨æ¥åœ¨ Elasticsearch ä¸­è¿›è¡Œå…³ç³»å‹æ•°æ®çš„ç®¡ç†ï¼š</p>
<p>Application-side joins<br>Data denormalization<br>Nested objects<br>Parent&#x2F;child relationships</p>
<p>å½“éè§„èŒƒåŒ–æˆä¸ºå¾ˆå¤šé¡¹ç›®çš„ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œé‡‡ç”¨é”æ–¹æ¡ˆçš„éœ€æ±‚ä¼šå¸¦æ¥å¤æ‚çš„å®ç°é€»è¾‘ã€‚ ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆï¼ŒElasticsearch æä¾›ä¸¤ä¸ªæ¨¡å‹å¸®åŠ©æˆ‘ä»¬å¤„ç†ç›¸å…³è”çš„å®ä½“ï¼š åµŒå¥—çš„å¯¹è±¡ å’Œ çˆ¶å­å…³ç³» ã€‚</p>
<h2 id="åµŒå¥—å¯¹è±¡"><a href="#åµŒå¥—å¯¹è±¡" class="headerlink" title="åµŒå¥—å¯¹è±¡"></a>åµŒå¥—å¯¹è±¡</h2><p>åµŒå¥—å¯¹è±¡ å°±æ˜¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚å°† comments å­—æ®µç±»å‹è®¾ç½®ä¸º nested è€Œä¸æ˜¯ object å,æ¯ä¸€ä¸ªåµŒå¥—å¯¹è±¡éƒ½ä¼šè¢«ç´¢å¼•ä¸ºä¸€ä¸ª éšè—çš„ç‹¬ç«‹æ–‡æ¡£ ,ä¸¾ä¾‹å¦‚ä¸‹:</p>
<p>{<br>  â€œcomments.nameâ€:    [ john, smith ],<br>  â€œcomments.commentâ€: [ article, great ],<br>  â€œcomments.ageâ€:     [ 28 ],<br>  â€œcomments.starsâ€:   [ 4 ],<br>  â€œcomments.dateâ€:    [ 2014-09-01 ]<br>}<br>{<br>  â€œcomments.nameâ€:    [ alice, white ],<br>  â€œcomments.commentâ€: [ like, more, please, this ],<br>  â€œcomments.ageâ€:     [ 31 ],<br>  â€œcomments.starsâ€:   [ 5 ],<br>  â€œcomments.dateâ€:    [ 2014-10-22 ]<br>}<br>{<br>  â€œtitleâ€:            [ eggs, nest ],<br>  â€œbodyâ€:             [ making, money, work, your ],<br>  â€œtagsâ€:             [ cash, shares ]<br>}</p>
<p>è®¾ç½®ä¸€ä¸ªå­—æ®µä¸º nested å¾ˆç®€å•â€‰â€”â€‰ ä½ åªéœ€è¦å°†å­—æ®µç±»å‹ object æ›¿æ¢ä¸º nested å³å¯ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;blogpost&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;comments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nested&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span>  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;comment&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span>  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span>     <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span>   <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stars&quot;</span><span class="punctuation">:</span>   <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span>   <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span>    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span>    <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ç”±äºåµŒå¥—å¯¹è±¡ è¢«ç´¢å¼•åœ¨ç‹¬ç«‹éšè—çš„æ–‡æ¡£ä¸­ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥æŸ¥è¯¢å®ƒä»¬ã€‚ ç›¸åº”åœ°ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨ nested æŸ¥è¯¢ å»è·å–å®ƒä»¬ï¼š<br>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ¹æ–‡æ¡£çš„åˆ†æ•°æ˜¯è¿™äº›åµŒå¥—æ–‡æ¡£åˆ†æ•°çš„å¹³å‡å€¼ã€‚å¯ä»¥é€šè¿‡è®¾ç½® score_mode å‚æ•°æ¥æ§åˆ¶è¿™ä¸ªå¾—åˆ†ç­–ç•¥ï¼Œç›¸å…³ç­–ç•¥æœ‰ avg (å¹³å‡å€¼), max (æœ€å¤§å€¼), sum (åŠ å’Œ) å’Œ none (ç›´æ¥è¿”å› 1.0 å¸¸æ•°å€¼åˆ†æ•°)ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /my_index/blogpost/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eggs&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;comments&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;score_mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;max&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;comments.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;john&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;comments.age&quot;</span><span class="punctuation">:</span> <span class="number">28</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨åµŒå¥—å­—æ®µæ’åº"><a href="#ä½¿ç”¨åµŒå¥—å­—æ®µæ’åº" class="headerlink" title="ä½¿ç”¨åµŒå¥—å­—æ®µæ’åº"></a>ä½¿ç”¨åµŒå¥—å­—æ®µæ’åº</h3><p>å‡å¦‚æˆ‘ä»¬æƒ³è¦æŸ¥è¯¢åœ¨10æœˆä»½æ”¶åˆ°è¯„è®ºçš„åšå®¢æ–‡ç« ï¼Œå¹¶ä¸”æŒ‰ç…§ stars æ•°çš„æœ€å°å€¼æ¥ç”±å°åˆ°å¤§æ’åºï¼Œé‚£ä¹ˆæŸ¥è¯¢è¯­å¥å¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;comments&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;comments.date&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2014-10-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lt&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;2014-11-01&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;comments.stars&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;min&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nested_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;comments&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nested_filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;comments.date&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2014-10-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lt&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;2014-11-01&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


<p>æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ç”¨ nested_path å’Œ nested_filter é‡å¤æŸ¥è¯¢æ¡ä»¶å‘¢ï¼ŸåŸå› åœ¨äºï¼Œæ’åºå‘ç”Ÿåœ¨æŸ¥è¯¢æ‰§è¡Œä¹‹åã€‚ æŸ¥è¯¢æ¡ä»¶é™å®šäº†åªåœ¨10æœˆä»½æ”¶åˆ°è¯„è®ºçš„åšå®¢æ–‡æ¡£ï¼Œä½†è¿”å›æ•´ä¸ªåšå®¢æ–‡æ¡£ã€‚å¦‚æœæˆ‘ä»¬ä¸åœ¨æ’åºå­å¥ä¸­åŠ å…¥ nested_filter ï¼Œ é‚£ä¹ˆæˆ‘ä»¬å¯¹åšå®¢æ–‡æ¡£çš„æ’åºå°†åŸºäºåšå®¢æ–‡æ¡£çš„æ‰€æœ‰è¯„è®ºï¼Œè€Œä¸æ˜¯ä»…ä»…åœ¨10æœˆä»½æ¥æ”¶åˆ°çš„è¯„è®ºã€‚</p>
<h2 id="çˆ¶å­å…³ç³»æ–‡æ¡£"><a href="#çˆ¶å­å…³ç³»æ–‡æ¡£" class="headerlink" title="çˆ¶å­å…³ç³»æ–‡æ¡£"></a>çˆ¶å­å…³ç³»æ–‡æ¡£</h2><p>ä¸ nested objects ç›¸æ¯”ï¼Œçˆ¶-å­å…³ç³»çš„ä¸»è¦ä¼˜åŠ¿æœ‰ï¼š</p>
<p>æ›´æ–°çˆ¶æ–‡æ¡£æ—¶ï¼Œä¸ä¼šé‡æ–°ç´¢å¼•å­æ–‡æ¡£ã€‚<br>åˆ›å»ºï¼Œä¿®æ”¹æˆ–åˆ é™¤å­æ–‡æ¡£æ—¶ï¼Œä¸ä¼šå½±å“çˆ¶æ–‡æ¡£æˆ–å…¶ä»–å­æ–‡æ¡£ã€‚è¿™ä¸€ç‚¹åœ¨è¿™ç§åœºæ™¯ä¸‹å°¤å…¶æœ‰ç”¨ï¼šå­æ–‡æ¡£æ•°é‡è¾ƒå¤šï¼Œå¹¶ä¸”å­æ–‡æ¡£åˆ›å»ºå’Œä¿®æ”¹çš„é¢‘ç‡é«˜æ—¶ã€‚<br>å­æ–‡æ¡£å¯ä»¥ä½œä¸ºæœç´¢ç»“æœç‹¬ç«‹è¿”å›ã€‚<br>Elasticsearch ç»´æŠ¤äº†ä¸€ä¸ªçˆ¶æ–‡æ¡£å’Œå­æ–‡æ¡£çš„æ˜ å°„å…³ç³»ï¼Œå¾—ç›Šäºè¿™ä¸ªæ˜ å°„ï¼Œçˆ¶-å­æ–‡æ¡£å…³è”æŸ¥è¯¢æ“ä½œéå¸¸å¿«ã€‚ä½†æ˜¯è¿™ä¸ªæ˜ å°„ä¹Ÿå¯¹çˆ¶-å­æ–‡æ¡£å…³ç³»æœ‰ä¸ªé™åˆ¶æ¡ä»¶ï¼šçˆ¶æ–‡æ¡£å’Œå…¶æ‰€æœ‰å­æ–‡æ¡£ï¼Œéƒ½å¿…é¡»è¦å­˜å‚¨åœ¨åŒä¸€ä¸ªåˆ†ç‰‡ä¸­ã€‚</p>
<p>&#x3D;&#x3D;å½“æ–‡æ¡£ç´¢å¼•æ€§èƒ½è¿œæ¯”æŸ¥è¯¢æ€§èƒ½é‡è¦ çš„æ—¶å€™ï¼Œçˆ¶å­å…³ç³»æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œä½†æ˜¯å®ƒä¹Ÿæ˜¯æœ‰å·¨å¤§ä»£ä»·çš„ã€‚å…¶æŸ¥è¯¢é€Ÿåº¦ä¼šæ¯”åŒç­‰çš„åµŒå¥—æŸ¥è¯¢æ…¢5åˆ°10å€!&#x3D;&#x3D;</p>
<p><strong>å½“ä½ è€ƒè™‘çˆ¶å­å…³ç³»æ˜¯å¦é€‚åˆä½ ç°æœ‰å…³ç³»æ¨¡å‹æ—¶ï¼Œè¯·è€ƒè™‘ä¸‹é¢è¿™äº›å»ºè®® ï¼š</strong></p>
<p><strong>å°½é‡å°‘åœ°ä½¿ç”¨çˆ¶å­å…³ç³»</strong>ï¼Œä»…åœ¨å­æ–‡æ¡£è¿œå¤šäºçˆ¶æ–‡æ¡£æ—¶ä½¿ç”¨ã€‚<br>é¿å…åœ¨ä¸€ä¸ªæŸ¥è¯¢ä¸­ä½¿ç”¨å¤šä¸ªçˆ¶å­è”åˆè¯­å¥ã€‚<br>åœ¨ has_child æŸ¥è¯¢ä¸­ä½¿ç”¨ filter ä¸Šä¸‹æ–‡ï¼Œæˆ–è€…è®¾ç½® score_mode ä¸º none æ¥é¿å…è®¡ç®—æ–‡æ¡£å¾—åˆ†ã€‚<br>ä¿è¯çˆ¶ IDs å°½é‡çŸ­ï¼Œä»¥ä¾¿åœ¨ doc values ä¸­æ›´å¥½åœ°å‹ç¼©ï¼Œè¢«ä¸´æ—¶è½½å…¥æ—¶å ç”¨æ›´å°‘çš„å†…å­˜ã€‚<br>æœ€é‡è¦çš„æ˜¯: å…ˆè€ƒè™‘ä¸‹æˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡çš„å…¶ä»–æ–¹å¼æ¥è¾¾åˆ°çˆ¶å­å…³ç³»çš„æ•ˆæœã€‚</p>
<h2 id="æ‰©å®¹è®¾è®¡"><a href="#æ‰©å®¹è®¾è®¡" class="headerlink" title="æ‰©å®¹è®¾è®¡"></a>æ‰©å®¹è®¾è®¡</h2><p>å‰¯æœ¬åˆ†ç‰‡ä¸ä¸»åˆ†ç‰‡åšç€ç›¸åŒçš„å·¥ä½œï¼›å®ƒä»¬åªæ˜¯æ‰®æ¼”ç€ç•¥å¾®ä¸åŒçš„è§’è‰²ã€‚æ²¡æœ‰å¿…è¦ç¡®ä¿ä¸»åˆ†ç‰‡å‡åŒ€åœ°åˆ†å¸ƒåœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸­ã€‚<br>PS:ä¸»åˆ†ç‰‡æ•°&gt;&#x3D;èŠ‚ç‚¹æ•°ï¼Œå¤§äºæ˜¯é¢„ç•™ç»™èŠ‚ç‚¹æ•°çš„æ‰©å……ã€‚</p>
<p>ä½¿ç”¨ç´¢å¼•åˆ«åæ¥æŒ‡å‘å½“å‰ç‰ˆæœ¬çš„ç´¢å¼•ã€‚ ä¸¾ä¾‹æ¥è¯´ï¼Œç»™ä½ çš„ç´¢å¼•å‘½åä¸º tweets_v1 è€Œä¸æ˜¯ tweets ã€‚ä½ çš„åº”ç”¨ç¨‹åºä¼šä¸ tweets è¿›è¡Œäº¤äº’ï¼Œä½†äº‹å®ä¸Šå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘ tweets_v1 çš„åˆ«åã€‚ è¿™å…è®¸ä½ å°†åˆ«ååˆ‡æ¢è‡³ä¸€ä¸ªæ›´æ–°ç‰ˆæœ¬çš„ç´¢å¼•è€Œä¿æŒæœåŠ¡è¿è½¬ã€‚</p>
<p>ä¸€ä¸ªæœç´¢è¯·æ±‚å¯ä»¥ä»¥å¤šä¸ªç´¢å¼•ä¸ºç›®æ ‡ï¼Œæ‰€ä»¥å°†æœç´¢åˆ«åæŒ‡å‘ tweets_1 ä»¥åŠ tweets_2 æ˜¯å®Œå…¨æœ‰æ•ˆçš„ã€‚ ç„¶è€Œï¼Œç´¢å¼•å†™å…¥è¯·æ±‚åªèƒ½ä»¥å•ä¸ªç´¢å¼•ä¸ºç›®æ ‡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»å°†ç´¢å¼•å†™å…¥çš„åˆ«ååªæŒ‡å‘æ–°çš„ç´¢å¼•ã€‚<br>PUT &#x2F;tweets_1&#x2F;_alias&#x2F;tweets_search<br>PUT &#x2F;tweets_1&#x2F;_alias&#x2F;tweets_index<br>POST &#x2F;_aliases<br>{<br>  â€œactionsâ€: [<br>    { â€œaddâ€:    { â€œindexâ€: â€œtweets_2â€, â€œaliasâ€: â€œtweets_searchâ€ }},<br>    { â€œremoveâ€: { â€œindexâ€: â€œtweets_1â€, â€œaliasâ€: â€œtweets_indexâ€  }},<br>    { â€œaddâ€:    { â€œindexâ€: â€œtweets_2â€, â€œaliasâ€: â€œtweets_indexâ€  }}<br>  ]<br>}<br>ä¸€ä¸ªæ–‡æ¡£ GET è¯·æ±‚ï¼Œåƒä¸€ä¸ªç´¢å¼•å†™å…¥è¯·æ±‚é‚£æ ·ï¼Œåªèƒ½ä»¥å•ä¸ªç´¢å¼•ä¸ºç›®æ ‡ã€‚ è¿™å¯¼è‡´åœ¨é€šè¿‡IDè·å–æ–‡æ¡£è¿™æ ·çš„åœºæ™¯ä¸‹æœ‰ä¸€ç‚¹å¤æ‚ã€‚ä½œä¸ºä»£æ›¿ï¼Œä½ å¯ä»¥å¯¹ tweets_1 ä»¥åŠ tweets_2 è¿è¡Œä¸€ä¸ª ids æŸ¥è¯¢ æœç´¢è¯·æ±‚ï¼Œ æˆ–è€… multi-get è¯·æ±‚ã€‚</p>
<p>æŒ‰æ—¶é—´èŒƒå›´ç´¢å¼•</p>
<p>POST &#x2F;_aliases<br>{<br>  â€œactionsâ€: [<br>    { â€œaddâ€:    { â€œaliasâ€: â€œlogs_currentâ€,  â€œindexâ€: â€œlogs_2014-10â€ }},<br>    { â€œremoveâ€: { â€œaliasâ€: â€œlogs_currentâ€,  â€œindexâ€: â€œlogs_2014-09â€ }},<br>    { â€œaddâ€:    { â€œaliasâ€: â€œlast_3_monthsâ€, â€œindexâ€: â€œlogs_2014-10â€ }},<br>    { â€œremoveâ€: { â€œaliasâ€: â€œlast_3_monthsâ€, â€œindexâ€: â€œlogs_2014-07â€ }}<br>  ]<br>}</p>
<h3 id="ç´¢å¼•æ¨¡æ¿"><a href="#ç´¢å¼•æ¨¡æ¿" class="headerlink" title="ç´¢å¼•æ¨¡æ¿"></a>ç´¢å¼•æ¨¡æ¿</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /_template/my_logs</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;template&quot;</span><span class="punctuation">:</span> <span class="string">&quot;logstash-*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span>    <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_default_&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;last_3_months&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ¨¡æ¿æŒ‡å®šäº†æ‰€æœ‰åå­—ä»¥ logstash- ä¸ºèµ·å§‹çš„ç´¢å¼•çš„é»˜è®¤è®¾ç½®ï¼Œä¸è®ºå®ƒæ˜¯æ‰‹åŠ¨è¿˜æ˜¯è‡ªåŠ¨åˆ›å»ºçš„ã€‚ å¦‚æœæˆ‘ä»¬è®¤ä¸ºæ˜å¤©çš„ç´¢å¼•éœ€è¦æ¯”ä»Šå¤©æ›´å¤§çš„å®¹é‡ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°è¿™ä¸ªç´¢å¼•ä»¥ä½¿ç”¨æ›´å¤šçš„åˆ†ç‰‡ã€‚</p>
<p>è¿™ä¸ªæ¨¡æ¿è¿˜å°†æ–°å»ºç´¢å¼•æ·»åŠ è‡³äº† last_3_months åˆ«åä¸­ï¼Œç„¶è€Œä»é‚£ä¸ªåˆ«åä¸­åˆ é™¤æ—§çš„ç´¢å¼•åˆ™éœ€è¦æ‰‹åŠ¨æ‰§è¡Œã€‚</p>
<h3 id="æ•°æ®è¿‡æœŸ"><a href="#æ•°æ®è¿‡æœŸ" class="headerlink" title="æ•°æ®è¿‡æœŸ"></a>æ•°æ®è¿‡æœŸ</h3><p>åˆ é™¤æ•´ä¸ªç´¢å¼•æ¯”åˆ é™¤å•ä¸ªæ–‡æ¡£è¦æ›´åŠ é«˜æ•ˆï¼šElasticsearch åªéœ€è¦åˆ é™¤æ•´ä¸ªæ–‡ä»¶å¤¹ã€‚</p>
<p>è¿™äº›ç´¢å¼•å¯ä»¥è¢«å…³é—­ã€‚å®ƒä»¬è¿˜ä¼šå­˜åœ¨äºé›†ç¾¤ä¸­ï¼Œä½†å®ƒä»¬ä¸ä¼šæ¶ˆè€—ç£ç›˜ç©ºé—´ä»¥å¤–çš„èµ„æºã€‚é‡æ–°æ‰“å¼€ä¸€ä¸ªç´¢å¼•è¦æ¯”ä»å¤‡ä»½ä¸­æ¢å¤å¿«å¾—å¤šã€‚<br>åœ¨å…³é—­ä¹‹å‰ï¼Œå€¼å¾—æˆ‘ä»¬å»åˆ·å†™ç´¢å¼•æ¥ç¡®ä¿æ²¡æœ‰äº‹åŠ¡æ®‹ç•™åœ¨äº‹åŠ¡æ—¥å¿—ä¸­ã€‚ä¸€ä¸ªç©ºç™½çš„äº‹åŠ¡æ—¥å¿—ä¼šä½¿å¾—ç´¢å¼•åœ¨é‡æ–°æ‰“å¼€æ—¶æ¢å¤å¾—æ›´å¿«ï¼š<br>POST &#x2F;logs_2014-01-<em>&#x2F;_flush<br>POST &#x2F;logs_2014-01-</em>&#x2F;_close<br>POST &#x2F;logs_2014-01-*&#x2F;_open</p>
<h3 id="æ‰©å®¹å¹¶ä¸æ˜¯æ— é™çš„"><a href="#æ‰©å®¹å¹¶ä¸æ˜¯æ— é™çš„" class="headerlink" title="æ‰©å®¹å¹¶ä¸æ˜¯æ— é™çš„"></a>æ‰©å®¹å¹¶ä¸æ˜¯æ— é™çš„</h3><p>éœ€è¦è®°ä½çš„æ˜¯ç›¸åŒçš„æ•°æ®ç»“æ„éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„å†…å­˜ä¸­ä¿å­˜ï¼Œå¹¶ä¸”å½“å®ƒå‘ç”Ÿæ›´æ”¹æ—¶å¿…é¡»å‘å¸ƒåˆ°æ¯ä¸€ä¸ªèŠ‚ç‚¹ã€‚ é›†ç¾¤çŠ¶æ€çš„æ•°æ®é‡è¶Šå¤§ï¼Œè¿™ä¸ªæ“ä½œå°±ä¼šè¶Šä¹…ã€‚</p>
<h1 id="ç®¡ç†ã€ç›‘æ§å’Œéƒ¨ç½²"><a href="#ç®¡ç†ã€ç›‘æ§å’Œéƒ¨ç½²" class="headerlink" title="ç®¡ç†ã€ç›‘æ§å’Œéƒ¨ç½²"></a>ç®¡ç†ã€ç›‘æ§å’Œéƒ¨ç½²</h1><h2 id="ç›‘æ§"><a href="#ç›‘æ§" class="headerlink" title="ç›‘æ§"></a>ç›‘æ§</h2><p>X-Pack</p>
<h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><h3 id="Transport-Client-ä¸-Node-Client"><a href="#Transport-Client-ä¸-Node-Client" class="headerlink" title="Transport Client ä¸ Node Client"></a>Transport Client ä¸ Node Client</h3><p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Javaï¼Œä½ å¯èƒ½æƒ³çŸ¥é“ä½•æ—¶ä½¿ç”¨ä¼ è¾“å®¢æˆ·ç«¯ï¼ˆæ³¨ï¼šTransport Clientï¼Œä¸‹åŒï¼‰ä¸èŠ‚ç‚¹å®¢æˆ·ç«¯ï¼ˆæ³¨ï¼šNode Clientï¼Œä¸‹åŒï¼‰ã€‚ åœ¨ä¹¦çš„å¼€å¤´æ‰€è¿°ï¼Œ ä¼ è¾“å®¢æˆ·ç«¯ä½œä¸ºä¸€ä¸ªé›†ç¾¤å’Œåº”ç”¨ç¨‹åºä¹‹é—´çš„é€šä¿¡å±‚ã€‚å®ƒçŸ¥é“ API å¹¶èƒ½è‡ªåŠ¨å¸®ä½ åœ¨èŠ‚ç‚¹ä¹‹é—´è½®è¯¢ï¼Œå¸®ä½ å—…æ¢é›†ç¾¤ç­‰ç­‰ã€‚ä½†å®ƒæ˜¯é›†ç¾¤ å¤–éƒ¨çš„ ï¼Œå’Œ REST å®¢æˆ·ç«¯ç±»ä¼¼ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼ŒèŠ‚ç‚¹å®¢æˆ·ç«¯ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªé›†ç¾¤ä¸­çš„èŠ‚ç‚¹ï¼ˆä½†ä¸ä¿å­˜æ•°æ®ï¼Œä¸èƒ½æˆä¸ºä¸»èŠ‚ç‚¹ï¼‰ã€‚å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒçŸ¥é“æ•´ä¸ªé›†ç¾¤çŠ¶æ€ï¼ˆæ‰€æœ‰èŠ‚ç‚¹é©»ç•™ï¼Œåˆ†ç‰‡åˆ†å¸ƒåœ¨å“ªäº›èŠ‚ç‚¹ï¼Œç­‰ç­‰ï¼‰ã€‚ è¿™æ„å‘³ç€å®ƒå¯ä»¥æ‰§è¡Œ APIs ä½†å°‘äº†ä¸€ä¸ªç½‘ç»œè·ƒç‚¹ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªå®¢æˆ·ç«¯æ¡ˆä¾‹çš„ä½¿ç”¨æƒ…å†µï¼š</p>
<p>å¦‚æœè¦å°†åº”ç”¨ç¨‹åºå’Œ Elasticsearch é›†ç¾¤è¿›è¡Œè§£è€¦ï¼Œä¼ è¾“å®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªç†æƒ³çš„é€‰æ‹©ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºéœ€è¦å¿«é€Ÿçš„åˆ›å»ºå’Œé”€æ¯åˆ°é›†ç¾¤çš„è¿æ¥ï¼Œä¼ è¾“å®¢æˆ·ç«¯æ¯”èŠ‚ç‚¹å®¢æˆ·ç«¯â€è½»â€ï¼Œå› ä¸ºå®ƒä¸æ˜¯ä¸€ä¸ªé›†ç¾¤çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>ç±»ä¼¼åœ°ï¼Œå¦‚æœæ‚¨éœ€è¦åˆ›å»ºæˆåƒä¸Šä¸‡çš„è¿æ¥ï¼Œä½ ä¸æƒ³æœ‰æˆåƒä¸Šä¸‡èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ã€‚ä¼ è¾“å®¢æˆ·ç«¯ï¼ˆ TC ï¼‰å°†æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ åªéœ€è¦æœ‰å°‘æ•°çš„ã€é•¿æœŸæŒä¹…çš„å¯¹è±¡è¿æ¥åˆ°é›†ç¾¤ï¼Œå®¢æˆ·ç«¯èŠ‚ç‚¹å¯ä»¥æ›´é«˜æ•ˆï¼Œå› ä¸ºå®ƒçŸ¥é“é›†ç¾¤çš„å¸ƒå±€ã€‚ä½†æ˜¯å®ƒä¼šä½¿ä½ çš„åº”ç”¨ç¨‹åºå’Œé›†ç¾¤è€¦åˆåœ¨ä¸€èµ·ï¼Œæ‰€ä»¥ä»é˜²ç«å¢™çš„è§’åº¦ï¼Œå®ƒå¯èƒ½ä¼šæ„æˆé—®é¢˜ã€‚</p>
<h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/cn/index.html">Elasticsearch: æƒå¨æŒ‡å—</a></p>
]]></content>
      <tags>
        <tag>ElasticSearch</tag>
        <tag>book</tag>
      </tags>
  </entry>
  <entry>
    <title>Spark API å…¨é›†(1):Spark SQL Dataset &amp; DataFrame API</title>
    <url>/2018/03/22/spark-sql-dataset-api/</url>
    <content><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>org.apache.spark.sql.Datasetæ˜¯Spark SQLä¸­æ ¸å¿ƒçš„ç±»ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dataset</span>[<span class="type">T</span>] <span class="keyword">extends</span> <span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure>

<p>DataFrameæ˜¯Dataset[Row]çš„åˆ«åã€‚</p>
<p>æœ¬æ–‡åŸºäºspark2.3.0.</p>
<p>ä¸‹é¢æ˜¯ç±»æ–¹æ³•ç®€ä»‹ã€‚</p>
<span id="more"></span>

<h1 id="ç±»æ–¹æ³•"><a href="#ç±»æ–¹æ³•" class="headerlink" title="ç±»æ–¹æ³•"></a>ç±»æ–¹æ³•</h1><h2 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h2><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">collect(): <span class="type">Array</span>[<span class="type">T</span>]</span><br><span class="line">è¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«<span class="type">Dataset</span>æ‰€æœ‰è¡Œçš„æ•°æ®ã€‚</span><br><span class="line">æ³¨æ„ï¼šæ‰€æœ‰æ•°æ®ä¼šè¢«åŠ è½½è¿›driverè¿›ç¨‹çš„å†…å­˜ã€‚</span><br><span class="line"></span><br><span class="line">collectAsList(): <span class="type">List</span>[<span class="type">T</span>]</span><br><span class="line">åŒä¸Šï¼Œä½†æ˜¯è¿”å›<span class="type">Java</span> listã€‚</span><br><span class="line"></span><br><span class="line">count(): <span class="type">Long</span></span><br><span class="line">æ•°æ®è¡Œæ•°</span><br><span class="line"></span><br><span class="line">describe(cols: <span class="type">String</span>*): <span class="type">DataFrame</span></span><br><span class="line">è®¡ç®—æŒ‡å®šåˆ—çš„ç»Ÿè®¡æŒ‡æ ‡ï¼ŒåŒ…æ‹¬count, mean, stddev, min, and max.</span><br><span class="line"></span><br><span class="line">head(): <span class="type">T</span></span><br><span class="line">è¿”å›ç¬¬ä¸€è¡Œ</span><br><span class="line"></span><br><span class="line">head(n: <span class="type">Int</span>): <span class="type">Array</span>[<span class="type">T</span>]</span><br><span class="line">è¿”å›å‰<span class="type">N</span>è¡Œ</span><br><span class="line"></span><br><span class="line">first(): <span class="type">T</span></span><br><span class="line">è¿”å›ç¬¬ä¸€è¡Œï¼Œæ˜¯head()çš„åˆ«åã€‚</span><br><span class="line"></span><br><span class="line">foreach(f: (<span class="type">T</span>) â‡’ <span class="type">Unit</span>): <span class="type">Unit</span></span><br><span class="line">æ‰€æœ‰å…ƒç´ ä¸Šåº”ç”¨få‡½æ•°</span><br><span class="line"></span><br><span class="line">foreachPartition(f: (<span class="type">Iterator</span>[<span class="type">T</span>]) â‡’ <span class="type">Unit</span>): <span class="type">Unit</span></span><br><span class="line">æ‰€æœ‰å…ƒç´ åˆ†åŒºä¸Šåº”ç”¨få‡½æ•°</span><br><span class="line"></span><br><span class="line">reduce(func: (<span class="type">T</span>, <span class="type">T</span>) â‡’ <span class="type">T</span>): <span class="type">T</span></span><br><span class="line">æ ¹æ®æ˜ å°„å‡½æ•°funcï¼Œå¯¹<span class="type">RDD</span>ä¸­çš„å…ƒç´ è¿›è¡ŒäºŒå…ƒè®¡ç®—ï¼Œè¿”å›è®¡ç®—ç»“æœã€‚</span><br><span class="line">æ³¨æ„ï¼šæä¾›çš„å‡½æ•°åº”æ»¡è¶³äº¤æ¢å¾‹åŠç»“åˆå¾‹ï¼Œå¦åˆ™è®¡ç®—ç»“æœå°†æ˜¯éç¡®å®šçš„ã€‚</span><br><span class="line"></span><br><span class="line">show(numRows: <span class="type">Int</span>, truncate: <span class="type">Int</span>, vertical: <span class="type">Boolean</span>): <span class="type">Unit</span></span><br><span class="line">è¡¨æ ¼å½¢å¼æ‰“å°å‡ºæ•°æ®ã€‚numRowsï¼šæ˜¾ç¤ºçš„è¡Œæ•°ï¼Œtruncateï¼šè£å‰ªå­—ç¬¦ä¸²ç±»å‹å€¼åˆ°æŒ‡å®šé•¿åº¦ï¼Œverticalï¼šå‚ç›´æ‰“å°ã€‚</span><br><span class="line"></span><br><span class="line">show(numRows: <span class="type">Int</span>, truncate: <span class="type">Int</span>): <span class="type">Unit</span></span><br><span class="line">show(numRows: <span class="type">Int</span>, truncate: <span class="type">Boolean</span>): <span class="type">Unit</span></span><br><span class="line">show(truncate: <span class="type">Boolean</span>): <span class="type">Unit</span></span><br><span class="line">numRows=<span class="number">20</span> truncate=<span class="number">20</span></span><br><span class="line"></span><br><span class="line">show(numRows: <span class="type">Int</span>): <span class="type">Unit</span></span><br><span class="line">truncate=<span class="number">20</span></span><br><span class="line"></span><br><span class="line">show(): <span class="type">Unit</span></span><br><span class="line">numRows=<span class="number">20</span> truncate=<span class="number">20</span></span><br><span class="line"></span><br><span class="line">summary(statistics: <span class="type">String</span>*): <span class="type">DataFrame</span></span><br><span class="line">è®¡ç®—æ•°æ®é›†statisticsæŒ‡å®šçš„æŒ‡æ ‡ï¼Œå¯æŒ‡å®š count, mean, stddev, min, approximate quartiles (percentiles at <span class="number">25</span>%, <span class="number">50</span>%, and <span class="number">75</span>%), and max.</span><br><span class="line">å¦‚æœªæŒ‡å®šåˆ™ä¼šè®¡ç®—å…¨éƒ¨ã€‚</span><br><span class="line"></span><br><span class="line">take(n: <span class="type">Int</span>): <span class="type">Array</span>[<span class="type">T</span>]</span><br><span class="line">è·å–å‰nè¡Œ</span><br><span class="line"></span><br><span class="line">takeAsList(n: <span class="type">Int</span>): <span class="type">List</span>[<span class="type">T</span>]</span><br><span class="line">è·å–å‰nè¡Œä¿å­˜ä¸ºlist</span><br><span class="line"></span><br><span class="line">toLocalIterator(): <span class="type">Iterator</span>[<span class="type">T</span>]</span><br><span class="line">è¿”å›ä¸€ä¸ªæ‰€æœ‰è¡Œçš„è¿­ä»£å™¨</span><br><span class="line"><span class="type">The</span> iterator will consume as much memory as the largest partition in <span class="keyword">this</span> <span class="type">Dataset</span>.</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="åŸºæœ¬å‡½æ•°ï¼ˆBasic-Dataset-functions"><a href="#åŸºæœ¬å‡½æ•°ï¼ˆBasic-Dataset-functions" class="headerlink" title="åŸºæœ¬å‡½æ•°ï¼ˆBasic Dataset functions)"></a>åŸºæœ¬å‡½æ•°ï¼ˆBasic Dataset functions)</h2><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">as[<span class="type">U</span>](<span class="keyword">implicit</span> arg0: <span class="type">Encoder</span>[<span class="type">U</span>]): <span class="type">Dataset</span>[<span class="type">U</span>]</span><br><span class="line">å°†æ•°æ®æ˜ å°„æˆæŒ‡å®šç±»å‹<span class="type">U</span>ï¼Œè¿”å›æ–°çš„<span class="type">Dataset</span></span><br><span class="line"></span><br><span class="line">persist(newLevel: <span class="type">StorageLevel</span>): <span class="type">Dataset</span>.<span class="keyword">this</span>.<span class="keyword">type</span></span><br><span class="line">ç¼“å­˜æ•°æ®ï¼Œå¯è®¾ç½®ç¼“å­˜çº§åˆ«ã€‚</span><br><span class="line"></span><br><span class="line">persist(): <span class="type">Dataset</span>.<span class="keyword">this</span>.<span class="keyword">type</span></span><br><span class="line">åŒcacheæ–¹æ³•</span><br><span class="line"></span><br><span class="line">cache(): <span class="type">Dataset</span>.<span class="keyword">this</span>.<span class="keyword">type</span></span><br><span class="line">ç¼“å­˜æ•°æ®,<span class="type">MEMORY_AND_DISK</span>æ¨¡å¼ã€‚</span><br><span class="line">æ³¨æ„ï¼š<span class="type">RDD</span>çš„cacheå‡½æ•°é»˜è®¤æ˜¯<span class="type">MEMORY_ONLY</span>ã€‚</span><br><span class="line"></span><br><span class="line">checkpoint(eager: <span class="type">Boolean</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">è¿”å›ä¸€ä¸ªcheckpointedçš„<span class="type">Dataset</span>ï¼Œ<span class="type">Dataset</span>çš„é€»è¾‘æ‰§è¡Œè®¡åˆ’å°†è¢«æˆªæ–­ã€‚</span><br><span class="line"></span><br><span class="line">checkpoint(): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">åŒä¸Šï¼Œeager=<span class="literal">true</span>.</span><br><span class="line"></span><br><span class="line">columns: <span class="type">Array</span>[<span class="type">String</span>]</span><br><span class="line">æ•°ç»„å½¢å¼è¿”å›æ‰€æœ‰åˆ—åã€‚</span><br><span class="line"></span><br><span class="line">dtypes: <span class="type">Array</span>[(<span class="type">String</span>, <span class="type">String</span>)]</span><br><span class="line">æ•°ç»„å½¢å¼è¿”å›æ‰€æœ‰åˆ—ååŠç±»å‹ã€‚</span><br><span class="line"></span><br><span class="line">createGlobalTempView(viewName: <span class="type">String</span>): <span class="type">Unit</span></span><br><span class="line">åˆ›å»ºå…¨å±€ä¸´æ—¶è§†å›¾(view)ï¼Œç”Ÿå‘½å‘¨æœŸä¸<span class="type">Spark</span>åº”ç”¨ä¸€è‡´ã€‚</span><br><span class="line">å¯ä»¥è·¨sessionè®¿é—®ã€‚e.g. <span class="type">SELECT</span> * <span class="type">FROM</span> global_temp.view1.</span><br><span class="line"></span><br><span class="line">createOrReplaceGlobalTempView(viewName: <span class="type">String</span>): <span class="type">Unit</span></span><br><span class="line">åŒä¸Šï¼Œå·²å­˜åœ¨åˆ™æ›¿æ¢ã€‚</span><br><span class="line"></span><br><span class="line">createTempView(viewName: <span class="type">String</span>): <span class="type">Unit</span></span><br><span class="line">åˆ›å»ºæœ¬åœ°ä¸´æ—¶è§†å›¾(view)ï¼Œä»…å½“å‰<span class="type">SparkSession</span>å¯è®¿é—®ã€‚</span><br><span class="line">æ³¨æ„ï¼šä¸è·Ÿä»»ä½•åº“ç»‘å®šï¼Œä¸èƒ½ç”¨db1.view1è¿™æ ·çš„å½¢å¼è®¿é—®ã€‚</span><br><span class="line"></span><br><span class="line">createOrReplaceTempView(viewName: <span class="type">String</span>): <span class="type">Unit</span></span><br><span class="line">åŒä¸Šï¼Œå·²å­˜åœ¨åˆ™æ›¿æ¢ã€‚</span><br><span class="line"></span><br><span class="line">explain(): <span class="type">Unit</span></span><br><span class="line">æ‰“å°ç‰©ç†æ‰§è¡Œè®¡åˆ’</span><br><span class="line">å¦æœ‰ï¼šqueryExecutionå˜é‡ï¼Œå®Œæ•´æ‰§è¡Œè®¡åˆ’ã€‚</span><br><span class="line"></span><br><span class="line">explain(extended: <span class="type">Boolean</span>): <span class="type">Unit</span></span><br><span class="line">æ‰“å°ç‰©ç†+é€»è¾‘æ‰§è¡Œè®¡åˆ’</span><br><span class="line"></span><br><span class="line">hint(name: <span class="type">String</span>, parameters: <span class="type">Any</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">å½“å‰datasetæŒ‡å®šhintã€‚<span class="comment">//todo</span></span><br><span class="line">e.g. df1.join(df2.hint(<span class="string">&quot;broadcast&quot;</span>))</span><br><span class="line"></span><br><span class="line">inputFiles: <span class="type">Array</span>[<span class="type">String</span>]</span><br><span class="line">è¿”å›ç»„æˆ<span class="type">Dataset</span>çš„è¾“å…¥æ–‡ä»¶ï¼ˆ<span class="type">Returns</span> a best-effort snapshot of the files that compose <span class="keyword">this</span> <span class="type">Dataset</span>ï¼‰</span><br><span class="line"></span><br><span class="line">isLocal: <span class="type">Boolean</span></span><br><span class="line">collectå’Œtakeæ˜¯å¦å¯ä»¥æœ¬åœ°æ‰§è¡Œï¼Œä¸éœ€è¦executor.</span><br><span class="line"></span><br><span class="line">localCheckpoint(eager: <span class="type">Boolean</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">æ‰§è¡Œæœ¬åœ°<span class="type">Checkpoint</span>ï¼Œè¿”å›æ–°datasetã€‚</span><br><span class="line"></span><br><span class="line">localCheckpoint(): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">eager=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">printSchema(): <span class="type">Unit</span></span><br><span class="line">æ‰“å°schemaç»“æ„</span><br><span class="line"></span><br><span class="line">rdd: <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">datasetå†…éƒ¨çš„<span class="type">RDD</span></span><br><span class="line"></span><br><span class="line">schema: <span class="type">StructType</span></span><br><span class="line">schema</span><br><span class="line"></span><br><span class="line">storageLevel: <span class="type">StorageLevel</span></span><br><span class="line">å½“å‰å­˜å‚¨ç­‰çº§ï¼Œæ²¡æœ‰è¢«persiståˆ™æ˜¯<span class="type">StorageLevel</span>.<span class="type">NONE</span></span><br><span class="line"></span><br><span class="line">toDF(): <span class="type">DataFrame</span></span><br><span class="line">toDF(colNames: <span class="type">String</span>*): <span class="type">DataFrame</span></span><br><span class="line">è½¬ä¸º<span class="type">DataFrame</span>ï¼Œä¹Ÿå¯ä»¥å°†<span class="type">RDD</span>è½¬ä¸º<span class="type">DataFrame</span>ã€‚</span><br><span class="line"></span><br><span class="line">unpersist(): <span class="type">Dataset</span>.<span class="keyword">this</span>.<span class="keyword">type</span></span><br><span class="line">unpersist(blocking: <span class="type">Boolean</span>): <span class="type">Dataset</span>.<span class="keyword">this</span>.<span class="keyword">type</span></span><br><span class="line">åˆ é™¤ç¼“å­˜ï¼Œblockingè¡¨ç¤ºæ˜¯å¦ç­‰æ‰€æœ‰blocksåˆ é™¤åæ‰è¿”å›,åˆ é™¤æœŸé—´é˜»å¡ã€‚</span><br><span class="line"></span><br><span class="line">write: <span class="type">DataFrameWriter</span>[<span class="type">T</span>]</span><br><span class="line"><span class="type">DataFrameWriter</span>ï¼Œéæµå¼æ•°æ®å†™æ¥å£ã€‚</span><br><span class="line"></span><br><span class="line">writeStream: <span class="type">DataStreamWriter</span>[<span class="type">T</span>]</span><br><span class="line"><span class="type">DataStreamWriter</span>ï¼Œæµå¼æ•°æ®å†™æ¥å£ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="æµå¼å‡½æ•°ï¼ˆstreamingï¼‰"><a href="#æµå¼å‡½æ•°ï¼ˆstreamingï¼‰" class="headerlink" title="æµå¼å‡½æ•°ï¼ˆstreamingï¼‰"></a>æµå¼å‡½æ•°ï¼ˆstreamingï¼‰</h2><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">isStreaming: <span class="type">Boolean</span></span><br><span class="line">æ˜¯å¦æµå¼æ•°æ®</span><br><span class="line"></span><br><span class="line">withWatermark(eventTime: <span class="type">String</span>, delayThreshold: <span class="type">String</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line"><span class="type">Defines</span> an event time watermark <span class="keyword">for</span> <span class="keyword">this</span> <span class="type">Dataset</span>.</span><br><span class="line"><span class="comment">//TODO</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="å¼ºç±»å‹è½¬æ¢ï¼ˆTyped-transformationsï¼‰"><a href="#å¼ºç±»å‹è½¬æ¢ï¼ˆTyped-transformationsï¼‰" class="headerlink" title="å¼ºç±»å‹è½¬æ¢ï¼ˆTyped transformationsï¼‰"></a>å¼ºç±»å‹è½¬æ¢ï¼ˆTyped transformationsï¼‰</h2><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">alias(alias: <span class="type">Symbol</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">alias(alias: <span class="type">String</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">as(alias: <span class="type">Symbol</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">as(alias: <span class="type">String</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">ç»™<span class="type">Dataset</span>ä¸€ä¸ªåˆ«å</span><br><span class="line"></span><br><span class="line">coalesce(numPartitions: <span class="type">Int</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">åˆ†åŒºåˆå¹¶(åªèƒ½å‡å°‘åˆ†åŒº)</span><br><span class="line"></span><br><span class="line">distinct(): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">dropDuplicatesçš„åˆ«å</span><br><span class="line"></span><br><span class="line">dropDuplicates(col1: <span class="type">String</span>, cols: <span class="type">String</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">dropDuplicates(colNames: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">dropDuplicates(colNames: <span class="type">Seq</span>[<span class="type">String</span>]): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">dropDuplicates(): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">æ ¹æ®æŒ‡å®šå­—æ®µï¼Œå¯¹æ•°æ®å»é‡ã€‚</span><br><span class="line"></span><br><span class="line">except(other: <span class="type">Dataset</span>[<span class="type">T</span>]): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">å»é™¤otherä¸­ä¹Ÿæœ‰çš„è¡Œã€‚åŒ<span class="type">EXCEPT</span> <span class="type">DISTINCT</span> in <span class="type">SQL</span>ã€‚</span><br><span class="line"><span class="comment">//TODO</span></span><br><span class="line"></span><br><span class="line">filter(func: (<span class="type">T</span>) â‡’ <span class="type">Boolean</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">filter(conditionExpr: <span class="type">String</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">filter(condition: <span class="type">Column</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">æ ¹æ®æ¡ä»¶è¿‡æ»¤è¡Œ</span><br><span class="line">e.g.</span><br><span class="line">peopleDs.filter(<span class="string">&quot;age &gt; 15&quot;</span>)</span><br><span class="line">peopleDs.filter($<span class="string">&quot;age&quot;</span> &gt; <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">flatMap[<span class="type">U</span>](func: (<span class="type">T</span>) â‡’ <span class="type">TraversableOnce</span>[<span class="type">U</span>])(<span class="keyword">implicit</span> arg0: <span class="type">Encoder</span>[<span class="type">U</span>]): <span class="type">Dataset</span>[<span class="type">U</span>]</span><br><span class="line">ç¬¬ä¸€æ­¥å’Œmapä¸€æ ·ï¼Œæœ€åå°†æ‰€æœ‰çš„è¾“å‡ºåˆå¹¶ã€‚</span><br><span class="line"></span><br><span class="line">groupByKey[<span class="type">K</span>](func: (<span class="type">T</span>) â‡’ <span class="type">K</span>)(<span class="keyword">implicit</span> arg0: <span class="type">Encoder</span>[<span class="type">K</span>]): <span class="type">KeyValueGroupedDataset</span>[<span class="type">K</span>, <span class="type">T</span>]</span><br><span class="line">ç°æ ¹æ®funcå‡½æ•°ç”Ÿæˆkeyï¼Œç„¶åæŒ‰keyåˆ†ç»„ã€‚</span><br><span class="line"></span><br><span class="line">intersect(other: <span class="type">Dataset</span>[<span class="type">T</span>]): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">æ±‚ä¸¤ä¸ªdatasetçš„äº¤é›†ï¼Œç­‰åŒäº<span class="type">INTERSECT</span> in <span class="type">SQL</span>.</span><br><span class="line"></span><br><span class="line">joinWith[<span class="type">U</span>](other: <span class="type">Dataset</span>[<span class="type">U</span>], condition: <span class="type">Column</span>): <span class="type">Dataset</span>[(<span class="type">T</span>, <span class="type">U</span>)]</span><br><span class="line">inner equi-joinä¸¤ä¸ªdataset</span><br><span class="line"></span><br><span class="line">joinWith[<span class="type">U</span>](other: <span class="type">Dataset</span>[<span class="type">U</span>], condition: <span class="type">Column</span>, joinType: <span class="type">String</span>): <span class="type">Dataset</span>[(<span class="type">T</span>, <span class="type">U</span>)]</span><br><span class="line">joinTypeå¯é€‰ï¼šinner, cross, outer, full, full_outer, left, left_outer, right, right_outer</span><br><span class="line"></span><br><span class="line">limit(n: <span class="type">Int</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">è¿”å›å‰nè¡Œï¼Œä¸headçš„åŒºåˆ«æ˜¯ï¼Œheadæ˜¯ä¸€ä¸ªactionï¼Œä¼šé©¬ä¸Šè¿”å›ç»“æœæ•°ç»„ã€‚</span><br><span class="line"></span><br><span class="line">map[<span class="type">U</span>](func: (<span class="type">T</span>) â‡’ <span class="type">U</span>)(<span class="keyword">implicit</span> arg0: <span class="type">Encoder</span>[<span class="type">U</span>]): <span class="type">Dataset</span>[<span class="type">U</span>]</span><br><span class="line">åœ¨æ¯ä¸€ä¸ªå…ƒç´ åº”ç”¨funcå‡½æ•°ï¼Œè¿”å›åŒ…å«ç»“æœé›†çš„datasetã€‚</span><br><span class="line"></span><br><span class="line">mapPartitions[<span class="type">U</span>](func: (<span class="type">Iterator</span>[<span class="type">T</span>]) â‡’ <span class="type">Iterator</span>[<span class="type">U</span>])(<span class="keyword">implicit</span> arg0: <span class="type">Encoder</span>[<span class="type">U</span>]): <span class="type">Dataset</span>[<span class="type">U</span>]</span><br><span class="line">åœ¨æ¯ä¸€ä¸ªåˆ†åŒºåº”ç”¨funcå‡½æ•°ï¼Œè¿”å›åŒ…å«ç»“æœé›†çš„datasetã€‚</span><br><span class="line"></span><br><span class="line">orderBy(sortExprs: <span class="type">Column</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">orderBy(sortCol: <span class="type">String</span>, sortCols: <span class="type">String</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">sortçš„åˆ«å</span><br><span class="line"></span><br><span class="line">sort(sortExprs: <span class="type">Column</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">sort(sortCol: <span class="type">String</span>, sortCols: <span class="type">String</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">æŒ‰æŒ‡å®šåˆ—æ’åºï¼Œé»˜è®¤ascã€‚</span><br><span class="line">e.g. ds.sort($<span class="string">&quot;col1&quot;</span>, $<span class="string">&quot;col2&quot;</span>.desc)</span><br><span class="line"></span><br><span class="line">sortWithinPartitions(sortExprs: <span class="type">Column</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">sortWithinPartitions(sortCol: <span class="type">String</span>, sortCols: <span class="type">String</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">åˆ†åŒºå†…æ’åºï¼ŒåŒ<span class="string">&quot;SORT BY&quot;</span> in <span class="type">SQL</span> (<span class="type">Hive</span> <span class="type">QL</span>).</span><br><span class="line"></span><br><span class="line">randomSplit(weights: <span class="type">Array</span>[<span class="type">Double</span>]): <span class="type">Array</span>[<span class="type">Dataset</span>[<span class="type">T</span>]]</span><br><span class="line">randomSplit(weights: <span class="type">Array</span>[<span class="type">Double</span>], seed: <span class="type">Long</span>): <span class="type">Array</span>[<span class="type">Dataset</span>[<span class="type">T</span>]]</span><br><span class="line">æŒ‰æƒé‡éšæœºåˆ†å‰²æ•°æ®</span><br><span class="line"></span><br><span class="line">repartition(partitionExprs: <span class="type">Column</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">repartition(numPartitions: <span class="type">Int</span>, partitionExprs: <span class="type">Column</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">repartition(numPartitions: <span class="type">Int</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">æŒ‰æŒ‡å®šè¡¨è¾¾å¼ï¼Œåˆ†åŒºæ•°ï¼Œé‡æ–°åˆ†åŒºï¼ˆhashï¼‰ï¼ŒåŒ<span class="string">&quot;DISTRIBUTE BY&quot;</span> in <span class="type">SQL</span>ã€‚</span><br><span class="line">é»˜è®¤åˆ†åŒºæ•°ä¸ºspark.sql.shuffle.partitions</span><br><span class="line"></span><br><span class="line">repartitionByRange(partitionExprs: <span class="type">Column</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">repartitionByRange(numPartitions: <span class="type">Int</span>, partitionExprs: <span class="type">Column</span>*): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">æŒ‰æŒ‡å®šè¡¨è¾¾å¼ï¼Œåˆ†åŒºæ•°ï¼Œé‡æ–°åˆ†åŒºï¼Œé‡‡ç”¨<span class="type">Range</span> partitionæ–¹å¼ï¼ŒæŒ‰é”®èŒƒå›´åˆ†åŒºã€‚</span><br><span class="line">åˆ†åŒºé»˜è®¤æ’åºæ–¹å¼ä¸ºascending nulls firstï¼Œåˆ†åŒºå†…æ•°æ®æœªæ’åºã€‚</span><br><span class="line"></span><br><span class="line">sample(withReplacement: <span class="type">Boolean</span>, fraction: <span class="type">Double</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">sample(withReplacement: <span class="type">Boolean</span>, fraction: <span class="type">Double</span>, seed: <span class="type">Long</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">sample(fraction: <span class="type">Double</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">sample(fraction: <span class="type">Double</span>, seed: <span class="type">Long</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">éšæœºå–æ ·æœ¬æ•°æ®</span><br><span class="line">withReplacementï¼š<span class="type">Sample</span> <span class="keyword">with</span> replacement or not.</span><br><span class="line">fractionï¼š<span class="type">Fraction</span> of rows to generate, range [<span class="number">0.0</span>, <span class="number">1.0</span>].</span><br><span class="line">seedï¼š<span class="type">Seed</span> <span class="keyword">for</span> sampling.</span><br><span class="line"></span><br><span class="line">select[<span class="type">U1</span>](c1: <span class="type">TypedColumn</span>[<span class="type">T</span>, <span class="type">U1</span>]): <span class="type">Dataset</span>[<span class="type">U1</span>]</span><br><span class="line">æ ¹æ®åˆ—/è¡¨è¾¾å¼è·å–åˆ—æ•°æ®</span><br><span class="line"></span><br><span class="line">transform[<span class="type">U</span>](t: (<span class="type">Dataset</span>[<span class="type">T</span>]) â‡’ <span class="type">Dataset</span>[<span class="type">U</span>]): <span class="type">Dataset</span>[<span class="type">U</span>]</span><br><span class="line">åº”ç”¨tå‡½æ•°è½¬æ¢<span class="type">Dataset</span>ã€‚</span><br><span class="line"></span><br><span class="line">union(other: <span class="type">Dataset</span>[<span class="type">T</span>]): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">ç­‰äº<span class="type">UNION</span> <span class="type">ALL</span> in <span class="type">SQL</span>ã€‚</span><br><span class="line">æ³¨æ„æ˜¯æŒ‰åˆ—ä½ç½®åˆå¹¶ï¼š</span><br><span class="line"><span class="keyword">val</span> df1 = <span class="type">Seq</span>((<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)).toDF(<span class="string">&quot;col0&quot;</span>, <span class="string">&quot;col1&quot;</span>, <span class="string">&quot;col2&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> df2 = <span class="type">Seq</span>((<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)).toDF(<span class="string">&quot;col1&quot;</span>, <span class="string">&quot;col2&quot;</span>, <span class="string">&quot;col0&quot;</span>)</span><br><span class="line">df1.union(df2).show</span><br><span class="line"></span><br><span class="line"><span class="comment">// output:</span></span><br><span class="line"><span class="comment">// +----+----+----+</span></span><br><span class="line"><span class="comment">// |col0|col1|col2|</span></span><br><span class="line"><span class="comment">// +----+----+----+</span></span><br><span class="line"><span class="comment">// |   1|   2|   3|</span></span><br><span class="line"><span class="comment">// |   4|   5|   6|</span></span><br><span class="line"><span class="comment">// +----+----+----+</span></span><br><span class="line"></span><br><span class="line">unionByName(other: <span class="type">Dataset</span>[<span class="type">T</span>]): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">åŒunionæ–¹æ³•ï¼Œä½†æ˜¯æŒ‰åˆ—ååˆå¹¶ï¼š</span><br><span class="line"><span class="keyword">val</span> df1 = <span class="type">Seq</span>((<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)).toDF(<span class="string">&quot;col0&quot;</span>, <span class="string">&quot;col1&quot;</span>, <span class="string">&quot;col2&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> df2 = <span class="type">Seq</span>((<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)).toDF(<span class="string">&quot;col1&quot;</span>, <span class="string">&quot;col2&quot;</span>, <span class="string">&quot;col0&quot;</span>)</span><br><span class="line">df1.unionByName(df2).show</span><br><span class="line"><span class="comment">// output:</span></span><br><span class="line"><span class="comment">// +----+----+----+</span></span><br><span class="line"><span class="comment">// |col0|col1|col2|</span></span><br><span class="line"><span class="comment">// +----+----+----+</span></span><br><span class="line"><span class="comment">// |   1|   2|   3|</span></span><br><span class="line"><span class="comment">// |   6|   4|   5|</span></span><br><span class="line"><span class="comment">// +----+----+----+</span></span><br><span class="line"></span><br><span class="line">where(conditionExpr: <span class="type">String</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">where(condition: <span class="type">Column</span>): <span class="type">Dataset</span>[<span class="type">T</span>]</span><br><span class="line">filterçš„åˆ«å</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="å¼±ç±»å‹è½¬æ¢ï¼ˆUntyped-transformationsï¼‰"><a href="#å¼±ç±»å‹è½¬æ¢ï¼ˆUntyped-transformationsï¼‰" class="headerlink" title="å¼±ç±»å‹è½¬æ¢ï¼ˆUntyped transformationsï¼‰"></a>å¼±ç±»å‹è½¬æ¢ï¼ˆUntyped transformationsï¼‰</h2><p>è¿”å›ç±»å‹ä¸ºDataFrameè€Œä¸æ˜¯Datasetã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">agg(expr: <span class="type">Column</span>, exprs: <span class="type">Column</span>*): <span class="type">DataFrame</span></span><br><span class="line">agg(exprs: <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>]): <span class="type">DataFrame</span></span><br><span class="line">agg(aggExpr: (<span class="type">String</span>, <span class="type">String</span>), aggExprs: (<span class="type">String</span>, <span class="type">String</span>)*): <span class="type">DataFrame</span></span><br><span class="line">åœ¨æ•´ä¸ªdatasetè¿›è¡Œèšåˆã€‚</span><br><span class="line">ds.agg(...) æ˜¯ ds.groupBy().agg(...) çš„ç®€å†™ã€‚</span><br><span class="line">e.g.</span><br><span class="line">ds.agg(max($<span class="string">&quot;age&quot;</span>), avg($<span class="string">&quot;salary&quot;</span>))</span><br><span class="line">ds.agg(<span class="type">Map</span>(<span class="string">&quot;age&quot;</span> -&gt; <span class="string">&quot;max&quot;</span>, <span class="string">&quot;salary&quot;</span> -&gt; <span class="string">&quot;avg&quot;</span>))</span><br><span class="line">ds.agg(<span class="string">&quot;age&quot;</span> -&gt; <span class="string">&quot;max&quot;</span>, <span class="string">&quot;salary&quot;</span> -&gt; <span class="string">&quot;avg&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apply(colName: <span class="type">String</span>): <span class="type">Column</span></span><br><span class="line">col(colName: <span class="type">String</span>): <span class="type">Column</span></span><br><span class="line">colRegex(colName: <span class="type">String</span>): <span class="type">Column</span></span><br><span class="line">è¿”å›æŒ‡å®šåˆ—ã€‚</span><br><span class="line"></span><br><span class="line">crossJoin(right: <span class="type">Dataset</span>[_]): <span class="type">DataFrame</span></span><br><span class="line">cross joinã€‚</span><br><span class="line"></span><br><span class="line">cube(col1: <span class="type">String</span>, cols: <span class="type">String</span>*): <span class="type">RelationalGroupedDataset</span></span><br><span class="line">cube(cols: <span class="type">Column</span>*): <span class="type">RelationalGroupedDataset</span></span><br><span class="line">ä½¿ç”¨æŒ‡å®šåˆ—åˆ›å»ºå¤šç»´cubeã€‚</span><br><span class="line"><span class="comment">//TODO</span></span><br><span class="line"></span><br><span class="line">drop(col: <span class="type">Column</span>): <span class="type">DataFrame</span></span><br><span class="line">drop(colNames: <span class="type">String</span>*): <span class="type">DataFrame</span></span><br><span class="line">drop(colName: <span class="type">String</span>): <span class="type">DataFrame</span></span><br><span class="line">å‰ªæ‰æŒ‡å®šå­—æ®µã€‚</span><br><span class="line"></span><br><span class="line">groupBy(col1: <span class="type">String</span>, cols: <span class="type">String</span>*): <span class="type">RelationalGroupedDataset</span></span><br><span class="line">groupBy(cols: <span class="type">Column</span>*): <span class="type">RelationalGroupedDataset</span></span><br><span class="line">æŒ‰æŒ‡å®šåˆ—åˆ†ç»„</span><br><span class="line"></span><br><span class="line">join(right: <span class="type">Dataset</span>[_], joinExprs: <span class="type">Column</span>, joinType: <span class="type">String</span>): <span class="type">DataFrame</span></span><br><span class="line">join(right: <span class="type">Dataset</span>[_], joinExprs: <span class="type">Column</span>): <span class="type">DataFrame</span></span><br><span class="line">join(right: <span class="type">Dataset</span>[_], usingColumns: <span class="type">Seq</span>[<span class="type">String</span>], joinType: <span class="type">String</span>): <span class="type">DataFrame</span></span><br><span class="line">join(right: <span class="type">Dataset</span>[_], usingColumns: <span class="type">Seq</span>[<span class="type">String</span>]): <span class="type">DataFrame</span></span><br><span class="line">join(right: <span class="type">Dataset</span>[_], usingColumn: <span class="type">String</span>): <span class="type">DataFrame</span></span><br><span class="line">join(right: <span class="type">Dataset</span>[_]): <span class="type">DataFrame</span></span><br><span class="line">ä¸å¦ä¸€ä¸ª<span class="type">DataFrame</span> joinã€‚</span><br><span class="line">joinExprsï¼š$<span class="string">&quot;df1Key&quot;</span> === $<span class="string">&quot;df2Key&quot;</span></span><br><span class="line">usingColumnï¼š<span class="type">Seq</span>(<span class="string">&quot;user_id&quot;</span>, <span class="string">&quot;user_name&quot;</span>)</span><br><span class="line">joinTypeï¼š<span class="type">Default</span> inner. <span class="type">Must</span> be one of: inner, cross, outer, full, full_outer, left, left_outer, right, right_outer, left_semi, left_anti.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">na: <span class="type">DataFrameNaFunctions</span></span><br><span class="line">è§<span class="type">DataFrameNaFunctions</span></span><br><span class="line"></span><br><span class="line">stat: <span class="type">DataFrameStatFunctions</span></span><br><span class="line">è§<span class="type">DataFrameStatFunctions</span></span><br><span class="line"></span><br><span class="line">rollup(col1: <span class="type">String</span>, cols: <span class="type">String</span>*): <span class="type">RelationalGroupedDataset</span></span><br><span class="line">rollup(cols: <span class="type">Column</span>*): <span class="type">RelationalGroupedDataset</span></span><br><span class="line">ä½¿ç”¨æŒ‡å®šåˆ—è¿›è¡Œrollupèšåˆã€‚<span class="comment">//TODO</span></span><br><span class="line"></span><br><span class="line">select(col: <span class="type">String</span>, cols: <span class="type">String</span>*): <span class="type">DataFrame</span></span><br><span class="line">select(cols: <span class="type">Column</span>*): <span class="type">DataFrame</span></span><br><span class="line">selectExpr(exprs: <span class="type">String</span>*): <span class="type">DataFrame</span></span><br><span class="line">é€‰å–æŒ‡å®šåˆ—ã€<span class="type">SQL</span>è¡¨è¾¾å¼ã€‚</span><br><span class="line"></span><br><span class="line">withColumn(colName: <span class="type">String</span>, col: <span class="type">Column</span>): <span class="type">DataFrame</span></span><br><span class="line">æ–°å¢æˆ–æ›¿æ¢ä¸€åˆ—ã€‚</span><br><span class="line"></span><br><span class="line">withColumnRenamed(existingName: <span class="type">String</span>, newName: <span class="type">String</span>): <span class="type">DataFrame</span></span><br><span class="line">å°†æŒ‡å®šåˆ—æ›´åã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="æœªåˆ†ç»„ï¼ˆUngroupedï¼‰"><a href="#æœªåˆ†ç»„ï¼ˆUngroupedï¼‰" class="headerlink" title="æœªåˆ†ç»„ï¼ˆUngroupedï¼‰"></a>æœªåˆ†ç»„ï¼ˆUngroupedï¼‰</h2><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">queryExecution: <span class="type">QueryExecution</span></span><br><span class="line">æ‰§è¡Œè®¡åˆ’</span><br><span class="line"></span><br><span class="line">sparkSession: <span class="type">SparkSession</span></span><br><span class="line">åˆ›å»ºè¯¥datasetçš„<span class="type">SparkSession</span></span><br><span class="line"></span><br><span class="line">sqlContext: <span class="type">SQLContext</span></span><br><span class="line">datasetçš„<span class="type">SQLContext</span></span><br><span class="line"></span><br><span class="line">toJSON: <span class="type">Dataset</span>[<span class="type">String</span>]</span><br><span class="line">æ¯è¡Œæ•°æ®è½¬æˆ<span class="type">JSON</span>å­—ç¬¦ä¸²ã€‚</span><br><span class="line"></span><br><span class="line">toString(): <span class="type">String</span></span><br><span class="line"><span class="type">Any</span>çš„toString</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="http://spark.apache.org/docs/latest/api/scala/index.html#org.apache.spark.sql.Dataset">Spark API</a></li>
</ul>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>API</tag>
      </tags>
  </entry>
  <entry>
    <title>Spark API å…¨é›†(3):Spark RDD APIå…¨é›†</title>
    <url>/2018/03/26/spark-rdd-RDD-api/</url>
    <content><![CDATA[<h1 id="RDDæ˜¯å•¥"><a href="#RDDæ˜¯å•¥" class="headerlink" title="RDDæ˜¯å•¥"></a>RDDæ˜¯å•¥</h1><p>Resilient Distributed Dataset (RDD)ï¼Œå¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†ï¼Œæ˜¯å¯¹ä¸å¯ä¿®æ”¹ï¼Œåˆ†åŒºçš„æ•°æ®é›†åˆçš„æŠ½è±¡ã€‚</p>
<p>RDD is characterized by five main properties:</p>
<ul>
<li>A list of partitions</li>
<li>A function for computing each split</li>
<li>A list of dependencies on other RDDs</li>
<li>Optionally, a Partitioner for key-value RDDs (e.g. to say that the RDD is hash-partitioned)</li>
<li>Optionally, a list of preferred locations to compute each split on (e.g. block locations for an HDFS file)<span id="more"></span></li>
</ul>
<h1 id="org-spark-rdd-RDDç±»æ–¹æ³•"><a href="#org-spark-rdd-RDDç±»æ–¹æ³•" class="headerlink" title="org.spark.rdd.RDDç±»æ–¹æ³•"></a>org.spark.rdd.RDDç±»æ–¹æ³•</h1><p>RDDæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RDD</span>[<span class="type">T</span>] <span class="keyword">extends</span> <span class="title">Serializable</span> <span class="keyword">with</span> <span class="title">Logging</span></span></span><br></pre></td></tr></table></figure>
<p>RDDç±»çš„publicæ–¹æ³•å¤§çº¦æœ‰80å¤šä¸ªï¼ˆåŒ…æ‹¬ä¸åŒå‚æ•°é‡è½½çš„ï¼‰,å‡åœ¨ä¸‹é¢åˆ—å‡ºã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒRDDç±»ä¸­å¹¶æ²¡æœ‰å®šä¹‰xxxByKeyå½¢å¼çš„æ–¹æ³•ï¼Œè¿™ç±»æ–¹æ³•å…¶å®æ˜¯åœ¨PairRDDFunctionsä¸­å®šä¹‰çš„ï¼Œé€šè¿‡éšå¼è½¬æ¢ï¼Œé”®å€¼å¯¹å½¢å¼çš„RDDï¼ˆå³RDD[(K, V)ï¼‰å¯ä»¥è°ƒç”¨PairRDDFunctionsä¸­å®šä¹‰çš„æ–¹æ³•ã€‚ç›¸å…³çš„éšå¼è½¬æ¢å®šä¹‰åœ¨RDDçš„ä¼´ç”Ÿå¯¹è±¡ä¸­ã€‚</p>
<h3 id="é”®å€¼è½¬æ¢æ“ä½œ"><a href="#é”®å€¼è½¬æ¢æ“ä½œ" class="headerlink" title="é”®å€¼è½¬æ¢æ“ä½œ"></a>é”®å€¼è½¬æ¢æ“ä½œ</h3><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">filter(f: (<span class="type">T</span>) â‡’ <span class="type">Boolean</span>): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">è¿‡æ»¤æ•°æ®ï¼Œä»…ç•™ä¸‹ä½¿å¾—fè¿”å›<span class="literal">true</span>çš„å…ƒç´ ã€‚</span><br><span class="line"></span><br><span class="line">map[<span class="type">U</span>](f: (<span class="type">T</span>) â‡’ <span class="type">U</span>)(<span class="keyword">implicit</span> arg0: <span class="type">ClassTag</span>[<span class="type">U</span>]): <span class="type">RDD</span>[<span class="type">U</span>]</span><br><span class="line">å°†ä¸€ä¸ª<span class="type">RDD</span>ä¸­çš„æ¯ä¸ªæ•°æ®é¡¹ï¼Œé€šè¿‡mapä¸­çš„å‡½æ•°æ˜ å°„å˜ä¸ºä¸€ä¸ªæ–°çš„å…ƒç´ ã€‚</span><br><span class="line">è¾“å…¥åˆ†åŒºä¸è¾“å‡ºåˆ†åŒºä¸€å¯¹ä¸€ï¼Œå³ï¼šæœ‰å¤šå°‘ä¸ªè¾“å…¥åˆ†åŒºï¼Œå°±æœ‰å¤šå°‘ä¸ªè¾“å‡ºåˆ†åŒºã€‚</span><br><span class="line"></span><br><span class="line">flatMap[<span class="type">U</span>](f: (<span class="type">T</span>) â‡’ <span class="type">TraversableOnce</span>[<span class="type">U</span>])(<span class="keyword">implicit</span> arg0: <span class="type">ClassTag</span>[<span class="type">U</span>]): <span class="type">RDD</span>[<span class="type">U</span>]</span><br><span class="line">ç¬¬ä¸€æ­¥å’Œmapä¸€æ ·ï¼Œæœ€åå°†æ‰€æœ‰çš„è¾“å‡ºåˆ†åŒºåˆå¹¶æˆä¸€ä¸ªã€‚</span><br><span class="line">ä½¿ç”¨flatMapæ—¶å€™éœ€è¦æ³¨æ„ï¼š</span><br><span class="line">flatMapä¼šå°†å­—ç¬¦ä¸²çœ‹æˆæ˜¯ä¸€ä¸ªå­—ç¬¦æ•°ç»„ã€‚</span><br><span class="line"></span><br><span class="line">mapPartitions[<span class="type">U</span>](f: (<span class="type">Iterator</span>[<span class="type">T</span>]) â‡’ <span class="type">Iterator</span>[<span class="type">U</span>], preservesPartitioning: <span class="type">Boolean</span> = <span class="literal">false</span>)(<span class="keyword">implicit</span> arg0: <span class="type">ClassTag</span>[<span class="type">U</span>]): <span class="type">RDD</span>[<span class="type">U</span>]</span><br><span class="line">è¯¥å‡½æ•°å’Œmapå‡½æ•°ç±»ä¼¼ï¼Œåªä¸è¿‡æ˜ å°„å‡½æ•°çš„å‚æ•°ç”±<span class="type">RDD</span>ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ å˜æˆäº†<span class="type">RDD</span>ä¸­æ¯ä¸€ä¸ªåˆ†åŒºçš„è¿­ä»£å™¨ã€‚å¦‚æœåœ¨æ˜ å°„çš„è¿‡ç¨‹ä¸­éœ€è¦é¢‘ç¹åˆ›å»ºé¢å¤–çš„å¯¹è±¡ï¼Œä½¿ç”¨mapPartitionsè¦æ¯”mapé«˜æ•ˆçš„è¿‡ã€‚</span><br><span class="line">æ¯”å¦‚ï¼Œå°†<span class="type">RDD</span>ä¸­çš„æ‰€æœ‰æ•°æ®é€šè¿‡<span class="type">JDBC</span>è¿æ¥å†™å…¥æ•°æ®åº“ï¼Œå¦‚æœä½¿ç”¨mapå‡½æ•°ï¼Œå¯èƒ½è¦ä¸ºæ¯ä¸€ä¸ªå…ƒç´ éƒ½åˆ›å»ºä¸€ä¸ªconnectionï¼Œè¿™æ ·å¼€é”€å¾ˆå¤§ï¼Œå¦‚æœä½¿ç”¨mapPartitionsï¼Œé‚£ä¹ˆåªéœ€è¦é’ˆå¯¹æ¯ä¸€ä¸ªåˆ†åŒºå»ºç«‹ä¸€ä¸ªconnectionã€‚</span><br><span class="line">å‚æ•°preservesPartitioningè¡¨ç¤ºæ˜¯å¦ä¿ç•™çˆ¶<span class="type">RDD</span>çš„partitioneråˆ†åŒºä¿¡æ¯ã€‚</span><br><span class="line"></span><br><span class="line">mapPartitionsWithIndex[<span class="type">U</span>](f: (<span class="type">Int</span>, <span class="type">Iterator</span>[<span class="type">T</span>]) =&gt; <span class="type">Iterator</span>[<span class="type">U</span>], preservesPartitioning: <span class="type">Boolean</span> = <span class="literal">false</span>)(<span class="keyword">implicit</span> arg0: <span class="type">ClassTag</span>[<span class="type">U</span>]): <span class="type">RDD</span>[<span class="type">U</span>]</span><br><span class="line">å‡½æ•°ä½œç”¨åŒmapPartitionsï¼Œä¸è¿‡æä¾›äº†ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºåˆ†åŒºçš„ç´¢å¼•ã€‚</span><br><span class="line"></span><br><span class="line">keyBy[<span class="type">K</span>](f: (<span class="type">T</span>) â‡’ <span class="type">K</span>): <span class="type">RDD</span>[(<span class="type">K</span>, <span class="type">T</span>)]</span><br><span class="line">é€šè¿‡få‡½æ•°ä¸ºæ¯ä¸ªå…ƒç´ ç”Ÿæˆä¸€ä¸ª<span class="type">KEY</span></span><br><span class="line"></span><br><span class="line">sortBy[<span class="type">K</span>](f: (<span class="type">T</span>) â‡’ <span class="type">K</span>, ascending: <span class="type">Boolean</span> = <span class="literal">true</span>, numPartitions: <span class="type">Int</span> = <span class="keyword">this</span>.partitions.length)(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">K</span>], ctag: <span class="type">ClassTag</span>[<span class="type">K</span>]): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">é€šè¿‡ç»™å®šçš„å‡½æ•°å¯¹å…ƒç´ æ’åº</span><br><span class="line"></span><br><span class="line">zip[<span class="type">U</span>](other: <span class="type">RDD</span>[<span class="type">U</span>])(<span class="keyword">implicit</span> arg0: <span class="type">ClassTag</span>[<span class="type">U</span>]): <span class="type">RDD</span>[(<span class="type">T</span>, <span class="type">U</span>)]</span><br><span class="line">ä¸å¦ä¸€ä¸ª<span class="type">RDD</span>ç»„åˆæˆï¼ˆk,v)å¯¹ã€‚</span><br><span class="line"></span><br><span class="line">zipPartitions[<span class="type">B</span>, <span class="type">V</span>](rdd2: <span class="type">RDD</span>[<span class="type">B</span>], preservesPartitioning: <span class="type">Boolean</span>)(f: (<span class="type">Iterator</span>[<span class="type">T</span>], <span class="type">Iterator</span>[<span class="type">B</span>]) â‡’ <span class="type">Iterator</span>[<span class="type">V</span>])(<span class="keyword">implicit</span> arg0: <span class="type">ClassTag</span>[<span class="type">B</span>], arg1: <span class="type">ClassTag</span>[<span class="type">V</span>]): <span class="type">RDD</span>[<span class="type">V</span>]</span><br><span class="line"></span><br><span class="line">zipWithIndex(): <span class="type">RDD</span>[(<span class="type">T</span>, <span class="type">Long</span>)]</span><br><span class="line"></span><br><span class="line">zipWithUniqueId(): <span class="type">RDD</span>[(<span class="type">T</span>, <span class="type">Long</span>)]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="èšåˆç›¸å…³"><a href="#èšåˆç›¸å…³" class="headerlink" title="èšåˆç›¸å…³"></a>èšåˆç›¸å…³</h3><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">aggregate[<span class="type">U</span>](zeroValue: <span class="type">U</span>)(seqOp: (<span class="type">U</span>, <span class="type">T</span>) â‡’ <span class="type">U</span>, combOp: (<span class="type">U</span>, <span class="type">U</span>) â‡’ <span class="type">U</span>)(<span class="keyword">implicit</span> arg0: <span class="type">ClassTag</span>[<span class="type">U</span>]): <span class="type">U</span></span><br><span class="line">aggregateç”¨æˆ·èšåˆ<span class="type">RDD</span>ä¸­çš„å…ƒç´ ï¼Œå…ˆä½¿ç”¨seqOpå°†<span class="type">RDD</span>ä¸­æ¯ä¸ªåˆ†åŒºä¸­çš„<span class="type">T</span>ç±»å‹å…ƒç´ èšåˆæˆ<span class="type">U</span>ç±»å‹ï¼Œå†ä½¿ç”¨combOpå°†ä¹‹å‰æ¯ä¸ªåˆ†åŒºèšåˆåçš„<span class="type">U</span>ç±»å‹èšåˆæˆ<span class="type">U</span>ç±»å‹ï¼Œç‰¹åˆ«æ³¨æ„seqOpå’ŒcombOpéƒ½ä¼šä½¿ç”¨zeroValueçš„å€¼ï¼ŒzeroValueçš„ç±»å‹ä¸º<span class="type">U</span>ã€‚</span><br><span class="line"></span><br><span class="line">treeAggregate[<span class="type">U</span>](zeroValue: <span class="type">U</span>)(seqOp: (<span class="type">U</span>, <span class="type">T</span>) â‡’ <span class="type">U</span>, combOp: (<span class="type">U</span>, <span class="type">U</span>) â‡’ <span class="type">U</span>, depth: <span class="type">Int</span> = <span class="number">2</span>)(<span class="keyword">implicit</span> arg0: <span class="type">ClassTag</span>[<span class="type">U</span>]): <span class="type">U</span></span><br><span class="line">å¤šå±‚çº§èšåˆ</span><br><span class="line"></span><br><span class="line">reduce(f: (<span class="type">T</span>, <span class="type">T</span>) â‡’ <span class="type">T</span>): <span class="type">T</span></span><br><span class="line">æ ¹æ®æ˜ å°„å‡½æ•°fï¼Œå¯¹<span class="type">RDD</span>ä¸­çš„å…ƒç´ è¿›è¡ŒäºŒå…ƒè®¡ç®—ï¼Œè¿”å›è®¡ç®—ç»“æœã€‚</span><br><span class="line"></span><br><span class="line">treeReduce(f: (<span class="type">T</span>, <span class="type">T</span>) â‡’ <span class="type">T</span>, depth: <span class="type">Int</span> = <span class="number">2</span>): <span class="type">T</span></span><br><span class="line">å¤šçº§reduceå½’å¹¶èšåˆ</span><br><span class="line"></span><br><span class="line">fold(zeroValue: <span class="type">T</span>)(op: (<span class="type">T</span>, <span class="type">T</span>) â‡’ <span class="type">T</span>): <span class="type">T</span></span><br><span class="line">foldæ˜¯aggregateçš„ç®€åŒ–ï¼Œå°†aggregateä¸­çš„seqOpå’ŒcombOpä½¿ç”¨åŒä¸€ä¸ªå‡½æ•°opã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">count(): <span class="type">Long</span></span><br><span class="line">countè¿”å›<span class="type">RDD</span>ä¸­çš„å…ƒç´ æ•°é‡ã€‚</span><br><span class="line"></span><br><span class="line">countApprox(timeout: <span class="type">Long</span>, confidence: <span class="type">Double</span> = <span class="number">0.95</span>): <span class="type">PartialResult</span>[<span class="type">BoundedDouble</span>]</span><br><span class="line">è¿‘ä¼¼count</span><br><span class="line"></span><br><span class="line">countApproxDistinct(relativeSD: <span class="type">Double</span> = <span class="number">0.05</span>): <span class="type">Long</span></span><br><span class="line">countApproxDistinct(p: <span class="type">Int</span>, sp: <span class="type">Int</span>): <span class="type">Long</span></span><br><span class="line">è¿‘ä¼¼distinct count</span><br><span class="line"></span><br><span class="line">countByValue()(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>] = <span class="literal">null</span>): <span class="type">Map</span>[<span class="type">T</span>, <span class="type">Long</span>]</span><br><span class="line">è®¡ç®—æ¯ä¸ªå€¼å‡ºç°æ¬¡æ•°</span><br><span class="line"></span><br><span class="line">countByValueApprox(timeout: <span class="type">Long</span>, confidence: <span class="type">Double</span> = <span class="number">0.95</span>)(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>] = <span class="literal">null</span>):</span><br><span class="line">è®¡ç®—æ¯ä¸ªå€¼å‡ºç°æ¬¡æ•°è¿‘ä¼¼å€¼</span><br><span class="line"></span><br><span class="line">distinct(): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">distinct(numPartitions: <span class="type">Int</span>)(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>] = <span class="literal">null</span>): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">è¿”å›å…ƒç´ å»é‡åçš„<span class="type">RDD</span></span><br><span class="line"></span><br><span class="line">groupBy[<span class="type">K</span>](f: (<span class="type">T</span>) â‡’ <span class="type">K</span>)(<span class="keyword">implicit</span> kt: <span class="type">ClassTag</span>[<span class="type">K</span>]): <span class="type">RDD</span>[(<span class="type">K</span>, <span class="type">Iterable</span>[<span class="type">T</span>])]</span><br><span class="line">groupBy[<span class="type">K</span>](f: (<span class="type">T</span>) â‡’ <span class="type">K</span>, numPartitions: <span class="type">Int</span>)(<span class="keyword">implicit</span> kt: <span class="type">ClassTag</span>[<span class="type">K</span>]): <span class="type">RDD</span>[(<span class="type">K</span>, <span class="type">Iterable</span>[<span class="type">T</span>])]</span><br><span class="line">groupBy[<span class="type">K</span>](f: (<span class="type">T</span>) â‡’ <span class="type">K</span>, p: <span class="type">Partitioner</span>)(<span class="keyword">implicit</span> kt: <span class="type">ClassTag</span>[<span class="type">K</span>], ord: <span class="type">Ordering</span>[<span class="type">K</span>] = <span class="literal">null</span>): <span class="type">RDD</span>[(<span class="type">K</span>, <span class="type">Iterable</span>[<span class="type">T</span>])]</span><br><span class="line">æŒ‰æŒ‡å®šå‡½æ•°ç”Ÿæˆkeyï¼Œå¹¶æŒ‰keyåˆ†ç»„ã€‚</span><br><span class="line">æ³¨æ„ï¼šæ€§èƒ½æ¯”è¾ƒå·®ï¼Œæ¨èç”¨<span class="type">PairRDDFunctions</span>.reduceByKey or <span class="type">PairRDDFunctions</span>.aggregateByKey.</span><br><span class="line">å› ä¸ºreduceByKeyä¼šå…ˆåœ¨åˆ†åŒºå†…åšèšåˆï¼Œå†è¿›è¡Œæ•°æ®äº¤æ¢(shuffle)ã€‚</span><br><span class="line"></span><br><span class="line">glom(): <span class="type">RDD</span>[<span class="type">Array</span>[<span class="type">T</span>]]</span><br><span class="line">è¯¥å‡½æ•°æ˜¯å°†<span class="type">RDD</span>ä¸­æ¯ä¸€ä¸ªåˆ†åŒºä¸­ç±»å‹ä¸º<span class="type">T</span>çš„å…ƒç´ è½¬æ¢æˆ<span class="type">Array</span>[<span class="type">T</span>]ï¼Œè¿™æ ·æ¯ä¸€ä¸ªåˆ†åŒºå°±åªæœ‰ä¸€ä¸ªæ•°ç»„å…ƒç´ ã€‚</span><br><span class="line"></span><br><span class="line">max()(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>]): <span class="type">T</span></span><br><span class="line">æœ€å¤§çš„å…ƒç´ </span><br><span class="line"></span><br><span class="line">min()(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>]): <span class="type">T</span></span><br><span class="line">æœ€å°çš„å…ƒç´ </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="éå†å…ƒç´ "><a href="#éå†å…ƒç´ " class="headerlink" title="éå†å…ƒç´ "></a>éå†å…ƒç´ </h3><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">foreach(f: (<span class="type">T</span>) â‡’ <span class="type">Unit</span>): <span class="type">Unit</span></span><br><span class="line">foreachç”¨äºéå†<span class="type">RDD</span>,å°†å‡½æ•°fåº”ç”¨äºæ¯ä¸€ä¸ªå…ƒç´ ã€‚</span><br><span class="line">ä½†è¦æ³¨æ„ï¼Œå¦‚æœå¯¹<span class="type">RDD</span>æ‰§è¡Œforeachï¼Œåªä¼šåœ¨<span class="type">Executor</span>ç«¯æœ‰æ•ˆï¼Œè€Œå¹¶ä¸æ˜¯<span class="type">Driver</span>ç«¯ã€‚</span><br><span class="line">æ¯”å¦‚ï¼šrdd.foreach(println)ï¼Œåªä¼šåœ¨<span class="type">Executor</span>çš„stdoutä¸­æ‰“å°å‡ºæ¥ï¼Œ<span class="type">Driver</span>ç«¯æ˜¯çœ‹ä¸åˆ°çš„ã€‚</span><br><span class="line"></span><br><span class="line">foreachPartition(f: (<span class="type">Iterator</span>[<span class="type">T</span>]) â‡’ <span class="type">Unit</span>): <span class="type">Unit</span></span><br><span class="line">foreachPartitionå’Œforeachç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯å¯¹æ¯ä¸€ä¸ªåˆ†åŒºä½¿ç”¨fã€‚</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="å–å…ƒç´ ç›¸å…³"><a href="#å–å…ƒç´ ç›¸å…³" class="headerlink" title="å–å…ƒç´ ç›¸å…³"></a>å–å…ƒç´ ç›¸å…³</h3><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">collect(): <span class="type">Array</span>[<span class="type">T</span>]</span><br><span class="line">collectç”¨äºå°†ä¸€ä¸ª<span class="type">RDD</span>è½¬æ¢æˆæ•°ç»„ã€‚</span><br><span class="line"></span><br><span class="line">first(): <span class="type">T</span></span><br><span class="line">firstè¿”å›<span class="type">RDD</span>ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä¸æ’åºã€‚</span><br><span class="line"></span><br><span class="line">take(num: <span class="type">Int</span>): <span class="type">Array</span>[<span class="type">T</span>]</span><br><span class="line">takeç”¨äºè·å–<span class="type">RDD</span>ä¸­ä»<span class="number">0</span>åˆ°num<span class="number">-1</span>ä¸‹æ ‡çš„å…ƒç´ ï¼Œä¸æ’åºã€‚</span><br><span class="line"></span><br><span class="line">top(num: <span class="type">Int</span>)(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>]): <span class="type">Array</span>[<span class="type">T</span>]</span><br><span class="line">topå‡½æ•°ç”¨äºä»<span class="type">RDD</span>ä¸­ï¼ŒæŒ‰ç…§é»˜è®¤ï¼ˆé™åºï¼‰æˆ–è€…æŒ‡å®šçš„æ’åºè§„åˆ™ï¼Œè¿”å›å‰numä¸ªå…ƒç´ ã€‚</span><br><span class="line"></span><br><span class="line">takeOrdered(num: <span class="type">Int</span>)(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>]): <span class="type">Array</span>[<span class="type">T</span>]</span><br><span class="line">takeOrderedå’Œtopç±»ä¼¼ï¼Œåªä¸è¿‡ä»¥å’Œtopç›¸åçš„é¡ºåºè¿”å›å…ƒç´ </span><br><span class="line"></span><br><span class="line">takeSample(withReplacement: <span class="type">Boolean</span>, num: <span class="type">Int</span>, seed: <span class="type">Long</span> = <span class="type">Utils</span>.random.nextLong): <span class="type">Array</span>[<span class="type">T</span>]</span><br><span class="line">å–æ ·æœ¬å…ƒç´ </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="é›†åˆé—´è¿ç®—"><a href="#é›†åˆé—´è¿ç®—" class="headerlink" title="é›†åˆé—´è¿ç®—"></a>é›†åˆé—´è¿ç®—</h3><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">++(other: <span class="type">RDD</span>[<span class="type">T</span>]): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">ä¸å¦ä¸€ä¸ª<span class="type">RDD</span> unionã€‚</span><br><span class="line"></span><br><span class="line">intersection(other: <span class="type">RDD</span>[<span class="type">T</span>], partitioner: <span class="type">Partitioner</span>)(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>] = <span class="literal">null</span>): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">intersection(other: <span class="type">RDD</span>[<span class="type">T</span>], numPartitions: <span class="type">Int</span>): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">intersection(other: <span class="type">RDD</span>[<span class="type">T</span>]): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">å–äº¤é›†</span><br><span class="line"></span><br><span class="line">subtract(other: <span class="type">RDD</span>[<span class="type">T</span>], p: <span class="type">Partitioner</span>)(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>] = <span class="literal">null</span>): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">subtract(other: <span class="type">RDD</span>[<span class="type">T</span>], numPartitions: <span class="type">Int</span>): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">subtract(other: <span class="type">RDD</span>[<span class="type">T</span>]): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">æ±‚å·®é›†</span><br><span class="line"></span><br><span class="line">union(other: <span class="type">RDD</span>[<span class="type">T</span>]): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">ä¸å¦ä¸€ä¸ª<span class="type">RDD</span>åˆå¹¶ï¼Œç±»ä¼¼union all,ä¸ä¼šå»é‡ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">persist(): <span class="type">RDD</span>.<span class="keyword">this</span>.<span class="keyword">type</span></span><br><span class="line">persist(newLevel: <span class="type">StorageLevel</span>): <span class="type">RDD</span>.<span class="keyword">this</span>.<span class="keyword">type</span></span><br><span class="line">ç¼“å­˜æ•°æ®ï¼Œå¯è®¾ç½®ç¼“å­˜çº§åˆ«(å¦‚æœå°šæœªè®¾ç½®è¿‡ï¼Œæ‰å¯ä»¥è®¾ç½®ï¼Œæœ¬åœ°checkpointé™¤å¤–)</span><br><span class="line"></span><br><span class="line">unpersist(blocking: <span class="type">Boolean</span> = <span class="literal">true</span>): <span class="type">RDD</span>.<span class="keyword">this</span>.<span class="keyword">type</span></span><br><span class="line"><span class="type">Mark</span> the <span class="type">RDD</span> as non-persistent, and remove all blocks <span class="keyword">for</span> it from memory and disk.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cache(): <span class="type">RDD</span>.<span class="keyword">this</span>.<span class="keyword">type</span></span><br><span class="line"><span class="type">MEMORY_ONLY</span>çº§åˆ«ç¼“å­˜æ•°æ®</span><br><span class="line"></span><br><span class="line">cartesian[<span class="type">U</span>](other: <span class="type">RDD</span>[<span class="type">U</span>])(<span class="keyword">implicit</span> arg0: <span class="type">ClassTag</span>[<span class="type">U</span>]): <span class="type">RDD</span>[(<span class="type">T</span>, <span class="type">U</span>)]ï¼š</span><br><span class="line">è®¡ç®—ä¸¤ä¸ª<span class="type">RDD</span>çš„è¿ªå¡å°”ç§¯</span><br><span class="line"></span><br><span class="line">checkpoint(): <span class="type">Unit</span></span><br><span class="line">æ ‡è®°å°†è¯¥<span class="type">RDD</span>è¿›è¡Œcheckpointå¤„ç†ï¼Ÿ</span><br><span class="line"></span><br><span class="line">coalesce(numPartitions: <span class="type">Int</span>, shuffle: <span class="type">Boolean</span> = <span class="literal">false</span>)(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>] = <span class="literal">null</span>): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">åˆ†åŒºåˆå¹¶(åªèƒ½å‡å°‘åˆ†åŒº)ï¼Œä½¿ç”¨<span class="type">HashPartitioner</span>ã€‚</span><br><span class="line">ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºé‡åˆ†åŒºçš„æ•°ç›®ï¼Œç¬¬äºŒä¸ªä¸ºæ˜¯å¦è¿›è¡Œshuffleï¼Œé»˜è®¤ä¸º<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">repartition(numPartitions: <span class="type">Int</span>)(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>] = <span class="literal">null</span>): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">è°ƒæ•´åˆ†åŒºæ•°ï¼Œä¼šå¯¼è‡´shuffleï¼Œå¦‚æœæ˜¯å‡å°‘åˆ†åŒºï¼Œå¯ä»¥ä½¿ç”¨coalesceï¼Œé¿å…shuffleã€‚</span><br><span class="line"></span><br><span class="line">toDebugString: <span class="type">String</span></span><br><span class="line">è¿”å›<span class="type">RDD</span>ä¾èµ–æ ‘/è¡€ç»Ÿå›¾</span><br><span class="line"></span><br><span class="line">getCheckpointFile: <span class="type">Option</span>[<span class="type">String</span>]</span><br><span class="line">è·å–checkpointæ–‡ä»¶å¤¹åç§°</span><br><span class="line"></span><br><span class="line">localCheckpoint(): <span class="type">RDD</span>.<span class="keyword">this</span>.<span class="keyword">type</span></span><br><span class="line">æ ‡è®°ä¸ºä½¿ç”¨æœ¬åœ°checkpoint</span><br><span class="line"></span><br><span class="line">isEmpty(): <span class="type">Boolean</span></span><br><span class="line">æ˜¯å¦å«<span class="number">0</span>ä¸ªå…ƒç´ </span><br><span class="line"></span><br><span class="line">iterator(split: <span class="type">Partition</span>, context: <span class="type">TaskContext</span>): <span class="type">Iterator</span>[<span class="type">T</span>]</span><br><span class="line">è¿”å›è¿­ä»£å™¨ï¼Œä¸åº”ç›´æ¥è°ƒç”¨ï¼Œè€Œæ˜¯ç»™<span class="type">RDD</span>çš„å­ç±»ç”¨çš„ã€‚</span><br><span class="line"></span><br><span class="line">toLocalIterator: <span class="type">Iterator</span>[<span class="type">T</span>]</span><br><span class="line">è¿”å›å…ƒç´ çš„æœ¬åœ°è¿­ä»£å™¨</span><br><span class="line"></span><br><span class="line">pipe(command: <span class="type">String</span>): <span class="type">RDD</span>[<span class="type">String</span>]</span><br><span class="line">pipe(command: <span class="type">String</span>, env: <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>]): <span class="type">RDD</span>[<span class="type">String</span>]</span><br><span class="line">pipe(command: <span class="type">Seq</span>[<span class="type">String</span>], env: <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>] = <span class="type">Map</span>(), printPipeContext: ((<span class="type">String</span>) â‡’ <span class="type">Unit</span>) â‡’ <span class="type">Unit</span> = <span class="literal">null</span>, printRDDElement: (<span class="type">T</span>, (<span class="type">String</span>) â‡’ <span class="type">Unit</span>) â‡’ <span class="type">Unit</span> = <span class="literal">null</span>, separateWorkingDir: <span class="type">Boolean</span> = <span class="literal">false</span>, bufferSize: <span class="type">Int</span> = <span class="number">8192</span>, encoding: <span class="type">String</span> = <span class="type">Codec</span>.defaultCharsetCodec.name): <span class="type">RDD</span>[<span class="type">String</span>]</span><br><span class="line">è°ƒç”¨å¤–éƒ¨è¿›ç¨‹å¤„ç†<span class="type">RDD</span>,å¦‚é€šè¿‡æ ‡å‡†è¾“å…¥ä¼ ç»™shellè„šæœ¬ã€‚</span><br><span class="line"></span><br><span class="line">preferredLocations(split: <span class="type">Partition</span>): <span class="type">Seq</span>[<span class="type">String</span>]</span><br><span class="line"><span class="type">Get</span> the preferred locations of a partition, taking into account whether the <span class="type">RDD</span> is checkpointed.</span><br><span class="line"></span><br><span class="line">randomSplit(weights: <span class="type">Array</span>[<span class="type">Double</span>], seed: <span class="type">Long</span> = <span class="type">Utils</span>.random.nextLong): <span class="type">Array</span>[<span class="type">RDD</span>[<span class="type">T</span>]]</span><br><span class="line">æŒ‰æƒéšæœºå°†å…ƒç´ åˆ†ç»„</span><br><span class="line"></span><br><span class="line">sample(withReplacement: <span class="type">Boolean</span>, fraction: <span class="type">Double</span>, seed: <span class="type">Long</span> = <span class="type">Utils</span>.random.nextLong): <span class="type">RDD</span>[<span class="type">T</span>]</span><br><span class="line">å–æ ·æœ¬/å­é›†</span><br><span class="line"></span><br><span class="line">setName(_name: <span class="type">String</span>): <span class="type">RDD</span>.<span class="keyword">this</span>.<span class="keyword">type</span></span><br><span class="line">è®¾ç½®<span class="type">RDD</span>åå­—</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ä¿å­˜"><a href="#ä¿å­˜" class="headerlink" title="ä¿å­˜"></a>ä¿å­˜</h3><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">saveAsObjectFile(path: <span class="type">String</span>): <span class="type">Unit</span></span><br><span class="line">ä¿å­˜ä¸º<span class="type">SequenceFile</span></span><br><span class="line"></span><br><span class="line">saveAsTextFile(path: <span class="type">String</span>, codec: <span class="type">Class</span>[_ &lt;: <span class="type">CompressionCodec</span>]): <span class="type">Unit</span></span><br><span class="line">saveAsTextFile(path: <span class="type">String</span>): <span class="type">Unit</span></span><br><span class="line">ä¿å­˜ä¸ºæ–‡æœ¬æ–‡ä»¶</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h2><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">context: <span class="type">SparkContext</span></span><br><span class="line">åˆ›å»º<span class="type">RDD</span>çš„<span class="type">SparkContext</span></span><br><span class="line"></span><br><span class="line">sparkContext: <span class="type">SparkContext</span></span><br><span class="line">åˆ›å»º<span class="type">RDD</span>çš„<span class="type">SparkContext</span></span><br><span class="line"></span><br><span class="line">dependencies: <span class="type">Seq</span>[<span class="type">Dependency</span>[_]]</span><br><span class="line"><span class="type">RDD</span>çš„ä¾èµ–åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">getNumPartitions: <span class="type">Int</span></span><br><span class="line">è·å–<span class="type">RDD</span>çš„åˆ†åŒºæ•°</span><br><span class="line"></span><br><span class="line">getStorageLevel: <span class="type">StorageLevel</span></span><br><span class="line">è·å–å­˜å‚¨ç­‰çº§ï¼Œå¦‚æœè®¾ç½®ä¸ºnone,åˆ™è¿”å›<span class="type">StorageLevel</span>.<span class="type">NONE</span> ã€‚</span><br><span class="line"></span><br><span class="line">id: <span class="type">Int</span></span><br><span class="line">è¯¥<span class="type">RDD</span>çš„unique <span class="type">ID</span></span><br><span class="line"></span><br><span class="line">isCheckpointed: <span class="type">Boolean</span></span><br><span class="line">æ˜¯å¦checkpointed and materialized, either reliably or locally.</span><br><span class="line"></span><br><span class="line">name: <span class="type">String</span></span><br><span class="line"><span class="type">RDD</span>çš„åå­—</span><br><span class="line"></span><br><span class="line">partitioner: <span class="type">Option</span>[<span class="type">Partitioner</span>]</span><br><span class="line">åˆ†åŒºå™¨</span><br><span class="line"></span><br><span class="line">partitions: <span class="type">Array</span>[<span class="type">Partition</span>]</span><br><span class="line">å„ä¸ªåˆ†åŒº</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>API</tag>
      </tags>
  </entry>
  <entry>
    <title>Spark work with MySQL</title>
    <url>/2016/12/27/spark-work-with-mysql/</url>
    <content><![CDATA[<p>With spark 2.0.x,we can use DataFrameReader and DataFrameWriter.<br>Use SparkSession.read to access DataFrameReader and use Dataset.write to access DataFrameWriter.</p>
<span id="more"></span>

<p>Suppose using spark-shell.</p>
<h1 id="read-example"><a href="#read-example" class="headerlink" title="read example"></a>read example</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> prop=<span class="keyword">new</span> java.util.<span class="type">Properties</span>()</span><br><span class="line">prop.put(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;username&quot;</span>)</span><br><span class="line">prop.put(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;yourpassword&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> url=<span class="string">&quot;jdbc:mysql://host:3306/db_name&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> df=spark.read.jdbc(url,<span class="string">&quot;table_name&quot;</span>,prop)</span><br><span class="line">df.show()</span><br></pre></td></tr></table></figure>

<h1 id="read-example2"><a href="#read-example2" class="headerlink" title="read example2"></a>read example2</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> jdbcDF = spark.read</span><br><span class="line">  .format(<span class="string">&quot;jdbc&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:mysql:dbserver&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;dbtable&quot;</span>, <span class="string">&quot;schema.tablename&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;username&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">  .load()</span><br></pre></td></tr></table></figure>

<h1 id="read-example3"><a href="#read-example3" class="headerlink" title="read example3"></a>read example3</h1><p>If you want to read data from a query result rather than a table.</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> sql=<span class="string">&quot;&quot;&quot;select * from db.your_table where id&gt;1&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">val</span> jdbcDF = spark.read</span><br><span class="line">  .format(<span class="string">&quot;jdbc&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:mysql:dbserver&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;dbtable&quot;</span>,  <span class="string">s&quot;( <span class="subst">$sql</span> ) t&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;username&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">  .load()</span><br></pre></td></tr></table></figure>

<h1 id="write-example"><a href="#write-example" class="headerlink" title="write example"></a>write example</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SaveMode</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> prop=<span class="keyword">new</span> java.util.<span class="type">Properties</span>()</span><br><span class="line">prop.put(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;username&quot;</span>)</span><br><span class="line">prop.put(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;yourpassword&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> url=<span class="string">&quot;jdbc:mysql://host:3306/db_name&quot;</span></span><br><span class="line"><span class="comment">//df is a dataframe contains the data which you want to write.</span></span><br><span class="line">df.write.mode(<span class="type">SaveMode</span>.<span class="type">Append</span>).jdbc(url,<span class="string">&quot;table_name&quot;</span>,prop)</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäºSparkå®ç°æ¨èç®—æ³•-1:æ¨èç®—æ³•ç®€ä»‹</title>
    <url>/2018/05/02/spark-recommendation-1/</url>
    <content><![CDATA[<h1 id="ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿç®€ä»‹"><a href="#ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿç®€ä»‹" class="headerlink" title="ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿç®€ä»‹"></a>ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿç®€ä»‹</h1><p>ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿçš„å®šä¹‰åœ¨ 1997 å¹´ç”± Resnick å’Œ Varian æå‡º:åˆ©ç”¨äº’è”ç½‘å‘ç”¨æˆ·æä¾›ä¿¡ æ¯å’Œå»ºè®®ï¼Œå¸®åŠ©ç”¨æˆ·é€‰æ‹©äº§å“ï¼Œæˆ–æ¨¡æ‹Ÿå”®è´§å‘˜å¸®åŠ©ç”¨æˆ·å®Œæˆè´­ä¹°è¡Œä¸ºçš„ç³»ç»Ÿ ã€‚é€šå¸¸æ¨è ç”±ä¸‰ä¸ªè¦ç´ ç»„æˆ:æ¨èç®—æ³•ã€ç”¨æˆ·ã€å€™é€‰æ¨èé¡¹ç›®ã€‚ç®€å•æ¥è¯´ï¼Œä¸€æ¬¡æ¨èè¿‡ç¨‹å°±æ˜¯æ¨èç®— æ³•ä»å€™é€‰æ¨èé¡¹ç›®ä¸­æŒ‘å‡ºæŸäº›é¡¹ç›®ç»™ç”¨æˆ·ã€‚</p>
<span id="more"></span>

<p>ç›®å‰ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿå·²ç»åœ¨ç”µå­å•†åŠ¡ã€è§†é¢‘ã€éŸ³ä¹ã€æ–°é—»ã€åšå®¢ç­‰é¢†åŸŸå¾—åˆ°äº†å¹¿æ³›åº” ç”¨ã€‚é€šå¸¸è¿™äº›é¢†åŸŸçš„ç½‘ç«™å’Œåº”ç”¨ä¼šæ¨èè‹¥å¹²å•†å“æˆ–è€…ä½œå“ç»™ç”¨æˆ·ï¼Œè¿™äº›æ¨èé¡¹ç›®é€šå¸¸ä»¥â€œçŒœ ä½ å–œæ¬¢â€ã€â€œè´­ä¹°æ­¤å•†å“çš„é¡¾å®¢ä¹ŸåŒæ—¶è´­ä¹°â€ã€â€œç›¸ä¼¼çš„å•†å“â€ç­‰å½¢å¼å‡ºç°ï¼Œæ‰€æ¨èçš„ç‰©å“ä¾¿ æ˜¯æ¨èç³»ç»Ÿé€šè¿‡æ¨èç®—æ³•ä»æµ·é‡ç‰©å“ä¸­æŒ‘é€‰å‡ºçš„ã€‚ç”±äºæ¨èç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·çš„å†å²è¡Œä¸ºæ•° æ®ç»™å‡ºå› äººè€Œå¼‚çš„æ¨èç»“æœï¼Œæ‰€ä»¥ç§°ä¹‹ä¸ºä¸ªæ€§åŒ–æ¨èã€‚</p>
<p>ä¸€å¥—å®Œæ•´çš„ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿé€šå¸¸åŒ…æ‹¬ç”¨æˆ·ä¿¡æ¯æ”¶é›†ã€æ¨èæ¨¡å‹è®¡ç®—ã€æ¨èç»“æœå±•ç¤ºä¸‰ ä¸ªéƒ¨åˆ†ã€‚ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿé¦–å…ˆæ”¶é›†ç”¨æˆ·çš„ç½‘ç»œæ“ä½œè¡Œä¸ºâ€”â€”å¦‚æµè§ˆã€è¯„åˆ†ã€è´­ä¹°ç­‰ï¼Œå°†è¿™ äº›è¡Œä¸ºæ•°æ®å­˜å‚¨åˆ°æ•°æ®ä»“åº“ä¸­ã€‚ç„¶åé€šè¿‡æœºå™¨å­¦ä¹ ã€æ•°æ®æŒ–æ˜ç­‰ç›¸å…³æŠ€æœ¯æ¥å¯¹è¿™äº›æ•°æ®è¿› è¡Œåˆ†æï¼Œæ›´è¿›ä¸€æ­¥å¯ä»¥ä»è¿™äº›å†å²æ•°æ®ä¸­å­¦ä¹ ç”¨æˆ·çš„å…´è¶£çˆ±å¥½ï¼Œè¿è¡Œæ¨èç®—æ³•ç”Ÿæˆæ¨èæ¨¡ å‹ã€‚æœ‰äº†æ¨èæ¨¡å‹ï¼Œä¾¿å¯ä»¥ä¸ºç”¨æˆ·æä¾›ä¸ªæ€§åŒ–çš„æ¨èæœåŠ¡ï¼Œå®ç°ä¸»åŠ¨æ¨èçš„ç›®çš„ã€‚ä¸ªæ€§åŒ– æ¨èæŠ€æœ¯å¯ä»¥å……åˆ†æé«˜ä¿¡æ¯ç³»ç»Ÿæˆ–è€…ç«™ç‚¹çš„æœåŠ¡è´¨é‡å’Œä½¿ç”¨æ•ˆç‡ï¼Œä»è€Œå¸å¼•æ›´å¤šçš„ç”¨æˆ· ã€‚</p>
<p>ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿçš„è¾“å…¥æ•°æ®å¯ä»¥æœ‰å¤šç§æ¥æºé€”å¾„ï¼Œé€šå¸¸åˆ†ä¸ºæ˜¾ç¤ºè¾“å…¥å’Œéšå¼è¾“å…¥ä¸¤ç§ ç±»å‹ã€‚æ˜¾ç¤ºè¾“å…¥æ˜¯æŒ‡ç”¨æˆ·æ˜ç¡®è¡¨è¾¾å–œå¥½çš„è¡Œä¸ºï¼Œä¾‹å¦‚ç»™ç”µå½±è¯„åˆ†ã€ç»™å¾®åšç‚¹èµã€è´­ç‰©åç»™ äºˆå¥½è¯„æˆ–å·®è¯„ç­‰ã€‚éšå¼è¾“å…¥åˆ™ä¸€èˆ¬æ˜¯éç‰¹æ„çš„è¡Œä¸ºï¼Œå¦‚æµè§ˆå•†å“è¯¦æƒ…é¡µé¢ã€æŸ¥çœ‹ç”µå½±è¯„ä»·ã€ æœç´¢å…³é”®è¯ç­‰ï¼Œè¿™äº›è¡Œä¸ºå¹¶ä¸ä»£è¡¨ç”¨æˆ·å–œæ¬¢æˆ–è®¨åŒæŸä¸ªç‰©å“ï¼Œä½†æ˜¯æ¨èç³»ç»Ÿèƒ½å¤Ÿä»ä¸­æŒ–æ˜ å‡ºç”¨æˆ·çš„å…´è¶£ä¿¡æ¯ã€‚</p>
<p>ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿçš„è¾“å‡ºä¹Ÿæ˜¯å¤šæ ·åŒ–çš„ï¼Œæœ‰å„ç§å„æ ·çš„å½¢å¼ã€‚æœ€å¸¸è§çš„æ˜¯æ¨èåˆ—è¡¨å½¢å¼ï¼Œ<br>å¦‚äºšé©¬é€Šç­‰ç”µå­å•†åŠ¡ç½‘ç«™çš„æ¨èå•†å“åˆ—è¡¨ã€YouTube ç­‰è§†é¢‘ç½‘ç«™çš„æ¨èå½±ç‰‡åˆ—è¡¨ã€å¾®åšç­‰ ç¤¾äº¤ç½‘ç«™çš„æ¨èå…³æ³¨ç”¨æˆ·ç­‰ã€‚è¿™ç±»æ˜¯æœ€ç›´æ¥çš„æ¨èå½¢å¼ï¼Œæ˜ç¡®å‘Šè¯‰äº†ç”¨æˆ·è¿™äº›æ˜¯æ¨èç»“æœï¼Œ å±äºæ˜¾ç¤ºçš„æ¨èã€‚å¦ä¸€ç±»å½¢å¼æ˜¯æ¯”è¾ƒéšå¼çš„æ¨è:è´­ç‰©ç½‘ç«™åœ¨å…³é”®è¯æœç´¢ç»“æœåˆ—è¡¨ä¸­åŠ å…¥ æ¨èçš„ç»“æœ;æ–°é—»ç½‘ç«™æ ¹æ®æ¨èç®—æ³•ä¼˜åŒ–æ–‡ç« çš„æ’åº;ç½‘ç»œé—®ç­”ç¤¾åŒºæŠŠç”¨æˆ·å¯èƒ½æ„Ÿå…´è¶£çš„ è¯é¢˜ä¼˜å…ˆå±•ç¤ºã€‚è¿™äº›æ¨èç³»ç»Ÿèå…¥åˆ°äº†ä¼ ç»Ÿçš„ç³»ç»Ÿæ¨¡å—ä¸­ï¼Œèµ·åˆ°æå‡åŸæœ‰ç³»ç»ŸåŠŸèƒ½çš„æ•ˆæœã€‚</p>
<h1 id="æ¨èç®—æ³•åˆ†ç±»"><a href="#æ¨èç®—æ³•åˆ†ç±»" class="headerlink" title="æ¨èç®—æ³•åˆ†ç±»"></a>æ¨èç®—æ³•åˆ†ç±»</h1><p>æ¨èç®—æ³•æ˜¯æ¨èç³»ç»Ÿçš„æ ¸å¿ƒï¼Œç›´æ¥å†³å®šç€æ¨èç³»ç»Ÿçš„æ€§èƒ½å’Œæ•ˆæœã€‚ä¾æ®æ¨èæ–¹æ³•çš„ä¸ åŒï¼Œé€šå¸¸æ¨èç®—æ³•å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ å¤§ç±»:åŸºäºå†…å®¹çš„æ¨è(Content-Based Recommendation)ï¼Œ ååŒè¿‡æ»¤æ¨è (Collaborative Filtering Recommendation) ï¼Œ æ·· åˆ å‹ æ¨ è (Hybrid Recommendation) ã€‚</p>
<p><img src="http://orfd3hw7v.bkt.clouddn.com/601d55beb52c4fcb9e1d1549cf0a8438.png-liam" alt="æ¨èç®—æ³•åˆ†ç±»"></p>
<h2 id="åŸºäºå†…å®¹çš„æ¨è"><a href="#åŸºäºå†…å®¹çš„æ¨è" class="headerlink" title="åŸºäºå†…å®¹çš„æ¨è"></a>åŸºäºå†…å®¹çš„æ¨è</h2><p>  åŸºäºå†…å®¹çš„æ¨èæ˜¯ç”¨é¡¹ç›®å†…å®¹æˆ–ç‰¹å¾æ¥å®šä¹‰æ‰€è¦æ¨èçš„é¡¹ç›®æˆ–å¯¹è±¡ï¼Œç„¶åç³»ç»ŸåŸºäºç”¨æˆ·è¯„ä»·å¯¹è±¡çš„ç‰¹å¾å­¦ä¹ ç”¨æˆ·çš„å…´è¶£ï¼Œä¾æ®ç”¨æˆ·èµ„æ–™ä¸å¾…é¢„æµ‹é¡¹ç›®çš„åŒ¹é…ç¨‹åº¦è¿›è¡Œæ¨èã€‚é¡¹ç›®æˆ–å¯¹è±¡çš„ç‰¹å¾é€šå¸¸æ˜¯æ–‡æœ¬å†…å®¹ï¼Œæ¯”å¦‚æ ‡é¢˜ã€åç§°ã€æ ‡ç­¾åŠè¯¥ç‰©å“çš„å…¶ä»–å…ƒæ•°æ®ã€‚åŸºäºå†…å®¹çš„æ¨èç³»ç»Ÿä¸å¯é¿å…åœ°å—åˆ°æœ‰é™çš„ç‰¹å¾ä¿¡æ¯è·å–æŠ€æœ¯çš„çº¦æŸï¼Œæ ¹æ®æ¨èå¯¹è±¡çš„ä¸åŒï¼Œå¯èƒ½ä¼šè¦ç”¨åˆ°æ–‡æœ¬æŒ–æ˜æŠ€æœ¯ã€å›¾ç‰‡è¯†åˆ«æŠ€æœ¯ã€è§†é¢‘æŒ–æ˜æŠ€æœ¯ç­‰ã€‚ç‰¹åˆ«æ˜¯è‡ªåŠ¨æå–å¤šåª’ä½“æ•°æ®å†…å®¹ç‰¹å¾çš„ç›¸å…³æŠ€æœ¯è¿˜ä¸æ˜¯å¾ˆæˆç†Ÿï¼Œå¯¼è‡´åŸºäºå†…å®¹çš„æ¨èç®—æ³•åœ¨è¿™æ–¹é¢çš„ç›¸å…³åº”ç”¨å—åˆ°äº†å¾ˆå¤§é™åˆ¶ã€‚</p>
<h2 id="ååŒè¿‡æ»¤æ¨è"><a href="#ååŒè¿‡æ»¤æ¨è" class="headerlink" title="ååŒè¿‡æ»¤æ¨è"></a>ååŒè¿‡æ»¤æ¨è</h2><p>ååŒè¿‡æ»¤(Collaborative Filteringï¼ŒCF)æ˜¯ä¸€ç§æ ¹æ®ç”¨æˆ·å¯¹å„ç§äº§å“çš„äº¤äº’ä¸è¯„åˆ†æ¥æ¨è æ–°äº§å“çš„æ¨èç³»ç»ŸæŠ€æœ¯ã€‚ååŒè¿‡æ»¤æœ€çªå‡ºçš„ä¼˜ç‚¹å°±åœ¨äºå®ƒçš„é²æ£’æ€§ï¼Œé€‚ç”¨äºå¤šç§è¾“å…¥æ•°æ®: æ— è®ºæ˜¯â€œæ˜¾å¼â€çš„è¾“å…¥æ•°æ®(ä¾‹å¦‚åœ¨ç”µå½±ç½‘ç«™ä¸Šè¿›è¡Œè¯„åˆ†)è¿˜æ˜¯â€œéšå¼â€çš„(ä¾‹å¦‚ç”¨æˆ·è®¿ é—®äº†ä¸€ä¸ªäº§å“çš„é¡µé¢ä½†æ˜¯æ²¡æœ‰å¯¹äº§å“è¯„åˆ†)éƒ½å¯ä»¥ç”¨æ¥åšååŒè¿‡æ»¤ã€‚ä»…ä»…æ ¹æ®è¿™äº›äº¤äº’ï¼Œ ååŒè¿‡æ»¤ç®—æ³•å°±èƒ½å¤ŸçŸ¥é“å“ªäº›äº§å“ä¹‹é—´æ¯”è¾ƒç›¸ä¼¼ä»¥åŠå“ªäº›ç”¨æˆ·ä¹‹é—´æ¯”è¾ƒç›¸ä¼¼ï¼Œç„¶åå°±å¯ä»¥ åšå‡ºæ–°çš„æ¨è ã€‚ç›¸æ¯”ä¸åŸºäºå†…å®¹çš„æ¨èç®—æ³•ï¼ŒååŒè¿‡æ»¤æ¨èç®—æ³•ä¸éœ€è¦åˆ†æé¡¹ç›®çš„å†… å®¹å’Œç‰¹å¾ï¼Œæ‰€ä»¥å¯ä»¥ä¸ä¾èµ–äºç‰¹å¾ä¿¡æ¯è·å–æŠ€æœ¯ï¼Œä»è€Œé€‚ç”¨äºå„ç§ç±»åˆ«çš„é¡¹ç›®ã€‚</p>
<p>æ€»ä½“ä¸Šæ¥è¯´ï¼ŒååŒè¿‡æ»¤æ˜¯ä¸€ç§åˆ©ç”¨é›†ä½“æ™ºæ…§çš„æ–¹æ³•ï¼Œä½¿ç”¨éƒ¨åˆ†æˆ–æ‰€æœ‰ç”¨æˆ·çš„è¡Œä¸ºæ•°æ®æ¥è¿›è¡Œæ¨èï¼Œä¸åŒç”¨æˆ·é€šè¿‡æ¨èç³»ç»Ÿé—´æ¥åœ°ç›¸äº’åä½œï¼Œæ¥è·å–å„è‡ªæ„Ÿå…´è¶£çš„ä¿¡æ¯ã€‚ååŒè¿‡ æ»¤çš„æ ¸å¿ƒæ˜¯æ‰¾å‡ºç”¨æˆ·æˆ–é¡¹ç›®çš„é‚»å±…ï¼Œå³ç›¸ä¼¼çš„ç”¨æˆ·æˆ–é¡¹ç›®ï¼Œç„¶åå–è‹¥å¹²ä¸ªæœ€è¿‘é‚»å±…æ¨èç»™ ç”¨æˆ·ã€‚æ ¹æ®å…·ä½“çš„å®ç°ï¼ŒååŒè¿‡æ»¤åˆå¯ä»¥è¢«åˆ†ä¸ºå¤šä¸ªå­ç±»åˆ«ï¼Œåˆ†åˆ«æ˜¯åŸºäºè®°å¿†çš„ååŒè¿‡æ»¤ (Memory-Based Collaborative Filtering)ï¼ŒåŸºäºæ¨¡å‹çš„ååŒè¿‡æ»¤(Model-Based Collaborative Filtering)ï¼ŒåŸºäºç¤¾äº¤ç½‘ç»œå…³ç³»çš„ååŒè¿‡æ»¤(Social-Based Collaborative Filtering)ç­‰ã€‚</p>
<h3 id="åŸºäºè®°å¿†çš„ååŒè¿‡æ»¤"><a href="#åŸºäºè®°å¿†çš„ååŒè¿‡æ»¤" class="headerlink" title="åŸºäºè®°å¿†çš„ååŒè¿‡æ»¤"></a>åŸºäºè®°å¿†çš„ååŒè¿‡æ»¤</h3><p>åŸºäºè®°å¿†çš„ååŒè¿‡æ»¤ç®—æ³•ä½¿ç”¨å…¨éƒ¨æˆ–å¤§éƒ¨åˆ†ç”¨æˆ·â€”é¡¹ç›®æ•°æ®æ¥ç”Ÿæˆé¢„æµ‹ã€‚åŸºäºè®°å¿†çš„ ååŒè¿‡æ»¤å¸¸ç”¨çš„æœ‰ä¸¤ç§ :åŸºäºç‰©å“çš„ååŒè¿‡æ»¤(Item-Based Collaborative Filteringï¼Œ Item-Based CF) å’ŒåŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤ (User-Based Collaborative Filteringï¼ŒUser-Based CF)ã€‚</p>
<p>å¯¹äºç±»ä¼¼å¾®åšã€æ–°é—»ã€è®ºå›ã€ç¤¾äº¤å’ŒçŸ¥è¯†é—®ç­”ç­‰å†…å®¹æå¤šã€å€™é€‰æ¨èé¡¹ç›®åºå¤§çš„ç³»ç»Ÿï¼Œ User-Based CF æ–¹æ³•é€šå¸¸ä¼˜äº Item-Based CFã€‚å› ä¸ºè¿™ç§æƒ…å†µä¸‹ï¼Œç‰©å“ç›¸ä¼¼åº¦çš„è®¡ç®—é‡å·¨å¤§ï¼Œ è€Œä¸”éœ€è¦é¢‘ç¹æ›´æ–°ï¼Œè€Œä½¿ç”¨ User-Based CF èƒ½å¤Ÿé¿å…è®¡ç®—ç‰©å“é—´çš„ç›¸ä¼¼åº¦ã€‚ç›¸åï¼Œå¯¹äºä¸€ ä¸ªç”¨æˆ·æ•°é‡è¿œè¶…è¿‡ç‰©å“æ•°é‡çš„åº”ç”¨æ¥è¯´ï¼Œæ­¤æ—¶ Item-Based CF çš„æ€§èƒ½å¯èƒ½æ¯” User-Based CF æ›´ä¼˜ï¼Œè¿™æ˜¯ç”±äºæ­¤ç§æƒ…å†µçš„ç‰©å“é—´ç›¸ä¼¼åº¦è¦æ¯”ç”¨æˆ·é—´ç›¸ä¼¼åº¦æ›´å®¹æ˜“è®¡ç®—ã€‚ç”±æ­¤å¯è§ï¼Œæ¨è ç³»ç»Ÿçš„è®¾è®¡è€…å¿…é¡»æ ¹æ®åº”ç”¨çš„ç‰¹ç‚¹æ¥é€‰æ‹©åˆé€‚çš„ç®—æ³• ï¼Œä¸èƒ½ä¸€æ¦‚è€Œè®ºã€‚</p>
<p>ä¸åŸºäºå†…å®¹çš„æ¨èç®—æ³•ç›¸æ¯”ï¼ŒItem-Based CF å’Œ User-Based CF æœ‰ä¸‹åˆ—ä¼˜ç‚¹:</p>
<ul>
<li><ol>
<li>èƒ½å¤Ÿè¿‡æ»¤éš¾ä»¥è¿›è¡Œå†…å®¹åˆ†æçš„ä¿¡æ¯ï¼Œå¦‚è‰ºæœ¯å“ã€éŸ³ä¹ã€æ–‡æœ¬ã€è§†é¢‘;</li>
</ol>
</li>
<li><ol start="2">
<li>å¯ä»¥åŸºäºä¸€äº›å¤æ‚çš„ï¼Œéš¾ä»¥æè¿°çš„æ¦‚å¿µè¿›è¡Œè¿‡æ»¤ï¼Œå¦‚å“è´¨ã€é£æ ¼ã€æµè¡Œåº¦ç­‰ã€‚</li>
</ol>
</li>
</ul>
<p>ç„¶è€Œï¼ŒItem-Based CF å’Œ User-Based CF ä¹Ÿå­˜åœ¨ç€ä»¥ä¸‹çš„ç¼ºç‚¹:</p>
<ul>
<li><ol>
<li>ç¨€ç–æ€§é—®é¢˜ã€‚å¦‚æœç”¨æˆ·å¯¹ç‰©å“çš„è¯„ä»·éå¸¸ç¨€ç–ï¼Œæ²¡æœ‰å……è¶³çš„æ•°æ®ç”¨äºè®¡ç®—ç›¸ä¼¼æ€§ï¼Œ<br> é‚£ä¹ˆåŸºäºè¯„ä»·æ‰€å¾—åˆ°çš„ç”¨æˆ·æˆ–ç‰©å“é—´çš„ç›¸ä¼¼æ€§å¯èƒ½ä¸å‡†ç¡®;</li>
</ol>
</li>
<li><ol start="2">
<li>å¯æ‰©å±•æ€§é—®é¢˜ã€‚éšç€ç”¨æˆ·å’Œç‰©å“çš„å¢å¤šï¼Œæ•°æ®é‡å°†ä¼šå‰§å¢ï¼Œç³»ç»Ÿçš„æ€§èƒ½ä¼šè¶Šæ¥è¶Š<br>ä½;</li>
</ol>
</li>
<li><ol start="3">
<li>å†·å¯åŠ¨é—®é¢˜ã€‚å¦‚æœæŸä¸€ç‰©å“ä»æ¥æ²¡æœ‰è¢«è¯„ä»·è¿‡ï¼Œåˆ™è¯¥ç‰©å“ä¸ä¼šè¢«åˆ—ä¸ºç›¸ä¼¼ç‰©å“ï¼Œ<br>é‚£ä¹ˆè¿™ä¸ªç‰©å“å°±ä¸å¯èƒ½è¢«æ¨èã€‚ç±»ä¼¼çš„ï¼Œå¯¹äºä¸€ä¸ªä»æœªè¯„ä»·è¿‡ç‰©å“çš„ç”¨æˆ·ï¼Œæ— æ³• è·å¾—æ¨èã€‚</li>
</ol>
</li>
</ul>
<h3 id="åŸºäºæ¨¡å‹çš„ååŒè¿‡æ»¤"><a href="#åŸºäºæ¨¡å‹çš„ååŒè¿‡æ»¤" class="headerlink" title="åŸºäºæ¨¡å‹çš„ååŒè¿‡æ»¤"></a>åŸºäºæ¨¡å‹çš„ååŒè¿‡æ»¤</h3><p>Model-Based CF ç®€å•æ¥è¯´æ˜¯å…ˆç”¨å†å²æ•°æ®è®­ç»ƒå¾—åˆ°æ¨èæ¨¡å‹ï¼Œå†ç”¨æ­¤æ¨¡å‹è¿›è¡Œé¢„æµ‹çš„æ¨èç®—æ³•ã€‚å¸¸è§çš„æ¨¡å‹ç®—æ³•åŒ…æ‹¬åŸºäºæ¦‚ç‡çš„æœ´ç´ è´å¶æ–¯ç®—æ³•ã€èšç±»ç®—æ³•å’ŒåŸºäºçŸ©é˜µåˆ†è§£çš„ç®—æ³•ç­‰ ã€‚</p>
<p>å¸¸ç”¨çš„çŸ©é˜µåˆ†è§£ç®—æ³•æœ‰:æ­£åˆ™åŒ–çŸ©é˜µåˆ†è§£(Regularized Matrix Factorization)ï¼Œå¸¦åç½® çš„çŸ©é˜µåˆ†è§£(Biased Matrix Factorization)ï¼Œäº¤æ›¿æœ€å°äºŒä¹˜æ³•(Alternating Least Squaresï¼ŒALS) å’Œå¥‡å¼‚å€¼åˆ†è§£(Singular Value Decompositionï¼ŒSVD)ã€‚è¿™äº›ç®—æ³•çš„åŸºæœ¬æ€æƒ³éƒ½æ˜¯å°†ç¨€ç–ä¸” é«˜ç»´çš„ç”¨æˆ·â€”ç‰©å“è¯„åˆ†çŸ©é˜µåˆ†è§£ä¸ºä¸¤ä¸ªä½ç»´çŸ©é˜µï¼Œåˆ†åˆ«è¡¨ç¤ºç”¨æˆ·çš„ç‰¹å¾å’Œç‰©å“çš„ç‰¹å¾ã€‚ç”¨ æˆ·çš„ç‰¹å¾çŸ©é˜µå¯ä»¥ä»£è¡¨ç”¨æˆ·çš„å…´è¶£ï¼ŒåŒæ ·çš„ï¼Œç‰©å“çš„ç‰¹å¾çŸ©é˜µæš—å«äº†ç‰©å“çš„ç‰¹ç‚¹ï¼Œè¿™ä¸¤ä¸ª çŸ©é˜µçš„ä¹˜ç§¯èƒ½ååº”å‡ºç”¨æˆ·å¯¹ç‰©å“çš„å–œå¥½ç¨‹åº¦ ã€‚æ‰€ä»¥è¯¥ç±»æ–¹æ³•çš„ä¸»è¦å·¥ä½œå°±æ˜¯è®¡ç®—å‡ºç”¨æˆ· çš„ç‰¹å¾çŸ©é˜µå’Œç‰©å“çš„ç‰¹å¾çŸ©é˜µã€‚</p>
<h3 id="åŸºäºç¤¾äº¤ç½‘ç»œå…³ç³»çš„ååŒè¿‡æ»¤"><a href="#åŸºäºç¤¾äº¤ç½‘ç»œå…³ç³»çš„ååŒè¿‡æ»¤" class="headerlink" title="åŸºäºç¤¾äº¤ç½‘ç»œå…³ç³»çš„ååŒè¿‡æ»¤"></a>åŸºäºç¤¾äº¤ç½‘ç»œå…³ç³»çš„ååŒè¿‡æ»¤</h3><p>ç®€å•æ¥è¯´ï¼Œæ˜¯ä¸€ç§ä½¿ç”¨ç”¨æˆ·çš„ç¤¾äº¤å…³ç³»æ•°æ®ã€ç”¨æˆ·å¥½å‹çš„å–œå¥½æ•°æ®ç­‰ç¤¾äº¤ç±»æ•°æ®æ¥è¿›è¡Œæ¨èçš„ç®—æ³•ã€‚è¯¥ç±»ç®—æ³•é€‚åˆäºå¾®åšã€å¾®ä¿¡ç­‰æ‹¥æœ‰ç”¨æˆ·ç¤¾äº¤å…³ç³»æ•°æ®çš„ç³»ç»Ÿã€‚</p>
<h2 id="æ··åˆå‹æ¨è"><a href="#æ··åˆå‹æ¨è" class="headerlink" title="æ··åˆå‹æ¨è"></a>æ··åˆå‹æ¨è</h2><p>  æ··åˆæ¨èæ˜¯æŒ‡å°†å¤šç§æ¨èæŠ€æœ¯ç»¼åˆï¼Œå–é•¿è¡¥çŸ­ï¼Œä»¥æ­¤æ¥è·å¾—æ›´å¥½çš„æ¨èæ•ˆæœã€‚å¸¸ç”¨çš„<br>æ–¹æ¡ˆæ˜¯å°†ååŒè¿‡æ»¤æŠ€æœ¯ä¸å¦ä¸€ç§ç®—æ³•ç»“åˆï¼Œç„¶åå°†ä¸åŒæ–¹æ³•å¾—å‡ºçš„æ¨èç»“æœè¿›è¡Œç­›é€‰å’Œè<br>åˆï¼Œä»è€Œæé«˜æ¨èæ•ˆæœã€‚</p>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>algorithm</tag>
        <tag>recommendation</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”¨Spark Streamingå®æ—¶è®¡ç®—æµ·é‡ç”¨æˆ·UV</title>
    <url>/2018/05/01/spark-streaming-uv/</url>
    <content><![CDATA[<h1 id="æå‡ºéœ€æ±‚"><a href="#æå‡ºéœ€æ±‚" class="headerlink" title="æå‡ºéœ€æ±‚"></a>æå‡ºéœ€æ±‚</h1><p>å®æ—¶ç»Ÿè®¡ä¸šåŠ¡ç³»ç»Ÿ(web,APPä¹‹ç±»)çš„è®¿é—®äººæ•°,å³æ‰€è°“UV,æˆ–è€…DAUæŒ‡æ ‡.</p>
<p>è¿™ä¸ªéœ€æ±‚æ€•æ˜¯æµè®¡ç®—æœ€æœ€æœ€å¸¸è§çš„éœ€æ±‚äº†.</p>
<p>è®¡ç®—UVçš„å…³é”®ç‚¹å°±åœ¨äºå»é‡,å³åŒä¸€ä¸ªäººè®¿é—®ä¸¤æ¬¡æ˜¯åªè®¡ä¸€ä¸ªUVçš„.åœ¨ç¦»çº¿è®¡ç®—ä¸­ç»Ÿè®¡UVæ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•å°±æ˜¯ç”¨groupæˆ–distinctæœºåˆ¶æ¥å»é‡.ä½†æ˜¯åœ¨å®æ—¶è®¡ç®—åœºæ™¯,è¿˜ç”¨groupå°±ä¸å¤ªç§‘å­¦äº†,ä¸€ä¸ªæ˜¯å…¨é‡æ•°æ®çš„groupæ˜¯æ¯”è¾ƒè´¹æ—¶çš„,ç¬¬äºŒä¸ªæ˜¯å…¨é‡æ•°æ®çš„groupæ˜¯å¾ˆè´¹å†…å­˜å’ŒCPUçš„.ç‰¹åˆ«æ˜¯å½“ç”¨æˆ·é‡å·¨å¤§çš„æ—¶å€™,è¿˜è¦åšåˆ°ç§’çº§æ›´æ–°å°±æ›´éš¾äº†.</p>
<p>æ€»ç»“èµ·æ¥,éœ€æ±‚å°±æ˜¯:æµ·é‡ç”¨æˆ·åœºæ™¯UVå®æ—¶è®¡ç®—.</p>
<span id="more"></span>

<h1 id="æ¥å—æŒ‘æˆ˜"><a href="#æ¥å—æŒ‘æˆ˜" class="headerlink" title="æ¥å—æŒ‘æˆ˜"></a>æ¥å—æŒ‘æˆ˜</h1><p>ä¸éš¾å‘ç°,é—®é¢˜çš„ä¸»è¦éš¾ç‚¹å°±æ˜¯<strong>å»é‡</strong>.</p>
<p>Spark Streamingç›®å‰æ²¡æœ‰ç»™å‡ºå†…ç½®æ–¹æ¡ˆ(è¿™ä¸ªå…¶å®å¯ä»¥æœ‰),ä½†æ˜¯æµ·é‡æ•°æ®å»é‡é—®é¢˜æ—©å°±æœ‰è§£å†³åŠæ³•äº†.<br>æ‰€ä»¥Spark Streamingç¨‹åºå®Œå…¨å¯ä»¥åˆ©ç”¨å…¶ä»–ç³»ç»Ÿçš„ç°æœ‰æ–¹æ¡ˆè§£å†³å»é‡é—®é¢˜,æ¯”å¦‚Redis.</p>
<h2 id="Redisçš„æµ·é‡å»é‡è®¡æ•°æ–¹æ¡ˆ"><a href="#Redisçš„æµ·é‡å»é‡è®¡æ•°æ–¹æ¡ˆ" class="headerlink" title="Redisçš„æµ·é‡å»é‡è®¡æ•°æ–¹æ¡ˆ"></a>Redisçš„æµ·é‡å»é‡è®¡æ•°æ–¹æ¡ˆ</h2><h3 id="Bitmapæ–¹æ¡ˆ"><a href="#Bitmapæ–¹æ¡ˆ" class="headerlink" title="Bitmapæ–¹æ¡ˆ"></a>Bitmapæ–¹æ¡ˆ</h3><p>æ‰€è°“çš„Bitmapå°±æ˜¯ç”¨ä¸€ä¸ªbitä½æ¥æ ‡è®°æŸä¸ªå…ƒç´ å¯¹åº”çš„Value,æ¯”å¦‚IDä¸º2çš„ç”¨æˆ·,å°±ç”¨ç¬¬2ä¸ªbitä½æ¥è¡¨ç¤º,ç„¶åç”¨è¯¥ä½çš„å€¼æ¥è¡¨ç¤ºè¯¥ç”¨æˆ·æ˜¯å¦è®¿é—®è¿‡.å¦‚æœè¦è®¡ç®—UV,é‚£å°±åªè¦æ•°ä¸€ä¸‹æœ‰å¤šå°‘ä¸ª1å°±è¡Œå•¦.</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰40äº¿ç”¨æˆ·,ä½¿ç”¨Bitmapéœ€è¦2^32ä¸ªbitä½,ç®—ä¸‹æ¥ä¹Ÿå°±500Må·¦å³.</p>
<p>ä½ å¯èƒ½æ²¡æƒ³åˆ°çš„æ˜¯,Redisä¸­æœ€å¸¸ç”¨çš„æ•°æ®ç»“æ„string,å°±å¯ä»¥å®ç°bitmapç®—æ³•.</p>
<p>Redisæä¾›äº†å¦‚ä¸‹å‘½ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// æ’å…¥</span><br><span class="line">setbit key offset value</span><br><span class="line">//è·å–</span><br><span class="line">getbit key offset</span><br><span class="line">//è®¡æ•°</span><br><span class="line">BITCOUNT key [start] [end]</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œoffsetæœ€å¤§å€¼å°±æ˜¯2^32.<br>æ¯”å¦‚IDä¸º2çš„ç”¨æˆ·,å¯ä»¥setbit uv 2 1,æ¥è®°å½•.<br>æœ€åè¦è®¡ç®—UV,å°±ç›´æ¥ BITCOUNT uv. è¿™æ­¥è®¡æ•°éå¸¸å¿«,å¤æ‚åº¦æ˜¯O(1).</p>
<h3 id="HyperLogLogæ–¹æ¡ˆ"><a href="#HyperLogLogæ–¹æ¡ˆ" class="headerlink" title="HyperLogLogæ–¹æ¡ˆ"></a>HyperLogLogæ–¹æ¡ˆ</h3><p>è‹¥è¦è®¡ç®—å¾ˆå¤šé¡µé¢çš„UV,ç”¨bitmapè¿˜æ˜¯æ¯”è¾ƒè´¹ç©ºé—´çš„,Nä¸ªé¡µé¢å°±å¾—æœ‰Nä¸ª500M.è¿™æ—¶å€™HyperLogLogç»“æ„å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„é€‰æ‹©.</p>
<blockquote>
<p>Redis åœ¨ 2.8.9 ç‰ˆæœ¬æ·»åŠ äº† HyperLogLog ç»“æ„ã€‚<br>Redis HyperLogLog æ˜¯ç”¨æ¥åšåŸºæ•°ç»Ÿè®¡çš„ç®—æ³•ï¼ŒHyperLogLog çš„ä¼˜ç‚¹æ˜¯ï¼Œåœ¨è¾“å…¥å…ƒç´ çš„æ•°é‡æˆ–è€…ä½“ç§¯éå¸¸éå¸¸å¤§æ—¶ï¼Œè®¡ç®—åŸºæ•°æ‰€éœ€çš„ç©ºé—´æ€»æ˜¯å›ºå®š çš„ã€å¹¶ä¸”æ˜¯å¾ˆå°çš„ã€‚<br>åœ¨ Redis é‡Œé¢ï¼Œæ¯ä¸ª HyperLogLog é”®åªéœ€è¦èŠ±è´¹ 12 KB å†…å­˜ï¼Œå°±å¯ä»¥è®¡ç®—æ¥è¿‘ 2^64 ä¸ªä¸åŒå…ƒç´ çš„åŸº æ•°ã€‚è¿™å’Œè®¡ç®—åŸºæ•°æ—¶ï¼Œå…ƒç´ è¶Šå¤šè€—è´¹å†…å­˜å°±è¶Šå¤šçš„é›†åˆå½¢æˆé²œæ˜å¯¹æ¯”ã€‚<br>ä½†æ˜¯ï¼Œå› ä¸º HyperLogLog åªä¼šæ ¹æ®è¾“å…¥å…ƒç´ æ¥è®¡ç®—åŸºæ•°ï¼Œè€Œä¸ä¼šå‚¨å­˜è¾“å…¥å…ƒç´ æœ¬èº«ï¼Œæ‰€ä»¥ HyperLogLog ä¸èƒ½åƒé›†åˆé‚£æ ·ï¼Œè¿”å›è¾“å…¥çš„å„ä¸ªå…ƒç´ ã€‚</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´HyperLogLogæ˜¯ä¸€ç§åŸºæ•°ç»Ÿè®¡ç®—æ³•,è®¡ç®—ç»“æœæ˜¯è¿‘ä¼¼å€¼, 12 KB å†…å­˜å°±å¯ä»¥è®¡ç®—2^64 ä¸ªä¸åŒå…ƒç´ çš„åŸºæ•°.</p>
<p>Rediså‘½ä»¤å¦‚ä¸‹:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">redis 127.0.0.1:6379&gt; PFADD runoobkey &quot;redis&quot;</span><br><span class="line"></span><br><span class="line">1) (integer) 1</span><br><span class="line"></span><br><span class="line">redis 127.0.0.1:6379&gt; PFADD runoobkey &quot;mongodb&quot;</span><br><span class="line"></span><br><span class="line">1) (integer) 1</span><br><span class="line"></span><br><span class="line">redis 127.0.0.1:6379&gt; PFADD runoobkey &quot;mysql&quot;</span><br><span class="line"></span><br><span class="line">1) (integer) 1</span><br><span class="line"></span><br><span class="line">redis 127.0.0.1:6379&gt; PFCOUNT runoobkey</span><br><span class="line"></span><br><span class="line">(integer) 3</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h1><p>ä¸‹é¢ç»™å‡ºHyperLogLogæ–¹æ¡ˆçš„å‚è€ƒå®ç°:</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">stream.foreachRDD &#123; rdd =&gt;</span><br><span class="line">	<span class="comment">//ç»Ÿè®¡äººæ•°</span></span><br><span class="line">	rdd.foreachPartition &#123; partition =&gt;</span><br><span class="line">		<span class="comment">//ä»åˆ†åŒºæ‰€å±executorçš„redisçº¿ç¨‹æ± è·å–ä¸€ä¸ªè¿æ¥.</span></span><br><span class="line">		<span class="keyword">val</span> redis = <span class="type">RedisUtil</span>.getRedis</span><br><span class="line">		partition.foreach &#123; <span class="keyword">case</span> (date, userId) =&gt;</span><br><span class="line">			<span class="comment">//ç»Ÿè®¡å½“å‰userId</span></span><br><span class="line">			redis.pfadd(<span class="string">s&quot;uv:<span class="subst">$date</span>&quot;</span>, userId)</span><br><span class="line">		&#125;</span><br><span class="line">		redis.close()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³äºRedisçš„è¿æ¥,å¦‚æœæ˜¯ç”¨javaæˆ–scalaå¯ä»¥ä½¿ç”¨JedisPool,æ³¨æ„å¤„ç†åºåˆ—åŒ–å³å¯.</p>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>streaming</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäºSparkå®ç°æ¨èç®—æ³•-2:åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤(ç†è®ºç¯‡)</title>
    <url>/2018/05/03/spark-recommendation-2/</url>
    <content><![CDATA[<link href="https://cdn.bootcss.com/KaTeX/0.7.1/katex.min.css" rel="stylesheet">

<h1 id="åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤"><a href="#åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤" class="headerlink" title="åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤"></a>åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤</h1><p>åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤ï¼Œå³User-Based CF (User-Based Collaborative Filtering)ï¼Œæ˜¯åŸºäºä¸€ä¸ªè¿™æ ·çš„å‡è®¾â€œè·Ÿä½ çˆ±å¥½ç›¸åŒçš„äººå–œæ¬¢çš„ç‰©å“ï¼Œä½ å¾ˆå¯èƒ½ä¹Ÿå–œæ¬¢â€ï¼Œæ‰€ä»¥User-Based CFä¸»è¦çš„ä»»åŠ¡å°±æ˜¯æ‰¾å‡ºç”¨æˆ·çš„æœ€è¿‘é‚»å±…ï¼Œä»è€Œæ ¹æ®æœ€è¿‘é‚»å±…çš„å–œå¥½åšå‡ºæœªçŸ¥é¡¹çš„è¯„åˆ†é¢„æµ‹ã€‚<br>User-Based CFç®—æ³•å¯ä»¥åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼šæ•°æ®è¡¨ç¤ºã€æœ€è¿‘é‚»æŸ¥è¯¢ã€è¯„åˆ†é¢„æµ‹ã€æ¨èç»“æœäº§ç”Ÿã€‚</p>
<span id="more"></span>

<h2 id="1-æ•°æ®è¡¨ç¤º"><a href="#1-æ•°æ®è¡¨ç¤º" class="headerlink" title="1.æ•°æ®è¡¨ç¤º"></a>1.æ•°æ®è¡¨ç¤º</h2><p>User-Based CFä½¿ç”¨çš„ç”¨æˆ·â€”é¡¹ç›®æ•°æ®å¯ä»¥è¡¨ç¤ºä¸ºäºŒç»´çŸ©é˜µã€‚ä»¥ç”¨æˆ·å¯¹é¡¹ç›®çš„è¯„åˆ†æ•°æ®ä¸ºä¾‹ï¼Œè¯„åˆ†æ•°æ®å¯ä»¥ç”¨å¦‚ä¸‹æ–¹æ³•è¡¨ç¤ºï¼Œ</p>
<ul>
<li>ç”¨æˆ·è¯„åˆ†æ•°æ®è¡¨</li>
</ul>
<table>
<thead>
<tr>
<th>Item&#x2F;User</th>
<th>User 1</th>
<th>â€¦</th>
<th>User k</th>
<th>â€¦</th>
<th>User n</th>
</tr>
</thead>
<tbody><tr>
<td>Item 1</td>
<td>R1,1</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Item j</td>
<td></td>
<td></td>
<td>Rj,k</td>
<td></td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Item m</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>Rm,n</td>
</tr>
</tbody></table>
<p>å…¶ä¸­æ¯ä¸€è¡Œä»£è¡¨ç‰©å“æ‰€è·å¾—çš„è¯„åˆ†ã€‚ä»¥Item jä¸ºä¾‹ï¼ŒRj,kä»£è¡¨ç”¨æˆ·kç»™ç‰©å“jçš„è¯„åˆ†ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰ç”¨æˆ·éƒ½ä¼šå¯¹Item jè¿›è¡Œè¯„åˆ†ï¼Œæ‰€ä»¥Rj,kå¯èƒ½å­˜åœ¨ä¹Ÿå¯èƒ½ä¸å­˜åœ¨ã€‚è¿™é‡Œè®¾ç”¨æˆ·æ•°ä¸ºnï¼Œç‰©å“æ•°ç›®ä¸ºmï¼Œå¯ä»¥å°†æ•°æ®è½¬æ¢ä¸ºè¯„åˆ†å€¼ç»„æˆçš„äºŒç»´çŸ©é˜µRï¼Œåˆ™Ræ˜¯ç»´åº¦ä¸º(mÃ—n)çš„è¯„åˆ†çŸ©é˜µã€‚</p>
<h2 id="2-æœ€è¿‘é‚»æŸ¥è¯¢"><a href="#2-æœ€è¿‘é‚»æŸ¥è¯¢" class="headerlink" title="2.æœ€è¿‘é‚»æŸ¥è¯¢"></a>2.æœ€è¿‘é‚»æŸ¥è¯¢</h2><p>æ‰€è°“â€œæœ€è¿‘é‚»å±…â€æ˜¯æŒ‡ä¸å½“å‰ç”¨æˆ·æœ€ç›¸ä¼¼çš„å…¶ä»–è‹¥å¹²ç”¨æˆ·ï¼Œä¸ºäº†é˜²æ­¢å•ä¸ªç”¨æˆ·è¯„åˆ†å¯¹æ¨èç»“æœå½±å“è¿‡å¤§ï¼Œå¯¼è‡´åå·®ï¼Œé€šå¸¸å–Nï¼ˆNä¸ºå¤§äº1çš„æ•´æ•°ï¼‰ä¸ªç›¸ä¼¼ç”¨æˆ·çš„æ•°æ®ã€‚æ²¡æœ‰åº¦é‡å°±æ²¡æœ‰æ¯”è¾ƒï¼Œæ‰€ä»¥éœ€è¦æŸç§æ–¹æ³•åº¦é‡ç”¨æˆ·é—´çš„ç›¸ä¼¼ç¨‹åº¦ï¼Œè¿™é‡Œç›¸ä¼¼ç¨‹åº¦ç®€ç§°ä¸ºç›¸ä¼¼åº¦ã€‚<br>ç›¸ä¼¼åº¦çš„è®¡ç®—æ–¹æ³•è¾ƒå¤šï¼Œä»¥ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ä¸ºä¾‹è¯´æ˜ã€‚ä½™å¼¦ç›¸ä¼¼åº¦(Cosine-based Similarity)æ˜¯ç”¨ä¸¤ä¸ªå‘é‡é—´å¤¹è§’çš„ä½™å¼¦å€¼æ¥è¡¡é‡ç›¸ä¼¼æ€§ã€‚è‹¥è¦è®¡ç®—ç”¨æˆ·é—´çš„ç›¸ä¼¼åº¦ï¼Œä¹Ÿå°±æ˜¯è¦è®¡ç®—ä¸Šä¸€æ­¥ä¸­çŸ©é˜µRçš„åˆ—å‘é‡é—´çš„ç›¸ä¼¼åº¦ï¼Œå–User Xå’ŒUser Yçš„å‘é‡åˆ†åˆ«ä¸ºå¦‚ä¸‹å…¬å¼æ‰€ç¤ºï¼Œ<br>$$<br>    x âƒ—&#x3D;(R_{1,x},â€¦,R_{m,x} )<br>$$<br>$$<br>    y âƒ—&#x3D;(R_{1,y},â€¦,R_{m,y} )<br>$$</p>
<p>é‚£ä¹ˆUser Xä¸User Yé—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ä¸ºï¼Œ<br>$$<br>    sim(X,Y)&#x3D;cosâ¡(x âƒ—,y âƒ— )&#x3D;\frac{x âƒ—âˆ™y âƒ—}{â€–x âƒ— â€–*â€–y âƒ— â€–}<br>$$</p>
<p>å…¶ä¸­$x âƒ—âˆ™y âƒ—$è¡¨ç¤ºå‘é‡é—´çš„å†…ç§¯ï¼Œ$â€–x âƒ— â€–$æ˜¯å‘é‡ x âƒ—$çš„æ¨¡ï¼Œsim(X,Y)å°±æ˜¯ç›¸ä¼¼åº¦çš„å€¼ã€‚ä¾æ¬¡è®¡ç®—å½“å‰ç”¨æˆ·ä¸å…¶ä»–æ‰€æœ‰ç”¨æˆ·çš„ç›¸ä¼¼åº¦ï¼Œé€‰å–ç›¸ä¼¼åº¦æœ€å¤§çš„å‰Kä¸ªç”¨æˆ·ä½œä¸ºè¯¥ç”¨æˆ·çš„æœ€è¿‘é‚»å±…é›†åˆã€‚</p>
<h2 id="3-è¯„åˆ†é¢„æµ‹"><a href="#3-è¯„åˆ†é¢„æµ‹" class="headerlink" title="3.è¯„åˆ†é¢„æµ‹"></a>3.è¯„åˆ†é¢„æµ‹</h2><p>è¯„åˆ†é¢„æµ‹çš„æ–¹æ³•ä¹Ÿæœ‰å¤šç§ï¼Œå¸¸ç”¨çš„æ˜¯åŠ æƒæ±‚å’Œçš„æ–¹æ³•è®¡ç®—é¢„æµ‹å€¼ã€‚å°†ç”¨æˆ·uçš„æœ€è¿‘é‚»å±…ç”¨æˆ·å¯¹ç‰©å“içš„æ‰“åˆ†è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œæƒå€¼ä¸ºå„ä¸ªæœ€è¿‘é‚»å±…ç”¨æˆ·ä¸ç”¨æˆ·uçš„ç›¸ä¼¼åº¦ï¼Œç„¶åå¯¹åŠ æƒæ±‚å’Œçš„ç»“æœæ±‚å¹³å‡ï¼Œè®¡ç®—å¾—åˆ°ç”¨æˆ·uå¯¹ç‰©å“içš„é¢„æµ‹æ‰“åˆ†ï¼Œå…¬å¼å¦‚ä¸‹ï¼š</p>
<p>$$<br>    P_{u,i}&#x3D;\frac{\sum_{nâˆˆN}S_{u,n}*R_{n,i}}<br>                                {\sum_{nâˆˆN}(|S_{u,n}|)}<br>$$</p>
<p>Nä»£è¡¨ç”¨æˆ·uçš„æœ€è¿‘é‚»å±…ç”¨æˆ·é›†åˆï¼Œnæ˜¯å±äºNä¸­çš„ä¸€ä¸ªç”¨æˆ·ï¼Œ $S_{u,n}$ è¡¨ç¤ºç”¨æˆ·uå’Œç”¨æˆ·nçš„ç›¸ä¼¼åº¦ï¼Œ$R_{n,i}$ è¡¨ç¤ºç”¨æˆ·nå¯¹ç‰©å“içš„è¯„åˆ†ã€‚æ ¹æ®è¯¥å…¬å¼é€ä¸ªè®¡ç®—å‡ºç”¨æˆ·uæœªè¯„åˆ†çš„æ‰€æœ‰ç‰©å“çš„é¢„æµ‹è¯„åˆ†ï¼Œå¾—åˆ°é¢„æµ‹è¯„åˆ†é›†åˆã€‚</p>
<h2 id="4-æ¨èç»“æœäº§ç”Ÿ"><a href="#4-æ¨èç»“æœäº§ç”Ÿ" class="headerlink" title="4.æ¨èç»“æœäº§ç”Ÿ"></a>4.æ¨èç»“æœäº§ç”Ÿ</h2><p>ä»ä¸Šä¸€æ­¥å¾—åˆ°çš„é¢„æµ‹è¯„åˆ†é›†åˆä¸­ï¼Œé€‰å‡ºè¯„åˆ†æœ€é«˜çš„è‹¥å¹²ä¸ªç‰©å“ä½œä¸ºæ¨èç‰©å“é›†ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆçš„æ¨èç»“æœã€‚</p>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>algorithm</tag>
        <tag>recommendation</tag>
      </tags>
  </entry>
  <entry>
    <title>Spark 2.xè¯»å†™MySQL</title>
    <url>/2018/12/25/spark-work-with-mysql-cn/</url>
    <content><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>ä» spark 2.0 å¼€å§‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨DataFrameReader å’Œ DataFrameWriteræ¥è¯»å†™MySQLã€‚</p>
<span id="more"></span>

<p>SparkSession.read è¿”å› DataFrameReader.<br>Dataset.write è¿”å› DataFrameWriter.</p>
<h1 id="ç…®å‡ ä¸ªæ —å­"><a href="#ç…®å‡ ä¸ªæ —å­" class="headerlink" title="ç…®å‡ ä¸ªæ —å­"></a>ç…®å‡ ä¸ªæ —å­</h1><p>å…¶ä¸­sparkæ˜¯SparkSession</p>
<h2 id="read-example"><a href="#read-example" class="headerlink" title="read example"></a>read example</h2><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> prop=<span class="keyword">new</span> java.util.<span class="type">Properties</span>()</span><br><span class="line">prop.put(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;username&quot;</span>)</span><br><span class="line">prop.put(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;yourpassword&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> url=<span class="string">&quot;jdbc:mysql://host:3306/db_name&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> df=spark.read.jdbc(url,<span class="string">&quot;table_name&quot;</span>,prop)</span><br><span class="line">df.show()</span><br></pre></td></tr></table></figure>

<h2 id="read-example2"><a href="#read-example2" class="headerlink" title="read example2"></a>read example2</h2><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> jdbcDF = spark.read</span><br><span class="line">  .format(<span class="string">&quot;jdbc&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:mysql:dbserver&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;dbtable&quot;</span>, <span class="string">&quot;schema.tablename&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;username&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">  .load()</span><br></pre></td></tr></table></figure>

<h2 id="read-example3"><a href="#read-example3" class="headerlink" title="read example3"></a>read example3</h2><p>å¦‚æœä½ æƒ³è¯»å–çš„ä¸æ˜¯ä¸€å¼ è¡¨çš„æ•°æ®ï¼Œè€Œæ˜¯ä¸€å¥SQLçš„æŸ¥è¯¢ç»“æœï¼Œé‚£ä¹ˆå¯ä»¥è¿™ä¹ˆæ“ä½œï¼š</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> sql=<span class="string">&quot;&quot;&quot;select * from db.your_table where id&gt;1&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">val</span> jdbcDF = spark.read</span><br><span class="line">  .format(<span class="string">&quot;jdbc&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:mysql:dbserver&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;dbtable&quot;</span>,  <span class="string">s&quot;( <span class="subst">$sql</span> ) t&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;username&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">  .load()</span><br></pre></td></tr></table></figure>


<h2 id="write-example"><a href="#write-example" class="headerlink" title="write example"></a>write example</h2><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SaveMode</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> prop=<span class="keyword">new</span> java.util.<span class="type">Properties</span>()</span><br><span class="line">prop.put(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;username&quot;</span>)</span><br><span class="line">prop.put(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;yourpassword&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> url=<span class="string">&quot;jdbc:mysql://host:3306/db_name&quot;</span></span><br><span class="line"><span class="comment">//dfæ˜¯ä¸€ä¸ªdataframe,ä¹Ÿå°±æ˜¯ä½ è¦å†™å…¥çš„æ•°æ®</span></span><br><span class="line">df.write.mode(<span class="type">SaveMode</span>.<span class="type">Append</span>).jdbc(url,<span class="string">&quot;table_name&quot;</span>,prop)</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäºSparkå®ç°æ¨èç®—æ³•-4:åŸºäºç‰©å“çš„ååŒè¿‡æ»¤(å®ç°ç¯‡)</title>
    <url>/2018/05/04/spark-recommendation-item-based-cf/</url>
    <content><![CDATA[<h1 id="ç®—æ³•è®¾è®¡ä¸å®ç°"><a href="#ç®—æ³•è®¾è®¡ä¸å®ç°" class="headerlink" title="ç®—æ³•è®¾è®¡ä¸å®ç°"></a>ç®—æ³•è®¾è®¡ä¸å®ç°</h1><p>åŸºäºç‰©å“çš„ååŒè¿‡æ»¤åˆç§°Item-Based CF.<br>åŸºäºSparkçš„Item-Based CFç®—æ³•å…¶å®ç°åŸç†å’Œæ­¥éª¤ä¸ç»å…¸æ–¹æ³•åŸºæœ¬ä¸€è‡´ï¼Œä¸åŒçš„åœ°æ–¹ä¸»è¦åœ¨äºå…·ä½“æ­¥éª¤å†…çš„å¹¶è¡ŒåŒ–è®¡ç®—ã€‚</p>
<span id="more"></span>

<h2 id="ç›¸ä¼¼åº¦ç®—æ³•"><a href="#ç›¸ä¼¼åº¦ç®—æ³•" class="headerlink" title="ç›¸ä¼¼åº¦ç®—æ³•"></a>ç›¸ä¼¼åº¦ç®—æ³•</h2><p>åœ¨Spark MLlibä¸­æä¾›äº†ä½™å¼¦ç›¸ä¼¼åº¦çš„åˆ†å¸ƒå¼å®ç°ï¼Œorg.apache.spark.mllib.linalg.distributedåŒ…ä¸­çš„IndexedRowMatrixæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çŸ©é˜µç±»ï¼Œå…¶ä¸­æä¾›äº†ä¸€ä¸ªcolumnSimilaritiesæ–¹æ³•ç”¨äºè®¡ç®—è¯¥çŸ©é˜µå„åˆ—ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ã€‚</p>
<h2 id="é¢„æµ‹å€¼è®¡ç®—"><a href="#é¢„æµ‹å€¼è®¡ç®—" class="headerlink" title="é¢„æµ‹å€¼è®¡ç®—"></a>é¢„æµ‹å€¼è®¡ç®—</h2><p>é‡‡ç”¨åŠ æƒæ±‚å’Œçš„æ–¹æ³•è®¡ç®—é¢„æµ‹å€¼.</p>
<h2 id="å®ç°æ­¥éª¤ï¼š"><a href="#å®ç°æ­¥éª¤ï¼š" class="headerlink" title="å®ç°æ­¥éª¤ï¼š"></a>å®ç°æ­¥éª¤ï¼š</h2><h3 id="æ­¥éª¤åˆ†è§£"><a href="#æ­¥éª¤åˆ†è§£" class="headerlink" title="æ­¥éª¤åˆ†è§£"></a>æ­¥éª¤åˆ†è§£</h3><p>Step 1ï¼šè¯»å–ç”¨æˆ·è¯„åˆ†æ•°æ®ï¼Œè®¾ç”¨æˆ·æ•°ä¸ºUï¼Œç‰©å“æ•°ç›®ä¸ºIï¼Œå°†æ•°æ®è½¬æ¢ä¸ºä»¥ç”¨æˆ·ä¸ºè¡Œï¼Œç‰©å“ä¸ºåˆ—çš„äºŒç»´çŸ©é˜µRï¼ŒRç»´åº¦ä¸ºï¼ˆUÃ—Iï¼‰ã€‚çŸ©é˜µçš„æ¯ä¸€ä¸ªæ•°æ®è¡¨ç¤ºæŸä¸ªç”¨æˆ·å¯¹ç‰¹å®šç‰©å“çš„è¯„åˆ†ã€‚</p>
<p>Step 2ï¼šè®¡ç®—Ræ¯åˆ—ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼Œå¯ä»¥å¾—åˆ°ç»´åº¦(IÃ—I)çš„çŸ©é˜µSã€‚S(i,j)è¡¨ç¤ºç‰©å“iå’Œç‰©å“jä¹‹é—´çš„ç›¸ä¼¼åº¦ã€‚</p>
<p>Step 3ï¼šä½¿ç”¨é¢„æµ‹å€¼è®¡ç®—å…¬å¼è®¡ç®—ç”¨æˆ·å¯¹æœªè¯„åˆ†ç‰©å“çš„é¢„æµ‹è¯„åˆ†ã€‚å¾—åˆ°é¢„æµ‹è¯„åˆ†çŸ©é˜µPï¼ŒPç»´åº¦ä¸ºï¼ˆUÃ—Iï¼‰ï¼ŒP(i,j) è¡¨ç¤ºç”¨æˆ·iå¯¹ç‰©å“jçš„é¢„æµ‹è¯„åˆ†ã€‚</p>
<p>Step 4ï¼šå¯¹ç”¨æˆ·iè¿›è¡Œæ¨èã€‚æ‰¾å‡ºPçš„ç¬¬iè¡Œä¸­è¯„åˆ†æœ€é«˜çš„å‰Kä¸ªç‰©å“æ¨èç»™ç”¨æˆ·ã€‚Kæ˜¯éœ€è¦æ¨èçš„ç‰©å“æ•°é‡ã€‚</p>
<h3 id="åŸºäºSparkçš„å®ç°"><a href="#åŸºäºSparkçš„å®ç°" class="headerlink" title="åŸºäºSparkçš„å®ç°"></a>åŸºäºSparkçš„å®ç°</h3><p>é‰´äºä»Spark 2.0.0å¼€å§‹åŸºäºDatasetçš„APIæˆä¸ºäº†ä¸»è¦ç¼–ç¨‹APIï¼Œæœ¬æ–‡é‡‡ç”¨Datasetçš„APIè¿›è¡Œå®ç°ï¼Œä½¿ç”¨çš„è¯­è¨€ä¸ºScalaã€‚åŸºäºSparkå¹³å°Item-Based CFå¯ä»¥åˆ†ä¸º4æ­¥å®ç°ï¼š</p>
<p>Step 1ï¼šè¯»å–è¯„åˆ†æ•°æ®é›†ï¼Œè¿™é‡Œæ˜¯ä»Hiveæ•°æ®ä»“åº“è¯»å–æ•°æ®ï¼Œudataæ˜¯è¡¨åï¼ŒuserIdã€itemIdã€ratingæ˜¯3ä¸ªå­—æ®µï¼Œåˆ†åˆ«æ˜¯[ç”¨æˆ·IDï¼Œç‰©å“IDï¼Œè¯„åˆ†]ã€‚è¿™é‡ŒæŒ‰ç…§8:2çš„æ¯”ä¾‹å°†æ•°æ®é›†åˆ†ä¸ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è¯»å–è¯„åˆ†æ•°æ®é›†</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dataSet</span></span>(): (<span class="type">DataFrame</span>, <span class="type">DataFrame</span>) = &#123;</span><br><span class="line">    <span class="keyword">val</span> table = <span class="string">&quot; udata&quot;</span></span><br><span class="line">    <span class="keyword">val</span> df = spark.sql(<span class="string">s&quot;select userId,itemId,rating from test.<span class="subst">$table</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> <span class="type">Array</span>(training, test) = df.randomSplit(<span class="type">Array</span>(<span class="number">0.8</span>, <span class="number">0.2</span>))</span><br><span class="line">    training.cache()</span><br><span class="line">    test.cache()</span><br><span class="line">    (training, test)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>Step 2ï¼šå°†æ•°æ®é›†è½¬æ¢æˆä»¥ç”¨æˆ·ä¸ºè¡Œã€ç‰©å“ä¸ºåˆ—çš„äºŒç»´è¯„åˆ†çŸ©é˜µï¼ŒçŸ©é˜µçš„æ¯ä¸€ä¸ªè¡Œæ˜¯ä¸€ä¸ªç”¨æˆ·å¯¹æ‰€æœ‰ç‰©å“çš„è¯„åˆ†ã€‚ç„¶åæ±‚å‡ºè¯„åˆ†çŸ©é˜µæ¯åˆ—ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼Œå¾—åˆ°ä¸€ä¸ªä»¥ç‰©å“IDä¸ºè¡Œå’Œåˆ—ï¼Œä»¥ç›¸ä¼¼åº¦ä¸ºæ•°æ®çš„çŸ©é˜µï¼Œè¿™ä¸ªçŸ©é˜µå°±æ˜¯ç‰©å“ç›¸ä¼¼åº¦çŸ©é˜µã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è®¡ç®—ç›¸ä¼¼åº¦çŸ©é˜µ</span></span><br><span class="line"><span class="comment">//è¯„åˆ†æ•°æ®è½¬æ¢æˆçŸ©é˜µ</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parseToMatrix</span></span>(data: <span class="type">DataFrame</span>): <span class="type">CoordinateMatrix</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> parsedData = data.rdd.map &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Row</span>(user: <span class="type">Int</span>, item: <span class="type">Int</span>, rate: <span class="type">Int</span>) =&gt;</span><br><span class="line">        <span class="type">MatrixEntry</span>(user, item, rate.toDouble)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">CoordinateMatrix</span>(parsedData)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//è®¡ç®—ç›¸ä¼¼åº¦çŸ©é˜µ</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">standardCosine</span></span>(matrix: <span class="type">CoordinateMatrix</span>): <span class="type">RDD</span>[<span class="type">MatrixEntry</span>] = &#123;</span><br><span class="line">    <span class="keyword">val</span> similarity = matrix.toIndexedRowMatrix().columnSimilarities()</span><br><span class="line">    <span class="keyword">val</span> sim = similarity.entries</span><br><span class="line">    sim</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>Step 3ï¼šè®¡ç®—æµ‹è¯•é›†ç›¸ä¼¼ç‰©å“è¡¨ã€‚å°†æµ‹è¯•é›†ä¸è®­ç»ƒé›†ã€ç‰©å“ç›¸ä¼¼åº¦è¡¨è¿›è¡Œå·¦è”æ¥ï¼Œå¾—åˆ°æµ‹è¯•é›†ç›¸ä¼¼ç‰©å“è¡¨ï¼Œå­—æ®µä¸º[ç”¨æˆ·ID,ç‰©å“ID,å®é™…è¯„åˆ†,ç›¸ä¼¼ç‰©å“è¯„åˆ†,ç›¸ä¼¼åº¦]ã€‚ç„¶åå°†è¯¥è¡¨æ³¨å†Œæˆä¸´æ—¶è¡¨testAndSimï¼Œå¹¶ä¸”ç¼“å­˜èµ·æ¥ï¼Œä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è®¡ç®—æµ‹è¯•é›†ç›¸ä¼¼ç‰©å“è¡¨</span></span><br><span class="line"><span class="keyword">val</span> testItemSim = spark.sql(</span><br><span class="line">      <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        |select test.userId,test.itemId,test.rating testRating,training.rating,sim.sim</span></span><br><span class="line"><span class="string">        |from test</span></span><br><span class="line"><span class="string">        | left join training on test.userId=training.userId</span></span><br><span class="line"><span class="string">        | left join itemSim sim on test.itemId=sim.itemX and training.itemId=sim.itemY</span></span><br><span class="line"><span class="string">      &quot;&quot;&quot;</span>.stripMargin</span><br><span class="line">    )</span><br><span class="line">    testItemSim.cache()</span><br><span class="line">    testItemSim.createOrReplaceTempView(<span class="string">&quot;testAndSim&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>Step 4ï¼šé¢„æµ‹æµ‹è¯•é›†ä¸­ç”¨æˆ·å¯¹ç‰©å“çš„è¯„åˆ†ã€‚å¯¹ä¸Šä¸€æ­¥å¾—åˆ°çš„æµ‹è¯•é›†ç›¸ä¼¼ç‰©å“è¡¨testAndSimè¿›è¡Œè®¡ç®—ï¼Œå°†è¯¥è¡¨æ•°æ®æŒ‰ç…§(userId,itemId)è¿›è¡Œåˆ†ç»„ï¼Œå–æ¯ç»„ç›¸ä¼¼åº¦å‰Kä¸ªç‰©å“çš„è¯„åˆ†ã€‚æœ€åä¾ç…§é¢„æµ‹å€¼è®¡ç®—å…¬å¼æ±‚å‡ºé¢„æµ‹å€¼ï¼Œå¾—åˆ°é¢„æµ‹è¯„åˆ†è¡¨testAndPreï¼Œå…¶ä¸­preå­—æ®µå°±æ˜¯å¯¹åº”çš„é¢„æµ‹è¯„åˆ†å€¼ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é¢„æµ‹è¯„åˆ†</span></span><br><span class="line"><span class="keyword">val</span> sqlRank = <span class="string">&quot;select userId,itemId,testRating,rating,sim,&quot;</span> +</span><br><span class="line">        <span class="string">&quot;rank() over (partition by userId,itemId order by sim desc) rank\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;from testAndSim&quot;</span></span><br><span class="line"><span class="keyword">val</span> testAndPre = spark.sql(</span><br><span class="line">        <span class="string">&quot;select userId,itemId,first(testRating) rate,nvl(sum(rating*sim)/sum(abs(sim)),0) pre\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;from( &quot;</span> +</span><br><span class="line">          <span class="string">&quot;  select *&quot;</span> +</span><br><span class="line">          <span class="string">&quot;  from  (&quot;</span> + sqlRank + <span class="string">&quot;) t &quot;</span> +</span><br><span class="line">          <span class="string">s&quot; where rank &lt;= <span class="subst">$k</span> &quot;</span> +</span><br><span class="line">          <span class="string">&quot;) w &quot;</span> +</span><br><span class="line">          <span class="string">&quot;group by userId,itemId&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>algorithm</tag>
        <tag>recommendation</tag>
      </tags>
  </entry>
  <entry>
    <title>[è¯»ä¹¦ç¬”è®°] é»‘å®¢ä¸ç”»å®¶</title>
    <url>/2019/01/19/Hackers-and-Painters-note/</url>
    <content><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>ã€Šé»‘å®¢ä¸ç”»å®¶ã€‹æ˜¯ç¡…è°·åˆ›ä¸šä¹‹çˆ¶Paul Grahamçš„æ–‡é›†ï¼Œè¿™é‡Œçš„é»‘å®¢æŒ‡çš„æ˜¯ä¼˜ç§€çš„è½¯ä»¶å·¥ç¨‹å¸ˆï¼Œä½œè€…å°†é»‘å®¢ä¸ç”»å®¶ä½œæ¯”è¾ƒï¼Œè®¤ä¸ºä¸é»‘å®¢æœ€æ¥è¿‘çš„èŒä¸šæ˜¯ç”»å®¶ï¼Œè¿™ä¾¿æ˜¯è¿™æœ¬ä¹¦ä¹¦åçš„ç”±æ¥äº†ã€‚<br>Paul Grahamåœ¨1995å¹´åˆ›åŠäº†Viawebï¼Œå¸®åŠ©ä¸ªäººç”¨æˆ·æ–¹ä¾¿çš„å¼€è®¾ç½‘ä¸Šå•†åº—ï¼Œ1998å¹´ä»¥5åƒä¸‡ç¾å…ƒçš„ä»·æ ¼å–ç»™Yahooå…¬å¸ã€‚<br>2005å¹´ä»–åˆ›å»ºäº†é£æŠ•å…¬å¸YCï¼Œè¢«ç§°ä¸ºå…¨ä¸–ç•Œæœ€ç‰›çš„åˆ›ä¸šå­µåŒ–å™¨ï¼ŒYCå¸®åŠ©äº†å¤§é‡çš„åˆ›ä¸šå…¬å¸ï¼ˆåˆ°2018å¹´æŠ•èµ„äº†1450å®¶å…¬å¸ï¼‰ï¼Œæ¯”è¾ƒæˆåŠŸçš„æ¡ˆä¾‹æœ‰ï¼šAirbnbï¼ŒStripeï¼ŒDropboxï¼ŒDockerï¼ŒGitLabç­‰ç­‰ã€‚</p>
<p>è¿™æœ¬ä¹¦ä¸­åŒ…å«äº†ä½œè€…å¯¹é»‘å®¢ç²¾ç¥ï¼Œåˆ›ä¸šï¼Œäº’è”ç½‘ï¼Œç¤¾ä¼šï¼Œç¼–ç¨‹è¯­è¨€çš„è¯¸å¤šè§‚ç‚¹ï¼Œè¯»å®Œè®©äººæ„Ÿè§‰å—ç›ŠåŒªæµ…ï¼Œç”šè‡³ä¼šæœ‰åˆ›ä¸šçš„å†²åŠ¨ï¼Œå“ˆå“ˆã€‚</p>
<blockquote>
<p>ä»¥ä¸‹æ˜¯å¯¹è¿™æœ¬ä¹¦å†…å®¹çš„ä¸€äº›æ‘˜æŠ„ã€‚</p>
</blockquote>
<span id="more"></span>

<h1 id="åº-amp-å‰è¨€"><a href="#åº-amp-å‰è¨€" class="headerlink" title="åº &amp; å‰è¨€"></a>åº &amp; å‰è¨€</h1><p>é»‘å®¢è¡Œä¸ºå¿…é¡»åŒ…å«ä¸‰ä¸ªç‰¹ç‚¹ï¼šå¥½ç©ã€é«˜æ™ºå•†ã€æ¢ç´¢ç²¾ç¥ã€‚</p>
<h1 id="1-ä¸ºä»€ä¹ˆä¹¦å‘†å­ä¸å—æ¬¢è¿"><a href="#1-ä¸ºä»€ä¹ˆä¹¦å‘†å­ä¸å—æ¬¢è¿" class="headerlink" title="1 ä¸ºä»€ä¹ˆä¹¦å‘†å­ä¸å—æ¬¢è¿"></a>1 ä¸ºä»€ä¹ˆä¹¦å‘†å­ä¸å—æ¬¢è¿</h1><p>æˆ‘è®¤ä¸ºï¼Œè¿™å°±æ˜¯é—®é¢˜çš„æ ¹æºã€‚<strong>â€œä¹¦å‘†å­â€çš„ç›®æ ‡å…·æœ‰ä¸¤é‡æ€§</strong>ã€‚ä»–ä»¬æ¯«æ— ç–‘é—®æƒ³è®©è‡ªå·±å—æ¬¢è¿ï¼Œä½†æ˜¯ä»–ä»¬æ›´æ„¿æ„è®©è‡ªå·±èªæ˜ã€‚â€œå—æ¬¢è¿â€å¹¶ä¸æ˜¯ä½ åœ¨è¯¾åæ—¶é—´éšä¾¿åšä¸€åšå°±èƒ½å®ç°çš„ï¼Œå°¤å…¶æ˜¯åœ¨ç¾å›½çš„ä¸­å­¦ä¸­ï¼Œåœ¨è¿™é‡Œï¼Œæ‰€æœ‰äººä¸ºäº†ä¸ªäººé­…åŠ›éƒ½ä¼šè¿›è¡Œæ¿€çƒˆç«äº‰ã€‚</p>
<p>è¡¨é¢ä¸Šï¼Œå­¦æ ¡çš„ä½¿å‘½æ˜¯æ•™è‚²å„¿ç«¥ã€‚äº‹å®ä¸Šï¼Œå­¦æ ¡çš„çœŸæ­£ç›®çš„æ˜¯æŠŠå„¿ç«¥éƒ½å…³åœ¨åŒä¸€ä¸ªåœ°æ–¹ï¼Œä»¥ä¾¿å¤§äººä»¬ç™½å¤©å¯ä»¥è…¾å‡ºæ‰‹æ¥æŠŠäº‹æƒ…åšå®Œã€‚</p>
<p>æ ¡å›­ç”Ÿæ´»çš„ä¸¤å¤§ææ€–ä¹‹å¤„â€”â€”æ®‹å¿å’Œæ— èŠâ€”â€”ä¹Ÿæ˜¯å‡ºäºåŒæ ·çš„åŸå› ã€‚</p>
<p>å¦‚æœä½ è§‰å¾—äººç”Ÿç³Ÿé€äº†ï¼Œé‚£ä¸æ˜¯å› ä¸ºä½“å†…æ¿€ç´ åˆ†æ³Œå¤±è°ƒï¼ˆä½ çˆ¶æ¯ç›¸ä¿¡è¿™ç§è¯´æ³•ï¼‰ï¼Œä¹Ÿä¸æ˜¯å› ä¸ºäººç”ŸçœŸçš„ç³Ÿé€äº†ï¼ˆä½ æœ¬äººç›¸ä¿¡è¿™ç§è¯´æ³•ï¼‰ã€‚é‚£æ˜¯å› ä¸ºä½ å¯¹æˆå¹´äººä¸å†å…·æœ‰ç»æµä»·å€¼ï¼ˆä¸å·¥ä¸šç¤¾ä¼šä»¥å‰çš„æ—¶æœŸç›¸æ¯”ï¼‰ï¼Œæ‰€ä»¥ä»–ä»¬æŠŠä½ æ‰”åœ¨å­¦æ ¡é‡Œï¼Œä¸€å…³å°±æ˜¯å¥½å‡ å¹´ï¼Œæ ¹æœ¬æ²¡æœ‰çœŸæ­£çš„äº‹æƒ…å¯åšã€‚ä»»ä½•è¿™ç§ç±»å‹çš„ç»„ç»‡éƒ½æ˜¯å¯æ€•çš„ç”Ÿå­˜ç¯å¢ƒã€‚ä½ æ ¹æœ¬ä¸éœ€è¦å¯»æ‰¾å…¶ä»–çš„åŸå› å°±èƒ½è§£é‡Šä¸ºä»€ä¹ˆé’å°‘å¹´æ˜¯ä¸å¿«ä¹çš„ã€‚</p>
<h1 id="2-é»‘å®¢ä¸ç”»å®¶"><a href="#2-é»‘å®¢ä¸ç”»å®¶" class="headerlink" title="2 é»‘å®¢ä¸ç”»å®¶"></a>2 é»‘å®¢ä¸ç”»å®¶</h1><p>è¿™ä¸ªå­¦ç§‘çš„ä¸€ç«¯æ˜¯çº¯ç²¹çš„æ•°å­¦å®¶ï¼Œä»–ä»¬è‡ªç§°â€œè®¡ç®—æœºç§‘å­¦å®¶â€ï¼Œåªæ˜¯ä¸ºäº†å¾—åˆ°å›½é˜²éƒ¨ç ”ç©¶å±€ï¼ˆDARPAï¼‰çš„é¡¹ç›®èµ„åŠ©ã€‚ä¸­é—´éƒ¨åˆ†æ˜¯è®¡ç®—æœºåšç‰©å­¦å®¶ï¼Œç ”ç©¶å„ç§ä¸“é—¨æ€§çš„é¢˜ç›®ï¼Œæ¯”å¦‚ç½‘ç»œæ•°æ®çš„è·¯ç”±ç®—æ³•ã€‚å¦ä¸€ç«¯åˆ™æ˜¯é»‘å®¢ï¼Œåªæƒ³å†™å‡ºæœ‰è¶£çš„è½¯ä»¶ï¼Œå¯¹äºä»–ä»¬æ¥è¯´ï¼Œè®¡ç®—æœºåªæ˜¯ä¸€ç§è¡¨è¾¾çš„åª’ä»‹ï¼Œå°±åƒå»ºç­‘å¸ˆæ‰‹é‡Œçš„æ··å‡åœŸï¼Œæˆ–è€…ç”»å®¶æ‰‹é‡Œçš„é¢œæ–™ã€‚</p>
<p>åˆ›é€ ä¼˜ç¾äº‹ç‰©çš„æ–¹å¼å¾€å¾€ä¸æ˜¯ä»å¤´åšèµ·ï¼Œè€Œæ˜¯åœ¨ç°æœ‰æˆæœçš„åŸºç¡€ä¸Šåšä¸€äº›å°å°çš„è°ƒæ•´ï¼Œæˆ–è€…å°†å·²æœ‰çš„è§‚ç‚¹ç”¨æ¯”è¾ƒæ–°çš„æ–¹å¼ç»„åˆèµ·æ¥ã€‚è¿™ç§ç±»å‹çš„å·¥ä½œå¾ˆéš¾ç”¨ç ”ç©¶æ€§çš„è®ºæ–‡è¡¨è¾¾ã€‚</p>
<p>é»‘å®¢ææ‡‚â€œè®¡ç®—ç†è®ºâ€ï¼ˆtheory of computationï¼‰çš„å¿…è¦æ€§ï¼Œä¸ç”»å®¶ææ‡‚é¢œæ–™åŒ–å­¦æˆåˆ†çš„å¿…è¦æ€§å·®ä¸å¤šå¤§ã€‚</p>
<p><strong>ç¼–ç¨‹è¯­è¨€æ˜¯ç”¨æ¥å¸®åŠ©æ€è€ƒç¨‹åºçš„ï¼Œè€Œä¸æ˜¯ç”¨æ¥è¡¨è¾¾ä½ å·²ç»æƒ³å¥½çš„ç¨‹åºã€‚å®ƒåº”è¯¥æ˜¯ä¸€æ”¯é“…ç¬”ï¼Œè€Œä¸æ˜¯ä¸€æ”¯é’¢ç¬”ã€‚</strong></p>
<p>è¿™ä¼¼ä¹æ˜¯å¤§å…¬å¸çš„æ™®éæƒ…å†µã€‚å¤§å…¬å¸è¿™æ ·å®‰æ’çš„åŸå› æ˜¯ä¸ºäº†å‡å°‘ç»“æœçš„æ ‡å‡†å·®ã€‚å› ä¸ºå®é™…ä¸Šåªæœ‰å¾ˆå°‘ä¸€éƒ¨åˆ†é»‘å®¢æ‡‚å¾—å¦‚ä½•æ­£ç¡®è®¾è®¡è½¯ä»¶ï¼Œ</p>
<p>çœŸæ­£ç«äº‰è½¯ä»¶è®¾è®¡çš„æˆ˜åœºæ˜¯æ–°å…´é¢†åŸŸçš„å¸‚åœºï¼Œè¿™é‡Œè¿˜æ²¡æœ‰äººå»ºç«‹è¿‡é˜²å¾¡å·¥äº‹ã€‚åªè¦ä½ èƒ½åšå‡ºå¤§èƒ†çš„è®¾è®¡ï¼Œç”±ä¸€ä¸ªäººæˆ–ä¸€æ‰¹äººåŒæ—¶è´Ÿè´£è®¾è®¡å’Œå®ç°äº§å“ï¼Œä½ å°±èƒ½åœ¨è¿™é‡Œæˆ˜èƒœå¤§å…¬å¸</p>
<p>é»‘å®¢å¦‚ä½•æ‰èƒ½åšè‡ªå·±å–œæ¬¢çš„äº‹æƒ…ï¼Ÿæˆ‘è®¤ä¸ºè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ³•æ˜¯ä¸€ä¸ªå‡ ä¹æ‰€æœ‰åˆ›ä½œè€…éƒ½çŸ¥é“çš„æ–¹æ³•ï¼šæ‰¾ä¸€ä»½å…»å®¶ç³Šå£çš„â€œç™½å¤©å·¥ä½œâ€ï¼ˆday jobï¼‰ã€‚è¿™ä¸ªè¯æ˜¯ä»éŸ³ä¹å®¶èº«ä¸Šæ¥çš„ï¼Œä»–ä»¬æ™šä¸Šè¡¨æ¼”éŸ³ä¹ï¼Œæ‰€ä»¥ç™½å¤©å¯ä»¥æ‰¾ä¸€ä»½å…¶ä»–å·¥ä½œã€‚æ›´ä¸€èˆ¬åœ°è¯´ï¼Œâ€œç™½å¤©å·¥ä½œâ€çš„æ„æ€æ˜¯ï¼Œä½ æœ‰ä¸€ä»½ä¸ºäº†èµšé’±çš„å·¥ä½œï¼Œè¿˜æœ‰ä¸€ä»½ä¸ºäº†çˆ±å¥½çš„å·¥ä½œã€‚<br><strong>é»‘å®¢è§£å†³ç”Ÿè®¡é—®é¢˜çš„æ–¹æ³•æ˜¯æ‰¾ä¸€ä»½â€œç™½å¤©å·¥ä½œâ€ï¼Œç„¶ååœ¨å…¶ä½™æ—¶é—´å¼€å‘ä¼˜ç¾çš„è½¯ä»¶ï¼Œ</strong></p>
<p>å› ä¸ºé»‘å®¢æ›´åƒåˆ›ä½œè€…ï¼Œè€Œä¸æ˜¯ç§‘å­¦å®¶ï¼Œæ‰€ä»¥è¦äº†è§£é»‘å®¢ï¼Œä¸åº”è¯¥åœ¨ç§‘å­¦å®¶èº«ä¸Šå¯»æ‰¾å¯ç¤ºï¼Œè€Œæ˜¯åº”è¯¥è§‚å¯Ÿå…¶ä»–ç±»å‹çš„åˆ›ä½œè€…ã€‚</p>
<p>ä¹Ÿè®¸å¯¹äºé»‘å®¢æ¥è¯´ï¼Œé‡‡å–åƒç”»å®¶è¿™æ ·çš„åšæ³•å¾ˆæœ‰å¥½å¤„ï¼šåº”è¯¥å®šæœŸåœ°ä»å¤´å¼€å§‹ï¼Œè€Œä¸è¦é•¿å¹´ç´¯æœˆåœ°åœ¨ä¸€ä¸ªé¡¹ç›®ä¸Šä¸æ–­å·¥ä½œï¼Œå¹¶ä¸”è¯•å›¾æŠŠæ‰€æœ‰çš„æœ€æ–°æƒ³æ³•éƒ½ä»¥ä¿®è®¢ç‰ˆçš„å½¢å¼åŒ…æ‹¬è¿›å»ã€‚</p>
<p>åˆ›ä½œè€…å¦ä¸€ä¸ªå­¦ä¹ çš„é€”å¾„æ˜¯é€šè¿‡èŒƒä¾‹ã€‚</p>
<p>é»‘å®¢å°±åƒç”»å®¶ï¼Œå·¥ä½œèµ·æ¥æ˜¯æœ‰å¿ƒç†å‘¨æœŸçš„ã€‚æœ‰æ—¶å€™ï¼Œä½ æœ‰äº†ä¸€ä¸ªä»¤äººå…´å¥‹çš„æ–°é¡¹ç›®ï¼Œä½ ä¼šæ„¿æ„ä¸ºå®ƒä¸€å¤©å·¥ä½œ16ä¸ªå°æ—¶ã€‚ç­‰è¿‡äº†è¿™ä¸€é˜µï¼Œä½ åˆä¼šè§‰å¾—ç™¾æ— èŠèµ–ï¼Œå¯¹æ‰€æœ‰äº‹æƒ…éƒ½æä¸èµ·å…´è¶£ã€‚</p>
<p>æ™®é€šé»‘å®¢ä¸ä¼˜ç§€é»‘å®¢çš„æ‰€æœ‰åŒºåˆ«ä¹‹ä¸­ï¼Œä¼šä¸ä¼šâ€œæ¢ä½æ€è€ƒâ€å¯èƒ½æ˜¯æœ€é‡è¦çš„å•ä¸ªå› ç´ ã€‚æœ‰äº›é»‘å®¢å¾ˆèªæ˜ï¼Œä½†æ˜¯å®Œå…¨ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒï¼Œæ ¹æœ¬ä¸ä¼šè®¾èº«å¤„åœ°ä¸ºç”¨æˆ·è€ƒè™‘ã€‚è¿™æ ·çš„äººå¾ˆéš¾è®¾è®¡å‡ºä¼˜ç§€è½¯ä»¶ï¼Œå› ä¸ºä»–ä»¬ä¸ä»ç”¨æˆ·çš„è§’åº¦çœ‹å¾…é—®é¢˜ã€‚</p>
<h1 id="3-ä¸èƒ½è¯´çš„è¯"><a href="#3-ä¸èƒ½è¯´çš„è¯" class="headerlink" title="3 ä¸èƒ½è¯´çš„è¯"></a>3 ä¸èƒ½è¯´çš„è¯</h1><p>å¦‚æœåˆ«äººå‘Šè¯‰ä½ åº”è¯¥ç›¸ä¿¡ä»€ä¹ˆï¼Œä½ å°±çœŸçš„ç›¸ä¿¡äº†ï¼Œé‚£ä¹ˆä½ å°±ä¼šå’Œåˆ«äººä¸€æ ·çŠ¯ä¸‹åŒæ ·çš„é”™è¯¯ã€‚</p>
<p>ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰ä¸èƒ½è¯´å‡ºå£çš„è¯éƒ½æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ç­”æ¡ˆã€‚å®é™…ä¸Šï¼Œåªæœ‰åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶æ‰è¡Œã€‚ç¬¬ä¸€ä¸ªæ¡ä»¶æ˜¯ï¼Œè¿™äº›è¯ä¸èƒ½è¯´å‡ºå£ï¼›ç¬¬äºŒä¸ªæ¡ä»¶æ˜¯ï¼Œå®ƒä»¬æ˜¯æ­£ç¡®çš„ï¼Œæˆ–è€…çœ‹èµ·æ¥å¾ˆå¯èƒ½æ­£ç¡®ï¼Œå€¼å¾—è¿›ä¸€æ­¥è®¨è®ºã€‚</p>
<p>å®ˆå£å¦‚ç“¶â€çš„çœŸæ­£ç¼ºç‚¹åœ¨äºï¼Œä½ ä»æ­¤æ— æ³•äº«å—è®¨è®ºå¸¦æ¥çš„å¥½å¤„äº†ã€‚è®¨è®ºä¸€ä¸ªè§‚ç‚¹ä¼šäº§ç”Ÿæ›´å¤šçš„è§‚ç‚¹ï¼Œä¸è®¨è®ºå°±ä»€ä¹ˆè§‚ç‚¹ä¹Ÿæ²¡æœ‰ã€‚</p>
<h1 id="4-è‰¯å¥½çš„åä¹ æƒ¯"><a href="#4-è‰¯å¥½çš„åä¹ æƒ¯" class="headerlink" title="4 è‰¯å¥½çš„åä¹ æƒ¯"></a>4 è‰¯å¥½çš„åä¹ æƒ¯</h1><p>å…¬æ°‘è‡ªç”±çœŸçš„æ˜¯å›½å®¶å¯Œå¼ºçš„åŸå› ï¼Œè€Œä¸æ˜¯ç»“æœå—ï¼Ÿæˆ‘è®¤ä¸ºæ˜¯çš„ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œä¸€ä¸ªäººä»¬æ‹¥æœ‰è¨€è®ºè‡ªç”±å’Œè¡ŒåŠ¨è‡ªç”±çš„ç¤¾ä¼šï¼Œå¾€å¾€æœ€æœ‰å¯èƒ½é‡‡çº³æœ€ä¼˜æ–¹æ¡ˆï¼Œè€Œä¸æ˜¯é‡‡çº³æœ€æœ‰æƒåŠ¿çš„äººæå‡ºçš„æ–¹æ¡ˆã€‚</p>
<p>æ­£æ˜¯é‚£äº›ä¸æœä»ç®¡æ•™çš„äººä»¬ï¼Œæ‰æ˜¯ç¾å›½è´¢å¯Œä¸åŠ›é‡çš„æºæ³‰ã€‚</p>
<h1 id="5-å¦ä¸€æ¡è·¯"><a href="#5-å¦ä¸€æ¡è·¯" class="headerlink" title="5 å¦ä¸€æ¡è·¯"></a>5 å¦ä¸€æ¡è·¯</h1><p>å¦‚æœä½ æƒ³æŠŠé’±è—åœ¨å®‰å…¨çš„åœ°æ–¹ï¼Œè¯·é—®ä½ æ˜¯é€‰æ‹©æ”¾åœ¨å®¶ä¸­åºŠå«ä¸‹é¢ï¼Œè¿˜æ˜¯æ”¾åœ¨é“¶è¡Œï¼Ÿè¿™ä¸ªæ¯”å–»å¯¹æœåŠ¡å™¨ç®¡ç†çš„æ–¹æ–¹é¢é¢éƒ½é€‚ç”¨ï¼Œä¸ä»…æ˜¯å®‰å…¨æ€§ï¼Œè¿˜åŒ…æ‹¬æ­£å¸¸è¿è¡Œæ—¶é—´ã€å¸¦å®½ã€è´Ÿè½½ç®¡ç†ã€å¤‡ä»½ç­‰ï¼Œéƒ½æ˜¯æˆ‘ä»¬å ä¼˜ã€‚</p>
<p><strong>ä¸å°‘å…¬å¸éƒ½å¾ˆæƒ³çŸ¥é“ï¼Œä»€ä¹ˆäº‹æƒ…å¯ä»¥å¤–åŒ…ï¼Œä»€ä¹ˆäº‹æƒ…ä¸å¯ä»¥å¤–åŒ…ã€‚ä¸€ä¸ªå¯èƒ½çš„ç­”æ¡ˆæ˜¯ï¼Œå…¬å¸å†…éƒ¨æ‰€æœ‰ä¸ç›´æ¥æ„Ÿå—åˆ°ç«äº‰å‹åŠ›çš„éƒ¨é—¨éƒ½åº”è¯¥å¤–åŒ…å‡ºå»ï¼Œè®©å®ƒä»¬æš´éœ²åœ¨ç«äº‰å‹åŠ›ä¹‹ä¸‹ã€‚</strong></p>
<p>åªæœ‰æ‡‚å¾—è®¾è®¡çš„é»‘å®¢ï¼Œæ‰èƒ½è®¾è®¡è½¯ä»¶ï¼Œä¸èƒ½äº¤ç»™å¯¹è½¯ä»¶ä¸€çŸ¥åŠè§£çš„è®¾è®¡å¸ˆã€‚å¦‚æœä½ ä¸æ‰“ç®—è‡ªå·±åŠ¨æ‰‹è®¾è®¡å’Œå¼€å‘ï¼Œé‚£å°±ä¸è¦åˆ›ä¸šã€‚</p>
<h1 id="6-å¦‚ä½•åˆ›é€ è´¢å¯Œ"><a href="#6-å¦‚ä½•åˆ›é€ è´¢å¯Œ" class="headerlink" title="6 å¦‚ä½•åˆ›é€ è´¢å¯Œ"></a>6 å¦‚ä½•åˆ›é€ è´¢å¯Œ</h1><p>ä»ç»æµå­¦è§‚ç‚¹çœ‹ï¼Œä½ å¯ä»¥æŠŠåˆ›ä¸šæƒ³è±¡æˆä¸€ä¸ªå‹ç¼©è¿‡ç¨‹ï¼Œä½ çš„æ‰€æœ‰å·¥ä½œå¹´ä»½è¢«å‹ç¼©æˆäº†çŸ­çŸ­å‡ å¹´ã€‚ä½ ä¸å†æ˜¯ä½å¼ºåº¦åœ°å·¥ä½œå››åå¹´ï¼Œè€Œæ˜¯ä»¥æé™å¼ºåº¦å·¥ä½œå››å¹´ã€‚åœ¨é«˜æŠ€æœ¯é¢†åŸŸï¼Œè¿™ç§å‹ç¼©çš„å›æŠ¥å°¤å…¶ä¸°åšï¼Œå·¥ä½œæ•ˆç‡è¶Šé«˜ï¼Œé¢å¤–æŠ¥é…¬å°±è¶Šé«˜ã€‚</p>
<p>çœŸæ­£é‡è¦çš„æ˜¯åšå‡ºäººä»¬éœ€è¦çš„ä¸œè¥¿ï¼Œè€Œä¸æ˜¯åŠ å…¥æŸä¸ªå…¬å¸ã€‚</p>
<p><strong>è¦è‡´å¯Œï¼Œä½ éœ€è¦ä¸¤æ ·ä¸œè¥¿ï¼šå¯æµ‹é‡æ€§å’Œå¯æ”¾å¤§æ€§</strong>ã€‚</p>
<p>ä¹”å¸ƒæ–¯æ›¾ç»è¯´è¿‡ï¼Œåˆ›ä¸šçš„æˆè´¥å–å†³äºæœ€æ—©åŠ å…¥å…¬å¸çš„é‚£åä¸ªäººã€‚æˆ‘åŸºæœ¬åŒæ„è¿™ä¸ªè§‚ç‚¹ï¼Œè™½ç„¶æˆ‘è§‰å¾—çœŸæ­£å†³å®šæˆè´¥çš„å…¶å®åªæ˜¯å‰äº”äººã€‚å°å›¢é˜Ÿçš„ä¼˜åŠ¿ä¸åœ¨äºå®ƒæœ¬èº«çš„å°ï¼Œè€Œåœ¨äºä½ å¯ä»¥é€‰æ‹©æˆå‘˜ã€‚æˆ‘ä»¬ä¸éœ€è¦å°æ‘åº„çš„é‚£ç§â€œå°â€ï¼Œè€Œéœ€è¦å…¨æ˜æ˜Ÿç¬¬ä¸€é˜µå®¹çš„é‚£ç§â€œå°â€ã€‚</p>
<p>é€‰æ‹©å…¬å¸è¦è§£å†³ä»€ä¹ˆé—®é¢˜åº”è¯¥ä»¥é—®é¢˜çš„éš¾åº¦ä½œä¸ºæŒ‡å¼•ï¼Œè€Œä¸”æ­¤åçš„å„ç§å†³ç­–éƒ½åº”è¯¥ä»¥æ­¤ä¸ºåŸåˆ™ã€‚Viawebçš„ä¸€ä¸ªç»éªŒæ³•åˆ™å°±æ˜¯â€œæ›´ä¸Šä¸€å±‚æ¥¼â€ã€‚<br>æ€»çš„æ¥è¯´ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¥½çš„å¤„äº‹åŸåˆ™ã€‚å¦‚æœä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œå°±é€‰è¾ƒéš¾çš„é‚£ä¸ªã€‚å¦‚æœä½ è¦é€‰æ‹©æ˜¯ååœ¨å®¶é‡Œçœ‹ç”µè§†ï¼Œè¿˜æ˜¯å¤–å‡ºè·‘æ­¥ï¼Œé‚£å°±å‡ºå»è·‘æ­¥å§ã€‚è¿™ä¸ªæ–¹æ³•æœ‰æ•ˆçš„åŸå› å¯èƒ½æ˜¯é‡åˆ°ä¸¤ä¸ªä¸€éš¾ä¸€æ˜“çš„é€‰æ‹©æ—¶ï¼Œå¾€å¾€å‡ºäºæ‡’æƒ°çš„ç¼˜æ•…ï¼Œä½ ä¼šé€‰æ‹©è¾ƒæ˜“çš„é‚£ä¸ªé€‰é¡¹ã€‚åœ¨æ„è¯†æ·±å¤„ï¼Œä½ å…¶å®çŸ¥é“ä¸æ‡’æƒ°çš„åšæ³•ä¼šå¸¦æ¥æ›´å¥½çš„ç»“æœï¼Œè¿™ä¸ªæ–¹æ³•åªæ˜¯è¿«ä½¿ä½ æ¥å—è¿™ä¸€ç‚¹ã€‚</p>
<h1 id="7-å…³æ³¨è´«å¯Œåˆ†åŒ–"><a href="#7-å…³æ³¨è´«å¯Œåˆ†åŒ–" class="headerlink" title="7 å…³æ³¨è´«å¯Œåˆ†åŒ–"></a>7 å…³æ³¨è´«å¯Œåˆ†åŒ–</h1><p>æ— è®ºåœ¨ç‰©è´¨ä¸Šï¼Œè¿˜æ˜¯åœ¨ç¤¾ä¼šåœ°ä½ä¸Šï¼ŒæŠ€æœ¯å¥½åƒéƒ½ç¼©å°äº†å¯Œäººä¸ç©·äººä¹‹é—´çš„å·®è·ï¼Œè€Œä¸æ˜¯è®©è¿™ç§å·®è·æ‰©å¤§äº†ã€‚</p>
<h1 id="9-è®¾è®¡è€…çš„å“å‘³"><a href="#9-è®¾è®¡è€…çš„å“å‘³" class="headerlink" title="9 è®¾è®¡è€…çš„å“å‘³"></a>9 è®¾è®¡è€…çš„å“å‘³</h1><p>ç­‰åˆ°ä½ é€æ¸å¯¹ä¸€ä»¶äº‹äº§ç”Ÿçƒ­æƒ…çš„æ—¶å€™ï¼Œå°±ä¸ä¼šæ»¡è¶³äºæ¨¡ä»¿äº†ã€‚ä½ çš„å“å‘³å°±è¿›å…¥äº†ç¬¬äºŒé˜¶æ®µï¼Œå¼€å§‹è‡ªè§‰åœ°è¿›è¡ŒåŸåˆ›ã€‚</p>
<h1 id="10-ç¼–ç¨‹è¯­è¨€è§£æ"><a href="#10-ç¼–ç¨‹è¯­è¨€è§£æ" class="headerlink" title="10 ç¼–ç¨‹è¯­è¨€è§£æ"></a>10 ç¼–ç¨‹è¯­è¨€è§£æ</h1><p>å¤´é‡è„šè½»â€çš„è¯­è¨€ï¼šå®ƒä»¬çš„å†…æ ¸è®¾è®¡å¾—å¹¶éå¾ˆå¥½ï¼Œä½†æ˜¯å´æœ‰ç€æ— æ•°å¼ºå¤§çš„å‡½æ•°åº“ï¼Œå¯ä»¥ç”¨æ¥è§£å†³ç‰¹å®šçš„é—®é¢˜ã€‚</p>
<h1 id="11-ç™¾å¹´åçš„ç¼–ç¨‹è¯­è¨€"><a href="#11-ç™¾å¹´åçš„ç¼–ç¨‹è¯­è¨€" class="headerlink" title="11 ç™¾å¹´åçš„ç¼–ç¨‹è¯­è¨€"></a>11 ç™¾å¹´åçš„ç¼–ç¨‹è¯­è¨€</h1><p>è¿™æœ‰ç‚¹åƒä¹°æˆ¿å­çš„æ—¶å€™ä½ åº”è¯¥å…ˆè€ƒè™‘åœ°ç†ä½ç½®ã€‚åˆ«çš„åœ°æ–¹å°†æ¥å‡ºé—®é¢˜éƒ½æœ‰åŠæ³•å¼¥è¡¥ï¼Œä½†æ˜¯åœ°ç†ä½ç½®æ˜¯æ²¡æ³•å˜çš„ã€‚</p>
<p>æµªè´¹ç¨‹åºå‘˜çš„æ—¶é—´è€Œä¸æ˜¯æµªè´¹æœºå™¨çš„æ—¶é—´æ‰æ˜¯çœŸæ­£çš„æ— æ•ˆç‡ã€‚éšç€è®¡ç®—æœºé€Ÿåº¦è¶Šæ¥è¶Šå¿«ï¼Œè¿™ä¼šå˜å¾—è¶Šæ¥è¶Šæ˜æ˜¾ã€‚</p>
<h1 id="13-ä¹¦å‘†å­çš„å¤ä»‡"><a href="#13-ä¹¦å‘†å­çš„å¤ä»‡" class="headerlink" title="13 ä¹¦å‘†å­çš„å¤ä»‡"></a>13 ä¹¦å‘†å­çš„å¤ä»‡</h1><p>åœ¨å¤§å‹ç»„ç»‡å†…éƒ¨ï¼Œæœ‰ä¸€ä¸ªä¸“é—¨çš„æœ¯è¯­æè¿°è¿™ç§è·Ÿéšå¤§å¤šæ•°äººçš„é€‰æ‹©çš„åšæ³•ï¼Œå«åšâ€œä¸šç•Œæœ€ä½³å®è·µâ€ã€‚è¿™ä¸ªè¯å‡ºç°çš„åŸå› å…¶å®å°±æ˜¯ä¸ºäº†è®©ä½ çš„ç»ç†å¯ä»¥æ¨å¸è´£ä»»ã€‚æ—¢ç„¶æˆ‘é€‰æ‹©çš„æ˜¯â€œä¸šç•Œæœ€ä½³å®è·µâ€ï¼Œå¦‚æœä¸æˆåŠŸï¼Œé¡¹ç›®å¤±è´¥äº†ï¼Œé‚£ä¹ˆä½ ä¹Ÿæ— æ³•æŒ‡è´£æˆ‘ï¼Œå› ä¸ºåšå‡ºé€‰æ‹©çš„äººä¸æ˜¯æˆ‘ï¼Œè€Œæ˜¯æ•´ä¸ªâ€œä¸šç•Œâ€ã€‚</p>
<p>ç¬¬ä¸€ï¼Œä¸åŒè¯­è¨€çš„ç¼–ç¨‹èƒ½åŠ›ä¸ä¸€æ ·ã€‚ç¬¬äºŒï¼Œå¤§å¤šæ•°ç»ç†æ•…æ„å¿½è§†ç¬¬ä¸€ç‚¹ã€‚ä½ æŠŠè¿™ä¸¤ç‚¹äº‹å®ç»“åˆèµ·æ¥ï¼Œå…¶å®å°±å¾—åˆ°äº†èµšé’±çš„è¯€çª</p>
<h1 id="14-æ¢¦å¯ä»¥æ±‚çš„ç¼–ç¨‹è¯­è¨€"><a href="#14-æ¢¦å¯ä»¥æ±‚çš„ç¼–ç¨‹è¯­è¨€" class="headerlink" title="14 æ¢¦å¯ä»¥æ±‚çš„ç¼–ç¨‹è¯­è¨€"></a>14 æ¢¦å¯ä»¥æ±‚çš„ç¼–ç¨‹è¯­è¨€</h1><p>è®©æˆ‘ä»¬è¯•ç€æè¿°é»‘å®¢å¿ƒç›®ä¸­æ¢¦å¯ä»¥æ±‚çš„è¯­è¨€æ¥ä¸ºä»¥ä¸Šå†…å®¹åšä¸ªå°ç»“ã€‚è¿™ç§è¯­è¨€å¹²å‡€ç®€ç»ƒï¼Œå…·æœ‰æœ€é«˜å±‚æ¬¡çš„æŠ½è±¡å’Œäº’åŠ¨æ€§ï¼Œè€Œä¸”å¾ˆå®¹æ˜“è£…å¤‡ï¼Œå¯ä»¥åªç”¨å¾ˆå°‘çš„ä»£ç å°±è§£å†³å¸¸è§çš„é—®é¢˜ã€‚ä¸ç®¡æ˜¯ä»€ä¹ˆç¨‹åºï¼Œä½ çœŸæ­£è¦å†™çš„ä»£ç å‡ ä¹éƒ½ä¸ä½ è‡ªå·±çš„ç‰¹å®šè®¾ç½®æœ‰å…³ï¼Œå…¶ä»–å…·æœ‰æ™®éæ€§çš„é—®é¢˜éƒ½æœ‰ç°æˆçš„å‡½æ•°åº“å¯ä»¥è°ƒç”¨ã€‚</p>
<h1 id="15-è®¾è®¡ä¸ç ”ç©¶"><a href="#15-è®¾è®¡ä¸ç ”ç©¶" class="headerlink" title="15 è®¾è®¡ä¸ç ”ç©¶"></a>15 è®¾è®¡ä¸ç ”ç©¶</h1><p>å…¶ä¸­æœ‰ä¸€ç‚¹æ˜¯æ­£ç¡®çš„ï¼Œé‚£å°±æ˜¯å¦‚æœä½ æ­£åœ¨è®¾è®¡æŸç§æ–°ä¸œè¥¿ï¼Œå°±åº”è¯¥å°½å¿«æ‹¿å‡ºåŸå‹ï¼Œå¬å–ç”¨æˆ·çš„æ„è§ã€‚</p>
<p>åŸå‹ï¼ˆprototypeï¼‰å¹¶ä¸åªæ˜¯æ¨¡å‹ï¼ˆmodelï¼‰ï¼Œä¸ç­‰äºå°†æ¥ä¸€å®šè¦å¦èµ·ç‚‰ç¶ï¼Œä½ å®Œå…¨èƒ½å¤Ÿåœ¨åŸå‹çš„åŸºç¡€ä¸Šç›´æ¥åšå‡ºæœ€åçš„æˆå“ã€‚æˆ‘è®¤ä¸ºï¼Œåªè¦æœ‰å¯èƒ½ï¼Œä½ å°±åº”è¯¥è¿™æ ·åšã€‚</p>
<p>ä¸ºäº†æŠŠäº§å“è®¾è®¡å¥½ï¼Œä½ å¿…é¡»å¯¹è‡ªå·±è¯´ï¼šâ€œå“‡ï¼Œè¿™ä¸ªäº§å“å¤ªæ£’äº†ï¼Œæˆ‘ä¸€å®šè¦è®¾è®¡å¥½ï¼â€è€Œä¸æ˜¯å¿ƒæƒ³ï¼šâ€œè¿™ç§åƒåœ¾ç©æ„ï¼Œåªæœ‰å‚»ç“œæ‰ä¼šå–œæ¬¢ï¼Œéšä¾¿è®¾è®¡ä¸€ä¸‹å°±è¡Œäº†ã€‚â€è®¾è®¡æ„å‘³ç€åšå‡ºç¬¦åˆäººç±»ç‰¹ç‚¹å’Œéœ€è¦çš„äº§å“ã€‚ä½†æ˜¯ï¼Œâ€œäººç±»â€ä¸ä»…åŒ…æ‹¬ç”¨æˆ·ï¼Œè¿˜åŒ…æ‹¬è®¾è®¡å¸ˆï¼Œæ‰€ä»¥è®¾è®¡å·¥ä½œæœ¬èº«ä¹Ÿå¿…é¡»ç¬¦åˆè®¾è®¡å¸ˆçš„ç‰¹ç‚¹å’Œéœ€è¦ã€‚</p>
]]></content>
      <tags>
        <tag>book</tag>
      </tags>
  </entry>
  <entry>
    <title>Hiveçª—å£å‡½æ•°å®æˆ˜</title>
    <url>/2019/02/20/hive-window-sql/</url>
    <content><![CDATA[<p>æœ¬æ–‡å°†ä»‹ç»ä½¿ç”¨Hiveå¼ºå¤§çš„çª—å£å‡½æ•°ï¼Œè§£å†³å®é™…é—®é¢˜çš„æ–¹æ³•ï¼Œä»…ä¾›å‚è€ƒã€‚</p>
<span id="more"></span>

<h1 id="è¿ç»­ç™»é™†-x2F-æ´»è·ƒ-x2F-è®¿é—®é—®é¢˜"><a href="#è¿ç»­ç™»é™†-x2F-æ´»è·ƒ-x2F-è®¿é—®é—®é¢˜" class="headerlink" title="è¿ç»­ç™»é™†&#x2F;æ´»è·ƒ&#x2F;è®¿é—®é—®é¢˜"></a>è¿ç»­ç™»é™†&#x2F;æ´»è·ƒ&#x2F;è®¿é—®é—®é¢˜</h1><p>å‡è®¾æœ‰ä¸€å¼ ç™»é™†æ—¥å¿—è¡¨ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_login (</span><br><span class="line">    uid <span class="type">int</span> comment <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">    dt <span class="type">int</span> comment <span class="string">&#x27;æ—¥æœŸyyyymmdd&#x27;</span></span><br><span class="line">) STORED <span class="keyword">AS</span> PARQUET</span><br></pre></td></tr></table></figure>
<p>PSï¼šå¦‚æœç”¨æˆ·åœ¨æŸå¤©å¤šæ¬¡ç™»é™†ï¼Œä¹Ÿåªä¼šæœ‰ä¸€æ¡è®°å½•ã€‚</p>
<h2 id="è®¡ç®—è·ç¦»ä¸Šæ¬¡ç™»å½•å¤©æ•°"><a href="#è®¡ç®—è·ç¦»ä¸Šæ¬¡ç™»å½•å¤©æ•°" class="headerlink" title="è®¡ç®—è·ç¦»ä¸Šæ¬¡ç™»å½•å¤©æ•°"></a>è®¡ç®—è·ç¦»ä¸Šæ¬¡ç™»å½•å¤©æ•°</h2><p>å…ˆæ¥ä¸ªæœ€ç®€å•çš„æ¡ˆä¾‹, è¦ç®—å‡ºç”¨æˆ·æ¯æ¬¡ç™»é™†ï¼Œè·ç¦»ä¸Šæ¬¡æœ‰å¤šå°‘å¤©ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span>,dt <span class="operator">-</span> <span class="built_in">lag</span>(dt,<span class="number">1</span>) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> uid <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt)</span><br><span class="line"><span class="keyword">from</span> user_login</span><br></pre></td></tr></table></figure>
<p>lag å‡½æ•°æ˜¯å–ä¸ŠNè¡Œçš„æŒ‡å®šåˆ—çš„æ•°æ®ï¼ŒNé»˜è®¤æ˜¯1ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥å†™æˆlag(dt)ã€‚</p>
<h2 id="è®¡ç®—è¿ç»­ç™»å½•å¤©æ•°"><a href="#è®¡ç®—è¿ç»­ç™»å½•å¤©æ•°" class="headerlink" title="è®¡ç®—è¿ç»­ç™»å½•å¤©æ•°"></a>è®¡ç®—è¿ç»­ç™»å½•å¤©æ•°</h2><p>è®¡ç®—ç”¨æˆ·è¿ç»­ç™»é™†äº†å¤šå°‘å¤©ï¼Œä¸€æ®µæ—¶é—´å†…å¯èƒ½ä¼šæœ‰å¤šæ¬¡è¿ç»­ç™»é™†ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    uid,</span><br><span class="line">    <span class="built_in">max</span>(dt)<span class="operator">-</span><span class="built_in">min</span>(dt) diff,</span><br><span class="line">    collect_set(dt)</span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        a.uid,</span><br><span class="line">        a.dt,</span><br><span class="line">        dt <span class="operator">-</span> rn num</span><br><span class="line">    <span class="keyword">from</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> uid, dt, <span class="built_in">row_number</span>() <span class="keyword">over</span> ( <span class="keyword">PARTITION</span> <span class="keyword">BY</span> uid <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt ) rn</span><br><span class="line">        <span class="keyword">FROM</span> user_login</span><br><span class="line">    ) a</span><br><span class="line">) b</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> uid,num</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦ç†è§£çš„å…³é”®ç‚¹æ˜¯â€™dt - rnâ€™å¾—åˆ°numè¿™ä¸ªè®¡ç®—ï¼Œä¹Ÿå°±æ˜¯å°†æ—¥æœŸå‡å»è¡Œå·ï¼Œ<br>è¿™æ˜¯ä¸ªå–å·§çš„ç®—æ³•ï¼Œçœ‹èµ·æ¥æœ‰ç‚¹å¥‡æ€ªã€‚</p>
<p>å› ä¸ºrow_number()æ˜¯æŒ‰dtæ­£åºçš„ï¼Œæ‰€ä»¥è¿ç»­çš„dtå‡å»è¡Œå·ï¼Œä¼šå¾—åˆ°åŒä¸€ä¸ªå€¼ï¼Œè€Œéè¿ç»­çš„åˆ™ä¸ä¼šã€‚<br>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>dt</th>
<th>row_number</th>
<th>dt - row_number (num)</th>
</tr>
</thead>
<tbody><tr>
<td>u1</td>
<td>20190203</td>
<td>1</td>
<td>20190202</td>
</tr>
<tr>
<td>u1</td>
<td>20190204</td>
<td>2</td>
<td>20190202</td>
</tr>
<tr>
<td>u1</td>
<td>20190206</td>
<td>3</td>
<td>20190203</td>
</tr>
</tbody></table>
<p>è¿™é‡Œå…¶å®å°±æ˜¯å­æŸ¥è¯¢bçš„ç»“æœï¼Œç†è§£äº†è¿™ä¸ªï¼Œæœ€å¤–å±‚çš„è¯­å¥å°±å¾ˆå¥½ç†è§£äº†ã€‚</p>
<h2 id="æ ‡è®°ç”¨æˆ·è¿ç»­é—´éš”ä¸è¶…è¿‡3å¤©çš„ç™»å½•"><a href="#æ ‡è®°ç”¨æˆ·è¿ç»­é—´éš”ä¸è¶…è¿‡3å¤©çš„ç™»å½•" class="headerlink" title="æ ‡è®°ç”¨æˆ·è¿ç»­é—´éš”ä¸è¶…è¿‡3å¤©çš„ç™»å½•"></a>æ ‡è®°ç”¨æˆ·è¿ç»­é—´éš”ä¸è¶…è¿‡3å¤©çš„ç™»å½•</h2><p>æ ‡è®°ç”¨æˆ·è¿ç»­çš„æ´»è·ƒè®°å½•ï¼Œåªè¦ä¸è¶…è¿‡3å¤©é—´éš”ï¼Œå°±ç®—è¿ç»­æ´»è·ƒã€‚</p>
<p>å‡è®¾æœ‰è®°å½•å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>dt</th>
</tr>
</thead>
<tbody><tr>
<td>u1</td>
<td>20190203</td>
</tr>
<tr>
<td>u1</td>
<td>20190204</td>
</tr>
<tr>
<td>u1</td>
<td>20190206</td>
</tr>
<tr>
<td>u1</td>
<td>20190210</td>
</tr>
<tr>
<td>u1</td>
<td>20190211</td>
</tr>
</tbody></table>
<p>è¿™é‡Œéœ€æ±‚å°±æ˜¯è¦æŠŠå‰3è¡Œå’Œå2è¡ŒåŒºåˆ†å‡ºæ¥ï¼Œå› ä¸º20190206å’Œ20190210ä¹‹é—´éš”äº†4å¤©ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span>,<span class="built_in">max</span>(flag) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> uid <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">and</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) session_id</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> uid,dt,if(dt<span class="operator">-</span><span class="built_in">lag</span>(dt)<span class="operator">&gt;</span><span class="number">3</span>,dt,<span class="number">0</span>) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> uid <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt) flag</span><br><span class="line">    <span class="keyword">from</span> user_login</span><br><span class="line">) t</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå­æŸ¥è¯¢tå°±æ˜¯å…ˆæ ‡è®°å¤„é—´éš”å¤§äº3çš„è®°å½•ã€‚</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>dt</th>
<th>flag</th>
</tr>
</thead>
<tbody><tr>
<td>u1</td>
<td>20190203</td>
<td>0</td>
</tr>
<tr>
<td>u1</td>
<td>20190204</td>
<td>0</td>
</tr>
<tr>
<td>u1</td>
<td>20190206</td>
<td>0</td>
</tr>
<tr>
<td>u1</td>
<td>20190210</td>
<td>20190210</td>
</tr>
<tr>
<td>u1</td>
<td>20190211</td>
<td>0</td>
</tr>
</tbody></table>
<p>æœ€å¤–å±‚çš„æŸ¥è¯¢ï¼Œé€šè¿‡çª—å£å‡½æ•°ï¼Œä»å½“å‰è¡Œå¾€ä¸Šæ‰¾å‡ºæœ€å¤§çš„flagï¼Œå› ä¸ºæŒ‰dtæ’åºï¼Œå¾—åˆ°çš„å…¶å®å°±æ˜¯æœ€è¿‘çš„flagï¼Œ<br>å°†è¯¥flagè®¾ç½®ä¸ºè‡ªå·±çš„session_idï¼Œè¡¨ç¤ºæ‰€å±åŒä¸€æ‰¹è¿ç»­æ´»è·ƒçš„è®°å½•ã€‚<br>å¾—åˆ°ï¼š</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>dt</th>
<th>flag</th>
<th>session_id</th>
</tr>
</thead>
<tbody><tr>
<td>u1</td>
<td>20190203</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>u1</td>
<td>20190204</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>u1</td>
<td>20190206</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>u1</td>
<td>20190210</td>
<td>20190210</td>
<td>20190210</td>
</tr>
<tr>
<td>u1</td>
<td>20190211</td>
<td>0</td>
<td>20190210</td>
</tr>
</tbody></table>
<p>ç°åœ¨å‰3è¡Œå’Œå2è¡Œï¼Œå°±è¢«æ ‡è®°ä¸ºä¸åŒçš„ç»„äº†ã€‚</p>
<p><strong>å¦‚æœæˆ‘ä»¬æœ‰çš„æ˜¯ç²¾ç¡®åˆ°åˆ†ã€ç§’çš„æ—¥å¿—ï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆå¯ä»¥ç”¨æ¥ç»™ç”¨æˆ·çš„è®¿é—®è®°å½•æ‰“ä¸Šä¼šè¯æ ‡è®°ï¼Œç„¶åæ‹¿æ¥è®¡ç®—å•æ¬¡è®¿é—®æ—¶é•¿ï¼Œè®¿é—®æ·±åº¦ç­‰ç­‰ï¼Œåªæ˜¯è¿™é‡Œçš„dtæ”¹æˆæ—¶é—´æˆ³è€Œå·²ã€‚</strong></p>
<p>è®¡ç®—ä¼šè¯æ ‡è®°å…¶å®æ˜¯æ•°ä»“åŒäº‹æçš„éœ€æ±‚ï¼Œä¹Ÿæ˜¯æˆ‘æƒ³å‡ºè¿™ä¸ªsqlæ–¹æ¡ˆçš„åˆè¡·ã€‚</p>
<p>å¸Œæœ›èƒ½å¸®åˆ°éœ€è¦çš„äººã€‚^-^</p>
]]></content>
      <tags>
        <tag>hive</tag>
        <tag>sql</tag>
      </tags>
  </entry>
  <entry>
    <title>Mavenç”¨æˆ·éƒ½åº”è¯¥çŸ¥é“çš„ä¸€äº›äº‹ï¼šå…³äºä¾èµ–çš„å¸¸è§é—®é¢˜</title>
    <url>/2019/06/20/maven-details-about-dependency/</url>
    <content><![CDATA[<h1 id="ä¾èµ–èŒƒå›´-scope-ä¸åŒé€‰é¡¹çš„åŒºåˆ«"><a href="#ä¾èµ–èŒƒå›´-scope-ä¸åŒé€‰é¡¹çš„åŒºåˆ«" class="headerlink" title="ä¾èµ–èŒƒå›´(scope)ä¸åŒé€‰é¡¹çš„åŒºåˆ«"></a>ä¾èµ–èŒƒå›´(scope)ä¸åŒé€‰é¡¹çš„åŒºåˆ«</h1><p>ä¾èµ–èŒƒå›´å‚æ•°çš„ä½œç”¨æ˜¯æ§åˆ¶ä¾èµ–åœ¨ä¸åŒé˜¶æ®µä¸classpathçš„å…³ç³»ï¼Œå…·ä½“åŒºåˆ«å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<span id="more"></span>

<p><img src="https://raw.githubusercontent.com/Liam8/img/master/maven/scope.png" alt="ä¾èµ–èŒƒå›´å›¾"></p>
<p>è¡¨ä¸­æ²¡æœ‰åˆ—å‡ºçš„å€¼æ˜¯importï¼Œè¿™ä¸ªé€‰é¡¹æ˜¯ç”¨äºå¼•å…¥dependencyManagementï¼Œä¸‹æ–‡ä¼šæœ‰ä»‹ç»ã€‚</p>
<h1 id="ä¾èµ–è°ƒè§£ï¼Œè°ƒè§£åŒä¸€ä¾èµ–çš„ä¸åŒç‰ˆæœ¬"><a href="#ä¾èµ–è°ƒè§£ï¼Œè°ƒè§£åŒä¸€ä¾èµ–çš„ä¸åŒç‰ˆæœ¬" class="headerlink" title="ä¾èµ–è°ƒè§£ï¼Œè°ƒè§£åŒä¸€ä¾èµ–çš„ä¸åŒç‰ˆæœ¬"></a>ä¾èµ–è°ƒè§£ï¼Œè°ƒè§£åŒä¸€ä¾èµ–çš„ä¸åŒç‰ˆæœ¬</h1><p>å‡è®¾ä½ çš„é¡¹ç›®æœ‰å¦‚ä¸‹çš„ä¾èµ–æ ‘</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POM</span><br><span class="line">|-- A</span><br><span class="line">|   `-- B 1.0</span><br><span class="line">|-- C</span><br><span class="line">|   `-- D</span><br><span class="line">|       `-- B 2.0</span><br><span class="line">`-- E</span><br><span class="line">    `-- B 3.0</span><br></pre></td></tr></table></figure>

<p>POMåŒæ—¶ä¾èµ–äº†Bçš„1.0å’Œ2.0ç‰ˆæœ¬ï¼Œå¯Mavenæ˜¯ä¸ä¼šé‡å¤å¼•å…¥ç›¸åŒåæ ‡çš„ä¾èµ–çš„ï¼Œé‚£ä¹ˆç©¶ç«Ÿå“ªä¸ªç‰ˆæœ¬ä¼šç”Ÿæ•ˆå‘¢ï¼Ÿ</p>
<p>Mavenå¯¹äºä¾èµ–çš„è°ƒè§£éµå¾ªä¸¤ä¸ªåŸºæœ¬åŸåˆ™ï¼š</p>
<ul>
<li>1 ä¾èµ–è·¯å¾„é•¿åº¦çŸ­è€…ä¼˜å…ˆï¼›</li>
<li>2 å¦‚æœä¾èµ–è·¯å¾„é•¿åº¦ç›¸åŒï¼Œåˆ™åå£°æ˜ä¼˜å…ˆã€‚</li>
</ul>
<p>æ‰€ä»¥æ ¹æ®1ï¼Œ2.0ç‰ˆæœ¬è¢«æ’é™¤ï¼Œæ ¹æ®2ï¼Œ3.0ç‰ˆæœ¬è¢«å®é™…å¼•å…¥ã€‚</p>
<p>å¦‚æœä½ è‡ªå·±æ˜ç¡®çŸ¥é“è¯¥å¼•å…¥å“ªä¸ªç‰ˆæœ¬çš„Bï¼Œé‚£ä¹ˆç›´æ¥åœ¨POMä¸­å£°æ˜Bä¾èµ–å°±å¥½äº†ï¼Œå› ä¸ºè¿™æ—¶çš„ä¾èµ–è·¯å¾„æ˜¯æœ€çŸ­äº†ã€‚</p>
<h1 id="å¯é€‰ä¾èµ–-optional-å«ä¹‰"><a href="#å¯é€‰ä¾èµ–-optional-å«ä¹‰" class="headerlink" title="å¯é€‰ä¾èµ–(optional)å«ä¹‰"></a>å¯é€‰ä¾èµ–(optional)å«ä¹‰</h1><p>å¯é€‰ä¾èµ–çš„ä½œç”¨å°±æ˜¯å£°æ˜è¯¥ä¾èµ–ä¸è¢«ä¼ é€’ä¾èµ–ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POM</span><br><span class="line">`-- A</span><br><span class="line">   `-- B(optional)</span><br></pre></td></tr></table></figure>
<p>è¿™é‡ŒBä¸ä¼šè¢«å¼•å…¥ã€‚</p>
<h1 id="Super-POM-Project-Object-Model"><a href="#Super-POM-Project-Object-Model" class="headerlink" title="Super POM(Project Object Model)"></a>Super POM(Project Object Model)</h1><p>Super POMæ˜¯Mavenè‡ªå¸¦çš„å…¨å±€POMæ–‡ä»¶ï¼Œæ‰€æœ‰çš„POMæ–‡ä»¶éƒ½é»˜è®¤ç»§æ‰¿äº†Super POMã€‚å…¶ä¸­å®šä¹‰äº†å„ç§é»˜è®¤é…ç½®ï¼Œä»¥ç®€åŒ–POMæ–‡ä»¶çš„ç¼–å†™ã€‚ä¸‹é¢æ˜¯Maven 3.5.4çš„Super POMçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Central Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.maven.apache.org/maven2<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">layout</span>&gt;</span>default<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Central Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.maven.apache.org/maven2<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">layout</span>&gt;</span>default<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>never<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.basedir&#125;/target<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$&#123;project.build.directory&#125;/classes<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;-$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">testOutputDirectory</span>&gt;</span>$&#123;project.build.directory&#125;/test-classes<span class="tag">&lt;/<span class="name">testOutputDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>$&#123;project.basedir&#125;/src/main/java<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scriptSourceDirectory</span>&gt;</span>$&#123;project.basedir&#125;/src/main/scripts<span class="tag">&lt;/<span class="name">scriptSourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">testSourceDirectory</span>&gt;</span>$&#123;project.basedir&#125;/src/test/java<span class="tag">&lt;/<span class="name">testSourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.basedir&#125;/src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">testResources</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">testResource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.basedir&#125;/src/test/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">testResource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">testResources</span>&gt;</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>Super POMä¸­å®šä¹‰äº†ä¸­å¤®ä¾èµ–ä»“åº“ã€ä¸­å¤®æ’ä»¶ä»“åº“ï¼Œä»¥åŠå„ç§æ–‡ä»¶å¤¹çš„é»˜è®¤è·¯å¾„ã€‚</p>
<h1 id="POMç»§æ‰¿"><a href="#POMç»§æ‰¿" class="headerlink" title="POMç»§æ‰¿"></a>POMç»§æ‰¿</h1><p>å¦‚æœä½ çš„é¡¹ç›®æœ‰å¤šä¸ªæ¨¡å—ï¼Œé€šå¸¸æ¯ä¸ªæ¨¡å—ä¹‹é—´ä¼šæœ‰ä¸€äº›ç›¸åŒçš„å…¬å…±çš„ä¾èµ–ï¼Œä½ å¯ä»¥æŠŠä¾èµ–å£°æ˜åœ¨æ¨¡å—å„è‡ªçš„POMä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">|-- mod A</span><br><span class="line">|   `-- pom.xml</span><br><span class="line">|       `-- P(1.0)</span><br><span class="line">`-- mod B</span><br><span class="line">    `-- pom.xml</span><br><span class="line">        `-- P(1.0)</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·Aæ¨¡å—å’ŒBæ¨¡å—éƒ½ä¾èµ–äº†Pï¼Œä½†æ˜¯å¦‚æœæœ‰å¤©ä½ æƒ³è¦ä¿®æ”¹Pçš„ç‰ˆæœ¬ï¼Œåˆå¸Œæœ›A,Bæ¨¡å—ä¾èµ–çš„Pç‰ˆæœ¬ç›¸åŒï¼Œé‚£å°±å¾—åŒæ—¶ä¿®æ”¹POM-Aå’ŒPOM-Bï¼Œå¤ªä¸ä¼˜é›…äº†ã€‚</p>
<p>æ‰€ä»¥Mavenæä¾›äº†POMç»§æ‰¿åŠŸèƒ½ï¼Œè®©æˆ‘ä»¬å¯ä»¥å§å…¬å…±çš„ä¾èµ–æŠ½å–å‡ºæ¥ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">|-- pom.xml (çˆ¶POM)</span><br><span class="line">|   `-- P(1.0)</span><br><span class="line">|-- mod A</span><br><span class="line">|   `-- pom.xml</span><br><span class="line">`-- mod B</span><br><span class="line">    `-- pom.xml</span><br></pre></td></tr></table></figure>

<p>åšæ³•å¦‚ä¸Šï¼Œåœ¨çˆ¶POMä¸­å£°æ˜ä¾èµ–Pï¼Œåœ¨ABæ¨¡å—çš„POMä¸­å£°æ˜å¯¹çˆ¶POMçš„ç»§æ‰¿ï¼Œä¾¿èƒ½å®ç°ABæ¨¡å—å¯¹Pä¾èµ–çš„å¼•å…¥ã€‚</p>
<p>ABæ¨¡å—ä¸­åŠ å…¥ä¸‹é¢ä¸€æ®µï¼Œä¾¿èƒ½å®ç°å¯¹çˆ¶POMçš„ç»§æ‰¿ã€‚</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mycompany.app<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-app<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>relativePathçš„é»˜è®¤å€¼å³æ˜¯â€˜..&#x2F;pom.xmlâ€™ï¼Œå¯ä»¥çœç•¥ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™é‡Œçˆ¶POMå¹¶ä¸éœ€è¦çŸ¥é“å­POMçš„ä¿¡æ¯ã€‚</p>
<p><strong>æ€»ä¹‹ï¼Œæœ‰äº†ç»§æ‰¿ï¼Œå­æ¨¡å—å°±èƒ½æ‹¥æœ‰çˆ¶æ¨¡å—åŒæ ·çš„ä¾èµ–ã€‚</strong></p>
<h1 id="POMèšåˆ"><a href="#POMèšåˆ" class="headerlink" title="POMèšåˆ"></a>POMèšåˆ</h1><p>å‡è®¾ä½ çš„é¡¹ç›®æœ‰å¤šä¸ªæ¨¡å—ï¼Œé€šå¸¸æ¯ä¸ªæ¨¡å—éœ€è¦å„è‡ªå•ç‹¬æ„å»ºï¼Œå¦‚æœæƒ³è¦æ‰€æœ‰æ¨¡å—èƒ½åŒæ—¶æ„å»ºï¼Œåˆ™éœ€è¦ä½¿ç”¨Mavençš„èšåˆåŠŸèƒ½ã€‚</p>
<p>ä½¿ç”¨èšåˆåŒæ ·éœ€è¦å»ºä¸€ä¸ªçˆ¶POM</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">|-- pom.xml (çˆ¶POM)</span><br><span class="line">|-- A</span><br><span class="line">|   `-- pom.xml</span><br><span class="line">`-- B</span><br><span class="line">    `-- pom.xml</span><br></pre></td></tr></table></figure>
<p>çˆ¶POMå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mycompany.app<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-app<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>A<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>B<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­packagingå¿…é¡»æ˜¯pomï¼Œmodulesä¸­å£°æ˜éœ€è¦èšåˆçš„å­æ¨¡å—ã€‚<br>ä¸ç»§æ‰¿ç›¸åï¼Œå­POMä¸­ä¸éœ€è¦çˆ¶POMçš„ä¿¡æ¯ã€‚</p>
<p><strong>æ€»ä¹‹ï¼Œæœ‰äº†èšåˆï¼Œæ‰€æœ‰å¯¹çˆ¶æ¨¡å—æ‰§è¡Œçš„Mavenå‘½ä»¤ï¼ŒåŒæ ·ä¼šå¯¹å­æ¨¡å—æ‰§è¡Œã€‚</strong></p>
<h1 id="ä¾èµ–ç®¡ç†-dependencyManagement-æ˜¯ä»€ä¹ˆ"><a href="#ä¾èµ–ç®¡ç†-dependencyManagement-æ˜¯ä»€ä¹ˆ" class="headerlink" title="ä¾èµ–ç®¡ç†(dependencyManagement)æ˜¯ä»€ä¹ˆ"></a>ä¾èµ–ç®¡ç†(dependencyManagement)æ˜¯ä»€ä¹ˆ</h1><p>åœ¨å‰é¢è®²ç»§æ‰¿çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡çˆ¶POMä½¿å¾—ABä¸¤ä¸ªæ¨¡å—éƒ½æ‹¥æœ‰äº†ä¾èµ–Pï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ç°åœ¨æ·»åŠ ä¸€ä¸ªæ¨¡å—Cï¼Œæ¨¡å—Cå¹¶ä¸éœ€è¦ä¾èµ–Pï¼Œåªéœ€è¦çˆ¶POMä¸­çš„å…¶ä»–é…ç½®å’Œä¾èµ–ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>è¿™å°±è¦ç”¨åˆ°dependencyManagementè¿™ä¸ªé…ç½®äº†ï¼ŒdependencyManagementä¸dependencieså…ƒç´ ä¸åŒåœ¨äºå¹¶ä¸ä¼šçœŸçš„å¼•å…¥ä¾èµ–ï¼Œåªæ˜¯æŒ‡å®šä¾èµ–çš„ç‰ˆæœ¬ã€‚</p>
<p>åšæ³•æ˜¯åœ¨çˆ¶POMä¸­æ·»åŠ dependencyManagementé…ç½®</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>groupabc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>p<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨ABæ¨¡å—çš„POMä¸­æ·»åŠ å¦‚ä¸‹ï¼Œæ³¨æ„ä¸å«ç‰ˆæœ¬ä¿¡æ¯ã€‚</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>groupabc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>p<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>  </span><br></pre></td></tr></table></figure>

<p>å¦‚æ­¤ä¸€æ¥ï¼ŒABæ¨¡å—éƒ½å¼•å…¥äº†ä¾èµ–pçš„v1.0ï¼Œè€Œæ¨¡å—Cæ²¡æœ‰å¼•å…¥ä¾èµ–pã€‚</p>
<p>å¦å¤–è¿˜æœ‰pluginManagementä¸æ­¤ç±»ä¼¼ï¼Œä¸è¿‡æ˜¯é’ˆå¯¹æ’ä»¶è€Œå·²ã€‚</p>
<h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p><a href="https://maven.apache.org/guides/introduction/introduction-to-the-pom.html">Introduction to the POM</a></p>
<p><a href="https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html#Dependency_Management">Introduction to the Dependency Mechanism</a></p>
<p><a href="https://book.douban.com/subject/5345682/">ã€ŠMavenå®æˆ˜ã€‹</a></p>
<p>è½¬è½½è¯·ä¿ç•™åŸæ–‡åœ°å€ï¼š<a href="https://liam-blog.ml/2019/06/20/maven-details-about-dependency/">Mavenç”¨æˆ·éƒ½åº”è¯¥çŸ¥é“çš„ä¸€äº›äº‹ï¼šå…³äºä¾èµ–çš„å¸¸è§é—®é¢˜</a></p>
]]></content>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Mavenç”¨æˆ·éƒ½åº”è¯¥çŸ¥é“çš„ä¸€äº›äº‹ï¼šæ„å»ºç”Ÿå‘½å‘¨æœŸå’Œæ’ä»¶</title>
    <url>/2019/06/16/maven-lifecycle-and-plugin-goal/</url>
    <content><![CDATA[<p><strong>Mavençš„æ‰€æœ‰å®é™…æ“ä½œéƒ½æ˜¯ç”±æ’ä»¶å®Œæˆçš„ï¼Œå¦‚æœæ²¡æœ‰æ’ä»¶ï¼ŒMavenä»€ä¹ˆéƒ½ä¸ä¼šå¹²ã€‚</strong><br>ï¼ˆå³æ—¶ä½ æ²¡æœ‰åœ¨POMä¸­é…ç½®<code>&lt;plugin&gt;</code>å…ƒç´ ï¼ŒSuper POMä¸­ä¹Ÿå·²ç»å¸®ä½ å¼•å…¥äº†è‹¥å¹²æ ¸å¿ƒæ’ä»¶ï¼‰</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œé¡¹ç›®æ„å»ºè¿‡ç¨‹ä¸­ï¼ŒMavenæ˜¯æ€ä¹ˆçŸ¥é“åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨å“ªä¸ªæ’ä»¶çš„å‘¢ï¼Ÿ</p>
<p>æ’ä»¶çš„è°ƒç”¨æ—¶æœºï¼Œè·Ÿâ€™ç”Ÿå‘½å‘¨æœŸâ€™å’Œâ€™æ’ä»¶ç›®æ ‡â€™æœ‰å¾ˆå¤§å…³ç³»ã€‚</p>
<span id="more"></span>

<h1 id="æ’ä»¶ç›®æ ‡-Plugin-Goal-æ˜¯ä¸ªä»€ä¹ˆé¬¼"><a href="#æ’ä»¶ç›®æ ‡-Plugin-Goal-æ˜¯ä¸ªä»€ä¹ˆé¬¼" class="headerlink" title="æ’ä»¶ç›®æ ‡(Plugin Goal)æ˜¯ä¸ªä»€ä¹ˆé¬¼"></a>æ’ä»¶ç›®æ ‡(Plugin Goal)æ˜¯ä¸ªä»€ä¹ˆé¬¼</h1><p>é¦–å…ˆéœ€è¦çŸ¥é“çš„æ˜¯ï¼ŒMavençš„æ‰€æœ‰å…·ä½“ä»»åŠ¡éƒ½æ˜¯äº¤ç”±æ’ä»¶å®ç°çš„ï¼Œè€Œä¸€ä¸ªæ’ä»¶å¾€å¾€èƒ½å®ç°è‹¥å¹²ä¸ªä»»åŠ¡æˆ–åŠŸèƒ½ã€‚åˆæˆ–è€…å¯ä»¥è¯´ä¸€ä¸ªæ’ä»¶èƒ½å®ç°è‹¥å¹²ä¸ªç›®æ ‡ï¼Œæ¯”å¦‚ç¼–è¯‘æºç ã€æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ã€æ‰“åŒ…é¡¹ç›®ç­‰ç­‰ã€‚<br>ç®€å•æ¥è¯´ï¼Œåœ¨Mavenä¸­Plugin Goalå¯ä»¥çœ‹åšæ˜¯æ’ä»¶çš„ä¸€ä¸ªåŠŸèƒ½ã€‚</p>
<p>Plugin Goalé€šå¸¸ç”¨â€˜æ’ä»¶å‰ç¼€:æ’ä»¶ç›®æ ‡â€˜çš„æ ¼å¼æè¿°ï¼Œå¸¸è§çš„æœ‰ï¼š<code>compiler:compile</code>,<code>surefire:test</code>,<code>dependency:tree</code>ç­‰ã€‚</p>
<p>æ‰€è°“æ’ä»¶å‰ç¼€å°±æ˜¯æ’ä»¶çš„åç§°çš„ä¸€ä¸ªç®€å†™ï¼Œæ¯”å¦‚compileræŒ‡çš„å°±æ˜¯maven-complier-pluginè¿™ä¸ªæ’ä»¶ã€‚<br><code>compiler:compile</code>çš„æ„æ€æ—¢æ˜¯maven-complier-pluginæ’ä»¶çš„compileç›®æ ‡ã€‚</p>
<h1 id="æ„å»ºç”Ÿå‘½å‘¨æœŸ-Build-Lifecycle-åˆæ˜¯ä»€ä¹ˆ"><a href="#æ„å»ºç”Ÿå‘½å‘¨æœŸ-Build-Lifecycle-åˆæ˜¯ä»€ä¹ˆ" class="headerlink" title="æ„å»ºç”Ÿå‘½å‘¨æœŸ(Build Lifecycle)åˆæ˜¯ä»€ä¹ˆ"></a>æ„å»ºç”Ÿå‘½å‘¨æœŸ(Build Lifecycle)åˆæ˜¯ä»€ä¹ˆ</h1><p>æ„å»ºç”Ÿå‘½å‘¨æœŸæ˜¯å¯¹æ„å»ºè¿‡ç¨‹çš„æŠ½è±¡å’Œç»Ÿä¸€ï¼ŒåŒ…æ‹¬äº†å‡ ä¹æ‰€æœ‰çš„æ„å»ºæ­¥éª¤ï¼Œå¦‚æ¸…ç†ã€åˆå§‹åŒ–ã€ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…ç­‰ç­‰ã€‚</p>
<p>Mavenä¸ºä¸ç”¨çš„ç›®çš„å®šä¹‰äº†3å¥—ç›¸äº’ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸï¼š</p>
<ul>
<li>clean ç”¨äºæ¸…ç†é¡¹ç›®</li>
<li>default ç”¨äºæ„å»ºé¡¹ç›®</li>
<li>site ç”¨äºæ„å»ºé¡¹ç›®ç«™ç‚¹</li>
</ul>
<p>æ¯ç§ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯ç”±è‹¥å¹²é˜¶æ®µ(phase)ç»„æˆï¼Œå¦‚cleanç”Ÿå‘½å‘¨æœŸç”±pre-clean,clean,post-cleanä¸‰ä¸ªé˜¶æ®µç»„æˆã€‚</p>
<p>é˜¶æ®µä¹‹é—´æ˜¯æœ‰åºçš„ï¼Œè€Œä¸”åé¢çš„é˜¶æ®µä¾èµ–å‰é¢çš„é˜¶æ®µã€‚<br>ç”¨æˆ·æ‰§è¡Œ<code>mvn clean</code>æ—¶ï¼Œå®é™…ä¸Šmavenä¼šå…ˆæ‰§è¡Œpre-cleané˜¶æ®µï¼Œç„¶åå†æ‰§è¡Œcleané˜¶æ®µï¼›æ‰§è¡Œ<code>mvn post-clean</code>æ—¶ï¼Œåˆ™ä¼šä¾æ¬¡æ‰§è¡Œpre-clean,clean,post-cleanä¸‰ä¸ªé˜¶æ®µã€‚</p>
<p>3ä¸ªç”Ÿå‘½å‘¨æœŸå„è‡ªçš„é˜¶æ®µå¦‚ä¸‹ï¼š</p>
<h3 id="Clean-Lifecycle"><a href="#Clean-Lifecycle" class="headerlink" title="Clean Lifecycle"></a>Clean Lifecycle</h3><table>
<thead>
<tr>
<th>Phase</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>pre-clean</td>
<td>execute processes needed prior to the actual project cleaning</td>
</tr>
<tr>
<td>clean</td>
<td>remove all files generated by the previous build</td>
</tr>
<tr>
<td>post-clean</td>
<td>execute processes needed to finalize the project cleaning</td>
</tr>
</tbody></table>
<h3 id="Default-Lifecycle"><a href="#Default-Lifecycle" class="headerlink" title="Default Lifecycle"></a>Default Lifecycle</h3><table>
<thead>
<tr>
<th>Phase</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>validate</td>
<td>validate the project is correct and all necessary information is available.</td>
</tr>
<tr>
<td>initialize</td>
<td>initialize build state, e.g. set properties or create directories.</td>
</tr>
<tr>
<td>generate-sources</td>
<td>generate any source code for inclusion in compilation.</td>
</tr>
<tr>
<td>process-sources</td>
<td>process the source code, for example to filter any values.</td>
</tr>
<tr>
<td>generate-resources</td>
<td>generate resources for inclusion in the package.</td>
</tr>
<tr>
<td>process-resources</td>
<td>copy and process the resources into the destination directory, ready for packaging.</td>
</tr>
<tr>
<td>compile</td>
<td>compile the source code of the project.</td>
</tr>
<tr>
<td>process-classes</td>
<td>post-process the generated files from compilation, for example to do bytecode enhancement on Java classes.</td>
</tr>
<tr>
<td>generate-test-sources</td>
<td>generate any test source code for inclusion in compilation.</td>
</tr>
<tr>
<td>process-test-sources</td>
<td>process the test source code, for example to filter any values.</td>
</tr>
<tr>
<td>generate-test-resources</td>
<td>create resources for testing.</td>
</tr>
<tr>
<td>process-test-resources</td>
<td>copy and process the resources into the test destination directory.</td>
</tr>
<tr>
<td>test-compile</td>
<td>compile the test source code into the test destination directory</td>
</tr>
<tr>
<td>process-test-classes</td>
<td>post-process the generated files from test compilation, for example to do bytecode enhancement on Java classes. For Maven 2.0.5 and above.</td>
</tr>
<tr>
<td>test</td>
<td>run tests using a suitable unit testing framework. These tests should not require the code be packaged or deployed.</td>
</tr>
<tr>
<td>prepare-package</td>
<td>perform any operations necessary to prepare a package before the actual packaging. This often results in an unpacked, processed version of the package. (Maven 2.1 and above)</td>
</tr>
<tr>
<td>package</td>
<td>take the compiled code and package it in its distributable format, such as a JAR.</td>
</tr>
<tr>
<td>pre-integration-test</td>
<td>perform actions required before integration tests are executed. This may involve things such as setting up the required environment.</td>
</tr>
<tr>
<td>integration-test</td>
<td>process and deploy the package if necessary into an environment where integration tests can be run.</td>
</tr>
<tr>
<td>post-integration-test</td>
<td>perform actions required after integration tests have been executed. This may including cleaning up the environment.</td>
</tr>
<tr>
<td>verify</td>
<td>run any checks to verify the package is valid and meets quality criteria.</td>
</tr>
<tr>
<td>install</td>
<td>install the package into the local repository, for use as a dependency in other projects locally.</td>
</tr>
<tr>
<td>deploy</td>
<td>done in an integration or release environment, copies the final package to the remote repository for sharing with other developers and projects.</td>
</tr>
</tbody></table>
<h3 id="Site-Lifecycle"><a href="#Site-Lifecycle" class="headerlink" title="Site Lifecycle"></a>Site Lifecycle</h3><table>
<thead>
<tr>
<th>Phase</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>pre-site</td>
<td>execute processes needed prior to the actual project site generation</td>
</tr>
<tr>
<td>site</td>
<td>generate the projectâ€™s site documentation</td>
</tr>
<tr>
<td>post-site</td>
<td>execute processes needed to finalize the site generation, and to prepare for site deployment</td>
</tr>
<tr>
<td>site-deploy</td>
<td>deploy the generated site documentation to the specified web server</td>
</tr>
</tbody></table>
<h1 id="æ’ä»¶ç›®æ ‡ä¸ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®š"><a href="#æ’ä»¶ç›®æ ‡ä¸ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®š" class="headerlink" title="æ’ä»¶ç›®æ ‡ä¸ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®š"></a>æ’ä»¶ç›®æ ‡ä¸ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®š</h1><p><strong>æ’ä»¶ç›®æ ‡æ˜¯ä¸ç”Ÿå‘½å‘¨æœŸçš„æŸä¸ªé˜¶æ®µç»‘å®šçš„</strong>ï¼Œæ¯”å¦‚maven-clean-pluginçš„cleanç›®æ ‡ä¸cleané˜¶æ®µç»‘å®šï¼Œä¹Ÿå°±æ„å‘³ç€å½“mavenæ‰§è¡Œcleanç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œåˆ°è¾¾cleané˜¶æ®µçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨maven-clean-pluginçš„cleanç›®æ ‡(åˆ é™¤é¡¹ç›®è¾“å‡ºç›®å½•)ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>æ’ä»¶ç›®æ ‡çš„æ‰§è¡Œé¡ºåºæ˜¯ç”±å…¶ç»‘å®šåˆ°çš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µçš„é¡ºåºå†³å®šçš„ï¼Œå¦‚æœå¤šä¸ªæ’ä»¶ç›®æ ‡ç»‘å®šåˆ°åŒä¸€ä¸ªé˜¶æ®µï¼Œé‚£ä¹ˆå…ˆå£°æ˜çš„æ’ä»¶ä¼šåœ¨åå£°æ˜çš„æ’ä»¶ä¹‹å‰æ‰§è¡Œã€‚</strong></p>
<p>å¯¹äºä¸€äº›æ ¸å¿ƒæ’ä»¶ï¼ŒMavenå·²ç»å†…ç½®é»˜è®¤å°†ä¸€äº›æ’ä»¶ç›®æ ‡ç»‘å®šåˆ°äº†ç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼Œç‰¹åˆ«æ˜¯defaultç”Ÿå‘½å‘¨æœŸï¼Œå¯¹äºä¸åŒçš„æ‰“åŒ…ç±»å‹ï¼ˆjar,war,pomç­‰ï¼‰ï¼ŒMavenæä¾›äº†ä¸åŒçš„é»˜è®¤ç»‘å®šã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><strong>Clean Lifecycle Bindings</strong></p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>plugin:goal</th>
</tr>
</thead>
<tbody><tr>
<td>clean</td>
<td>clean:clean</td>
</tr>
</tbody></table>
<p><strong>Default Lifecycle Bindings - Packaging ejb &#x2F; ejb3 &#x2F; jar &#x2F; par &#x2F; rar &#x2F; war</strong></p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>plugin:goal</th>
</tr>
</thead>
<tbody><tr>
<td>process-resources</td>
<td>resources:resources</td>
</tr>
<tr>
<td>compile</td>
<td>compiler:compile</td>
</tr>
<tr>
<td>process-test-resources</td>
<td>resources:testResources</td>
</tr>
<tr>
<td>test-compile</td>
<td>compiler:testCompile</td>
</tr>
<tr>
<td>test</td>
<td>surefire:test</td>
</tr>
<tr>
<td>package</td>
<td>ejb:ejb  or  ejb3:ejb3  or  jar:jar  or  par:par  or  rar:rar  or  war:war</td>
</tr>
<tr>
<td>install</td>
<td>install:install</td>
</tr>
<tr>
<td>deploy</td>
<td>deploy:deploy</td>
</tr>
</tbody></table>
<p><strong>Default Lifecycle Bindings - Packaging ear</strong></p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>plugin:goal</th>
</tr>
</thead>
<tbody><tr>
<td>generate-resources</td>
<td>ear:generate-application-xml</td>
</tr>
<tr>
<td>process-resources</td>
<td>resources:resources</td>
</tr>
<tr>
<td>package</td>
<td>ear:ear</td>
</tr>
<tr>
<td>install</td>
<td>install:install</td>
</tr>
<tr>
<td>deploy</td>
<td>deploy:deploy</td>
</tr>
</tbody></table>
<p><strong>Default Lifecycle Bindings - Packaging maven-plugin</strong></p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>plugin:goal</th>
</tr>
</thead>
<tbody><tr>
<td>generate-resources</td>
<td>plugin:descriptor</td>
</tr>
<tr>
<td>process-resources</td>
<td>resources:resources</td>
</tr>
<tr>
<td>compile</td>
<td>compiler:compile</td>
</tr>
<tr>
<td>process-test-resources</td>
<td>resources:testResources</td>
</tr>
<tr>
<td>test-compile</td>
<td>compiler:testCompile</td>
</tr>
<tr>
<td>test</td>
<td>surefire:test</td>
</tr>
<tr>
<td>package</td>
<td>jar:jar and plugin:addPluginArtifactMetadata</td>
</tr>
<tr>
<td>install</td>
<td>install:install</td>
</tr>
<tr>
<td>deploy</td>
<td>deploy:deploy</td>
</tr>
</tbody></table>
<p><strong>Default Lifecycle Bindings - Packaging pom</strong></p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>plugin:goal</th>
</tr>
</thead>
<tbody><tr>
<td>package</td>
<td></td>
</tr>
<tr>
<td>install</td>
<td>install:install</td>
</tr>
<tr>
<td>deploy</td>
<td>deploy:deploy</td>
</tr>
</tbody></table>
<p><strong>Site Lifecycle Bindings</strong></p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>plugin:goal</th>
</tr>
</thead>
<tbody><tr>
<td>site</td>
<td>site:site</td>
</tr>
<tr>
<td>site-deploy</td>
<td>site:deploy</td>
</tr>
</tbody></table>
<h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><ul>
<li><a href="https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html">Introduction to the Build Lifecycle</a></li>
<li><a href="https://book.douban.com/subject/5345682/">ã€ŠMavenå®æˆ˜ã€‹</a></li>
</ul>
<p>è½¬è½½è¯·ä¿ç•™åŸæ–‡åœ°å€ï¼š<a href="https://liam-blog.ml/2019/06/16/maven-lifecycle-and-plugin-goal/">Mavenç”¨æˆ·éƒ½åº”è¯¥çŸ¥é“çš„ä¸€äº›äº‹ï¼šæ„å»ºç”Ÿå‘½å‘¨æœŸå’Œæ’ä»¶</a></p>
]]></content>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Scalaå¹¶å‘ç¼–ç¨‹å®æˆ˜ 2ï¼šLock é”</title>
    <url>/2019/07/21/Scala-Concurrency-in-Practice-2/</url>
    <content><![CDATA[<p>synchronizedä½œä¸ºå†…ç½®é”ï¼Œä½¿ç”¨ç®€å•ï¼Œä¸æ˜“å‡ºé”™ï¼Œç„¶é¹…ç¡®æœ‰ç›¸å½“çš„å±€é™æ€§ï¼Œä¾‹å¦‚ï¼Œæ— æ³•ä»ç­‰å¾…è·å–é”çš„é˜»å¡ä¸­ä¸­æ–­ï¼Œæ— æ³•è®¾ç½®è·å–é”çš„è¶…æ—¶ã€‚<br>æ‰€ä»¥JUCæä¾›äº†å¦ä¸€ç§æ›´çµæ´»çš„åŠ é”æ–¹å¼ï¼Œå³Lockã€‚</p>
<span id="more"></span>

<h1 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h1><p>Lockæ¥å£å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Lock</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;     </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;     </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>;     </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;     </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;     </span><br><span class="line">    Condition <span class="title function_">newCondition</span><span class="params">()</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»æ¥å£çš„å®šä¹‰ä¸éš¾å‘ç°ï¼ŒLockä¸ä»…æä¾›äº†å¸¸è§„çš„lock()é˜»å¡å¼åŠ é”ï¼Œä¹Ÿæä¾›äº†tryLockä½¿å¾—çº¿ç¨‹èƒ½åœ¨è·å–ä¸åˆ°é”æ—¶ï¼Œé©¬ä¸Šè¿”å›ï¼Œ<br>ç”šè‡³å¯ä»¥ç­‰å¾…é”ä¸€æ®µæ—¶é—´åï¼Œå†è¿”å›ã€‚lockInterruptiblyåˆ™æä¾›äº†å¯ä¸­æ–­çš„é˜»å¡å¼è·å–é”æ–¹å¼ã€‚</p>
<p>Lockçš„é”éœ€è¦æ˜¾ç¤ºé‡Šæ”¾ï¼Œé€šå¸¸è¦ä¸<code>try...finally</code>è¯­å¥ä¸€èµ·ä½¿ç”¨ï¼Œé¿å…æ­»é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lock.lock(); </span><br><span class="line"><span class="keyword">try</span> &#123;     </span><br><span class="line">   <span class="comment">// update object state     </span></span><br><span class="line">   <span class="comment">// catch exceptions and restore invariants if necessary </span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;     </span><br><span class="line">   lock.unlock(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><p>Lockæœ€å¸¸ç”¨çš„å®ç°ç±»æ˜¯ReentrantLockï¼Œè¿™æ˜¯ä¸€ä¸ª<em>å¯é‡å…¥é”</em>(synchronizedä¹Ÿæ˜¯)ã€‚</p>
<p>ReentrantLocké»˜è®¤å’Œå†…ç½®é”ä¸€æ ·ï¼Œæ˜¯éå…¬å¹³é”ï¼Œä½†æ˜¯æ”¯æŒ<em>å…¬å¹³é”</em>æ¨¡å¼ï¼Œå¯ä»¥ç”¨<code>ReentrantLock(true)</code>åˆ›å»ºå…¬å¹³é”ã€‚</p>
<h3 id="å¯é‡å…¥é”"><a href="#å¯é‡å…¥é”" class="headerlink" title="å¯é‡å…¥é”"></a>å¯é‡å…¥é”</h3><p>æ‰€è°“å¯é‡å…¥é”ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åœ¨æŒæœ‰è¯¥é”çš„æ—¶å€™ï¼Œå†æ¬¡è·å–è¯¥é”ã€‚å¯é‡å…¥é”é€šå¸¸ä¸ä¸€ä¸ªè®¡æ•°å™¨å…³è”ï¼Œç¬¬ä¸€æ¬¡è·å–é”çš„æ—¶å€™ï¼Œè®¡æ•°å™¨ä»0å˜ä¸º1ï¼Œå†æ¬¡è·å–é”ï¼Œå˜ä¸º2ï¼Œä»¥æ­¤ç±»æ¨ã€‚é‡Šæ”¾é”çš„æ—¶å€™ï¼Œè®¡æ•°å™¨æ¯æ¬¡å‡1ï¼Œç›´è‡³å‡ä¸º0ï¼Œè¯¥é”æ‰çœŸæ­£é‡Šæ”¾ç»™å…¶ä»–çº¿ç¨‹ã€‚<br><strong>ä¸ºå•¥éœ€è¦å¯é‡å…¥é”</strong><br>ä¸¾ä¸ªä¾‹å­(JCPä¹¦ä¸Šçš„)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Widget</span> &#123;     </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;         </span><br><span class="line">        ... </span><br><span class="line">    &#125; </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoggingWidget</span> <span class="keyword">extends</span> <span class="title class_">Widget</span> &#123;     </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;         </span><br><span class="line">        System.out.println(toString() + <span class="string">&quot;: calling doSomething&quot;</span>);         </span><br><span class="line">        <span class="built_in">super</span>.doSomething();     </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å­ç±»è¦†ç›–äº†çˆ¶ç±»æ–¹æ³•ï¼Œå¹¶å†æ¬¡è°ƒç”¨äº†çˆ¶ç±»çš„åŒæ­¥æ–¹æ³•ï¼Œå¦‚æœé”ä¸æ”¯æŒé‡å…¥ï¼Œåˆ™ä¼šå¯¼è‡´æ­»é”ã€‚</p>
<h3 id="å…¬å¹³é”"><a href="#å…¬å¹³é”" class="headerlink" title="å…¬å¹³é”"></a>å…¬å¹³é”</h3><p>æ‰€è°“å…¬å¹³é”ï¼Œå…¶å®å°±æ˜¯æŒ‡é”çš„ç­‰å¾…é˜Ÿåˆ—æ‰§è¡Œå…ˆè¿›å…ˆå‡ºï¼Œç­‰å¾…æœ€ä¹…çš„çº¿ç¨‹ä¼˜å…ˆè·å¾—é”ã€‚<br><strong>ä½†æ˜¯å†…ç½®é”å’ŒReentrantLocké»˜è®¤éƒ½æ˜¯éå…¬å¹³çš„ï¼Œä¸ºå•¥ï¼Ÿ</strong><br>å› ä¸ºéå…¬å¹³é”çš„æ€§èƒ½æ›´å¥½ã€‚ä¸€ä¸ªäº‹å®æ˜¯ï¼Œä¸€ä¸ªçº¿ç¨‹ä»è¢«å”¤é†’åˆ°çœŸæ­£è¿è¡Œä¸­é—´æœ‰ä¸å¯å¿½è§†çš„å»¶è¿Ÿï¼Œè¿™ä¸ªå»¶è¿Ÿæ—¶é—´å¾ˆå¯èƒ½é•¿åˆ°è¶³å¤Ÿä¸€ä¸ªè¿è¡Œä¸­çš„çº¿ç¨‹è·å–é”ï¼Œå¹¶å®Œæˆæ“ä½œï¼Œç„¶åé‡Šæ”¾é”ã€‚ä¹Ÿå³æ˜¯è¯´ï¼ŒæŠŠé”ç»™â€™ç­‰å¾…æœ€ä¹…çš„çº¿ç¨‹â€˜çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥è®©å…¶ä»–çº¿ç¨‹æ’é˜Ÿè·å–é”ï¼Œå¹¶å½’è¿˜é”ï¼Œè¿˜ä¸ä¼šå½±å“â€™ç­‰å¾…æœ€ä¹…çš„çº¿ç¨‹â€˜çš„è¿è¡Œã€‚è¿™æ ·ä¸€æ¥ååé‡å°±å¾—åˆ°äº†æå‡ã€‚</p>
<h1 id="Scalaæ —å­"><a href="#Scalaæ —å­" class="headerlink" title="Scalaæ —å­"></a>Scalaæ —å­</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.liam8.con</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.<span class="type">TimeUnit</span></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.&#123;<span class="type">Lock</span>, <span class="type">ReentrantLock</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">LockDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> rtl: <span class="type">Lock</span> = <span class="keyword">new</span> <span class="type">ReentrantLock</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> inc: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get</span></span>(): <span class="type">Int</span> = &#123;</span><br><span class="line">    rtl.lock()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      inc</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      rtl.unlock()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">addOne</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    rtl.lock()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>.sleep(<span class="number">1</span>)</span><br><span class="line">      inc = <span class="number">1</span> + get()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      rtl.unlock()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">Thread</span> &#123;</span><br><span class="line">          <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">            println(<span class="string">s&quot;run thread <span class="subst">$i</span>&quot;</span>)</span><br><span class="line">            addOne()</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;.start()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      println(<span class="string">s&quot;inc=<span class="subst">$inc</span>&quot;</span>)</span><br><span class="line">      <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>.sleep(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>output</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">run thread 3</span><br><span class="line">run thread 8</span><br><span class="line">run thread 1</span><br><span class="line">run thread 9</span><br><span class="line">run thread 7</span><br><span class="line">run thread 4</span><br><span class="line">run thread 5</span><br><span class="line">run thread 2</span><br><span class="line">run thread 10</span><br><span class="line">run thread 6</span><br><span class="line">inc=0</span><br><span class="line">inc=0</span><br><span class="line">inc=2</span><br><span class="line">inc=3</span><br><span class="line">inc=4</span><br><span class="line">inc=5</span><br><span class="line">inc=6</span><br><span class="line">inc=7</span><br><span class="line">inc=8</span><br><span class="line">inc=8</span><br><span class="line">inc=10</span><br><span class="line">inc=10</span><br><span class="line">inc=10</span><br></pre></td></tr></table></figure>

<h1 id="æœ¬æ–‡ä»£ç "><a href="#æœ¬æ–‡ä»£ç " class="headerlink" title="æœ¬æ–‡ä»£ç "></a>æœ¬æ–‡ä»£ç </h1><p><a href="https://github.com/Liam8/learn-scala">Githubä»“åº“</a></p>
<p>è½¬è½½è¯·æ³¨æ˜åŸæ–‡åœ°å€ï¼š<a href="https://liam-blog.ml/2019/07/21/Scala-Concurrency-in-Practice-2/">https://liam-blog.ml/2019/07/21/Scala-Concurrency-in-Practice-2/</a></p>
]]></content>
      <tags>
        <tag>Scala</tag>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title>Scalaå¹¶å‘ç¼–ç¨‹å®æˆ˜ 1ï¼šMonitorä¸synchronized</title>
    <url>/2019/07/14/Scala-Concurrency-in-Practice-1/</url>
    <content><![CDATA[<p>Javaå¹¶å‘ç¼–ç¨‹æœ€å¸¸ç”¨å’Œæ˜“ç”¨çš„æŠ€æœ¯è«è¿‡äºsynchronizedå…³é”®å­—ï¼Œè€ŒScalaçš„å¹¶å‘ç¼–ç¨‹ä¹‹æ—…ä¹Ÿå¯ä»¥ä»synchronizedå¼€å§‹ã€‚è€Œsynchronizedçš„èƒŒåå…¶å®æ˜¯monitoræŠ€æœ¯ã€‚</p>
<span id="more"></span>

<h1 id="ä»€ä¹ˆæ˜¯Monitor"><a href="#ä»€ä¹ˆæ˜¯Monitor" class="headerlink" title="ä»€ä¹ˆæ˜¯Monitor"></a>ä»€ä¹ˆæ˜¯Monitor</h1><p>Monitoræ˜¯è§£å†³å¹¶å‘ç¼–ç¨‹é—®é¢˜çš„ä¸€ç§å¸¸ç”¨æŠ€æœ¯ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³äº’æ–¥å’ŒåŒæ­¥ä¸¤å¤§å¸¸è§é—®é¢˜ï¼Œé€šå¸¸ç¿»è¯‘ä¸ºâ€˜ç›‘è§†å™¨â€™æˆ–â€˜ç®¡ç¨‹â€™ã€‚ä¸ªäººè®¤ä¸ºâ€˜ç®¡ç¨‹â€˜æ›´èƒ½è¡¨è¾¾monitorçš„å«ä¹‰ï¼ŒæŒ‡çš„æ˜¯ç®¡ç†å…±äº«å˜é‡ä»¥åŠå¯¹å…±äº«å˜é‡çš„æ“ä½œè¿‡ç¨‹ï¼Œè®©ä»–ä»¬æ”¯æŒå¹¶å‘ã€‚</p>
<h1 id="Scalaçš„synchronized"><a href="#Scalaçš„synchronized" class="headerlink" title="Scalaçš„synchronized"></a>Scalaçš„synchronized</h1><p>Synchronizedæ˜¯Javaå¯¹monitorçš„å®ç°ï¼Œå¯ä»¥å¯¹ä»£ç å—æˆ–æ–¹æ³•ä½¿ç”¨ï¼Œä½¿å¾—æ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œå®ç°äº†çº¿ç¨‹äº’æ–¥ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†é”ï¼Œå…¶ä»–çº¿ç¨‹å°†åœ¨é˜Ÿåˆ—ä¸Šç­‰å¾…ï¼Œå®ç°äº†çº¿ç¨‹åŒæ­¥ã€‚</p>
<p>Scalaå»¶ç”¨äº†è¿™ä¸€å…³é”®å­—ï¼Œä½†æ˜¯è¯­æ³•æœ‰æ‰€ä¸åŒã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç”¨äºä»£ç å—</span></span><br><span class="line">obj.synchronized &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”¨äºæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span></span>(): <span class="type">Unit</span> = <span class="keyword">this</span>.synchronized &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è·ŸJavaä¸€æ ·ï¼Œè¿™é‡Œçš„thisæ˜¯å¯ä»¥çœç•¥çš„ï¼Œå› ä¸ºé»˜è®¤åŠ é”çš„å¯¹è±¡å°±æ˜¯thisï¼Œä½†æ˜¯ä¸å»ºè®®çœç•¥ã€‚</p>
<h1 id="Scalaå®ä¾‹"><a href="#Scalaå®ä¾‹" class="headerlink" title="Scalaå®ä¾‹"></a>Scalaå®ä¾‹</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.<span class="type">TimeUnit</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SynchronizedDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> inc: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">addOne</span></span>(): <span class="type">Unit</span> = <span class="keyword">this</span>.synchronized &#123;</span><br><span class="line">    <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>.sleep(<span class="number">1</span>)</span><br><span class="line">    inc += <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">          println(<span class="string">s&quot;run thread with object method <span class="subst">$i</span>&quot;</span>)</span><br><span class="line">          addOne()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;.start()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> instance = <span class="keyword">new</span> <span class="type">SynchronizedDemo</span></span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">          println(<span class="string">s&quot;run thread with class method <span class="subst">$i</span>&quot;</span>)</span><br><span class="line">          instance.addOne()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;.start()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      println(<span class="string">s&quot;object inc=<span class="subst">$inc</span>, class inc=<span class="subst">$&#123;instance.inc&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>.sleep(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SynchronizedDemo</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> inc: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">addOne</span></span>(): <span class="type">Unit</span> = <span class="keyword">this</span>.synchronized &#123;</span><br><span class="line">    <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>.sleep(<span class="number">1</span>)</span><br><span class="line">    inc += <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºè¾“å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">run thread with class method 7</span><br><span class="line">run thread with class method 4</span><br><span class="line">run thread with object method 8</span><br><span class="line">run thread with object method 7</span><br><span class="line">run thread with class method 10</span><br><span class="line">run thread with class method 8</span><br><span class="line">run thread with class method 9</span><br><span class="line">run thread with object method 5</span><br><span class="line">run thread with object method 3</span><br><span class="line">run thread with object method 2</span><br><span class="line">run thread with object method 4</span><br><span class="line">run thread with object method 10</span><br><span class="line">run thread with object method 9</span><br><span class="line">run thread with class method 5</span><br><span class="line">run thread with class method 3</span><br><span class="line">object inc=0, class inc=0</span><br><span class="line">run thread with object method 1</span><br><span class="line">run thread with class method 6</span><br><span class="line">run thread with class method 1</span><br><span class="line">run thread with class method 2</span><br><span class="line">run thread with object method 6</span><br><span class="line">object inc=1, class inc=1</span><br><span class="line">object inc=2, class inc=2</span><br><span class="line">object inc=3, class inc=2</span><br><span class="line">object inc=4, class inc=4</span><br><span class="line">object inc=5, class inc=5</span><br><span class="line">object inc=6, class inc=6</span><br><span class="line">object inc=7, class inc=7</span><br><span class="line">object inc=8, class inc=8</span><br><span class="line">object inc=9, class inc=9</span><br><span class="line">object inc=10, class inc=10</span><br></pre></td></tr></table></figure>

<p><strong>è§£æ</strong></p>
<ul>
<li>åœ¨object SynchronizedDemoå’Œclass SynchronizedDemoä¸­å‡å®šä¹‰äº†ä¸€ä¸ªincå˜é‡å’Œä¸€ä¸ªaddOneæ–¹æ³•ï¼ŒaddOneæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†incåŠ 1ã€‚</li>
<li>mainæ–¹æ³•ä¸­ï¼Œåˆ†åˆ«åˆ›å»º10ä¸ªçº¿ç¨‹è°ƒç”¨addOneæ–¹æ³•ï¼Œå¯¹incè¿›è¡Œ10æ¬¡åŠ 1æ“ä½œã€‚</li>
<li>å› ä¸ºincå˜é‡ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å¯¹addOneæ–¹æ³•åŠ ä¸Šsynchronizedå…³é”®å­—ï¼Œä½¿å¾—ä¿®æ”¹æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚è¿™æ ·æ‰èƒ½ä¿è¯incä¼šä»1åŠ åˆ°10ã€‚</li>
<li>objectå’Œclassä¸­çš„thiså¹¶ä¸ç›¸åŒï¼Œobjectä¸­çš„thisæŒ‡å‘çš„æ˜¯åä¸ºSynchronizedDemoçš„objectå¯¹è±¡ï¼Œclassä¸­çš„åˆ™æ˜¯è¯¥classå®ä¾‹åŒ–åçš„å¯¹è±¡ã€‚(Scalaä¸­æ²¡æœ‰é™æ€ç±»å’Œé™æ€æ–¹æ³•ï¼Œobject SynchronizedDemoå®é™…ä¸Šæ˜¯åˆ›å»ºåä¸ºSynchronizedDemoçš„å•ä¾‹å¯¹è±¡)</li>
</ul>
<p>å¦‚æœæŠŠclassä¸­å®šä¹‰çš„addOneæ”¹æˆå¦‚ä¸‹ï¼š</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addOne</span></span>(): <span class="type">Unit</span> = <span class="type">SynchronizedDemo</span>.synchronized &#123;</span><br><span class="line">  <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>.sleep(<span class="number">1</span>)</span><br><span class="line">  inc += <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸¤å¤„å®šä¹‰çš„addOneæ–¹æ³•å°±ä¼šäº’æ–¥ï¼Œè¾“å‡ºå°±ä¼šå˜æˆå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">run thread with object method 2</span><br><span class="line">run thread with object method 1</span><br><span class="line">run thread with object method 3</span><br><span class="line">run thread with object method 4</span><br><span class="line">run thread with object method 5</span><br><span class="line">run thread with object method 6</span><br><span class="line">run thread with object method 7</span><br><span class="line">run thread with object method 8</span><br><span class="line">run thread with object method 9</span><br><span class="line">run thread with object method 10</span><br><span class="line">run thread with class method 1</span><br><span class="line">run thread with class method 2</span><br><span class="line">run thread with class method 3</span><br><span class="line">run thread with class method 4</span><br><span class="line">run thread with class method 5</span><br><span class="line">run thread with class method 6</span><br><span class="line">run thread with class method 7</span><br><span class="line">run thread with class method 8</span><br><span class="line">run thread with class method 9</span><br><span class="line">run thread with class method 10</span><br><span class="line">object inc=0, class inc=0</span><br><span class="line">object inc=1, class inc=0</span><br><span class="line">object inc=1, class inc=1</span><br><span class="line">object inc=1, class inc=2</span><br><span class="line">object inc=1, class inc=3</span><br><span class="line">object inc=1, class inc=4</span><br><span class="line">object inc=1, class inc=5</span><br><span class="line">object inc=1, class inc=6</span><br><span class="line">object inc=1, class inc=7</span><br><span class="line">object inc=1, class inc=8</span><br><span class="line">object inc=1, class inc=9</span><br><span class="line">object inc=1, class inc=10</span><br><span class="line">object inc=2, class inc=10</span><br><span class="line">object inc=3, class inc=10</span><br><span class="line">object inc=4, class inc=10</span><br><span class="line">object inc=5, class inc=10</span><br><span class="line">object inc=6, class inc=10</span><br><span class="line">object inc=7, class inc=10</span><br><span class="line">object inc=8, class inc=10</span><br><span class="line">object inc=9, class inc=10</span><br><span class="line">object inc=10, class inc=10</span><br></pre></td></tr></table></figure>

<h1 id="æœ¬æ–‡ä»£ç "><a href="#æœ¬æ–‡ä»£ç " class="headerlink" title="æœ¬æ–‡ä»£ç "></a>æœ¬æ–‡ä»£ç </h1><p><a href="https://github.com/Liam8/learn-scala">Githubä»“åº“</a></p>
<p>è½¬è½½è¯·æ³¨æ˜åŸæ–‡åœ°å€ï¼š<a href="https://liam-blog.ml/2019/07/14/Scala-Concurrency-in-Practice-1/">https://liam-blog.ml/2019/07/14/Scala-Concurrency-in-Practice-1/</a></p>
]]></content>
      <tags>
        <tag>Scala</tag>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title>Scalaå¹¶å‘ç¼–ç¨‹å®æˆ˜ 3ï¼šCondition æ¡ä»¶å˜é‡</title>
    <url>/2019/08/03/Scala-Concurrency-in-Practice-3/</url>
    <content><![CDATA[<p>åœ¨<a href="/2019/07/21/Scala-Concurrency-in-Practice-2/">Scalaå¹¶å‘ç¼–ç¨‹å®æˆ˜ï¼šLock é”</a>ä¸­æˆ‘ä»¬äº†è§£åˆ°å¦‚ä½•é€šè¿‡Lockæ¥å®ç°äº’æ–¥æ“ä½œï¼Œä½†æ˜¯è·å–é”ä¹‹åï¼Œå¦‚æœå‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼ˆå¦‚æ¶ˆè´¹ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ•°æ®æ—¶ï¼Œå‘ç°é˜Ÿåˆ—ä¸ºç©ºï¼‰ï¼Œçº¿ç¨‹è¦å¦‚ä½•ç­‰å¾…æ¡ä»¶æ»¡è¶³ï¼ˆå¦‚é˜Ÿåˆ—ä¸ä¸ºç©ºï¼‰å¹¶è®©å‡ºé”å‘¢ï¼Ÿè¿™éœ€è¦ç”¨åˆ°Conditionæ¡ä»¶å˜é‡ï¼Œåˆç§°ä½œæ¡ä»¶é˜Ÿåˆ—ã€‚</p>
<span id="more"></span>

<p>Conditionä¸JDKå†…ç½®çš„ç®¡ç¨‹çš„ç­‰å¾…é˜Ÿåˆ—åŠŸèƒ½ç±»ä¼¼ï¼Œä¸»è¦åŠŸèƒ½éƒ½æ˜¯è®©çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸Šç­‰å¾…è¢«å”¤é†’ï¼Œä½†æ˜¯å†…ç½®ç®¡ç¨‹çš„é”åªèƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„é˜Ÿåˆ—ï¼Œè€Œä¸€ä¸ªLocké”å¯ä»¥æœ‰å¤šä¸ªConditioné˜Ÿåˆ—ã€‚</p>
<p>Conditionæ¥å£çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">awaitUninterruptibly</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">long</span> <span class="title function_">awaitNanos</span><span class="params">(<span class="type">long</span> nanosTimeout)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">awaitUntil</span><span class="params">(Date deadline)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">signalAll</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Conditionçš„await,signal,signalAllæ–¹æ³•åˆ†åˆ«å¯¹åº”Objectç±»çš„wait,notify,notifyAllæ–¹æ³•ã€‚</p>
<p>ä¸‹é¢è¿™ä¸ªæ —å­å°±æ˜¯å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æœ‰ç•Œé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œè®©å…¥é˜Ÿæ“ä½œçš„çº¿ç¨‹waitï¼Œé˜Ÿåˆ—ç©ºçš„æ—¶å€™å°±è®©å‡ºé˜Ÿæ“ä½œçš„çº¿ç¨‹waitï¼Œå½“é˜Ÿåˆ—æƒ…å†µå˜åŒ–çš„æ—¶å€™ï¼Œåˆèƒ½åŠæ—¶å”¤é†’waitçŠ¶æ€çš„çº¿ç¨‹ã€‚<br>é˜Ÿåˆ—å®ç°ç±»ä¸­åˆ›å»ºäº†ä¸¤ä¸ªConditionæ¡ä»¶å˜é‡notFullå’ŒnotEmptyã€‚<br>å½“putå…ƒç´ è¿›å…¥é˜Ÿåˆ—æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™éœ€è¦ç­‰å¾…notFullæ¡ä»¶ï¼Œå³åœ¨notFullçš„ç­‰å¾…é˜Ÿåˆ—ç­‰å€™ï¼›<br>å½“ä»é˜Ÿåˆ—takeå…ƒç´ æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™éœ€è¦ç­‰å¾…notEmptyæ¡ä»¶ï¼Œå³åœ¨notEmptyçš„ç­‰å¾…é˜Ÿåˆ—ç­‰å€™ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">object</span> <span class="title">ConditionDemo</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> queue = <span class="keyword">new</span> <span class="type">BoundedBuffer</span></span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">          queue.put(<span class="string">s&quot;Item<span class="subst">$i</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;.start()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">          queue.take</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;.start()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">BoundedBuffer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">val</span> lock = <span class="keyword">new</span> <span class="type">ReentrantLock</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">val</span> notFull = lock.newCondition</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">val</span> notEmpty = lock.newCondition</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">val</span> items = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">Any</span>](<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">var</span> putptr = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> takeptr = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span></span>(x: <span class="type">Any</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      lock.lock()</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (count == items.length) &#123;</span><br><span class="line">          notFull.await()</span><br><span class="line">        &#125;</span><br><span class="line">        items(putptr) = x</span><br><span class="line">        putptr += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (putptr == items.length) &#123;</span><br><span class="line">          putptr = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        println(<span class="string">s&quot;put <span class="subst">$x</span>&quot;</span>)</span><br><span class="line">        notEmpty.signal()</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">take</span></span>: <span class="type">Any</span> = &#123;</span><br><span class="line">      lock.lock()</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">          notEmpty.await()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> x = items(takeptr)</span><br><span class="line">        takeptr += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (takeptr == items.length) &#123;</span><br><span class="line">          takeptr = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        count -= <span class="number">1</span></span><br><span class="line">        println(<span class="string">s&quot;take <span class="subst">$x</span>&quot;</span>)</span><br><span class="line">        notFull.signal()</span><br><span class="line">        x</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>output:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">put Item8</span><br><span class="line">put Item10</span><br><span class="line">put Item5</span><br><span class="line">take Item8</span><br><span class="line">put Item7</span><br><span class="line">take Item10</span><br><span class="line">put Item9</span><br><span class="line">take Item5</span><br><span class="line">put Item1</span><br><span class="line">take Item7</span><br><span class="line">put Item4</span><br><span class="line">take Item9</span><br><span class="line">put Item2</span><br><span class="line">take Item1</span><br><span class="line">put Item6</span><br><span class="line">take Item4</span><br><span class="line">put Item3</span><br><span class="line">take Item2</span><br><span class="line">take Item6</span><br><span class="line">take Item3</span><br></pre></td></tr></table></figure>

<h1 id="æœ¬æ–‡ä»£ç "><a href="#æœ¬æ–‡ä»£ç " class="headerlink" title="æœ¬æ–‡ä»£ç "></a>æœ¬æ–‡ä»£ç </h1><p><a href="https://github.com/Liam8/learn-scala">Githubä»“åº“</a></p>
]]></content>
      <tags>
        <tag>Scala</tag>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title>Scalaå¹¶å‘ç¼–ç¨‹å®æˆ˜ 4ï¼šSemaphore ä¿¡å·é‡æ¨¡å‹</title>
    <url>/2019/08/26/Scala-Concurrency-Semaphore/</url>
    <content><![CDATA[<p>Semaphoreä¿¡å·é‡æ¨¡å‹ï¼Œæ˜¯ä¸€ç§é€šè¿‡ç»´æŠ¤è®¡æ•°å™¨æ•°å€¼æ¥æ§åˆ¶å¹¶å‘æ•°é‡çš„æ¨¡å‹ï¼ŒLockå®ç°çš„äº’æ–¥é”åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®ä¸´ç•ŒåŒºï¼Œè€ŒSemaphoreå…è®¸æœ‰é™å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸´ç•ŒåŒºã€‚</p>
<p>ä»€ä¹ˆæƒ…å†µéœ€è¦å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Ÿæœ€å¸¸è§çš„éœ€æ±‚å°±æ˜¯æ± åŒ–èµ„æºï¼Œè¿æ¥æ± ã€çº¿ç¨‹æ± ã€å¯¹è±¡æ± ç­‰ç­‰ã€‚</p>
<span id="more"></span>

<p>java.util.concurren.Semaphore æ˜¯JDKä¸­çš„å®ç°ç±»ï¼Œå¸¸ç”¨æ–¹æ³•æœ‰è¿™äº›ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Semaphore</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p>æ„é€ å‡½æ•°å¯ä»¥ä¼ å…¥permitsï¼Œè®¾ç½®è®¡æ•°å™¨çš„åˆå§‹å€¼ï¼Œè¡¨ç¤ºå¯ä»¥åŒæ—¶è·å–é”çš„çº¿ç¨‹æ•°ã€‚<br>acquireå‡½æ•°ç”¨äºè·å–é”ï¼Œreleaseç›¸åã€‚</p>
<p>ä¸‹é¢åˆ©ç”¨Semaphoreå®ç°ä¸€ä¸ªå¯¹è±¡æ± ï¼Œé‡Œé¢å¯ä»¥å­˜æ”¾ä»»æ„éœ€è¦å¤ç”¨çš„å¯¹è±¡ï¼Œå¦‚æœå­˜æ”¾çš„æ˜¯è¿æ¥å¯¹è±¡ï¼Œå°±å˜æˆäº†è¿æ¥æ± ã€‚<br>ä¸‹é¢ä¾‹å­å¾€å¯¹è±¡æ± å­˜æ”¾äº†å‡ ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå†ç”¨è‹¥å¹²çº¿ç¨‹åŒæ—¶å»ç”³è¯·è¿™ä¸ªå­—ç¬¦ä¸²èµ„æºã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.liam8.con</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.<span class="type">SimpleDateFormat</span></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Date</span></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.&#123;<span class="type">ConcurrentLinkedDeque</span>, <span class="type">Semaphore</span>, <span class="type">TimeUnit</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> collection.<span class="type">JavaConversions</span>._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SemaphoreDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> pool = <span class="keyword">new</span> <span class="type">SemaphoreDemo</span>[<span class="type">String</span>](<span class="number">2</span>, <span class="type">List</span>(<span class="string">&quot;aaaa&quot;</span>, <span class="string">&quot;bbbbb&quot;</span>))</span><br><span class="line">    <span class="keyword">val</span> formatDate = (date: <span class="type">Date</span>) =&gt; <span class="keyword">new</span> <span class="type">SimpleDateFormat</span>(<span class="string">&quot;HH:mm:ss.SSS&quot;</span>).format(date)</span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">          pool.exec &#123; e =&gt;</span><br><span class="line">            println(<span class="string">s&quot;<span class="subst">$&#123;formatDate(new Date)&#125;</span> thread <span class="subst">$i</span> using <span class="subst">$e</span>&quot;</span>)</span><br><span class="line">            <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>.sleep(<span class="number">3</span>)</span><br><span class="line">            println(<span class="string">s&quot;<span class="subst">$&#123;formatDate(new Date)&#125;</span> thread <span class="subst">$i</span> done with <span class="subst">$e</span>&quot;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;.start()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SemaphoreDemo</span>[<span class="type">T</span>](<span class="params">size: <span class="type">Int</span>, items: <span class="type">List</span>[<span class="type">T</span>]</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> pool: <span class="type">ConcurrentLinkedDeque</span>[<span class="type">T</span>] = <span class="keyword">new</span> <span class="type">ConcurrentLinkedDeque</span>[<span class="type">T</span>](items)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> semaphore: <span class="type">Semaphore</span> = <span class="keyword">new</span> <span class="type">Semaphore</span>(size)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">exec</span></span>(func: <span class="type">T</span> =&gt; <span class="type">Unit</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    semaphore.acquire()</span><br><span class="line">    <span class="keyword">val</span> t = pool.pop()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      func(t)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      pool.add(t)</span><br><span class="line">      semaphore.release()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>output</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">09:56:52.313 thread 4 using bbbbb</span><br><span class="line">09:56:52.313 thread 2 using aaaa</span><br><span class="line">09:56:55.351 thread 2 done with aaaa</span><br><span class="line">09:56:55.351 thread 4 done with bbbbb</span><br><span class="line">09:56:55.352 thread 1 using aaaa</span><br><span class="line">09:56:55.352 thread 3 using bbbbb</span><br><span class="line">09:56:58.353 thread 1 done with aaaa</span><br><span class="line">09:56:58.353 thread 3 done with bbbbb</span><br><span class="line">09:56:58.353 thread 5 using bbbbb</span><br><span class="line">09:56:58.353 thread 6 using aaaa</span><br><span class="line">09:57:01.354 thread 6 done with aaaa</span><br><span class="line">09:57:01.354 thread 5 done with bbbbb</span><br><span class="line">09:57:01.355 thread 7 using aaaa</span><br><span class="line">09:57:01.355 thread 8 using bbbbb</span><br><span class="line">09:57:04.359 thread 7 done with aaaa</span><br><span class="line">09:57:04.359 thread 8 done with bbbbb</span><br><span class="line">09:57:04.360 thread 9 using aaaa</span><br><span class="line">09:57:04.360 thread 10 using bbbbb</span><br><span class="line">09:57:07.363 thread 9 done with aaaa</span><br><span class="line">09:57:07.363 thread 10 done with bbbbb</span><br></pre></td></tr></table></figure>

<h1 id="æœ¬æ–‡ä»£ç "><a href="#æœ¬æ–‡ä»£ç " class="headerlink" title="æœ¬æ–‡ä»£ç "></a>æœ¬æ–‡ä»£ç </h1><p><a href="https://github.com/Liam8/learn-scala">Githubä»“åº“</a></p>
]]></content>
      <tags>
        <tag>Scala</tag>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title>Scalaå¹¶å‘ç¼–ç¨‹å®æˆ˜ 5ï¼šExecutorçº¿ç¨‹æ± </title>
    <url>/2019/09/22/Scala-Concurrency-Executor/</url>
    <content><![CDATA[<p>åˆ›å»ºçº¿ç¨‹æ˜¯ä¸€ä¸ªé‡é‡çº§æ“ä½œï¼Œå› ä¸ºéœ€è¦è°ƒç”¨æ“ä½œç³»ç»Ÿå†…æ ¸çš„APIï¼Œæ‰€ä»¥æœ€å¥½ä¸è¦é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œä¸ºäº†èƒ½å¤Ÿå¤ç”¨åˆ›å»ºçš„çº¿ç¨‹ï¼Œå¸¸ç”¨çš„åŠæ³•çš„å°±æ˜¯åˆ›å»ºçº¿ç¨‹æ± ã€‚</p>
<span id="more"></span>

<h1 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h1><p>java.util.concurrenåŒ…ä¸­æä¾›äº†è‹¥å¹²æ¥å£å’Œç±»æ¥å®ç°çº¿ç¨‹æ± ï¼Œæœ€å¸¸ç”¨çš„æœ‰Executorï¼ŒExecutorServiceï¼ŒThreadPoolExecutorã€‚</p>
<p>Executoræ¥å£å¾ˆç®€å•å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ¥å£çš„ç›®çš„åœ¨äºå°†ä»»åŠ¡ä¸æ‰§è¡Œæœºåˆ¶è§£è€¦ï¼Œä½¿å¾—ç”¨æˆ·ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹ï¼Œåªè¦äº¤ç»™Executorå°±è¡Œäº†ã€‚</p>
<h1 id="ExecutorService"><a href="#ExecutorService" class="headerlink" title="ExecutorService"></a>ExecutorService</h1><p>ExecutorServiceæ¥å£åˆ™æ‰©å±•äº†Executoræ¥å£ï¼Œå¢åŠ äº†è‹¥å¹²å®ç”¨çš„æ–¹æ³•ï¼Œæœ€å¸¸ç”¨çš„ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//æäº¤Callableä»»åŠ¡ä»¥è·å–è¿”å›å€¼</span></span><br><span class="line">&lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span>;</span><br></pre></td></tr></table></figure>

<p>AbstractExecutorServiceæŠ½è±¡ç±»æ˜¯ExecutorServiceçš„å®ç°ï¼Œå®ç°äº†è‹¥å¹²æ¨¡æ¿æ–¹æ³•ã€‚</p>
<p>æœ€é‡è¦çš„ç±»è«è¿‡äºThreadPoolExecutorï¼Œå®ƒæ˜¯æœ€æœ€å¸¸ç”¨çš„ExecutorServiceå®ç°ç±»ï¼Œä¸‹é¢é‡ç‚¹è¯´è¯´ã€‚</p>
<h1 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h1><p>ThreadPoolExecutoråœ¨æ„é€ æ—¶å¯ä»¥æŒ‡å®šçš„å‚æ•°æœ€å¤šæœ‰7ä¸ªï¼Œå¦å¤–è¿˜æœ‰3ä¸ªä½¿ç”¨ä¸€äº›é»˜è®¤å‚æ•°çš„ç®€åŒ–ç‰ˆæœ¬ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                          TimeUnit unit,</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>corePoolSize æ˜¯ä¿ç•™çš„æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³ä½¿çº¿ç¨‹å¤„äºç©ºé—²ä¹Ÿä¸ä¼šè¢«å›æ”¶ï¼Œé™¤éè®¾ç½®äº†allowCoreThreadTimeOutå±æ€§ã€‚</li>
<li>maximumPoolSize æœ€å¤§çº¿ç¨‹æ•°ã€‚å½“workQueueæ»¡äº†ï¼Œä¼šç»™æ–°æäº¤çš„ä»»åŠ¡åˆ›å»ºæ–°çº¿ç¨‹ï¼Œè¿™ç§æƒ…å†µä¸‹çº¿ç¨‹æ•°ä¼šè¶…è¿‡corePoolSizeï¼Œä½†æ•´ä¸ªçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°å¿…é¡»æœ‰ä¸ªä¸Šé™ï¼Œå°±æ˜¯maximumPoolSizeäº†ã€‚</li>
<li>keepAliveTime å›æ”¶çº¿ç¨‹å‰ï¼Œå…è®¸ä¿ç•™ç©ºé—²çº¿ç¨‹çš„æ—¶é•¿ã€‚</li>
<li>workQueue å­˜å‚¨æäº¤çš„ä»»åŠ¡çš„é˜Ÿåˆ—</li>
<li>threadFactory åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ç±»(ThreadFactoryè¿™ä¸ªæ¥å£å°±å®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•<code>Thread newThread(Runnable r);</code>)</li>
<li>handler handlerç”¨äºæ²¡æœ‰å¯ç”¨çº¿ç¨‹ï¼ˆçº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§å€¼ï¼Œæ²¡æœ‰ç©ºé—²çº¿ç¨‹ï¼‰ä¸”workQueueé˜Ÿåˆ—æ»¡äº†çš„æ—¶å€™ã€‚</li>
</ul>
<blockquote>
<p>ThreadPoolExecutor å·²ç»æä¾›äº†ä»¥ä¸‹ 4 ç§ç­–ç•¥ã€‚<br>CallerRunsPolicyï¼šæäº¤ä»»åŠ¡çš„çº¿ç¨‹è‡ªå·±å»æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚<br>AbortPolicyï¼šé»˜è®¤çš„æ‹’ç»ç­–ç•¥ï¼Œä¼š throws RejectedExecutionExceptionã€‚<br>DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œæ²¡æœ‰ä»»ä½•å¼‚å¸¸æŠ›å‡ºã€‚<br>DiscardOldestPolicyï¼šä¸¢å¼ƒæœ€è€çš„ä»»åŠ¡ï¼Œå…¶å®å°±æ˜¯æŠŠæœ€æ—©è¿›å…¥å·¥ä½œé˜Ÿåˆ—çš„ä»»åŠ¡ä¸¢å¼ƒï¼Œç„¶åæŠŠæ–°ä»»åŠ¡åŠ å…¥åˆ°å·¥ä½œé˜Ÿåˆ—ã€‚</p>
</blockquote>
<p>ThreadPoolExecutoryçš„æ„é€ å‡½æ•°ä¸€å…±æœ‰å››ç§ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥çœç•¥threadFactoryå’Œhandlerä¸­çš„ä¸€ä¸ªæˆ–ä¸¤ä¸ªã€‚</p>
<p><em>éœ€è¦æ³¨æ„çš„æƒ…å†µ</em><br>å½“maximumPoolSize&gt;corePoolSizeæ—¶ï¼Œå¦‚æœworkQueueæ»¡äº†ï¼Œæ–°æäº¤çš„ä»»åŠ¡ä¼šè¢«æ–°çº¿ç¨‹é©¬ä¸Šæ‰§è¡Œï¼Œè€Œä¹‹å‰æäº¤çš„åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„é˜Ÿåˆ—åˆ™ç»§ç»­ç­‰å¾…ã€‚<br>ä¹Ÿå°±æ˜¯è¯´åæäº¤çš„ä»»åŠ¡å¯èƒ½å…ˆæ‰§è¡Œäº†ã€‚<br>å½“æ–°çº¿ç¨‹æ‰§è¡Œå®Œæ–°æäº¤çš„è¿™ä¸ªä»»åŠ¡åï¼Œä¼šè½¬å»æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œè¿™æ—¶æ¶ˆè´¹ä»»åŠ¡é˜Ÿåˆ—çš„çº¿ç¨‹æ•°å¯èƒ½ä¼šå¤§äºcorePoolSizeï¼Œæ¶ˆè´¹é€Ÿåº¦åŠ å¿«äº†ã€‚<br>ä¸‹é¢åšä¸ªå®éªŒã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.liam8.con</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.&#123;<span class="type">ArrayBlockingQueue</span>, <span class="type">Callable</span>, <span class="type">Future</span>, <span class="type">RejectedExecutionException</span>, <span class="type">ThreadPoolExecutor</span>, <span class="type">TimeUnit</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ExecutorDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// corePoolSize=1,maximumPoolSize=2,queue capacity=1</span></span><br><span class="line">    <span class="keyword">val</span> executor = <span class="keyword">new</span> <span class="type">ThreadPoolExecutor</span>(</span><br><span class="line">      <span class="number">1</span>,</span><br><span class="line">      <span class="number">2</span>,</span><br><span class="line">      <span class="number">10</span>,</span><br><span class="line">      <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>,</span><br><span class="line">      <span class="keyword">new</span> <span class="type">ArrayBlockingQueue</span>[<span class="type">Runnable</span>](<span class="number">1</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">val</span> task1 = <span class="keyword">new</span> <span class="type">Runnable</span> &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">        println(<span class="string">&quot;task1 running&quot;</span>)</span><br><span class="line">        <span class="type">Thread</span>.sleep(<span class="number">3000</span>)</span><br><span class="line">        println(<span class="string">&quot;task1 complete&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> task2 = <span class="keyword">new</span> <span class="type">Runnable</span> &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">        println(<span class="string">&quot;task2 running&quot;</span>)</span><br><span class="line">        <span class="type">Thread</span>.sleep(<span class="number">3000</span>)</span><br><span class="line">        println(<span class="string">&quot;task2 complete&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> task3 = <span class="keyword">new</span> <span class="type">Callable</span>[<span class="type">String</span>] &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">call</span></span>(): <span class="type">String</span> = &#123;</span><br><span class="line">        println(<span class="string">&quot;task3 running&quot;</span>)</span><br><span class="line">        <span class="type">Thread</span>.sleep(<span class="number">3000</span>)</span><br><span class="line">        println(<span class="string">&quot;task3 complete&quot;</span>)</span><br><span class="line">        <span class="string">&quot;xxx&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> task4 = <span class="keyword">new</span> <span class="type">Runnable</span> &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">        println(<span class="string">&quot;task4 running&quot;</span>)</span><br><span class="line">        <span class="type">Thread</span>.sleep(<span class="number">3000</span>)</span><br><span class="line">        println(<span class="string">&quot;task4 complete&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> task2Result: <span class="type">Future</span>[<span class="type">String</span>] = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> taskCount = <span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor.execute(task1)</span><br><span class="line">      println(<span class="string">&quot;task1 submitted&quot;</span>)</span><br><span class="line">      taskCount += <span class="number">1</span></span><br><span class="line">      executor.execute(task2)</span><br><span class="line">      println(<span class="string">&quot;task2 submitted&quot;</span>)</span><br><span class="line">      taskCount += <span class="number">1</span></span><br><span class="line">      task2Result = executor.submit(task3)</span><br><span class="line">      println(<span class="string">&quot;task3 submitted&quot;</span>)</span><br><span class="line">      taskCount += <span class="number">1</span></span><br><span class="line">      executor.execute(task4)</span><br><span class="line">      println(<span class="string">&quot;task4 submitted&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> e: <span class="type">RejectedExecutionException</span> =&gt; println(<span class="string">s&quot;task <span class="subst">$taskCount</span> be rejected&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// èµ·ä¸€ä¸ªçº¿ç¨‹è·Ÿè¸ªçº¿ç¨‹æ± å¤§å°</span></span><br><span class="line">    <span class="keyword">val</span> th = <span class="keyword">new</span> <span class="type">Thread</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> threadNum = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> =</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (executor.getPoolSize != threadNum) &#123;</span><br><span class="line">            threadNum = executor.getPoolSize</span><br><span class="line">            println(<span class="string">&quot;pool size:&quot;</span> + threadNum)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="type">Thread</span>.sleep(<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    th.setDaemon(<span class="literal">true</span>)</span><br><span class="line">    th.start()</span><br><span class="line">    <span class="keyword">if</span> (task2Result != <span class="literal">null</span>) &#123;</span><br><span class="line">      println(task2Result.get(<span class="number">7</span>, <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Thread</span>.sleep(<span class="number">5000</span>)</span><br><span class="line">    executor.shutdown()</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>output</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">task1 running</span><br><span class="line">task1 submitted</span><br><span class="line">task2 submitted</span><br><span class="line">task3 submitted</span><br><span class="line">task3 running  //task3åœ¨task2ä¹‹å‰è¿è¡Œäº†ï¼</span><br><span class="line">task 4 be rejected // çº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§å€¼ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œtask4è¢«æ‹’ç»(é»˜è®¤çš„handler)</span><br><span class="line">pool size:2</span><br><span class="line">task1 complete</span><br><span class="line">task3 complete</span><br><span class="line">xxx</span><br><span class="line">task2 running // ç©ºé—²çš„çº¿ç¨‹å¼€å§‹æ¶ˆè´¹é˜Ÿåˆ—</span><br><span class="line">task2 complete</span><br><span class="line">pool size:0</span><br></pre></td></tr></table></figure>

<h1 id="Executors"><a href="#Executors" class="headerlink" title="Executors"></a>Executors</h1><p>Executorsæ˜¯JUCåŒ…ä¸­çš„ä¸€ä¸ªé™æ€å·¥å‚ç±»ï¼Œå…¶ä¸­é™¤äº†newFixedThreadPoolï¼ŒnewSingleThreadExecutoræ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•éƒ½ä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºå…¶ä»–æ–¹æ³•åˆ›å»ºçš„çº¿ç¨‹æ± ä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œå¯èƒ½ä¼šå ç”¨è¿‡å¤šå†…å­˜ï¼Œç”šè‡³OOMï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ã€‚</p>
<h1 id="ExecutionContext"><a href="#ExecutionContext" class="headerlink" title="ExecutionContext"></a>ExecutionContext</h1><p>Scalaå¦å¤–æä¾›äº†ExecutionContextå’ŒFutureæ¥ç®€åŒ–çº¿ç¨‹æ± çš„ä½¿ç”¨ï¼ŒFutureå¯ä»¥æ¥å—ä¸€ä¸ªExecutionContextç±»å‹çš„éšå¼å‚æ•°ï¼Œå°†ä¼ å…¥çš„å‡½æ•°æäº¤åˆ°ExecutionContextçš„çº¿ç¨‹æ± ä¸­è¿è¡Œã€‚<br>ä¸‹é¢ä¸¾ä¸ªæ —å­ï¼Œä¸åšæ·±å…¥æ¢è®¨ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.liam8.con</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.<span class="type">Executors</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.concurrent.&#123;<span class="type">Await</span>, <span class="type">ExecutionContext</span>, <span class="type">ExecutionContextExecutorService</span>, <span class="type">Future</span>&#125;</span><br><span class="line"><span class="keyword">import</span> scala.concurrent.duration._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ExecutionContextDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> pool = <span class="type">Executors</span>.newFixedThreadPool(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">implicit</span> <span class="keyword">val</span> ec: <span class="type">ExecutionContextExecutorService</span> = <span class="type">ExecutionContext</span>.fromExecutorService(pool)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> f = <span class="type">Future</span> &#123;</span><br><span class="line">      <span class="keyword">val</span> t = <span class="type">Thread</span>.currentThread().getName</span><br><span class="line">      println(<span class="string">s&quot;<span class="subst">$t</span>: future is coming&quot;</span>)</span><br><span class="line">      <span class="number">123</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> re = f.map(r =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> t = <span class="type">Thread</span>.currentThread().getName</span><br><span class="line">      println(<span class="string">s&quot;<span class="subst">$t</span>: mapping&quot;</span>)</span><br><span class="line">      r * r</span><br><span class="line">    &#125;)</span><br><span class="line">    re.onSuccess &#123; <span class="keyword">case</span> x: <span class="type">Int</span> =&gt; println(x) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Await</span>.result(f, <span class="number">3.</span>seconds)</span><br><span class="line">    ec.shutdown()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>output </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pool-1-thread-1: future is coming</span><br><span class="line">pool-1-thread-2: mapping</span><br><span class="line">15129</span><br></pre></td></tr></table></figure>

<h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p><a href="https://time.geekbang.org/column/article/90771">Executorä¸çº¿ç¨‹æ± ï¼šå¦‚ä½•åˆ›å»ºæ­£ç¡®çš„çº¿ç¨‹æ± ï¼Ÿ</a></p>
<p><a href="https://www.freecodecamp.org/news/futures-made-easy-with-scala-da1beb3bb281/">Futures Made Easy with Scala</a></p>
<h1 id="æœ¬æ–‡ä»£ç "><a href="#æœ¬æ–‡ä»£ç " class="headerlink" title="æœ¬æ–‡ä»£ç "></a>æœ¬æ–‡ä»£ç </h1><p><a href="https://github.com/Liam8/learn-scala">Githubä»“åº“</a></p>
<p>è½¬è½½è¯·æ³¨æ˜åŸæ–‡åœ°å€ï¼š<a href="https://liam-blog.ml/2019/09/22/Scala-Concurrency-Executor/">https://liam-blog.ml/2019/09/22/Scala-Concurrency-Executor/</a></p>
]]></content>
      <tags>
        <tag>Scala</tag>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title>Scala implicit éšå¼è½¬æ¢å®‰å…¨é©¾é©¶æŒ‡å—</title>
    <url>/2019/09/28/scala-implicit/</url>
    <content><![CDATA[<p>è¿™ç¯‡çŸ­æ–‡å°†ç»“åˆå®ä¾‹å¯¹éšå¼è½¬æ¢çš„å„ç§åœºæ™¯è¿›è¡Œè§£é‡Šå’Œæ€»ç»“ï¼Œå¸Œæœ›çœ‹å®Œçš„äººèƒ½å¤Ÿå®‰å…¨é©¶è¿‡éšå¼è½¬æ¢è¿™ä¸ªå¤§å‘ã€‚</p>
<span id="more"></span>

<h1 id="éšå¼è½¬æ¢å‡½æ•°"><a href="#éšå¼è½¬æ¢å‡½æ•°" class="headerlink" title="éšå¼è½¬æ¢å‡½æ•°"></a>éšå¼è½¬æ¢å‡½æ•°</h1><p>éšå¼è½¬æ¢å‡½æ•°æœ‰ä¸¤ç§ä½œç”¨åœºæ™¯ã€‚</p>
<ul>
<li>1 è½¬æ¢ä¸ºæœŸæœ›ç±»å‹ï¼šå°±æ˜¯æŒ‡ä¸€æ—¦ç¼–è¯‘å™¨çœ‹åˆ°Xï¼Œä½†éœ€è¦Yï¼Œå°±ä¼šæ£€æŸ¥ä»Xåˆ°Yçš„éšå¼è½¬æ¢å‡½æ•°ã€‚</li>
<li>2 è½¬æ¢æ–¹æ³•çš„è°ƒç”¨è€…ï¼šç®€å•æ¥è¯´ï¼Œå¦‚obj.f()ï¼Œå¦‚æœobjå¯¹è±¡æ²¡æœ‰fæ–¹æ³•ï¼Œåˆ™å°è¯•å°†objè½¬æ¢ä¸ºæ‹¥æœ‰fæ–¹æ³•çš„ç±»å‹ã€‚</li>
</ul>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ImpFunction</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Dog</span>(<span class="params">val name: <span class="type">String</span></span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bark</span></span>(): <span class="type">Unit</span> = println(<span class="string">s&quot;<span class="subst">$name</span> say: Wang !&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">double2int</span></span>(d: <span class="type">Double</span>): <span class="type">Int</span> = d.toInt</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">string2Dog</span></span>(s: <span class="type">String</span>): <span class="type">Dog</span> = <span class="keyword">new</span> <span class="type">Dog</span>(s)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> f: <span class="type">Int</span> = <span class="number">1.1</span> <span class="comment">//è½¬æ¢ä¸ºæœŸæœ›ç±»å‹,1.1é€šè¿‡double2intè½¬æˆäº†Intç±»å‹</span></span><br><span class="line"></span><br><span class="line">  println(f)</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;Teddy&quot;</span>.bark() <span class="comment">// è½¬æ¢æ–¹æ³•çš„è°ƒç”¨è€…,å­—ç¬¦ä¸²é€šè¿‡string2Dogè½¬æˆäº†Dog, äºæ˜¯æœ‰äº†barkæ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// Teddy say: Wang !</span></span><br></pre></td></tr></table></figure>

<p><code>val f: Int = 1.1</code> å› ä¸ºç±»å‹ä¸åŒ¹é…ï¼Œè¿™æ®µæœ¬æ¥æ˜¯æ— æ³•é€šè¿‡ç¼–è¯‘çš„ï¼Œä½†æ˜¯ç¼–è¯‘å™¨å‘ç°å­˜åœ¨ä¸€ä¸ªDoubleè‡³Intçš„éšå¼è½¬æ¢å‡½æ•°ï¼Œæ‰€ä»¥è¿›è¡Œäº†éšå¼è½¬æ¢ã€‚</p>
<p><code>&quot;Teddy&quot;.bark()</code> Stringç±»å‹æœ¬æ¥æ˜¯æ²¡æœ‰barkæ–¹æ³•çš„ï¼Œä½†æ˜¯ç¼–è¯‘å™¨å‘ç°äº†éšå¼è½¬æ¢string2Dogå¯ä»¥ä½¿å¾—Stringè½¬æˆä¸€ç§æ‹¥æœ‰barkæ–¹æ³•çš„ç±»å‹ï¼Œç›¸å½“äºè¿›è¡Œäº†è¿™æ ·çš„è½¬æ¢ï¼š<code>string2Dog(&quot;Teddy&quot;).bark()</code>ã€‚</p>
<h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¼–è¯‘å™¨åªå…³å¿ƒéšå¼è½¬æ¢å‡½æ•°çš„è¾“å…¥è¾“å‡ºç±»å‹ï¼Œä¸å…³å¿ƒå‡½æ•°åï¼Œä¸ºé¿å…æ­§ä¹‰ï¼ŒåŒä¸€ä¸ªä½œç”¨åŸŸä¸­ä¸èƒ½æœ‰è¾“å…¥è¾“å‡ºç±»å‹ç›¸åŒçš„ä¸¤ä¸ªéšå¼è½¬æ¢å‡½æ•°ï¼Œä¸ç„¶ç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚</p>
<h1 id="éšå¼ç±»"><a href="#éšå¼ç±»" class="headerlink" title="éšå¼ç±»"></a>éšå¼ç±»</h1><p>Scala 2.10å¼•å…¥äº†ä¸€ç§å«åšéšå¼ç±»çš„æ–°ç‰¹æ€§ã€‚éšå¼ç±»æŒ‡çš„æ˜¯ç”¨implicitå…³é”®å­—ä¿®é¥°çš„ç±»ã€‚ä½¿ç”¨æƒ…å†µä¸éšå¼è½¬æ¢å‡½æ•°ç±»ä¼¼ï¼Œ<strong>å¯ä»¥çœ‹åšå°†ç±»çš„æ„é€ å‡½æ•°å®šä¹‰ä¸ºéšå¼è½¬æ¢å‡½æ•°</strong>ï¼Œè¿”å›ç±»å‹å°±æ˜¯è¿™ä¸ªç±»ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.liam8.impl</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ImpClass</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span>(<span class="params">val name: <span class="type">String</span></span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bark</span></span>(): <span class="type">Unit</span> = println(<span class="string">s&quot;<span class="subst">$name</span> say: Wang !&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;Teddy&quot;</span>.bark()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="æ³¨æ„äº‹é¡¹-1"><a href="#æ³¨æ„äº‹é¡¹-1" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p><em>è¿™æ®µæ¥è‡ªå®˜ç½‘<a href="https://docs.scala-lang.org/zh-cn/overviews/core/implicit-classes.html">IMPLICIT CLASSES</a></em><br>éšå¼ç±»æœ‰ä»¥ä¸‹é™åˆ¶æ¡ä»¶ï¼š</p>
<ul>
<li><p>1 åªèƒ½åœ¨åˆ«çš„trait&#x2F;ç±»&#x2F;å¯¹è±¡å†…éƒ¨å®šä¹‰ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Helpers</span> </span>&#123;</span><br><span class="line">   <span class="keyword">implicit</span> <span class="class"><span class="keyword">class</span> <span class="title">RichInt</span>(<span class="params">x: <span class="type">Int</span></span>) <span class="comment">// æ­£ç¡®ï¼</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">implicit</span> <span class="class"><span class="keyword">class</span> <span class="title">RichDouble</span>(<span class="params">x: <span class="type">Double</span></span>) <span class="comment">// é”™è¯¯ï¼</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>2 æ„é€ å‡½æ•°åªèƒ½æºå¸¦ä¸€ä¸ªééšå¼å‚æ•°ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">implicit</span> <span class="class"><span class="keyword">class</span> <span class="title">RichDate</span>(<span class="params">date: java.util.<span class="type">Date</span></span>) <span class="comment">// æ­£ç¡®ï¼</span></span></span><br><span class="line"><span class="keyword">implicit</span> <span class="class"><span class="keyword">class</span> <span class="title">Indexer</span>[<span class="type">T</span>](<span class="params">collecton: <span class="type">Seq</span>[<span class="type">T</span>], index: <span class="type">Int</span></span>) <span class="comment">// é”™è¯¯ï¼</span></span></span><br><span class="line"><span class="keyword">implicit</span> <span class="class"><span class="keyword">class</span> <span class="title">Indexer</span>[<span class="type">T</span>](<span class="params">collecton: <span class="type">Seq</span>[<span class="type">T</span>]</span>)(<span class="params">implicit index: <span class="type">Index</span></span>) <span class="comment">// æ­£ç¡®ï¼</span></span></span><br></pre></td></tr></table></figure>
<p>è™½ç„¶æˆ‘ä»¬å¯ä»¥åˆ›å»ºå¸¦æœ‰å¤šä¸ªééšå¼å‚æ•°çš„éšå¼ç±»ï¼Œä½†è¿™äº›ç±»æ— æ³•ç”¨äºéšå¼è½¬æ¢ã€‚</p>
</li>
<li><p>3 åœ¨åŒä¸€ä½œç”¨åŸŸå†…ï¼Œä¸èƒ½æœ‰ä»»ä½•æ–¹æ³•ã€æˆå‘˜æˆ–å¯¹è±¡ä¸éšå¼ç±»åŒåã€‚<br>æ³¨æ„ï¼šè¿™æ„å‘³ç€éšå¼ç±»ä¸èƒ½æ˜¯case classã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Bar</span></span></span><br><span class="line"><span class="keyword">implicit</span> <span class="class"><span class="keyword">class</span> <span class="title">Bar</span>(<span class="params">x: <span class="type">Int</span></span>) <span class="comment">// é”™è¯¯ï¼</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> x = <span class="number">5</span></span><br><span class="line"><span class="keyword">implicit</span> <span class="class"><span class="keyword">class</span> <span class="title">x</span>(<span class="params">y: <span class="type">Int</span></span>) <span class="comment">// é”™è¯¯ï¼</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Baz</span>(<span class="params">x: <span class="type">Int</span></span>) <span class="comment">// é”™è¯¯ï¼</span></span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="éšå¼å‚æ•°-amp-éšå¼å€¼"><a href="#éšå¼å‚æ•°-amp-éšå¼å€¼" class="headerlink" title="éšå¼å‚æ•° &amp; éšå¼å€¼"></a>éšå¼å‚æ•° &amp; éšå¼å€¼</h1><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.liam8.impl</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ImpParam</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">bark</span></span>(<span class="keyword">implicit</span> name: <span class="type">String</span>): <span class="type">Unit</span> = println(<span class="string">s&quot;<span class="subst">$name</span> say: Wang !&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> t: <span class="type">String</span> = <span class="string">&quot;Hot Dog&quot;</span></span><br><span class="line"></span><br><span class="line">  bark</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‚æ•°åŠ ä¸Šimplicitå°±æˆäº†éšå¼å‚æ•°ï¼Œéœ€è¦ä¸éšå¼å€¼(å˜é‡å®šä¹‰åŠ ä¸Šimplicit)æ­é…ä½¿ç”¨ï¼Œæœ€åä¸€è¡Œçš„<code>bark</code>ç¼ºå°‘äº†ä¸€ä¸ªStringç±»å‹çš„å‚æ•°ï¼Œç¼–è¯‘å™¨æ‰¾åˆ°äº†Stringç±»å‹çš„éšå¼å€¼ï¼Œä¾¿å°†å…¶ä¼ å…¥ï¼Œç›¸å½“äºæ‰§è¡Œäº†<code>bark(t)</code>ã€‚</p>
<p>implicitå…³é”®å­—ä¼šä½œç”¨äºå‡½æ•°åˆ—è¡¨ä¸­çš„çš„æ‰€æœ‰å‚æ•°ï¼Œå¦‚<code>def test(implicitÂ x:Int, y: Double)</code>è¿™æ ·å®šä¹‰å‡½æ•°ï¼Œxå’Œyå°±éƒ½æˆäº†éšå¼å‡½æ•°ã€‚ä½†æ˜¯é€šå¸¸æˆ‘ä»¬åªå¸Œæœ›éƒ¨åˆ†å‚æ•°ä¸ºéšå¼å‚æ•°ï¼Œå°±å¥½æ¯”é€šå¸¸ä¼šç»™éƒ¨åˆ†å‚æ•°æä¾›é»˜è®¤å€¼è€Œä¸æ˜¯å…¨éƒ¨éƒ½æŒ‡å®šé»˜è®¤å€¼ï¼Œäºæ˜¯éšå¼å‚æ•°å¸¸å¸¸ä¸æŸ¯é‡ŒåŒ–å‡½æ•°ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—åªæœ‰æœ€åä¸€ä¸ªå‚æ•°ä¸ºéšå¼å‚æ•°ï¼Œä¾‹å¦‚<code>def test(x: Int)(implicit y: Double)</code>ã€‚</p>
<p>ğŸ‘‡æ˜¯å®Œæ•´çš„ä¾‹å­ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ImpParamWithCurry</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">bark</span></span>(name: <span class="type">String</span>)(<span class="keyword">implicit</span> word: <span class="type">String</span>): <span class="type">Unit</span> = println(<span class="string">s&quot;<span class="subst">$name</span> say: <span class="subst">$word</span> !&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> w: <span class="type">String</span> = <span class="string">&quot;Wang&quot;</span></span><br><span class="line"></span><br><span class="line">  bark(<span class="string">&quot;Hot Dog&quot;</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="æ³¨æ„äº‹é¡¹-2"><a href="#æ³¨æ„äº‹é¡¹-2" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p><em>ä¸‹é¢è¿™æ®µæ¥è‡ª<a href="https://blog.csdn.net/m0_37138008/article/details/78120210">scalaçš„éšå¼è½¬æ¢å­¦ä¹ æ€»ç»“ï¼ˆè¯¦ç»†ï¼‰</a></em></p>
<ul>
<li>1ï¼‰å½“å‡½æ•°æ²¡æœ‰æŸ¯é‡ŒåŒ–æ—¶ï¼Œimplicitå…³é”®å­—ä¼šä½œç”¨äºå‡½æ•°åˆ—è¡¨ä¸­çš„çš„æ‰€æœ‰å‚æ•°ã€‚</li>
<li>2ï¼‰éšå¼å‚æ•°ä½¿ç”¨æ—¶è¦ä¹ˆå…¨éƒ¨ä¸æŒ‡å®šï¼Œè¦ä¹ˆå…¨ä¸æŒ‡å®šï¼Œä¸èƒ½åªæŒ‡å®šéƒ¨åˆ†ã€‚</li>
<li>3ï¼‰åŒç±»å‹çš„éšå¼å€¼åªèƒ½åœ¨ä½œç”¨åŸŸå†…å‡ºç°ä¸€æ¬¡ï¼Œå³ä¸èƒ½åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸­å®šä¹‰å¤šä¸ªç›¸åŒç±»å‹çš„éšå¼å€¼ã€‚</li>
<li>4ï¼‰åœ¨æŒ‡å®šéšå¼å‚æ•°æ—¶ï¼Œimplicit å…³é”®å­—åªèƒ½å‡ºç°åœ¨å‚æ•°å¼€å¤´ã€‚</li>
<li>5ï¼‰å¦‚æœæƒ³è¦å®ç°å‚æ•°çš„éƒ¨åˆ†éšå¼å‚æ•°ï¼Œåªèƒ½ä½¿ç”¨å‡½æ•°çš„æŸ¯é‡ŒåŒ–ï¼Œ<br>Â Â Â Â Â Â Â Â Â  å¦‚è¦å®ç°è¿™ç§å½¢å¼çš„å‡½æ•°ï¼Œdef test(x:Int, implicitÂ  y: Double)çš„å½¢å¼ï¼Œå¿…é¡»ä½¿ç”¨æŸ¯é‡ŒåŒ–å®ç°ï¼šdef test(x: Int)(implicit y: Double).</li>
<li>6ï¼‰æŸ¯é‡ŒåŒ–çš„å‡½æ•°ï¼Œ implicit å…³é”®å­—åªèƒ½ä½œç”¨äºæœ€åä¸€ä¸ªå‚æ•°ã€‚å¦åˆ™ï¼Œä¸åˆæ³•ã€‚</li>
<li>7ï¼‰implicit å…³é”®å­—åœ¨éšå¼å‚æ•°ä¸­åªèƒ½å‡ºç°ä¸€æ¬¡ï¼ŒæŸ¯é‡ŒåŒ–çš„å‡½æ•°ä¹Ÿä¸ä¾‹å¤–ï¼</li>
</ul>
<h1 id="éšå¼å¯¹è±¡"><a href="#éšå¼å¯¹è±¡" class="headerlink" title="éšå¼å¯¹è±¡"></a>éšå¼å¯¹è±¡</h1><p>ç±»ä¼¼äºéšå¼å€¼, è¦ç»“åˆéšå¼å‚æ•°ä½¿ç”¨ã€‚å…ˆçœ‹ä¸€ä¸ªæ —å­(ä¸‹é¢çš„ä»£ç éœ€è¦è®¤çœŸä½“ä¼š)ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.liam8.impl</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ImpObject</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å®šä¹‰ä¸€ä¸ª`æ’åºå™¨`æ¥å£ï¼Œèƒ½å¤Ÿæ¯”è¾ƒä¸¤ä¸ªç›¸åŒç±»å‹çš„å€¼çš„å¤§å°</span></span><br><span class="line">  <span class="class"><span class="keyword">trait</span> <span class="title">Ordering</span>[<span class="type">T</span>] </span>&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœx&lt;yè¿”å›-1ï¼Œx&gt;yè¿”å›1ï¼Œx==yåˆ™è¿”å›0.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">compare</span></span>(x: <span class="type">T</span>, y: <span class="type">T</span>): <span class="type">Int</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å®ç°ä¸€ä¸ªIntç±»å‹çš„æ’åºå™¨</span></span><br><span class="line">  <span class="keyword">implicit</span> <span class="class"><span class="keyword">object</span> <span class="title">IntOrdering</span> <span class="keyword">extends</span> <span class="title">Ordering</span>[<span class="type">Int</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">compare</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">      <span class="keyword">if</span> (x &lt; y) <span class="number">-1</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (x == y) <span class="number">0</span></span><br><span class="line">      <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å®ç°ä¸€ä¸ªStringç±»å‹çš„æ’åºå™¨</span></span><br><span class="line">  <span class="keyword">implicit</span> <span class="class"><span class="keyword">object</span> <span class="title">StringOrdering</span> <span class="keyword">extends</span> <span class="title">Ordering</span>[<span class="type">String</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">compare</span></span>(x: <span class="type">String</span>, y: <span class="type">String</span>): <span class="type">Int</span> = x.compareTo(y)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ä¸€ä¸ªé€šç”¨çš„maxå‡½æ•°</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">max</span></span>[<span class="type">T</span>](x: <span class="type">T</span>, y: <span class="type">T</span>)(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>]): <span class="type">T</span> = &#123;</span><br><span class="line">      <span class="keyword">if</span> (ord.compare(x, y) &gt;= <span class="number">0</span>) x <span class="keyword">else</span> y</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  println(max(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">  println(max(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//output: </span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// b</span></span><br></pre></td></tr></table></figure>
<p>maxå‡½æ•°çš„ä½œç”¨æ˜¾ç„¶æ˜¯è¿”å›xå’Œyä¸­çš„æœ€å¤§å€¼ï¼Œä½†æ˜¯xå’Œyçš„å€¼ç±»å‹ä¸æ˜¯å›ºå®šçš„ï¼Œmaxä¸çŸ¥é“å¦‚ä½•æ¯”è¾ƒxå’Œyçš„å¤§å‹ï¼Œäºæ˜¯å®šä¹‰äº†ä¸€ä¸ªéšå¼å‚æ•°<code>implicit ord: Ordering[T]</code>ï¼Œå¸Œæœ›èƒ½ä¼ å…¥ä¸€ä¸ªOrdering[T]ç±»å‹çš„æ’åºå™¨å¸®åŠ©è¿›è¡Œxå’Œyçš„æ¯”è¾ƒã€‚</p>
<p>åœ¨è°ƒç”¨<code>max(1, 2)</code>çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å‘ç°éœ€è¦ä¸€ä¸ªOrdering[Int]ç±»å‹çš„å‚æ•°ï¼Œåˆšå¥½<code>implicit object IntOrdering</code>å®šä¹‰äº†ä¸€ä¸ªéšå¼å¯¹è±¡ç¬¦åˆè¦æ±‚ï¼Œäºæ˜¯è¢«ç”¨æ¥ä¼ å…¥maxå‡½æ•°ã€‚</p>
<p>éšå¼å¯¹è±¡è·Ÿä¸Šé¢çš„éšå¼å€¼éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯ç±»å‹ç‰¹æ®Šè€Œå·²ã€‚</p>
<p>åœ¨Scalaä¸­scala.math.Orderingå¾ˆå¸¸ç”¨çš„å†…ç½®ç‰¹è´¨ï¼Œå¦‚æœä½ ç†è§£äº†è¿™æ®µä»£ç ï¼Œä¹Ÿå°±å¤§è‡´ç†è§£äº†Orderingçš„åŸç†ã€‚</p>
<h1 id="ä¸Šä¸‹æ–‡ç•Œå®š-context-bounds"><a href="#ä¸Šä¸‹æ–‡ç•Œå®š-context-bounds" class="headerlink" title="ä¸Šä¸‹æ–‡ç•Œå®š(context bounds)"></a>ä¸Šä¸‹æ–‡ç•Œå®š(context bounds)</h1><p>è¿™æ˜¯ä¸€ç§éšå¼å‚æ•°çš„è¯­æ³•ç³–ã€‚</p>
<p>å†çœ‹ä¸Šé¢éšå¼å¯¹è±¡çš„ä¾‹å­ï¼Œå¦‚æœè¦æ·»åŠ ä¸€ä¸ªminå‡½æ•°ï¼Œå¤§è‡´å°±æ˜¯è¿™æ ·</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">min</span></span>[<span class="type">T</span>](x: <span class="type">T</span>, y: <span class="type">T</span>)(<span class="keyword">implicit</span> ord: <span class="type">Ordering</span>[<span class="type">T</span>]): <span class="type">T</span> = &#123;</span><br><span class="line">  <span class="keyword">if</span> (ord.compare(x, y) &gt;= <span class="number">0</span>) y <span class="keyword">else</span> x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯maxå’Œminå‡½æ•°çš„å‚æ•°éƒ½æ¯”è¾ƒé•¿ï¼Œäºæ˜¯å‡ºç°äº†ä¸€ç§ç®€åŒ–çš„å†™æ³•</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">min</span></span>[<span class="type">T</span>: <span class="type">Ordering</span>](x: <span class="type">T</span>, y: <span class="type">T</span>): <span class="type">T</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> ord = implicitly[<span class="type">Ordering</span>[<span class="type">T</span>]]</span><br><span class="line">  <span class="keyword">if</span> (ord.compare(x, y) &gt;= <span class="number">0</span>) y <span class="keyword">else</span> x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>[T: Ordering]</code>è¿™ç§è¯­æ³•å°±å«ä¸Šä¸‹æ–‡ç•Œå®šï¼Œå«ä¹‰æ˜¯ä¸Šä¸‹æ–‡ä¸­å¿…é¡»æœ‰ä¸€ä¸ªOrdering[T]ç±»å‹çš„éšå¼å€¼ï¼Œè¿™ä¸ªå€¼ä¼šè¢«ä¼ å…¥minå‡½æ•°ã€‚ä½†æ˜¯ç”±äºè¿™ä¸ªéšå¼å€¼å¹¶æ²¡æœ‰æ˜ç¡®èµ‹å€¼ç»™æŸä¸ªå˜é‡ï¼Œæ²¡æ³•ç›´æ¥ä½¿ç”¨å®ƒï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªimplicitlyå‡½æ•°æŠŠéšå¼å€¼å–å‡ºæ¥ã€‚</p>
<p>implicitlyå‡½æ•°çš„å®šä¹‰éå¸¸ç®€å•ï¼Œä½œç”¨å°±æ˜¯å°†Tç±»å‹çš„éšå«å€¼è¿”å›ï¼š</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="meta">@inline</span> <span class="function"><span class="keyword">def</span> <span class="title">implicitly</span></span>[<span class="type">T</span>](<span class="keyword">implicit</span> e: <span class="type">T</span>) = e</span><br></pre></td></tr></table></figure>

<h1 id="è§†ç•Œ"><a href="#è§†ç•Œ" class="headerlink" title="è§†ç•Œ"></a>è§†ç•Œ</h1><p>è¿™ä¸ªè¯­æ³•å·²ç»è¢«åºŸå¼ƒäº†ï¼Œä½†æ˜¯ä½ è¿˜æ˜¯å¯èƒ½ä¼šçœ‹åˆ°ï¼Œç®€å•è§£é‡Šä¸‹ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">min</span></span>[<span class="type">T</span> &lt;% <span class="type">Ordered</span>[<span class="type">T</span>]](x: <span class="type">T</span>, y: <span class="type">T</span>): <span class="type">T</span> = &#123;</span><br><span class="line">    <span class="keyword">if</span> (x &gt; y) y <span class="keyword">else</span> x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§†ç•Œçš„å®šä¹‰<code>T &lt;% Ordered[T]</code>çš„å«ä¹‰æ˜¯Tå¯ä»¥è¢«éšå¼è½¬æ¢æˆOrdered[T]ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ<code>x &gt; y</code>å¯ä»¥ç¼–è¯‘é€šè¿‡ã€‚</p>
<p>ä¸Šé¢çš„å†™æ³•å…¶å®ç­‰åŒäºä¸‹é¢è¿™æ ·ï¼Œæ‰€ä»¥è§†ç•Œçš„è¯­æ³•ä¸èƒ½ç”¨äº†ä¹Ÿä¸è¦ç´§ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">min</span></span>[<span class="type">T</span>](x: <span class="type">T</span>, y: <span class="type">T</span>)(<span class="keyword">implicit</span> c: <span class="type">T</span> =&gt; <span class="type">Ordered</span>[<span class="type">T</span>]): <span class="type">T</span> = &#123;</span><br><span class="line">  <span class="keyword">if</span> (x &gt; y) y <span class="keyword">else</span> x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="éšå¼è½¬æ¢æœºåˆ¶"><a href="#éšå¼è½¬æ¢æœºåˆ¶" class="headerlink" title="éšå¼è½¬æ¢æœºåˆ¶"></a>éšå¼è½¬æ¢æœºåˆ¶</h1><h2 id="éšå¼è½¬æ¢é€šç”¨è§„åˆ™"><a href="#éšå¼è½¬æ¢é€šç”¨è§„åˆ™" class="headerlink" title="éšå¼è½¬æ¢é€šç”¨è§„åˆ™"></a>éšå¼è½¬æ¢é€šç”¨è§„åˆ™</h2><ul>
<li><p>æ ‡è®°è§„åˆ™ï¼šåªæœ‰æ ‡è®°ä¸ºimplicitçš„å®šä¹‰æ‰æ˜¯å¯ç”¨çš„ã€‚</p>
</li>
<li><p>ä½œç”¨åŸŸè§„åˆ™ï¼šæ’å…¥çš„éšå¼è½¬æ¢å¿…é¡»ä»¥å•ä¸€æ ‡è¯†ç¬¦çš„å½¢å¼å¤„äºä½œç”¨åŸŸä¸­ï¼Œæˆ–ä¸è½¬æ¢çš„æºæˆ–ç›®æ ‡ç±»å‹å…³è”åœ¨ä¸€èµ·ã€‚</p>
</li>
</ul>
<p>å•ä¸€æ ‡è¯†ç¬¦æ„æ€æ˜¯ä¸èƒ½æ’å…¥å½¢å¼ä¸ºsomeVariable.convert(x)çš„è½¬æ¢ï¼Œåªèƒ½æ˜¯convert(x)ã€‚<br>å•ä¸€æ ‡è¯†ç¬¦è§„åˆ™æœ‰ä¸ªä¾‹å¤–ï¼Œç¼–è¯‘å™¨è¿˜å°†åœ¨æºç±»å‹æˆ–è½¬æ¢çš„æœŸæœ›ç›®æ ‡ç±»å‹çš„ä¼´ç”Ÿå¯¹è±¡ä¸­å¯»æ‰¾éšå¼å®šä¹‰ã€‚</p>
<p>æœ‰ç‚¹éš¾ç†è§£?çœ‹ä¸ªä¾‹å­!</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.liam8.impl</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ImpCompObject</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">object</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">dogToCat</span></span>(d: <span class="type">Dog</span>) = <span class="keyword">new</span> <span class="type">Cat</span>(d.name)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Cat</span>(<span class="params">val name: <span class="type">String</span></span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">miao</span></span>(): <span class="type">Unit</span> = println(<span class="string">s&quot;<span class="subst">$name</span> say: Miao !&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Dog</span>(<span class="params">val name: <span class="type">String</span></span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bark</span></span>(): <span class="type">Unit</span> = println(<span class="string">s&quot;<span class="subst">$name</span> say: Wang !&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">new</span> <span class="type">Dog</span>(<span class="string">&quot;Teddy&quot;</span>).miao()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Teddy say: Miao !</span></span><br></pre></td></tr></table></figure>
<p>å½“å‰ä½œç”¨åŸŸä¸­æ²¡æœ‰å®šä¹‰å’Œå¼•å…¥éšå¼å‡½æ•°ï¼Œä½†æ˜¯åœ¨Dogçš„ä¼´ç”Ÿå¯¹è±¡ä¸­æ‰¾åˆ°äº†ï¼Œæ‰€ä»¥Dogå¯ä»¥è¢«è½¬æˆCatï¼Œè¿™ä¸ªè·Ÿä¸Šä¸‹æ–‡æ²¡æœ‰å…³ç³»ï¼Œè€Œæ˜¯Dogè‡ªå¸¦æŠ€èƒ½ã€‚</p>
<ul>
<li><p>æ— æ­§ä¹‰è§„åˆ™ï¼šéšå¼è½¬æ¢å”¯æœ‰ä¸å­˜åœ¨å…¶ä»–è½¬æ¢çš„å‰æä¸‹æœ‰æ•ˆã€‚</p>
</li>
<li><p>å•ä¸€è°ƒç”¨è§„åˆ™ï¼šåªä¼šå°è¯•ä¸€ä¸ªéšå¼æ“ä½œã€‚</p>
</li>
<li><p>æ˜¾ç¤ºæ“ä½œå…ˆè¡Œè§„åˆ™ï¼šè‹¥ç¼–å†™çš„ä»£ç ç±»å‹æ£€æŸ¥æ— è¯¯ï¼Œåˆ™ä¸ä¼šå°è¯•éšå¼æ“ä½œã€‚</p>
</li>
</ul>
<h2 id="è½¬æ¢æ—¶æœº"><a href="#è½¬æ¢æ—¶æœº" class="headerlink" title="è½¬æ¢æ—¶æœº"></a>è½¬æ¢æ—¶æœº</h2><ul>
<li>å½“ç±»å‹ä¸ç›®æ ‡ç±»å‹ä¸ä¸€è‡´æ—¶</li>
<li>å½“å¯¹è±¡è°ƒç”¨ç±»ä¸­ä¸å­˜åœ¨çš„æ–¹æ³•æˆ–æˆå‘˜æ—¶</li>
<li>ç¼ºå°‘éšå¼å‚æ•°æ—¶</li>
</ul>
<p>ä¹Ÿå³æ˜¯èƒ½ç”¨åˆ°éšå¼æ“ä½œçš„æœ‰ä¸‰ä¸ªåœ°æ–¹ï¼šè½¬æ¢ä¸ºæœŸæœ›ç±»å‹ã€æŒ‡å®šï¼ˆæ–¹æ³•ï¼‰è°ƒç”¨è€…çš„è½¬æ¢ã€éšå¼å‚æ•°ã€‚</p>
<h2 id="è½¬æ¢æœºåˆ¶"><a href="#è½¬æ¢æœºåˆ¶" class="headerlink" title="è½¬æ¢æœºåˆ¶"></a>è½¬æ¢æœºåˆ¶</h2><p><em>è¿™æ®µæ¥è‡ª<a href="https://www.cnblogs.com/MOBIN/p/5351900.html">æ·±å…¥ç†è§£Scalaçš„éšå¼è½¬æ¢</a></em></p>
<p>å³ç¼–è¯‘å™¨æ˜¯å¦‚ä½•æŸ¥æ‰¾åˆ°ç¼ºå¤±ä¿¡æ¯çš„ï¼Œè§£æå…·æœ‰ä»¥ä¸‹ä¸¤ç§è§„åˆ™ï¼š</p>
<ul>
<li><p>1.é¦–å…ˆä¼šåœ¨å½“å‰ä»£ç ä½œç”¨åŸŸä¸‹æŸ¥æ‰¾éšå¼å®ä½“ï¼ˆéšå¼æ–¹æ³•  éšå¼ç±» éšå¼å¯¹è±¡ï¼‰</p>
</li>
<li><p>2.å¦‚æœç¬¬ä¸€æ¡è§„åˆ™æŸ¥æ‰¾éšå¼å®ä½“å¤±è´¥ï¼Œä¼šç»§ç»­åœ¨éšå¼å‚æ•°çš„ç±»å‹çš„ä½œç”¨åŸŸé‡ŒæŸ¥æ‰¾<br>ç±»å‹çš„ä½œç”¨åŸŸæ˜¯æŒ‡ä¸è¯¥ç±»å‹ç›¸å…³è”çš„å…¨éƒ¨ä¼´ç”Ÿæ¨¡å—ï¼Œä¸€ä¸ªéšå¼å®ä½“çš„ç±»å‹Tå®ƒçš„æŸ¥æ‰¾èŒƒå›´å¦‚ä¸‹ï¼š</p>
<ul>
<li>1 å¦‚æœTè¢«å®šä¹‰ä¸ºT with A with B with C,é‚£ä¹ˆA,B,Céƒ½æ˜¯Tçš„éƒ¨åˆ†ï¼Œåœ¨Tçš„éšå¼è§£æè¿‡ç¨‹ä¸­ï¼Œå®ƒä»¬çš„ä¼´ç”Ÿå¯¹è±¡éƒ½ä¼šè¢«æœç´¢</li>
<li>2 å¦‚æœTæ˜¯å‚æ•°åŒ–ç±»å‹ï¼Œé‚£ä¹ˆç±»å‹å‚æ•°å’Œä¸ç±»å‹å‚æ•°ç›¸å…³è”çš„éƒ¨åˆ†éƒ½ç®—ä½œTçš„éƒ¨åˆ†ï¼Œæ¯”å¦‚List[String]çš„éšå¼æœç´¢ä¼šæœç´¢Listçš„ä¼´ç”Ÿå¯¹è±¡å’ŒStringçš„ä¼´ç”Ÿå¯¹è±¡</li>
<li>3  å¦‚æœTæ˜¯ä¸€ä¸ªå•ä¾‹ç±»å‹p.Tï¼Œå³Tæ˜¯å±äºæŸä¸ªpå¯¹è±¡å†…ï¼Œé‚£ä¹ˆè¿™ä¸ªpå¯¹è±¡ä¹Ÿä¼šè¢«æœç´¢</li>
<li>4  å¦‚æœTæ˜¯ä¸ªç±»å‹æ³¨å…¥S#Tï¼Œé‚£ä¹ˆSå’ŒTéƒ½ä¼šè¢«æœç´¢</li>
</ul>
</li>
</ul>
<h1 id="ä¸Šè·¯å‰çš„è¯"><a href="#ä¸Šè·¯å‰çš„è¯" class="headerlink" title="ä¸Šè·¯å‰çš„è¯"></a>ä¸Šè·¯å‰çš„è¯</h1><p>è¿™æ®µè¯æ¥è‡ªã€ŠScalaç¼–ç¨‹ã€‹</p>
<blockquote>
<p>éšå¼æ“ä½œè‹¥è¿‡äºé¢‘ç¹ä½¿ç”¨ï¼Œä¼šè®©ä»£ç å˜å¾—æ™¦æ¶©éš¾æ‡‚ã€‚å› æ­¤ï¼Œåœ¨è€ƒè™‘æ·»åŠ æ–°çš„éšå¼è½¬æ¢ä¹‹å‰ï¼Œè¯·é¦–å…ˆè‡ªé—®æ˜¯å¦èƒ½å¤Ÿé€šè¿‡å…¶ä»–æ‰‹æ®µï¼Œè¯¸å¦‚ç»§æ‰¿ã€æ··å…¥ç»„åˆæˆ–æ–¹æ³•é‡è½½ï¼Œè¾¾åˆ°åŒæ ·çš„ç›®çš„ã€‚å¦‚æœæ‰€æœ‰è¿™äº›éƒ½ä¸èƒ½æˆåŠŸï¼Œå¹¶ä¸”ä½ æ„Ÿè§‰ä»£ç ä»æœ‰ä¸€äº›ç¹å¤å’Œå†—ä½™ï¼Œé‚£ä¹ˆéšå¼æ“ä½œæˆ–è®¸æ­£å¥½èƒ½å¸®åˆ°ä½ ã€‚</p>
</blockquote>
<p>æ‰€ä»¥ã€‚ã€‚ã€‚è°¨æ…ä½¿ç”¨ï¼Œå°å¿ƒç¿»è½¦ï¼Œgood luck!</p>
<h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p><a href="https://docs.scala-lang.org/zh-cn/overviews/core/implicit-classes.html">IMPLICIT CLASSES</a></p>
<p><a href="https://blog.csdn.net/m0_37138008/article/details/78120210">scalaçš„éšå¼è½¬æ¢å­¦ä¹ æ€»ç»“ï¼ˆè¯¦ç»†ï¼‰</a></p>
<p>ã€ŠScalaç¼–ç¨‹ã€‹</p>
<p><a href="https://www.cnblogs.com/MOBIN/p/5351900.html">æ·±å…¥ç†è§£Scalaçš„éšå¼è½¬æ¢</a></p>
<h1 id="æœ¬æ–‡ä»£ç "><a href="#æœ¬æ–‡ä»£ç " class="headerlink" title="æœ¬æ–‡ä»£ç "></a>æœ¬æ–‡ä»£ç </h1><p><a href="https://github.com/Liam8/learn-scala">Githubä»“åº“</a></p>
<p>è½¬è½½è¯·æ³¨æ˜åŸæ–‡åœ°å€ï¼š<a href="https://liam-blog.ml/2019/09/28/scala-implicit/">https://liam-blog.ml/2019/09/28/scala-implicit/</a></p>
]]></content>
      <tags>
        <tag>Scala</tag>
      </tags>
  </entry>
  <entry>
    <title>Spark Coreè§£æ 1ï¼šRDD å¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†</title>
    <url>/2019/10/23/spark-core-rdd/</url>
    <content><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p>Spark Coreæ˜¯Sparkçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œæ˜¯Spark SQLï¼ŒSpark Streamingï¼ŒSpark MLlibç­‰ç­‰å…¶ä»–æ¨¡å—çš„åŸºç¡€, Spark Coreæä¾›äº†å¼€å‘åˆ†å¸ƒå¼åº”ç”¨çš„è„šæ‰‹æ¶ï¼Œä½¿å¾—å…¶ä»–æ¨¡å—æˆ–åº”ç”¨çš„å¼€å‘è€…ä¸å¿…å…³å¿ƒå¤æ‚çš„åˆ†å¸ƒå¼è®¡ç®—å¦‚ä½•å®ç°ï¼Œåªéœ€ä½¿ç”¨Spark Coreæä¾›çš„åˆ†å¸ƒå¼æ•°æ®ç»“æ„RDDåŠä¸°å¯Œçš„ç®—å­APIï¼Œä»¥ç±»ä¼¼å¼€å‘å•æœºåº”ç”¨çš„æ–¹å¼æ¥è¿›è¡Œå¼€å‘ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/spark.png" alt="spark.png"></p>
<p>å›¾ä¸­æœ€ä¸‹é¢é‚£ä¸ªå°±æ˜¯Spark Coreå•¦ï¼Œæ—¥å¸¸ä½¿ç”¨çš„RDDç›¸å…³çš„APIå°±å±äºSpark Coreï¼Œè€ŒDatasetã€DataFrameåˆ™å±äºSpark SQLã€‚</p>
<span id="more"></span>

<h1 id="RDD-æ¦‚è§ˆ"><a href="#RDD-æ¦‚è§ˆ" class="headerlink" title="RDD æ¦‚è§ˆ"></a>RDD æ¦‚è§ˆ</h1><p>æœ¬æ–‡åŸºäºSpark 2.xã€‚</p>
<h2 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h2><p>RDD (Resilient Distributed Datasetï¼Œå¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†)ï¼š</p>
<ul>
<li>Resilientï¼šä¸å¯å˜çš„ã€å®¹é”™çš„</li>
<li>Distributedï¼šæ•°æ®åˆ†æ•£åœ¨ä¸åŒèŠ‚ç‚¹ï¼ˆæœºå™¨ï¼Œè¿›ç¨‹ï¼‰</li>
<li>Datasetï¼šä¸€ä¸ªç”±å¤šä¸ªåˆ†åŒºç»„æˆçš„æ•°æ®é›†</li>
</ul>
<h2 id="ç‰¹å¾"><a href="#ç‰¹å¾" class="headerlink" title="ç‰¹å¾"></a>ç‰¹å¾</h2><p>In-Memoryï¼šRDDä¼šä¼˜å…ˆä½¿ç”¨å†…å­˜<br>Immutableï¼ˆRead-Onlyï¼‰ï¼šä¸€æ—¦åˆ›å»ºä¸å¯ä¿®æ”¹<br>Lazy evaluatedï¼šæƒ°æ€§æ‰§è¡Œ<br>Cacheableï¼šå¯ç¼“å­˜ï¼Œå¯å¤ç”¨<br>Parallelï¼šå¯å¹¶è¡Œå¤„ç†<br>Typedï¼šå¼ºç±»å‹ï¼Œå•ä¸€ç±»å‹æ•°æ®<br>Partitionedï¼šåˆ†åŒºçš„<br>Location-Stickinessï¼šå¯æŒ‡å®šåˆ†åŒºä¼˜å…ˆä½¿ç”¨çš„èŠ‚ç‚¹</p>
<p>æ˜¯Sparkä¸­æœ€æ ¸å¿ƒçš„æ•°æ®æŠ½è±¡ï¼Œæ•°æ®å¤„ç†å’Œè®¡ç®—åŸºæœ¬éƒ½æ˜¯åŸºäºRDDã€‚</p>
<h2 id="ç»„æˆ"><a href="#ç»„æˆ" class="headerlink" title="ç»„æˆ"></a>ç»„æˆ</h2><p>ä¸€ä¸ªRDDé€šå¸¸ç”±5ä¸ªè¦ç´ ç»„æˆï¼š</p>
<ul>
<li>ä¸€ç»„åˆ†åŒº(partition)</li>
<li>ä¸€ä¸ªè®¡ç®—å‡½æ•°</li>
<li>ä¸€ç»„ä¾èµ–(ç›´æ¥ä¾èµ–çš„çˆ¶RDD)</li>
<li>ä¸€ä¸ªåˆ†åŒºå™¨ (å¯é€‰) </li>
<li>ä¸€ç»„ä¼˜å…ˆè®¡ç®—ä½ç½®(e.g. å°†Taskåˆ†é…è‡³é è¿‘HDFSå—çš„èŠ‚ç‚¹è¿›è¡Œè®¡ç®—) (å¯é€‰)</li>
</ul>
<p>ä¸ä¼ ç»Ÿæ•°æ®ç»“æ„å¯¹æ¯”ï¼Œåªå…³å¿ƒè®¿é—®ï¼Œä¸å…³å¿ƒå­˜å‚¨ã€‚é€šè¿‡è¿­ä»£å™¨è®¿é—®æ•°æ®ï¼Œåªè¦æ•°æ®èƒ½è¢«ä¸é‡å¤åœ°è®¿é—®å³å¯ã€‚</p>
<h2 id="ç®—å­"><a href="#ç®—å­" class="headerlink" title="ç®—å­"></a>ç®—å­</h2><p>ç®—å­ï¼Œå³å¯¹RDDè¿›è¡Œå˜æ¢çš„æ“ä½œï¼ŒæŒ‰ç…§æ˜¯å¦è§¦å‘Jobæäº¤å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼š</p>
<ul>
<li>transformationï¼šä¸ä¼šç«‹å³æ‰§è¡Œçš„ä¸€ç±»å˜æ¢ï¼Œä¸ä¼šè§¦å‘Jobæ‰§è¡Œï¼Œä¼šç”Ÿæˆå¹¶è¿”å›æ–°çš„RDDï¼ŒåŒæ—¶è®°å½•ä¸‹ä¾èµ–å…³ç³»ã€‚å¦‚ï¼šmap,filter,union,join,reduceByKeyã€‚</li>
<li>action: ä¼šç«‹å³æäº¤Jobçš„ä¸€ç±»å˜æ¢ï¼Œä¸ä¼šè¿”å›æ–°çš„RDDï¼Œè€Œæ˜¯ç›´æ¥è¿”å›è®¡ç®—ç»“æœã€‚å¦‚ï¼šcount,reduce,foreachã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191022162739.png" alt="20191022162739.png"></p>
<h3 id="ç®—å­ä¸RDDçš„å…³ç³»"><a href="#ç®—å­ä¸RDDçš„å…³ç³»" class="headerlink" title="ç®—å­ä¸RDDçš„å…³ç³»"></a>ç®—å­ä¸RDDçš„å…³ç³»</h3><p>transformationç±»å‹çš„ç®—å­é€šå¸¸éƒ½ä¼šè¿”å›æ–°çš„RDDï¼Œè™½ç„¶åªè¿”å›ä¸€ä¸ªæ–°çš„RDDç»™ç”¨æˆ·ï¼Œä½†æ˜¯åœ¨RDDçš„è¡€ç¼˜å…³ç³»å›¾(RDD linage)ä¸­ï¼Œæœ‰å¯èƒ½æ–°å¢äº†å¤šä¸ªRDDã€‚</p>
<p>å…ˆçœ‹ç®—å­ä¸RDDä¸€å¯¹ä¸€çš„æƒ…å†µï¼š<br>map &#x3D;&gt; MapPartitionsRDD<br>filter &#x3D;&gt; MapPartitionsRDD<br>reduceByKey &#x3D;&gt; ShuffledRDD<br>â€¦</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/reduceByKey.png" alt="reduceByKey.png"></p>
<p>ä¸€å¯¹å¤šï¼š<br>join &#x3D;&gt;  CoGroupedRDD-&gt;MapPartitionsRDD-&gt;MapPartitionsRDD<br>distinct &#x3D;&gt; MapPartitionsRDD-&gt;ShuffledRDD-&gt;MapPartitionsRDD<br>â€¦</p>
<p>ä¸€ä¸ªç®—å­ç”Ÿæˆçš„å¤šä¸ªRDDï¼Œä¹Ÿä¸ä¸€å®šå½’å±äºåŒä¸€ä¸ªstageï¼Œä¾‹å¦‚distinctç®—å­ï¼Œç”Ÿæˆçš„ç¬¬ä¸€ä¸ªMapPartitionsRDDå½’å±äºå‰ä¸€ä¸ªstageï¼Œå…¶ä»–çš„åˆ™å½’å±äºåä¸€ä¸ªstageï¼Œå…¶ä¸­äº§ç”Ÿäº†ä¸€æ¬¡shuffleã€‚</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/distinct-1.png" alt="distinct-1.png"></p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/distinct-2.png" alt="distinct-2.png"></p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/distinct-3.png" alt="distinct-3.png"></p>
<h1 id="Partition-amp-Partitioner"><a href="#Partition-amp-Partitioner" class="headerlink" title="Partition &amp; Partitioner"></a>Partition &amp; Partitioner</h1><p><strong>ä¸ºä»€ä¹ˆè¦æŠŠæ•°æ®åˆ†åŒºï¼Ÿ</strong><br>æŠŠæ•°æ®åˆ†æˆè‹¥å¹²partitionæ˜¯ä¸ºäº†å°†æ•°æ®åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹ä¸åŒçº¿ç¨‹ï¼Œä»è€Œèƒ½è¿›è¡Œåˆ†å¸ƒå¼çš„å¤šçº¿ç¨‹çš„å¹¶è¡Œè®¡ç®—ã€‚</p>
<p><strong>æŒ‰ä»€ä¹ˆè§„åˆ™åˆ†åŒºï¼Ÿ</strong><br>RDDä»æ•°æ®æºç”Ÿæˆçš„æ—¶å€™ï¼Œæ•°æ®é€šå¸¸æ˜¯éšæœºåˆ†é…åˆ°ä¸åŒçš„partitionæˆ–è€…ä¿æŒæ•°æ®æºçš„åˆ†åŒºï¼Œå¦‚sc.parallelize(â€¦)ï¼Œsc.textFile(â€¦)ã€‚</p>
<p>è¿™å¯¹äºæŸäº›RDDæ“ä½œæ¥è¯´æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œæ¯”å¦‚filter(),map(),flatMap()ï¼Œrdd.union(otherRDD)ï¼Œrdd.intersection(otherRDD)ï¼Œ<br>rdd.subtract(otherRDD)ã€‚</p>
<p>ä½†æ˜¯å¯¹äºreduceByKey(),foldByKey(),combineByKey(),groupByKey()ï¼ŒsortByKey()ï¼Œcogroup(), join() ,leftOuterJoin(), rightOuterJoin()è¿™äº›æ“ä½œï¼Œéšæœºåˆ†é…åˆ†åŒºå°±éå¸¸ä¸å‹å¥½ï¼Œä¼šå¸¦æ¥å¾ˆå¤šé¢å¤–çš„ç½‘ç»œä¼ è¾“ã€‚å½±å“ä¸€ä¸ªåˆ†å¸ƒå¼è®¡ç®—ç³»ç»Ÿæ€§èƒ½çš„æœ€å¤§æ•Œäººå°±æ˜¯ç½‘ç»œä¼ è¾“ï¼Œæ‰€ä»¥å¿…é¡»å°½é‡æœ€å°åŒ–ç½‘ç»œä¼ è¾“ã€‚</p>
<p><strong>ä¸ºäº†å‡å°‘ç½‘ç»œä¼ è¾“ï¼Œæ€ä¹ˆåˆ†åŒºæ‰åˆç†ï¼Ÿ</strong><br>å¯¹äºreduceByKeyæ“ä½œåº”è¯¥æŠŠç›¸åŒkeyçš„æ•°æ®æ”¾åˆ°åŒä¸€åˆ†åŒºï¼›<br>å¯¹äºsortByKeyæ“ä½œåº”è¯¥æŠŠåŒä¸€èŒƒå›´çš„æ•°æ®æ”¾åˆ°åŒä¸€åˆ†åŒºã€‚</p>
<p>å¯è§ä¸åŒçš„æ“ä½œé€‚åˆä¸åŒçš„æ•°æ®åˆ†åŒºè§„åˆ™ï¼ŒSparkå°†åˆ’åˆ†è§„åˆ™æŠ½è±¡ä¸º<em>Partitioner(åˆ†åŒºå™¨)</em> ï¼Œåˆ†åŒºå™¨çš„æ ¸å¿ƒä½œç”¨æ˜¯å†³å®šæ•°æ®åº”å½’å±çš„åˆ†åŒºï¼Œæœ¬è´¨å°±æ˜¯è®¡ç®—æ•°æ®å¯¹åº”çš„åˆ†åŒºIDã€‚</p>
<p>åœ¨Spark Coreä¸­å†…ç½®äº†2ä¸ªPartitioneræ¥æ”¯æŒå¸¸ç”¨çš„åˆ†åŒºè§„åˆ™(Spark MLlib,Spark SQLä¸­æœ‰å…¶ä»–çš„)ã€‚</p>
<ul>
<li>HashPartitioner å“ˆå¸Œåˆ†åŒºå™¨</li>
<li>RangePartitioner èŒƒå›´åˆ†åŒºå™¨</li>
</ul>
<h2 id="HashPartitioner"><a href="#HashPartitioner" class="headerlink" title="HashPartitioner"></a>HashPartitioner</h2><p>å“ˆå¸Œåˆ†åŒºå™¨æ˜¯é»˜è®¤çš„åˆ†åŒºå™¨ï¼Œä¹Ÿæ˜¯ä½¿ç”¨æœ€å¹¿æ³›çš„ä¸€ä¸ªï¼Œä½œç”¨æ˜¯å°†æ•°æ®æŒ‰ç…§keyçš„hashå€¼è¿›è¡Œåˆ†åŒºã€‚</p>
<p>åˆ†åŒºIDè®¡ç®—å…¬å¼éå¸¸ç®€å•ï¼š<code>keyçš„hashå€¼ % åˆ†åŒºä¸ªæ•°</code> ï¼Œ å¦‚æœkeyä¸ºnullï¼Œåˆ™è¿”å›0.</p>
<p>ä¹Ÿå°±æ˜¯å°†keyçš„hashå€¼(Javaä¸­æ¯ä¸ªå¯¹è±¡éƒ½æœ‰hash code,å¯¹è±¡ç›¸ç­‰åˆ™hash codeç›¸åŒ)ï¼Œé™¤ä»¥åˆ†åŒºä¸ªæ•°ï¼Œå–ä½™æ•°ä¸ºåˆ†åŒºIDï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯ç›¸åŒKeyçš„æ•°æ®è¢«åˆ†åˆ°åŒä¸€ä¸ªåˆ†åŒºï¼Œä½†æ˜¯æ¯ä¸ªåˆ†åŒºçš„æ•°æ®é‡å¯èƒ½ä¼šç›¸å·®å¾ˆå¤§ï¼Œå‡ºç°æ•°æ®å€¾æ–œã€‚</p>
<h2 id="RangePartitioner"><a href="#RangePartitioner" class="headerlink" title="RangePartitioner"></a>RangePartitioner</h2><p>RangePartitionerçš„ä½œç”¨æ˜¯æ ¹æ®keyï¼Œå°†æ•°æ®æŒ‰èŒƒå›´å¤§è‡´å¹³å‡çš„åˆ†åˆ°å„ä¸ªåˆ†åŒºï¼Œåªæ”¯æŒèƒ½æ’åºçš„keyã€‚</p>
<p>è¦çŸ¥é“ä¸€ä¸ªkeyå±äºå“ªä¸ªåˆ†åŒºï¼Œéœ€è¦çŸ¥é“æ¯ä¸ªåˆ†åŒºçš„è¾¹ç•Œå€¼ã€‚<br>ç¡®å®šè¾¹ç•Œå€¼éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œå› ä¸ºæ•°æ®é‡é€šå¸¸è¾ƒå¤§ï¼Œé€šè¿‡æ ·æœ¬æ›¿ä»£æ€»ä½“æ¥ä¼°è®¡æ¯ä¸ªåˆ†åŒºçš„è¾¹ç•Œå€¼ã€‚</p>
<p>é‡‡æ ·æµç¨‹ï¼š</p>
<ul>
<li><ol>
<li>ä½¿ç”¨æ°´å¡˜æŠ½æ ·å¯¹æ€»ä½“è¿›è¡Œé‡‡æ ·ï¼›</li>
</ol>
</li>
<li><ol start="2">
<li>é’ˆå¯¹æ•°æ®é‡è¿œè¶…å¹³å‡å€¼çš„åˆ†åŒºï¼Œè¿›è¡Œä¼ ç»ŸæŠ½æ ·(ä¼¯åŠªåˆ©æŠ½æ ·)ã€‚</li>
</ol>
</li>
</ul>
<p>ä½¿ç”¨åœºæ™¯ï¼šsortByKey</p>
<p>æ‰©å±•é—®é¢˜ï¼š</p>
<h2 id="å¦‚ä½•ä½¿ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h2><p>å¯¹äºä¸€ä¸ªæ²¡æœ‰æ˜ç¡®æŒ‡å®šPartitionerçš„æƒ…å†µä¸‹ï¼Œ<br>reduceByKey(),foldByKey(),combineByKey(),groupByKey()ç­‰æ“ä½œä¼šé»˜è®¤ä½¿ç”¨HashPartitionerã€‚<br>sortByKeyæ“ä½œä¼šé‡‡ç”¨RangePartitionerã€‚</p>
<p>reduceByKeyä¹Ÿæœ‰ä¸€ä¸ªå¯ä»¥è‡ªå®šä¹‰åˆ†åŒºå™¨çš„ç‰ˆæœ¬ï¼š<code>reduceByKey(partitioner: Partitioner, func: (V, V) =&gt; V)</code></p>
<h1 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h1><h2 id="ä¼ å…¥ç»™transformationçš„å‡½æ•°"><a href="#ä¼ å…¥ç»™transformationçš„å‡½æ•°" class="headerlink" title="ä¼ å…¥ç»™transformationçš„å‡½æ•°"></a>ä¼ å…¥ç»™transformationçš„å‡½æ•°</h2><p>transformationä¼šç”Ÿæˆæ–°çš„RDDï¼Œä¼ ç»™RDD transformationçš„å‡½æ•°æœ€ç»ˆä¼šä»¥æˆå‘˜å˜é‡çš„å½¢å¼å­˜å‚¨åœ¨æ–°ç”Ÿæˆçš„RDDä¸­ã€‚</p>
<p>ä»¥mapå‡½æ•°ä¸ºä¾‹ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> r11 = r00.map(n =&gt; (n, n))</span><br></pre></td></tr></table></figure>

<p>mapå‡½æ•°æ¥å—çš„å‚æ•°ç±»å‹ä¸º<code>f: T =&gt; U</code>ï¼Œå› ä¸ºScalaæ”¯æŒå‡½æ•°å¼ç¼–ç¨‹ï¼Œå‡½æ•°å¯ä»¥åƒå€¼ä¸€æ ·å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ã€‚<br>få‚æ•°çš„ç±»å‹<code>T =&gt; U</code>ä»£è¡¨ä¸€ç§å‡½æ•°ç±»å‹ï¼Œè¿™ä¸ªå‡½æ•°çš„è¾“å…¥å‚æ•°çš„ç±»å‹å¿…é¡»ä¸ºTï¼Œè¾“å‡ºç±»å‹ä¸ºUï¼Œè¿™é‡ŒTå’ŒUéƒ½æ˜¯æ³›å‹ï¼ŒTä»£è¡¨RDDä¸­æ•°æ®çš„ç±»å‹ï¼Œå¯¹äºRDD[String]æ¥è¯´ï¼ŒTå°±æ˜¯Stringã€‚</p>
<p>æœ€ç»ˆfå‚æ•°ï¼Œä¼šè½¬æ¢æˆæœ‰å…³è¿­ä»£å™¨çš„ä¸€ä¸ªå‡½æ•°ï¼Œå­˜å‚¨åˆ°RDDçš„fæˆå‘˜å˜é‡ä¸­ã€‚</p>
<p>æœ€ç»ˆå­˜å‚¨çš„ç±»å‹ä¸ºï¼š<br><code>f: (TaskContext, Int, Iterator[T]) =&gt; Iterator[U]</code><br>å¯¹äºmapæ¥è¯´æ˜¯è¿™æ ·ä¸€ä¸ªå‡½æ•°<br><code>(context, pid, iter) =&gt; iter.map(f)</code><br>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¼ å…¥åˆ°RDD.mapçš„få‡½æ•°ï¼Œæœ€ç»ˆä¼ ç»™äº†Iterator.mapå‡½æ•°ã€‚</p>
<h2 id="ä¼ å…¥ç»™actionçš„å‡½æ•°"><a href="#ä¼ å…¥ç»™actionçš„å‡½æ•°" class="headerlink" title="ä¼ å…¥ç»™actionçš„å‡½æ•°"></a>ä¼ å…¥ç»™actionçš„å‡½æ•°</h2><p>actionä¸ä¼šç”Ÿæˆæ–°çš„RDDï¼Œè€Œæ˜¯å°†å‡½æ•°ä¼ é€’ç»™Jobã€‚</p>
<h1 id="Dependency"><a href="#Dependency" class="headerlink" title="Dependency"></a>Dependency</h1><p>å½“RDD1ç»è¿‡transformationç”Ÿæˆäº†RDD2ï¼Œå°±ç§°ä½œRDD2ä¾èµ–RDD1ï¼ŒRDD1æ˜¯RDD2çš„çˆ¶RDDï¼Œä»–ä»¬æ˜¯çˆ¶å­å…³ç³»ã€‚</p>
<p>å…ˆçœ‹ä¸€ä¸ªä¾‹å­</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> r00 = sc.parallelize(<span class="number">0</span> to <span class="number">9</span>)</span><br><span class="line"><span class="keyword">val</span> r01 = sc.parallelize(<span class="number">0</span> to <span class="number">90</span> by <span class="number">10</span>)</span><br><span class="line"><span class="keyword">val</span> r10 = r00 cartesian r01</span><br><span class="line"><span class="keyword">val</span> r11 = r00.map(n =&gt; (n, n))</span><br><span class="line"><span class="keyword">val</span> r12 = r00 zip r01</span><br><span class="line"><span class="keyword">val</span> r13 = r01.keyBy(_ / <span class="number">20</span>)</span><br><span class="line"><span class="keyword">val</span> r20 = <span class="type">Seq</span>(r11, r12, r13).foldLeft(r10)(_ union _)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹ä¸‹RDDä¹‹é—´çš„ä¾èµ–å…³ç³»å›¾</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191022162858.png" alt="20191022162858.png"></p>
<p>RDDçš„ä¾èµ–å…³ç³»ç½‘åˆå«RDDçš„è¡€ç»Ÿ(lineage)ï¼Œå¯ä»¥çœ‹åšæ˜¯RDDçš„é€»è¾‘æ‰§è¡Œè®¡åˆ’ã€‚</p>
<p>åŒä¹‰è¯ï¼šRDD lineageï¼ŒRDD operator graphï¼ŒRDD dependency graph</p>
<h2 id="Dependencyå­˜å‚¨"><a href="#Dependencyå­˜å‚¨" class="headerlink" title="Dependencyå­˜å‚¨"></a>Dependencyå­˜å‚¨</h2><p>çˆ¶RDDä¸å­RDDä¹‹é—´çš„ä¾èµ–å…³ç³»è®°å½•åœ¨<strong>å­RDD</strong>çš„å±æ€§ä¸­(<code>deps: Seq[Dependency[_]]</code>)ï¼Œæ•°æ®ç±»å‹ä¸ºDependency(å¯ä»¥æœ‰å¤šä¸ª)ï¼ŒDependencyä¸­ä¿å­˜äº†çˆ¶RDDçš„å¼•ç”¨ï¼Œè¿™æ ·é€šè¿‡Dependencyå°±èƒ½æ‰¾åˆ°çˆ¶RDDã€‚</p>
<h2 id="Dependencyåˆ†ç±»"><a href="#Dependencyåˆ†ç±»" class="headerlink" title="Dependencyåˆ†ç±»"></a>Dependencyåˆ†ç±»</h2><p>Dependencyä¸ä»…æè¿°äº†RDDä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œè¿˜è¿›ä¸€æ­¥æè¿°äº†ä¸åŒRDDçš„partitionä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p>
<p>ä¾æ®partitionä¹‹é—´ä¾èµ–å…³ç³»çš„ä¸åŒDependencyåˆ†ä¸ºä¸¤å¤§ç±»ï¼š</p>
<ul>
<li>NarrowDependency çª„ä¾èµ–ï¼Œ1ä¸ªçˆ¶åˆ†åŒºåªå¯¹åº”1ä¸ªå­åˆ†åŒºï¼Œè¿™æ—¶çˆ¶RDDä¸éœ€è¦æ”¹å˜åˆ†åŒºæ–¹å¼ã€‚å¦‚ï¼šmapã€filterã€unionï¼Œco-paritioned join</li>
<li>ShuffleDependency Shuffleä¾èµ–(å®½ä¾èµ–)ï¼Œ1ä¸ªçˆ¶åˆ†åŒºå¯¹åº”å¤šä¸ªå­åˆ†åŒºï¼Œè¿™ç§æƒ…å†µçˆ¶RDDå¿…é¡»é‡æ–°åˆ†åŒºï¼Œæ‰èƒ½ç¬¦åˆå­RDDçš„éœ€æ±‚ã€‚å¦‚ï¼šgroupByKeyã€reduceByKeyã€sortByKeyï¼Œï¼ˆnot co-paritionedï¼‰join</li>
</ul>
<h3 id="NarrowDependency"><a href="#NarrowDependency" class="headerlink" title="NarrowDependency"></a>NarrowDependency</h3><p>NarrowDependencyæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸€å…±æœ‰3ä¸­å®ç°ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰3ç§NarrowDependencyã€‚</p>
<ul>
<li>OneToOneDependencyï¼šä¸€å¯¹ä¸€ä¾èµ–ï¼Œæ¯”å¦‚map,</li>
<li>RangeDependencyï¼šèŒƒå›´ä¾èµ–ï¼Œå¦‚ union</li>
<li>PruneDependencyï¼šè£å‰ªä¾èµ–ï¼Œè¿‡æ»¤æ‰éƒ¨åˆ†åˆ†åŒºï¼Œå¦‚PartitionPruningRDD</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191022163015.png" alt="20191022163015.png"></p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191022163033.png" alt="20191022163033.png"></p>
<h3 id="ShuffleDependency"><a href="#ShuffleDependency" class="headerlink" title="ShuffleDependency"></a>ShuffleDependency</h3><p>å‡ºç°shuffleä¾èµ–è¡¨ç¤ºçˆ¶RDDä¸å­RDDçš„åˆ†åŒºæ–¹å¼å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191022163106.png" alt="20191022163106.png"></p>
<h1 id="RDDåˆ†ç±»"><a href="#RDDåˆ†ç±»" class="headerlink" title="RDDåˆ†ç±»"></a>RDDåˆ†ç±»</h1><p>RDDçš„å…·ä½“å®ç°ç±»æœ‰å‡ åç§(å¤§æ¦‚60+)ï¼Œä»‹ç»ä¸‹æœ€å¸¸è§çš„å‡ ç§ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">scala&gt; r20.toDebugString</span><br><span class="line">res34: <span class="type">String</span> =</span><br><span class="line">(<span class="number">28</span>) <span class="type">UnionRDD</span>[<span class="number">38</span>] at union at &lt;pastie&gt;:<span class="number">31</span> []</span><br><span class="line"> |   <span class="type">UnionRDD</span>[<span class="number">37</span>] at union at &lt;pastie&gt;:<span class="number">31</span> []</span><br><span class="line"> |   <span class="type">UnionRDD</span>[<span class="number">36</span>] at union at &lt;pastie&gt;:<span class="number">31</span> []</span><br><span class="line"> |   <span class="type">CartesianRDD</span>[<span class="number">32</span>] at cartesian at &lt;pastie&gt;:<span class="number">27</span> []</span><br><span class="line"> |   <span class="type">ParallelCollectionRDD</span>[<span class="number">30</span>] at parallelize at &lt;pastie&gt;:<span class="number">25</span> []</span><br><span class="line"> |   <span class="type">ParallelCollectionRDD</span>[<span class="number">31</span>] at parallelize at &lt;pastie&gt;:<span class="number">26</span> []</span><br><span class="line"> |   <span class="type">MapPartitionsRDD</span>[<span class="number">33</span>] at map at &lt;pastie&gt;:<span class="number">28</span> []</span><br><span class="line"> |   <span class="type">ParallelCollectionRDD</span>[<span class="number">30</span>] at parallelize at &lt;pastie&gt;:<span class="number">25</span> []</span><br><span class="line"> |   <span class="type">ZippedPartitionsRDD2</span>[<span class="number">34</span>] at zip at &lt;pastie&gt;:<span class="number">29</span> []</span><br><span class="line"> |   <span class="type">ParallelCollectionRDD</span>[<span class="number">30</span>] at parallelize at &lt;pastie&gt;:<span class="number">25</span> []</span><br><span class="line"> |   <span class="type">ParallelCollectionRDD</span>[<span class="number">31</span>] at parallelize at &lt;pastie&gt;:<span class="number">26</span> []</span><br><span class="line"> |   <span class="type">MapPartitionsRDD</span>[<span class="number">35</span>] at keyBy at &lt;pastie&gt;:<span class="number">30</span> []</span><br><span class="line"> |   <span class="type">ParallelCollectionRDD</span>[<span class="number">31</span>] at parallelize at &lt;pastie&gt;:<span class="number">26</span> []</span><br></pre></td></tr></table></figure>

<p>ä¸åŒçš„RDDä»£è¡¨ç€ä¸åŒçš„â€˜è®¡ç®—æ¨¡å¼â€™ï¼š<br>MapPartitionsRDDï¼Œå¯¹Iteratorçš„æ¯ä¸ªå€¼åº”ç”¨ç›¸åŒçš„å‡½æ•°ï¼›</p>
<p>ShuffledRDDï¼Œå¯¹Iteratoræ‰§è¡ŒcombineByKeyçš„æ¨¡å¼ï¼Œå¯ä»¥æŒ‡å®š<br><code> createCombiner: V =&gt; C,mergeValue: (C, V) =&gt; C, mergeCombiners: (C, C) =&gt; C</code>, computeå‡½æ•°è¿”å›ShuffleReaderç”Ÿæˆçš„è¿­ä»£å™¨ã€‚</p>
<h2 id="MapPartitionsRDD"><a href="#MapPartitionsRDD" class="headerlink" title="MapPartitionsRDD"></a>MapPartitionsRDD</h2><p>MapPartitionsRDDå¯¹äºçˆ¶RDDçš„ä¾èµ–ç±»å‹åªèƒ½æ˜¯OneToOneDependencyï¼Œä»£è¡¨å°†å‡½æ•°åº”ç”¨åˆ°æ¯ä¸€ä¸ªåˆ†åŒºçš„è®¡ç®—ã€‚</p>
<p>ç›¸å…³transformationï¼šmap, flatMap, filter, mapPartitionsç­‰ç­‰</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">scala&gt; sc.parallelize(<span class="number">0</span> to <span class="number">10000</span>).map(x=&gt;(x%<span class="number">9</span>,<span class="number">1</span>)).dependencies</span><br><span class="line">res35: <span class="type">Seq</span>[org.apache.spark.<span class="type">Dependency</span>[_]] = <span class="type">List</span>(org.apache.spark.<span class="type">OneToOneDependency</span>@<span class="number">7</span>c6843f)</span><br></pre></td></tr></table></figure>

<h2 id="ShuffledRDD"><a href="#ShuffledRDD" class="headerlink" title="ShuffledRDD"></a>ShuffledRDD</h2><p>å¯¹äºçˆ¶RDDçš„ä¾èµ–ç±»å‹åªèƒ½æ˜¯ShuffleDependencyï¼Œä»£è¡¨éœ€è¦æ”¹å˜åˆ†åŒºæ–¹å¼è¿›è¡Œshuffleçš„è®¡ç®—ã€‚</p>
<p>ä¼šåˆ›å»ºShuffledRDDçš„transformationï¼š<br>RDDï¼šcoalesce<br>PairRDDFunctionsï¼š reduceByKey, combineByKeyWithClassTag ï¼Œ partitionBy (åˆ†åŒºæ–¹å¼ä¸åŒæ—¶) ç­‰<br>OrderedRDDFunctionsï¼š sortByKeyï¼Œ repartitionAndSortWithinPartitions </p>
<h1 id="RDD-Checkpoint"><a href="#RDD-Checkpoint" class="headerlink" title="RDD Checkpoint"></a>RDD Checkpoint</h1><p>Checkpointæ£€æŸ¥ç‚¹ï¼Œæ˜¯ä¸€ç§æˆªæ–­RDDä¾èµ–é“¾ï¼Œå¹¶æŠŠRDDæ•°æ®æŒä¹…åŒ–åˆ°å­˜å‚¨ç³»ç»Ÿ(é€šå¸¸æ˜¯HDFSæˆ–æœ¬åœ°)çš„è¿‡ç¨‹ã€‚<br>ä¸»è¦ä½œç”¨æ˜¯æˆªæ–­RDDä¾èµ–å…³ç³»ï¼Œé˜²æ­¢stack overflow(ä¸DAGé€’å½’è°ƒç”¨æœ‰å…³)ã€‚<br>å­˜å‚¨çš„æ•°æ®åŒ…æ‹¬RDDè®¡ç®—åçš„æ•°æ®å’Œpartitionerã€‚</p>
<p>Checkpointåˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>reliable ï¼šè°ƒç”¨å‡½æ•°ä¸ºRDD.checkpoint()ï¼Œæ•°æ®ä¿å­˜åˆ°å¯é å­˜å‚¨HDFSï¼ŒRDDçš„parentæ›¿æ¢ä¸ºReliableCheckpointRDDï¼›</li>
<li>localï¼šè°ƒç”¨å‡½æ•°ä¸ºRDD.localCheckpoint()ï¼Œæ•°æ®ä¿å­˜åˆ°spark cacheä¸­(ä¸æ˜¯æœ¬åœ°)ï¼ŒRDDçš„parentæ›¿æ¢ä¸ºLocalCheckpointRDDã€‚å½“executoræŒ‚æ‰ï¼Œæ•°æ®ä¼šä¸¢å¤±ã€‚</li>
</ul>
<p>æ³¨æ„ï¼šä¸streamingä¸­çš„checkpointingä¸åŒï¼Œstreamingä¸­çš„checkpointingä¼šåŒæ—¶ä¿å­˜å…ƒæ•°æ®å’ŒRDDæ•°æ®ï¼Œå¯ä»¥ç”¨äºApplicationå®¹é”™ã€‚</p>
<h2 id="å¦‚ä½•ä½¿ç”¨-1"><a href="#å¦‚ä½•ä½¿ç”¨-1" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h2><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">scala&gt; :paste</span><br><span class="line"><span class="comment">// Entering paste mode (ctrl-D to finish)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> a=sc.parallelize(<span class="number">0</span> to <span class="number">9</span>)</span><br><span class="line"><span class="keyword">val</span> b=a.map(_*<span class="number">10</span>)</span><br><span class="line"><span class="keyword">val</span> c=b.filter(_&gt;<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Exiting paste mode, now interpreting.</span></span><br><span class="line"></span><br><span class="line">a: org.apache.spark.rdd.<span class="type">RDD</span>[<span class="type">Int</span>] = <span class="type">ParallelCollectionRDD</span>[<span class="number">0</span>] at parallelize at &lt;console&gt;:<span class="number">24</span></span><br><span class="line">b: org.apache.spark.rdd.<span class="type">RDD</span>[<span class="type">Int</span>] = <span class="type">MapPartitionsRDD</span>[<span class="number">1</span>] at map at &lt;console&gt;:<span class="number">25</span></span><br><span class="line">c: org.apache.spark.rdd.<span class="type">RDD</span>[<span class="type">Int</span>] = <span class="type">MapPartitionsRDD</span>[<span class="number">2</span>] at filter at &lt;console&gt;:<span class="number">26</span></span><br><span class="line"></span><br><span class="line">scala&gt; c.toDebugString</span><br><span class="line">res0: <span class="type">String</span> =</span><br><span class="line">(<span class="number">4</span>) <span class="type">MapPartitionsRDD</span>[<span class="number">2</span>] at filter at &lt;console&gt;:<span class="number">26</span> []</span><br><span class="line"> |  <span class="type">MapPartitionsRDD</span>[<span class="number">1</span>] at map at &lt;console&gt;:<span class="number">25</span> []</span><br><span class="line"> |  <span class="type">ParallelCollectionRDD</span>[<span class="number">0</span>] at parallelize at &lt;console&gt;:<span class="number">24</span> []</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">scala&gt; sc.setCheckpointDir(<span class="string">&quot;/tmp/spark-checkpoint&quot;</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; b.checkpoint</span><br><span class="line"></span><br><span class="line">scala&gt; b.count</span><br><span class="line">res4: <span class="type">Long</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">scala&gt; c.toDebugString</span><br><span class="line">res5: <span class="type">String</span> =</span><br><span class="line">(<span class="number">4</span>) <span class="type">MapPartitionsRDD</span>[<span class="number">2</span>] at filter at &lt;console&gt;:<span class="number">26</span> []</span><br><span class="line"> |  <span class="type">MapPartitionsRDD</span>[<span class="number">1</span>] at map at &lt;console&gt;:<span class="number">25</span> []</span><br><span class="line"> |  <span class="type">ReliableCheckpointRDD</span>[<span class="number">3</span>] at count at &lt;console&gt;:<span class="number">26</span> []</span><br><span class="line"> </span><br><span class="line">scala&gt; b.toDebugString</span><br><span class="line">res6: <span class="type">String</span> =</span><br><span class="line">(<span class="number">4</span>) <span class="type">MapPartitionsRDD</span>[<span class="number">1</span>] at map at &lt;console&gt;:<span class="number">25</span> []</span><br><span class="line"> |  <span class="type">ReliableCheckpointRDD</span>[<span class="number">3</span>] at count at &lt;console&gt;:<span class="number">26</span> [] </span><br><span class="line"> </span><br><span class="line"><span class="comment">//local </span></span><br><span class="line">scala&gt; c.localCheckpoint</span><br><span class="line">scala&gt; c.count</span><br><span class="line">res9: <span class="type">Long</span> = <span class="number">8</span></span><br><span class="line"></span><br><span class="line">scala&gt; c.toDebugString</span><br><span class="line">res10: <span class="type">String</span> =</span><br><span class="line">(<span class="number">4</span>) <span class="type">MapPartitionsRDD</span>[<span class="number">2</span>] at filter at &lt;console&gt;:<span class="number">26</span> [<span class="type">Disk</span> <span class="type">Memory</span> <span class="type">Deserialized</span> <span class="number">1</span>x <span class="type">Replicated</span>]</span><br><span class="line"> |       <span class="type">CachedPartitions</span>: <span class="number">4</span>; <span class="type">MemorySize</span>: <span class="number">104.0</span> <span class="type">B</span>; <span class="type">ExternalBlockStoreSize</span>: <span class="number">0.0</span> <span class="type">B</span>; <span class="type">DiskSize</span>: <span class="number">0.0</span> <span class="type">B</span></span><br><span class="line"> |  <span class="type">LocalCheckpointRDD</span>[<span class="number">4</span>] at count at &lt;console&gt;:<span class="number">26</span> [<span class="type">Disk</span> <span class="type">Memory</span> <span class="type">Deserialized</span> <span class="number">1</span>x <span class="type">Replicated</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹HDFSä¸Šå­˜å‚¨çš„checkpointæ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hdfs dfs -ls /tmp/spark-checkpoint/74acd422-2693-4f47-b786-69b4f8dc33ad/rdd-1</span><br><span class="line">Found 4 items</span><br><span class="line">-rw-r--r--   2 ld-liuyuan_su hdfs         91 2019-10-09 08:40 /tmp/spark-checkpoint/74acd422-2693-4f47-b786-69b4f8dc33ad/rdd-1/part-00000</span><br><span class="line">-rw-r--r--   2 ld-liuyuan_su hdfs        101 2019-10-09 08:40 /tmp/spark-checkpoint/74acd422-2693-4f47-b786-69b4f8dc33ad/rdd-1/part-00001</span><br><span class="line">-rw-r--r--   2 ld-liuyuan_su hdfs         91 2019-10-09 08:40 /tmp/spark-checkpoint/74acd422-2693-4f47-b786-69b4f8dc33ad/rdd-1/part-00002</span><br><span class="line">-rw-r--r--   2 ld-liuyuan_su hdfs        101 2019-10-09 08:40 /tmp/spark-checkpoint/74acd422-2693-4f47-b786-69b4f8dc33ad/rdd-1/part-00003</span><br></pre></td></tr></table></figure>


<h1 id="RDD-Cache"><a href="#RDD-Cache" class="headerlink" title="RDD Cache"></a>RDD Cache</h1><p>Cacheæœºåˆ¶æ˜¯Sparkæä¾›çš„ä¸€ç§å°†æ•°æ®ç¼“å­˜åˆ°å†…å­˜(æˆ–ç£ç›˜)çš„æœºåˆ¶ï¼Œ<br>ä¸»è¦ç”¨é€”æ˜¯ä½¿å¾—ä¸­é—´è®¡ç®—ç»“æœå¯ä»¥è¢«é‡ç”¨ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191022163225.png" alt="20191022163225.png"></p>
<p>å¸¸è§çš„ä½¿ç”¨åœºæ™¯æœ‰å¦‚ä¸‹å‡ ç§ï¼Œåº•å±‚éƒ½æ˜¯è°ƒç”¨RDDçš„cacheï¼Œè¿™é‡Œåªè®²RDDçš„cacheã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rdd.cache()</span><br><span class="line">dataset.cache()</span><br><span class="line">spark.sql(&quot;cache table test.test&quot;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Sparkçš„Cacheä¸ä»…èƒ½å°†æ•°æ®ç¼“å­˜åˆ°å†…å­˜ï¼Œä¹Ÿèƒ½ä½¿ç”¨ç£ç›˜ï¼Œç”šè‡³åŒæ—¶ä½¿ç”¨å†…å­˜å’Œç£ç›˜ï¼Œè¿™ç§ç¼“å­˜çš„ä¸åŒå­˜å‚¨æ–¹å¼ï¼Œç§°ä½œâ€˜StorageLevel(å­˜å‚¨çº§åˆ«)â€™ã€‚</p>
<p>å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š<code>rdd.persist(StorageLevel.MEMORY_ONLY)</code>ã€‚</p>
<p>Sparkç›®å‰æ”¯æŒçš„å­˜å‚¨çº§åˆ«å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NONE (default)</span><br><span class="line">DISK_ONL</span><br><span class="line">DISK_ONLY_2</span><br><span class="line">MEMORY_ONLY (cacheæ“ä½œä½¿ç”¨çš„çº§åˆ«)</span><br><span class="line">MEMORY_ONLY_2</span><br><span class="line">MEMORY_ONLY_SER</span><br><span class="line">MEMORY_ONLY_SER_2</span><br><span class="line">MEMORY_AND_DISK</span><br><span class="line">MEMORY_AND_DISK_2</span><br><span class="line">MEMORY_AND_DISK_SER</span><br><span class="line">MEMORY_AND_DISK_SER_2</span><br><span class="line">OFF_HEAP</span><br></pre></td></tr></table></figure>

<p><code>2</code>ä»£è¡¨å­˜å‚¨ä»½æ•°ä¸º2ï¼Œä¹Ÿå°±æ˜¯æœ‰ä¸ªå¤‡ä»½å­˜å‚¨ã€‚<br><code>SER</code>ä»£è¡¨å­˜å‚¨åºåˆ—åŒ–åçš„æ•°æ®ã€‚</p>
<p>DISK_ONLYåé¢æ²¡è·ŸSERï¼Œä½†å…¶å®åªèƒ½æ˜¯å­˜å‚¨åºåˆ—åŒ–åçš„æ•°æ®ã€‚</p>
<p>è¦cache RDD,å¸¸ç”¨åˆ°ä¸¤ä¸ªå‡½æ•°, <code>cache()</code>å’Œ<code>persist()</code>ï¼Œcacheæ–¹æ³•æœ¬è´¨ä¸Šæ˜¯<code>persist(StorageLevel.MEMORY_ONLY)</code>ï¼Œä¹Ÿå°±æ˜¯è¯´persistå¯ä»¥æŒ‡å®šStorageLevelï¼Œè€Œcacheä¸è¡Œã€‚</p>
<h3 id="Checkpoint-vs-Cache"><a href="#Checkpoint-vs-Cache" class="headerlink" title="Checkpoint vs Cache"></a>Checkpoint vs Cache</h3><ul>
<li>Cacheç”¨äºç¼“å­˜ï¼Œé‡‡ç”¨ä¸´æ—¶ä¿å­˜ï¼ŒExecutoræŒ‚æ‰ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œä½†æ˜¯æ•°æ®å¯ä»¥é‡æ–°è®¡ç®—ã€‚</li>
<li>Checkpointç”¨äºæˆªæ–­ä¾èµ–é“¾ï¼Œreliableæ–¹å¼ä¸‹ExecutoræŒ‚æ‰ä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œæ•°æ®ä¸€æ—¦ä¸¢å¤±ä¸å¯æ¢å¤ã€‚</li>
</ul>
<h1 id="RDD-Broadcast"><a href="#RDD-Broadcast" class="headerlink" title="RDD Broadcast"></a>RDD Broadcast</h1><p>ä¸€ç§å°†æ•°æ®åœ¨ä¸åŒèŠ‚ç‚¹é—´å…±äº«çš„æœºåˆ¶ï¼Œå¯ä»¥å°†æŒ‡å®šçš„<strong>åªè¯»</strong>æ•°æ®å¹¿æ’­åˆ†å‘åˆ°æ¯ä¸ªExecutorï¼Œæ¯ä¸ªExecutoræœ‰ä¸€ä»½å®Œæ•´çš„å¤‡ä»½ã€‚</p>
<p>æ˜¯ä¸€ç§é«˜æ•ˆçš„æ•°æ®å…±äº«æœºåˆ¶ï¼Œè¢«å¹¿æ’­çš„æ•°æ®å¯ä»¥è¢«ä¸åŒçš„stageå’Œtaskå…±äº«ï¼Œè€Œä¸éœ€è¦ç»™æ¯ä¸ªtaskæ‹·è´ä¸€ä»½ã€‚</p>
<p>Broadcastæœºåˆ¶æœ‰ä¸ªéå¸¸é‡è¦çš„ä½œç”¨ï¼ŒSparkå°±æ˜¯é€šè¿‡å®ƒå°†taskåˆ†å‘ç»™å„ä¸ªExecutorã€‚</p>
<p>ä¸‹é¢ä¸¾ä¸ªä½¿ç”¨çš„ä¾‹å­</p>
<p>rddA</p>
<table>
<thead>
<tr>
<th>k</th>
<th>low</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>a</td>
</tr>
<tr>
<td>2</td>
<td>b</td>
</tr>
<tr>
<td>3</td>
<td>c</td>
</tr>
</tbody></table>
<p>rddB</p>
<table>
<thead>
<tr>
<th>k</th>
<th>up</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>A</td>
</tr>
<tr>
<td>2</td>
<td>B</td>
</tr>
<tr>
<td>3</td>
<td>C</td>
</tr>
</tbody></table>
<p>rddAB</p>
<table>
<thead>
<tr>
<th>k</th>
<th>low</th>
<th>up</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>a</td>
<td>A</td>
</tr>
<tr>
<td>2</td>
<td>b</td>
<td>B</td>
</tr>
<tr>
<td>3</td>
<td>c</td>
<td>C</td>
</tr>
</tbody></table>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">scala&gt; <span class="keyword">val</span> rddA=sc.parallelize(<span class="type">List</span>((<span class="number">1</span>,<span class="string">&quot;a&quot;</span>),(<span class="number">2</span>,<span class="string">&quot;b&quot;</span>),(<span class="number">3</span>,<span class="string">&quot;c&quot;</span>)))</span><br><span class="line">rddA: org.apache.spark.rdd.<span class="type">RDD</span>[(<span class="type">Int</span>, <span class="type">String</span>)] = <span class="type">ParallelCollectionRDD</span>[<span class="number">5</span>] at parallelize at &lt;console&gt;:<span class="number">24</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rddB=sc.parallelize(<span class="type">List</span>((<span class="number">1</span>,<span class="string">&quot;A&quot;</span>),(<span class="number">2</span>,<span class="string">&quot;B&quot;</span>),(<span class="number">3</span>,<span class="string">&quot;C&quot;</span>)))</span><br><span class="line">rddB: org.apache.spark.rdd.<span class="type">RDD</span>[(<span class="type">Int</span>, <span class="type">String</span>)] = <span class="type">ParallelCollectionRDD</span>[<span class="number">6</span>] at parallelize at &lt;console&gt;:<span class="number">24</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rddAB=rddA.join(rddB)</span><br><span class="line">rddAB: org.apache.spark.rdd.<span class="type">RDD</span>[(<span class="type">Int</span>, (<span class="type">String</span>, <span class="type">String</span>))] = <span class="type">MapPartitionsRDD</span>[<span class="number">9</span>] at join at &lt;console&gt;:<span class="number">27</span></span><br><span class="line"></span><br><span class="line">scala&gt; rddAB.collect</span><br><span class="line">res11: <span class="type">Array</span>[(<span class="type">Int</span>, (<span class="type">String</span>, <span class="type">String</span>))] = <span class="type">Array</span>((<span class="number">1</span>,(a,<span class="type">A</span>)), (<span class="number">2</span>,(b,<span class="type">B</span>)), (<span class="number">3</span>,(c,<span class="type">C</span>)))</span><br><span class="line"></span><br><span class="line">scala&gt; rddAB.toDebugString</span><br><span class="line">res12: <span class="type">String</span> =</span><br><span class="line">(<span class="number">4</span>) <span class="type">MapPartitionsRDD</span>[<span class="number">9</span>] at join at &lt;console&gt;:<span class="number">27</span> []</span><br><span class="line"> |  <span class="type">MapPartitionsRDD</span>[<span class="number">8</span>] at join at &lt;console&gt;:<span class="number">27</span> []</span><br><span class="line"> |  <span class="type">CoGroupedRDD</span>[<span class="number">7</span>] at join at &lt;console&gt;:<span class="number">27</span> []</span><br><span class="line"> +-(<span class="number">4</span>) <span class="type">ParallelCollectionRDD</span>[<span class="number">5</span>] at parallelize at &lt;console&gt;:<span class="number">24</span> []</span><br><span class="line"> +-(<span class="number">4</span>) <span class="type">ParallelCollectionRDD</span>[<span class="number">6</span>] at parallelize at &lt;console&gt;:<span class="number">24</span> []</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rddBMap=sc.broadcast(rddB.collectAsMap)</span><br><span class="line">rddBMap: org.apache.spark.broadcast.<span class="type">Broadcast</span>[scala.collection.<span class="type">Map</span>[<span class="type">Int</span>,<span class="type">String</span>]] = <span class="type">Broadcast</span>(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rddABMapJoin= rddA.map&#123;<span class="keyword">case</span>(k,v) =&gt; (k,(v,rddBMap.value.get(k).get))&#125;</span><br><span class="line">rddABMapJoin: org.apache.spark.rdd.<span class="type">RDD</span>[(<span class="type">Int</span>, (<span class="type">String</span>, <span class="type">String</span>))] = <span class="type">MapPartitionsRDD</span>[<span class="number">10</span>] at map at &lt;console&gt;:<span class="number">27</span></span><br><span class="line"></span><br><span class="line">scala&gt; rddABMapJoin.collect</span><br><span class="line">res13: <span class="type">Array</span>[(<span class="type">Int</span>, (<span class="type">String</span>, <span class="type">String</span>))] = <span class="type">Array</span>((<span class="number">1</span>,(a,<span class="type">A</span>)), (<span class="number">2</span>,(b,<span class="type">B</span>)), (<span class="number">3</span>,(c,<span class="type">C</span>)))</span><br><span class="line"></span><br><span class="line">scala&gt; rddABMapJoin.toDebugString</span><br><span class="line">res14: <span class="type">String</span> =</span><br><span class="line">(<span class="number">4</span>) <span class="type">MapPartitionsRDD</span>[<span class="number">10</span>] at map at &lt;console&gt;:<span class="number">27</span> []</span><br><span class="line"> |  <span class="type">ParallelCollectionRDD</span>[<span class="number">5</span>] at parallelize at &lt;console&gt;:<span class="number">24</span> []</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡broadcastæœºåˆ¶ï¼Œå°†åŸæœ¬çš„ä¸¤ä¸ªstageè®¡ç®—å‡å°‘ä¸º1ä¸ªstageã€‚<br>è¿™é‡Œæ¨¡æ‹Ÿå®ç°äº†map-side joinã€‚</p>
<h2 id="Broadcast-VS-Cache"><a href="#Broadcast-VS-Cache" class="headerlink" title="Broadcast VS Cache"></a>Broadcast VS Cache</h2><p>Cacheä¹Ÿä¼šæŠŠæ•°æ®åˆ†å‘åˆ°å„ä¸ªèŠ‚ç‚¹ï¼Œä½†æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šé€šå¸¸åªæœ‰éƒ¨åˆ†åˆ†åŒºçš„æ•°æ®ï¼Œè€ŒBroadcastä¼šä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å®Œæ•´çš„æ•°æ®ã€‚<br>Broadcastä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ï¼Œä½†æ˜¯å¸¦æ¥äº†æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<h1 id="RDD-Accumulators"><a href="#RDD-Accumulators" class="headerlink" title="RDD Accumulators"></a>RDD Accumulators</h1><p>Broadcastæœºåˆ¶æœ‰ä¸ªçŸ­æ¿ï¼Œå®ƒçš„å˜é‡æ˜¯åªè¯»çš„ï¼Œäºæ˜¯Sparkæä¾›äº†Accumulators(ç´¯åŠ å™¨)æ¥å¼¥è¡¥ã€‚</p>
<p>Accumulatorçš„å€¼å¯ä»¥å¢å‡ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥ä¿®æ”¹ä¸ºæŒ‡å®šå€¼ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">scala&gt; <span class="keyword">val</span> acc=sc.longAccumulator</span><br><span class="line">acc: org.apache.spark.util.<span class="type">LongAccumulator</span> = <span class="type">LongAccumulator</span>(id: <span class="number">200</span>, name: <span class="type">None</span>, value: <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; rddA.map(_=&gt;acc.add(<span class="number">-1</span>)).count</span><br><span class="line">res15: <span class="type">Long</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">scala&gt; acc.value</span><br><span class="line">res17: <span class="type">Long</span> = <span class="number">-3</span></span><br></pre></td></tr></table></figure>

<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://vishnuviswanath.com/spark_rdd.html">Spark RDDs Simplified</a></p>
<p><a href="https://techmagie.wordpress.com/2015/12/19/understanding-spark-partitioning/">Understanding Spark Partitioning</a></p>
<p><a href="https://jaceklaskowski.gitbooks.io/mastering-apache-spark/spark-rdd-checkpointing.html">Checkpointing</a></p>
<p><a href="https://book.douban.com/subject/30157181/">Sparkå†…æ ¸è®¾è®¡çš„è‰ºæœ¯</a></p>
<p>è½¬è½½è¯·æ³¨æ˜åŸæ–‡åœ°å€ï¼š<a href="https://liam-blog.ml/2019/10/23/spark-core-rdd/">https://liam-blog.ml/2019/10/23/spark-core-rdd/</a></p>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>Spark Core</tag>
      </tags>
  </entry>
  <entry>
    <title>Spark Core è§£æ 4ï¼šå†…å­˜æ¨¡å‹</title>
    <url>/2020/02/29/spark-core-memory/</url>
    <content><![CDATA[<h2 id="Sparkå†…å­˜æ¨¡å‹"><a href="#Sparkå†…å­˜æ¨¡å‹" class="headerlink" title="Sparkå†…å­˜æ¨¡å‹"></a>Sparkå†…å­˜æ¨¡å‹</h2><p>Sparkä¹‹æ‰€ä»¥å¿«ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å› ä¸ºå®ƒå–„äºåˆ©ç”¨å†…å­˜ï¼Œå¤§é‡åˆ©ç”¨å†…å­˜è¿›è¡Œå­˜å‚¨å’Œè®¡ç®—ï¼Œä»è€Œå‡å°‘ç£ç›˜IOï¼Œæå‡æ‰§è¡Œæ•ˆç‡ã€‚</p>
<p>ä»1.6ç‰ˆæœ¬å¼€å§‹ï¼ŒSparkå¼•å…¥äº†ç»Ÿä¸€å†…å­˜ç®¡ç†æ¨¡å‹ï¼ˆä¹‹å‰ç‰ˆæœ¬åªæœ‰é™æ€å†…å­˜ç®¡ç†ï¼Œè¿™é‡Œä¸ç»†è¯´ï¼‰ï¼Œæ‰¾åˆ°ä¸¤å¼ å›¾æè¿°çš„å¾ˆæ¸…æ¥šï¼š</p>
<span id="more"></span>

<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/spark-mem-on-heap.png" alt="spark-mem-on-heap.png"></p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/spark-mem-off-heap.png" alt="spark-mem-off-heap.png"></p>
<p>ä¸ºä»€ä¹ˆæœ‰ä¸¤å¼ å›¾å‘¢ï¼Œå› ä¸ºSparkæ—¢èƒ½ä½¿ç”¨JVMå †å†…å­˜(on-heap)ï¼Œä¹Ÿèƒ½ä½¿ç”¨å †å¤–å†…å­˜(off-heap)ï¼Œä¸¤å¼ å›¾åˆ†åˆ«æè¿°çš„æ˜¯è¿™ä¸¤å—å†…å­˜çš„æƒ…å†µã€‚å›¾ä¸­å·²ç»æŠŠSparkå¯¹å†…å­˜å®¹é‡çš„åˆ’åˆ†å¾ˆå½¢è±¡çš„è¯´æ˜äº†ï¼Œç½‘ä¸Šç›¸å…³æ–‡ç« ä¹Ÿä¸å°‘ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<h2 id="å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹"><a href="#å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹" class="headerlink" title="å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹"></a>å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹</h2><ul>
<li><p>Storageä¸ExecutionåŒºåŸŸä¹‹é—´çš„è™šçº¿ï¼Œä»£è¡¨Storageä¸Executionå†…å­˜çš„å®¹é‡æ˜¯å¯ä»¥åŠ¨æ€å˜åŒ–çš„ï¼Œæ¯”å¦‚Storageå†…å­˜ä¸è¶³çš„æ—¶å€™ï¼Œå¯ä»¥å ç”¨Executionçš„å†…å­˜ã€‚ä½†æ˜¯ï¼Œon-heapä¸­çš„Storageä¸å¯ä»¥å ç”¨off-heapä¸­çš„Executionå†…å­˜ï¼Œå› ä¸ºon-heapåŠoff-heapæ•´ä¸ªçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œæ²¡æ³•äº’ç›¸å ç”¨ã€‚</p>
</li>
<li><p>Storageä¸Executionç©ºé—´éƒ½ä¸è¶³æ—¶ï¼Œéƒ½éœ€è¦æº¢å†™è‡³ç£ç›˜ï¼›Executionç©ºé—´ä¸è¶³æ—¶ï¼Œè‹¥æœ‰ç©ºé—´è¢«Storageå€Ÿç”¨ï¼Œè¯¥ç©ºé—´å¯ä»¥é€šè¿‡æ·˜æ±°æˆ–è½¬å­˜ç£ç›˜çš„æ–¹å¼å½’è¿˜ï¼›Storageç©ºé—´ä¸è¶³æ—¶ï¼Œè‹¥æœ‰ç©ºé—´è¢«Executionå€Ÿç”¨ï¼Œåˆ™æ— æ³•ç«‹å³å½’è¿˜ï¼Œåªèƒ½ç­‰å¾…ç”¨å®Œé‡Šæ”¾ã€‚</p>
</li>
<li><p>Sparkå¯¹å †å†…å†…å­˜çš„ç®¡ç†æ˜¯ä¸€ç§é€»è¾‘ä¸Šçš„â€è§„åˆ’å¼â€çš„ç®¡ç†ï¼Œå› ä¸ºå¯¹è±¡å®ä¾‹å ç”¨å†…å­˜çš„ç”³è¯·å’Œé‡Šæ”¾éƒ½ç”±JVMå®Œæˆï¼ŒSparkåªèƒ½åœ¨ç”³è¯·åå’Œé‡Šæ”¾å‰è®°å½•è¿™äº›å†…å­˜ã€‚è¯´ç™½äº†Sparkåªæ˜¯ä¸ªè®°è´¦çš„ï¼Œè®°å½•æ¯æ¬¡ç”³è¯·äº†å¤šå°‘å†…å­˜ï¼Œå°±èƒ½ç®—å‡ºè¿˜å‰©å¤šå°‘å†…å­˜ã€‚ç„¶é¹…è¿™ä¸ªå†…å­˜çš„å¸å¹¶ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ç²¾ç¡®è®°å½•çš„ï¼Œå¾€å¾€ä¼šå¯¹ä¸ä¸Šå¸ã€‚é¦–å…ˆï¼Œå¯¹äºoff-heapå †å¤–å†…å­˜æ¥è¯´ï¼Œå†…å­˜å¯ä»¥æ¯”è¾ƒç²¾ç¡®åœ°ç”³è¯·å’Œé‡Šæ”¾ï¼Œé—®é¢˜ä¸å¤§ã€‚å¯¹äºon-heapå†…å­˜æ¥è¯´ï¼Œåºåˆ—åŒ–çš„å¯¹è±¡å¯ä»¥ç²¾ç¡®è®¡ç®—å¤§å°ï¼Œä½†éåºåˆ—åŒ–çš„å¯¹è±¡å°±åªèƒ½ä¼°ç®—äº†(å‡ºäºæ€§èƒ½è€ƒè™‘)ï¼Œæ‰€ä»¥å­˜åœ¨è®°è´¦çš„å†…å­˜å¤§å°ä¸å‡†çš„æƒ…å†µã€‚å¦å¤–ï¼Œon-heapå†…å­˜çš„å›æ”¶æ˜¯JVMè‡ªåŠ¨è¿›è¡Œçš„ï¼Œè´¦æœ¬ä¸Šé‡Šæ”¾æ‰çš„å†…å­˜ç©ºé—´ï¼Œä¸ä¸€å®šå·²ç»è¢«å›æ”¶ã€‚å› ä¸ºè®°è´¦çš„ä¸å‡†ï¼Œæ‰€ä»¥å³ä½¿è¿›è¡Œäº†å†…å­˜ç®¡ç†è¿˜æ˜¯ä¼šæœ‰OOMçš„é£é™©ã€‚</p>
</li>
</ul>
<h2 id="ç»Ÿä¸€å†…å­˜æ¨¡å‹çš„å®ç°"><a href="#ç»Ÿä¸€å†…å­˜æ¨¡å‹çš„å®ç°" class="headerlink" title="ç»Ÿä¸€å†…å­˜æ¨¡å‹çš„å®ç°"></a>ç»Ÿä¸€å†…å­˜æ¨¡å‹çš„å®ç°</h2><p>æ ¸å¿ƒçš„å®ç°ç±»æ˜¯UnifiedMemoryManagerï¼Œå…¶ä¸­ç»´æŠ¤äº†4ä¸ªå†…å­˜è´¦æœ¬ï¼š<br>onHeapStorageMemoryPoolï¼ŒoffHeapStorageMemoryPoolï¼ŒonHeapExecutionMemoryPoolï¼ŒoffHeapExecutionMemoryPoolï¼Œ<br>åˆ†åˆ«å¯¹åº”å•¥ä¸€çœ‹åå­—å°±çŸ¥é“äº†ã€‚</p>
<p>è™½ç„¶ä»–ä»¬å«MemoryPoolï¼Œè¿˜æä¾›äº†releaseMemoryã€acquireMemoryä¹‹ç±»çš„æ–¹æ³•ï¼Œçœ‹ä¸Šå»æŒºè™ï¼Œä½†å®é™…ä¸Šåªæ˜¯è®°å½•å·²ç”¨å†…å­˜å¤§å°ï¼Œè¿›è¡Œæ•°å€¼ä¸Šçš„åŠ åŠ å‡å‡è€Œå·²ã€‚è€ŒStorageä¸Executionå†…å­˜çš„äº’ç›¸å€Ÿç”¨ï¼Œå…¶å®åªæ˜¯è´¦æœ¬MemoryPoolå¤§å°æ•°å€¼çš„è°ƒæ•´è€Œå·²ã€‚</p>
<h2 id="Executionæ‰§è¡Œå†…å­˜"><a href="#Executionæ‰§è¡Œå†…å­˜" class="headerlink" title="Executionæ‰§è¡Œå†…å­˜"></a>Executionæ‰§è¡Œå†…å­˜</h2><p>æ¯ä¸ªExecutoræœ‰ä¸€ä¸ªMemoryManagerï¼Œç”¨æ¥ç®¡ç†è¯¥ExecutorèŠ‚ç‚¹çš„å†…å­˜ï¼›<br>æ¯ä¸ªTaskAtemptéƒ½æœ‰ä¸€ä¸ªTaskMemoryMangerç®¡ç†å•æ¬¡Taskæ‰§è¡Œçš„å†…å­˜ï¼›<br>æ¯ä¸ªTaskMemoryMangerå¯¹å½“å‰TaskAtemptä¸­çš„å¤šä¸ªMemoryConsumerè¿›è¡Œç®¡ç†ï¼Œè´Ÿè´£åˆ†é…å†…å­˜ç»™MemoryConsumerï¼›<br>MemoryConsumerå°±æ˜¯Sparkä¸­æœ€ç»ˆçš„æ‰§è¡Œå†…å­˜æ¶ˆè´¹è€…ï¼Œæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ¯”è¾ƒå…¸å‹çš„å®ç°ç±»æœ‰ExternalAppendOnlyMapã€ShuffleExternalSorterã€ExternalSorterç­‰ï¼Œä¸éš¾å‘ç°è¿™äº›ç±»éƒ½æ˜¯ä¸shuffleç›¸å…³çš„ï¼ˆè¿˜æœ‰ä¸€äº›å®ç°ç±»æ˜¯Spark SQLç›¸å…³çš„ï¼‰ï¼Œä¹Ÿå³æ˜¯è¯´æ‰§è¡Œå†…å­˜åŸºæœ¬å°±æ˜¯shuffleä½¿ç”¨çš„å†…å­˜ã€‚</p>
<p>Shuffleç›¸å…³å¯ä»¥å‚è€ƒ<a href="https://liam-blog.ml/2019/12/29/spark-core-shuffle/">Spark Core è§£æ 3ï¼šShuffle</a></p>
<h2 id="Storageå­˜å‚¨å†…å­˜"><a href="#Storageå­˜å‚¨å†…å­˜" class="headerlink" title="Storageå­˜å‚¨å†…å­˜"></a>Storageå­˜å‚¨å†…å­˜</h2><p>ä¸»è¦ç”¨äºå­˜å‚¨cacheå’Œbroadcastçš„æ•°æ®ï¼Œä¸ºSparkçš„å­˜å‚¨ä½“ç³»æœåŠ¡ã€‚<br>ä»‹ç»å­˜å‚¨ä½“ç³»çš„æ—¶å€™å†ç»†è¯´ã€‚</p>
<h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><p><a href="https://www.ibm.com/developerworks/cn/analytics/library/ba-cn-apache-spark-memory-management/index.html">Apache Spark å†…å­˜ç®¡ç†è¯¦è§£</a></p>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>Spark Core</tag>
        <tag>memory</tag>
      </tags>
  </entry>
  <entry>
    <title>Spark Coreè§£æ 2ï¼šScheduler è°ƒåº¦ä½“ç³»</title>
    <url>/2019/11/07/spark-core-scheduler/</url>
    <content><![CDATA[<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>è°ƒåº¦ç³»ç»Ÿï¼Œæ˜¯è´¯ç©¿æ•´ä¸ªSparkåº”ç”¨çš„ä¸»å¿ƒéª¨ï¼Œä»è°ƒåº¦ç³»ç»Ÿå¼€å§‹å…¥æ‰‹äº†è§£Spark Coreï¼Œæ¯”è¾ƒå®¹æ˜“ç†æ¸…å¤´ç»ªã€‚</p>
<p>Sparkçš„èµ„æºè°ƒåº¦é‡‡ç”¨çš„æ˜¯å¸¸è§çš„ä¸¤å±‚è°ƒåº¦ï¼Œåº•å±‚èµ„æºçš„ç®¡ç†å’Œåˆ†é…æ˜¯ç¬¬ä¸€å±‚è°ƒåº¦ï¼Œäº¤ç»™YARNã€Mesosæˆ–è€…Sparkçš„Standaloneé›†ç¾¤å¤„ç†ï¼ŒApplicationä»ç¬¬ä¸€å±‚è°ƒåº¦æ‹¿åˆ°èµ„æºåï¼Œè¿˜è¦è¿›è¡Œå†…éƒ¨çš„ä»»åŠ¡å’Œèµ„æºè°ƒåº¦ï¼Œå°†ä»»åŠ¡å’Œèµ„æºè¿›è¡ŒåŒ¹é…ï¼Œè¿™æ˜¯ç¬¬äºŒå±‚è°ƒåº¦ï¼Œ<strong>æœ¬æ–‡è®²çš„å°±æ˜¯è¿™ç¬¬äºŒå±‚è°ƒåº¦</strong>ã€‚</p>
<p>Sparkçš„è°ƒåº¦ä½“ç³»æ¶‰åŠçš„ä»»åŠ¡åŒ…æ‹¬3ä¸ªç²’åº¦ï¼Œåˆ†åˆ«æ˜¯Jobã€Stageã€Taskã€‚<br>Jobä»£è¡¨ç”¨æˆ·æäº¤çš„ä¸€ç³»åˆ—æ“ä½œçš„æ€»ä½“ï¼Œä¸€ä¸ªå…·ä½“çš„è®¡ç®—ä»»åŠ¡ï¼Œæœ‰æ˜ç¡®çš„è¾“å…¥è¾“å‡ºï¼Œä¸€ä¸ªJobç”±å¤šä¸ªStageç»„æˆï¼›<br>ä¸€ä¸ªStageä»£è¡¨Jobè®¡ç®—æµç¨‹çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œä¸€ä¸ªé˜¶æ®µï¼ŒåŒ…å«å¤šä¸ªTaskï¼›<br>ä¸€ä¸ªTaskä»£è¡¨å¯¹ä¸€ä¸ªåˆ†åŒºçš„æ•°æ®è¿›è¡Œè®¡ç®—çš„å…·ä½“ä»»åŠ¡ã€‚</p>
<p>å±‚çº§å…³ç³»ï¼šJob &gt; Stage &gt; Task</p>
<span id="more"></span>

<p>åœ¨<a href="https://liam-blog.ml/2019/10/23/spark-core-rdd/">Spark Core è§£æï¼šRDD å¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†</a>ä¸­ï¼Œå·²ç»è§£é‡Šäº†RDDä¹‹é—´çš„ä¾èµ–ï¼Œä»¥åŠå¦‚ä½•ç»„æˆRDDè¡€ç¼˜å›¾ã€‚</p>
<p><strong>æ‰€ä»¥æœ¬æ–‡ä¸»è¦ç›®çš„å°±æ˜¯è§£é‡Šæ¸…æ¥šï¼šSchedulerå°†RDDè¡€ç¼˜å›¾è½¬å˜æˆStage DAGï¼Œç„¶åç”ŸæˆTaskï¼Œæœ€åæäº¤ç»™Executorå»æ‰§è¡Œçš„è¿‡ç¨‹ã€‚</strong></p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191212230626.png" alt="20191212230626.png"></p>
<h3 id="Stage"><a href="#Stage" class="headerlink" title="Stage"></a>Stage</h3><p>Jobçš„ä¸åŒåˆ†åŒºçš„è®¡ç®—é€šå¸¸å¯ä»¥å¹¶è¡Œï¼Œä½†æ˜¯æœ‰äº›è®¡ç®—éœ€è¦å°†æ•°æ®è¿›è¡Œé‡æ–°åˆ†åŒºï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä½œshuffle(æ··æ´—)ã€‚Shuffleçš„è¿‡ç¨‹æ˜¯æ²¡æ³•å®Œå…¨å¹¶è¡Œçš„ï¼Œè¿™æ—¶å€™å°±ä¼šå‡ºç°taskä¹‹é—´çš„ç­‰å¾…ï¼Œtaskçš„æ•°é‡ä¹Ÿå¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥Sparkä¸­ä»¥shuffleä¸ºè¾¹ç•Œï¼Œå¯¹taskè¿›è¡Œåˆ’åˆ†ï¼Œåˆ’åˆ†å‡ºæ¥çš„æ¯æ®µç§°ä¸ºStageã€‚</p>
<p>Stageä»£è¡¨ä¸€ç»„å¯ä»¥å¹¶è¡Œçš„æ‰§è¡Œç›¸åŒè®¡ç®—çš„taskï¼Œæ¯ä¸ªä»»åŠ¡å¿…é¡»æœ‰ç›¸åŒçš„åˆ†åŒºè§„åˆ™ï¼Œè¿™æ ·ä¸€ä¸ªstageä¸­æ˜¯æ²¡æœ‰shuffleçš„ã€‚</p>
<p>åœ¨ä¸€ä¸ªSpark Appä¸­ï¼Œstageæœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€IDï¼Œstage idæ˜¯è‡ªå¢çš„ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191028171155.png" alt="20191028171155.png"></p>
<p>Stageåˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>ResultStageï¼šæœ€åæ‰§è¡Œçš„stageï¼Œè´Ÿè´£Jobæœ€ç»ˆçš„ç»“æœè¾“å‡ºï¼Œ<strong>æ¯ä¸ªJobæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªResultStage</strong>ï¼›</li>
<li>ShuffleMapStageï¼šè¯¥stageçš„è¾“å‡ºä¸æ˜¯æœ€ç»ˆç»“æœï¼Œè€Œæ˜¯å…¶ä»–stageçš„è¾“å…¥æ•°æ®ï¼Œé€šå¸¸æ¶‰åŠä¸€æ¬¡shuffleè®¡ç®—ã€‚</li>
</ul>
<p>stageåˆ›å»ºæµç¨‹ï¼š</p>
<ul>
<li>ä»æœ€ç»ˆæ‰§è¡Œactionçš„RDDå¼€å§‹ï¼Œæ²¿ç€RDDä¾èµ–å…³ç³»éå†ï¼Œ<br>ä¸€æ—¦å‘ç°æŸä¸ªRDDçš„dependencyæ˜¯ShuffleDependencyï¼Œå°±åˆ›å»ºä¸€ä¸ªShuffleMapStageã€‚</li>
<li>æœ€ååˆ›å»ºResultStageã€‚</li>
</ul>
<h4 id="example-1"><a href="#example-1" class="headerlink" title="example 1"></a>example 1</h4><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> rg=sc.parallelize(<span class="type">List</span>((<span class="number">1</span>,<span class="number">10</span>),(<span class="number">2</span>,<span class="number">20</span>)))</span><br><span class="line">rg.reduceByKey(_+_).collect</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/stages-simple.png" alt="stages-simple.png"></p>
<p>è¿™é‡ŒreduceByKeyæ“ä½œå¼•èµ·äº†ä¸€æ¬¡shuffleï¼Œæ‰€ä»¥jobè¢«åˆ‡åˆ†æˆäº†2ä¸ªstageã€‚</p>
<h4 id="example-2"><a href="#example-2" class="headerlink" title="example 2"></a>example 2</h4><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> rddA=sc.parallelize(<span class="type">List</span>((<span class="number">1</span>,<span class="string">&quot;a&quot;</span>),(<span class="number">2</span>,<span class="string">&quot;b&quot;</span>),(<span class="number">3</span>,<span class="string">&quot;c&quot;</span>)))</span><br><span class="line"><span class="keyword">val</span> rddB=sc.parallelize(<span class="type">List</span>((<span class="number">1</span>,<span class="string">&quot;A&quot;</span>),(<span class="number">2</span>,<span class="string">&quot;B&quot;</span>),(<span class="number">3</span>,<span class="string">&quot;C&quot;</span>)))</span><br><span class="line">rddA.join(rddB).collect</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/stages-join.png" alt="stages-join.png"></p>
<p>joinæ“ä½œå¯¼è‡´rddAå’ŒrddBéƒ½è¿›è¡Œäº†ä¸€æ¬¡shuffleï¼Œæ‰€ä»¥æœ‰3ä¸ªstageã€‚</p>
<h4 id="example-3"><a href="#example-3" class="headerlink" title="example 3"></a>example 3</h4><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">HashPartitioner</span></span><br><span class="line"><span class="keyword">val</span> rddA=sc.parallelize(<span class="type">List</span>((<span class="number">1</span>,<span class="string">&quot;a&quot;</span>),(<span class="number">2</span>,<span class="string">&quot;b&quot;</span>),(<span class="number">3</span>,<span class="string">&quot;c&quot;</span>))).partitionBy(<span class="keyword">new</span> <span class="type">HashPartitioner</span>(<span class="number">3</span>))</span><br><span class="line"><span class="keyword">val</span> rddB=sc.parallelize(<span class="type">List</span>((<span class="number">1</span>,<span class="string">&quot;A&quot;</span>),(<span class="number">2</span>,<span class="string">&quot;B&quot;</span>),(<span class="number">3</span>,<span class="string">&quot;C&quot;</span>)))</span><br><span class="line">rddA.join(rddB).collect</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/stages-co-join.png" alt="stages-co-join.png"></p>
<p>WHAT ?</p>
<p>å› ä¸ºrddAå·²ç»å®šä¹‰äº†Partitionerï¼Œè¿™é‡Œjoinæ“ä½œä¼šä¿ç•™rddAçš„åˆ†åŒºæ–¹å¼ï¼Œæ‰€ä»¥å¯¹rddAçš„ä¾èµ–æ˜¯OneToOneDepenencyï¼Œè€Œå¯¹äºrddBåˆ™æ˜¯ShuffleDependencyã€‚</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/stage-example-3-2.png" alt="stage-example-3-2.png"></p>
<h4 id="æ¢ç´¢ï¼šä¸€ä¸ªRDDè¢«ä¾èµ–å¤šæ¬¡ï¼Œä¼šå¦‚ä½•"><a href="#æ¢ç´¢ï¼šä¸€ä¸ªRDDè¢«ä¾èµ–å¤šæ¬¡ï¼Œä¼šå¦‚ä½•" class="headerlink" title="æ¢ç´¢ï¼šä¸€ä¸ªRDDè¢«ä¾èµ–å¤šæ¬¡ï¼Œä¼šå¦‚ä½•"></a>æ¢ç´¢ï¼šä¸€ä¸ªRDDè¢«ä¾èµ–å¤šæ¬¡ï¼Œä¼šå¦‚ä½•</h4><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> rddA=sc.parallelize(<span class="type">List</span>((<span class="number">1</span>,<span class="string">&quot;a&quot;</span>),(<span class="number">2</span>,<span class="string">&quot;b&quot;</span>),(<span class="number">3</span>,<span class="string">&quot;c&quot;</span>)))</span><br><span class="line">rddA join rddA collect</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/rdd%20use%20twice.png" alt="rdd use twice.png"></p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/rdd-used-twice.png" alt="rdd-used-twice.png"></p>
<p>ä¸€ä¸ªRDDè¢«ä¸¤ä¸ªstageä½¿ç”¨äº†ã€‚</p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>ç»¼ä¸Šï¼Œstageçš„åˆ’åˆ†ä¸€å®šæ˜¯ä¾æ®shuffleå³ShuffleDependencyï¼Œè·Ÿç®—å­å’ŒRDDå˜é‡çš„å®šä¹‰æ²¡æœ‰å¾ˆå¼ºçš„å…³ç³»ï¼Œexample2å’Œ3ä¸­çš„joinæ“ä½œ<code>rddA.join(rddB).collect</code>çœ‹èµ·æ¥ä¸€æ¨¡ä¸€æ ·ï¼Œä½†å®é™…äº§ç”Ÿçš„stageåˆ’åˆ†å´å·®åˆ«å¾ˆå¤§ã€‚</p>
<h3 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h3><p>ä¸stageå¯¹åº”ï¼Œtaskä¹Ÿåˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>ShuffleMapTaskï¼šå³ShuffleMapStageä¸­çš„taskï¼Œä¸»è¦å®Œæˆmapã€shuffleè®¡ç®—ã€‚</li>
<li>ResultTaskï¼šResultStageä¸­çš„taskï¼Œä¸»è¦å®Œæˆæœ€ç»ˆç»“æœè¾“å‡ºæˆ–è€…è¿”å›ç»“æœç»™driverçš„ä»»åŠ¡ã€‚</li>
</ul>
<p>ä¸€ä¸ªstageæœ‰å¤šå°‘ä¸ªpartitionå°±ä¼šåˆ›å»ºå¤šå°‘ä¸ªtaskï¼Œæ¯”å¦‚ä¸€ä¸ªShuffleMapStageæœ‰10ä¸ªpartitionï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»º10ä¸ªShuffleMapTaskã€‚</p>
<p>ä¸€ä¸ªStageä¸­çš„æ‰€æœ‰taskç»„æˆä¸€ä¸ªTaskSetã€‚</p>
<h2 id="Job-Submit"><a href="#Job-Submit" class="headerlink" title="Job Submit"></a>Job Submit</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph TB</span><br><span class="line">R(RDD.action)--&gt;S(SparkContext.runJob)-- RDD --&gt;D(DAGScheduler.runJob)</span><br><span class="line">-- TaskSet --&gt;T(TaskScheduler.submitTasks)-- TaskDescription --&gt;E(Executor.launchTask)</span><br></pre></td></tr></table></figure>

<p>RDDåœ¨actionæ“ä½œä¸­é€šè¿‡SparkContext.runJobæ–¹æ³•è§¦å‘Jobæ‰§è¡Œæµç¨‹ï¼Œè¯¥æ–¹æ³•å°†è°ƒç”¨DagScheduler.runJobæ–¹æ³•ï¼Œå°†RDDä¼ å…¥DagSchedulerã€‚ç„¶åï¼ŒDAGScheduleråˆ›å»ºTaskSetæäº¤ç»™TaskSchedulerï¼ŒTaskSchedulerå†å°†TaskSetå°è£…æˆTaskDescriptionå‘é€ç»™Executorï¼Œæœ€åExecutorä¼šå°†TaskDescriptionæäº¤ç»™çº¿ç¨‹æ± æ¥è¿è¡Œã€‚</p>
<h2 id="Stage-Scheduler-high-level"><a href="#Stage-Scheduler-high-level" class="headerlink" title="Stage Scheduler(high-level)"></a>Stage Scheduler(high-level)</h2><h3 id="DagScheduler"><a href="#DagScheduler" class="headerlink" title="DagScheduler"></a>DagScheduler</h3><p>Stageçº§åˆ«çš„è°ƒåº¦æ˜¯DagSchedulerè´Ÿè´£çš„ï¼Œä¹Ÿæ˜¯Sparkè°ƒåº¦ä½“ç³»çš„æ ¸å¿ƒã€‚</p>
<h4 id="DagSchedulerçš„å·¥ä½œæ¨¡å¼"><a href="#DagSchedulerçš„å·¥ä½œæ¨¡å¼" class="headerlink" title="DagSchedulerçš„å·¥ä½œæ¨¡å¼"></a>DagSchedulerçš„å·¥ä½œæ¨¡å¼</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant M as main thread</span><br><span class="line">    participant L as eventProcessLoop</span><br><span class="line">    participant E as event thread</span><br><span class="line">    M--&gt;&gt;L: post event</span><br><span class="line">    E--&gt;&gt;L: handle event</span><br></pre></td></tr></table></figure>

<p>DagSchedulerå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªäº‹ä»¶æ¶ˆæ¯æ€»çº¿eventProcessLoop(ç±»å‹ä¸ºDAGSchedulerEventProcessLoop)ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªç”¨æ¥å­˜å‚¨DAGSchedulerEventç±»å‹æ•°æ®çš„é˜Ÿåˆ—ã€‚</p>
<p>å½“DagSchedulerçš„ä¸€äº›æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼ˆå¦‚submitJobæ–¹æ³•ï¼‰ï¼Œå¹¶ä¸ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†è¯¥ä»»åŠ¡ï¼Œè€Œæ˜¯postä¸€ä¸ªevent(å¦‚JobSubmitted)åˆ°eventProcessLoopã€‚eventProcessLoopä¸­æœ‰ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œä¼šä¸æ–­çš„ä¾æ¬¡ä»é˜Ÿåˆ—ä¸­å–å‡ºeventï¼Œç„¶åè°ƒç”¨å¯¹åº”çš„handle(å¦‚handleJobSubmitted)æ–¹æ³•æ¥æ‰§è¡Œå…·ä½“çš„ä»»åŠ¡ã€‚</p>
<h3 id="Stageè°ƒåº¦æµç¨‹"><a href="#Stageè°ƒåº¦æµç¨‹" class="headerlink" title="Stageè°ƒåº¦æµç¨‹"></a>Stageè°ƒåº¦æµç¨‹</h3><ul>
<li><p>1.submit job</p>
<p>DagScheduler.runJobæ–¹æ³•ä¼šè°ƒç”¨submitJobæ–¹æ³•ï¼Œå‘eventProcessLoopå‘é€ä¸€ä¸ªJobSubmittedç±»å‹çš„æ¶ˆæ¯ï¼Œå…¶ä¸­åŒ…å«äº†RDDç­‰ä¿¡æ¯ã€‚å½“eventProcessLoopæ¥æ”¶åˆ°JobSubmittedç±»å‹çš„æ¶ˆæ¯ï¼Œä¼šè°ƒç”¨DagScheduler.handleJobSubmittedæ–¹æ³•æ¥å¤„ç†æ¶ˆæ¯ã€‚</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant M as main thread(runJob)</span><br><span class="line">    participant L as eventProcessLoop</span><br><span class="line">    participant E as event thread(handleJobSubmitted)</span><br><span class="line">    M--&gt;&gt;L: post JobSubmitted event</span><br><span class="line">    E--&gt;&gt;L: handle JobSubmitted event</span><br></pre></td></tr></table></figure>

<ul>
<li><p>2.create stage</p>
<ul>
<li><p>DagScheduleråœ¨å®ƒçš„handleJobSubmittedæ–¹æ³•ä¸­å¼€å§‹åˆ›å»ºResultStageã€‚ResultStageä¸­åŒ…å«äº†æœ€ç»ˆæ‰§è¡Œactionçš„finalRDDï¼Œä»¥åŠè®¡ç®—å‡½æ•°funcã€‚</p>
</li>
<li><p>ResultStageæœ‰ä¸ªparentså±æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯ä¸ªåˆ—è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥æœ‰å¤šä¸ªparent stageã€‚åˆ›å»ºResultStageæ—¶éœ€è¦å…ˆåˆ›å»ºå®ƒçš„parent stageæ¥å¡«å……è¿™ä¸ªå±æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´è¦åˆ›å»ºResultStageç›´æ¥ä¾èµ–çš„æ‰€æœ‰ShuffleMapStageã€‚</p>
</li>
<li><p>é€šè¿‡stage.rdd.dependencieså±æ€§ï¼Œé‡‡ç”¨å®½åº¦ä¼˜å…ˆéå†ï¼Œä¸€æ—¦å‘ç°æŸä¸ªRDD(å‡è®¾å«rddA)çš„dependencyæ˜¯ShuffleDependencyï¼Œå°±åˆ›å»ºä¸€ä¸ªShuffleMapStageï¼ŒShuffleMapStageä¸­åŒ…å«çš„å…³é”®ä¿¡æ¯ä¸ResultStageä¸åŒï¼Œæ˜¯rddAçš„ShuffleDependencyå’ŒrddAçš„ShuffleDependency.rddï¼Œä¹Ÿå°±æ˜¯è¯´æ–°åˆ›å»ºçš„ShuffleMapStageæŒæœ‰çš„ä¿¡æ¯æ˜¯ä»–è‡ªèº«çš„æœ€åä¸€ä¸ªRDDå’Œè¯¥RDDçš„å­RDDçš„dependencyã€‚</p>
</li>
<li><p>åˆ›å»ºä¸€ä¸ªShuffleMapStageçš„è¿‡ç¨‹åŒç†ä¼šéœ€è¦åˆ›å»ºå®ƒçš„parent stageï¼Œä¹Ÿæ˜¯è‹¥å¹²ShuffleMapStageã€‚å¦‚æ­¤é€’å½’ä¸‹å»ï¼Œç›´åˆ°åˆ›å»ºå®Œæ‰€æœ‰çš„ShuffleMapStageï¼Œæœ€åæ‰å®ŒæˆResultStageçš„åˆ›å»ºã€‚æœ€ååˆ›å»ºå‡ºæ¥çš„è¿™äº›Stage(è‹¥å¹²ShuffleMapStageåŠ ä¸€ä¸ªResultStage)ï¼Œé€šè¿‡parentå±æ€§ä¸²èµ·æ¥ï¼Œå°±åƒè¿™æ ·</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph TD</span><br><span class="line">A[ResultStage]-- parent --&gt;B[ShuffleMapStage 1]</span><br><span class="line">A-- parent --&gt;C[ShuffleMapStage 2]</span><br><span class="line">B-- parent --&gt;D[ShuffleMapStage 3]</span><br></pre></td></tr></table></figure>

<p>è¿™å°±ç”Ÿæˆäº†æ‰€è°“çš„DAGå›¾ï¼Œä½†æ˜¯è¿™ä¸ªå›¾çš„æŒ‡å‘è·Ÿæ‰§è¡Œé¡ºåºæ˜¯åè¿‡æ¥çš„ï¼Œå¦‚æœæŒ‰æ‰§è¡Œé¡ºåºæ¥ç”»DAGå›¾ï¼Œå°±æ˜¯å¸¸è§çš„å½¢å¼äº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph TD</span><br><span class="line">D[ShuffleMapStage 3]--&gt;C[ShuffleMapStage 2]</span><br><span class="line">C[ShuffleMapStage 2]--&gt;A[ResultStage]</span><br><span class="line">B[ShuffleMapStage 1]--&gt;A[ResultStage]</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>3.submit stage</p>
<p>DagScheduler.handleJobSubmittedæ–¹æ³•åˆ›å»ºå¥½ResultStageåä¼šæäº¤è¿™ä¸ªstage(submitStageæ–¹æ³•)ï¼Œåœ¨æäº¤ä¸€ä¸ªstageçš„æ—¶å€™ï¼Œä¼šè¦å…ˆæäº¤å®ƒçš„parent stage,ä¹Ÿæ˜¯é€šè¿‡é€’å½’çš„å½¢å¼ï¼Œç›´åˆ°ä¸€ä¸ªstageçš„æ‰€æœ‰parent stageéƒ½è¢«æäº¤äº†ï¼Œå®ƒè‡ªå·±æ‰èƒ½è¢«æäº¤ï¼Œå¦‚æœä¸€ä¸ªstageçš„parentè¿˜æ²¡æœ‰å®Œæˆï¼Œåˆ™ä¼šæŠŠè¿™ä¸ªstageåŠ å…¥waitingStagesã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒDAGå›¾ä¸­å‰é¢çš„stageä¼šè¢«å…ˆæäº¤ã€‚å½“ä¸€ä¸ªstageçš„parentéƒ½å‡†å¤‡å¥½äº†ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œå®Œäº†ï¼Œå®ƒæ‰ä¼šè¿›å…¥submitMissingTasksçš„ç¯èŠ‚ã€‚</p>
</li>
<li><p>4.submit task</p>
<p>Taskæ˜¯åœ¨DagSchedulerï¼ˆä¸æ˜¯TaskSchedulerï¼‰çš„submitMissingTasksæ–¹æ³•ä¸­åˆ›å»ºçš„ï¼ŒåŒ…æ‹¬ShuffleMapTaskå’ŒResultTaskï¼Œä¸Stageå¯¹åº”ã€‚å½’å±äºåŒä¸€ä¸ªstageçš„è¿™æ‰¹Taskç»„æˆä¸€ä¸ªTaskSeté›†åˆï¼Œæœ€åæäº¤ç»™TaskSchedulerçš„å°±æ˜¯è¿™ä¸ªTaskSeté›†åˆã€‚</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191029095005.png" alt="20191029095005.png"></p>
<h2 id="Task-Scheduler-low-level"><a href="#Task-Scheduler-low-level" class="headerlink" title="Task Scheduler(low-level)"></a>Task Scheduler(low-level)</h2><p>Taskçš„è°ƒåº¦å·¥ä½œæ˜¯ç”±TaskSchedulerä¸SchedulerBackendç´§å¯†åˆä½œï¼Œå…±åŒå®Œæˆçš„ã€‚</p>
<p>TaskScheduleræ˜¯taskçº§åˆ«çš„è°ƒåº¦å™¨ï¼Œä¸»è¦ä½œç”¨æ˜¯ç®¡ç†taskçš„è°ƒåº¦å’Œæäº¤ï¼Œæ˜¯Sparkåº•å±‚çš„è°ƒåº¦å™¨ã€‚</p>
<p>SchedulerBackendæ˜¯TaskSchedulerçš„åç«¯æœåŠ¡ï¼Œæœ‰ç‹¬ç«‹çš„çº¿ç¨‹ï¼Œæ‰€æœ‰çš„Executoréƒ½ä¼šæ³¨å†Œåˆ°SchedulerBackendï¼Œä¸»è¦ä½œç”¨æ˜¯è¿›è¡Œèµ„æºåˆ†é…ã€å°†taskåˆ†é…ç»™executorç­‰ã€‚</p>
<h3 id="Taskè°ƒåº¦æµç¨‹"><a href="#Taskè°ƒåº¦æµç¨‹" class="headerlink" title="Taskè°ƒåº¦æµç¨‹"></a>Taskè°ƒåº¦æµç¨‹</h3><p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/spark%20task%20scheduler.png" alt="spark task scheduler.png"></p>
<p>ç¬¬ä¸€ä¸ªçº¿ç¨‹æ˜¯DAGSchedulerçš„äº‹ä»¶å¤„ç†çº¿ç¨‹ï¼Œåœ¨å…¶ä¸­ï¼ŒTaskå…ˆç»è¿‡DAGSchedulerï¼ˆè“è‰²ç®­å¤´è¡¨ç¤ºï¼‰å°è£…æˆTaskSetï¼Œå†ç”±TaskSchedulerï¼ˆç»¿è‰²ç®­å¤´ï¼‰å°è£…æˆTaskSetManagerï¼Œå¹¶åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ä¸­ã€‚</p>
<p>SchedulerBackendåœ¨æ”¶åˆ°ReviveOffersæ¶ˆæ¯æ—¶ï¼Œä¼šä»çº¿ç¨‹æ± å–ä¸€ä¸ªçº¿ç¨‹è¿›è¡ŒmakeOffersæ“ä½œï¼ŒWorkerOfferåˆ›å»ºåä¼ é€’ç»™TaskSchedulerè¿›è¡Œåˆ†é…ã€‚</p>
<p>å›¾ä¸­ç¬¬äºŒä¸ªçº¿ç¨‹å°±æ˜¯SchedulerBackendçš„ä¸€ä¸ªäº‹ä»¶åˆ†å‘çº¿ç¨‹ï¼Œä»Poolä¸­å–å‡ºæœ€ä¼˜å…ˆçš„TaskSetManagerï¼Œç„¶åå°†WorkerOfferä¸å…¶ä¸­çš„Taskè¿›è¡Œé…å¯¹ï¼Œç”ŸæˆTaskDescriptionï¼Œå‘é€ç»™WorkerOfferæŒ‡å®šçš„Executorå»æ‰§è¡Œã€‚</p>
<h3 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h3><p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/TaskScheduler.png" alt="TaskScheduler.png"></p>
<ul>
<li>1 DAGScheduler(submitMissingTasksæ–¹æ³•ä¸­)è°ƒç”¨TaskScheduler.submitTasks()åˆ›å»ºå¹¶æäº¤TaskSetç»™TaskSchedulerï¼›</li>
<li>2 TaskScheduleræ‹¿åˆ°TaskSetåä¼šåˆ›å»ºä¸€ä¸ªTaskSetManageræ¥ç®¡ç†å®ƒï¼Œå¹¶ä¸”æŠŠTaskSetManageræ·»åŠ åˆ°rootPoolè°ƒåº¦æ± ä¸­ï¼›</li>
<li>3 è°ƒç”¨SchedulerBackend.reviveOffers()æ–¹æ³•ï¼›</li>
<li>4 SchedulerBackendå‘é€ReviveOffersæ¶ˆæ¯ç»™DriverEndpointï¼›</li>
<li>5 DriverEndpointæ”¶åˆ°ReviveOffersæ¶ˆæ¯åï¼Œä¼šè°ƒç”¨makeOffers()æ–¹æ³•åˆ›å»ºWorkerOfferï¼Œå¹¶é€šè¿‡TaskScheduler.resourceOffers()è¿”å›offerï¼›</li>
<li>6 TaskSchedulerä»rootPoolè·å–æŒ‰è°ƒåº¦ç®—æ³•æ’åºåçš„TaskSetManageråˆ—è¡¨ï¼Œå–ç¬¬ä¸€ä¸ªTaskSetManagerï¼Œé€ä¸ªç»™TaskSetçš„Taskåˆ†é…WorkerOfferï¼Œç”ŸæˆTaskDescription(åŒ…å«offerä¿¡æ¯)ï¼›</li>
<li>7 è°ƒç”¨SchedulerBackend.DriverEndpointçš„launchTasksæ–¹æ³•ï¼Œå°†TaskDescriptionåºåˆ—åŒ–å¹¶å°è£…åœ¨LaunchTaskæ¶ˆæ¯ä¸­ï¼Œå‘é€ç»™offeræŒ‡å®šçš„executorã€‚LaunchTaskæ¶ˆæ¯è¢«ExecutorBackendæ”¶åˆ°åï¼Œä¼šå°†Taskä¿¡æ¯ååºåˆ—åŒ–ï¼Œä¼ ç»™Executor.launchTask()ï¼Œæœ€åä½¿ç”¨Executorçš„çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸ªTaskã€‚</li>
</ul>
<h3 id="æ¢³ç†"><a href="#æ¢³ç†" class="headerlink" title="æ¢³ç†"></a>æ¢³ç†</h3><p>Stage,TaskSet,TaskSetManageræ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ•°é‡ç›¸ç­‰ï¼Œéƒ½æ˜¯åªå­˜åœ¨driverä¸Šçš„ã€‚<br>Parition,Task,TaskDescriptionæ˜¯ä¸€ä¸€å¯¹åº”ï¼Œæ•°é‡ç›¸åŒï¼ŒTaskå’ŒTaskDescriptionæ˜¯ä¼šè¢«å‘åˆ°executorä¸Šçš„ã€‚</p>
<h3 id="TaskSchedulerçš„è°ƒåº¦æ± "><a href="#TaskSchedulerçš„è°ƒåº¦æ± " class="headerlink" title="TaskSchedulerçš„è°ƒåº¦æ± "></a>TaskSchedulerçš„è°ƒåº¦æ± </h3><p>ä¸DAGSchedulerä¸åŒçš„æ˜¯TaskScheduleræœ‰è°ƒåº¦æ± ï¼Œæœ‰ä¸¤ç§è°ƒåº¦å®ä½“ï¼ŒPoolå’ŒTaskSetManagerã€‚<br>ä¸YARNçš„è°ƒåº¦é˜Ÿåˆ—ç±»ä¼¼ï¼Œé‡‡ç”¨äº†å±‚çº§é˜Ÿåˆ—çš„æ–¹å¼ï¼ŒPoolæ˜¯TaskSetManagerçš„å®¹å™¨ï¼Œèµ·åˆ°å°†TaskSetManageråˆ†ç»„çš„ä½œç”¨ã€‚</p>
<h4 id="Schedulable"><a href="#Schedulable" class="headerlink" title="Schedulable"></a>Schedulable</h4><p>Schedulableæ˜¯è°ƒåº¦å®ä½“çš„åŸºç±»ï¼Œæœ‰ä¸¤ä¸ªå­ç±»Poolå’ŒTaskSetManagerã€‚</p>
<p>è¦ç†è§£è°ƒåº¦è§„åˆ™ï¼Œå¿…é¡»çŸ¥é“ä¸‹é¢å‡ ä¸ªå±æ€§ï¼š</p>
<ul>
<li>parentï¼šæ‰€å±è°ƒåº¦æ± ï¼Œé¡¶å±‚çš„è°ƒåº¦æ± ä¸ºroot poolï¼›</li>
<li>schedulableQueueï¼šåŒ…å«çš„è°ƒåº¦å¯¹è±¡ç»„æˆçš„é˜Ÿåˆ—ï¼›</li>
<li>schedulingModeï¼šè°ƒåº¦æ¨¡å¼ï¼ŒFIFO or FAIRï¼›</li>
<li>weightï¼šæƒé‡</li>
<li>minShareï¼šæœ€å°åˆ†é…é¢(CPUæ ¸æ•°)</li>
<li>runningTasksï¼šè¿è¡Œä¸­taskæ•°</li>
<li>priorityï¼šä¼˜å…ˆçº§</li>
<li>stageIdï¼šå°±æ˜¯stageId</li>
<li>nameï¼šåç§°</li>
</ul>
<p>Poolå’ŒTaskSetManagerå¯¹äºè¿™äº›å±æ€§çš„å–å€¼æœ‰æ‰€ä¸åŒï¼Œä»è€Œå¯¼è‡´äº†ä»–ä»¬çš„è°ƒåº¦è¡Œä¸ºä¹Ÿä¸ä¸€æ ·ã€‚</p>
<table>
<thead>
<tr>
<th align="left">properties</th>
<th align="left">Pool</th>
<th align="left">TaskSetManager</th>
</tr>
</thead>
<tbody><tr>
<td align="left">weight</td>
<td align="left">config</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">minShare</td>
<td align="left">config</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">priority</td>
<td align="left">0</td>
<td align="left">jobId</td>
</tr>
<tr>
<td align="left">stageId</td>
<td align="left">-1</td>
<td align="left">stageId</td>
</tr>
<tr>
<td align="left">name</td>
<td align="left">config</td>
<td align="left">TaskSet_{taskSet.id}</td>
</tr>
<tr>
<td align="left">runningTasks</td>
<td align="left">Poolæ‰€å«TaskSetManagerçš„runningTaskså’Œ</td>
<td align="left">TaskSetManagerè¿è¡Œä¸­taskæ•°</td>
</tr>
</tbody></table>
<h4 id="Poolsåˆ›å»ºæµç¨‹"><a href="#Poolsåˆ›å»ºæµç¨‹" class="headerlink" title="Poolsåˆ›å»ºæµç¨‹"></a>Poolsåˆ›å»ºæµç¨‹</h4><p>TaskScheduleræœ‰ä¸ªå±æ€§schedulingModeï¼Œå€¼å–å†³äºé…ç½®é¡¹<code>spark.scheduler.mode</code>ï¼Œé»˜è®¤ä¸ºFIFOã€‚è¿™ä¸ªå±æ€§ä¼šå¯¼è‡´TaskSchedulerä½¿ç”¨ä¸åŒçš„SchedulableBuilderï¼Œå³FIFOSchedulableBuilderå’ŒFairSchedulableBuilderã€‚</p>
<p>TaskScheduleråœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå°±ä¼šåˆ›å»ºroot poolï¼Œæ ¹è°ƒåº¦æ± ï¼Œæ˜¯æ‰€æœ‰poolçš„ç¥–å…ˆã€‚<br>å®ƒçš„å±æ€§å–å€¼ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">name: &quot;&quot; (ç©ºå­—ç¬¦ä¸²)</span><br><span class="line">schedulingMode: åŒTaskSchedulerçš„schedulingModeå±æ€§</span><br><span class="line">weight: 0</span><br><span class="line">minShare: 0</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„root poolçš„è°ƒåº¦æ¨¡å¼ç¡®å®šäº†ã€‚</p>
<p>æ¥ä¸‹æ¥ä¼šæ‰§è¡Œ<code>schedulableBuilder.buildPools()</code>æ–¹æ³•ï¼Œ</p>
<ul>
<li><p>å¦‚æœæ˜¯FIFOSchedulableBuilderï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿã€‚</p>
</li>
<li><p>è‹¥æ˜¯FairSchedulableBuilder</p>
<ul>
<li>1 ä¾æ®scheduleré…ç½®æ–‡ä»¶(åé¢ä¼šè¯´)ï¼Œå¼€å§‹åˆ›å»ºpool(å¯ä»¥æ˜¯å¤šä¸ªpoolï¼ŒFIFOï¼ŒFAIRéƒ½æœ‰å¯èƒ½ï¼Œå–å†³äºé…ç½®æ–‡ä»¶)ï¼Œå¹¶éƒ½åŠ å…¥root poolä¸­ã€‚</li>
<li>2 å¦‚æœç°åœ¨root poolä¸­æ²¡æœ‰åä¸ºâ€defaultâ€çš„pool(å³é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰å®šä¹‰ä¸€ä¸ªå«defaultçš„pool)ï¼Œåˆ›å»ºdefault poolï¼Œå¹¶åŠ å…¥root poolä¸­ã€‚<br>è¿™æ—¶default poolå®ƒçš„å±æ€§å–å€¼æ˜¯å›ºå®šçš„ï¼š</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">name: &quot;default&quot;</span><br><span class="line">schedulingMode: FIFO</span><br><span class="line">weight: 1</span><br><span class="line">minShare: 0</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="TaskåŠ å…¥poolæµç¨‹"><a href="#TaskåŠ å…¥poolæµç¨‹" class="headerlink" title="TaskåŠ å…¥poolæµç¨‹"></a>TaskåŠ å…¥poolæµç¨‹</h4><p>å½“TaskScheduleræäº¤taskçš„æ—¶å€™ï¼Œä¼šå…ˆåˆ›å»ºTaskSetManagerï¼Œç„¶åé€šè¿‡schedulableBuilderæ·»åŠ åˆ°poolä¸­ã€‚</p>
<ul>
<li><p>å¦‚æœæ˜¯FIFOSchedulableBuilderï¼Œåˆ™ä¼šç›´æ¥æŠŠTaskSetManageråŠ å…¥root poolé˜Ÿåˆ—ä¸­ã€‚</p>
</li>
<li><p>è‹¥æ˜¯FairSchedulableBuilder</p>
<ul>
<li>1 ä»<code>spark.scheduler.pool</code>é…ç½®è·å–pool nameï¼Œæ²¡æœ‰å®šä¹‰åˆ™ç”¨â€™defaultâ€™ï¼›</li>
<li>2 ä»root pooléå†æ‰¾åˆ°å¯¹åº”åç§°çš„poolï¼ŒæŠŠTaskSetManageråŠ å…¥poolçš„é˜Ÿåˆ—ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªè¯¥åç§°çš„poolï¼Œé‡‡ç”¨ä¸default poolç›¸åŒçš„å±æ€§é…ç½®ï¼Œå¹¶åŠ å…¥root poolã€‚</li>
</ul>
</li>
</ul>
<h4 id="è°ƒåº¦æ± ç»“æ„"><a href="#è°ƒåº¦æ± ç»“æ„" class="headerlink" title="è°ƒåº¦æ± ç»“æ„"></a>è°ƒåº¦æ± ç»“æ„</h4><p>ç»è¿‡ä¸Šé¢ä¸¤éƒ¨åˆ†ï¼Œæœ€ç»ˆå¾—åˆ°çš„è°ƒåº¦æ± ç»“æ„å¦‚ä¸‹ï¼š</p>
<p>spark.scheduler.mode&#x3D;FIFO</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191128210416.png" alt="20191128210416.png"></p>
<p>spark.scheduler.mode&#x3D;FAIR</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191128210432.png" alt="20191128210432.png"></p>
<h4 id="Fair-Scheduler-poolsé…ç½®"><a href="#Fair-Scheduler-poolsé…ç½®" class="headerlink" title="Fair Scheduler poolsé…ç½®"></a>Fair Scheduler poolsé…ç½®</h4><p>Fair Scheduler Poolçš„åˆ’åˆ†ä¾èµ–äºé…ç½®æ–‡ä»¶ï¼Œé»˜è®¤çš„é…ç½®æ–‡ä»¶ä¸ºâ€™fairscheduler.xmlâ€™ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹â€spark.scheduler.allocation.fileâ€æŒ‡å®šé…ç½®æ–‡ä»¶ã€‚</p>
<p>ç…®ä¸ªæ —å­ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">allocations</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pool</span> <span class="attr">name</span>=<span class="string">&quot;prod&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schedulingMode</span>&gt;</span>FAIR<span class="tag">&lt;/<span class="name">schedulingMode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">weight</span>&gt;</span>1<span class="tag">&lt;/<span class="name">weight</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">minShare</span>&gt;</span>2<span class="tag">&lt;/<span class="name">minShare</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pool</span> <span class="attr">name</span>=<span class="string">&quot;test&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schedulingMode</span>&gt;</span>FIFO<span class="tag">&lt;/<span class="name">schedulingMode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">weight</span>&gt;</span>2<span class="tag">&lt;/<span class="name">weight</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">minShare</span>&gt;</span>3<span class="tag">&lt;/<span class="name">minShare</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">allocations</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé…ç½®äº†ä¸¤ä¸ªpoolï¼Œprodå’Œtestï¼Œå¹¶ä¸”é…ç½®äº†ç›¸å…³å±æ€§ï¼Œ<strong>è¿™ä¸¤ä¸ªpooléƒ½ä¼šæ·»åŠ åˆ°root poolä¸­</strong>ã€‚</p>
<h4 id="è°ƒåº¦ç®—æ³•"><a href="#è°ƒåº¦ç®—æ³•" class="headerlink" title="è°ƒåº¦ç®—æ³•"></a>è°ƒåº¦ç®—æ³•</h4><p>ä»¥SchedulingAlgorithmä¸ºåŸºç±»ï¼Œå†…ç½®å®ç°çš„è°ƒåº¦ç®—æ³•æœ‰ä¸¤ç§FIFOSchedulingAlgorithmå’ŒFairSchedulingAlgorithmï¼Œå…¶é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>FIFO: å…ˆè¿›å…ˆå‡ºï¼Œä¼˜å…ˆçº§æ¯”è¾ƒç®—æ³•å¦‚ä¸‹ï¼Œ</p>
<ul>
<li>1.æ¯”è¾ƒpriorityï¼Œå°çš„ä¼˜å…ˆï¼›</li>
<li>2.priorityç›¸åŒåˆ™æ¯”è¾ƒStageIdï¼Œå°çš„ä¼˜å…ˆã€‚</li>
</ul>
</li>
<li><p>FAIRï¼šå…¬å¹³è°ƒåº¦ï¼Œä¼˜å…ˆçº§æ¯”è¾ƒç®—æ³•å¦‚ä¸‹ï¼Œ</p>
<ul>
<li>1.runningTaskså°äºminShareçš„ä¼˜å…ˆçº§æ¯”ä¸å°äºçš„ä¼˜å…ˆçº§è¦é«˜ã€‚</li>
<li>2.è‹¥ä¸¤è€…è¿è¡Œçš„runningTaskséƒ½æ¯”minShareå°ï¼Œåˆ™æ¯”è¾ƒminShareä½¿ç”¨ç‡(runningTasks&#x2F;max(minShare,1))ï¼Œä½¿ç”¨ç‡è¶Šä½ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
<li>3.è‹¥ä¸¤è€…çš„minShareä½¿ç”¨ç‡ç›¸åŒï¼Œåˆ™æ¯”è¾ƒæƒé‡ä½¿ç”¨ç‡(runningTasks&#x2F;weight)ï¼Œä½¿ç”¨ç‡è¶Šä½ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
<li>4.è‹¥æƒé‡ä¹Ÿç›¸åŒï¼Œåˆ™æ¯”è¾ƒnameï¼Œå°çš„ä¼˜å…ˆã€‚</li>
</ul>
</li>
</ul>
<h5 id="Poolä¸ºFIFOæ¨¡å¼ä¸‹çš„å‡ ç§æƒ…å½¢"><a href="#Poolä¸ºFIFOæ¨¡å¼ä¸‹çš„å‡ ç§æƒ…å½¢" class="headerlink" title="Poolä¸ºFIFOæ¨¡å¼ä¸‹çš„å‡ ç§æƒ…å½¢"></a>Poolä¸ºFIFOæ¨¡å¼ä¸‹çš„å‡ ç§æƒ…å½¢</h5><p>TaskSetManagerä¹‹é—´çš„æ¯”è¾ƒï¼Œå…¶å®å°±æ˜¯å…ˆæ¯”è¾ƒjobIdå†æ¯”è¾ƒstageIdï¼Œè°å°è°ä¼˜å…ˆï¼Œæ„å‘³ç€å°±æ˜¯è°å…ˆæäº¤è°ä¼˜å…ˆã€‚</p>
<p>Poolä¹‹é—´çš„æ¯”è¾ƒï¼Œä¸å­˜åœ¨ï¼FIFOçš„poolé˜Ÿåˆ—ä¸­æ˜¯ä¸ä¼šæœ‰poolçš„ã€‚</p>
<h5 id="Poolä¸ºFAIRæ¨¡å¼ä¸‹çš„å‡ ç§æƒ…å½¢"><a href="#Poolä¸ºFAIRæ¨¡å¼ä¸‹çš„å‡ ç§æƒ…å½¢" class="headerlink" title="Poolä¸ºFAIRæ¨¡å¼ä¸‹çš„å‡ ç§æƒ…å½¢"></a>Poolä¸ºFAIRæ¨¡å¼ä¸‹çš„å‡ ç§æƒ…å½¢</h5><p>TaskSetManagerä¹‹é—´çš„æ¯”è¾ƒï¼Œå› ä¸ºminShare&#x3D;0ï¼Œweight&#x3D;1ï¼ŒFAIRç®—æ³•å˜æˆäº†ï¼š</p>
<ul>
<li>1 runningTaskså°çš„ä¼˜å…ˆ</li>
<li>2 runningTasksç›¸åŒåˆ™æ¯”è¾ƒname</li>
</ul>
<p>Poolä¹‹é—´çš„æ¯”è¾ƒï¼Œå°±æ˜¯æ ‡å‡†çš„FAIRç®—æ³•ã€‚</p>
<p><strong>å½“root poolä¸ºFAIRæ¨¡å¼ï¼Œå…ˆå–æœ€ä¼˜å…ˆçš„poolï¼Œå†ä»poolä¸­ï¼ŒæŒ‰poolçš„è°ƒåº¦æ¨¡å¼å–ä¼˜å…ˆçš„TaskSetManagerã€‚</strong></p>
<h4 id="å¼€å§‹ä½¿ç”¨FAIR-mode"><a href="#å¼€å§‹ä½¿ç”¨FAIR-mode" class="headerlink" title="å¼€å§‹ä½¿ç”¨FAIR mode"></a>å¼€å§‹ä½¿ç”¨FAIR mode</h4><p>å¯ç”¨FAIRæ¨¡å¼ï¼š</p>
<ul>
<li>1 å‡†å¤‡å¥½<code>fairscheduler.xml</code>æ–‡ä»¶</li>
<li>2 å¯åŠ¨å‚æ•°æ·»åŠ  <code>--conf spark.scheduler.mode=FAIR</code></li>
<li>3 è¿è¡Œå¯åŠ¨å‘½ä»¤ï¼Œå¦‚<code>spark-shell --master yarn --deploy-mode client --conf spark.scheode=FAIR</code></li>
</ul>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/ui-fair.png" alt="ui-fair.png"></p>
<p>å¯åŠ¨åå¦‚æœç›´æ¥è¿è¡ŒJobä¼šè‡ªåŠ¨æäº¤åˆ°default poolï¼Œé‚£ä¹ˆå¦‚ä½•æäº¤Jobåˆ°æŒ‡å®špoolï¼Ÿ<br>SparkContext.setLocalProperty(â€œspark.scheduler.poolâ€,â€poolNameâ€)</p>
<p>å¦‚æœæ¯æ¬¡åªè¿è¡Œä¸€ä¸ªJobï¼Œå¼€å¯FAIRæ¨¡å¼çš„æ„ä¹‰ä¸å¤§ï¼Œé‚£ä¹ˆå¦‚ä½•åŒæ—¶è¿è¡Œå¤šä¸ªJobï¼Ÿ<br>è¦å¼‚æ­¥æäº¤Jobï¼Œéœ€è¦ç”¨åˆ°RDDçš„async actionï¼Œç›®å‰æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">countAsync</span><br><span class="line">collectAsync</span><br><span class="line">takeAsync</span><br><span class="line">foreachAsync</span><br><span class="line">foreachPartitionAsync</span><br></pre></td></tr></table></figure>

<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">sc.setLocalProperty(<span class="string">&quot;spark.scheduler.pool&quot;</span>,<span class="string">&quot;test&quot;</span>)</span><br><span class="line">b.foreachAsync(_=&gt;<span class="type">Thread</span>.sleep(<span class="number">100</span>))</span><br><span class="line">sc.setLocalProperty(<span class="string">&quot;spark.scheduler.pool&quot;</span>,<span class="string">&quot;production&quot;</span>)</span><br><span class="line">b.foreachAsync(_=&gt;<span class="type">Thread</span>.sleep(<span class="number">100</span>))</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±ä¼šæœ‰ä¸¤ä¸ªä»»åŠ¡åœ¨ä¸åŒçš„poolåŒæ—¶è¿è¡Œï¼š</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/pools.png" alt="pools.png"></p>
<h4 id="FAIR-modeåº”ç”¨åœºæ™¯"><a href="#FAIR-modeåº”ç”¨åœºæ™¯" class="headerlink" title="FAIR modeåº”ç”¨åœºæ™¯"></a>FAIR modeåº”ç”¨åœºæ™¯</h4><p>åœºæ™¯1ï¼šSpark SQL thrift server<br>ä½œç”¨ï¼šè®©ç¦»çº¿ä»»åŠ¡å’Œäº¤äº’å¼æŸ¥è¯¢ä»»åŠ¡åˆ†é…åˆ°ä¸åŒçš„poolï¼Œç»™äº¤äº’å¼æŸ¥è¯¢ä»»åŠ¡æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œè¿™æ ·é•¿æ—¶é—´è¿è¡Œçš„ç¦»çº¿ä»»åŠ¡å°±ä¸ä¼šä¸€ç›´å ç”¨æ‰€æœ‰èµ„æºï¼Œé˜»å¡äº¤äº’å¼æŸ¥è¯¢ä»»åŠ¡ã€‚</p>
<p>åœºæ™¯2ï¼šStreaming jobä¸Batch jobåŒæ—¶è¿è¡Œ<br>ä½œç”¨ï¼šæ¯”å¦‚ç”¨Streamingæ¥æ•°æ®å†™å…¥HDFSï¼Œå¯èƒ½äº§ç”Ÿå¾ˆå¤šå°æ–‡ä»¶ï¼Œå¯ä»¥åœ¨ä½ä¼˜å…ˆçº§çš„poolå®šæ—¶è¿è¡Œbatch jobåˆå¹¶å°æ–‡ä»¶ã€‚</p>
<p>å¦å¤–å¯ä»¥å‚è€ƒSpark Summit 2017çš„åˆ†äº«ï¼š<a href="https://www.slideshare.net/databricks/continuous-application-with-fair-scheduler-with-robert-xue">Continuous Application with FAIR Scheduler</a></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://book.douban.com/subject/30157181/">Sparkå†…æ ¸è®¾è®¡çš„è‰ºæœ¯</a></p>
<p><a href="https://blog.csdn.net/xianpanjia4616/article/details/84405145">sparkä»»åŠ¡è°ƒåº¦FIFOå’ŒFAIRçš„è¯¦è§£</a></p>
<p><a href="https://spark.apache.org/docs/latest/job-scheduling.html">Job Scheduling</a></p>
<p>è½¬è½½è¯·æ³¨æ˜åŸæ–‡åœ°å€ï¼š<br><a href="https://liam-blog.ml/2019/11/07/spark-core-scheduler/">https://liam-blog.ml/2019/11/07/spark-core-scheduler/</a></p>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>Spark Core</tag>
        <tag>Scheduler</tag>
      </tags>
  </entry>
  <entry>
    <title>Spark Core è§£æ 3ï¼šShuffle</title>
    <url>/2019/12/29/spark-core-shuffle/</url>
    <content><![CDATA[<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>æ‰€è°“shuffleå°±æ˜¯å°†æ•°æ®æŒ‰æ–°çš„è§„åˆ™è¿›è¡Œåˆ†åŒºçš„è¿‡ç¨‹ï¼Œå°†æ•°æ®åˆ†åŒºä»æ—§åˆ†åŒºè½¬å˜æˆæ–°åˆ†åŒºã€‚</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/20191229115009.png" alt="20191229115009.png"></p>
<span id="more"></span>

<p>è¿™ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µç§°ä¸ºshuffle writeï¼Œæ¯ä¸ªè®¡ç®—èŠ‚ç‚¹éœ€è¦å¯¹è‡ªå·±æŒæœ‰çš„é‚£éƒ¨åˆ†æ•°æ®æŒ‰æ–°åˆ†åŒºè§„åˆ™è¿›è¡Œé‡æ–°åˆ†åŒºï¼Œå¹¶æŒ‰æ–°åˆ†åŒºå†™å…¥æ–‡ä»¶ã€‚<br>shuffle writeå®Œæˆåï¼ŒåŒä¸€ä¸ªæ–°åˆ†åŒºçš„æ•°æ®ä¼šåˆ†æ•£åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œè¿™æ ·æ˜¯ä¸åˆ©äºæ¥ä¸‹æ¥çš„è®¡ç®—çš„ï¼Œå¿…é¡»æŠŠåŒä¸€ä¸ªæ–°åˆ†åŒºçš„æ•°æ®æ±‡é›†åˆ°ä¸€ä¸ªèŠ‚ç‚¹æ‰è¡Œï¼Œæ‰€ä»¥éœ€è¦ç¬¬äºŒé˜¶æ®µshuffle readã€‚<br>shuffle readé˜¶æ®µå°†æŒ‰ç…§æ–°åˆ†åŒºï¼Œæ‹‰å–shuffle writeç”Ÿæˆçš„æ–‡ä»¶ï¼Œç›¸åŒæ–°åˆ†åŒºçš„æ•°æ®æ±‡é›†åˆ°åŒä¸€èŠ‚ç‚¹ï¼Œç»„åˆæˆæ–°çš„åˆ†åŒºï¼Œè¿™æ ·æ‰ç®—æ˜¯å®ç°äº†æ–°çš„æ•°æ®åˆ†åŒºã€‚</p>
<p>Sparkä¸­è´Ÿè´£å®ç°shuffleçš„ç»„ä»¶æ˜¯ShuffleMangerï¼Œå…¶æ ¸å¿ƒæ˜¯ShuffleWriterå’ŒShuffleReaderä¸¤å—ï¼Œåˆ†åˆ«è´Ÿè´£shuffle writeå’Œreadçš„å®ç°ã€‚</p>
<p>ä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºï¼ŒSparkçš„ShuffleMangerç»è¿‡ä¸æ–­çš„å‘å±•ï¼Œåˆ°ç›®å‰åªå‰©ä¸‹äº†ä¸€ç§å³SortShuffleManagerï¼Œæœ¬æ–‡çš„åˆ†æå³æ˜¯åŸºäºè¿™ç§å®ç°ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/Shuffle-history.png" alt="Shuffle-history.png"></p>
<h3 id="ShuffleWriteræ¦‚è¿°"><a href="#ShuffleWriteræ¦‚è¿°" class="headerlink" title="ShuffleWriteræ¦‚è¿°"></a>ShuffleWriteræ¦‚è¿°</h3><p>é¡¾åæ€ä¹‰ï¼ŒShuffleWriterå°±æ˜¯Sparkä¸­è´Ÿè´£shuffle writeé˜¶æ®µçš„ç»„ä»¶å•¦ã€‚</p>
<p>Spark2.xä¸­è™½ç„¶åªæœ‰ä¸€ç§Shuffleç®¡ç†å™¨(SortShuffleManager)ï¼Œä½†æ˜¯æ”¯æŒ3ç§ä¸åŒè¡Œä¸ºçš„ShuffleWriterï¼Œåˆ†åˆ«æ˜¯SortShuffleWriterã€BypassMergeSortShuffleWriterã€UnsafeShuffleWriterã€‚</p>
<p>ä¸‹é¢å…ˆç®€å•ä»‹ç»ä¸‹è¿™å‡ ç§ShuffleWriterï¼Œç„¶åå†åšè¯¦ç»†åˆ†æã€‚</p>
<h4 id="BypassMergeSortShuffleWriter"><a href="#BypassMergeSortShuffleWriter" class="headerlink" title="BypassMergeSortShuffleWriter"></a>BypassMergeSortShuffleWriter</h4><p>ç»•è¿‡æ’åºå’Œèšåˆçš„ShuffleWriterï¼Œè¿™ä¸ªæ˜¯shuffle writeæœ€æœ´ç´ çš„å®ç°ã€‚<br>å®ƒå°†æ•°æ®æŒ‰æ–°åˆ†åŒºå†™åˆ°ä¸åŒçš„æ–‡ä»¶ï¼Œæœ€åå†æŠŠè¿™äº›æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ï¼ŒåŒæ—¶ç”Ÿæˆä¸€ä¸ªç´¢å¼•æ–‡ä»¶æ¥æ ‡è¯†æ•°æ®å—ä¸åˆ†åŒºçš„å¯¹åº”å…³ç³»ã€‚</p>
<h4 id="SortShuffleWriter"><a href="#SortShuffleWriter" class="headerlink" title="SortShuffleWriter"></a>SortShuffleWriter</h4><p>è¿™æ˜¯åŸºäºæ’åºçš„ShuffleWriterï¼Œåœ¨BypassMergeSortShuffleWriterçš„åŸºç¡€ä¹‹ä¸Šï¼Œå®ƒå¯ä»¥æ”¯æŒå¯¹æ•°æ®è¿›è¡Œèšåˆï¼Œè€Œä¸”ä¼šå¯¹æ•°æ®è¿›è¡Œåˆ†åŒºæ’åºã€‚</p>
<p>PS:ä¸ºä»€ä¹ˆshuffle writeé˜¶æ®µè¦å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Ÿ<br>å› ä¸ºreduceæ“ä½œé€šå¸¸ä¼šè¦å¯¹æ•°æ®æ’åºï¼Œå¦‚æœåœ¨mapç«¯è¿›è¡Œä¸€æ¬¡åˆæ’ï¼Œå¯ä»¥å‡è½»reduceçš„å‹åŠ›ã€‚</p>
<h4 id="UnsafeShuffleWriter"><a href="#UnsafeShuffleWriter" class="headerlink" title="UnsafeShuffleWriter"></a>UnsafeShuffleWriter</h4><p>å¯ä»¥ä½¿ç”¨å †å¤–å†…å­˜çš„ShuffleWriterï¼Œå®ƒçš„è¡Œä¸ºç›¸å½“äºä¸å¸¦èšåˆåŠŸèƒ½çš„SortShuffleWriterï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨å †å¤–å†…å­˜æé«˜æ€§èƒ½ã€‚</p>
<p>å¦ä¸€ä¸ªä¼˜åŒ–ç‚¹æ˜¯ï¼Œæ”¯æŒå¯¹åºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æ•°æ®æ’åºï¼Œä¸ä»…èƒ½å‡å°‘å†…å­˜çš„æ¶ˆè€—(å› ä¸ºåºåˆ—åŒ–åçš„æ•°æ®æ›´ç´§å‡‘)ï¼Œä¹Ÿèƒ½é¿å…å¤šæ¬¡åºåˆ—åŒ–ååºåˆ—åŒ–(æº¢å‡ºåˆ°æ–‡ä»¶æ—¶éœ€è¦åºåˆ—åŒ–ï¼Œåˆå¹¶æ–‡ä»¶æ—¶éœ€è¦ååºåˆ—åŒ–)çš„æ€§èƒ½æŸè€—ã€‚</p>
<h4 id="ä¼šé‡‡ç”¨å“ªä¸ªShuffleWriter"><a href="#ä¼šé‡‡ç”¨å“ªä¸ªShuffleWriter" class="headerlink" title="ä¼šé‡‡ç”¨å“ªä¸ªShuffleWriter"></a>ä¼šé‡‡ç”¨å“ªä¸ªShuffleWriter</h4><p>Sparkè‡ªèº«ä¼šæŒ‰å¦‚ä¸‹è§„åˆ™å¯¹ShuffleWriterè¿›è¡Œé€‰æ‹©ï¼Œä»ä¸Šå¾€ä¸‹ä¾æ¬¡åˆ¤æ–­ï¼š</p>
<ul>
<li>1 å½“åˆ†åŒºæ•°(æŒ‰æ–°è§„åˆ™çš„)å°äºç­‰äºé…ç½®<code>spark.shuffle.sort.bypassMergeThreshold(é»˜è®¤ä¸º200)</code>çš„å€¼ï¼Œä½¿ç”¨BypassMergeSortShuffleWriterï¼›</li>
<li>2 å¦‚æœå½“å‰ä¾èµ–çš„serializerçš„åºåˆ—åŒ–ç»“æœæ”¯æŒé‡æ’(åé¢è§£é‡Š)ï¼Œåˆ™ä½¿ç”¨UnsafeShuffleWriterï¼›</li>
<li>3 å¦åˆ™é‡‡ç”¨SortShuffleWriterã€‚</li>
</ul>
<h3 id="ShuffleReaderæ¦‚è¿°"><a href="#ShuffleReaderæ¦‚è¿°" class="headerlink" title="ShuffleReaderæ¦‚è¿°"></a>ShuffleReaderæ¦‚è¿°</h3><p>ShuffleReaderåªæœ‰ä¸€ç§å³BlockStoreShuffleReaderï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä»BlockStoreè¯»å–shuffleæ•°æ®ã€‚<br>åœ¨è¿›è¡Œshuffle readæ—¶ï¼Œä¼šå¼‚æ­¥æ‹‰å–æ•°æ®åˆ°å†…å­˜æˆ–ç£ç›˜(å¤§å°è¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶)ã€‚æ‹‰å–æ•°æ®çš„åŒæ—¶å¯¹æ•°æ®è¿›è¡Œèšåˆ(å¦‚æœå®šä¹‰äº†èšåˆå™¨)å’Œæ’åº(å¦‚æœå®šä¹‰äº†æ’åºå™¨)æ“ä½œã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œ<strong>åŸºæœ¬æ¦‚å¿µè®²è§£å®Œæ¯•ï¼Œä¸‹é¢å¼€å§‹è®²åŸç†ã€‚</strong></p>
<h2 id="Sorter-æ’åºå™¨"><a href="#Sorter-æ’åºå™¨" class="headerlink" title="Sorter æ’åºå™¨"></a>Sorter æ’åºå™¨</h2><p>åœ¨shuffleè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªæ­¥éª¤ä¸ä»…æ¯”è¾ƒè€—è´¹èµ„æºï¼Œä¹Ÿæ˜¯æ€§èƒ½ç“¶é¢ˆä¹‹ä¸€ï¼Œè¿™ä¸ªæ­¥éª¤å°±æ˜¯æ’åºï¼Œç”¨æ¥æ’åºçš„ç»„ä»¶ç§°ä¸ºSorterã€‚</p>
<p>è¦ç†è§£è¿™3ç§ShuffleWriterçš„åŒºåˆ«ï¼Œå¿…é¡»å…ˆäº†è§£Sorterï¼Œå› ä¸ºä»–ä»¬çš„æ’åºè¿‡ç¨‹ä¾èµ–ä¸åŒçš„Sorterï¼Œå¯¼è‡´ä»–ä»¬çš„è¡Œä¸ºå„å¼‚ã€‚</p>
<p>SortShuffleWriterä½¿ç”¨çš„æ˜¯ExternalSorterï¼Œ<br>UnsafeShuffleWriteré‡‡ç”¨çš„æ˜¯ShuffleExternalSorterï¼ŒBypassMergeSortShuffleWriteråˆ™æ²¡æœ‰ä½¿ç”¨Sorterã€‚</p>
<h3 id="ExternalSorter-å¤–éƒ¨æ’åºå™¨"><a href="#ExternalSorter-å¤–éƒ¨æ’åºå™¨" class="headerlink" title="ExternalSorter å¤–éƒ¨æ’åºå™¨"></a>ExternalSorter å¤–éƒ¨æ’åºå™¨</h3><p>é™¤äº†æ’åºï¼Œè¿™ä¸ªæ’åºå™¨è¿˜æ”¯æŒæ•°æ®çš„èšåˆå’Œæº¢å†™åˆ°ç£ç›˜ã€‚å®ƒä½¿ç”¨åˆ°äº†å‡ ä¸ªé‡è¦çš„<strong>æ•°æ®ç»“æ„</strong>ï¼Œä¸‹é¢è¯¦ç»†ä»‹ç»ä¸‹ã€‚</p>
<h4 id="AppendOnlyMap-ï¼ˆåˆ’é‡ç‚¹ï¼‰"><a href="#AppendOnlyMap-ï¼ˆåˆ’é‡ç‚¹ï¼‰" class="headerlink" title="AppendOnlyMap ï¼ˆåˆ’é‡ç‚¹ï¼‰"></a>AppendOnlyMap ï¼ˆåˆ’é‡ç‚¹ï¼‰</h4><p>AppendOnlyMapæ˜¯ä¸€ä¸ªæ”¯æŒæ–°å¢å’Œä¿®æ”¹çš„å“ˆå¸Œè¡¨ï¼Œä½†æ˜¯ä¸æ”¯æŒåˆ é™¤å…ƒç´ ã€‚</p>
<p>åº•å±‚å­˜å‚¨ç»“æ„å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªæ•°ç»„<code>Array[AnyRef]</code>ï¼Œå…ƒç´ çš„keyå’Œvalueç´§æŒ¨ç€å­˜æ”¾ï¼Œåƒè¿™æ ·ï¼š<code>key0,value0,null,null,...,key1,value1,...</code>ã€‚å‡å¦‚AppendOnlyMapçš„å®¹é‡ä¸ºcapacityï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°ç»„çš„å¤§å°å°±æ˜¯2 * capacityã€‚</p>
<p>keyåˆ°æ•°ç»„ç´¢å¼•çš„æ˜ å°„ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯å¯¹keyè®¡ç®—hashå€¼ï¼Œç„¶åå¯¹å®¹é‡å–æ¨¡ï¼Œæœ€åä¹˜ä»¥2ï¼Œ<code>hash(key) % capacity * 2</code>ã€‚å¦‚æœå‘ç”Ÿäº†å“ˆå¸Œå†²çªï¼Œåˆ™ç»§ç»­æ¢æµ‹åé¢çš„ä½ç½®ï¼Œç¬¬ä¸€æ¬¡æ¢æµ‹+2çš„ä½ç½®ï¼Œç¬¬äºŒæ¬¡æ¢æµ‹+2+4çš„ä½ç½®ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå¯ä»¥æ€»ç»“å‡ºä¸€ä¸ªå…¬å¼ $idx+2*\sum_{i&#x3D;1}^{k}i$ ï¼Œå…¶ä¸­idxæ˜¯æ ¹æ®hashå€¼è®¡ç®—å‡ºçš„ä½ç½®ï¼Œkä»£è¡¨æ¢æµ‹æ¬¡æ•°ã€‚</p>
<h5 id="è·å–å…ƒç´ "><a href="#è·å–å…ƒç´ " class="headerlink" title="è·å–å…ƒç´ "></a>è·å–å…ƒç´ </h5><p>å¦‚ä½•å–å‡ºå…ƒç´ å‘¢ï¼Œæ¯”å¦‚æ•°æ®ç»„åä¸ºdataï¼Œkeyè®¡ç®—å‡ºç´¢å¼•ä¸º4ï¼Œå¦‚æœdata(4)&#x3D;&#x3D;keyï¼Œé‚£ä¹ˆå¯¹åº”çš„å€¼å°±æ˜¯data(5)ï¼Œå¦‚æœdata(4)!&#x3D;keyï¼Œé‚£ç»§ç»­æ£€æŸ¥data(4+2)ã€data(4+2+4)ç­‰ç­‰æ˜¯å¦ç­‰äºkeyã€‚</p>
<p>PSï¼šæ”¯æŒkeyä¸ºnullçš„å…ƒç´ ï¼Œå•ç‹¬å­˜å‚¨åœ¨ä¸€ä¸ªå˜é‡ä¸­ï¼›<br>å®¹é‡æœ‰ä¸ªçº¦æŸï¼Œå®ƒä¸€å®šæ˜¯2çš„å¹‚ã€‚</p>
<h5 id="æ’å…¥å…ƒç´ "><a href="#æ’å…¥å…ƒç´ " class="headerlink" title="æ’å…¥å…ƒç´ "></a>æ’å…¥å…ƒç´ </h5><p>å…ˆæ ¹æ®ä¸Šé¢çš„æ–¹æ³•ï¼Œè®¡ç®—å‡ºkeyå¯¹åº”çš„æ•°æ®ç´¢å¼•idxï¼Œå¦‚æœidxä¸Šæ²¡æœ‰å­˜å‚¨æ•°æ®ï¼Œé‚£å°±ç›´æ¥åœ¨idxå­˜ä¸‹keyï¼Œidx+1çš„ä½ç½®å­˜ä¸‹valueã€‚å¦‚æœidxä¸Šå·²ç»å­˜äº†æ•°ï¼Œåˆšå¥½å°±æ˜¯è¦æ’å…¥çš„keyå€¼ï¼Œé‚£ä¹Ÿå¥½åŠï¼Œç›´æ¥æ›´æ–°valueå³å¯ã€‚</p>
<p>è‹¥idxä¸Šå·²ç»å­˜äº†å¦ä¸€ä¸ªkeyå€¼ï¼Œé‚£å°±å‘ç”Ÿå†²çªäº†ã€‚æ¥ä¸‹æ¥å°è¯•idx+2çš„ä½ç½®ï¼Œå¦‚æœç»§ç»­å†²çªï¼Œåˆ™ç»§ç»­å°è¯•idx+2+4ã€idx+2+4+6ã€â€¦çš„ä½ç½®ï¼Œç›´åˆ°æˆåŠŸã€‚</p>
<h5 id="èšåˆå…ƒç´ "><a href="#èšåˆå…ƒç´ " class="headerlink" title="èšåˆå…ƒç´ "></a>èšåˆå…ƒç´ </h5><p>ç”¨æ¥ä¿®æ”¹å…ƒç´ çš„APIæ˜¯<code>changeValue(key: K, updateFunc: (Boolean, V) =&gt; V): V</code>ï¼Œå¤„ç†æµç¨‹åŸºæœ¬ä¸æ’å…¥å…ƒç´ ä¸€æ ·ï¼Œåªæ˜¯å½“keyå·²ç»å­˜åœ¨æ—¶ï¼Œä¼šç”¨updateFuncå¤„ç†æ—§å€¼ä¸æ–°å€¼ï¼Œå¦‚æœä¼ å…¥çš„updateFuncæ˜¯å°†æ–°å€¼ä¸æ—§å€¼mergeçš„å‡½æ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨changeValueæ–¹æ³•æ¥å®ç°å…ƒç´ èšåˆçš„ç›®çš„ã€‚</p>
<h5 id="å†…ç½®æ’åº"><a href="#å†…ç½®æ’åº" class="headerlink" title="å†…ç½®æ’åº"></a>å†…ç½®æ’åº</h5><p>è¿›è¡Œæ’åºçš„APIæ˜¯<code>destructiveSortedIterator(keyComparator: Comparator[K]): Iterator[(K, V)]</code>ï¼Œéœ€è¦ä¼ å…¥ç”¨æ¥æ¯”è¾ƒkeyçš„æ¯”è¾ƒå™¨ï¼Œè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ã€‚</p>
<p>å‡½æ•°é¦–å…ˆè¦å¯¹åº•å±‚æ•°ç»„è¿›è¡Œæ•´ç†ï¼Œå°†å„å…ƒç´ å‘å‰ç§»åŠ¨ï¼Œä½¿å¾—å…ƒç´ ç´§æŒ¨ç€æ’åˆ—ï¼Œä¹Ÿå°±æ˜¯æŠŠæ•°ç»„ä¸­ç©ºç€çš„ä½ç½®ç”¨åé¢çš„å…ƒç´ å¡«ä¸Šï¼Œç„¶åä½¿ç”¨TimSortæ’åºç®—æ³•(æ’å…¥æ’åºä¸å½’å¹¶æ’åºç»“åˆçš„ä¸€ç§ç®—æ³•)å¯¹æ•°ç»„è¿›è¡Œæ’åº(ä½¿ç”¨ä¼ å…¥çš„Comparatoræ¯”è¾ƒkey)ï¼Œæœ€åè¾“å‡ºè¿™ä¸ªæ’åºåæ•°ç»„çš„è¿­ä»£å™¨ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»è¿‡æ’åºåï¼ŒAppendOnlyMapå˜æˆäº†destroyedçŠ¶æ€ï¼Œä¸å†æ”¯æŒæ–°å¢å’Œä¿®æ”¹å…ƒç´ ï¼Œåªèƒ½é€šè¿‡è¿­ä»£å™¨è®¿é—®å…ƒç´ ã€‚</p>
<h5 id="å°ç»“ä¸€ä¸‹"><a href="#å°ç»“ä¸€ä¸‹" class="headerlink" title="å°ç»“ä¸€ä¸‹"></a>å°ç»“ä¸€ä¸‹</h5><p>AppendOnlyMapæ˜¯ä¸€ä¸ªç±»ä¼¼mapçš„æ•°æ®ç»“æ„ï¼Œæ”¯æŒå¯¹ç›¸åŒå…ƒç´ è¿›è¡Œèšåˆï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å¯¹å…ƒç´ è¿›è¡Œæ’åºï¼Œä½†æ˜¯ä¸æ”¯æŒåˆ é™¤å…ƒç´ ã€‚</p>
<h4 id="PartitionedAppendOnlyMap"><a href="#PartitionedAppendOnlyMap" class="headerlink" title="PartitionedAppendOnlyMap"></a>PartitionedAppendOnlyMap</h4><p>æ˜¯AppendOnlyMapçš„å­ç±»ï¼Œç»§æ‰¿äº†AppendOnlyMapçš„åŠŸèƒ½ï¼Œè¿˜å¦å¤–å®ç°äº†SizeTrackerå’ŒWritablePartitionedPairCollectionç‰¹è´¨ï¼Œä¸»è¦æ˜¯å¢åŠ äº†é›†åˆå¤§å°ä¼°ç®—(ä½¿ç”¨å†…å­˜å¤§å°)ã€æŒ‰åˆ†åŒºå’Œkeyæ’åºã€å†™å…¥ç£ç›˜çš„åŠŸèƒ½ã€‚</p>
<h4 id="PartitionedPairBuffer"><a href="#PartitionedPairBuffer" class="headerlink" title="PartitionedPairBuffer"></a>PartitionedPairBuffer</h4><p>åº•å±‚æ˜¯ä¸AppendOnlyMapä½¿ç”¨çš„ä¸€æ ·çš„æ•°ç»„ï¼Œä½†æ˜¯å…ƒç´ ä¸æŒ‰å“ˆå¸Œå€¼å­˜å‚¨ï¼Œè€Œæ˜¯é¡ºåºå­˜å‚¨(è¿™æ ·æ’åºå‰å°±ä¸éœ€è¦æ•´ç†æ•°æ®äº†)ï¼ŒåŒæ ·æ”¯æŒæ’åºï¼Œä½†æ˜¯ä¸æ”¯æŒå¯¹å…ƒç´ çš„èšåˆ(å› ä¸ºé‡‡ç”¨çš„å­˜å‚¨æ–¹å¼ä¸æ”¯æŒéšæœºå­˜å–å…ƒç´ )ã€‚<br>ä¸PartitionedAppendOnlyMapç±»ä¼¼ï¼Œæ”¯æŒé›†åˆå¤§å°ä¼°ç®—(ä½¿ç”¨å†…å­˜å¤§å°)ã€æŒ‰åˆ†åŒºå’Œkeyæ’åºã€å†™å…¥ç£ç›˜çš„åŠŸèƒ½ã€‚</p>
<h4 id="ExternalSorter-åŸç†"><a href="#ExternalSorter-åŸç†" class="headerlink" title="ExternalSorter åŸç†"></a>ExternalSorter åŸç†</h4><p>ExternalSorterä½¿ç”¨äº†PartitionedAppendOnlyMapå’ŒPartitionedPairBufferä½œä¸º<strong>æ•°æ®buffer</strong>ï¼Œæˆ–è€…è¯´æ•°æ®å®¹å™¨ï¼š</p>
<ul>
<li>å½“éœ€è¦è¿›è¡Œmapç«¯èšåˆçš„æ—¶å€™ï¼Œä½¿ç”¨PartitionedAppendOnlyMapå­˜å‚¨æ•°æ®ï¼Œè¿™æ ·å°±æ‹¥æœ‰äº†å¯¹æ•°æ®è¿›è¡Œèšåˆå’Œåˆ†åŒºæ’åºåŠŸèƒ½ï¼›</li>
<li>å½“ä¸éœ€è¦è¿›è¡Œmapç«¯èšåˆçš„æ—¶å€™ï¼Œä½¿ç”¨PartitionedPairBufferï¼Œå°±è·å¾—äº†æ€§èƒ½æ›´å¥½(å› ä¸ºä¸éœ€è¦æ•´ç†æ•°æ®)çš„åˆ†åŒºæ’åºåŠŸèƒ½ã€‚</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼ŒExternalSorterçš„åŠŸèƒ½æœ‰ï¼šç¼“å†²æ•°æ®ã€åˆ†åŒºæ’åºã€è¾“å‡ºæ’åºåçš„æ•°æ®åˆ°æ–‡ä»¶ã€‚</p>
<h5 id="æº¢å†™"><a href="#æº¢å†™" class="headerlink" title="æº¢å†™"></a>æº¢å†™</h5><p>å¦å¤–ï¼ŒExternalSorterå®ç°äº†å°†æ•°æ®æº¢å‡ºåˆ°ç£ç›˜çš„åŠŸèƒ½ï¼Œè¿™æ ·å³ä½¿å†…å­˜æ— æ³•è£…ä¸‹æ‰€æœ‰çš„æ•°æ®ï¼Œä¹Ÿèƒ½è¿›è¡Œåˆ†åŒºæ’åºã€‚æº¢å†™åˆ°ç£ç›˜çš„æ•°æ®ï¼Œæœ€ç»ˆä¼šä¸å†…å­˜ä¸­çš„æ•°æ®åˆå¹¶åå†æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚</p>
<p>æ‰€è°“æº¢å†™ï¼Œæ˜¯æŒ‡å†…å­˜è£…ä¸ä¸‹ä¸æ–­å¢åŠ çš„æ•°æ®äº†ï¼Œåªå¥½æŠŠå†…å­˜ä¸­çš„æ•°æ®å†™åˆ°ç£ç›˜çš„è¿‡ç¨‹ã€‚<br>ExternalSorterçš„æº¢å†™è¿‡ç¨‹å¤§è‡´æ˜¯ï¼š</p>
<ul>
<li>1 å½“bufferå†…å­˜ä½¿ç”¨é‡å¤§äºé˜ˆå€¼ï¼Œå¹¶ä¸”ç”³è¯·ä¸åˆ°æ›´å¤šå†…å­˜çš„æ—¶å€™ï¼Œå¯åŠ¨æº¢å†™ï¼›</li>
<li>2 è°ƒç”¨bufferçš„æ’åºå‡½æ•°ï¼Œå¹¶å°†æ•°æ®å†™å…¥ç£ç›˜ï¼›</li>
<li>3 åˆ›å»ºä¸€ä¸ªæ–°çš„bufferï¼Œç»§ç»­æ¥å—æ–°æ•°æ®ã€‚</li>
</ul>
<p>è¾“å‡ºæœ€ç»ˆç»“æœçš„æ—¶å€™ï¼Œä¼šæŠŠæ‰€æœ‰çš„æº¢å†™æ–‡ä»¶ï¼Œè¿åŒå†…å­˜ä¸­çš„æ•°æ®ï¼Œé€šè¿‡å½’å¹¶æ’åº(merge sort)åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ã€‚</p>
<h3 id="ShuffleExternalSorter"><a href="#ShuffleExternalSorter" class="headerlink" title="ShuffleExternalSorter"></a>ShuffleExternalSorter</h3><p>è¿™ä¹Ÿæ˜¯ä¸€ç§å¤–éƒ¨æ’åºå™¨ï¼Œæ”¯æŒåˆ†åŒºæ’åºå’Œæ•°æ®æº¢å‡ºåˆ°ç£ç›˜ï¼Œä½†æ˜¯ä¸æ”¯æŒæ•°æ®èšåˆï¼Œä¹Ÿä¸æ”¯æŒåˆå¹¶æº¢å†™æ–‡ä»¶ã€‚æº¢å†™æ–‡ä»¶åˆå¹¶çš„å·¥ä½œç”±UnsafeShuffleWriterå®Œæˆã€‚<br>æ¯”è¾ƒç‰¹åˆ«çš„æ˜¯ï¼Œè¿™ä¸ªæ’åºå™¨å¯ä»¥ä½¿ç”¨å †å¤–(off-heap)å†…å­˜ï¼Œå› ä¸ºä½¿ç”¨äº†Unsafeç±»æ“ä½œå†…å­˜ã€‚Unsafeç±»ä¸ä»…èƒ½æ“ä½œoff-heapå†…å­˜ï¼Œä¹Ÿèƒ½æ“ä½œon-heapå†…å­˜ï¼Œæ‰€ä»¥ShuffleExternalSorteræ˜¯æ—¢èƒ½ä½¿ç”¨å †å†…å†…å­˜ï¼Œä¹Ÿèƒ½ä½¿ç”¨å †å¤–å†…å­˜çš„ã€‚</p>
<h3 id="ShuffleReader"><a href="#ShuffleReader" class="headerlink" title="ShuffleReader"></a>ShuffleReader</h3><p>ShuffleReaderåªæœ‰ä¸€ç§å³BlockStoreShuffleReaderã€‚<br>åœ¨è¿›è¡Œshuffle readæ—¶ï¼Œä¼šå…ˆåˆ›å»ºShuffleBlockFetcherIteratorï¼Œé€šè¿‡ShuffleClientå¼€å§‹å¼‚æ­¥æ‹‰å–æ•°æ®åˆ°å†…å­˜æˆ–ç£ç›˜(å¤§å°è¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶)ã€‚æ‹‰å–æ•°æ®çš„åŒæ—¶å¯¹æ•°æ®è¿›è¡Œèšåˆ(å¦‚æœå®šä¹‰äº†èšåˆå™¨)å’Œæ’åº(å¦‚æœå®šä¹‰äº†æ’åºå™¨)æ“ä½œã€‚å…¶ä¸­èšåˆæ“ä½œä½¿ç”¨çš„æ˜¯ExternalAppendOnlyMapï¼Œæ’åºåˆ™æ˜¯ä½¿ç”¨ExternalSorterã€‚</p>
<h2 id="ç»å…¸çš„SortShuffleè¿‡ç¨‹"><a href="#ç»å…¸çš„SortShuffleè¿‡ç¨‹" class="headerlink" title="ç»å…¸çš„SortShuffleè¿‡ç¨‹"></a>ç»å…¸çš„SortShuffleè¿‡ç¨‹</h2><h3 id="ç®€åŒ–ç‰ˆæœ¬"><a href="#ç®€åŒ–ç‰ˆæœ¬" class="headerlink" title="ç®€åŒ–ç‰ˆæœ¬"></a>ç®€åŒ–ç‰ˆæœ¬</h3><p>shuffle writeé˜¶æ®µï¼š</p>
<ul>
<li>1 SortShuffleWriterä¸æ–­ä»RDDçš„è¿­ä»£å™¨å–å‡ºæ•°æ®å¹¶å­˜å…¥bufferã€‚å¦‚æœæœ‰å®šä¹‰èšåˆæ“ä½œï¼Œä¼šé‡‡ç”¨PartitionedAppendOnlyMapä½œä¸ºbufferï¼Œè¾¹æ’å…¥è¾¹èšåˆæ•°æ®ï¼Œå¦åˆ™ä½¿ç”¨PartitionedPairBufferï¼Œåªæ’å…¥æ•°æ®ä¸åšèšåˆã€‚å­˜å…¥bufferè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå†…å­˜ä¸å¤Ÿï¼Œä¼šè§¦å‘spillï¼Œå°†æ•°æ®æ’åºåæº¢å†™åˆ°ç£ç›˜ï¼›</li>
<li>2 å¯¹bufferä¸­çš„æ•°æ®æŒ‰æ–°åˆ†åŒºå’Œkeyè¿›è¡Œæ’åºï¼Œå¦‚æœæœ‰spillæ–‡ä»¶ï¼Œåˆ™è¿›è¡Œåˆå¹¶ï¼Œç„¶åè¾“å‡ºä¸€ä¸ªæ•°æ®æ–‡ä»¶(data file)å’Œä¸€ä¸ªç´¢å¼•æ–‡ä»¶(index file)ï¼Œè¿”å›MapStatusã€‚</li>
</ul>
<p>shuffle readé˜¶æ®µï¼š</p>
<ul>
<li>1 BlockStoreShuffleReaderå…ˆé€šè¿‡mapOutputTrackerè·å–éœ€è¦æ‹‰å–çš„blockä¿¡æ¯ï¼Œç„¶åå¼€å§‹æ‹‰å–æ•°æ®åˆ°bufferä¸­ï¼›</li>
<li>2 æ‹‰å–æ•°æ®çš„åŒæ—¶ï¼Œå¦‚æœè¯¥ShuffleDependencyæœ‰å®šä¹‰èšåˆå™¨ï¼Œåˆ™ä¼šé€šè¿‡ExternalAppendOnlyMapå¯¹æ•°æ®è¿›è¡Œèšåˆï¼›æ¥ä¸‹æ¥ï¼Œå¦‚æœè¯¥ShuffleDependencyæœ‰å®šä¹‰æ’åºå™¨ï¼Œåˆ™ä¼šä½¿ç”¨ExternalSorterè¿›è¡Œæ’åºï¼Œæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ã€‚</li>
</ul>
<h3 id="è¯¦ç»†ç‰ˆæœ¬"><a href="#è¯¦ç»†ç‰ˆæœ¬" class="headerlink" title="è¯¦ç»†ç‰ˆæœ¬"></a>è¯¦ç»†ç‰ˆæœ¬</h3><p>å‡è‹¥ä½¿ç”¨çš„æ˜¯SortShuffleWriterå’ŒBlockStoreShuffleReaderï¼Œæ¥ä¸‹æ¥å¯¹ç…§2.4ç‰ˆæœ¬çš„æºç ï¼Œåšä¸ªæ•´ä½“æµç¨‹åˆ†æã€‚</p>
<p>è¿™ä¸€åˆ‡ä»ShuffleMapTaskå¼€å§‹â€¦ ï¼ˆä¸çŸ¥é“ä»€ä¹ˆæ˜¯ShuffleMapTaskï¼Œè¯·çœ‹<a href="https://liam-blog.ml/2019/11/07/spark-core-scheduler/">Spark Coreè§£æ 2ï¼šScheduler è°ƒåº¦ä½“ç³»</a>ï¼‰</p>
<ul>
<li>1 ShuffleMapTaskçš„runTaskæ–¹æ³•è¢«Executorçš„æŸä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œ<strong>taskå¼€å§‹æ‰§è¡Œ</strong>ï¼›</li>
<li>2 runTaskæ–¹æ³•è°ƒç”¨SortShuffleManager.getWriteræ–¹æ³•ï¼Œåˆ›å»ºSortShuffleWriterå®ä¾‹ï¼Œç„¶åè°ƒç”¨SortShuffleWriter.writeæ–¹æ³•ï¼Œ<strong>å¼€å¯shuffle writeé˜¶æ®µ</strong>ï¼›</li>
<li>3 writeæ–¹æ³•ä¸­ä¼šnewä¸€ä¸ªExternalSorterå®ä¾‹ï¼Œå¹¶è°ƒç”¨è¿™ä¸ªå®ä¾‹çš„insertAllæ–¹æ³•ï¼Œå¹¶ä¼ å…¥RDD(æ‰€å±stageæœ€åä¸€ä¸ªRDD)å¯¹åº”çš„ä¸€ä¸ªåˆ†åŒºçš„Iteratorï¼Œ<strong>è¿›å…¥æ•°æ®ç¼“å†²èšåˆé˜¶æ®µ</strong>ï¼›</li>
<li>4 insertAllæ–¹æ³•ä¸­ï¼Œæ¯ä»Iteratorä¸­å–ä¸€ä¸ªå€¼ï¼Œå°±æŠŠè¿™ä¸ªå€¼å­˜å…¥å†…å­˜ä¸­çš„ç¼“å†²æ•°æ®ç»“æ„bufferã€‚ä»Iteratorä¸­å–å€¼ä¼šè§¦å‘RDDä¸Šç”¨æˆ·å®šä¹‰çš„è®¡ç®—é€»è¾‘ï¼Œå–å‡ºçš„è¿™ä¸€æ¡æ•°æ®å…¶å®æ˜¯ä»æ•°æ®æºè¯»å‡ºå¹¶ç»è¿‡å„ç§çˆ¶RDDçš„è®¡ç®—é€»è¾‘åå¾—åˆ°çš„ç»“æœã€‚å¦‚æœæœ‰å®šä¹‰èšåˆæ“ä½œï¼Œä¼šé‡‡ç”¨PartitionedAppendOnlyMapä½œä¸ºbufferï¼Œè¾¹æ’å…¥è¾¹èšåˆæ•°æ®ï¼Œå¦åˆ™ä½¿ç”¨PartitionedPairBufferï¼Œåªæ’å…¥æ•°æ®ä¸åšèšåˆã€‚å­˜å…¥bufferè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå†…å­˜ä¸å¤Ÿï¼Œä¼šè§¦å‘spillï¼Œå°†æ•°æ®æ’åºåæº¢å†™åˆ°ç£ç›˜ï¼Œç„¶ååˆ›å»ºæ–°çš„bufferï¼Œç»§ç»­å­˜å…¥æ•°æ®ï¼›</li>
<li>5 <strong>æ•°æ®å…¨éƒ¨å­˜å…¥bufferåï¼Œå¼€å§‹æ’åºè¾“å‡ºé˜¶æ®µã€‚</strong>SortShuffleWriter.writeæ–¹æ³•è°ƒç”¨ExternalSorter.writePartitionedFileæ–¹æ³•ï¼Œå¯¹bufferä¸­çš„æ•°æ®æŒ‰æ–°åˆ†åŒºå’Œkeyè¿›è¡Œæ’åº(å¦‚æœæœ‰spillæ–‡ä»¶ï¼Œåˆ™åˆ©ç”¨heapç»“æ„è¿›è¡Œmerge sort)ï¼Œç„¶åè¾“å‡ºä¸€ä¸ªæ•°æ®æ–‡ä»¶(data file)å’Œä¸€ä¸ªç´¢å¼•æ–‡ä»¶(index file)ï¼Œç´¢å¼•æ–‡ä»¶ä¸­è®°å½•äº†æ•°æ®æ–‡ä»¶ä¸­æ¯ä¸ªåˆ†åŒºçš„æ•°æ®å¼€å§‹çš„offsetã€‚ï¼ˆæ³¨æ„ï¼šbufferçš„è¾“å…¥æ•°æ®è™½ç„¶åªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œä½†æ˜¯è¾“å‡ºä¼šæŒ‰æ–°åˆ†åŒºæ–¹å¼è¾“å‡ºå¤šä¸ªåˆ†åŒºçš„æ•°æ®ã€‚ï¼‰</li>
<li>6 <strong>writeæ–¹æ³•å†™å®Œæ•°æ®å</strong>ï¼Œè¿”å›MapStatusï¼ˆåŒ…å«shuffleServerIdå’Œåˆ†åŒºä¿¡æ¯ï¼‰ï¼Œæœ€ç»ˆMapStatusä¼šå‘é€ç»™DAGSchedulerï¼Œç„¶åè¢«MapOutputTrackerè®°å½•ä»»åŠ¡ä¿¡æ¯ï¼Œ</li>
<li>7 <strong>shuffle writeç»“æŸï¼Œä¸‹é¢è¯´è¯´shuffle readã€‚</strong><br>shuffle readæ—¢å¯èƒ½å‘ç”Ÿåœ¨ShuffleMapTaskä¹Ÿå¯èƒ½å‘ç”Ÿåœ¨ResultTaskï¼Œè¿™å–å†³äºtaskæ‰€å±stageåŒ…å«çš„RDDçš„dependency<br>æ˜¯å¦å«æœ‰ShuffleDependencyï¼Œå¯¹äºShuffleDependencyï¼ŒRDDçš„computeå‡½æ•°ä¼šè°ƒç”¨BlockStoreShuffleReader.readæ–¹æ³•ï¼Œå¼€å¯readæµç¨‹ã€‚</li>
<li>8 readå‡½æ•°ä¸­ä¼šå…ˆé€šè¿‡mapOutputTrackerè·å–éœ€è¦æ‹‰å–çš„blockä¿¡æ¯ï¼Œç„¶ååˆ›å»ºShuffleBlockFetcherIteratorï¼ŒShuffleBlockFetcherIteratorè¢«åˆ›å»ºåä¼šç«‹å³å¼€å§‹æ‹‰å–æ•°æ®(é€šè¿‡ShuffleClient)ï¼Œæ‹‰å–è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œæ‹‰å–åˆ°çš„æ•°æ®ä¼šæš‚å­˜åˆ°bufferä¸­ã€‚</li>
<li>9 æ‹‰å–æ•°æ®çš„åŒæ—¶ï¼Œå¦‚æœè¯¥ShuffleDependencyæœ‰å®šä¹‰èšåˆå™¨ï¼Œåˆ™ä¼šé€šè¿‡ExternalAppendOnlyMapå¯¹æ•°æ®è¿›è¡Œèšåˆï¼›æ¥ä¸‹æ¥ï¼Œå¦‚æœè¯¥ShuffleDependencyæœ‰å®šä¹‰æ’åºå™¨ï¼Œåˆ™ä¼šä½¿ç”¨ExternalSorterè¿›è¡Œæ’åºã€‚</li>
<li>10 readå‡½æ•°æœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªIteratorï¼Œæˆä¸ºtaskçš„æ•°æ®æ¥æºã€‚</li>
</ul>
<p>å°ç»“ï¼šå¦‚æœæœ‰nä¸ªShuffleMapTaskï¼Œwriteé˜¶æ®µæœ€ç»ˆä¼šç”Ÿæˆ2nä¸ªä¸´æ—¶æ–‡ä»¶(ä¸å«spillæ–‡ä»¶)ï¼Œreadé˜¶æ®µé™¤äº†spillæ–‡ä»¶ä¸ä¼šäº§ç”Ÿä¸´æ—¶æ•°æ®æ–‡ä»¶ã€‚</p>
<h2 id="é»‘ç§‘æŠ€UnsafeShuffleè¿‡ç¨‹"><a href="#é»‘ç§‘æŠ€UnsafeShuffleè¿‡ç¨‹" class="headerlink" title="é»‘ç§‘æŠ€UnsafeShuffleè¿‡ç¨‹"></a>é»‘ç§‘æŠ€UnsafeShuffleè¿‡ç¨‹</h2><p>UnsafeShuffleWriter.writeæ–¹æ³•ï¼Œé—´æ¥è°ƒç”¨ShuffleExternalSorter.insertRecordæ–¹æ³•ï¼Œä¼ å…¥<em>åºåˆ—åŒ–å</em>çš„æ•°æ®recordï¼Œ<strong>æ•°æ®ç¼“å†²è¿‡ç¨‹å¼€å§‹</strong>ï¼›</p>
<ul>
<li>ç¼“å†²é˜¶æ®µç¬¬1æ­¥ï¼Œæ ¹æ®æƒ…å†µè¿›è¡Œæº¢å†™ã€‚<br>ShuffleExternalSorter.insertRecordæ–¹æ³•ä¸­ï¼Œå…ˆæ£€æŸ¥è®°å½•æ•°ï¼Œè¾¾åˆ°é˜ˆå€¼ï¼Œåˆ™è¿›è¡Œspillæº¢å†™ï¼›æº¢å†™è¿‡ç¨‹å¤§è‡´ä¸ºï¼šè°ƒç”¨ShuffleInMemorySorter.getSortedIteratorå¯¹å­˜å…¥çš„recordAddressåœ°å€æ’åºï¼Œè¿™é‡Œåªæ˜¯æŒ‰partitionIdæ’åº(RadixSortå’ŒTimSortä¸¤ç§ç®—æ³•)ï¼ŒæŒ‰ç…§æ’åºå¥½çš„recordAddressï¼Œä¾æ¬¡è¾“å‡ºæ•°æ®(ä»ç„¶æ˜¯åºåˆ—åŒ–åçš„)åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶è®°å½•æ¯ä¸ªpartitionçš„offsetåˆ°SpillInfoä¸­ï¼›</li>
<li>ç¼“å†²é˜¶æ®µç¬¬2æ­¥ï¼Œç”³è¯·å†…å­˜å—pageã€‚<br>å¦‚æœShuffleExternalSorterçš„currentPageç©ºé—´ä¸è¶³ï¼Œä¼šå…ˆç”³è¯·page(å³MemoryBlock)ï¼›ç”³è¯·è¿‡ç¨‹ä¼šä¾æ¬¡ä½¿ç”¨åˆ°TaskMemoryManager.allocatePageå’ŒMemoryManager.tungstenMemoryAllocator().allocateï¼Œä¾æ®MemoryManagerä½¿ç”¨çš„MemoryAllocatoræ˜¯HeapMemoryAllocatorè¿˜æ˜¯UnsafeMemoryAllocatorï¼Œç”³è¯·åˆ°çš„MemoryBlockæ˜¯on-heapå’Œoff-heapç±»å‹åœ°å€çš„å…¶ä¸­ä¸€ç§ï¼›</li>
<li>ç¼“å†²é˜¶æ®µç¬¬3æ­¥ï¼Œæ•°æ®å†™å…¥pageã€‚<br>currentPageç©ºé—´è¶³å¤Ÿåï¼Œä¾æ¬¡å°†recordå­—èŠ‚å¤§å°ï¼Œrecordæœ¬èº«å¤åˆ¶åˆ°currentPageä¸­ä»¥pageCursorå¼€å§‹çš„åœ°å€æ®µä¸­ï¼Œå¹¶å¢åŠ pageCursoræ¸¸æ ‡åœ°å€ï¼›</li>
<li>ç¼“å†²é˜¶æ®µç¬¬4æ­¥ï¼Œä¿å­˜recordåœ°å€ã€‚<br>é€šè¿‡taskMemoryManager.encodePageNumberAndOffsetå¾—åˆ°recordAddressï¼Œè¿åŒpartitionIdå­˜å…¥ShuffleInMemorySorterï¼›</li>
</ul>
<p>å½“æ•°æ®å…¨éƒ¨ç¼“å†²å®Œæ¯•ï¼Œ<strong>å¼€å§‹æ’åºè¾“å‡ºé˜¶æ®µ</strong>ã€‚</p>
<ul>
<li>æ¥ä¸‹æ¥writeæ–¹æ³•ä¼šé—´æ¥è°ƒç”¨ShuffleExternalSorter.writeSortedFileï¼Œå°†å†…å­˜ä¸­å‰©ä¸‹çš„æ•°æ®å…¨éƒ¨æº¢å†™ï¼›</li>
<li>UnsafeShuffleWriter.mergeSpillsæ–¹æ³•å°†spillçš„æ–‡ä»¶å…¨éƒ¨åˆå¹¶æˆä¸€ä¸ªï¼Œè¿™é‡Œä¼šåˆ©ç”¨ä¹‹å‰ä¿å­˜çš„SpillInfoï¼Œå°†ç›¸åŒpartitionçš„æ•°æ®åˆåˆ°ä¸€èµ·ï¼›(è¿™é‡Œåˆå¹¶æœ‰ä¸‰ç§å®ç°ï¼štransferTo-based fast mergeï¼ŒfileStream-based fast mergeï¼Œslow merge)</li>
<li>é€šè¿‡shuffleBlockResolver.writeIndexFileAndCommitåˆ›å»ºç´¢å¼•æ–‡ä»¶ï¼›</li>
<li>è¿”å›mapStatusï¼›</li>
<li><strong>shuffle writeé˜¶æ®µç»“æŸï¼Œreadé˜¶æ®µä¸SortShuffleç›¸åŒ</strong></li>
</ul>
<p>å°ç»“ï¼š<br>å¦‚æœé…ç½®äº†<code>spark.memory.offHeap.enabled</code>å’Œ<code>spark.memory.offHeap.size</code>å‚æ•°ï¼Œåˆ™ä¼šä½¿ç”¨off-heapç¼“å†²æ•°æ®ï¼›</p>
<p>æ•°æ®å’Œåœ°å€æŒ‡é’ˆåˆ†å¼€å­˜å‚¨ï¼Œæ’åºåªæ˜¯å¯¹åœ°å€æŒ‡é’ˆè¿›è¡Œã€‚</p>
<p>UnsafeShuffleWriterçš„é»‘ç§‘æŠ€ä¸»è¦ä½“ç°åœ¨ï¼š</p>
<ul>
<li>writeå…¨ç¨‹åªåœ¨ç¬¬ä¸€æ­¥åšäº†æ•°æ®åºåˆ—åŒ–ï¼Œåé¢æ“ä½œçš„éƒ½æ˜¯åºåˆ—åŒ–åçš„æ•°æ®ï¼Œç”šè‡³å†™æ–‡ä»¶æ—¶ä¹Ÿæ²¡æœ‰å†è¿›è¡Œåºåˆ—åŒ–ï¼›</li>
<li>ä½¿ç”¨off-heapå†…å­˜å­˜å‚¨æ•°æ®ï¼Œå¤§å¤§å‡å°‘JVM GCå‹åŠ›ï¼Œè€Œä¸”é¿å…äº†IOæ—¶æ•°æ®åœ¨å †å†…å †å¤–å†…å­˜ä¹‹é—´çš„æ‹·è´ï¼›</li>
<li>ä½¿ç”¨åœ°å€æŒ‡é’ˆè¿›è¡Œæ’åºï¼Œå‡å°‘äº†åºåˆ—åŒ–ååºåˆ—åŒ–çš„æ€§èƒ½æ¶ˆè€—ï¼›</li>
<li>spillæ–‡ä»¶åˆå¹¶æ—¶ï¼Œâ€˜transferTo-based fast mergeâ€™ä½¿ç”¨NIOæä¾›çš„transferToæ–¹æ³•ï¼Œæ–‡ä»¶æ•°æ®ç›´æ¥åœ¨å†…æ ¸ç©ºé—´(kernel-space)æ‹·è´åˆå¹¶ï¼Œæå‡äº†æ€§èƒ½ã€‚</li>
</ul>
<h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><p><a href="https://book.douban.com/subject/30157181/">Sparkå†…æ ¸è®¾è®¡çš„è‰ºæœ¯</a><br>è½¬è½½è¯·æ³¨æ˜åŸæ–‡åœ°å€ï¼š<a href="https://liam-blog.ml/2019/12/29/spark-core-shuffle/">Liamâ€™s Blog</a></p>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>Spark Core</tag>
        <tag>shuffle</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäºRediså®ç°åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é™æµå™¨</title>
    <url>/2020/03/29/redis-lock-rate-limiter/</url>
    <content><![CDATA[<p>åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é™æµå™¨åº”è¯¥æ˜¯ç®—æ˜¯æ¯”è¾ƒå¸¸è§çš„éœ€æ±‚äº†ï¼Œè€ŒRedisç°åœ¨å‡ ä¹æ˜¯åº”ç”¨çš„æ ‡é…äº†ï¼Œäºæ˜¯å¾ˆå¤šäººä¼šå€¾å‘äºé€‰æ‹©åŸºäºRedisæ¥å®ç°ï¼Œå› ä¸ºä¸éœ€è¦å¼•å…¥é¢å¤–çš„ä¾èµ–ã€‚</p>
<p>åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é™æµå™¨åœ¨Javaé¢†åŸŸæ¯”è¾ƒæˆç†Ÿå’Œå¸¸ç”¨çš„å¼€æºå®ç°æ˜¯Redisson(<a href="https://github.com/redisson/redisson/wiki/Redisson%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D">ä¸­æ–‡å®˜æ–¹ä»‹ç»</a>)ï¼Œä¸‹é¢ä»å®ƒçš„æå°éƒ¨åˆ†æºç ï¼Œåˆ†æä¸‹åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é™æµå™¨çš„å®ç°é€»è¾‘ã€‚</p>
<span id="more"></span>
<h2 id="åˆ†å¸ƒå¼é”çš„å®ç°"><a href="#åˆ†å¸ƒå¼é”çš„å®ç°" class="headerlink" title="åˆ†å¸ƒå¼é”çš„å®ç°"></a>åˆ†å¸ƒå¼é”çš„å®ç°</h2><h3 id="åŠ é”"><a href="#åŠ é”" class="headerlink" title="åŠ é”"></a>åŠ é”</h3><p>Redissonä¸­åŠ é”å®ç°çš„æ ¸å¿ƒæºç å¦‚ä¸‹ï¼Œä¸ºäº†å®ç°æ“ä½œçš„åŸå­æ€§ï¼Œä¸å¾—ä¸ä½¿ç”¨evalå‘½ä»¤åŠ Luaè„šæœ¬çš„æ–¹å¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;T&gt; RFuture&lt;T&gt; <span class="title function_">tryLockInnerAsync</span><span class="params">(<span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId, RedisStrictCommand&lt;T&gt; command)</span> &#123;</span><br><span class="line">    internalLockLeaseTime = unit.toMillis(leaseTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, command,</span><br><span class="line">              <span class="string">&quot;if (redis.call(&#x27;exists&#x27;, KEYS[1]) == 0) then &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;return nil; &quot;</span> +</span><br><span class="line">              <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">              <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;return nil; &quot;</span> +</span><br><span class="line">              <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">              <span class="string">&quot;return redis.call(&#x27;pttl&#x27;, KEYS[1]);&quot;</span>,</span><br><span class="line">                Collections.&lt;Object&gt;singletonList(getName()), internalLockLeaseTime, getLockName(threadId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŠŠä¸Šé¢çš„Luaä»£ç çš„é€»è¾‘ç¿»è¯‘æˆrediså‘½ä»¤ç»„æˆçš„ä¼ªä»£ç ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">//è·å–é”</span><br><span class="line"><span class="keyword">if</span> exists <span class="variable">$lockName</span> == 0</span><br><span class="line">  hset <span class="variable">$lockName</span> <span class="variable">$threadUid</span> 1</span><br><span class="line">  pexpire <span class="variable">$lockName</span> <span class="variable">$expireTime</span></span><br><span class="line">  <span class="built_in">return</span> nil</span><br><span class="line">//é‡å…¥é”</span><br><span class="line"><span class="keyword">if</span> hexists <span class="variable">$lockName</span> <span class="variable">$threadUid</span> == 1</span><br><span class="line">   hincrby <span class="variable">$lockName</span> <span class="variable">$threadUid</span> 1</span><br><span class="line">   pexpire <span class="variable">$lockName</span> <span class="variable">$expireTime</span></span><br><span class="line">  <span class="built_in">return</span> nil</span><br><span class="line">//è·å–å¤±è´¥</span><br><span class="line"><span class="built_in">return</span> pttl <span class="variable">$lockName</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç°åœ¨é€»è¾‘å¾ˆæ¸…æ™°äº†å§ï¼Œæ³¨æ„è¿™é‡Œçš„é”ä½¿ç”¨äº†hashç»“æ„è€Œä¸æ˜¯stringï¼Œå› ä¸ºå®ç°çš„æ˜¯å¯é‡å…¥é”ï¼Œéœ€è¦è®°å½•åŠ é”çš„çº¿ç¨‹æ ‡è¯†ï¼Œå¹¶ç»´æŒä¸€ä¸ªè®¡æ•°å™¨ã€‚</p>
<p>æœ‰çš„éœ€æ±‚æ˜¯è¦çº¿ç¨‹ä¸€ç›´ç­‰å¾…ç›´åˆ°è·å–åˆ°é”çš„ï¼ŒRedissonä¸­é€šè¿‡subscribeå‘½ä»¤è®¢é˜…é”ç›¸å…³çš„ä¸€ä¸ªchannelï¼Œæ”¶åˆ°é€šçŸ¥åä¼šå†æ¬¡å°è¯•è·å–é”ã€‚</p>
<p>å…³äºå¯é‡å…¥é”,æˆ‘åœ¨<a href="https://liam-blog.ml/2019/07/21/Scala-Concurrency-in-Practice-2/">Scalaå¹¶å‘ç¼–ç¨‹å®æˆ˜ 2ï¼šLock é”</a>ä¸­æœ‰è§£é‡Šè¿‡ï¼š</p>
<blockquote>
<p>æ‰€è°“å¯é‡å…¥é”ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åœ¨æŒæœ‰è¯¥é”çš„æ—¶å€™ï¼Œå†æ¬¡è·å–è¯¥é”ã€‚å¯é‡å…¥é”é€šå¸¸ä¸ä¸€ä¸ªè®¡æ•°å™¨å…³è”ï¼Œç¬¬ä¸€æ¬¡è·å–é”çš„æ—¶å€™ï¼Œè®¡æ•°å™¨ä»0å˜ä¸º1ï¼Œå†æ¬¡è·å–é”ï¼Œå˜ä¸º2ï¼Œä»¥æ­¤ç±»æ¨ã€‚é‡Šæ”¾é”çš„æ—¶å€™ï¼Œè®¡æ•°å™¨æ¯æ¬¡å‡1ï¼Œç›´è‡³å‡ä¸º0ï¼Œè¯¥é”æ‰çœŸæ­£é‡Šæ”¾ç»™å…¶ä»–çº¿ç¨‹ã€‚</p>
</blockquote>
<p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå®ç°çš„é”æ˜¯æœ‰è¿‡æœŸæ—¶é—´çš„ï¼Œå¦‚æœéœ€è¦ä¸€ç›´æŒæœ‰é”ï¼Œredissonä¸­çš„å®ç°æ˜¯ï¼Œä¼šç”¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ä¸æ–­å»åˆ·æ–°è¿‡æœŸæ—¶é—´ã€‚(å¯ä»¥æƒ³æƒ³ï¼Œä¸ºä»€ä¹ˆä¸ç”¨ä¸€ä¸ªæ°¸ä¸è¿‡æœŸçš„keyæ¥å®ç°å‘¢ï¼Ÿ)</p>
<h3 id="è§£é”"><a href="#è§£é”" class="headerlink" title="è§£é”"></a>è§£é”</h3><p>ä¸‹é¢çœ‹è§£é”çš„æºç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> RFuture&lt;Boolean&gt; <span class="title function_">unlockInnerAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,</span><br><span class="line">            <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[3]) == 0) then &quot;</span> +</span><br><span class="line">                <span class="string">&quot;return nil;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">            <span class="string">&quot;local counter = redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[3], -1); &quot;</span> +</span><br><span class="line">            <span class="string">&quot;if (counter &gt; 0) then &quot;</span> +</span><br><span class="line">                <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[2]); &quot;</span> +</span><br><span class="line">                <span class="string">&quot;return 0; &quot;</span> +</span><br><span class="line">            <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                <span class="string">&quot;redis.call(&#x27;del&#x27;, KEYS[1]); &quot;</span> +</span><br><span class="line">                <span class="string">&quot;redis.call(&#x27;publish&#x27;, KEYS[2], ARGV[1]); &quot;</span> +</span><br><span class="line">                <span class="string">&quot;return 1; &quot;</span>+</span><br><span class="line">            <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">            <span class="string">&quot;return nil;&quot;</span>,</span><br><span class="line">            Arrays.&lt;Object&gt;asList(getName(), getChannelName()), LockPubSub.UNLOCK_MESSAGE, internalLockLeaseTime, getLockName(threadId));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒä¹Ÿæ˜¯Luaå®ç°ï¼Œç¿»è¯‘ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">//é”æ˜¯å¦å­˜åœ¨</span><br><span class="line"><span class="keyword">if</span> exists <span class="variable">$lockName</span> == 0</span><br><span class="line">   publish <span class="variable">$channel</span> 0</span><br><span class="line">   <span class="built_in">return</span> 1</span><br><span class="line">//æ˜¯å¦æŒæœ‰é”</span><br><span class="line"><span class="keyword">if</span> hexists <span class="variable">$lockName</span> <span class="variable">$threadUid</span> ==0</span><br><span class="line">  <span class="built_in">return</span> nil</span><br><span class="line"></span><br><span class="line">//å‡å°‘æŒæœ‰è®¡æ•°</span><br><span class="line">counter = hincrby <span class="variable">$lockName</span> <span class="variable">$threadUid</span> -1</span><br><span class="line"><span class="keyword">if</span> counter &gt; 0</span><br><span class="line">  //åˆ·æ–°é”</span><br><span class="line">  pexpire <span class="variable">$lockName</span> <span class="variable">$expireTime</span></span><br><span class="line">  <span class="built_in">return</span> 0</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  //é‡Šæ”¾é”</span><br><span class="line">  del <span class="variable">$lockName</span></span><br><span class="line">  publish <span class="variable">$channel</span> 0</span><br><span class="line">  <span class="built_in">return</span> 1</span><br></pre></td></tr></table></figure>

<p>é€»è¾‘åº”è¯¥å®¹æ˜“çœ‹æ‡‚ï¼Œå…¶ä¸­publishæ˜¯ä¸ºäº†é€šçŸ¥å…¶ä»–çº¿ç¨‹é”é‡Šæ”¾äº†ï¼Œå¯ä»¥æ¥æŠ¢å•¦ã€‚</p>
<h2 id="åˆ†å¸ƒå¼é™æµå™¨çš„å®ç°"><a href="#åˆ†å¸ƒå¼é™æµå™¨çš„å®ç°" class="headerlink" title="åˆ†å¸ƒå¼é™æµå™¨çš„å®ç°"></a>åˆ†å¸ƒå¼é™æµå™¨çš„å®ç°</h2><p>å¦‚æœä¸€ä¸ªæœåŠ¡æœ‰å¤šä¸ªå®ä¾‹ï¼Œåšé™æµçš„è¯ï¼Œé€šå¸¸æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯å¯¹æ¯ä¸ªå®ä¾‹å•ç‹¬é™åˆ¶ï¼Œä¸€ç§æ˜¯å¯¹æ‰€æœ‰å®ä¾‹æ•´ä½“çš„æµé‡åšé™åˆ¶ã€‚<br>Redissonä¸­å¯¹è¿™ä¸¤ç§éƒ½æœ‰å®ç°ï¼Œä»¥é™æµå™¨çš„ç±»å‹æ¥åŒºåˆ†ï¼Œç¬¬ä¸€ç§ç§°ä½œPER_CLIENTï¼Œç¬¬äºŒç§ä¸ºOVERALLã€‚</p>
<p>é™æµç®—æ³•æœ‰è‹¥å¹²ç§ï¼ŒRedissoné‡‡ç”¨çš„æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ ¸å¿ƒå®ç°åŒæ ·æ˜¯Luaï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; RFuture&lt;T&gt; <span class="title function_">tryAcquireAsync</span><span class="params">(RedisCommand&lt;T&gt; command, Long value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, command,</span><br><span class="line">            <span class="string">&quot;local rate = redis.call(&#x27;hget&#x27;, KEYS[1], &#x27;rate&#x27;);&quot;</span></span><br><span class="line">          + <span class="string">&quot;local interval = redis.call(&#x27;hget&#x27;, KEYS[1], &#x27;interval&#x27;);&quot;</span></span><br><span class="line">          + <span class="string">&quot;local type = redis.call(&#x27;hget&#x27;, KEYS[1], &#x27;type&#x27;);&quot;</span></span><br><span class="line">          + <span class="string">&quot;assert(rate ~= false and interval ~= false and type ~= false, &#x27;RateLimiter is not initialized&#x27;)&quot;</span></span><br><span class="line">          </span><br><span class="line">          + <span class="string">&quot;local valueName = KEYS[2];&quot;</span></span><br><span class="line">          + <span class="string">&quot;if type == &#x27;1&#x27; then &quot;</span></span><br><span class="line">              + <span class="string">&quot;valueName = KEYS[3];&quot;</span></span><br><span class="line">          + <span class="string">&quot;end;&quot;</span></span><br><span class="line">          </span><br><span class="line">          + <span class="string">&quot;local currentValue = redis.call(&#x27;get&#x27;, valueName); &quot;</span></span><br><span class="line">          + <span class="string">&quot;if currentValue ~= false then &quot;</span></span><br><span class="line">                 + <span class="string">&quot;if tonumber(currentValue) &lt; tonumber(ARGV[1]) then &quot;</span></span><br><span class="line">                     + <span class="string">&quot;return redis.call(&#x27;pttl&#x27;, valueName); &quot;</span></span><br><span class="line">                 + <span class="string">&quot;else &quot;</span></span><br><span class="line">                     + <span class="string">&quot;redis.call(&#x27;decrby&#x27;, valueName, ARGV[1]); &quot;</span></span><br><span class="line">                     + <span class="string">&quot;return nil; &quot;</span></span><br><span class="line">                 + <span class="string">&quot;end; &quot;</span></span><br><span class="line">          + <span class="string">&quot;else &quot;</span></span><br><span class="line">                 + <span class="string">&quot;assert(tonumber(rate) &gt;= tonumber(ARGV[1]), &#x27;Requested permits amount could not exceed defined rate&#x27;); &quot;</span></span><br><span class="line">                 + <span class="string">&quot;redis.call(&#x27;set&#x27;, valueName, rate, &#x27;px&#x27;, interval); &quot;</span></span><br><span class="line">                 + <span class="string">&quot;redis.call(&#x27;decrby&#x27;, valueName, ARGV[1]); &quot;</span></span><br><span class="line">                 + <span class="string">&quot;return nil; &quot;</span></span><br><span class="line">          + <span class="string">&quot;end;&quot;</span>,</span><br><span class="line">            Arrays.asList(getName(), getValueName(), getClientValueName()),</span><br><span class="line">            value);    </span><br></pre></td></tr></table></figure>

<p>ç®€åŒ–ä¸ºä¼ªä»£ç ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">//ä»¤ç‰Œæ¡¶å®¹é‡</span><br><span class="line"><span class="variable">$rate</span> = hget <span class="variable">$configKey</span> rate</span><br><span class="line">//é—´éš”ï¼ˆæ¯”å¦‚rate=10,interval=1000,å°±ä»£è¡¨1000æ¯«ç§’ä¸­å…è®¸10æ¬¡ï¼Œå³QPSä¸º10ï¼‰</span><br><span class="line"><span class="variable">$interval</span> = hget <span class="variable">$configKey</span> interval</span><br><span class="line">//ç±»å‹</span><br><span class="line"><span class="variable">$type</span> = hget <span class="variable">$configKey</span> <span class="built_in">type</span></span><br><span class="line">//æ£€æŸ¥é™æµå™¨æ˜¯å¦å·²ç»åˆå§‹åŒ–</span><br><span class="line">assert(<span class="variable">$rate</span>,<span class="variable">$interval</span>,<span class="variable">$type</span>éƒ½å­˜åœ¨)</span><br><span class="line"></span><br><span class="line">//<span class="variable">$valueName</span>æ˜¯å­˜å‚¨ä»¤ç‰Œæ¡¶çš„key</span><br><span class="line"><span class="variable">$valueName</span> = <span class="variable">$valueKey</span></span><br><span class="line">//å¦‚æœæ˜¯PER_CLIENTç±»å‹</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">type</span> == <span class="string">&#x27;1&#x27;</span></span><br><span class="line">   <span class="variable">$valueName</span> = <span class="variable">$clientValueKey</span></span><br><span class="line"></span><br><span class="line">//<span class="variable">$currentValue</span>æ˜¯å½“å‰ä»¤ç‰Œæ•°ï¼Œ<span class="variable">$acquireValue</span>æ˜¯ç”³è¯·çš„ä»¤ç‰Œæ•°</span><br><span class="line"><span class="variable">$currentValue</span> = get <span class="variable">$valueName</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$currentValue</span> != <span class="literal">false</span></span><br><span class="line">    //ä»¤ç‰Œæ¡¶å·²ç»å­˜åœ¨</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">$currentValue</span> &lt; <span class="variable">$acquireValue</span></span><br><span class="line">        //ä»¤ç‰Œå°äºç”³è¯·æ•°ï¼Œç”³è¯·ä»¤ç‰Œå¤±è´¥</span><br><span class="line">        <span class="built_in">return</span> pttl <span class="variable">$valueName</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        //ä»¤ç‰Œ å‡å» ç”³è¯·æ•°</span><br><span class="line">        decrby <span class="variable">$valueName</span> <span class="variable">$acquireValue</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    //ä»¤ç‰Œæ¡¶ä¸å­˜åœ¨</span><br><span class="line"></span><br><span class="line">    //æ£€æŸ¥ç”³è¯·æ•°ä¸èƒ½å¤§äºä»¤ç‰Œæ¡¶å®¹é‡</span><br><span class="line">    assert(<span class="variable">$rate</span>&gt;<span class="variable">$acquireValue</span>)</span><br><span class="line">    //åˆ›å»ºä»¤ç‰Œæ¡¶</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$valueName</span> <span class="variable">$rate</span> px <span class="variable">$interval</span></span><br><span class="line">    decrby <span class="variable">$valueName</span> <span class="variable">$acquireValue</span></span><br><span class="line">    <span class="built_in">return</span> nil</span><br></pre></td></tr></table></figure>

<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä»¤ç‰Œæ¡¶çš„é…ç½®ä¿¡æ¯ä¹Ÿä¿å­˜åˆ°äº†redisä¸­ï¼Œå¯ä»¥çœ‹åˆ°rateï¼Œintervalï¼Œtypeä¿¡æ¯éƒ½æ˜¯ä»ä¸€ä¸ªhashç»“æ„ä¸­è·å–çš„ï¼Œä»è·å–ä»¤ç‰Œæ¡¶é…ç½®åˆ°æ›´æ–°ä»¤ç‰Œæ¡¶æ•´ä¸ªè¿‡ç¨‹æ˜¯åŸå­åŒ–çš„ã€‚è¿™æ˜¯è€ƒè™‘åˆ°å¤šä¸ªåº”ç”¨å®ä¾‹çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå®ä¾‹æ‹¿åˆ°çš„é™æµå™¨çš„é…ç½®å¯èƒ½å‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µï¼Œç‰¹åˆ«æ˜¯åœ¨ä¿®æ”¹é™æµå™¨é…ç½®çš„æ—¶å€™ã€‚</p>
<h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><p><a href="https://github.com/redisson/redisson">Redisson github</a><br>è½¬è½½è¯·æ³¨æ˜åŸæ–‡åœ°å€ï¼š<a href="https://liam-blog.ml/2020/03/29/redis-lock-rate-limiter/">Liamâ€™s Blog</a></p>
]]></content>
      <tags>
        <tag>redis</tag>
        <tag>lock</tag>
        <tag>rate limiter</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafka Fundamental Concepts</title>
    <url>/2021/05/08/Kafka-Fundamental-Concepts/</url>
    <content><![CDATA[<h1 id="What-is-Kafka"><a href="#What-is-Kafka" class="headerlink" title="What is Kafka?"></a>What is Kafka?</h1><blockquote>
<p><a href="https://www.confluent.io/what-is-apache-kafka/">Apache Kafka</a> is an event streaming platform used to collect, process, store, and integrate data at scale. It has numerous use cases including distributed logging, stream processing, data integration, and pub&#x2F;sub messaging.</p>
</blockquote>
<span id="more"></span>

<h1 id="Kafka-Architecture-Fundamental-Concepts"><a href="#Kafka-Architecture-Fundamental-Concepts" class="headerlink" title="Kafka Architecture - Fundamental Concepts"></a>Kafka Architecture - Fundamental Concepts</h1><p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/1503038310607_9038_1503038310779.png" alt="1503038310607_9038_1503038310779"></p>
<ul>
<li>Topic: Use different topics to hold different kinds of events.Here we have only one topic named TopicA.</li>
<li>Partitioning &#x2F; Topic-Partition: Partitioning takes the single topic log and breaks it into multiple logs, each of which can live on a separate node in the Kafka cluster. This way, the work of storing messages, writing new messages, and processing existing messages can be split among many nodes in the cluster.</li>
<li>Broker: Kafka is composed of a network of machines called brokers.</li>
<li>Producer and Consumer: These are client applications that contain your code, putting messages into topics and reading messages from topics. </li>
<li>Zookeeper: A external service to store metadata of Kafka.</li>
<li>Consumer Group: We can put consumers in a group to avoid that different consumers get same message.</li>
<li>Replication, leader and follower:  We need to copy partition data to several other brokers to keep it safe. Those copies are called <strong>follower</strong> replicas, whereas the main partition is called the <strong>leader</strong> replica. When you produce data to the leaderâ€”in general, reading and writing are done to the leaderâ€”the leader and the followers work together to replicate those new writes to the followers.</li>
</ul>
<h1 id="More-about-leader-and-follower"><a href="#More-about-leader-and-follower" class="headerlink" title="More about leader and follower"></a>More about leader and follower</h1><p>Letâ€™s look into only one partition.</p>
<p>All replicas, including leader and followers, are called <strong>AR</strong> (Assigned Replicas). After leader received some messages, followers will pull these messages from leader, usually followers can sync up the messages quickly, these replicas are called <strong>ISR</strong> (In-Sync Replicas). If the replica lag too much, itâ€™s going to be <strong>OSR</strong> (Out-of-Sync Replicas). Definitely, the number of AR equal to ISR + OSR.</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/image-20210505104957944.png" alt="image-20210505104957944"></p>
<p>In each partition, Kafka use offset to locate messages, just like the index of array.</p>
<p><strong>LEO</strong> is short for Log End Offset, it means the next offset to append new message. In the  picture, the leader has received 5 messages, so the LEO is 5. The LEO of follower1 is 5 as well. However, the follower2 havenâ€™t caught up the latest message, so its LEO is 4.</p>
<p>In this case, the consumers can only get messages from 0th to 3rd for the time being. Kafka only allow consumers get messages which have been saved by all ISRs. In order to indicate the range of messages which can be consumed, Kafka introduced <strong>HW</strong>( High Watermark).It should be 4 here, like the LEO using the next offset of latest message.</p>
<p>To show the details of partitions, you can use the command below.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$KAFKA_HOME/bin/kafka-topics.sh --describe --topic test --bootstrap-server &lt;your brokers&gt;</span><br><span class="line">Topic: test	PartitionCount: 4	ReplicationFactor: 3	Configs: segment.bytes=1073741824</span><br><span class="line">	Topic: test	Partition: 0	Leader: 1005	Replicas: 1005,1004,1006	Isr: 1005,1004,1006</span><br><span class="line">	Topic: test	Partition: 1	Leader: 1006	Replicas: 1006,1005,1004	Isr: 1006,1005,1004</span><br><span class="line">	Topic: test	Partition: 2	Leader: 1004	Replicas: 1004,1006,1005	Isr: 1004,1006,1005</span><br><span class="line">	Topic: test	Partition: 3	Leader: 1005	Replicas: 1005,1006,1004	Isr: 1005,1006,1004</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>Details you need to know about Apache Parquet</title>
    <url>/2020/05/31/details-you-need-to-know-about-Apache-Parquet/</url>
    <content><![CDATA[<p>Parquet is a columnar file format that supports nested data. Lots of data systems support this data format because of itâ€™s great advantage of performance.</p>
<span id="more"></span>

<h2 id="File-format"><a href="#File-format" class="headerlink" title="File format"></a>File format</h2><p><img src="https://raw.github.com/apache/parquet-format/master/doc/images/FileLayout.gif" alt="parquet-file-format"></p>
<p>First we should known is that Apache Parquet is a binary encoding like Apache Thrift and Protocol Buffers which are not human-redable, itâ€™s very different from some texual format like JSON, XML and CSV.</p>
<p>In order to identify the beginning and ending of the Parquet file, it use a Magic Number(4 special bytes) as separator. Following the first magic number, there are several Row Groups and then Footer. FileMetaData is placed in Footer, because metadata is written after the data is written. Row Groups are about datas.</p>
<blockquote>
<p>There are three types of metadata: file metadata, column (chunk) metadata and page header metadata. All thrift structures are serialized using the TCompactProtocol.</p>
</blockquote>
<p>ThriftCompactProtocol is another binary encoding from <a href="https://thrift.apache.org/">Apache Thrift</a> project.</p>
<p>Some important conceptions listed below.</p>
<blockquote>
<p>Block (hdfs block): This means a block in hdfs and the meaning is unchanged for describing this file format. The file format is designed to work well on top of hdfs.</p>
<p>File: A hdfs file that must include the metadata for the file. It does not need to actually contain the data.</p>
<p>Row group: A logical horizontal partitioning of the data into rows. There is no physical structure that is guaranteed for a row group. A row group consists of a column chunk for each column in the dataset.</p>
<p>Column chunk: A chunk of the data for a particular column. These live in a particular row group and is guaranteed to be contiguous in the file.</p>
<p>Page: Column chunks are divided up into pages. A page is conceptually an indivisible unit (in terms of compression and encoding). There can be multiple page types which is interleaved in a column chunk.</p>
<p><strong>Hierarchically, a file consists of one or more row groups. A row group contains exactly one column chunk per column. Column chunks contain one or more pages.</strong></p>
</blockquote>
<h2 id="Metadata"><a href="#Metadata" class="headerlink" title="Metadata"></a>Metadata</h2><p>Letâ€™s deep into the metadata.</p>
<p><img src="https://github.com/apache/parquet-format/raw/master/doc/images/FileFormat.gif" alt="metadata"></p>
<p>The definition file: <a href="https://github.com/apache/parquet-format/blob/master/src/main/thrift/parquet.thrift">Parquet thrift definition</a></p>
<h3 id="FileMetaData"><a href="#FileMetaData" class="headerlink" title="FileMetaData"></a>FileMetaData</h3><p>Here is the definition:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description for file metadata</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> FileMetaData &#123;</span><br><span class="line">  <span class="comment">/** Version of this file **/</span></span><br><span class="line">  <span class="number">1</span>: required i32 version</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Parquet schema for this file.  This schema contains metadata for all the columns.</span></span><br><span class="line"><span class="comment">   * The schema is represented as a tree with a single root.  The nodes of the tree</span></span><br><span class="line"><span class="comment">   * are flattened to a list by doing a depth-first traversal.</span></span><br><span class="line"><span class="comment">   * The column metadata contains the path in the schema for that column which can be</span></span><br><span class="line"><span class="comment">   * used to map columns to nodes in the schema.</span></span><br><span class="line"><span class="comment">   * The first element is the root **/</span></span><br><span class="line">  <span class="number">2</span>: required list&lt;SchemaElement&gt; schema;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Number of rows in this file **/</span></span><br><span class="line">  <span class="number">3</span>: required i64 num_rows</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Row groups in this file **/</span></span><br><span class="line">  <span class="number">4</span>: required list&lt;RowGroup&gt; row_groups</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Optional key/value metadata **/</span></span><br><span class="line">  <span class="number">5</span>: optional list&lt;KeyValue&gt; key_value_metadata</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** String for application that wrote this file.  This should be in the format</span></span><br><span class="line"><span class="comment">   * &lt;Application&gt; version &lt;App Version&gt; (build &lt;App Build Hash&gt;).</span></span><br><span class="line"><span class="comment">   * e.g. impala version 1.0 (build 6cf94d29b2b7115df4de2c06e2ab4326d721eb55)</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  <span class="number">6</span>: optional <span class="type">string</span> created_by</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Sort order used for the min_value and max_value fields of each column in</span></span><br><span class="line"><span class="comment">   * this file. Each sort order corresponds to one column, determined by its</span></span><br><span class="line"><span class="comment">   * position in the list, matching the position of the column in the schema.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Without column_orders, the meaning of the min_value and max_value fields is</span></span><br><span class="line"><span class="comment">   * undefined. To ensure well-defined behaviour, if min_value and max_value are</span></span><br><span class="line"><span class="comment">   * written to a Parquet file, column_orders must be written as well.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * The obsolete min and max fields are always sorted by signed comparison</span></span><br><span class="line"><span class="comment">   * regardless of column_orders.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">7</span>: optional list&lt;ColumnOrder&gt; column_orders;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The field â€˜num_rowsâ€™ is very useful when data reader wanna to count the data, for instance, when SparkSQL count on some paritioned table, Spark just sum all the â€˜num_rowsâ€™ of each parquet file belong to those filtered partitions.</p>
<p>The â€˜schemaâ€™ is the most important part of this metadata, it is defined by a list of SchemaElement, thatâ€™s means each field is represented by a SchemaElement.</p>
<h4 id="SchemaElement"><a href="#SchemaElement" class="headerlink" title="SchemaElement"></a>SchemaElement</h4><p>Here is the structure of SchemaElement.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Represents a element inside a schema definition.</span></span><br><span class="line"><span class="comment"> *  - if it is a group (inner node) then type is undefined and num_children is defined</span></span><br><span class="line"><span class="comment"> *  - if it is a primitive type (leaf) then type is defined and num_children is undefined</span></span><br><span class="line"><span class="comment"> * the nodes are listed in depth first traversal order.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> SchemaElement &#123;</span><br><span class="line">  <span class="comment">/** Data type for this field. Not set if the current element is a non-leaf node */</span></span><br><span class="line">  <span class="number">1</span>: optional Type <span class="keyword">type</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** If type is FIXED_LEN_BYTE_ARRAY, this is the byte length of the vales.</span></span><br><span class="line"><span class="comment">   * Otherwise, if specified, this is the maximum bit length to store any of the values.</span></span><br><span class="line"><span class="comment">   * (e.g. a low cardinality INT col could have this set to 3).  Note that this is</span></span><br><span class="line"><span class="comment">   * in the schema, and therefore fixed for the entire file.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">2</span>: optional i32 type_length;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** repetition of the field. The root of the schema does not have a repetition_type.</span></span><br><span class="line"><span class="comment">   * All other nodes must have one */</span></span><br><span class="line">  <span class="number">3</span>: optional FieldRepetitionType repetition_type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Name of the field in the schema */</span></span><br><span class="line">  <span class="number">4</span>: required <span class="type">string</span> name;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Nested fields.  Since thrift does not support nested fields,</span></span><br><span class="line"><span class="comment">   * the nesting is flattened to a single list by a depth-first traversal.</span></span><br><span class="line"><span class="comment">   * The children count is used to construct the nested relationship.</span></span><br><span class="line"><span class="comment">   * This field is not set when the element is a primitive type</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">5</span>: optional i32 num_children;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** When the schema is the result of a conversion from another model</span></span><br><span class="line"><span class="comment">   * Used to record the original type to help with cross conversion.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">6</span>: optional ConvertedType converted_type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Used when this column contains decimal data.</span></span><br><span class="line"><span class="comment">   * See the DECIMAL converted type for more details.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">7</span>: optional i32 scale</span><br><span class="line">  <span class="number">8</span>: optional i32 precision</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** When the original schema supports field ids, this will save the</span></span><br><span class="line"><span class="comment">   * original field id in the parquet schema</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">9</span>: optional i32 field_id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The logical type of this SchemaElement</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * LogicalType replaces ConvertedType, but ConvertedType is still required</span></span><br><span class="line"><span class="comment">   * for some logical types to ensure forward-compatibility in format v1.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="number">10</span>: optional LogicalType logicalType</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The data type of each data column is determined by both â€˜typeâ€™ and â€˜logicalTypeâ€™ field.</p>
<p>The â€˜typeâ€™ field support several primitive types:</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">BOOLEAN: 1 bit boolean</span><br><span class="line">INT32: 32 bit signed ints</span><br><span class="line">INT64: 64 bit signed ints</span><br><span class="line">INT96: 96 bit signed ints</span><br><span class="line">FLOAT: IEEE 32-bit floating point values</span><br><span class="line">DOUBLE: IEEE 64-bit floating point values</span><br><span class="line">BYTE_ARRAY: arbitrarily long byte arrays</span><br></pre></td></tr></table></figure>

<p>Logical types are some type based on primitive type, the field â€˜logicalTypeâ€™ tells data reader to which LogicalType should the primitive type data be transfered.</p>
<blockquote>
<p>Logical types are used to extend the types that parquet can be used to store, by specifying how the primitive types should be interpreted. This keeps the set of primitive types to a minimum and reuses parquetâ€™s efficient encodings. For example, strings are stored as byte arrays (binary) with a UTF8 annotation.</p>
</blockquote>
<p>Many types supported by â€˜logicalTypeâ€™. Such as:</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">STRING,ENUM,UUID,</span><br><span class="line">DATE,TIME,TIMESTAMP,INTERVAL</span><br><span class="line">INT,DECIMAL</span><br><span class="line">JSON,BSON</span><br><span class="line">LIST,MAP</span><br><span class="line">NULL</span><br></pre></td></tr></table></figure>

<blockquote>
<p>INT annotation can be used to specify the maximum number of bits in the stored value. The annotation has two parameter: bit width and sign, such as:INT(8, true), INT(16, true), INT(32, true), INT(64, true).</p>
</blockquote>
<p>For more details about LogicalType see <a href="https://github.com/apache/parquet-format/blob/master/LogicalTypes.md">Parquet Logical Type Definitions</a></p>
<h4 id="ColumnMetaData"><a href="#ColumnMetaData" class="headerlink" title="ColumnMetaData"></a>ColumnMetaData</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description for column metadata</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> ColumnMetaData &#123;</span><br><span class="line">  <span class="comment">/** Type of this column **/</span></span><br><span class="line">  <span class="number">1</span>: required Type <span class="keyword">type</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Set of all encodings used for this column. The purpose is to validate</span></span><br><span class="line"><span class="comment">   * whether we can decode those pages. **/</span></span><br><span class="line">  <span class="number">2</span>: required list&lt;Encoding&gt; encodings</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Path in schema **/</span></span><br><span class="line">  <span class="number">3</span>: required list&lt;<span class="type">string</span>&gt; path_in_schema</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Compression codec **/</span></span><br><span class="line">  <span class="number">4</span>: required CompressionCodec codec</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Number of values in this column **/</span></span><br><span class="line">  <span class="number">5</span>: required i64 num_values</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** total byte size of all uncompressed pages in this column chunk (including the headers) **/</span></span><br><span class="line">  <span class="number">6</span>: required i64 total_uncompressed_size</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** total byte size of all compressed pages in this column chunk (including the headers) **/</span></span><br><span class="line">  <span class="number">7</span>: required i64 total_compressed_size</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Optional key/value metadata **/</span></span><br><span class="line">  <span class="number">8</span>: optional list&lt;KeyValue&gt; key_value_metadata</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Byte offset from beginning of file to first data page **/</span></span><br><span class="line">  <span class="number">9</span>: required i64 data_page_offset</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Byte offset from beginning of file to root index page **/</span></span><br><span class="line">  <span class="number">10</span>: optional i64 index_page_offset</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Byte offset from the beginning of file to first (only) dictionary page **/</span></span><br><span class="line">  <span class="number">11</span>: optional i64 dictionary_page_offset</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** optional statistics for this column chunk */</span></span><br><span class="line">  <span class="number">12</span>: optional Statistics statistics;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Set of all encodings used for pages in this column chunk.</span></span><br><span class="line"><span class="comment">   * This information can be used to determine if all data pages are</span></span><br><span class="line"><span class="comment">   * dictionary encoded for example **/</span></span><br><span class="line">  <span class="number">13</span>: optional list&lt;PageEncodingStats&gt; encoding_stats;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Each ColumnChunk has only one ColumnMetaData, so one ColumnMetaData defined how to store one columnâ€™s data in one row group.</p>
<p>Some fields should be noticed:</p>
<ul>
<li>encodings: just for validation, each columnâ€™s encoding is defined in DataPageHeader(see below);</li>
<li>codec: the compression algorithm used, such as SNAPPY, GZIP, LZO and so on;</li>
<li>statistics: statistics information for the column of the row group. Some useful field are showed below, they are very useful for distinct counting or filtering. With the â€˜max_valueâ€™ and â€˜min_valueâ€™, SparkSQL can do filter push-down by skipping some row groups.</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> Statistics &#123;</span><br><span class="line">    ...</span><br><span class="line">   <span class="comment">/** count of null value in the column */</span></span><br><span class="line">   <span class="number">3</span>: optional i64 null_count;</span><br><span class="line">   <span class="comment">/** count of distinct values occurring */</span></span><br><span class="line">   <span class="number">4</span>: optional i64 distinct_count;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Min and max values for the column, determined by its ColumnOrder.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Values are encoded using PLAIN encoding, except that variable-length byte</span></span><br><span class="line"><span class="comment">    * arrays do not include a length prefix.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="number">5</span>: optional binary max_value;</span><br><span class="line">   <span class="number">6</span>: optional binary min_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="PageHeader"><a href="#PageHeader" class="headerlink" title="PageHeader"></a>PageHeader</h4><p>PageHeader is kind of like parent class of DataPageHeader, IndexPageHeader and DictionaryPageHeader, contains some common fields.</p>
<p>Each data page has a DataPageHeader, letâ€™s look into it below.</p>
<h5 id="DataPageHeader"><a href="#DataPageHeader" class="headerlink" title="DataPageHeader"></a>DataPageHeader</h5><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * New page format allowing reading levels without decompressing the data</span></span><br><span class="line"><span class="comment"> * Repetition and definition levels are uncompressed</span></span><br><span class="line"><span class="comment"> * The remaining section containing the data is compressed if is_compressed is true</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">struct</span> DataPageHeaderV2 &#123;</span><br><span class="line">  <span class="comment">/** Number of values, including NULLs, in this data page. **/</span></span><br><span class="line">  <span class="number">1</span>: required i32 num_values</span><br><span class="line">  <span class="comment">/** Number of NULL values, in this data page.</span></span><br><span class="line"><span class="comment">      Number of non-null = num_values - num_nulls which is also the number of values in the data section **/</span></span><br><span class="line">  <span class="number">2</span>: required i32 num_nulls</span><br><span class="line">  <span class="comment">/** Number of rows in this data page. which means pages change on record boundaries (r = 0) **/</span></span><br><span class="line">  <span class="number">3</span>: required i32 num_rows</span><br><span class="line">  <span class="comment">/** Encoding used for data in this page **/</span></span><br><span class="line">  <span class="number">4</span>: required Encoding encoding</span><br><span class="line"></span><br><span class="line">  <span class="comment">// repetition levels and definition levels are always using RLE (without size in it)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** length of the definition levels */</span></span><br><span class="line">  <span class="number">5</span>: required i32 definition_levels_byte_length;</span><br><span class="line">  <span class="comment">/** length of the repetition levels */</span></span><br><span class="line">  <span class="number">6</span>: required i32 repetition_levels_byte_length;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**  whether the values are compressed.</span></span><br><span class="line"><span class="comment">  Which means the section of the page between</span></span><br><span class="line"><span class="comment">  definition_levels_byte_length + repetition_levels_byte_length + 1 and compressed_page_size (included)</span></span><br><span class="line"><span class="comment">  is compressed with the compression_codec.</span></span><br><span class="line"><span class="comment">  If missing it is considered compressed */</span></span><br><span class="line">  <span class="number">7</span>: optional <span class="type">bool</span> is_compressed = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** optional statistics for this column chunk */</span></span><br><span class="line">  <span class="number">8</span>: optional Statistics statistics;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>encoding: This field is about how to store <strong>primitive type</strong> data with bytes, for example, a PLAIN encoding means to use 4 bytes, PLAIN_DICTIONARY means to use a dictionary.<br>For more details see <a href="https://github.com/apache/parquet-format/blob/master/Encodings.md">Parquet encoding definitions</a></li>
<li>statistics: statistics information for this page</li>
</ul>
<p>ps: The comment of statistics is wrong, it should be â€˜optional statistics for the data in this pageâ€™, I have fixed that in my <a href="https://github.com/apache/parquet-format/pull/159">PR</a>.</p>
<p><strong>How encoding work with compression ?</strong></p>
<p>First, the data be encoded , second, encoded output is then compressed with a generic compression algorithm specified in ColumnMetaData like Snappy.</p>
<p>There is another description.</p>
<blockquote>
<p>Encoding: Itâ€™s more at application level where data representation is changed. The encoding can also minimize space usage which can give us a kind of compression.<br>Compression : In general itâ€™s the Technic to reduce storage for given data in bytes irrespective of underline data is already encoded or not.</p>
</blockquote>
<h2 id="Parquet-tools"><a href="#Parquet-tools" class="headerlink" title="Parquet-tools"></a>Parquet-tools</h2><p>Parquet-tools is a convenient offical tool to play with Parquet file.</p>
<p>If you use MacOS and homebrew, just install it by <code>brew install parquet-tools</code> .</p>
<p>To show metadata: <code>parquet-tools meta yourfile.parquet</code></p>
<p>Or use hadoop distribution: <code>hadoop jar ./parquet-tools-&lt;VERSION&gt;.jar &lt;command&gt;</code></p>
<p>Youâ€™ll get something like this:</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">creator:     parquet-mr version 1.10.1 (build a89df8f9932b6ef6633d06069e50c9b7970bebd1)</span><br><span class="line">extra:       org.apache.spark.sql.parquet.row.metadata = &#123;&quot;type&quot;:&quot;struct&quot;,&quot;fields&quot;:[&#123;&quot;name&quot;:&quot;v&quot;,&quot;type&quot;:&quot;i [more]...</span><br><span class="line"></span><br><span class="line">file schema: spark_schema</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------</span><br><span class="line">v:           REQUIRED INT32 R:0 D:0</span><br><span class="line">sq:          REQUIRED INT32 R:0 D:0</span><br><span class="line">str:         OPTIONAL BINARY O:UTF8 R:0 D:1</span><br><span class="line"></span><br><span class="line">row group 1: RC:5000 TS:94040</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------</span><br><span class="line">v:            INT32 SNAPPY DO:0 FPO:4 SZ:20056/20050/1.00 VC:5000 ENC:PLAIN,BIT_PACKED</span><br><span class="line">sq:           INT32 SNAPPY DO:0 FPO:20060 SZ:20030/20050/1.00 VC:5000 ENC:PLAIN,BIT_PACKED</span><br><span class="line">str:          BINARY SNAPPY DO:0 FPO:40090 SZ:21960/53940/2.46 VC:5000 ENC:RLE,PLAIN,BIT_PACKED</span><br></pre></td></tr></table></figure>

<p>More details: <a href="https://github.com/apache/parquet-mr/tree/master/parquet-tools">Parquet Tools</a></p>
<h2 id="Use-Parquet-with-Spark"><a href="#Use-Parquet-with-Spark" class="headerlink" title="Use Parquet with Spark"></a>Use Parquet with Spark</h2><p>You can find some guide here: <a href="https://spark.apache.org/docs/latest/sql-data-sources-parquet.html">Spark SQL Guide &gt; Parquet Files</a>.</p>
<p>With Parquet file, spark can do some optimizations.</p>
<blockquote>
<ul>
<li><strong>Column projection</strong><br>  The idea behind this feature is simple: just read the data for columns that the query needs to process and skip the rest of the data. Column-oriented data formats like Parquet can implement this feature quite naturally.</li>
<li><strong>Predicate push down</strong><br>  Predicate push down is another feature of Spark and Parquet that can improve query performance by reducing the amount of data read from Parquet files. Predicate push down works by evaluating filtering predicates in the query against metadata stored in the Parquet files.</li>
</ul>
</blockquote>
<p><strong>Does predicate push down available for nest field ?</strong></p>
<p>Yes. If the field schema is <code>user(id, name)</code>, data will be stored in two columns as <code>user.id</code> and <code>user.name</code>, then both id and name have thier own statistic info in metadata.</p>
<h2 id="Use-Parquet-with-HDFS"><a href="#Use-Parquet-with-HDFS" class="headerlink" title="Use Parquet with HDFS"></a>Use Parquet with HDFS</h2><p>When using Parquet with HDFS, you should care about the row group size.</p>
<blockquote>
<p>Row group size: Larger row groups allow for larger column chunks which makes it possible to do larger sequential IO. Larger groups also require more buffering in the write path (or a two pass write). We recommend large row groups (512MB - 1GB). Since an entire row group might need to be read, we want it to completely fit on one HDFS block. Therefore, HDFS block sizes should also be set to be larger. An optimized read setup would be: 1GB row groups, 1GB HDFS block size, 1 HDFS block per HDFS file.</p>
</blockquote>
<p>The row group size is controlled by config named <code>parquet.block.size</code>, the default value is 128MB,  </p>
<p>You can set it in Spark as below:<br><code>sc.hadoopConfiguration.setInt(&quot;parquet.block.size&quot;,256*1024*1024)</code><br>or<br><code>df.write.option(&quot;parquet.block.size&quot;,256*1024*1024)</code></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://parquet.apache.org/documentation/latest/">Apache Parquet</a></p>
<p><a href="https://db-blog.web.cern.ch/blog/luca-canali/2017-06-diving-spark-and-parquet-workloads-example">Diving into Spark and Parquet Workloads, by Example</a></p>
]]></content>
      <tags>
        <tag>Spark</tag>
        <tag>Apache Parquet</tag>
      </tags>
  </entry>
  <entry>
    <title>How to solve dependency conflicts with Maven</title>
    <url>/2021/09/24/How-to-solve-dependency-conflicts-with-Maven/</url>
    <content><![CDATA[<h2 id="What-are-dependency-conflicts"><a href="#What-are-dependency-conflicts" class="headerlink" title="What are dependency conflicts?"></a>What are dependency conflicts?</h2><p>Here is an example, this project has 2 dependencies, and both of them depend on the Guava library with different versions.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Project dependencies --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>30.1.1-jre<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>29.0-jre<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>As you all know, we canâ€™t have two classes with the same package and name in one project. So there would be conflicts if different versions of a package are imported. Obviously, in this case, only one version of Guava will be imported.</p>
<span id="more"></span>

<h2 id="How-to-find-dependency-conflictsï¼Ÿ"><a href="#How-to-find-dependency-conflictsï¼Ÿ" class="headerlink" title="How to find dependency conflictsï¼Ÿ"></a>How to find dependency conflictsï¼Ÿ</h2><p>Iâ€™d like to introduce 2 useful tools to you. The first one is â€˜maven-dependency-pluginâ€™. Itâ€™s a Maven plugin, so you can use it directly. The command is listed below:</p>
<p><code>mvn dependency:tree -Dverbose -Dincludes=com.google.guava:guava</code></p>
<p>The â€˜dependencyâ€™ is the plugin prefix, the â€˜treeâ€™ is the plugin goal. </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[INFO] --- maven-dependency-plugin:2.8:tree (default-cli) @ study-maven ---</span><br><span class="line">[INFO] org.example:study-maven:jar:1.0-SNAPSHOT</span><br><span class="line">[INFO] +- org.example:study-maven-2:jar:1.0-SNAPSHOT:compile</span><br><span class="line">[INFO] |  \\- com.google.guava:guava:jar:30.1.1-jre:compile</span><br><span class="line">[INFO] \\- org.example:study-maven-3:jar:1.0-SNAPSHOT:compile</span><br><span class="line">[INFO]    \\- (com.google.guava:guava:jar:29.0-jre:compile - omitted for conflict with 30.1.1-jre)</span><br></pre></td></tr></table></figure>

<p>The result tells us that 2 dependencies imported the guava package, but only version 30 is available in this project. Version 29 is omitted.</p>
<p>Another tool is an IntelliJ IDEA plugin, called <em>Maven Helper</em>. Itâ€™s more convenient if you are using this development editor. You can see the conflicts directly in its panel.</p>
<img src="https://raw.githubusercontent.com/Liam8/img/master/blog/image-20210924183132709.png" alt="image-20210924183132709.png" style="zoom: 33%;" />

<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/image-20210924190701716.png" alt="image-20210924190701716"></p>
<h2 id="How-Maven-chooses-the-version-of-dependency"><a href="#How-Maven-chooses-the-version-of-dependency" class="headerlink" title="How Maven chooses the version of dependency?"></a>How Maven chooses the version of dependency?</h2><p>Actually, the rule is quite simple. You just need to remember 2 rules.</p>
<p>The first one is: <strong>nearest definition wins</strong></p>
<p>â€œnearest definitionâ€ means that the version used will be the closest one to your project in the tree of dependencies.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">POM</span><br><span class="line">|-- A</span><br><span class="line">|   `-- B 1.0</span><br><span class="line">|-- C</span><br><span class="line">   `-- D</span><br><span class="line">      `-- B 2.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>From this dependency tree, we can get 2 dependency paths: <code>root-A-B1.0</code> and <code>root-C-D-B2.0</code>. You can see the first path is shorter than the second one, so according to this rule, version 1.0 will be chosen by Maven.</p>
<p>If two dependency versions are at the same depth, then youâ€™ll need the second rule: <strong>first declaration wins</strong>. It means which dependency imported earlier will be chosen.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POM</span><br><span class="line">|-- A</span><br><span class="line">|   `-- B 1.0</span><br><span class="line">|-- C</span><br><span class="line">    `-- B 2.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Version 1.0 is imported earlier, so it will be the final winner.</p>
<p>More details: <a href="https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html">Introduction to the Dependency Mechanism</a></p>
<p>Do you remember the example I mentioned before? The project imported 2 dependencies, study-maven-2 and study-maven-3. Both of these 2 libraries imported Guava directly.</p>
<p>Letâ€™s have a look at the dependency tree of the project. You can see that version 30 is available, and another version of Guava is omitted. Because version 30 is imported firstly.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[INFO] --- maven-dependency-plugin:2.8:tree (default-cli) @ study-maven ---</span><br><span class="line">[INFO] org.example:study-maven:jar:1.0-SNAPSHOT</span><br><span class="line">[INFO] +- org.example:study-maven-2:jar:1.0-SNAPSHOT:compile</span><br><span class="line">[INFO] |  \- com.google.guava:guava:jar:30.1.1-jre:compile</span><br><span class="line">[INFO] \- org.example:study-maven-3:jar:1.0-SNAPSHOT:compile</span><br><span class="line">[INFO]    \- (com.google.guava:guava:jar:29.0-jre:compile - omitted for conflict with 30.1.1-jre)</span><br></pre></td></tr></table></figure>

<p>But there is an exceptional situation, itâ€™s not a usual case; it happens when you importing the same library with a different version in one POM file. Then the latter one will win.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>29.0-jre<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>27.0.1-jre<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[INFO] --- maven-dependency-plugin:2.8:tree (default-cli) @ study-maven ---</span><br><span class="line">[INFO] org.example:study-maven:jar:1.0-SNAPSHOT</span><br><span class="line">[INFO] \\- com.google.guava:guava:jar:27.0.1-jre:compile</span><br></pre></td></tr></table></figure>



<h2 id="How-to-specify-the-version-we-want"><a href="#How-to-specify-the-version-we-want" class="headerlink" title="How to specify the version we want?"></a>How to specify the version we want?</h2><h3 id="3-solutions"><a href="#3-solutions" class="headerlink" title="3 solutions"></a>3 solutions</h3><p>Here Iâ€™ll give you 3 solutions.</p>
<p>The first way to achieve this goal is that excluding the version you donâ€™t want when importing the dependency. You need to add some exclusion configurations with the dependency importing. You can do it manually or with the Maven Helper plugin.</p>
<p><img src="https://raw.githubusercontent.com/Liam8/img/master/blog/image-20210924193152686.png" alt="image-20210924193152686"></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>After you do that, you can check the dependency tree again.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[INFO] --- maven-dependency-plugin:2.8:tree (default-cli) @ study-maven ---</span><br><span class="line">[INFO] org.example:study-maven:jar:1.0-SNAPSHOT</span><br><span class="line">[INFO] \\- org.example:study-maven-3:jar:1.0-SNAPSHOT:compile</span><br><span class="line">[INFO]    \\- com.google.guava:guava:jar:29.0-jre:compile</span><br></pre></td></tr></table></figure>

<p>The second way is importing the version you want directly in your project, according to the rule we mentioned before, the directly imported version will be the available one. Letâ€™s check the dependency tree again, now version 29 is the winner.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>29.0-jre<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">[INFO] --- maven-dependency-plugin:2.8:tree (default-cli) @ study-maven ---</span><br><span class="line">[INFO] org.example:study-maven:jar:1.0-SNAPSHOT</span><br><span class="line">[INFO] +- org.example:study-maven-2:jar:1.0-SNAPSHOT:compile</span><br><span class="line">[INFO] |  \\- (com.google.guava:guava:jar:30.1.1-jre:compile - omitted for conflict with 29.0-jre)</span><br><span class="line">[INFO] +- org.example:study-maven-3:jar:1.0-SNAPSHOT:compile</span><br><span class="line">[INFO] |  \\- (com.google.guava:guava:jar:29.0-jre:compile - omitted for conflict with 30.1.1-jre)</span><br><span class="line">[INFO] \\- com.google.guava:guava:jar:29.0-jre:compile</span><br></pre></td></tr></table></figure>

<p>The 3rd solution is using dependency management, you can assign a version directly.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>29.0-jre<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">[INFO] --- maven-dependency-plugin:2.8:tree (default-cli) @ study-maven ---</span><br><span class="line">[INFO] org.example:study-maven:jar:1.0-SNAPSHOT</span><br><span class="line">[INFO] +- org.example:study-maven-2:jar:1.0-SNAPSHOT:compile</span><br><span class="line">[INFO] |  \\- com.google.guava:guava:jar:29.0-jre:compile (version managed from 30.1.1-jre)</span><br><span class="line">[INFO] \\- org.example:study-maven-3:jar:1.0-SNAPSHOT:compile</span><br><span class="line">[INFO]    \\- (com.google.guava:guava:jar:29.0-jre:compile - version managed from 30.1.1-jre; omitted for duplicate)</span><br></pre></td></tr></table></figure>

<p>You can see, now version 29 is the winner.</p>
<p>Please attention that the dependency managementâ€™s priority is lower than the directly imported one. It means the dependency management can not change the version you imported directly.</p>
<h3 id="What-if-we-have-to-keep-two-versions"><a href="#What-if-we-have-to-keep-two-versions" class="headerlink" title="What if we have to keep two versions?"></a>What if we have to keep two versions?</h3><p>Some libraries only work with the old version of Guava, but some of them only work with the new version.</p>
<p>Letâ€™s say study-maven-2 only works with Guava 30.1, but study-maven-3 can not work without Guava 29.<br>Here are the steps:</p>
<ol>
<li>Create a new project;</li>
<li>Relocate all classes in package â€˜com.google.commonâ€™ by maven-shade-plugin;</li>
<li>Import the shaded one.</li>
</ol>
<p>Here what we need is the â€˜maven-shade-pluginâ€™. This plugin can relocate some classes, by changing its package name.</p>
<p>Here is an example, weâ€™d like to relocate all classes in package â€˜com.google.commonâ€™ to another package.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shaded-study-maven-3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">relocations</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">relocation</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>com.google.common<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">shadedPattern</span>&gt;</span>org.example.shaded.com.google.common<span class="tag">&lt;/<span class="name">shadedPattern</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">relocation</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">relocations</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>What happened with relocation?</p>
<p>Your code will use the relocated classes after being compiled.</p>
<p>Before relocation, your code was importing the class of Guava from the original package; After relocation, your code is importing the same class from a new package.</p>
<p>Before:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Preconditions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Preconditions.checkNotNull(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.shaded.com.google.common.base.Preconditions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Demo</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Preconditions.checkNotNull(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After you install or deploy the package, you can import the shaded library, there wonâ€™t be conflict.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>study-maven-2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shaded-study-maven-3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="What-if-your-dependency-conflict-with-the-runtime-library"><a href="#What-if-your-dependency-conflict-with-the-runtime-library" class="headerlink" title="What if your dependency conflict with the runtime library?"></a>What if your dependency conflict with the runtime library?</h3><p>In a runtime environment, like Spark cluster is using guava 19.0, but you need to use 30.x version.</p>
<p>You can not shade the library provided by the runtime environment, but you can shade your package.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>30.1.1-jre<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">relocations</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">relocation</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>com.google.common<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">shadedPattern</span>&gt;</span>org.example.shaded.com.google.common<span class="tag">&lt;/<span class="name">shadedPattern</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">relocation</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">relocations</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>There is no best solution here, so you need to make your choice case by case.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Now you know more about the solution to deal with conflicts.</p>
<p>Letâ€™s summarize briefly what weâ€™ve looked at.</p>
<p>Firstly, weâ€™ve talked about how to find dependency conflicts.</p>
<p>Secondly, weâ€™ve got to know how Maven works with conflicts.</p>
<p>Lastly, weâ€™ve discussed the solutions.</p>
]]></content>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Extend Spark Data Source with DataFrame</title>
    <url>/2022/04/25/Extend-Spark-Data-Source/</url>
    <content><![CDATA[<p>In this article, weâ€™ll implement a spark data source for reading and writing a Google spreadsheet, so that youâ€™ll know how to extend the data source of Spark by yourself.</p>
<h2 id="Whatâ€™s-a-customized-data-source-like"><a href="#Whatâ€™s-a-customized-data-source-like" class="headerlink" title="Whatâ€™s a customized data source like?"></a>Whatâ€™s a customized data source like?</h2><h3 id="read-data-from-Google-Spreadsheet-into-a-DataFrame"><a href="#read-data-from-Google-Spreadsheet-into-a-DataFrame" class="headerlink" title="read data from Google Spreadsheet into a DataFrame"></a>read data from Google Spreadsheet into a DataFrame</h3><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> data = spark.read.format(<span class="string">&quot;google-spreadsheet&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;credentialsPath&quot;</span>, credentialFile)</span><br><span class="line">  .option(<span class="string">&quot;spreadsheetId&quot;</span>, spreadsheetId)</span><br><span class="line">  .option(<span class="string">&quot;sheetName&quot;</span>, sheetName1)</span><br><span class="line">  .load()</span><br></pre></td></tr></table></figure>

<h3 id="write-data-of-a-DataFrame-into-Google-Spreadsheet"><a href="#write-data-of-a-DataFrame-into-Google-Spreadsheet" class="headerlink" title="write data of a DataFrame into Google Spreadsheet"></a>write data of a DataFrame into Google Spreadsheet</h3><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">df.write.format(<span class="string">&quot;google-spreadsheet&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;credentialsPath&quot;</span>, credentialFile)</span><br><span class="line">  .option(<span class="string">&quot;spreadsheetId&quot;</span>, spreadsheetId)</span><br><span class="line">  .option(<span class="string">&quot;sheetName&quot;</span>, sheetName)</span><br><span class="line">  .mode(<span class="type">SaveMode</span>.<span class="type">Overwrite</span>)</span><br><span class="line">  .save()</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="Implement"><a href="#Implement" class="headerlink" title="Implement"></a>Implement</h2><p>In total, weâ€™ll implement 4 files:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GoogleSpreadsheetDataSource.scala</span><br><span class="line"></span><br><span class="line">GoogleSpreadsheetDataSourceException.scala</span><br><span class="line"></span><br><span class="line">GoogleSpreadsheetDataSourceReader.scala</span><br><span class="line"></span><br><span class="line">GoogleSpreadsheetDataSourceWriter.scala</span><br></pre></td></tr></table></figure>

<ul>
<li><p>GoogleSpreadsheetDataSource is the main class to define a DataSource.</p>
</li>
<li><p>GoogleSpreadsheetDataSourceReader and GoogleSpreadsheetDataSourceWriter tell Spark how to read and write data with a Sheet separately.</p>
</li>
<li><p>GoogleSpreadsheetDataSourceException is just a customized exception.</p>
</li>
</ul>
<p>You can check the full code here <a href="https://github.com/Liam8/spark-google-spreadsheet-datasource">Liam8&#x2F;spark-google-spreadsheet-datasource</a>.</p>
<h3 id="main-class"><a href="#main-class" class="headerlink" title="main class"></a>main class</h3><p>Letâ€™s start with the main class.</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoogleSpreadsheetDataSource</span> <span class="keyword">extends</span> <span class="title">ReadSupport</span> <span class="keyword">with</span> <span class="title">WriteSupport</span> <span class="keyword">with</span> <span class="title">DataSourceRegister</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createReader</span></span>(options: <span class="type">DataSourceOptions</span>): <span class="type">DataSourceReader</span> = &#123;</span><br><span class="line">    createReader(<span class="literal">null</span>, options)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createReader</span></span>(schema: <span class="type">StructType</span>, options: <span class="type">DataSourceOptions</span>): <span class="type">DataSourceReader</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">GoogleSpreadsheetDataSourceReader</span>(</span><br><span class="line">      options.get(<span class="string">&quot;spreadsheetId&quot;</span>).get(),</span><br><span class="line">      options.get(<span class="string">&quot;sheetName&quot;</span>).get(),</span><br><span class="line">      options.get(<span class="string">&quot;credentialsPath&quot;</span>).get(),</span><br><span class="line">      options.getInt(<span class="string">&quot;bufferSizeOfEachPartition&quot;</span>, <span class="number">100</span>),</span><br><span class="line">      <span class="type">Option</span>(schema),</span><br><span class="line">      options.getBoolean(<span class="string">&quot;firstRowAsHeader&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">      options.getInt(<span class="string">&quot;parallelism&quot;</span>,</span><br><span class="line">        <span class="type">SparkSession</span>.getActiveSession.get.sparkContext.defaultParallelism)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">shortName</span></span>(): <span class="type">String</span> = <span class="string">&quot;google-spreadsheet&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createWriter</span></span>(</span><br><span class="line">    writeUUID: <span class="type">String</span>, schema: <span class="type">StructType</span>, mode: <span class="type">SaveMode</span>, options: <span class="type">DataSourceOptions</span></span><br><span class="line">  ): <span class="type">Optional</span>[<span class="type">DataSourceWriter</span>] = &#123;</span><br><span class="line">    <span class="type">Optional</span>.of(<span class="keyword">new</span> <span class="type">GoogleSpreadsheetDataSourceWriter</span>(</span><br><span class="line">      mode,</span><br><span class="line">      options.get(<span class="string">&quot;spreadsheetId&quot;</span>).get(),</span><br><span class="line">      options.get(<span class="string">&quot;sheetName&quot;</span>).get(),</span><br><span class="line">      options.get(<span class="string">&quot;credentialsPath&quot;</span>).get(),</span><br><span class="line">      options.getInt(<span class="string">&quot;bufferSizeOfEachPartition&quot;</span>, <span class="number">10</span>),</span><br><span class="line">      schema,</span><br><span class="line">      options.getBoolean(<span class="string">&quot;firstRowAsHeader&quot;</span>, <span class="literal">true</span>)</span><br><span class="line">    ))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">GoogleSpreadsheetDataSource</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">buildSheet</span></span>(credentialsPath: <span class="type">String</span>): <span class="type">Sheets</span> =</span><br><span class="line">    <span class="keyword">new</span> <span class="type">Sheets</span>.<span class="type">Builder</span>(</span><br><span class="line">      <span class="type">GoogleNetHttpTransport</span>.newTrustedTransport,</span><br><span class="line">      <span class="type">JacksonFactory</span>.getDefaultInstance,</span><br><span class="line">      <span class="keyword">new</span> <span class="type">HttpCredentialsAdapter</span>(<span class="type">GoogleCredentials</span>.fromStream(</span><br><span class="line">        <span class="keyword">this</span>.getClass.getClassLoader.getResourceAsStream(credentialsPath)</span><br><span class="line">      ).createScoped(<span class="type">SheetsScopes</span>.<span class="type">SPREADSHEETS</span>))</span><br><span class="line">    ).setApplicationName(<span class="string">&quot;GoogleSpreadsheetDataSourceReader&quot;</span>).build()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>In this class, we can get options from DataSourceOptions to create the Reader and Writer. If you only want to read data, you donâ€™t need to extend the WriteSupport.</p>
<h3 id="Reader"><a href="#Reader" class="headerlink" title="Reader"></a>Reader</h3><p>In the Reader we mainly need to deal with two things, one is how to generate partitions, and another one is how to read data in one partition.</p>
<p>The most important thing is to implement the DataSourceReader.</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">planInputPartitions</span></span>(): util.<span class="type">List</span>[<span class="type">InputPartition</span>[<span class="type">InternalRow</span>]] = &#123;</span><br><span class="line">    <span class="keyword">val</span> sheets = sheetService.spreadsheets().get(spreadsheetId)</span><br><span class="line">      .setFields(<span class="string">&quot;sheets.properties&quot;</span>).execute().getSheets</span><br><span class="line">    <span class="comment">// sheetName is case insensitive</span></span><br><span class="line">    <span class="keyword">val</span> tmpSheetName = sheetName.toLowerCase</span><br><span class="line">    <span class="keyword">val</span> sheet = sheets.asScala.find(_.getProperties.getTitle.toLowerCase == tmpSheetName).getOrElse(</span><br><span class="line">      <span class="keyword">throw</span> <span class="type">GoogleSpreadsheetDataSourceException</span>(<span class="string">s&quot;Can&#x27;t find the sheet named <span class="subst">$sheetName</span>&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">val</span> rowCount = sheet.getProperties.getGridProperties.getRowCount</span><br><span class="line">    <span class="keyword">val</span> step = <span class="type">Math</span>.ceil(rowCount / parallelism).toInt</span><br><span class="line">    <span class="keyword">val</span> start = <span class="keyword">if</span> (firstRowAsHeader) <span class="number">2</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">    <span class="type">Range</span>.inclusive(start, rowCount, step).map &#123; i =&gt;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">GoogleSpreadsheetInputPartition</span>(</span><br><span class="line">        credentialsPath,</span><br><span class="line">        spreadsheetId,</span><br><span class="line">        sheetName,</span><br><span class="line">        i,</span><br><span class="line">        <span class="type">Math</span>.min(i + step - <span class="number">1</span>, rowCount),</span><br><span class="line">        bufferSizeOfEachPartition,</span><br><span class="line">        originalSchema,</span><br><span class="line">        prunedSchema</span><br><span class="line">      ).asInstanceOf[<span class="type">InputPartition</span>[<span class="type">InternalRow</span>]]</span><br><span class="line">    &#125;.toList.asJava</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>In the method <code>planInputPartitions</code>, we create a list of <code>GoogleSpreadsheetInputPartition</code>.</p>
<p><code>GoogleSpreadsheetInputPartition</code> is a subclass of <code>InputPartition</code> that holds the metadata of one partition. </p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoogleSpreadsheetInputPartition</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="class">  credentialsPath: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  spreadsheetId: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  sheetName: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  startOffset: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  endOffset: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  bufferSize: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  schema: <span class="type">StructType</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  prunedSchema: <span class="type">Option</span>[<span class="type">StructType</span>]</span></span></span><br><span class="line"><span class="params"><span class="class"></span>) <span class="keyword">extends</span> <span class="title">InputPartition</span>[<span class="type">InternalRow</span>] </span>&#123;</span><br></pre></td></tr></table></figure>

<p>The <code>startOffset: Int, endOffset: Int</code> means from which offset or row current partition should read and where to stop.</p>
 <figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> rowCount = sheet.getProperties.getGridProperties.getRowCount</span><br><span class="line"><span class="keyword">val</span> step = <span class="type">Math</span>.ceil(rowCount / parallelism).toInt</span><br></pre></td></tr></table></figure>

<p>Here we get the total number of rows in the sheet, and then divide it by parallelism to get how many rows should be read in one partition. Then we can calculate the <code>startOffset</code> and <code>endOffset</code> off all pages.</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoogleSpreadsheetDataSourceReader</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="class">  spreadsheetId: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  sheetName: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  credentialsPath: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  bufferSizeOfEachPartition: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  var schema: <span class="type">Option</span>[<span class="type">StructType</span>] = <span class="type">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  firstRowAsHeader: <span class="type">Boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  parallelism: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="class"></span>) <span class="keyword">extends</span> <span class="title">DataSourceReader</span> <span class="keyword">with</span> <span class="title">SupportsPushDownRequiredColumns</span> </span></span><br></pre></td></tr></table></figure>

<p>Where we really do the data reading is in the class <code>GoogleSpreadsheetInputPartitionReader</code>, I override two methods here <code>override def get(): InternalRow</code> and <code>override def next(): Boolean</code>. Itâ€™s very similar like implement an iterator: <code>next()</code> returns true or false to tell if any more data to read; <code>get()</code> to get the next row of data.</p>
<p>To improve the performance, the <code>next()</code> here read a batch of data from the sheet, and then buffs it. So the <code>get()</code> just return a row of data from the buffer.</p>
<h3 id="Writer"><a href="#Writer" class="headerlink" title="Writer"></a>Writer</h3><figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoogleSpreadsheetDataWriter</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="class">  saveMode: <span class="type">SaveMode</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  schema: <span class="type">StructType</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  credentialsPath: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  spreadsheetId: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  sheetName: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  bufferSize: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">  firstRowAsHeader: <span class="type">Boolean</span></span></span></span><br><span class="line"><span class="params"><span class="class"></span>) <span class="keyword">extends</span> <span class="title">DataWriter</span>[<span class="type">InternalRow</span>]</span></span><br></pre></td></tr></table></figure>

<p>In file <code>GoogleSpreadsheetDataSourceWriter.scala</code> the most important class is <code>GoogleSpreadsheetDataWriter</code>. In this class, we have a method <code>override def write(record: InternalRow): Unit</code> to write data of one partition into an external system. In my implementation, I put data into a buffer first, and write data into the sheet when the buffer is full.</p>
<h3 id="Register-Datasource"><a href="#Register-Datasource" class="headerlink" title="Register Datasource"></a>Register Datasource</h3><p>If we want to make the data source can be used as the built-in data source like:<code>spark.read.format(&quot;google-spreadsheet&quot;)</code>, we need to register it first. There is a file to do this <code>/src/main/resources/META-INF/services/org.apache.spark.sql.sources.DataSourceRegister</code>.</p>
<p>The content of this file is:</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">com.github.liam8.spark.datasource.googlesheet.<span class="type">GoogleSpreadsheetDataSource</span></span><br></pre></td></tr></table></figure>

<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>In a work, the core part of the data source implementation is reading and writing data of one partition. The Spark framework will do most of the rest things for you.</p>
<p>Following this way to extend the Spark data source, basically, you can let Spark read and write data with any storage.</p>
<p><a href="https://github.com/Liam8/spark-google-spreadsheet-datasource">Check the repo in Github</a></p>
]]></content>
      <tags>
        <tag>Spark</tag>
      </tags>
  </entry>
</search>
